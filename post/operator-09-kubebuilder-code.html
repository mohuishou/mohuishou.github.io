<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/icons/touch-icon-apple.png"><link rel="icon" type="image/png" href="/icons/favicon-32x32.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content="mohuishou 的 技术博客, 关注云原生, Go, K8s, Docker, 微服务等技术"><meta name="author" content="Mohuishou"><meta name="keywords" content="Go,Docker,PHP,Go,k8s,operator,kubernetes,kubebuilder,kubernetes 系列,Kubernetes 扩展: Operator"><title>9. kubebuilder 进阶: 源码分析 - Mohuishou</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main-442214b0b65670dd46af7df7ed93c28e.css"><link rel="stylesheet" href="/assets/css/custom-0e36f72be6c0aff220c940db3074a9fc.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"lailin.xyz",root:"/",version:"1.8.7",typing:{enable:!1,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,onlypost:!1},web_analytics:{enable:!0,baidu:null,google:"UA-137859264-1",gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}}}</script><script src="/js/utils-5ecdced2f65030c3508cf0b3db78f4ad.js"></script><script src="/js/color-schema-46bfe5914503d369a38135850f0aac19.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>mohuishou</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> Go 系列</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/"><i class="iconfont icon-category-fill"></i> Go 进阶训练营(更新中) </a><a class="dropdown-item" href="/post/list.html"><i class="iconfont icon-notebook"></i> Go 数据结构与算法(更新中) </a><a class="dropdown-item" href="/post/go-design-pattern.html"><i class="iconfont icon-notebook"></i> Go 设计模式</a></div></li><li class="nav-item"><a class="nav-link" href="/post/operator-01-overview.html"><i class="iconfont icon-category-fill"></i> kubernetes 系列</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 更多</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/links/"><i class="iconfont icon-link-fill"></i> 友链 </a><a class="dropdown-item" href="/atom.xml"><i class="iconfont icon-rss"></i> rss </a><a class="dropdown-item" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></div></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/bg.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="9. kubebuilder 进阶: 源码分析">9. kubebuilder 进阶: 源码分析</span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-05-17 01:00" pubdate>2021年5月17日 凌晨</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3.5k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 57 分钟</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"><div class="sidebar"><p class="sidebar-header">kubernetes 系列</p><div class="sidebar-body" id="sidebar-body"><ol class="sidebar-list sidebar-list-1"><li class="sidebar-list-item"><a class="sidebar-title sidebar-title-ckpy587uy00a0fsoif4hh6gro" data-cid="ckpy587uy00a0fsoif4hh6gro" onclick='switchSideBar("ckpy587uy00a0fsoif4hh6gro")'>Kubernetes 扩展: Operator(10)</a><ol data-cid="ckpy587uy00a0fsoif4hh6gro" class="sidebar-list sidebar-list-2 sidebar-is-collapsible sidebar-ckpy587uy00a0fsoif4hh6gro"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-01-overview.html">1. Operator概述: 如何对 Kubernetes 进行扩展</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-02-use-kind-create-k8s-local-cluster.html">2. Kind: 如何快速搭建本地 K8s 开发环境？</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-03-kubebuilder-tutorial.html">3. KubeBuilder 简明教程</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-04-kustomize-tutorial.html">4. kustomize 简明教程</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-05-kubebuilder-crud.html">5. kubebuilder 实战: CRUD</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-06-kubebuilder-status-and-event.html">6. kubebuilder 实战: status &amp; event</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-07-kubebuilder-test.html">7. kubebuilder 进阶: 测试</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-08-kubebuilder-webhook.html">8. kubebuilder 进阶: webhook</a></li><li class="sidebar-list-item is-active-li"><a class="sidebar-link sidebar-active-link" href="/post/operator-09-kubebuilder-code.html">9. kubebuilder 进阶: 源码分析</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-11-summary.html">10. 总结</a></li></ol></li></ol></div></div><script>function switchSideBar(s){$(".sidebar-title-"+s).toggleClass("sidebar-title-collapsed"),$(".sidebar-"+s).toggleClass("sidebar-is-collapsed")}</script></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">9. kubebuilder 进阶: 源码分析</h1><div class="markdown-body"><div class="note note-info"><p>注：本文所有示例代码都可以在 <a target="_blank" rel="noopener" href="https://github.com/mohuishou/blog-code">blog-code</a> 仓库中找到</p></div><p>在前面的文章当中我们已经完整的完成了一个 Operator 的开发，涉及到了 CURD、预删除、Status、Event、OwnerReference、WebHook，也算是将一个 Operator 开发中会涉及到的点大部分都了解了一下。kubebuilder 帮我们做了很多事情，让我们的开发基本上只需要关注一个 Reconcile 函数就可以了，但是从另外一个方面来讲，kubebuilder 目前对我们来说它还是一个黑盒，会产生很多的疑问：</p><ul><li>Reconcile 方法是怎么被触发的？</li><li>怎么识别到不同的资源？</li><li>整体是如何进行工作的？</li><li>……</li></ul><h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p>我们先来看一下来自官方文档的这个架构图<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="架构图 https://master.book.kubebuilder.io/architecture.html
">[1]</span></a></sup></p><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/20210502134650.svg" srcset="/img/loading.gif" alt="arch"></p><ul><li><strong>Process</strong> 进程通过 <code>main.go</code>启动，一般来说一个 Controller 只有一个进程，如果做了高可用的话，会有多个</li><li><strong>Manager</strong> 每个进程会有一个 Manager，这是核心组件，主要负责<ul><li>metrics 的暴露</li><li>webhook 证书</li><li>初始化共享的 cache</li><li>初始化共享的 clients 用于和 APIServer 进行通信</li><li>所有的 Controller 的运行</li></ul></li><li><strong>Client</strong> 一般来说，我们 创建、更新、删除某个资源的时候会直接调用 Client 和 APIServer 进行通信</li><li><strong>Cache</strong> 负责同步 Controller 关心的资源，其核心是 GVK -&gt; Informer 的映射，一般我们的 Get 和 List 操作都会从 Cache 中获取数据</li><li><strong>Controller</strong> 控制器的业务逻辑所在的地方，一个 Manager 可能会有多个 Controller，我们一般只需要实现 Reconcile 方法就行。图上的 Predicate 是事件过滤器，我们可以在 Controller 中过滤掉我们不关心的事件信息</li><li><strong>WebHook</strong> 就是我们准入控制实现的地方了，主要是有两类接口，一个是 MutatingAdmissionWebhook 需要实现 Defaulter 接口，一个是 ValidatingAdmissionWebhook 需要实现 Validator 接口</li></ul><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>了解了基本的架构之后，我们就从入口 <code>main.go</code> 开始，看一看 kubebuilder 究竟在后面偷偷的做了哪些事情吧。</p><h3 id="main-go"><a href="#main-go" class="headerlink" title="main.go"></a>main.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"> <span class="hljs-comment">// 省略了参数绑定和 error check 的代码</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> metricsAddr <span class="hljs-keyword">string</span><br>	<span class="hljs-keyword">var</span> enableLeaderElection <span class="hljs-keyword">bool</span><br>	<span class="hljs-keyword">var</span> probeAddr <span class="hljs-keyword">string</span><br><br>	ctrl.SetLogger(zap.New(zap.UseFlagOptions(&amp;opts)))<br><br>	mgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options&#123;<br>		Scheme:                 scheme,<br>		MetricsBindAddress:     metricsAddr,<br>		Port:                   <span class="hljs-number">9443</span>,<br>		HealthProbeBindAddress: probeAddr,<br>		LeaderElection:         enableLeaderElection,<br>		LeaderElectionID:       <span class="hljs-string">&quot;97acaccf.lailin.xyz&quot;</span>,<br>		<span class="hljs-comment">// CertDir:                &quot;config/cert/&quot;, // 手动指定证书位置用于测试</span><br>	&#125;)<br>	<br><br>	(&amp;controllers.NodePoolReconciler&#123;<br>		Client:   mgr.GetClient(),<br>		Log:      ctrl.Log.WithName(<span class="hljs-string">&quot;controllers&quot;</span>).WithName(<span class="hljs-string">&quot;NodePool&quot;</span>),<br>		Scheme:   mgr.GetScheme(),<br>		Recorder: mgr.GetEventRecorderFor(<span class="hljs-string">&quot;NodePool&quot;</span>),<br>	&#125;).SetupWithManager(mgr)<br><br>	(&amp;nodesv1.NodePool&#123;&#125;).SetupWebhookWithManager(mgr)<br>  <br>	<span class="hljs-comment">//+kubebuilder:scaffold:builder</span><br><br>	mgr.AddHealthzCheck(<span class="hljs-string">&quot;healthz&quot;</span>, healthz.Ping)<br>	mgr.AddReadyzCheck(<span class="hljs-string">&quot;readyz&quot;</span>, healthz.Ping)<br><br>	setupLog.Info(<span class="hljs-string">&quot;starting manager&quot;</span>)<br>	mgr.Start(ctrl.SetupSignalHandler())<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到 main.go 主要是做了一些启动的工作包括：</p><ul><li>创建一个 Manager</li><li>使用刚刚创建的 Manager 创建了一个 Controller</li><li>启动 WebHook</li><li>添加健康检查</li><li>启动 Manager</li></ul><p>下面我们就顺着 main 函数里面的逻辑一步步的往下看看</p><h3 id="NewManger"><a href="#NewManger" class="headerlink" title="NewManger"></a>NewManger</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// New returns a new Manager for creating Controllers.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">(config *rest.Config, options Options)</span> <span class="hljs-params">(Manager, error)</span></span> &#123;<br>	<span class="hljs-comment">// 省略配置初始化相关代码</span><br><br>	<span class="hljs-comment">// 创建 cache</span><br>	cache, err := options.NewCache(config, <br>                                 cache.Options&#123;<br>                                   Scheme: options.Scheme, <span class="hljs-comment">// main 中传入的 scheme</span><br>                                   Mapper: mapper,         <span class="hljs-comment">// k8s api 和 go type 的转换器</span><br>                                   Resync: options.SyncPeriod, <span class="hljs-comment">// 默认 10 小时，一般不要改</span><br>                                   Namespace: options.Namespace, <span class="hljs-comment">// 需要监听的 namespace</span><br>                                 &#125;)<br><br>  <span class="hljs-comment">// 创建和 APIServer 交互的 client，读写分离</span><br>	clientOptions := client.Options&#123;Scheme: options.Scheme, Mapper: mapper&#125;<br>	apiReader, err := client.New(config, clientOptions)<br><br><br>	writeObj, err := options.ClientBuilder.<br>		WithUncached(options.ClientDisableCacheFor...).<br>		Build(cache, config, clientOptions)<br><br>	<span class="hljs-keyword">if</span> options.DryRunClient &#123;<br>		writeObj = client.NewDryRunClient(writeObj)<br>	&#125;<br><br>	<span class="hljs-comment">// 创建事件记录器</span><br>	recorderProvider, err := options.newRecorderProvider(config, options.Scheme, options.Logger.WithName(<span class="hljs-string">&quot;events&quot;</span>), options.makeBroadcaster)<br><br>	<span class="hljs-comment">// 需要需要高可用的话，创建选举相关的配置</span><br>	leaderConfig := config<br>	<span class="hljs-keyword">if</span> options.LeaderElectionConfig != <span class="hljs-literal">nil</span> &#123;<br>		leaderConfig = options.LeaderElectionConfig<br>	&#125;<br>	resourceLock, err := options.newResourceLock(leaderConfig, recorderProvider, leaderelection.Options&#123;<br>		LeaderElection:             options.LeaderElection,<br>		LeaderElectionResourceLock: options.LeaderElectionResourceLock,<br>		LeaderElectionID:           options.LeaderElectionID,<br>		LeaderElectionNamespace:    options.LeaderElectionNamespace,<br>	&#125;)<br><br>	<span class="hljs-comment">// 创建 metric 和 健康检查的接口</span><br>	metricsListener, err := options.newMetricsListener(options.MetricsBindAddress)<br><br>	<span class="hljs-comment">// By default we have no extra endpoints to expose on metrics http server.</span><br>	metricsExtraHandlers := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]http.Handler)<br><br>	<span class="hljs-comment">// Create health probes listener. This will throw an error if the bind</span><br>	<span class="hljs-comment">// address is invalid or already in use.</span><br>	healthProbeListener, err := options.newHealthProbeListener(options.HealthProbeBindAddress)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br><br>  <span class="hljs-comment">// 最后将这些配置放到 manager 中</span><br>	<span class="hljs-keyword">return</span> &amp;controllerManager&#123;<br>		config:                  config,<br>		scheme:                  options.Scheme,<br>		cache:                   cache,<br>		fieldIndexes:            cache,<br>		client:                  writeObj,<br>		apiReader:               apiReader,<br>		recorderProvider:        recorderProvider,<br>		resourceLock:            resourceLock,<br>		mapper:                  mapper,<br>		metricsListener:         metricsListener,<br>		metricsExtraHandlers:    metricsExtraHandlers,<br>		logger:                  options.Logger,<br>		elected:                 <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;),<br>		port:                    options.Port,<br>		host:                    options.Host,<br>		certDir:                 options.CertDir,<br>		leaseDuration:           *options.LeaseDuration,<br>		renewDeadline:           *options.RenewDeadline,<br>		retryPeriod:             *options.RetryPeriod,<br>		healthProbeListener:     healthProbeListener,<br>		readinessEndpointName:   options.ReadinessEndpointName,<br>		livenessEndpointName:    options.LivenessEndpointName,<br>		gracefulShutdownTimeout: *options.GracefulShutdownTimeout,<br>		internalProceduresStop:  <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;),<br>	&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="创建-Cache"><a href="#创建-Cache" class="headerlink" title="创建 Cache"></a>创建 Cache</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">(config *rest.Config, opts Options)</span> <span class="hljs-params">(Cache, error)</span></span> &#123;<br>	opts, err := defaultOpts(config, opts)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	im := internal.NewInformersMap(config, opts.Scheme, opts.Mapper, *opts.Resync, opts.Namespace)<br>	<span class="hljs-keyword">return</span> &amp;informerCache&#123;InformersMap: im&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>这里主要是调用 <code>NewInformersMap</code>方法创建 Informer 的映射</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewInformersMap</span><span class="hljs-params">(config *rest.Config,</span></span><br><span class="hljs-function"><span class="hljs-params">	scheme *runtime.Scheme,</span></span><br><span class="hljs-function"><span class="hljs-params">	mapper meta.RESTMapper,</span></span><br><span class="hljs-function"><span class="hljs-params">	resync time.Duration,</span></span><br><span class="hljs-function"><span class="hljs-params">	namespace <span class="hljs-keyword">string</span>)</span> *<span class="hljs-title">InformersMap</span></span> &#123;<br><br>	<span class="hljs-keyword">return</span> &amp;InformersMap&#123;<br>		structured:   newStructuredInformersMap(config, scheme, mapper, resync, namespace),<br>		unstructured: newUnstructuredInformersMap(config, scheme, mapper, resync, namespace),<br>		metadata:     newMetadataInformersMap(config, scheme, mapper, resync, namespace),<br><br>		Scheme: scheme,<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>NewInformersMap</code>会去分别创建，结构化、非结构化以及 metadata 的 InformerMap 而这些方法最后都会去调用 <code>newSpecificInformersMap</code>方法，区别就是不同的方法传入的 <code>createListWatcherFunc</code> 参数不同</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newSpecificInformersMap</span><span class="hljs-params">(config *rest.Config,</span></span><br><span class="hljs-function"><span class="hljs-params">	scheme *runtime.Scheme,</span></span><br><span class="hljs-function"><span class="hljs-params">	mapper meta.RESTMapper,</span></span><br><span class="hljs-function"><span class="hljs-params">	resync time.Duration,</span></span><br><span class="hljs-function"><span class="hljs-params">	namespace <span class="hljs-keyword">string</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">	createListWatcher createListWatcherFunc)</span> *<span class="hljs-title">specificInformersMap</span></span> &#123;<br>	ip := &amp;specificInformersMap&#123;<br>		config:            config,<br>		Scheme:            scheme,<br>		mapper:            mapper,<br>		informersByGVK:    <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[schema.GroupVersionKind]*MapEntry),<br>		codecs:            serializer.NewCodecFactory(scheme),<br>		paramCodec:        runtime.NewParameterCodec(scheme),<br>		resync:            resync,<br>		startWait:         <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;),<br>		createListWatcher: createListWatcher,<br>		namespace:         namespace,<br>	&#125;<br>	<span class="hljs-keyword">return</span> ip<br>&#125;<br></code></pre></td></tr></table></figure><p>newSpecificInformersMap 和常规的 InformersMap 类似，区别是没实现 <code>WaitForCacheSync</code>方法</p><p>以结构化的传入的 <code>createStructuredListWatch</code> 为例，主要是返回一个用于创建 SharedIndexInformer 的 ListWatch 对象</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createStructuredListWatch</span><span class="hljs-params">(gvk schema.GroupVersionKind, ip *specificInformersMap)</span> <span class="hljs-params">(*cache.ListWatch, error)</span></span> &#123;<br>	<span class="hljs-comment">// Kubernetes APIs work against Resources, not GroupVersionKinds.  Map the</span><br>	<span class="hljs-comment">// groupVersionKind to the Resource API we will use.</span><br>	mapping, err := ip.mapper.RESTMapping(gvk.GroupKind(), gvk.Version)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br><br>	client, err := apiutil.RESTClientForGVK(gvk, <span class="hljs-literal">false</span>, ip.config, ip.codecs)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	listGVK := gvk.GroupVersion().WithKind(gvk.Kind + <span class="hljs-string">&quot;List&quot;</span>)<br>	listObj, err := ip.Scheme.New(listGVK)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br><br>	<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> the functions that make use of this ListWatch should be adapted to</span><br>	<span class="hljs-comment">//  pass in their own contexts instead of relying on this fixed one here.</span><br>	ctx := context.TODO()<br>	<span class="hljs-comment">// Create a new ListWatch for the obj</span><br>	<span class="hljs-keyword">return</span> &amp;cache.ListWatch&#123;<br>		ListFunc: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(opts metav1.ListOptions)</span> <span class="hljs-params">(runtime.Object, error)</span></span> &#123;<br>			res := listObj.DeepCopyObject()<br>			isNamespaceScoped := ip.namespace != <span class="hljs-string">&quot;&quot;</span> &amp;&amp; mapping.Scope.Name() != meta.RESTScopeNameRoot<br>			err := client.Get().NamespaceIfScoped(ip.namespace, isNamespaceScoped).Resource(mapping.Resource.Resource).VersionedParams(&amp;opts, ip.paramCodec).Do(ctx).Into(res)<br>			<span class="hljs-keyword">return</span> res, err<br>		&#125;,<br>		<span class="hljs-comment">// Setup the watch function</span><br>		WatchFunc: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(opts metav1.ListOptions)</span> <span class="hljs-params">(watch.Interface, error)</span></span> &#123;<br>			<span class="hljs-comment">// Watch needs to be set to true separately</span><br>			opts.Watch = <span class="hljs-literal">true</span><br>			isNamespaceScoped := ip.namespace != <span class="hljs-string">&quot;&quot;</span> &amp;&amp; mapping.Scope.Name() != meta.RESTScopeNameRoot<br>			<span class="hljs-keyword">return</span> client.Get().NamespaceIfScoped(ip.namespace, isNamespaceScoped).Resource(mapping.Resource.Resource).VersionedParams(&amp;opts, ip.paramCodec).Watch(ctx)<br>		&#125;,<br>	&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>小结:</strong> cache 主要是创建了一些 InformerMap，完成了 GVK 到 Informer 的映射，每个 Informer 会根据 ListWatch 函数对对应的 GVK 进行 List 和 Watch。</p><h4 id="创建-Client"><a href="#创建-Client" class="headerlink" title="创建 Client"></a>创建 Client</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">(config *rest.Config, options Options)</span> <span class="hljs-params">(Client, error)</span></span> &#123;<br>	<span class="hljs-keyword">if</span> config == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;must provide non-nil rest.Config to client.New&quot;</span>)<br>	&#125;<br><br>	<span class="hljs-comment">// Init a scheme if none provided</span><br>	<span class="hljs-keyword">if</span> options.Scheme == <span class="hljs-literal">nil</span> &#123;<br>		options.Scheme = scheme.Scheme<br>	&#125;<br><br>	<span class="hljs-comment">// Init a Mapper if none provided</span><br>	<span class="hljs-keyword">if</span> options.Mapper == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">var</span> err error<br>		options.Mapper, err = apiutil.NewDynamicRESTMapper(config)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>		&#125;<br>	&#125;<br><br>	clientcache := &amp;clientCache&#123;<br>		config: config,<br>		scheme: options.Scheme,<br>		mapper: options.Mapper,<br>		codecs: serializer.NewCodecFactory(options.Scheme),<br><br>		structuredResourceByType:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[schema.GroupVersionKind]*resourceMeta),<br>		unstructuredResourceByType: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[schema.GroupVersionKind]*resourceMeta),<br>	&#125;<br><br>	rawMetaClient, err := metadata.NewForConfig(config)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;unable to construct metadata-only client for use as part of client: %w&quot;</span>, err)<br>	&#125;<br><br>	c := &amp;client&#123;<br>		typedClient: typedClient&#123;<br>			cache:      clientcache,<br>			paramCodec: runtime.NewParameterCodec(options.Scheme),<br>		&#125;,<br>		unstructuredClient: unstructuredClient&#123;<br>			cache:      clientcache,<br>			paramCodec: noConversionParamCodec&#123;&#125;,<br>		&#125;,<br>		metadataClient: metadataClient&#123;<br>			client:     rawMetaClient,<br>			restMapper: options.Mapper,<br>		&#125;,<br>		scheme: options.Scheme,<br>		mapper: options.Mapper,<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> c, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>client 创建了两个一个用于读，一个用于写，用于读的会直接使用上面的 cache，用于写的才会直接和 APIServer 进行交互</p><h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><p>下面我们看一下核心的 Controller 是怎么初始化和工作的</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> err = (&amp;controllers.NodePoolReconciler&#123;<br>  Client:   mgr.GetClient(),<br>  Log:      ctrl.Log.WithName(<span class="hljs-string">&quot;controllers&quot;</span>).WithName(<span class="hljs-string">&quot;NodePool&quot;</span>),<br>  Scheme:   mgr.GetScheme(),<br>  Recorder: mgr.GetEventRecorderFor(<span class="hljs-string">&quot;NodePool&quot;</span>),<br>&#125;).SetupWithManager(mgr); err != <span class="hljs-literal">nil</span> &#123;<br>  setupLog.Error(err, <span class="hljs-string">&quot;unable to create controller&quot;</span>, <span class="hljs-string">&quot;controller&quot;</span>, <span class="hljs-string">&quot;NodePool&quot;</span>)<br>  os.Exit(<span class="hljs-number">1</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>main.go</code> 的方法里面主要是初始化了 Controller 的结构体，然后调用了 <code>SetupWithManager</code>方法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// SetupWithManager sets up the controller with the Manager.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *NodePoolReconciler)</span> <span class="hljs-title">SetupWithManager</span><span class="hljs-params">(mgr ctrl.Manager)</span> <span class="hljs-title">error</span></span> &#123;<br>	<span class="hljs-keyword">return</span> ctrl.NewControllerManagedBy(mgr).<br>		For(&amp;nodesv1.NodePool&#123;&#125;).<br>		Watches(&amp;source.Kind&#123;Type: &amp;corev1.Node&#123;&#125;&#125;, handler.Funcs&#123;UpdateFunc: r.nodeUpdateHandler&#125;).<br>		Complete(r)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>SetupWithManager</code>之前有讲到过，主要是使用了建造者模式，去构建了我们需要监听的对象，只有这些对象的相关事件才会触发我们的 <code>Reconcile</code> 逻辑。这里面的 <code>Complete</code> 最后其实是调用了 <code>Build</code> 方法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(blder *Builder)</span> <span class="hljs-title">Build</span><span class="hljs-params">(r reconcile.Reconciler)</span> <span class="hljs-params">(controller.Controller, error)</span></span> &#123;<br>	<span class="hljs-comment">// 省略参数校验</span><br><br>	<span class="hljs-comment">// Set the Config</span><br>	blder.loadRestConfig()<br><br>	<span class="hljs-comment">// Set the ControllerManagedBy</span><br>	<span class="hljs-keyword">if</span> err := blder.doController(r); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br><br>	<span class="hljs-comment">// Set the Watch</span><br>	<span class="hljs-keyword">if</span> err := blder.doWatch(); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> blder.ctrl, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>Build</code>主要调用 <code>doController</code> 、<code>doWatch</code>两个方法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(blder *Builder)</span> <span class="hljs-title">doController</span><span class="hljs-params">(r reconcile.Reconciler)</span> <span class="hljs-title">error</span></span> &#123;<br>	ctrlOptions := blder.ctrlOptions<br>	<span class="hljs-keyword">if</span> ctrlOptions.Reconciler == <span class="hljs-literal">nil</span> &#123;<br>		ctrlOptions.Reconciler = r<br>	&#125;<br><br>	<span class="hljs-comment">// Retrieve the GVK from the object we&#x27;re reconciling</span><br>	<span class="hljs-comment">// to prepopulate logger information, and to optionally generate a default name.</span><br>	gvk, err := getGvk(blder.forInput.object, blder.mgr.GetScheme())<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br><br>	<span class="hljs-comment">// Setup the logger.</span><br>	<span class="hljs-keyword">if</span> ctrlOptions.Log == <span class="hljs-literal">nil</span> &#123;<br>		ctrlOptions.Log = blder.mgr.GetLogger()<br>	&#125;<br>	ctrlOptions.Log = ctrlOptions.Log.WithValues(<span class="hljs-string">&quot;reconciler group&quot;</span>, gvk.Group, <span class="hljs-string">&quot;reconciler kind&quot;</span>, gvk.Kind)<br><br>	<span class="hljs-comment">// Build the controller and return.</span><br>	blder.ctrl, err = newController(blder.getControllerName(gvk), blder.mgr, ctrlOptions)<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br></code></pre></td></tr></table></figure><p><code>doController</code>主要是初始化了一个 Controller，这里面传入了我们实现 的<code>Reconciler</code>以及获取到我们的 GVK 的名称</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(blder *Builder)</span> <span class="hljs-title">doWatch</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br>	<span class="hljs-comment">// Reconcile type</span><br>	typeForSrc, err := blder.project(blder.forInput.object, blder.forInput.objectProjection)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	src := &amp;source.Kind&#123;Type: typeForSrc&#125;<br>	hdler := &amp;handler.EnqueueRequestForObject&#123;&#125;<br>	allPredicates := <span class="hljs-built_in">append</span>(blder.globalPredicates, blder.forInput.predicates...)<br>	<span class="hljs-keyword">if</span> err := blder.ctrl.Watch(src, hdler, allPredicates...); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br><br>	<span class="hljs-comment">// Watches the managed types</span><br>	<span class="hljs-keyword">for</span> _, own := <span class="hljs-keyword">range</span> blder.ownsInput &#123;<br>		typeForSrc, err := blder.project(own.object, own.objectProjection)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> err<br>		&#125;<br>		src := &amp;source.Kind&#123;Type: typeForSrc&#125;<br>		hdler := &amp;handler.EnqueueRequestForOwner&#123;<br>			OwnerType:    blder.forInput.object,<br>			IsController: <span class="hljs-literal">true</span>,<br>		&#125;<br>		allPredicates := <span class="hljs-built_in">append</span>([]predicate.Predicate(<span class="hljs-literal">nil</span>), blder.globalPredicates...)<br>		allPredicates = <span class="hljs-built_in">append</span>(allPredicates, own.predicates...)<br>		<span class="hljs-keyword">if</span> err := blder.ctrl.Watch(src, hdler, allPredicates...); err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> err<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// Do the watch requests</span><br>	<span class="hljs-keyword">for</span> _, w := <span class="hljs-keyword">range</span> blder.watchesInput &#123;<br>		allPredicates := <span class="hljs-built_in">append</span>([]predicate.Predicate(<span class="hljs-literal">nil</span>), blder.globalPredicates...)<br>		allPredicates = <span class="hljs-built_in">append</span>(allPredicates, w.predicates...)<br><br>		<span class="hljs-comment">// If the source of this watch is of type *source.Kind, project it.</span><br>		<span class="hljs-keyword">if</span> srckind, ok := w.src.(*source.Kind); ok &#123;<br>			typeForSrc, err := blder.project(srckind.Type, w.objectProjection)<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				<span class="hljs-keyword">return</span> err<br>			&#125;<br>			srckind.Type = typeForSrc<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> err := blder.ctrl.Watch(w.src, w.eventhandler, allPredicates...); err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> err<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>Watch 主要是监听我们想要的资源变化，<code>blder.ctrl.Watch(src, hdler, allPredicates...)</code>通过过滤源事件的变化，<code>allPredicates</code>是过滤器，只有所有的过滤器都返回 true 时，才会将事件传递给 EventHandler <code>hdler</code>，这里会将 Handler 注册到 Informer 上</p><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cm *controllerManager)</span> <span class="hljs-title">Start</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-params">(err error)</span></span> &#123;<br>	cm.internalCtx, cm.internalCancel = context.WithCancel(ctx)<br><br>	<span class="hljs-comment">// 这个用来表示所有的协程都已经退出了，</span><br>	stopComplete := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br>	<span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(stopComplete)<br>	<br>  <span class="hljs-comment">// ......</span><br><br>	<span class="hljs-comment">// 用于保存错误</span><br>	cm.errChan = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> error)<br><br>	<span class="hljs-comment">// 如果需要 metric 就启动 metric 服务</span><br>	<span class="hljs-keyword">if</span> cm.metricsListener != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">go</span> cm.serveMetrics()<br>	&#125;<br><br>	<span class="hljs-comment">// 启动健康检查服务</span><br>	<span class="hljs-keyword">if</span> cm.healthProbeListener != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">go</span> cm.serveHealthProbes()<br>	&#125;<br><br>  <br>	<span class="hljs-keyword">go</span> cm.startNonLeaderElectionRunnables()<br><br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">if</span> cm.resourceLock != <span class="hljs-literal">nil</span> &#123;<br>			err := cm.startLeaderElection()<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				cm.errChan &lt;- err<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">// Treat not having leader election enabled the same as being elected.</span><br>			<span class="hljs-built_in">close</span>(cm.elected)<br>			<span class="hljs-keyword">go</span> cm.startLeaderElectionRunnables()<br>		&#125;<br>	&#125;()<br><br>  <span class="hljs-comment">// 判断是否需要退出</span><br>	<span class="hljs-keyword">select</span> &#123;<br>	<span class="hljs-keyword">case</span> &lt;-ctx.Done():<br>		<span class="hljs-comment">// We are done</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>	<span class="hljs-keyword">case</span> err := &lt;-cm.errChan:<br>		<span class="hljs-comment">// Error starting or running a runnable</span><br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>无论是不是 leader 最后都会使用 <code>startRunnable</code> 启动 Controller</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cm *controllerManager)</span> <span class="hljs-title">startNonLeaderElectionRunnables</span><span class="hljs-params">()</span></span> &#123;<br>	cm.mu.Lock()<br>	<span class="hljs-keyword">defer</span> cm.mu.Unlock()<br><br>	cm.waitForCache(cm.internalCtx)<br><br>	<span class="hljs-comment">// Start the non-leaderelection Runnables after the cache has synced</span><br>	<span class="hljs-keyword">for</span> _, c := <span class="hljs-keyword">range</span> cm.nonLeaderElectionRunnables &#123;<br>		<span class="hljs-comment">// Controllers block, but we want to return an error if any have an error starting.</span><br>		<span class="hljs-comment">// Write any Start errors to a channel so we can return them</span><br>		cm.startRunnable(c)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>实际上是调用了 Controller 的 <code>Start</code>方法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Start implements controller.Controller</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Controller)</span> <span class="hljs-title">Start</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-title">error</span></span> &#123;<br><br>  <span class="hljs-comment">// Controller 只能被执行一次</span><br>	c.mu.Lock()<br>	<span class="hljs-keyword">if</span> c.Started &#123;<br>		<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;controller was started more than once. This is likely to be caused by being added to a manager multiple times&quot;</span>)<br>	&#125;<br><br>	<span class="hljs-comment">// Set the internal context.</span><br>	c.ctx = ctx<br><br>  <span class="hljs-comment">// 获取队列</span><br>	c.Queue = c.MakeQueue()<br>	<span class="hljs-keyword">defer</span> c.Queue.ShutDown()<br><br>	err := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br>		<span class="hljs-keyword">defer</span> c.mu.Unlock()<br><br>		<span class="hljs-keyword">defer</span> utilruntime.HandleCrash()<br><br>		<span class="hljs-comment">// 尝试等待缓存</span><br>		<span class="hljs-keyword">for</span> _, watch := <span class="hljs-keyword">range</span> c.startWatches &#123;<br>			c.Log.Info(<span class="hljs-string">&quot;Starting EventSource&quot;</span>, <span class="hljs-string">&quot;source&quot;</span>, watch.src)<br>			<span class="hljs-keyword">if</span> err := watch.src.Start(ctx, watch.handler, c.Queue, watch.predicates...); err != <span class="hljs-literal">nil</span> &#123;<br>				<span class="hljs-keyword">return</span> err<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">// 启动 Controller</span><br>		c.Log.Info(<span class="hljs-string">&quot;Starting Controller&quot;</span>)<br><br>    <br>		<span class="hljs-keyword">for</span> _, watch := <span class="hljs-keyword">range</span> c.startWatches &#123;<br>			syncingSource, ok := watch.src.(source.SyncingSource)<br>			<span class="hljs-keyword">if</span> !ok &#123;<br>				<span class="hljs-keyword">continue</span><br>			&#125;<br>			<span class="hljs-keyword">if</span> err := syncingSource.WaitForSync(ctx); err != <span class="hljs-literal">nil</span> &#123;<br>				<span class="hljs-comment">// This code is unreachable in case of kube watches since WaitForCacheSync will never return an error</span><br>				<span class="hljs-comment">// Leaving it here because that could happen in the future</span><br>				err := fmt.Errorf(<span class="hljs-string">&quot;failed to wait for %s caches to sync: %w&quot;</span>, c.Name, err)<br>				c.Log.Error(err, <span class="hljs-string">&quot;Could not wait for Cache to sync&quot;</span>)<br>				<span class="hljs-keyword">return</span> err<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">// All the watches have been started, we can reset the local slice.</span><br>		<span class="hljs-comment">//</span><br>		<span class="hljs-comment">// We should never hold watches more than necessary, each watch source can hold a backing cache,</span><br>		<span class="hljs-comment">// which won&#x27;t be garbage collected if we hold a reference to it.</span><br>		c.startWatches = <span class="hljs-literal">nil</span><br><br>		<span class="hljs-keyword">if</span> c.JitterPeriod == <span class="hljs-number">0</span> &#123;<br>			c.JitterPeriod = <span class="hljs-number">1</span> * time.Second<br>		&#125;<br><br>		<span class="hljs-comment">// Launch workers to process resources</span><br>		c.Log.Info(<span class="hljs-string">&quot;Starting workers&quot;</span>, <span class="hljs-string">&quot;worker count&quot;</span>, c.MaxConcurrentReconciles)<br>		ctrlmetrics.WorkerCount.WithLabelValues(c.Name).<br>		            Set(<span class="hljs-keyword">float64</span>(c.MaxConcurrentReconciles))<br>		<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; c.MaxConcurrentReconciles; i++ &#123;<br>			<span class="hljs-keyword">go</span> wait.UntilWithContext(ctx, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;<br>				<span class="hljs-comment">// 查询队列中有没有关注的事件，有的话就触发我们的 reconcile 逻辑</span><br>				<span class="hljs-keyword">for</span> c.processNextWorkItem(ctx) &#123;<br>				&#125;<br>			&#125;, c.JitterPeriod)<br>		&#125;<br><br>		c.Started = <span class="hljs-literal">true</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>	&#125;()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br><br>	&lt;-ctx.Done()<br>	c.Log.Info(<span class="hljs-string">&quot;Stopping workers&quot;</span>)<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// attempt to process it, by calling the reconcileHandler.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Controller)</span> <span class="hljs-title">processNextWorkItem</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-title">bool</span></span> &#123;<br>	obj, shutdown := c.Queue.Get()<br>	<span class="hljs-keyword">if</span> shutdown &#123;<br>		<span class="hljs-comment">// Stop working</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>	&#125;<br><br>	<span class="hljs-comment">// We call Done here so the workqueue knows we have finished</span><br>	<span class="hljs-comment">// processing this item. We also must remember to call Forget if we</span><br>	<span class="hljs-comment">// do not want this work item being re-queued. For example, we do</span><br>	<span class="hljs-comment">// not call Forget if a transient error occurs, instead the item is</span><br>	<span class="hljs-comment">// put back on the workqueue and attempted again after a back-off</span><br>	<span class="hljs-comment">// period.</span><br>	<span class="hljs-keyword">defer</span> c.Queue.Done(obj)<br><br>	ctrlmetrics.ActiveWorkers.WithLabelValues(c.Name).Add(<span class="hljs-number">1</span>)<br>	<span class="hljs-keyword">defer</span> ctrlmetrics.ActiveWorkers.WithLabelValues(c.Name).Add(<span class="hljs-number">-1</span>)<br><br>	c.reconcileHandler(ctx, obj)<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Reconcile 方法的触发是通过 Cache 中的 Informer 获取到资源的变更事件，然后再通过生产者消费者的模式触发我们自己实现的 Reconcile 方法的。</p><p>Kubebuilder 是一个非常好用的 Operator 开发框架，不仅极大的简化了 Operator 的开发过程，并且充分的利用了 go interface 的特性留下了足够的扩展性，这个我们可以学习，如果我们的业务代码开发框架能够做到这个地步，我觉得也就不错了</p><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span>架构图 <a target="_blank" rel="noopener" href="https://master.book.kubebuilder.io/architecture.html">https://master.book.kubebuilder.io/architecture.html</a><br><a href="#fnref:1" rev="footnote" class="footnote-backref">↩</a></span></span></li></ol></div></section><h2 id="关注我获取更新"><a href="#关注我获取更新" class="headerlink" title="关注我获取更新"></a>关注我获取更新<a class="anchorjs-link" aria-label="Anchor" data-anchorjs-icon="" href="#关注我获取更新" style="font:1em/1 anchorjs-icons;padding-left:.375em"></a></h2><div class="row"><div class="col-lg-6"><img style="width:100%" src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png" srcset="/img/loading.gif" alt="wechat"></div><div class="col-lg-2 col-4"><a target="_blank" href="http://s.zhihu.com/B4RT3"><img style="width:100%" src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png" srcset="/img/loading.gif" alt="知乎"></a></div><div class="col-lg-2 col-4"><a target="_blank" href="https://toutiao.io/subjects/387401?f=new"><img style="width:100%" src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png" srcset="/img/loading.gif" alt="开发者头条"></a></div><div class="col-lg-2 col-4"><a target="_blank" href="https://github.com/mohuishou"><img style="width:100%" src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png" srcset="/img/loading.gif" alt="github"></a></div></div><script>document.addEventListener("DOMContentLoaded",t=>{let e=$("#toc");1<=e.height()&&e.append(`
    <a
      class="fancybox fancybox.image"
      target="_blank" href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"
      itemscope=""
      itemtype="http://schema.org/ImageObject"
      itemprop="url"
      data-fancybox="default"
      rel="default noopener"
      title="wechat"
      data-caption="wechat"
      ><img
        style="width: 100%"
        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"
        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"
        alt="wechat"
      />
    `)})</script><h2 id="猜你喜欢">猜你喜欢</h2><ul><li><a href="/post/operator-03-kubebuilder-tutorial.html" rel="recommend">3. KubeBuilder 简明教程</a> <span></span></li><li><a href="/post/operator-05-kubebuilder-crud.html" rel="recommend">5. kubebuilder 实战: CRUD</a> <span></span></li><li><a href="/post/operator-06-kubebuilder-status-and-event.html" rel="recommend">6. kubebuilder 实战: status & event</a> <span></span></li><li><a href="/post/operator-07-kubebuilder-test.html" rel="recommend">7. kubebuilder 进阶: 测试</a> <span></span></li><li><a href="/post/operator-08-kubebuilder-webhook.html" rel="recommend">8. kubebuilder 进阶: webhook</a> <span></span></li></ul></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/kubernetes-%E7%B3%BB%E5%88%97/">kubernetes 系列</a> <a class="hover-with-bg" href="/categories/kubernetes-%E7%B3%BB%E5%88%97/Kubernetes-%E6%89%A9%E5%B1%95-Operator/">Kubernetes 扩展: Operator</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/Go/">Go</a> <a class="hover-with-bg" href="/tags/k8s/">k8s</a> <a class="hover-with-bg" href="/tags/operator/">operator</a> <a class="hover-with-bg" href="/tags/kubernetes/">kubernetes</a> <a class="hover-with-bg" href="/tags/kubebuilder/">kubebuilder</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a>，转载请注明出处，禁止全文转载</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/post/operator-11-summary.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">10. 总结</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/post/operator-08-kubebuilder-webhook.html"><span class="hidden-mobile">8. kubebuilder 进阶: webhook</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><script type="text/javascript">var light="github-light",dark="github-dark",schema="dark"===(schema=document.documentElement.getAttribute("data-user-color-scheme"))?dark:light;window.UtterancesThemeLight=light,window.UtterancesThemeDark=dark;var s=document.createElement("script");s.setAttribute("src","https://utteranc.es/client.js"),s.setAttribute("repo","scuplus/blogComment"),s.setAttribute("issue-term","pathname"),s.setAttribute("label","utterances"),s.setAttribute("theme",schema),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async","async"),document.getElementById("comments").appendChild(s)</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div><div id="bottom"><div id="bottom-drawer" class="bottom-drawer"><div class="sidebar"><p class="sidebar-header">kubernetes 系列</p><div class="sidebar-body" id="sidebar-body"><ol class="sidebar-list sidebar-list-1"><li class="sidebar-list-item"><a class="sidebar-title sidebar-title-ckpy587uy00a0fsoif4hh6gro" data-cid="ckpy587uy00a0fsoif4hh6gro" onclick='switchSideBar("ckpy587uy00a0fsoif4hh6gro")'>Kubernetes 扩展: Operator(10)</a><ol data-cid="ckpy587uy00a0fsoif4hh6gro" class="sidebar-list sidebar-list-2 sidebar-is-collapsible sidebar-ckpy587uy00a0fsoif4hh6gro"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-01-overview.html">1. Operator概述: 如何对 Kubernetes 进行扩展</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-02-use-kind-create-k8s-local-cluster.html">2. Kind: 如何快速搭建本地 K8s 开发环境？</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-03-kubebuilder-tutorial.html">3. KubeBuilder 简明教程</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-04-kustomize-tutorial.html">4. kustomize 简明教程</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-05-kubebuilder-crud.html">5. kubebuilder 实战: CRUD</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-06-kubebuilder-status-and-event.html">6. kubebuilder 实战: status &amp; event</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-07-kubebuilder-test.html">7. kubebuilder 进阶: 测试</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-08-kubebuilder-webhook.html">8. kubebuilder 进阶: webhook</a></li><li class="sidebar-list-item is-active-li"><a class="sidebar-link sidebar-active-link" href="/post/operator-09-kubebuilder-code.html">9. kubebuilder 进阶: 源码分析</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-11-summary.html">10. 总结</a></li></ol></li></ol></div></div><script>function switchSideBar(s){$(".sidebar-title-"+s).toggleClass("sidebar-title-collapsed"),$(".sidebar-"+s).toggleClass("sidebar-is-collapsed")}</script><div id="toc-mobile"><div class="toc-body" id="toc-body-mobile"></div></div></div><div id="bottom-tab"><a class="sub-menu" onclick='showBottomDrawer(this,"#bottom-drawer .sidebar")'><i class="iconfont"></i> 章节 </a><a class="sub-menu" onclick='showBottomDrawer(this,"#bottom-drawer #toc-mobile")'><i class="iconfont"></i> 目录 </a><a href="#comments" class="sub-menu" onclick='showBottomDrawer(this,"#comments")'><i class="iconfont"></i> 评论</a></div></div><script>function showBottomDrawer(s,t){let e=document.querySelector("#bottom-tab");e.childNodes.forEach(t=>{t!=s&&t.classList&&t.classList.remove("active")}),"#comments"!=t&&s.classList.toggle("active");let o=document.querySelector("#bottom-drawer"),c=document.querySelector(t);o.childNodes.forEach(t=>{t!=c&&t.classList&&t.classList.remove("active")}),c.classList.toggle("active"),"#comments"!=t?(c.classList.contains("active")&&!o.classList.contains("active")&&o.classList.add("active"),!c.classList.contains("active")&&o.classList.contains("active")&&o.classList.remove("active")):o.classList.remove("active")}document.onreadystatechange=function(t){let s=$("#bottom-drawer");s.height()<=0||window.tocbot.init({tocSelector:"#toc-body-mobile",contentSelector:".markdown-body",headingSelector:"h1,h2,h3,h4",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:20})}</script></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><div class="col-lg-7 mx-auto nopadding-x-md"><div class="container custom mx-auto"><script>!function(e,s,p){var r;void 0===e.webpushr&&(e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)},r=s.getElementsByTagName(p)[0],(p=s.createElement(p)).id="webpushr-jssdk",p.async=1,p.src="https://cdn.webpushr.com/app.min.js",r.parentNode.appendChild(p))}(window,document,"script"),webpushr("setup",{key:"BBkZb7rpvsVqVNkORXD9T9T93MJodtpNJD5c1f2HE_XsED3r94An3CKObdyTJ6ub3ARm9LIdeDCVzKLBsK760NM"})</script></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script><script src="/js/debouncer-c523e4d3f8b7b837c19f74984acbabf7.js"></script><script src="/js/events-4e84ef10eba726c5b41efcb456e3626a.js"></script><script src="/js/plugins-ca6fb836896e0a0e60d594acac4010f1.js"></script><script src="/js/lazyload-e96b3165477d429bf8096bdbd068d816.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script src="/js/local-search-c277a106ee2a2e265fcd58887e53c0fb.js"></script><script>document.querySelector("#local-search-input").onclick=function(){searchFunc("/local-search.xml","local-search-input","local-search-result"),this.onclick=null}</script><script defer>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-137859264-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script>let sidebarBody=document.querySelector(".sidebar .sidebar-body"),sidebarActive=document.querySelector(".sidebar .is-active-li"),bc=sidebarBody.getBoundingClientRect(),ac=sidebarActive.getBoundingClientRect(),t=ac.y-bc.y-bc.height/2;0<t&&sidebarBody.scrollTo({top:t,behavior:"smooth"})</script><script src="/js/boot-b4d619350e67f5b3ceeb2164d30268e0.js"></script></body></html>