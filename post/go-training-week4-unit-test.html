<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/icons/touch-icon-apple.png"><link rel="icon" type="image/png" href="/icons/favicon-32x32.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content="mohuishou 的 技术博客, 关注云原生, Go, K8s, Docker, 微服务等技术"><meta name="author" content="Mohuishou"><meta name="keywords" content="Go,Docker,PHP,学习笔记,Go,Go进阶训练营,工程化,单元测试,Go进阶训练营,Week04: Go 工程化"><title>Go工程化(八) 单元测试 - Mohuishou</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main-8c4c5e426918ae095492d8a940e57fef.css"><link rel="stylesheet" href="/assets/css/custom-6db6671dbe84a966b9771f9ad2d73786.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"lailin.xyz",root:"/",version:"1.8.7",typing:{enable:!1,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,onlypost:!1},web_analytics:{enable:!0,baidu:null,google:"UA-137859264-1",gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}}}</script><script src="/js/utils-5ecdced2f65030c3508cf0b3db78f4ad.js"></script><script src="/js/color-schema-4678c2299d6eeb96e23435ea339c9331.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>mohuishou</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/"><i class="iconfont icon-category-fill"></i> Go 进阶训练营(更新中)</a></li><li class="nav-item"><a class="nav-link" href="/post/go-design-pattern.html"><i class="iconfont icon-notebook"></i> Go 设计模式</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 更多</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/links/"><i class="iconfont icon-link-fill"></i> 友链 </a><a class="dropdown-item" href="/atom.xml"><i class="iconfont icon-rss"></i> rss </a><a class="dropdown-item" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></div></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/bg.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="Go工程化(八) 单元测试">Go工程化(八) 单元测试</span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-03-09 10:08" pubdate>2021年3月9日 上午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3.4k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 45 分钟</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"><div class="sidebar"><p class="sidebar-header">Go进阶训练营</p><div class="sidebar-body" id="sidebar-body"><ol class="sidebar-list sidebar-list-1"><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckkm23xho0000m4t51q602czj").classList.toggle("sidebar-is-collapsed")'>Week01: 微服务</a><ol id="sidebar-ckkm23xho0000m4t51q602czj" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-01.html">微服务(一) 微服务概览</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-02.html">微服务(二) 服务发现&amp;多租户</a></li></ol></li><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckkm23ykh0003m4t53mln1w0n").classList.toggle("sidebar-is-collapsed")'>Week02: Go错误处理</a><ol id="sidebar-ckkm23ykh0003m4t53mln1w0n" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-03.html">Go错误处理最佳实践</a></li></ol></li><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckkm2667n000pm4t52z016wn0").classList.toggle("sidebar-is-collapsed")'>Week03: Go 并发编程</a><ol id="sidebar-ckkm2667n000pm4t52z016wn0" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-goroutine.html">Go并发编程(一) goroutine</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-go-memory-model.html">Go并发编程(二) Go 内存模型</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-data-race.html">Go并发编程(三) data race</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-sync.html">Go并发编程(四) 深入理解 Mutex</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-waitgroup.html">Go并发编程(六) 深入理解 WaitGroup</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-atomic.html">Go并发编程(五) 深入理解 sync/atomic</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-errgroup.html">Go并发编程(七) 深入理解 errgroup</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-once.html">Go并发编程(八) 深入理解 sync.Once</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-context.html">Go并发编程(九) 深入理解 Context</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-channel.html">Go并发编程(十) 深入理解 Channel</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-sum.html">Go并发编程(十一) 总结</a></li></ol></li><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckkm23zra000im4t5en8m0qy9").classList.toggle("sidebar-is-collapsed")'>Week04: Go 工程化</a><ol id="sidebar-ckkm23zra000im4t5en8m0qy9" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-clean-arch.html">Go工程化(一) 架构整洁之道阅读笔记</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-project-layout.html">Go工程化(二) 项目目录结构</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-wire.html">Go工程化(三) 依赖注入框架 wire</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-api-design.html">Go工程化(四) API 设计上: 项目结构 &amp; 设计</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-protoc-gen-go-gin.html">Go工程化(五) API 设计下: 基于 protobuf 自动生成 gin 代码</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-config.html">Go工程化(六) 配置管理</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-go-module.html">Go工程化(七) Go Module</a></li><li class="sidebar-list-item is-active-li"><a class="sidebar-link sidebar-active-link" href="/post/go-training-week4-unit-test.html">Go工程化(八) 单元测试</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-practice.html">Go工程化(九) 项目重构实践</a></li></ol></li><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckmgd197g000cieou0z682wci").classList.toggle("sidebar-is-collapsed")'>Week05: 评论系统架构设计</a><ol id="sidebar-ckmgd197g000cieou0z682wci" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week5-comment-design-1.html">评论系统架构设计（一）功能拆分&amp;架构设计</a></li></ol></li></ol></div></div></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">Go工程化(八) 单元测试</h1><div class="markdown-body"><h2 id="序"><a href="#序" class="headerlink" title="序"></a>序</h2><p>本系列为 <a target="_blank" rel="noopener" href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go 进阶训练营</a> 笔记，预计 2021Q2 完成更新，访问 <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">博客: Go 进阶训练营</a> 即可查看当前更新进度，部分文章篇幅较长，使用 PC 大屏浏览体验更佳。<strong>3 月进度: 05/15</strong> 3 月开始会尝试爆更模式，争取做到两天更新一篇文章，如果感兴趣可以拉到文章最下方获取关注方式。</p><p>从我们开始开发以来，应该很多人都提到过测试的重要性，而在所有的测试类型当中，以单元测试为代表的单元测试无疑是成本最小，性价比最高的一种，而且有的公司为了保证质量会要求单元测试覆盖率的指标（包括我们）</p><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1614514088908-363f1894-098c-47e5-8289-0e223adda8a6.png" srcset="/img/loading.gif" alt="image.png"><br>所以希望看完这篇文章，希望大家可以很快的在我们之前提出的项目结构上进行单元测试的编写，可以做到又快又好。<br>本文分为两部分，前半段会简单介绍一下 go 的单元测试怎么写，不会有很复杂的技巧，如果已经比较了解可以跳过，后半段会介绍一下我们在项目当中该如何写 “单元测试”</p><h2 id="单元测试简明教程"><a href="#单元测试简明教程" class="headerlink" title="单元测试简明教程"></a>单元测试简明教程</h2><h3 id="go-test"><a href="#go-test" class="headerlink" title="go test"></a>go test</h3><h4 id="一个简单的-🌰"><a href="#一个简单的-🌰" class="headerlink" title="一个简单的 🌰"></a>一个简单的 🌰</h4><p>项目结构</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">.<br>├── max.go<br>└── max_test.go<br></code></pre></td></tr></table></figure><p>max.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> max<br><br><span class="hljs-comment">// Int get the max</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Int</span><span class="hljs-params">(a, b <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;<br>	<span class="hljs-keyword">if</span> a &gt; b &#123;<br>		<span class="hljs-keyword">return</span> a<br>	&#125;<br>	<span class="hljs-keyword">return</span> b<br>&#125;<br></code></pre></td></tr></table></figure><p>max_test.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> max<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestInt</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	<span class="hljs-keyword">if</span> got := Int(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>); got != <span class="hljs-number">2</span> &#123;<br>		t.Errorf(<span class="hljs-string">&quot;exp: %d, got: %d&quot;</span>, <span class="hljs-number">2</span>, got)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>执行结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">▶ go <span class="hljs-built_in">test</span><br>PASS<br>ok      code/max        0.006s<br></code></pre></td></tr></table></figure><p><strong>单元测试文件说明</strong></p><ul><li>文件名必须是<code>_test.go</code>结尾的，这样在执行<code>go test</code>的时候才会执行到相应的代码。</li><li>你必须<code>import testing</code>这个包。</li><li>所有的测试用例函数必须是<code>Test</code>开头。</li><li>测试用例会按照源代码中写的顺序依次执行。</li><li>测试函数<code>TestX()</code>的参数是<code>testing.T</code>，我们可以使用该类型来记录错误或者是测试状态。</li><li>测试格式：<code>func TestXxx (t *testing.T)</code>,<code>Xxx</code>部分可以为任意的字母数字的组合，但是首字母不能是小写字母[a-z]，例如<code>Testintdiv</code>是错误的函数名。</li><li>函数中通过调用<code>testing.T</code>的<code>Error</code>, <code>Errorf</code>, <code>FailNow</code>, <code>Fatal</code>, <code>FatalIf</code>方法，说明测试不通过，调用<code>Log</code>方法用来记录测试的信息。</li></ul><h4 id="表驱动测试"><a href="#表驱动测试" class="headerlink" title="表驱动测试"></a>表驱动测试</h4><p>在实际编写单元测试的时候，我们往往需要执行多个测试用例，期望达到更全面的覆盖效果，这时候就需要使用表驱动测试了。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestInt_Table</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	tests := []<span class="hljs-keyword">struct</span> &#123;<br>		name <span class="hljs-keyword">string</span><br>		a    <span class="hljs-keyword">int</span><br>		b    <span class="hljs-keyword">int</span><br>		want <span class="hljs-keyword">int</span><br>	&#125;&#123;<br>		&#123;name: <span class="hljs-string">&quot;a&gt;b&quot;</span>, a: <span class="hljs-number">10</span>, b: <span class="hljs-number">2</span>, want: <span class="hljs-number">10</span>&#125;,<br>		&#123;name: <span class="hljs-string">&quot;a&lt;b&quot;</span>, a: <span class="hljs-number">1</span>, b: <span class="hljs-number">2</span>, want: <span class="hljs-number">2</span>&#125;,<br>	&#125;<br><br>	<span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;<br>		t.Run(tt.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>			<span class="hljs-keyword">if</span> got := Int(tt.a, tt.b); got != tt.want &#123;<br>				t.Errorf(<span class="hljs-string">&quot;exp: %d, got: %d&quot;</span>, tt.want, got)<br>			&#125;<br>		&#125;)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>执行结果</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go">▶ <span class="hljs-keyword">go</span> test -v<br>=== RUN   TestInt<br>--- PASS: TestInt (<span class="hljs-number">0.00</span>s)<br>=== RUN   TestInt_Table<br>=== RUN   TestInt_Table/a&gt;b<br>=== RUN   TestInt_Table/a&lt;b<br>--- PASS: TestInt_Table (<span class="hljs-number">0.00</span>s)<br>    --- PASS: TestInt_Table/a&gt;b (<span class="hljs-number">0.00</span>s)<br>    --- PASS: TestInt_Table/a&lt;b (<span class="hljs-number">0.00</span>s)<br>PASS<br></code></pre></td></tr></table></figure><p><strong>随机执行</strong><br>上面的例子是按照顺序执行的，单元测试大多随机执行更能够发现一些没有注意到的错误, 如下面的这个例子，利用 <code>map</code> 的特性我们很容易将上面这个例子改造为随机执行的单元测试</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestInt_RandTable</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	tests := <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">struct</span> &#123;<br>		a    <span class="hljs-keyword">int</span><br>		b    <span class="hljs-keyword">int</span><br>		want <span class="hljs-keyword">int</span><br>	&#125;&#123;<br>		<span class="hljs-string">&quot;a&gt;b&quot;</span>: &#123;a: <span class="hljs-number">10</span>, b: <span class="hljs-number">2</span>, want: <span class="hljs-number">10</span>&#125;,<br>		<span class="hljs-string">&quot;a&lt;b&quot;</span>: &#123;a: <span class="hljs-number">1</span>, b: <span class="hljs-number">2</span>, want: <span class="hljs-number">2</span>&#125;,<br>	&#125;<br><br>	<span class="hljs-keyword">for</span> name, tt := <span class="hljs-keyword">range</span> tests &#123;<br>		t.Run(name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>			<span class="hljs-keyword">if</span> got := Int(tt.a, tt.b); got != tt.want &#123;<br>				t.Errorf(<span class="hljs-string">&quot;exp: %d, got: %d&quot;</span>, tt.want, got)<br>			&#125;<br>		&#125;)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="testfiy"><a href="#testfiy" class="headerlink" title="testfiy"></a>testfiy</h3><p>标准库为我们提供了一个还不错的测试框架，但是没有提供断言的功能，<code>testify</code> 包含了 断言、mock、suite 三个功能，mock 推荐使用官方的 <code>gomock</code></p><p><code>testify/assert</code> 提供了非常多的方法，这里为大家介绍最为常用的一些，所有的方法可以访问 <a target="_blank" rel="noopener" href="https://godoc.org/github.com/stretchr/testify/assert">https://godoc.org/github.com/stretchr/testify/assert</a> 查看</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 判断两个值是否相等</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Equal</span><span class="hljs-params">(t TestingT, expected, actual <span class="hljs-keyword">interface</span>&#123;&#125;, msgAndArgs ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span><br><span class="hljs-comment">// 判断两个值不相等</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NotEqual</span><span class="hljs-params">(t TestingT, expected, actual <span class="hljs-keyword">interface</span>&#123;&#125;, msgAndArgs ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span><br><span class="hljs-comment">// 测试失败，测试中断</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FailNow</span><span class="hljs-params">(t TestingT, failureMessage <span class="hljs-keyword">string</span>, msgAndArgs ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span><br><span class="hljs-comment">// 判断值是否为nil，常用于 error 的判断</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Nil</span><span class="hljs-params">(t TestingT, object <span class="hljs-keyword">interface</span>&#123;&#125;, msgAndArgs ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span><br><span class="hljs-comment">// 判断值是否不为nil，常用于 error 的判断</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NotNil</span><span class="hljs-params">(t TestingT, object <span class="hljs-keyword">interface</span>&#123;&#125;, msgAndArgs ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span><br></code></pre></td></tr></table></figure><p>我们可以发现，断言方法都会返回一个 <code>bool</code> 值，我们可以通过这个返回值判断断言成功/失败，从而做一些处理</p><p>一个例子</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestInt_assert_fail</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	got := Int(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<br>	assert.Equal(t, <span class="hljs-number">1</span>, got)<br>&#125;<br></code></pre></td></tr></table></figure><p>执行结果, 可以看到输出十分的清晰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">=== RUN   TestInt_assert_fail<br>--- FAIL: TestInt_assert_fail (0.00s)<br>    max_test.go:62:<br>                Error Trace:    max_test.go:62<br>                Error:          Not equal:<br>                                expected: 1<br>                                actual  : 2<br>                Test:           TestInt_assert_fail<br>FAIL<br>FAIL    code/max        0.017s<br></code></pre></td></tr></table></figure><h3 id="gomock"><a href="#gomock" class="headerlink" title="gomock"></a>gomock</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p><strong>注意: 请在非项目文件夹执行下面这条命令</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">GO111MODULE=on GOPROXY=https://goproxy.cn go get github.com/golang/mock/mockgen<br></code></pre></td></tr></table></figure><p><code>mockgen</code> 是一个代码生成工具，可以对包或者源代码文件生成指定<strong>接口</strong>的 Mock 代码</p><h4 id="生成-Mock-代码"><a href="#生成-Mock-代码" class="headerlink" title="生成 Mock 代码"></a>生成 Mock 代码</h4><p>指定源文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">mockgen -<span class="hljs-built_in">source</span>=./.go  -destination=./a_mock.go  INeedMockInterface<br><br>mockgen -<span class="hljs-built_in">source</span>=源文件路径  -destination=写入文件的路径(没有这个参数输出到终端) 需要mock的接口名(多个接口逗号间隔)<br></code></pre></td></tr></table></figure><p>指定包路径</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mockgen  -destination=写入文件的路径(没有这个参数输出到终端) 包路径 需要mock的接口名(多个接口逗号间隔)<br></code></pre></td></tr></table></figure><h4 id="一个简单的-gomock-🌰"><a href="#一个简单的-gomock-🌰" class="headerlink" title="一个简单的 gomock 🌰"></a>一个简单的 gomock 🌰</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// UserAge 获取用户年龄</span><br><span class="hljs-keyword">type</span> UserAge <span class="hljs-keyword">interface</span> &#123;<br>	GetAge(user <span class="hljs-keyword">string</span>) <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-comment">// Simple 一个简单的例子</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Simple</span><span class="hljs-params">(user <span class="hljs-keyword">string</span>, age UserAge)</span> <span class="hljs-title">string</span></span> &#123;<br>	<span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;%s age is: %d&quot;</span>, user, age.GetAge(user))<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSimple</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	<span class="hljs-comment">// 新建一个mock对象</span><br>	ctrl := gomock.NewController(t)<br>	age := mock_mock.NewMockUserAge(ctrl)<br><br>  <span class="hljs-comment">// mock 返回值</span><br>	age.EXPECT().GetAge(gomock.Any()).Return(<span class="hljs-number">1</span>).AnyTimes()<br><br>	assert.Equal(t, <span class="hljs-string">&quot;a age is: 1&quot;</span>, Simple(<span class="hljs-string">&quot;a&quot;</span>, age))<br>&#125;<br></code></pre></td></tr></table></figure><div style="background:#e8f7ff;padding:10px;border:1px solid #abd2da;border-radius:5px;margin-bottom:5px">本文只是简单介绍用法，详细使用及 API 说明可以查看官方仓库，<a target="_blank" rel="noopener" href="https://github.com/golang/mock">https://github.com/golang/mock</a></div><h2 id="项目-“单元测试”"><a href="#项目-“单元测试”" class="headerlink" title="项目 “单元测试”"></a>项目 “单元测试”</h2><p>接下来就是本文的重点，在我们之前提到的 <a href="https://lailin.xyz/post/go-training-week4-project-layout.html">Go 工程化(二) 项目目录结构</a> 当中，如何编写单元测试。虽然这里说的是单元测试，其实后面讲的其实很多不是单元测试，像 repo 层，如果涉及到数据库后面就会讲到我们一般会启动一个真实的数据库来测试，这其实已经算是集成测试了，但是它仍然是轻量级的。</p><h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><p>这一层主要处理的 dto 和 do 数据之间的相互转换，本身是不含什么业务逻辑的，目前我们使用的是 http，所以在这一层的测试一般会使用 httptest 来模拟实际请求的测试。然后在对 usecase 层的调用上，我们使用 gomock mock 掉相关的接口，简化我们的测试。如果你不想写的那么麻烦，也可以不用启用 httptest 来测试，直接测试 service 层的代码也是可以的，不过这样的话，service 层的代码测试的内容就没有多少了，也就是看转换数据的时候符不符合预期。</p><p>这一层主要完成的测试是</p><ul><li>参数的校验是否符合预期</li><li>数据的转换是否符合预期，如果你像我一样偷懒使用了类似 <a target="_blank" rel="noopener" href="https://pkg.go.dev/github.com/jinzhu/copier">copier</a> 的工具的话一定要写这部分的单元测试，不然还是很容易出错，容易字段名不一致导致 copier 的工作不正常</li></ul><p>当然如果时间有限的话，这一层的测试也不是必须的，因为接入层相对来说变化也比较快一点，这是说写了单元测试，基本上在测试阶段很少会出现由于参数的问题提交过来的 bug</p><p>同样我们直接看一个例子, 首先是 service 层的代码，可以看到逻辑很简单，就是调用了一下，usecase 层的接口</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> _ v1.BlogServiceHTTPServer = &amp;PostService&#123;&#125;<br><br><span class="hljs-comment">// PostService PostService</span><br><span class="hljs-keyword">type</span> PostService <span class="hljs-keyword">struct</span> &#123;<br>	Usecase domain.IPostUsecase<br>&#125;<br><br><span class="hljs-comment">// CreateArticle 创建文章</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *PostService)</span> <span class="hljs-title">CreateArticle</span><span class="hljs-params">(ctx context.Context, req *v1.Article)</span> <span class="hljs-params">(*v1.Article, error)</span></span> &#123;<br>	article, err := p.Usecase.CreateArticle(ctx, domain.Article&#123;<br>		Title:    req.Title,<br>		Content:  req.Content,<br>		AuthorID: req.AuthorId,<br>	&#125;)<br><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br><br>	<span class="hljs-keyword">var</span> resp v1.Article<br>	err = copier.Copy(&amp;resp, &amp;article)<br>	<span class="hljs-keyword">return</span> &amp;resp, err<br>&#125;<br></code></pre></td></tr></table></figure><p>再看看单元测试<br>首先是初始化，之前我们讲到初始化的时候我们一般在 cmd 当中使用 wire 自动生成，但是在单元测试中 wire 并不好用，并且由于单元测试的时候我们的依赖项其实没有真实的依赖项那么复杂我们只需要关心当前这一层的依赖即可，所以一般在单元测试的时候我都是手写初始化<br>一般会向下面这样，使用一个 struct 包装起来，因为在后面像是 mock 的 usecase 还需要调用</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> testPostService <span class="hljs-keyword">struct</span> &#123;<br>	post    *PostService<br>	usecase *mock_domain.MockIPostUsecase<br>	handler *gin.Engine<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initPostService</span><span class="hljs-params">(t *testing.T)</span> *<span class="hljs-title">testPostService</span></span> &#123;<br>	ctrl := gomock.NewController(t)<br>	usecase := mock_domain.NewMockIPostUsecase(ctrl)<br>	service := &amp;PostService&#123;Usecase: usecase&#125;<br><br>	handler := gin.New()<br>	v1.RegisterBlogServiceHTTPServer(handler, service)<br><br>	<span class="hljs-keyword">return</span> &amp;testPostService&#123;<br>		post:    service,<br>		usecase: usecase,<br>		handler: handler,<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>实际的测试，这一块主要是为了展示一个完整的单元测试所以贴的代码稍微长了一些，后面的两层具体的单元测试代码都大同小异，我就不再贴了，主要的思路就是把依赖的接口都用 gomock mock 掉，这样实际写单元测试代码的时候就会比较简单。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestPostService_CreateArticle</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	s := initPostService(t)<br>	s.usecase.EXPECT().<br>		CreateArticle(gomock.Any(), gomock.Eq(domain.Article&#123;Title: <span class="hljs-string">&quot;err&quot;</span>, AuthorID: <span class="hljs-number">1</span>&#125;)).<br>		Return(domain.Article&#123;&#125;, fmt.Errorf(<span class="hljs-string">&quot;err&quot;</span>))<br>	s.usecase.EXPECT().<br>		CreateArticle(gomock.Any(), gomock.Eq(domain.Article&#123;Title: <span class="hljs-string">&quot;success&quot;</span>, AuthorID: <span class="hljs-number">2</span>&#125;)).<br>		Return(domain.Article&#123;Title: <span class="hljs-string">&quot;success&quot;</span>&#125;, <span class="hljs-literal">nil</span>)<br><br>	tests := []<span class="hljs-keyword">struct</span> &#123;<br>		name       <span class="hljs-keyword">string</span><br>		params     *v1.Article<br>		want       *v1.Article<br>		wantStatus <span class="hljs-keyword">int</span><br>		wantCode   <span class="hljs-keyword">int</span><br>		wantErr    <span class="hljs-keyword">string</span><br>	&#125;&#123;<br>		&#123;<br>			name: <span class="hljs-string">&quot;参数错误 author_id 必须&quot;</span>,<br>			params: &amp;v1.Article&#123;<br>				Title:    <span class="hljs-string">&quot;1&quot;</span>,<br>				Content:  <span class="hljs-string">&quot;2&quot;</span>,<br>				AuthorId: <span class="hljs-number">0</span>,<br>			&#125;,<br>			want:       <span class="hljs-literal">nil</span>,<br>			wantStatus: <span class="hljs-number">400</span>,<br>			wantCode:   <span class="hljs-number">400</span>,<br>		&#125;,<br>		&#123;<br>			name: <span class="hljs-string">&quot;失败&quot;</span>,<br>			params: &amp;v1.Article&#123;<br>				Title:    <span class="hljs-string">&quot;err&quot;</span>,<br>				AuthorId: <span class="hljs-number">1</span>,<br>			&#125;,<br>			want:       <span class="hljs-literal">nil</span>,<br>			wantStatus: <span class="hljs-number">500</span>,<br>			wantCode:   <span class="hljs-number">-1</span>,<br>		&#125;,<br>		&#123;<br>			name: <span class="hljs-string">&quot;成功&quot;</span>,<br>			params: &amp;v1.Article&#123;<br>				Title:    <span class="hljs-string">&quot;success&quot;</span>,<br>				AuthorId: <span class="hljs-number">2</span>,<br>			&#125;,<br>			want: &amp;v1.Article&#123;<br>				Title: <span class="hljs-string">&quot;success&quot;</span>,<br>			&#125;,<br>			wantStatus: <span class="hljs-number">200</span>,<br>			wantCode:   <span class="hljs-number">0</span>,<br>		&#125;,<br>	&#125;<br>	<span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;<br>		t.Run(tt.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>			<span class="hljs-comment">// 下面这些一般都会封装在一起，这里是为了演示</span><br><br>			<span class="hljs-comment">// 初始化请求</span><br>			b, err := json.Marshal(tt.params)<br>			require.NoError(t, err)<br>			uri := fmt.Sprintf(<span class="hljs-string">&quot;/v1/author/%d/articles&quot;</span>, tt.params.AuthorId)<br>			req := httptest.NewRequest(http.MethodPost, uri, bytes.NewReader(b))<br><br>			<span class="hljs-comment">// 初始化响应</span><br>			w := httptest.NewRecorder()<br><br>			<span class="hljs-comment">// 调用相应的handler接口</span><br>			s.handler.ServeHTTP(w, req)<br><br>			<span class="hljs-comment">// 提取响应</span><br>			resp := w.Result()<br>			<span class="hljs-keyword">defer</span> resp.Body.Close()<br>			require.Equal(t, tt.wantStatus, resp.StatusCode)<br><br>			<span class="hljs-comment">// 读取响应body</span><br>			respBody, _ := ioutil.ReadAll(resp.Body)<br>			r := <span class="hljs-keyword">struct</span> &#123;<br>				Code <span class="hljs-keyword">int</span>         <span class="hljs-string">`json:&quot;code&quot;`</span><br>				Msg  <span class="hljs-keyword">string</span>      <span class="hljs-string">`json:&quot;msg&quot;`</span><br>				Data *v1.Article <span class="hljs-string">`json:&quot;data&quot;`</span><br>			&#125;&#123;&#125;<br>			require.NoError(t, json.Unmarshal(respBody, &amp;r))<br><br>			assert.Equal(t, tt.wantCode, r.Code)<br>			assert.Equal(t, tt.want, r.Data)<br>		&#125;)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="usecase"><a href="#usecase" class="headerlink" title="usecase"></a>usecase</h3><p>usecase 是主要的业务逻辑，所以一般写单元测试的时候都应该先写这一层的单远测试，而且这一层我们没有任何依赖，只需要把 repo 层的接口直接 mock 掉就可以了，是非常纯净的一层，其实也就这一层的单元测试才是真正的单元测试</p><h3 id="repo"><a href="#repo" class="headerlink" title="repo"></a>repo</h3><p>repo 层我们一般依赖 mysql 或者是 redis 等数据库，在测试的时候我们可以直接启动一个全新的数据库用于测试即可。</p><h4 id="本地"><a href="#本地" class="headerlink" title="本地"></a>本地</h4><p>直接使用 docker run 对应的数据库就可以了</p><h4 id="ci-cd"><a href="#ci-cd" class="headerlink" title="ci/cd"></a>ci/cd</h4><p>我们的 ci cd 是使用的 gitlab，gitlab 有一个比较好用的功能是指定 service，只需要指定对应的数据库镜像我们就可以在测试容器启动的时候自动启动对应的测试数据库容器，并且每一次都是全新的空数据库。我们只需要每次跑单元测试的时候先跑一下数据库的 migration 就可以了。</p><p>下面给出一个配置示例</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">test:</span><br>  <span class="hljs-attr">stage:</span> <span class="hljs-string">test</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">golang:1.15-alpine-test</span><br>  <span class="hljs-attr">services:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">redis:v4.0.11</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">postgres:10-alpine</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">docker:19-dind</span><br>  <span class="hljs-attr">variables:</span><br>    <span class="hljs-attr">POSTGRES_DB:</span> <span class="hljs-string">test_db</span><br>    <span class="hljs-attr">POSTGRES_USER:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">POSTGRES_PASSWORD:</span> <span class="hljs-number">1234567</span><br>    <span class="hljs-attr">GOPROXY:</span> <span class="hljs-string">&quot;这里设置 proxy 地址&quot;</span><br>    <span class="hljs-attr">CGO_ENABLED:</span> <span class="hljs-number">0</span><br>  <span class="hljs-attr">script:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">go</span> <span class="hljs-string">mod</span> <span class="hljs-string">download</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">go</span> <span class="hljs-string">run</span> <span class="hljs-string">db/*.go</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">mkdir</span> <span class="hljs-string">artifacts</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">gotestsum</span> <span class="hljs-string">--</span> <span class="hljs-string">-p</span> <span class="hljs-number">1</span> <span class="hljs-string">-v</span> <span class="hljs-string">-coverprofile=./artifacts/coverage.out</span> <span class="hljs-string">-coverpkg=./...</span> <span class="hljs-string">./...</span><br>    <span class="hljs-comment"># 单元测试统计去除一些不需要测试的代码</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">|</span><br>      <span class="hljs-string">cat</span> <span class="hljs-string">./artifacts/coverage.out</span> <span class="hljs-string">|</span> <span class="hljs-string">\</span><br>      <span class="hljs-string">grep</span> <span class="hljs-string">-v</span> <span class="hljs-string">&quot;/mock/&quot;</span> <span class="hljs-string">|</span> <span class="hljs-string">grep</span> <span class="hljs-string">-v</span> <span class="hljs-string">&quot;/db/&quot;</span> <span class="hljs-string">|</span>  <span class="hljs-string">grep</span> <span class="hljs-string">-v</span> <span class="hljs-string">&quot;pb.go&quot;</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">./artifacts/coverage.out2</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">go</span> <span class="hljs-string">tool</span> <span class="hljs-string">cover</span> <span class="hljs-string">-func=./artifacts/coverage.out2</span><br>  <span class="hljs-comment"># 捕获单元测试覆盖率在 gitlab job 上显示</span><br>  <span class="hljs-attr">coverage:</span> <span class="hljs-string">&#x27;/total:\s+.*\s+\d+\.\d+%/&#x27;</span><br>  <span class="hljs-attr">artifacts:</span><br>    <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">artifacts/coverage.out</span><br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>单元测试的介绍就到这里了，这篇文章从单元测试的基本写法，再到我们在项目当中如何写单元测试都简单介绍了一下，希望你看了这篇文章能有所收获。</p><p>同时我们 Go 工程化 这一章节的内容也接近尾声了，整理的材料也挺多的，下一篇就是这一节的最后一篇文章，讲一讲我在真实改造一个项目的时候遇到的一些问题和解决方案。</p><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ol><li><a target="_blank" rel="noopener" href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go 进阶训练营-极客时间</a></li><li><a target="_blank" rel="noopener" href="https://github.com/stretchr/testify">https://github.com/stretchr/testify</a></li><li><a target="_blank" rel="noopener" href="https://github.com/golang/mock">https://github.com/golang/mock</a></li><li><a target="_blank" rel="noopener" href="https://pkg.go.dev/github.com/jinzhu/copier">https://pkg.go.dev/github.com/jinzhu/copier</a></li></ol><div><h2 id="相关推荐">相关推荐</h2><ul><li><a href="https://lailin.xyz/post/go-training-week5-comment-design-1.html">评论系统架构设计（一）功能拆分&架构设计</a></li><li><a href="https://lailin.xyz/post/go-training-week4-practice.html">Go工程化(九) 项目重构实践</a></li><li><a href="https://lailin.xyz/post/go-training-week4-go-module.html">Go工程化(七) Go Module</a></li></ul></div></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">Go进阶训练营</a> <a class="hover-with-bg" href="/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/Week04-Go-%E5%B7%A5%E7%A8%8B%E5%8C%96/">Week04: Go 工程化</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> <a class="hover-with-bg" href="/tags/Go/">Go</a> <a class="hover-with-bg" href="/tags/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">Go进阶训练营</a> <a class="hover-with-bg" href="/tags/%E5%B7%A5%E7%A8%8B%E5%8C%96/">工程化</a> <a class="hover-with-bg" href="/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/">单元测试</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a>，转载请注明出处，禁止全文转载</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/post/go-training-week4-practice.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Go工程化(九) 项目重构实践</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/post/go-training-week4-go-module.html"><span class="hidden-mobile">Go工程化(七) Go Module</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><script type="text/javascript">Fluid.utils.waitElementVisible("comments",function(){var t="github-light",e="github-dark",s="dark"===(s=document.documentElement.getAttribute("data-user-color-scheme"))?e:t;window.UtterancesThemeLight=t,window.UtterancesThemeDark=e;e=document.createElement("script");e.setAttribute("src","https://utteranc.es/client.js"),e.setAttribute("repo","scuplus/blogComment"),e.setAttribute("issue-term","pathname"),e.setAttribute("label","utterances"),e.setAttribute("theme",s),e.setAttribute("crossorigin","anonymous"),document.getElementById("comments").appendChild(e)})</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div><div id="bottom"><div id="bottom-drawer" class="bottom-drawer"><div class="sidebar"><p class="sidebar-header">Go进阶训练营</p><div class="sidebar-body" id="sidebar-body"><ol class="sidebar-list sidebar-list-1"><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckkm23xho0000m4t51q602czj").classList.toggle("sidebar-is-collapsed")'>Week01: 微服务</a><ol id="sidebar-ckkm23xho0000m4t51q602czj" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-01.html">微服务(一) 微服务概览</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-02.html">微服务(二) 服务发现&amp;多租户</a></li></ol></li><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckkm23ykh0003m4t53mln1w0n").classList.toggle("sidebar-is-collapsed")'>Week02: Go错误处理</a><ol id="sidebar-ckkm23ykh0003m4t53mln1w0n" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-03.html">Go错误处理最佳实践</a></li></ol></li><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckkm2667n000pm4t52z016wn0").classList.toggle("sidebar-is-collapsed")'>Week03: Go 并发编程</a><ol id="sidebar-ckkm2667n000pm4t52z016wn0" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-goroutine.html">Go并发编程(一) goroutine</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-go-memory-model.html">Go并发编程(二) Go 内存模型</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-data-race.html">Go并发编程(三) data race</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-sync.html">Go并发编程(四) 深入理解 Mutex</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-atomic.html">Go并发编程(五) 深入理解 sync/atomic</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-waitgroup.html">Go并发编程(六) 深入理解 WaitGroup</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-errgroup.html">Go并发编程(七) 深入理解 errgroup</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-once.html">Go并发编程(八) 深入理解 sync.Once</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-context.html">Go并发编程(九) 深入理解 Context</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-channel.html">Go并发编程(十) 深入理解 Channel</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-sum.html">Go并发编程(十一) 总结</a></li></ol></li><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckkm23zra000im4t5en8m0qy9").classList.toggle("sidebar-is-collapsed")'>Week04: Go 工程化</a><ol id="sidebar-ckkm23zra000im4t5en8m0qy9" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-clean-arch.html">Go工程化(一) 架构整洁之道阅读笔记</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-project-layout.html">Go工程化(二) 项目目录结构</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-wire.html">Go工程化(三) 依赖注入框架 wire</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-api-design.html">Go工程化(四) API 设计上: 项目结构 &amp; 设计</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-protoc-gen-go-gin.html">Go工程化(五) API 设计下: 基于 protobuf 自动生成 gin 代码</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-config.html">Go工程化(六) 配置管理</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-go-module.html">Go工程化(七) Go Module</a></li><li class="sidebar-list-item is-active-li"><a class="sidebar-link sidebar-active-link" href="/post/go-training-week4-unit-test.html">Go工程化(八) 单元测试</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-practice.html">Go工程化(九) 项目重构实践</a></li></ol></li><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckmgd197g000cieou0z682wci").classList.toggle("sidebar-is-collapsed")'>Week05: 评论系统架构设计</a><ol id="sidebar-ckmgd197g000cieou0z682wci" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week5-comment-design-1.html">评论系统架构设计（一）功能拆分&amp;架构设计</a></li></ol></li></ol></div></div><div id="toc-mobile"><div class="toc-body" id="toc-body-mobile"></div></div></div><div id="bottom-tab"><a class="sub-menu" onclick='showBottomDrawer(this,"#bottom-drawer .sidebar")'><i class="iconfont"></i> 章节 </a><a class="sub-menu" onclick='showBottomDrawer(this,"#bottom-drawer #toc-mobile")'><i class="iconfont"></i> 目录 </a><a href="#comments" class="sub-menu" onclick='showBottomDrawer(this,"#comments")'><i class="iconfont"></i> 评论</a></div></div><script>function showBottomDrawer(s,t){let e=document.querySelector("#bottom-tab");e.childNodes.forEach(t=>{t!=s&&t.classList&&t.classList.remove("active")}),"#comments"!=t&&s.classList.toggle("active");let o=document.querySelector("#bottom-drawer"),c=document.querySelector(t);o.childNodes.forEach(t=>{t!=c&&t.classList&&t.classList.remove("active")}),c.classList.toggle("active"),"#comments"!=t?(c.classList.contains("active")&&!o.classList.contains("active")&&o.classList.add("active"),!c.classList.contains("active")&&o.classList.contains("active")&&o.classList.remove("active")):o.classList.remove("active")}document.onreadystatechange=function(t){let s=$("#bottom-drawer");s.height()<=0||window.tocbot.init({tocSelector:"#toc-body-mobile",contentSelector:".markdown-body",headingSelector:"h1,h2,h3,h4",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:20})}</script></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><div class="col-lg-7 mx-auto nopadding-x-md"><div class="container custom mx-auto"><script>!function(e,s,p){var r;void 0===e.webpushr&&(e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)},r=s.getElementsByTagName(p)[0],(p=s.createElement(p)).id="webpushr-jssdk",p.async=1,p.src="https://cdn.webpushr.com/app.min.js",r.parentNode.appendChild(p))}(window,document,"script"),webpushr("setup",{key:"BBkZb7rpvsVqVNkORXD9T9T93MJodtpNJD5c1f2HE_XsED3r94An3CKObdyTJ6ub3ARm9LIdeDCVzKLBsK760NM"})</script></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script><script src="/js/debouncer-c523e4d3f8b7b837c19f74984acbabf7.js"></script><script src="/js/events-f495e9aefe2285fc712ba316bdf01b26.js"></script><script src="/js/plugins-93fa930e12b7596433529edc1b5458df.js"></script><script src="/js/lazyload-e96b3165477d429bf8096bdbd068d816.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script src="/js/local-search-c277a106ee2a2e265fcd58887e53c0fb.js"></script><script>document.querySelector("#local-search-input").onclick=function(){searchFunc("/local-search.xml","local-search-input","local-search-result"),this.onclick=null}</script><script defer>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-137859264-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script>let sidebarBody=document.querySelector(".sidebar .sidebar-body"),sidebarActive=document.querySelector(".sidebar .is-active-li"),bc=sidebarBody.getBoundingClientRect(),ac=sidebarActive.getBoundingClientRect(),t=ac.y-bc.y-bc.height/2;0<t&&sidebarBody.scrollTo({top:t,behavior:"smooth"})</script><script src="/js/boot-b4d619350e67f5b3ceeb2164d30268e0.js"></script><script src="/assets/js/post-content-4067526c74af06e5ffe9a190633d525a.js"></script></body></html>