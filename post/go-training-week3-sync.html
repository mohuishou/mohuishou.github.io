<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/icons/touch-icon-apple.png"><link rel="icon" type="image/png" href="/icons/favicon-32x32.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content><meta name="author" content="Mohuishou"><meta name="keywords" content="Go, Docker, PHP"><title>Week03: Goå¹¶å‘ç¼–ç¨‹(å››) æ·±å…¥ç†è§£ Mutex - Mohuishou</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/assets/css/custom.css"><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script></head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>mohuishou</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> å‹é“¾</a></li><li class="nav-item"><a class="nav-link" href="/atom.xml"><i class="iconfont icon-rss"></i> rss</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner intro-2" id="background" parallax="true" style="background:url(/img/bg.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container page-header text-center fade-in-up"><span class="h2" id="subtitle"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2020-12-26 13:08" pubdate>2020å¹´12æœˆ26æ—¥ ä¸‹åˆ</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 4.1k å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 56 åˆ†é’Ÿ</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto" id="post"><h1 style="display:none">Week03: Goå¹¶å‘ç¼–ç¨‹(å››) æ·±å…¥ç†è§£ Mutex</h1><div class="markdown-body" id="post-body"><blockquote><p>æœ¬ç³»åˆ—ä¸ºæå®¢æ—¶é—´ Go è¿›é˜¶è®­ç»ƒè¥ç¬”è®°ï¼ŒåŒæ­¥ç›´æ’­æ›´æ–°ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 1 ~ 2 ç¯‡æ–‡ç« ï¼Œåˆ° 202103 æœˆæ›´æ–°å®Œæˆ</p></blockquote><h1 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h1><p>å‰é¢å‡ ç¯‡æ–‡ç« å½“ä¸­æˆ‘ä»¬éƒ½åå¤æåˆ°äº† goroutine åˆ›å»ºæ˜¯ç®€å•çš„ï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶è¦å°å¿ƒï¼Œä¹ æƒ¯æ€»ä¼šä¸ç»æ„é—´çš„å¯¼è‡´æˆ‘ä»¬å†™å‡ºå¾ˆå¤š bug å¯¹äºè¯­è¨€è§„èŒƒæ²¡æœ‰å®šä¹‰çš„å†…å®¹æˆ‘ä»¬ä¸è¦åšä»»ä½•å‡è®¾ã€‚æˆ‘ä»¬éœ€è¦é€šè¿‡åŒæ­¥è¯­ä¹‰æ§åˆ¶ä»–ä»¬çš„æ‰§è¡Œé¡ºåºï¼Œå…³äºä¹‹å‰çš„å†…å®¹å¯ä»¥çœ‹å‰é¢çš„ä¸‰ç¯‡æ–‡ç« ï¼š</p><ul><li><a href="https://lailin.xyz/post/go-training-week3-goroutine.html">Week03: Go å¹¶å‘ç¼–ç¨‹(ä¸€) goroutine</a></li><li><a href="https://lailin.xyz/post/go-training-week3-go-memory-model.html">Week03: Go å¹¶å‘ç¼–ç¨‹(äºŒ) Go å†…å­˜æ¨¡å‹</a></li><li><a href="https://lailin.xyz/post/go-training-week3-data-race.html">Week03: Go å¹¶å‘ç¼–ç¨‹(ä¸‰) data race</a></li></ul><p>æ¥ä¸‹æ¥çš„å‡ ç¯‡æ–‡ç« å°±è®©æˆ‘ä»¬æˆ‘ä»¬ä¸€èµ·æ¥äº†è§£ä¸€ä¸‹ sync åŒ…ç›¸å…³çš„ä¸€äº›ç”¨æ³•ï¼Œä»¥åŠéƒ¨åˆ†å®ç°åŸç†ï¼Œå½“ç„¶è¿™é‡Œè¯´æ˜¯ sync åŒ…ï¼Œå®é™…ä¸ŠåŒ…å«äº†ä¸‰ä¸ªåŒ…åˆ†åˆ«æ˜¯: sync, sync/atomic, golang.org/x/sync/errgroup</p><div style="background:#fffbe6;padding:10px;border:1px solid #c3c3c3;border-radius:5px;margin-bottom:5px">è¿™äº›åŒ…æä¾›äº†ä¸€äº›åŸºç¡€çš„åŒæ­¥è¯­ä¹‰ï¼Œä½†æ˜¯åœ¨å®é™…çš„å¹¶å‘ç¼–ç¨‹å½“ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ channel æ¥è¿›è¡ŒåŒæ­¥æ§åˆ¶ã€‚â€œShare memory by communicating; donâ€™t communicate by sharing memory.â€</div><h1 id="Mutex"><a href="#Mutex" class="headerlink" title="Mutex"></a>Mutex</h1><h2 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ä¸Šä¸€ç¯‡æ–‡ç« è¯´åˆ°çš„ä¾‹å­åº”è¯¥æ€ä¹ˆæ”¹</p><pre><code class="hljs go"><span class="hljs-keyword">var</span> mu sync.Mutex

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">2</span>; i++ &#123;
		wg.Add(<span class="hljs-number">1</span>)
		<span class="hljs-keyword">go</span> routine(i)
	&#125;
	wg.Wait()
	fmt.Printf(<span class="hljs-string">"Final Counter: %d\n"</span>, counter)
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">routine</span><span class="hljs-params">(id <span class="hljs-keyword">int</span>)</span></span> &#123;
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++ &#123;
		mu.Lock()
		counter++
		mu.Unlock()
	&#125;
	wg.Done()
&#125;</code></pre><p>è¿™é‡Œä¸»è¦çš„ç›®çš„å°±æ˜¯ä¸ºäº†ä¿æŠ¤æˆ‘ä»¬ä¸´ç•ŒåŒºçš„æ•°æ®ï¼Œé€šè¿‡é”æ¥è¿›è¡Œä¿è¯ã€‚é”çš„ä½¿ç”¨éå¸¸çš„ç®€å•ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹</p><ul><li>é”çš„èŒƒå›´è¦å°½é‡çš„å°ï¼Œä¸è¦æå¾ˆå¤šå¤§é”</li><li>ç”¨é”ä¸€å®šè¦è§£é”ï¼Œå°å¿ƒäº§ç”Ÿæ­»é”</li></ul><h2 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åœ¨ Go ä¸­é”æ˜¯æ€ä¹ˆå®ç°çš„</p><h3 id="é”çš„å®ç°æ¨¡å¼-5"><a href="#é”çš„å®ç°æ¨¡å¼-5" class="headerlink" title="é”çš„å®ç°æ¨¡å¼[5]"></a>é”çš„å®ç°æ¨¡å¼[5]</h3><ul><li><strong>Barging</strong>: è¿™ç§æ¨¡å¼æ˜¯ä¸ºäº†æé«˜ååé‡ï¼Œå½“é”è¢«é‡Šæ”¾æ—¶ï¼Œå®ƒä¼šå”¤é†’ç¬¬ä¸€ä¸ªç­‰å¾…è€…ï¼Œç„¶åæŠŠé”ç»™ç¬¬ä¸€ä¸ªç­‰å¾…è€…æˆ–è€…ç»™ç¬¬ä¸€ä¸ªè¯·æ±‚é”çš„äºº</li></ul><p><img src="https://lailin.xyz/images/1608967840701-d8c54ee4-964b-49d0-8fab-6f98dd777fd2.png" srcset="/img/loading.gif" alt="1_B1atM-b6GPDS0_Q_TPEUBw.png"></p><ul><li><strong>Handoff: </strong>å½“é”é‡Šæ”¾æ—¶å€™ï¼Œé”ä¼šä¸€ç›´æŒæœ‰ç›´åˆ°ç¬¬ä¸€ä¸ªç­‰å¾…è€…å‡†å¤‡å¥½è·å–é”ã€‚å®ƒé™ä½äº†ååé‡ï¼Œå› ä¸ºé”è¢«æŒæœ‰ï¼Œå³ä½¿å¦ä¸€ä¸ª goroutine å‡†å¤‡è·å–å®ƒã€‚<strong><em>è¿™ç§æ¨¡å¼å¯ä»¥è§£å†³å…¬å¹³æ€§çš„é—®é¢˜ï¼Œå› ä¸ºåœ¨ Barging æ¨¡å¼ä¸‹å¯èƒ½ä¼šå­˜åœ¨è¢«å”¤é†’çš„ goroutine æ°¸è¿œä¹Ÿè·å–ä¸åˆ°é”çš„æƒ…å†µï¼Œæ¯•ç«Ÿä¸€ç›´åœ¨ cpu ä¸Šè·‘ç€çš„ goroutine æ²¡æœ‰ä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šæ›´å¿«ä¸€äº›ã€‚ç¼ºç‚¹å°±æ˜¯æ€§èƒ½ä¼šç›¸å¯¹å·®ä¸€äº›</em></strong></li></ul><p><img src="https://lailin.xyz/images/1608967902210-d4c2937f-56fd-49e8-a5a3-903bec31e6fc.png" srcset="/img/loading.gif" alt="image.png"></p><ul><li><strong>Spiningï¼š</strong>è‡ªæ—‹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…åº”ç”¨ç¨‹åºé‡åº¦ä½¿ç”¨é”æ—¶æ•ˆæœä¸é”™ã€‚Parking å’Œ Unparking goroutines æœ‰ä¸ä½çš„æ€§èƒ½æˆæœ¬å¼€é”€ï¼Œç›¸æ¯”è‡ªæ—‹æ¥è¯´è¦æ…¢å¾—å¤šã€‚<em><strong>ä½†æ˜¯è‡ªæ—‹æ˜¯æœ‰æˆæœ¬çš„ï¼Œæ‰€ä»¥åœ¨ go çš„å®ç°ä¸­è¿›å…¥è‡ªæ—‹çš„æ¡ä»¶ååˆ†çš„è‹›åˆ»ã€‚</strong></em></li></ul><p><img src="https://lailin.xyz/images/1608967913891-eb4cf780-6ffd-4a2d-a3d5-8e05d7e3fce3.png" srcset="/img/loading.gif" alt="image.png"></p><h3 id="Go-Mutex-å®ç°åŸç†"><a href="#Go-Mutex-å®ç°åŸç†" class="headerlink" title="Go Mutex å®ç°åŸç†"></a>Go Mutex å®ç°åŸç†</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹åœ¨ Go ä¸­å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæˆ‘ä»¬å…ˆè®²åŸç†å†çœ‹æºç ï¼Œé¿å…çœ‹çš„äº‘é‡Œé›¾é‡Œçš„ã€‚**</p><h4 id="åŠ é”"><a href="#åŠ é”" class="headerlink" title="åŠ é”"></a>åŠ é”</h4><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒGo åœ¨ 1.15 çš„ç‰ˆæœ¬ä¸­é”çš„å®ç°ç»“åˆä¸Šé¢æåˆ°çš„ä¸‰ç§æ¨¡å¼ï¼Œè°ƒç”¨ Lock æ–¹æ³•çš„æ—¶å€™ã€‚</p><ol><li>é¦–å…ˆå¦‚æœå½“å‰é”å¤„äºåˆå§‹åŒ–çŠ¶æ€å°±ç›´æ¥ç”¨ CAS æ–¹æ³•å°è¯•è·å–é”ï¼Œè¿™æ˜¯<strong>_ Fast Path_</strong></li><li>å¦‚æœå¤±è´¥å°±è¿›å…¥<strong><em> Slow Path</em></strong><ol><li>ä¼šé¦–å…ˆåˆ¤æ–­å½“å‰èƒ½ä¸èƒ½è¿›å…¥è‡ªæ—‹çŠ¶æ€ï¼Œå¦‚æœå¯ä»¥å°±è¿›å…¥è‡ªæ—‹ï¼Œæœ€å¤šè‡ªæ—‹ 4 æ¬¡</li><li>è‡ªæ—‹å®Œæˆä¹‹åï¼Œå°±ä¼šå»è®¡ç®—å½“å‰çš„é”çš„çŠ¶æ€</li><li>ç„¶åå°è¯•é€šè¿‡ CAS è·å–é”</li><li>å¦‚æœæ²¡æœ‰è·å–åˆ°å°±è°ƒç”¨ <code>runtime_SemacquireMutex</code> æ–¹æ³•ä¼‘çœ å½“å‰ goroutine å¹¶ä¸”å°è¯•è·å–ä¿¡å·é‡</li><li>goroutine è¢«å”¤é†’ä¹‹åä¼šå…ˆåˆ¤æ–­å½“å‰æ˜¯å¦å¤„åœ¨é¥¥é¥¿çŠ¶æ€ï¼Œï¼ˆå¦‚æœå½“å‰ goroutine è¶…è¿‡ 1ms éƒ½æ²¡æœ‰è·å–åˆ°é”å°±ä¼šè¿›é¥¥é¥¿æ¨¡å¼ï¼‰ 1. å¦‚æœå¤„åœ¨é¥¥é¥¿çŠ¶æ€å°±ä¼šè·å¾—äº’æ–¥é”ï¼Œå¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸­åªå­˜åœ¨å½“å‰ Goroutineï¼Œäº’æ–¥é”è¿˜ä¼šä»é¥¥é¥¿æ¨¡å¼ä¸­é€€å‡º 1. å¦‚æœä¸åœ¨ï¼Œå°±ä¼šè®¾ç½®å”¤é†’å’Œé¥¥é¥¿æ ‡è®°ã€é‡ç½®è¿­ä»£æ¬¡æ•°å¹¶é‡æ–°æ‰§è¡Œè·å–é”çš„å¾ªç¯<br><div style="background:#fffbe6;padding:10px;border:1px solid #c3c3c3;border-radius:5px;margin-bottom:5px">CAS æ–¹æ³•åœ¨è¿™é‡ŒæŒ‡çš„æ˜¯ <code>atomic.CompareAndSwapInt32(addr, old, new) bool</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå…ˆæ¯”è¾ƒä¼ å…¥çš„åœ°å€çš„å€¼æ˜¯å¦æ˜¯ oldï¼Œå¦‚æœæ˜¯çš„è¯å°±å°è¯•èµ‹æ–°å€¼ï¼Œå¦‚æœä¸æ˜¯çš„è¯å°±ç›´æ¥è¿”å› falseï¼Œè¿”å› true æ—¶è¡¨ç¤ºèµ‹å€¼æˆåŠŸ<br>é¥¥é¥¿æ¨¡å¼æ˜¯ Go 1.9 ç‰ˆæœ¬ä¹‹åå¼•å…¥çš„ä¼˜åŒ–ï¼Œç”¨äºè§£å†³å…¬å¹³æ€§çš„é—®é¢˜[10]</div><br><img src="https://lailin.xyz/images/1608970759375-09d8cda7-77ac-48d3-b2f3-b8890e927bd4.svg" srcset="/img/loading.gif" alt="02_Goè¿›é˜¶03_blog_sync.drawio.svg"></li></ol></li></ol><h4 id="è§£é”"><a href="#è§£é”" class="headerlink" title="è§£é”"></a>è§£é”</h4><p>è§£é”çš„æµç¨‹ç›¸å¯¹äºåŠ é”ç®€å•è®¸å¤š<br><img src="https://lailin.xyz/images/1608978117259-455cf28e-aa1e-46cf-8fd6-6040ed6c0a7a.svg" srcset="/img/loading.gif" alt="02_Goè¿›é˜¶03_blog_sync.drawio.svg"></p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="Mutex-åŸºæœ¬ç»“æ„"><a href="#Mutex-åŸºæœ¬ç»“æ„" class="headerlink" title="Mutex åŸºæœ¬ç»“æ„"></a>Mutex åŸºæœ¬ç»“æ„</h3><p>çŸ¥é“å…¶ä¸­çš„åŸç†ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹æºç åˆ†æ</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Mutex <span class="hljs-keyword">struct</span> &#123;
	state <span class="hljs-keyword">int32</span>
	sema  <span class="hljs-keyword">uint32</span>
&#125;</code></pre><p><code>Mutex</code> ç»“æ„ä½“ç”± <code>state</code> <code>sema</code> ä¸¤ä¸ª 4 å­—èŠ‚æˆå‘˜ç»„æˆï¼Œå…¶ä¸­ <code>state</code> è¡¨ç¤ºäº†å½“å‰é”çš„çŠ¶æ€ï¼Œ <code>sema</code> æ˜¯ç”¨äºæ§åˆ¶é”çš„ä¿¡å·é‡<br><img src="https://lailin.xyz/images/1608972241012-8c0fe8e2-b1c8-4696-a9c4-454e11753e0f.svg" srcset="/img/loading.gif" alt="02_Goè¿›é˜¶03_blog_sync.drawio.svg"><br><code>state</code> å­—æ®µçš„æœ€ä½ä¸‰ä½è¡¨ç¤ºä¸‰ç§çŠ¶æ€ï¼Œåˆ†åˆ«æ˜¯ <code>mutexLocked</code> <code>mutexWoken</code> <code>mutexStarving</code> ï¼Œå‰©ä¸‹çš„ç”¨äºç»Ÿè®¡å½“å‰åœ¨ç­‰å¾…é”çš„ goroutine æ•°é‡</p><ul><li><code>mutexLocked</code> è¡¨ç¤ºæ˜¯å¦å¤„äºé”å®šçŠ¶æ€</li><li><code>mutexWoken</code> è¡¨ç¤ºæ˜¯å¦å¤„äºå”¤é†’çŠ¶æ€</li><li><code>mutexStarving</code> è¡¨ç¤ºæ˜¯å¦å¤„äºé¥¥é¥¿çŠ¶æ€</li></ul><h3 id="åŠ é”-1"><a href="#åŠ é”-1" class="headerlink" title="åŠ é”"></a>åŠ é”</h3><p>å›å‘³ä¸€ä¸‹ä¸Šé¢çœ‹åˆ°çš„æµç¨‹å›¾ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹äº’æ–¥é”æ˜¯å¦‚ä½•åŠ é”çš„</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mutex)</span> <span class="hljs-title">Lock</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-comment">// Fast path: grab unlocked mutex.</span>
	<span class="hljs-keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, <span class="hljs-number">0</span>, mutexLocked) &#123;
		<span class="hljs-keyword">return</span>
	&#125;
	<span class="hljs-comment">// Slow path (outlined so that the fast path can be inlined)</span>
	m.lockSlow()
&#125;</code></pre><ul><li>å½“æˆ‘ä»¬è°ƒç”¨ <code>Lock</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šå…ˆå°è¯•èµ° Fast Pathï¼Œä¹Ÿå°±æ˜¯å¦‚æœå½“å‰äº’æ–¥é”å¦‚æœå¤„äºæœªåŠ é”çš„çŠ¶æ€ï¼Œå°è¯•åŠ é”ï¼Œåªè¦åŠ é”æˆåŠŸå°±ç›´æ¥è¿”å›</li><li>å¦åˆ™çš„è¯å°±è¿›å…¥ slow path</li></ul><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mutex)</span> <span class="hljs-title">lockSlow</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-keyword">var</span> waitStartTime <span class="hljs-keyword">int64</span> <span class="hljs-comment">// ç­‰å¾…æ—¶é—´</span>
	starving := <span class="hljs-literal">false</span> <span class="hljs-comment">// æ˜¯å¦å¤„äºé¥¥é¥¿çŠ¶æ€</span>
	awoke := <span class="hljs-literal">false</span> <span class="hljs-comment">// æ˜¯å¦å¤„äºå”¤é†’çŠ¶æ€</span>
	iter := <span class="hljs-number">0</span> <span class="hljs-comment">// è‡ªæ—‹è¿­ä»£æ¬¡æ•°</span>
	old := m.state
	<span class="hljs-keyword">for</span> &#123;
		<span class="hljs-comment">// Don't spin in starvation mode, ownership is handed off to waiters</span>
		<span class="hljs-comment">// so we won't be able to acquire the mutex anyway.</span>
		<span class="hljs-keyword">if</span> old&amp;(mutexLocked|mutexStarving) == mutexLocked &amp;&amp; runtime_canSpin(iter) &#123;
			<span class="hljs-comment">// Active spinning makes sense.</span>
			<span class="hljs-comment">// Try to set mutexWoken flag to inform Unlock</span>
			<span class="hljs-comment">// to not wake other blocked goroutines.</span>
			<span class="hljs-keyword">if</span> !awoke &amp;&amp; old&amp;mutexWoken == <span class="hljs-number">0</span> &amp;&amp; old&gt;&gt;mutexWaiterShift != <span class="hljs-number">0</span> &amp;&amp;
				atomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken) &#123;
				awoke = <span class="hljs-literal">true</span>
			&#125;
			runtime_doSpin()
			iter++
			old = m.state
			<span class="hljs-keyword">continue</span>
		&#125;</code></pre><p>åœ¨ <code>lockSlow</code> æ–¹æ³•ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸€ä¸ªå¤§çš„ for å¾ªç¯ï¼Œä¸æ–­çš„å°è¯•å»è·å–äº’æ–¥é”ï¼Œåœ¨å¾ªç¯çš„å†…éƒ¨ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯åˆ¤æ–­èƒ½å¦è‡ªæ—‹çŠ¶æ€ã€‚<br>è¿›å…¥è‡ªæ—‹çŠ¶æ€çš„åˆ¤æ–­æ¯”è¾ƒè‹›åˆ»ï¼Œå…·ä½“éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶å‘¢ï¼Ÿ <code>runtime_canSpin</code> æºç è§ä¸‹æ–¹</p><ul><li>å½“å‰äº’æ–¥é”çš„çŠ¶æ€æ˜¯éé¥¥é¥¿çŠ¶æ€ï¼Œå¹¶ä¸”å·²ç»è¢«é”å®šäº†</li><li>è‡ªæ—‹æ¬¡æ•°ä¸è¶…è¿‡ 4 æ¬¡</li><li>cpu ä¸ªæ•°å¤§äºä¸€ï¼Œå¿…é¡»è¦æ˜¯å¤šæ ¸ cpu</li><li>å½“å‰æ­£åœ¨æ‰§è¡Œå½“ä¸­ï¼Œå¹¶ä¸”é˜Ÿåˆ—ç©ºé—²çš„ p çš„ä¸ªæ•°å¤§äºç­‰äºä¸€</li></ul><pre><code class="hljs go"><span class="hljs-comment">// Active spinning for sync.Mutex.</span>
<span class="hljs-comment">//go:linkname sync_runtime_canSpin sync.runtime_canSpin</span>
<span class="hljs-comment">//go:nosplit</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sync_runtime_canSpin</span><span class="hljs-params">(i <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span> &#123;
	<span class="hljs-keyword">if</span> i &gt;= active_spin || ncpu &lt;= <span class="hljs-number">1</span> || gomaxprocs &lt;= <span class="hljs-keyword">int32</span>(sched.npidle+sched.nmspinning)+<span class="hljs-number">1</span> &#123;
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
	&#125;
	<span class="hljs-keyword">if</span> p := getg().m.p.ptr(); !runqempty(p) &#123;
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
	&#125;
	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
&#125;</code></pre><p>å¦‚æœå¯ä»¥è¿›å…¥è‡ªæ—‹çŠ¶æ€ä¹‹åå°±ä¼šè°ƒç”¨ <code>runtime_doSpin</code> æ–¹æ³•è¿›å…¥è‡ªæ—‹ï¼Œ <code>doSpin</code> æ–¹æ³•ä¼šè°ƒç”¨ <code>procyield(30)</code> æ‰§è¡Œä¸‰åæ¬¡ <code>PAUSE</code> æŒ‡ä»¤</p><pre><code class="hljs go">TEXT runtimeÂ·procyield(SB),NOSPLIT,$<span class="hljs-number">0</span><span class="hljs-number">-0</span>
	MOVL	cycles+<span class="hljs-number">0</span>(FP), AX
again:
	PAUSE
	SUBL	$<span class="hljs-number">1</span>, AX
	JNZ	again
	RET</code></pre><p></p><div style="background:#fffbe6;padding:10px;border:1px solid #c3c3c3;border-radius:5px;margin-bottom:5px">ä¸ºä»€ä¹ˆä½¿ç”¨ PAUSE æŒ‡ä»¤å‘¢ï¼Ÿ<br>PAUSE æŒ‡ä»¤ä¼šå‘Šè¯‰ CPU æˆ‘å½“å‰å¤„äºå¤„äºè‡ªæ—‹çŠ¶æ€ï¼Œè¿™æ—¶å€™ CPU ä¼šé’ˆå¯¹æ€§çš„åšä¸€äº›ä¼˜åŒ–ï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œè¿™ä¸ªæŒ‡ä»¤çš„æ—¶å€™ CPU ä¼šé™ä½è‡ªå·±çš„åŠŸè€—ï¼Œå‡å°‘èƒ½æºæ¶ˆè€—</div><br><pre><code class="hljs go"><span class="hljs-keyword">if</span> !awoke &amp;&amp; old&amp;mutexWoken == <span class="hljs-number">0</span> &amp;&amp; old&gt;&gt;mutexWaiterShift != <span class="hljs-number">0</span> &amp;&amp;
	atomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken) &#123;
	awoke = <span class="hljs-literal">true</span>
&#125;</code></pre><p></p><p>åœ¨è‡ªæ—‹çš„è¿‡ç¨‹ä¸­ä¼šå°è¯•è®¾ç½® <code>mutexWoken</code> æ¥é€šçŸ¥è§£é”ï¼Œä»è€Œé¿å…å”¤é†’å…¶ä»–å·²ç»ä¼‘çœ çš„ <code>goroutine</code> åœ¨è‡ªæ—‹æ¨¡å¼ä¸‹ï¼Œå½“å‰çš„ <code>goroutine</code> å°±èƒ½æ›´å¿«çš„è·å–åˆ°é”<br><pre><code class="hljs go"><span class="hljs-built_in">new</span> := old
<span class="hljs-comment">// Don't try to acquire starving mutex, new arriving goroutines must queue.</span>
<span class="hljs-keyword">if</span> old&amp;mutexStarving == <span class="hljs-number">0</span> &#123;
	<span class="hljs-built_in">new</span> |= mutexLocked
&#125;
<span class="hljs-keyword">if</span> old&amp;(mutexLocked|mutexStarving) != <span class="hljs-number">0</span> &#123;
	<span class="hljs-built_in">new</span> += <span class="hljs-number">1</span> &lt;&lt; mutexWaiterShift
&#125;
<span class="hljs-comment">// The current goroutine switches mutex to starvation mode.</span>
<span class="hljs-comment">// But if the mutex is currently unlocked, don't do the switch.</span>
<span class="hljs-comment">// Unlock expects that starving mutex has waiters, which will not</span>
<span class="hljs-comment">// be true in this case.</span>
<span class="hljs-keyword">if</span> starving &amp;&amp; old&amp;mutexLocked != <span class="hljs-number">0</span> &#123;
	<span class="hljs-built_in">new</span> |= mutexStarving
&#125;
<span class="hljs-keyword">if</span> awoke &#123;
	<span class="hljs-comment">// The goroutine has been woken from sleep,</span>
	<span class="hljs-comment">// so we need to reset the flag in either case.</span>
	<span class="hljs-keyword">if</span> <span class="hljs-built_in">new</span>&amp;mutexWoken == <span class="hljs-number">0</span> &#123;
		throw(<span class="hljs-string">"sync: inconsistent mutex state"</span>)
	&#125;
	<span class="hljs-built_in">new</span> &amp;^= mutexWoken
&#125;</code></pre></p><p>è‡ªæ—‹ç»“æŸä¹‹åå°±ä¼šå»è®¡ç®—å½“å‰äº’æ–¥é”çš„çŠ¶æ€ï¼Œå¦‚æœå½“å‰å¤„åœ¨é¥¥é¥¿æ¨¡å¼ä¸‹åˆ™ä¸ä¼šå»è¯·æ±‚é”ï¼Œè€Œæ˜¯ä¼šå°†å½“å‰ goroutine æ”¾åˆ°é˜Ÿåˆ—çš„æœ«ç«¯<br><pre><code class="hljs go"><span class="hljs-keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="hljs-built_in">new</span>) &#123;
    <span class="hljs-keyword">if</span> old&amp;(mutexLocked|mutexStarving) == <span class="hljs-number">0</span> &#123;
        <span class="hljs-keyword">break</span> <span class="hljs-comment">// locked the mutex with CAS</span>
    &#125;
    <span class="hljs-comment">// If we were already waiting before, queue at the front of the queue.</span>
    queueLifo := waitStartTime != <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> waitStartTime == <span class="hljs-number">0</span> &#123;
        waitStartTime = runtime_nanotime()
    &#125;
    runtime_SemacquireMutex(&amp;m.sema, queueLifo, <span class="hljs-number">1</span>)
    starving = starving || runtime_nanotime()-waitStartTime &gt; starvationThresholdNs
    old = m.state
    <span class="hljs-keyword">if</span> old&amp;mutexStarving != <span class="hljs-number">0</span> &#123;
        <span class="hljs-comment">// If this goroutine was woken and mutex is in starvation mode,</span>
        <span class="hljs-comment">// ownership was handed off to us but mutex is in somewhat</span>
        <span class="hljs-comment">// inconsistent state: mutexLocked is not set and we are still</span>
        <span class="hljs-comment">// accounted as waiter. Fix that.</span>
        <span class="hljs-keyword">if</span> old&amp;(mutexLocked|mutexWoken) != <span class="hljs-number">0</span> || old&gt;&gt;mutexWaiterShift == <span class="hljs-number">0</span> &#123;
            throw(<span class="hljs-string">"sync: inconsistent mutex state"</span>)
        &#125;
        delta := <span class="hljs-keyword">int32</span>(mutexLocked - <span class="hljs-number">1</span>&lt;&lt;mutexWaiterShift)
        <span class="hljs-keyword">if</span> !starving || old&gt;&gt;mutexWaiterShift == <span class="hljs-number">1</span> &#123;
            <span class="hljs-comment">// Exit starvation mode.</span>
            <span class="hljs-comment">// Critical to do it here and consider wait time.</span>
            <span class="hljs-comment">// Starvation mode is so inefficient, that two goroutines</span>
            <span class="hljs-comment">// can go lock-step infinitely once they switch mutex</span>
            <span class="hljs-comment">// to starvation mode.</span>
            delta -= mutexStarving
        &#125;
        atomic.AddInt32(&amp;m.state, delta)
        <span class="hljs-keyword">break</span>
    &#125;
    awoke = <span class="hljs-literal">true</span>
    iter = <span class="hljs-number">0</span>
&#125;</code></pre></p><p>çŠ¶æ€è®¡ç®—å®Œæˆä¹‹åå°±ä¼šå°è¯•ä½¿ç”¨ CAS æ“ä½œè·å–é”ï¼Œå¦‚æœè·å–æˆåŠŸå°±ä¼šç›´æ¥é€€å‡ºå¾ªç¯<br>å¦‚æœè·å–å¤±è´¥ï¼Œåˆ™ä¼šè°ƒç”¨ <code>runtime_SemacquireMutex(&amp;m.sema, queueLifo, 1)</code> æ–¹æ³•ä¿è¯é”ä¸ä¼šåŒæ—¶è¢«ä¸¤ä¸ª goroutine è·å–ã€‚<code>runtime_SemacquireMutex</code> æ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯:</p><ul><li>ä¸æ–­è°ƒç”¨å°è¯•è·å–é”</li><li>ä¼‘çœ å½“å‰ goroutine</li><li>ç­‰å¾…ä¿¡å·é‡ï¼Œå”¤é†’ goroutine</li></ul><p>goroutine è¢«å”¤é†’ä¹‹åå°±ä¼šå»åˆ¤æ–­å½“å‰æ˜¯å¦å¤„äºé¥¥é¥¿æ¨¡å¼ï¼Œå¦‚æœå½“å‰ç­‰å¾…è¶…è¿‡ <code>1ms</code> å°±ä¼šè¿›å…¥é¥¥é¥¿æ¨¡å¼</p><ul><li>é¥¥é¥¿æ¨¡å¼ä¸‹ï¼šä¼šè·å¾—äº’æ–¥é”ï¼Œå¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸­åªå­˜åœ¨å½“å‰ Goroutineï¼Œäº’æ–¥é”è¿˜ä¼šä»é¥¥é¥¿æ¨¡å¼ä¸­é€€å‡º</li><li>æ­£å¸¸æ¨¡å¼ä¸‹ï¼šä¼šè®¾ç½®å”¤é†’å’Œé¥¥é¥¿æ ‡è®°ã€é‡ç½®è¿­ä»£æ¬¡æ•°å¹¶é‡æ–°æ‰§è¡Œè·å–é”çš„å¾ªç¯</li></ul><h3 id="è§£é”-1"><a href="#è§£é”-1" class="headerlink" title="è§£é”"></a>è§£é”</h3><p>å’ŒåŠ é”æ¯”è§£é”å°±å¾ˆç®€å•äº†ï¼Œç›´æ¥çœ‹æ³¨é‡Šå°±å¥½</p><pre><code class="hljs go"><span class="hljs-comment">// è§£é”ä¸€ä¸ªæ²¡æœ‰é”å®šçš„äº’æ–¥é‡ä¼šæŠ¥è¿è¡Œæ—¶é”™è¯¯</span>
<span class="hljs-comment">// è§£é”æ²¡æœ‰ç»‘å®šå…³ç³»ï¼Œå¯ä»¥ä¸€ä¸ª goroutine é”å®šï¼Œå¦å¤–ä¸€ä¸ª goroutine è§£é”</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mutex)</span> <span class="hljs-title">Unlock</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-comment">// Fast path: ç›´æ¥å°è¯•è®¾ç½® state çš„å€¼ï¼Œè¿›è¡Œè§£é”</span>
	<span class="hljs-built_in">new</span> := atomic.AddInt32(&amp;m.state, -mutexLocked)
    <span class="hljs-comment">// å¦‚æœå‡å»äº† mutexLocked çš„å€¼ä¹‹åä¸ä¸ºé›¶å°±ä¼šè¿›å…¥æ…¢é€Ÿé€šé“ï¼Œè¿™è¯´æ˜æœ‰å¯èƒ½å¤±è´¥äº†ï¼Œæˆ–è€…æ˜¯è¿˜æœ‰å…¶ä»–çš„ goroutine ç­‰ç€</span>
	<span class="hljs-keyword">if</span> <span class="hljs-built_in">new</span> != <span class="hljs-number">0</span> &#123;
		<span class="hljs-comment">// Outlined slow path to allow inlining the fast path.</span>
		<span class="hljs-comment">// To hide unlockSlow during tracing we skip one extra frame when tracing GoUnblock.</span>
		m.unlockSlow(<span class="hljs-built_in">new</span>)
	&#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mutex)</span> <span class="hljs-title">unlockSlow</span><span class="hljs-params">(<span class="hljs-built_in">new</span> <span class="hljs-keyword">int32</span>)</span></span> &#123;
    <span class="hljs-comment">// è§£é”ä¸€ä¸ªæ²¡æœ‰é”å®šçš„äº’æ–¥é‡ä¼šæŠ¥è¿è¡Œæ—¶é”™è¯¯</span>
	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">new</span>+mutexLocked)&amp;mutexLocked == <span class="hljs-number">0</span> &#123;
		throw(<span class="hljs-string">"sync: unlock of unlocked mutex"</span>)
	&#125;
    <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦å¤„äºé¥¥é¥¿æ¨¡å¼</span>
	<span class="hljs-keyword">if</span> <span class="hljs-built_in">new</span>&amp;mutexStarving == <span class="hljs-number">0</span> &#123;
        <span class="hljs-comment">// æ­£å¸¸æ¨¡å¼</span>
		old := <span class="hljs-built_in">new</span>
		<span class="hljs-keyword">for</span> &#123;
			<span class="hljs-comment">// å¦‚æœå½“å‰æ²¡æœ‰ç­‰å¾…è€….æˆ–è€… goroutine å·²ç»è¢«å”¤é†’æˆ–è€…æ˜¯å¤„äºé”å®šçŠ¶æ€äº†ï¼Œå°±ç›´æ¥è¿”å›</span>
			<span class="hljs-keyword">if</span> old&gt;&gt;mutexWaiterShift == <span class="hljs-number">0</span> || old&amp;(mutexLocked|mutexWoken|mutexStarving) != <span class="hljs-number">0</span> &#123;
				<span class="hljs-keyword">return</span>
			&#125;
			<span class="hljs-comment">// å”¤é†’ç­‰å¾…è€…å¹¶ä¸”ç§»äº¤é”çš„æ§åˆ¶æƒ</span>
			<span class="hljs-built_in">new</span> = (old - <span class="hljs-number">1</span>&lt;&lt;mutexWaiterShift) | mutexWoken
			<span class="hljs-keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="hljs-built_in">new</span>) &#123;
				runtime_Semrelease(&amp;m.sema, <span class="hljs-literal">false</span>, <span class="hljs-number">1</span>)
				<span class="hljs-keyword">return</span>
			&#125;
			old = m.state
		&#125;
	&#125; <span class="hljs-keyword">else</span> &#123;
		<span class="hljs-comment">// é¥¥é¥¿æ¨¡å¼ï¼Œèµ° handoff æµç¨‹ï¼Œç›´æ¥å°†é”äº¤ç»™ä¸‹ä¸€ä¸ªç­‰å¾…çš„ goroutineï¼Œæ³¨æ„è¿™ä¸ªæ—¶å€™ä¸ä¼šä»é¥¥é¥¿æ¨¡å¼ä¸­é€€å‡º</span>
		runtime_Semrelease(&amp;m.sema, <span class="hljs-literal">true</span>, <span class="hljs-number">1</span>)
	&#125;
&#125;</code></pre><h1 id="RWMutex"><a href="#RWMutex" class="headerlink" title="RWMutex"></a>RWMutex</h1><p>è¯»å†™é”ç›¸å¯¹äºäº’æ–¥é”æ¥è¯´ç²’åº¦æ›´ç»†ï¼Œä½¿ç”¨è¯»å†™é”å¯ä»¥å¹¶å‘è¯»ï¼Œä½†æ˜¯ä¸èƒ½å¹¶å‘è¯»å†™ï¼Œæˆ–è€…å¹¶å‘å†™å†™</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center"><strong>è¯»</strong></th><th style="text-align:center"><strong>å†™</strong></th></tr></thead><tbody><tr><td style="text-align:center">è¯»</td><td style="text-align:center">Y</td><td style="text-align:center">N</td></tr><tr><td style="text-align:center">å†™</td><td style="text-align:center">N</td><td style="text-align:center">N</td></tr></tbody></table><h2 id="æ¡ˆä¾‹-1"><a href="#æ¡ˆä¾‹-1" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h2><p>å…¶å®å¤§éƒ¨åˆ†çš„ä¸šåŠ¡åº”ç”¨éƒ½æ˜¯è¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œè¿™ä¸ªæ—¶å€™ä½¿ç”¨è¯»å†™é”çš„æ€§èƒ½å°±ä¼šæ¯”äº’æ–¥é”è¦å¥½ä¸€äº›ï¼Œä¾‹å¦‚ä¸‹é¢çš„è¿™ä¸ªä¾‹å­ï¼Œæ˜¯ä¸€ä¸ªé…ç½®è¯»å†™çš„ä¾‹å­ï¼Œæˆ‘ä»¬åˆ†åˆ«ä½¿ç”¨è¯»å†™é”å’Œäº’æ–¥é”å®ç°</p><pre><code class="hljs go"><span class="hljs-comment">// RWMutexConfig è¯»å†™é”å®ç°</span>
<span class="hljs-keyword">type</span> RWMutexConfig <span class="hljs-keyword">struct</span> &#123;
	rw   sync.RWMutex
	data []<span class="hljs-keyword">int</span>
&#125;

<span class="hljs-comment">// Get get config data</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *RWMutexConfig)</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> []<span class="hljs-title">int</span></span> &#123;
	c.rw.RLock()
	<span class="hljs-keyword">defer</span> c.rw.RUnlock()
	<span class="hljs-keyword">return</span> c.data
&#125;

<span class="hljs-comment">// Set set config data</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *RWMutexConfig)</span> <span class="hljs-title">Set</span><span class="hljs-params">(n []<span class="hljs-keyword">int</span>)</span></span> &#123;
	c.rw.Lock()
	<span class="hljs-keyword">defer</span> c.rw.Unlock()
	c.data = n
&#125;</code></pre><p>äº’æ–¥é”å®ç°</p><pre><code class="hljs go">
<span class="hljs-comment">// MutexConfig äº’æ–¥é”å®ç°</span>
<span class="hljs-keyword">type</span> MutexConfig <span class="hljs-keyword">struct</span> &#123;
	data []<span class="hljs-keyword">int</span>
	mu   sync.Mutex
&#125;

<span class="hljs-comment">// Get get config data</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *MutexConfig)</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> []<span class="hljs-title">int</span></span> &#123;
	c.mu.Lock()
	<span class="hljs-keyword">defer</span> c.mu.Unlock()
	<span class="hljs-keyword">return</span> c.data
&#125;

<span class="hljs-comment">// Set set config data</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *MutexConfig)</span> <span class="hljs-title">Set</span><span class="hljs-params">(n []<span class="hljs-keyword">int</span>)</span></span> &#123;
	c.mu.Lock()
	<span class="hljs-keyword">defer</span> c.mu.Unlock()
	c.data = n
&#125;</code></pre><p>å¹¶å‘åŸºå‡†æµ‹è¯•</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> iConfig <span class="hljs-keyword">interface</span> &#123;
	Get() []<span class="hljs-keyword">int</span>
	Set([]<span class="hljs-keyword">int</span>)
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">bench</span><span class="hljs-params">(b *testing.B, c iConfig)</span></span> &#123;
	b.RunParallel(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p *testing.PB)</span></span> &#123;
		<span class="hljs-keyword">for</span> p.Next() &#123;
			c.Set([]<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">100</span>&#125;)
			c.Get()
			c.Get()
			c.Get()
			c.Set([]<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">100</span>&#125;)
			c.Get()
			c.Get()
		&#125;
	&#125;)
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkMutexConfig</span><span class="hljs-params">(b *testing.B)</span></span> &#123;
	conf := &amp;MutexConfig&#123;data: []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;&#125;
	bench(b, conf)
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkRWMutexConfig</span><span class="hljs-params">(b *testing.B)</span></span> &#123;
	conf := &amp;RWMutexConfig&#123;data: []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;&#125;
	bench(b, conf)
&#125;</code></pre><p>æ‰§è¡Œç»“æœ</p><pre><code class="hljs go">â¯ <span class="hljs-keyword">go</span> test -race -bench=.
goos: linux
goarch: amd64
pkg: github.com/mohuishou/<span class="hljs-keyword">go</span>-training/Week03/blog/<span class="hljs-number">04</span>_sync/<span class="hljs-number">02</span>_rwmutex
BenchmarkMutexConfig<span class="hljs-number">-4</span>            <span class="hljs-number">179577</span>              <span class="hljs-number">6912</span> ns/op
BenchmarkRWMutexConfig<span class="hljs-number">-4</span>          <span class="hljs-number">341620</span>              <span class="hljs-number">3425</span> ns/op
PASS
ok      github.com/mohuishou/<span class="hljs-keyword">go</span>-training/Week03/blog/<span class="hljs-number">04</span>_sync/<span class="hljs-number">02</span>_rwmutex <span class="hljs-number">3.565</span>s</code></pre><p>å¯ä»¥çœ‹åˆ°é¦–å…ˆæ˜¯æ²¡æœ‰ data race é—®é¢˜ï¼Œå…¶æ¬¡è¯»å†™é”çš„æ€§èƒ½å‡ ä¹æ˜¯äº’æ–¥é”çš„ä¸€å€</p><h2 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h2><h3 id="åŸºæœ¬ç»“æ„"><a href="#åŸºæœ¬ç»“æ„" class="headerlink" title="åŸºæœ¬ç»“æ„"></a>åŸºæœ¬ç»“æ„</h3><pre><code class="hljs go"><span class="hljs-keyword">type</span> RWMutex <span class="hljs-keyword">struct</span> &#123;
	w           Mutex  <span class="hljs-comment">// å¤ç”¨äº’æ–¥é”</span>
	writerSem   <span class="hljs-keyword">uint32</span> <span class="hljs-comment">// ä¿¡å·é‡ï¼Œç”¨äºå†™ç­‰å¾…è¯»</span>
	readerSem   <span class="hljs-keyword">uint32</span> <span class="hljs-comment">// ä¿¡å·é‡ï¼Œç”¨äºè¯»ç­‰å¾…å†™</span>
	readerCount <span class="hljs-keyword">int32</span>  <span class="hljs-comment">// å½“å‰æ‰§è¡Œè¯»çš„ goroutine æ•°é‡</span>
	readerWait  <span class="hljs-keyword">int32</span>  <span class="hljs-comment">// å†™æ“ä½œè¢«é˜»å¡çš„å‡†å¤‡è¯»çš„ goroutine çš„æ•°é‡</span>
&#125;</code></pre><p>ç”±äºå¤ç”¨äº†äº’æ–¥é”çš„ä»£ç ï¼Œè¯»å†™é”çš„æºç å¾ˆç®€å•ï¼Œè¿™é‡Œæˆ‘å°±ä¸å•ç‹¬ç”»å›¾äº†</p><h3 id="è¯»é”"><a href="#è¯»é”" class="headerlink" title="è¯»é”"></a>è¯»é”</h3><h4 id="åŠ é”-2"><a href="#åŠ é”-2" class="headerlink" title="åŠ é”"></a>åŠ é”</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rw *RWMutex)</span> <span class="hljs-title">RLock</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-keyword">if</span> atomic.AddInt32(&amp;rw.readerCount, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span> &#123;
		<span class="hljs-comment">// A writer is pending, wait for it.</span>
		runtime_SemacquireMutex(&amp;rw.readerSem, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>)
	&#125;
&#125;</code></pre><p>é¦–å…ˆæ˜¯è¯»é”ï¼Œ <code>atomic.AddInt32(&amp;rw.readerCount, 1)</code> è°ƒç”¨è¿™ä¸ªåŸå­æ–¹æ³•ï¼Œå¯¹å½“å‰åœ¨è¯»çš„æ•°é‡åŠ ä¸€ï¼Œå¦‚æœè¿”å›è´Ÿæ•°ï¼Œé‚£ä¹ˆè¯´æ˜å½“å‰æœ‰å…¶ä»–å†™é”ï¼Œè¿™æ—¶å€™å°±è°ƒç”¨ <code>runtime_SemacquireMutex</code> ä¼‘çœ  goroutine ç­‰å¾…è¢«å”¤é†’</p><h4 id="è§£é”-2"><a href="#è§£é”-2" class="headerlink" title="è§£é”"></a>è§£é”</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rw *RWMutex)</span> <span class="hljs-title">RUnlock</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-keyword">if</span> r := atomic.AddInt32(&amp;rw.readerCount, <span class="hljs-number">-1</span>); r &lt; <span class="hljs-number">0</span> &#123;
		<span class="hljs-comment">// Outlined slow-path to allow the fast-path to be inlined</span>
		rw.rUnlockSlow(r)
	&#125;
&#125;</code></pre><p>è§£é”çš„æ—¶å€™å¯¹æ­£åœ¨è¯»çš„æ“ä½œå‡ä¸€ï¼Œå¦‚æœè¿”å›å€¼å°äº 0 é‚£ä¹ˆè¯´æ˜å½“å‰æœ‰åœ¨å†™çš„æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™è°ƒç”¨ <code>rUnlockSlow</code> è¿›å…¥æ…¢é€Ÿé€šé“</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rw *RWMutex)</span> <span class="hljs-title">rUnlockSlow</span><span class="hljs-params">(r <span class="hljs-keyword">int32</span>)</span></span> &#123;
	<span class="hljs-keyword">if</span> r+<span class="hljs-number">1</span> == <span class="hljs-number">0</span> || r+<span class="hljs-number">1</span> == -rwmutexMaxReaders &#123;
		race.Enable()
		throw(<span class="hljs-string">"sync: RUnlock of unlocked RWMutex"</span>)
	&#125;
	<span class="hljs-comment">// A writer is pending.</span>
	<span class="hljs-keyword">if</span> atomic.AddInt32(&amp;rw.readerWait, <span class="hljs-number">-1</span>) == <span class="hljs-number">0</span> &#123;
		<span class="hljs-comment">// The last reader unblocks the writer.</span>
		runtime_Semrelease(&amp;rw.writerSem, <span class="hljs-literal">false</span>, <span class="hljs-number">1</span>)
	&#125;
&#125;</code></pre><p>è¢«é˜»å¡çš„å‡†å¤‡è¯»çš„ goroutine çš„æ•°é‡å‡ä¸€ï¼ŒreaderWait ä¸º 0ï¼Œå°±è¡¨ç¤ºå½“å‰æ²¡æœ‰æ­£åœ¨å‡†å¤‡è¯»çš„ goroutine è¿™æ—¶å€™è°ƒç”¨ <code>runtime_Semrelease</code> å”¤é†’å†™æ“ä½œ</p><h3 id="å†™é”"><a href="#å†™é”" class="headerlink" title="å†™é”"></a>å†™é”</h3><h4 id="åŠ é”-3"><a href="#åŠ é”-3" class="headerlink" title="åŠ é”"></a>åŠ é”</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rw *RWMutex)</span> <span class="hljs-title">Lock</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-comment">// First, resolve competition with other writers.</span>
	rw.w.Lock()
	<span class="hljs-comment">// Announce to readers there is a pending writer.</span>
	r := atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders
	<span class="hljs-comment">// Wait for active readers.</span>
	<span class="hljs-keyword">if</span> r != <span class="hljs-number">0</span> &amp;&amp; atomic.AddInt32(&amp;rw.readerWait, r) != <span class="hljs-number">0</span> &#123;
		runtime_SemacquireMutex(&amp;rw.writerSem, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>)
	&#125;
&#125;</code></pre><p>é¦–å…ˆè°ƒç”¨äº’æ–¥é”çš„ lockï¼Œè·å–åˆ°äº’æ–¥é”ä¹‹åï¼Œ</p><ul><li><code>atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders)</code> è°ƒç”¨è¿™ä¸ªå‡½æ•°é˜»å¡åç»­çš„è¯»æ“ä½œ</li><li>å¦‚æœè®¡ç®—ä¹‹åå½“å‰ä»ç„¶æœ‰å…¶ä»– goroutine æŒæœ‰è¯»é”ï¼Œé‚£ä¹ˆå°±è°ƒç”¨ <code>runtime_SemacquireMutex</code> ä¼‘çœ å½“å‰çš„ goroutine ç­‰å¾…æ‰€æœ‰çš„è¯»æ“ä½œå®Œæˆ</li></ul><h4 id="è§£é”-3"><a href="#è§£é”-3" class="headerlink" title="è§£é”"></a>è§£é”</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rw *RWMutex)</span> <span class="hljs-title">Unlock</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-comment">// Announce to readers there is no active writer.</span>
	r := atomic.AddInt32(&amp;rw.readerCount, rwmutexMaxReaders)
	<span class="hljs-keyword">if</span> r &gt;= rwmutexMaxReaders &#123;
		race.Enable()
		throw(<span class="hljs-string">"sync: Unlock of unlocked RWMutex"</span>)
	&#125;
	<span class="hljs-comment">// Unblock blocked readers, if any.</span>
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">int</span>(r); i++ &#123;
		runtime_Semrelease(&amp;rw.readerSem, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>)
	&#125;
&#125;</code></pre><p>è§£é”çš„æ“ä½œï¼Œä¼šå…ˆè°ƒç”¨ <code>atomic.AddInt32(&amp;rw.readerCount, rwmutexMaxReaders)</code> å°†æ¢å¤ä¹‹å‰å†™å…¥çš„è´Ÿæ•°ï¼Œç„¶åæ ¹æ®å½“å‰æœ‰å¤šå°‘ä¸ªè¯»æ“ä½œåœ¨ç­‰å¾…ï¼Œå¾ªç¯å”¤é†’</p><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><ol><li><a href="https://pkg.go.dev/sync" target="_blank" rel="noopener">https://pkg.go.dev/sync</a> å®˜ç½‘æ–‡æ¡£ï¼Œå¿…è¯»</li><li><a href="https://pkg.go.dev/golang.org/x/sync@v0.0.0-20201207232520-09787c993a3a/errgroup" target="_blank" rel="noopener">https://pkg.go.dev/golang.org/x/sync@v0.0.0-20201207232520-09787c993a3a/errgroup</a> å®˜ç½‘æ–‡æ¡£ï¼Œå¿…è¯»</li><li><a href="https://pkg.go.dev/sync/atomic" target="_blank" rel="noopener">https://pkg.go.dev/sync/atomic</a> å®˜ç½‘æ–‡æ¡£ï¼Œå¿…è¯»</li><li><a href="https://medium.com/a-journey-with-go/go-how-to-reduce-lock-contention-with-the-atomic-package-ba3b2664b549" target="_blank" rel="noopener">Go: How to Reduce Lock Contention with the Atomic Package</a></li><li><a href="https://medium.com/a-journey-with-go/go-mutex-and-starvation-3f4f4e75ad50" target="_blank" rel="noopener">Go: Mutex and Starvation</a></li><li><a href="https://mojotv.cn/go/golang-muteex-starvation" target="_blank" rel="noopener">Go è¿›é˜¶ 27:Go è¯­è¨€ Mutex Starvation(è¯‘)</a></li><li><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-sync-primitives/" target="_blank" rel="noopener">Go è¯­è¨€è®¾è®¡ä¸å®ç°-6.2 åŒæ­¥åŸè¯­ä¸é”</a> è¿™æœ¬ä¹¦å€¼å¾—ä¸€çœ‹</li><li><a href="https://www.felixcloutier.com/x86/pause" target="_blank" rel="noopener">PAUSE â€” Spin Loop Hint</a></li><li><a href="https://github.com/freelancer-leon/notes/blob/master/kernel/lock/Lock-2-Linux_x86_Spin_Lock.md#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E6%98%AF-pause-%E6%8C%87%E4%BB%A4" target="_blank" rel="noopener">Linux x86 è‡ªæ—‹é”çš„å®ç°</a></li><li><a href="https://github.com/golang/go/commit/0556e26273f704db73df9e7c4c3d2e8434dec7be" target="_blank" rel="noopener">https://github.com/golang/go/commit/0556e26273f704db73df9e7c4c3d2e8434dec7be</a></li></ol><h1 id="å…³æ³¨æˆ‘è·å–æ›´æ–°"><a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°</h1><p>çœ‹åˆ°è¿™é‡Œäº†è¿˜ä¸å…³æ³¨ç‚¹èµèµ°ä¸€æ³¢</p><ul><li><a href="https://lailin.xyz">åšå®¢</a> å¯ä»¥è®¢é˜… RSS</li><li><a href="https://github.com/mohuishou" target="_blank" rel="noopener">Github</a> Follow me</li><li><a href="https://www.zhihu.com/people/mo-hui-shou-76" target="_blank" rel="noopener">çŸ¥ä¹</a> å…³æ³¨è´¦å·ï¼Œé¡ºä¾¿ç‚¹ä¸ª ğŸ‘</li><li><a href="https://toutiao.io/subjects/387401?f=new" target="_blank" rel="noopener">å¼€å‘è€…å¤´æ¡</a> è®¢é˜…è®¢é˜…å·ï¼Œé¡ºä¾¿ç‚¹ä¸ª ğŸ‘</li></ul><div><h2 id="ç›¸å…³æ¨è">ç›¸å…³æ¨è</h2><ul><li><a href="https://lailin.xyz/post/go-training-week3-waitgroup.html">Week03: Goå¹¶å‘ç¼–ç¨‹(å…­) æ·±å…¥ç†è§£ WaitGroup</a></li><li><a href="https://lailin.xyz/post/go-training-week3-atomic.html">Week03: Goå¹¶å‘ç¼–ç¨‹(äº”) æ·±å…¥ç†è§£ sync/atomic</a></li><li><a href="https://lailin.xyz/post/go-training-week3-data-race.html">Week03: Goå¹¶å‘ç¼–ç¨‹(ä¸‰) data race</a></li></ul></div></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/Goè¿›é˜¶è®­ç»ƒè¥/">Goè¿›é˜¶è®­ç»ƒè¥</a> <a class="hover-with-bg" href="/categories/Goè¿›é˜¶è®­ç»ƒè¥/Goå¹¶å‘ç¼–ç¨‹/">Goå¹¶å‘ç¼–ç¨‹</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/å­¦ä¹ ç¬”è®°/">å­¦ä¹ ç¬”è®°</a> <a class="hover-with-bg" href="/tags/Go/">Go</a> <a class="hover-with-bg" href="/tags/Goè¿›é˜¶è®­ç»ƒè¥/">Goè¿›é˜¶è®­ç»ƒè¥</a> <a class="hover-with-bg" href="/tags/å¹¶å‘/">å¹¶å‘</a></div></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext row"><article class="post-prev col-6"><a href="/post/go-training-week3-atomic.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Week03: Goå¹¶å‘ç¼–ç¨‹(äº”) æ·±å…¥ç†è§£ sync/atomic</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></article><article class="post-next col-6"><a href="/post/go-training-week3-data-race.html"><span class="hidden-mobile">Week03: Goå¹¶å‘ç¼–ç¨‹(ä¸‰) data race</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><script type="text/javascript">function loadUtterances(){var t="github-light",e="github-dark",s=document.documentElement.getAttribute("data-user-color-scheme");s="dark"===s?e:t,window.UtterancesThemeLight=t,window.UtterancesThemeDark=e;var n=document.createElement("script");n.setAttribute("src","https://utteranc.es/client.js"),n.setAttribute("repo","scuplus/blogComment"),n.setAttribute("issue-term","pathname"),n.setAttribute("label","utterances"),n.setAttribute("theme",s),n.setAttribute("crossorigin","anonymous"),document.getElementById("comments").appendChild(n)}waitElementVisible("comments",loadUtterances)</script></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div id="tocbot"></div></div></div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready(function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:"#post-body",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:0,scrollSmooth:!0,headingsOffset:-t}),0<$(".toc-list-item").length&&$("#toc").css("visibility","visible")})</script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","Week03: Goå¹¶å‘ç¼–ç¨‹(å››) æ·±å…¥ç†è§£ Mutex&nbsp;"],cursorChar:"_",typeSpeed:70,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})</script><script defer>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-137859264-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script></body></html>