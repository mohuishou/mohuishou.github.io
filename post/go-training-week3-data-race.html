<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/icons/touch-icon-apple.png"><link rel="icon" type="image/png" href="/icons/favicon-32x32.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content><meta name="author" content="Mohuishou"><meta name="keywords" content="Go, Docker, PHP"><title>Week03: Goå¹¶å‘ç¼–ç¨‹(ä¸‰) data race - Mohuishou</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/assets/css/custom.css"><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script></head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>mohuishou</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> å‹é“¾</a></li><li class="nav-item"><a class="nav-link" href="/atom.xml"><i class="iconfont icon-rss"></i> rss</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner intro-2" id="background" parallax="true" style="background:url(/img/bg.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container page-header text-center fade-in-up"><span class="h2" id="subtitle"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2020-12-07 13:38" pubdate>2020å¹´12æœˆ7æ—¥ ä¸‹åˆ</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3.6k å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 47 åˆ†é’Ÿ</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto" id="post"><h1 style="display:none">Week03: Goå¹¶å‘ç¼–ç¨‹(ä¸‰) data race</h1><div class="markdown-body" id="post-body"><blockquote><p>æœ¬ç³»åˆ—ä¸ºæå®¢æ—¶é—´ Go è¿›é˜¶è®­ç»ƒè¥ç¬”è®°ï¼ŒåŒæ­¥ç›´æ’­æ›´æ–°ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 1 ~ 2 ç¯‡æ–‡ç« ï¼Œåˆ° 202103 æœˆæ›´æ–°å®Œæˆ</p></blockquote><h2 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h2><p>åœ¨å‰ä¸¤ç¯‡æ–‡ç« å½“ä¸­æˆ‘ä»¬åå¤æåˆ°äº†è™½ç„¶åœ¨ go ä¸­ï¼Œå¹¶å‘ç¼–ç¨‹ååˆ†ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ <code>go func()</code> å°±èƒ½å¯åŠ¨ä¸€ä¸ª goroutine å»åšä¸€äº›äº‹æƒ…ï¼Œä½†æ˜¯æ­£æ˜¯ç”±äºè¿™ç§ç®€å•æˆ‘ä»¬è¦ååˆ†å½“å¿ƒï¼Œä¸ç„¶å¾ˆå®¹æ˜“å‡ºç°ä¸€äº›è«åå…¶å¦™çš„ bug æˆ–è€…æ˜¯ä½ çš„æœåŠ¡ç”±äºä¸çŸ¥åçš„åŸå› å°±é‡å¯äº†ã€‚</p><h2 id="æ•°æ®ç«äº‰-data-race"><a href="#æ•°æ®ç«äº‰-data-race" class="headerlink" title="æ•°æ®ç«äº‰(data race)"></a>æ•°æ®ç«äº‰(data race)</h2><p>ä¹‹å‰æˆ‘ä»¬æåˆ°äº†å¾ˆå¤šæ¬¡åœ¨å¤šä¸ª goroutine å¯¹åŒä¸€ä¸ªå˜é‡çš„æ•°æ®è¿›è¡Œä¿®æ”¹çš„æ—¶å€™ä¼šå‡ºç°å¾ˆå¤šå¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ï¼Œé‚£æˆ‘ä»¬æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•æ£€æµ‹å®ƒå‘¢ï¼Œé™¤äº†é€šè¿‡æˆ‘ä»¬èªæ˜çš„è„‘è¢‹ï¼Ÿ</p><p>ç­”æ¡ˆå°±æ˜¯ data race tagï¼Œgo å®˜æ–¹æ—©åœ¨ 1.1 ç‰ˆæœ¬å°±å¼•å…¥äº†æ•°æ®ç«äº‰çš„æ£€æµ‹å·¥å…·ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æ‰§è¡Œæµ‹è¯•æˆ–è€…æ˜¯ç¼–è¯‘çš„æ—¶å€™åŠ ä¸Š <code>-race</code> çš„ flag å°±å¯ä»¥å¼€å¯æ•°æ®ç«äº‰çš„æ£€æµ‹</p><pre><code class="hljs go"><span class="hljs-keyword">go</span> test -race ./...
<span class="hljs-keyword">go</span> build -race</code></pre><div style="background:#fffbe6;padding:10px;border:1px solid #c3c3c3;border-radius:5px;margin-bottom:5px">ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒ build çš„æ—¶å€™å¼€å¯æ•°æ®ç«äº‰æ£€æµ‹ï¼Œå› ä¸ºè¿™ä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½æŸå¤±(ä¸€èˆ¬å†…å­˜5-10å€ï¼Œæ‰§è¡Œæ—¶é—´2-20å€)ï¼Œå½“ç„¶ å¿…é¡»è¦ debug çš„æ—¶å€™é™¤å¤–ã€‚<br>å»ºè®®åœ¨æ‰§è¡Œå•å…ƒæµ‹è¯•æ—¶å§‹ç»ˆå¼€å¯æ•°æ®ç«äº‰çš„æ£€æµ‹ã€‚</div><h3 id="æ¡ˆä¾‹ä¸€"><a href="#æ¡ˆä¾‹ä¸€" class="headerlink" title="æ¡ˆä¾‹ä¸€"></a>æ¡ˆä¾‹ä¸€</h3><p>æˆ‘ä»¬æ¥ç›´æ¥çœ‹ä¸€ä¸‹ä¸‹é¢çš„è¿™ä¸ªä¾‹å­ï¼Œè¿™æ˜¯æ¥è‡ªè¯¾ä¸Šçš„ä¸€ä¸ªä¾‹å­ï¼Œä½†æ˜¯æˆ‘ç¨ç¨åšäº†ä¸€äº›æ”¹é€ ï¼Œæºä»£ç æ²¡æœ‰è·‘ 10w æ¬¡è¿™ä¸ªæ“ä½œï¼Œä¼šå¯¼è‡´çœ‹èµ·æ¥æ¯æ¬¡è·‘çš„ç»“æœéƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠè¿™ä¸ªæ¬¡æ•°æ”¾å¤§å°±å¯ä»¥å‘ç°æ¯æ¬¡ç»“æœéƒ½ä¼šä¸ä¸€æ ·</p><h4 id="æ­£å¸¸æ‰§è¡Œ"><a href="#æ­£å¸¸æ‰§è¡Œ" class="headerlink" title="æ­£å¸¸æ‰§è¡Œ"></a>æ­£å¸¸æ‰§è¡Œ</h4><pre><code class="hljs go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"sync"</span>
)

<span class="hljs-keyword">var</span> wg sync.WaitGroup
<span class="hljs-keyword">var</span> counter <span class="hljs-keyword">int</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-comment">// å¤šè·‘å‡ æ¬¡æ¥çœ‹ç»“æœ</span>
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; i++ &#123;
		run()
	&#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">2</span>; i++ &#123;
		wg.Add(<span class="hljs-number">1</span>)
		<span class="hljs-keyword">go</span> routine(i)
	&#125;
	wg.Wait()
	fmt.Printf(<span class="hljs-string">"Final Counter: %d\n"</span>, counter)
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">routine</span><span class="hljs-params">(id <span class="hljs-keyword">int</span>)</span></span> &#123;
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++ &#123;
		value := counter
		value++
		counter = value
	&#125;
	wg.Done()
&#125;</code></pre><p>æˆ‘æ‰§è¡Œäº†ä¸‰æ¬¡æ¯æ¬¡çš„ç»“æœéƒ½ä¸ä¸€è‡´ï¼Œåˆ†åˆ«æ˜¯:</p><pre><code class="hljs go">Final Counter: <span class="hljs-number">399996</span>
Final Counter: <span class="hljs-number">399989</span>
Final Counter: <span class="hljs-number">399988</span></code></pre><p>ä¸ºä»€ä¹ˆä¼šå¯¼è‡´è¿™æ ·çš„ç»“æœå‘¢ï¼Œæ˜¯å› ä¸ºæ¯ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½ä½¿ç”¨ <code>go routine(i)</code> å¯åŠ¨äº†ä¸¤ä¸ª goroutineï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰æ§åˆ¶å®ƒçš„æ‰§è¡Œé¡ºåºï¼Œé‚£å°±æœ‰å¥½å‡ ç§å¯èƒ½äº†ï¼Œæˆ‘è¿™é‡Œæè¿°ä¸¤ç§æƒ…å†µ</p><ol><li>æ‰§è¡Œä¸€æ¬¡ <code>run()</code> , <code>counter + 4</code> è¿™ç§æƒ…å†µä¸‹ï¼Œç¬¬äºŒä¸ª goroutine å¼€å§‹æ‰§è¡Œæ—¶ï¼Œæ‹¿åˆ°äº†ç¬¬ä¸€ä¸ª goroutine çš„æ‰§è¡Œç»“æœï¼Œä¹Ÿå°±æ˜¯ <code>value := counter</code> è¿™ä¸€æ­¥æ—¶ï¼Œvalue = 2</li><li>æ‰§è¡Œä¸€æ¬¡ <code>run()</code> , <code>counter + 2</code> è¿™ç§æƒ…å†µä¸‹ï¼Œç¬¬äºŒä¸ª goroutine å¼€å§‹æ‰§è¡Œæ—¶ï¼Œæ²¡æœ‰æ‹¿åˆ°äº†ç¬¬ä¸€ä¸ª goroutine çš„æ‰§è¡Œç»“æœï¼Œä¹Ÿå°±æ˜¯ <code>value := counter</code> è¿™ä¸€æ­¥æ—¶ï¼Œcounter è¿˜æ˜¯é›¶å€¼ï¼Œè¿™æ—¶å€™ value = 0</li></ol><p>å½“ç„¶ç”±äºç§ç§ä¸ç¡®å®šæ€§ï¼Œæ‰€æœ‰è‚¯å®šä¸æ­¢è¿™ä¸¤ç§æƒ…å†µï¼Œä½†æ˜¯è¿™ä¸ªä¸æ˜¯æœ¬æ–‡è®¨è®ºçš„é‡ç‚¹ï¼Œå…·ä½“çš„åŸå› å¯ä»¥ç»“åˆä¸Šä¸€ç¯‡æ–‡ç«  <a href="https://lailin.xyz/post/go-training-week3-go-memory-model.html">Week03: Go å¹¶å‘ç¼–ç¨‹(äºŒ) Go å†…å­˜æ¨¡å‹</a> è¿›è¡Œæ€è€ƒ</p><h4 id="data-race-æ‰§è¡Œ"><a href="#data-race-æ‰§è¡Œ" class="headerlink" title="data race æ‰§è¡Œ"></a>data race æ‰§è¡Œ</h4><p>å¯ä»¥å‘ç°ï¼Œå†™å‡ºè¿™ç§ä»£ç æ—¶ä¸Šçº¿åå¦‚æœå‡ºç° bug ä¼šéå¸¸éš¾å®šä½ï¼Œå› ä¸ºä½ ä¸çŸ¥é“åˆ°åº•æ˜¯å“ªé‡Œå‡ºç°äº†é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±è¦åœ¨æµ‹è¯•é˜¶æ®µå°±ç»“åˆ data race å·¥å…·æå‰å‘ç°é—®é¢˜ã€‚<br>æˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p><pre><code class="hljs go"><span class="hljs-keyword">go</span> run -race ./main.<span class="hljs-keyword">go</span></code></pre><p>ä¼šå‘ç°ç»“æœä¼šæ‰€æœ‰çš„éƒ½è¾“å‡ºï¼Œ <code>data race</code> çš„æŠ¥é”™ä¿¡æ¯ï¼Œæˆ‘ä»¬å·²ç»çœ‹ä¸åˆ°äº†ï¼Œå› ä¸ºç»ˆç«¯çš„æ‰“å°çš„å¤ªé•¿äº†ï¼Œå¯ä»¥å‘ç°çš„æ˜¯ï¼Œæœ€åæ‰“å°å‡ºå‘ç°äº†ä¸€å¤„ data race å¹¶ä¸”æ¨å‡ºç ä¸º <code>66</code></p><pre><code class="hljs go">Final Counter: <span class="hljs-number">399956</span>
Final Counter: <span class="hljs-number">399960</span>
Found <span class="hljs-number">1</span> data race(s)
exit status <span class="hljs-number">66</span></code></pre><h4 id="data-race-é…ç½®"><a href="#data-race-é…ç½®" class="headerlink" title="data race é…ç½®"></a>data race é…ç½®</h4><p>é—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥ç«‹å³çŸ¥é“ data race çš„æŠ¥é”™å‘¢ï¼Ÿ<br>ç­”æ¡ˆå°±åœ¨å®˜æ–¹çš„æ–‡æ¡£å½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½® <code>GORACE</code> ç¯å¢ƒå˜é‡ï¼Œæ¥æ§åˆ¶ data race çš„è¡Œä¸ºï¼Œ æ ¼å¼å¦‚ä¸‹:</p><pre><code class="hljs go">GORACE=<span class="hljs-string">"option1=val1 option2=val2"</span></code></pre><p>å¯é€‰é…ç½®:</p><table><thead><tr><th><strong>é…ç½®</strong></th><th><strong>é»˜è®¤å€¼</strong></th><th><strong>è¯´æ˜</strong></th></tr></thead><tbody><tr><td>log_path</td><td>stderr</td><td>æ—¥å¿—æ–‡ä»¶çš„è·¯å¾„ï¼Œé™¤äº†æ–‡ä»¶è·¯å¾„å¤–æ”¯æŒ stderr, stdout è¿™ä¸¤ä¸ªç‰¹æ®Šå€¼</td></tr><tr><td>exitcode</td><td>66</td><td>é€€å‡ºç </td></tr><tr><td>strip_path_prefix</td><td>â€œâ€</td><td>ä»æ—¥å¿—ä¸­çš„æ–‡ä»¶ä¿¡æ¯é‡Œé¢å»é™¤ç›¸å…³çš„å‰ç¼€ï¼Œå¯ä»¥å»é™¤æœ¬åœ°ä¿¡æ¯ï¼ŒåŒæ—¶ä¼šæ›´å¥½çœ‹</td></tr><tr><td>history_size</td><td>1</td><td>per-goroutine å†…å­˜è®¿é—®å†å²è®°å½•ä¸º 32K * 2 ** history_sizeï¼Œå¢åŠ è¿™ä¸ªå¯ä»¥é¿å…å‡ºç°å †æ ˆè¿˜åŸå¤±è´¥çš„é”™è¯¯ï¼Œä½†æ˜¯å¢åŠ è¿™ä¸ªä¼šå¯¼è‡´ä½¿ç”¨çš„å†…å­˜ä¹Ÿè·Ÿç€å¢åŠ </td></tr><tr><td>halt_on_error</td><td>0</td><td>ç”¨æ¥æ§åˆ¶ç¬¬ä¸€ä¸ªæ•°æ®ç«äº‰é”™è¯¯å‡ºç°åæ˜¯å¦ç«‹å³é€€å‡º</td></tr><tr><td>atexit_sleep_ms</td><td>100</td><td>ç”¨æ¥æ§åˆ¶ main é€€å‡ºä¹‹å‰ sleep çš„æ—¶é—´</td></tr></tbody></table><p>æœ‰äº†è¿™ä¸ªèƒŒæ™¯çŸ¥è¯†åå°±å¾ˆç®€å•äº†ï¼Œåœ¨æˆ‘ä»¬è¿™ä¸ªåœºæ™¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶å‘ç°æ•°æ®ç«äº‰åç›´æ¥é€€å‡º</p><pre><code class="hljs go">GORACE=<span class="hljs-string">"halt_on_error=1 strip_path_prefix=/home/ll/project/Go-000/Week03/blog/03_sync/01_data_race"</span> <span class="hljs-keyword">go</span> run -race ./main.<span class="hljs-keyword">go</span></code></pre><p>é‡æ–°æ‰§è¡Œåæˆ‘ä»¬çš„ç»“æœ</p><pre><code class="hljs go">==================
WARNING: DATA RACE
Read at <span class="hljs-number">0x00000064a9c0</span> by goroutine <span class="hljs-number">7</span>:
  main.routine()
      /main.<span class="hljs-keyword">go</span>:<span class="hljs-number">29</span> +<span class="hljs-number">0x47</span>

Previous write at <span class="hljs-number">0x00000064a9c0</span> by goroutine <span class="hljs-number">8</span>:
  main.routine()
      /main.<span class="hljs-keyword">go</span>:<span class="hljs-number">31</span> +<span class="hljs-number">0x64</span>

Goroutine <span class="hljs-number">7</span> (running) created at:
  main.run()
      /main.<span class="hljs-keyword">go</span>:<span class="hljs-number">21</span> +<span class="hljs-number">0x75</span>
  main.main()
      /main.<span class="hljs-keyword">go</span>:<span class="hljs-number">14</span> +<span class="hljs-number">0x38</span>

Goroutine <span class="hljs-number">8</span> (finished) created at:
  main.run()
      /main.<span class="hljs-keyword">go</span>:<span class="hljs-number">21</span> +<span class="hljs-number">0x75</span>
  main.main()
      /main.<span class="hljs-keyword">go</span>:<span class="hljs-number">14</span> +<span class="hljs-number">0x38</span>
==================
exit status <span class="hljs-number">66</span></code></pre><p>è¿™ä¸ªç»“æœéå¸¸æ¸…æ™°çš„å‘Šè¯‰äº†æˆ‘ä»¬åœ¨ 29 è¡Œè¿™ä¸ªåœ°æ–¹æˆ‘ä»¬æœ‰ä¸€ä¸ª goroutine åœ¨è¯»å–æ•°æ®ï¼Œä½†æ˜¯å‘¢ï¼Œåœ¨ 31 è¡Œè¿™ä¸ªåœ°æ–¹åˆæœ‰ä¸€ä¸ª goroutine åœ¨å†™å…¥ï¼Œæ‰€ä»¥äº§ç”Ÿäº†æ•°æ®ç«äº‰ã€‚<br>ç„¶åä¸‹é¢åˆ†åˆ«è¯´æ˜è¿™ä¸¤ä¸ª goroutine æ˜¯ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„ï¼Œå·²ç»å½“å‰æ˜¯å¦åœ¨è¿è¡Œå½“ä¸­ã€‚</p><h3 id="å…¸å‹æ¡ˆä¾‹"><a href="#å…¸å‹æ¡ˆä¾‹" class="headerlink" title="å…¸å‹æ¡ˆä¾‹"></a>å…¸å‹æ¡ˆä¾‹</h3><p>æ¥æ¥ä¸‹æˆ‘ä»¬å†æ¥çœ‹ä¸€äº›å…¸å‹æ¡ˆä¾‹ï¼Œè¿™äº›æ¡ˆä¾‹éƒ½æ¥è‡ª go å®˜æ–¹çš„æ–‡æ¡£ <a href="https://golang.org/doc/articles/race_detector.html" target="_blank" rel="noopener">Data Race Detector</a>ï¼Œè¿™äº›ä¹Ÿæ˜¯åˆå­¦è€…å¾ˆå®¹æ˜“çŠ¯çš„é”™è¯¯</p><h4 id="æ¡ˆä¾‹äºŒ-åœ¨å¾ªç¯ä¸­å¯åŠ¨-goroutine-å¼•ç”¨ä¸´æ—¶å˜é‡"><a href="#æ¡ˆä¾‹äºŒ-åœ¨å¾ªç¯ä¸­å¯åŠ¨-goroutine-å¼•ç”¨ä¸´æ—¶å˜é‡" class="headerlink" title="æ¡ˆä¾‹äºŒ åœ¨å¾ªç¯ä¸­å¯åŠ¨ goroutine å¼•ç”¨ä¸´æ—¶å˜é‡"></a>æ¡ˆä¾‹äºŒ åœ¨å¾ªç¯ä¸­å¯åŠ¨ goroutine å¼•ç”¨ä¸´æ—¶å˜é‡</h4><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-keyword">var</span> wg sync.WaitGroup
	wg.Add(<span class="hljs-number">5</span>)
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;
		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
			fmt.Println(i) <span class="hljs-comment">// Not the 'i' you are looking for.</span>
			wg.Done()
		&#125;()
	&#125;
	wg.Wait()
&#125;</code></pre><p>å¦‚æœä½ å»æ‰¾ä¸€äº› go çš„é¢è¯•é¢˜ï¼Œè‚¯å®šèƒ½æ‰¾åˆ°ç±»ä¼¼çš„ä¾‹å­ï¼Œç„¶åä¼šé—®ä½ è¿™é‡Œä¼šè¾“å‡ºä»€ä¹ˆï¼Ÿ<br>å¸¸è§çš„ç­”æ¡ˆå°±æ˜¯ä¼šè¾“å‡º 5 ä¸ª 5ï¼Œå› ä¸ºåœ¨ for å¾ªç¯çš„ i++ ä¼šæ‰§è¡Œçš„å¿«ä¸€äº›ï¼Œæ‰€ä»¥åœ¨æœ€åæ‰“å°çš„ç»“æœéƒ½æ˜¯ 5<br>è¿™ä¸ªç­”æ¡ˆä¸èƒ½è¯´ä¸å¯¹ï¼Œå› ä¸ºçœŸçš„æ‰§è¡Œçš„è¯å¤§æ¦‚ç‡ä¹Ÿæ˜¯è¿™ä¸ªç»“æœï¼Œä½†æ˜¯ä¸å…¨<br>å› ä¸ºè¿™é‡Œæœ¬è´¨ä¸Šæ˜¯æœ‰æ•°æ®ç«äº‰ï¼Œåœ¨æ–°å¯åŠ¨çš„ goroutine å½“ä¸­è¯»å– i çš„å€¼ï¼Œåœ¨ main ä¸­å†™å…¥ï¼Œå¯¼è‡´å‡ºç°äº† data raceï¼Œè¿™ä¸ªç»“æœåº”è¯¥æ˜¯ä¸å¯é¢„çŸ¥çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½å‡å®š goroutine ä¸­ print å°±ä¸€å®šæ¯”å¤–é¢çš„ i++ æ…¢ï¼Œä¹ æƒ¯æ€§çš„åšè¿™ç§å‡è®¾åœ¨å¹¶å‘ç¼–ç¨‹ä¸­æ˜¯å¾ˆæœ‰å¯èƒ½ä¼šå‡ºé—®é¢˜çš„</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-keyword">var</span> wg sync.WaitGroup
	wg.Add(<span class="hljs-number">5</span>)
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;
		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-keyword">int</span>)</span></span> &#123;
			fmt.Println(i)
			wg.Done()
		&#125;(i)
	&#125;
	wg.Wait()
&#125;</code></pre><p>è¿™ä¸ªè¦ä¿®æ”¹ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦å°† i ä½œä¸ºå‚æ•°ä¼ å…¥å³å¯ï¼Œè¿™æ ·æ¯ä¸ª goroutine æ‹¿åˆ°çš„éƒ½æ˜¯æ‹·è´åçš„æ•°æ®</p><h4 id="æ¡ˆä¾‹ä¸‰-ä¸€ä¸å°å¿ƒå°±æŠŠå˜é‡å…±äº«äº†"><a href="#æ¡ˆä¾‹ä¸‰-ä¸€ä¸å°å¿ƒå°±æŠŠå˜é‡å…±äº«äº†" class="headerlink" title="æ¡ˆä¾‹ä¸‰ ä¸€ä¸å°å¿ƒå°±æŠŠå˜é‡å…±äº«äº†"></a>æ¡ˆä¾‹ä¸‰ ä¸€ä¸å°å¿ƒå°±æŠŠå˜é‡å…±äº«äº†</h4><pre><code class="hljs go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"os"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;
	ParallelWrite([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">"xxx"</span>))
&#125;

<span class="hljs-comment">// ParallelWrite writes data to file1 and file2, returns the errors.</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ParallelWrite</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">chan</span> <span class="hljs-title">error</span></span> &#123;
	res := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> error, <span class="hljs-number">2</span>)
	f1, err := os.Create(<span class="hljs-string">"/tmp/file1"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
		res &lt;- err
	&#125; <span class="hljs-keyword">else</span> &#123;
		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
			<span class="hljs-comment">// This err is shared with the main goroutine,</span>
			<span class="hljs-comment">// so the write races with the write below.</span>
			_, err = f1.Write(data)
			res &lt;- err
			f1.Close()
		&#125;()
	&#125;
	f2, err := os.Create(<span class="hljs-string">"/tmp/file2"</span>) <span class="hljs-comment">// The second conflicting write to err.</span>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;
		res &lt;- err
	&#125; <span class="hljs-keyword">else</span> &#123;
		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
			_, err = f2.Write(data)
			res &lt;- err
			f2.Close()
		&#125;()
	&#125;
	<span class="hljs-keyword">return</span> res
&#125;</code></pre><p>æˆ‘ä»¬ä½¿ç”¨ <code>go run -race main.go</code> æ‰§è¡Œï¼Œå¯ä»¥å‘ç°è¿™é‡ŒæŠ¥é”™çš„åœ°æ–¹æ˜¯ï¼Œ19 è¡Œå’Œ 24 è¡Œï¼Œæœ‰ data raceï¼Œè¿™é‡Œä¸»è¦æ˜¯å› ä¸ºå…±äº«äº† err è¿™ä¸ªå˜é‡</p><pre><code class="hljs go">==================
WARNING: DATA RACE
Write at <span class="hljs-number">0x00c0000a01a0</span> by goroutine <span class="hljs-number">7</span>:
  main.ParallelWrite.func1()
      /home/ll/project/Go<span class="hljs-number">-000</span>/Week03/blog/<span class="hljs-number">03</span>_data_race/<span class="hljs-number">03</span>/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">19</span> +<span class="hljs-number">0x94</span>

Previous write at <span class="hljs-number">0x00c0000a01a0</span> by main goroutine:
  main.ParallelWrite()
      /home/ll/project/Go<span class="hljs-number">-000</span>/Week03/blog/<span class="hljs-number">03</span>_data_race/<span class="hljs-number">03</span>/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">24</span> +<span class="hljs-number">0x1dd</span>
  main.main()
      /home/ll/project/Go<span class="hljs-number">-000</span>/Week03/blog/<span class="hljs-number">03</span>_data_race/<span class="hljs-number">03</span>/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">6</span> +<span class="hljs-number">0x84</span>

Goroutine <span class="hljs-number">7</span> (running) created at:
  main.ParallelWrite()
      /home/ll/project/Go<span class="hljs-number">-000</span>/Week03/blog/<span class="hljs-number">03</span>_data_race/<span class="hljs-number">03</span>/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">16</span> +<span class="hljs-number">0x336</span>
  main.main()
      /home/ll/project/Go<span class="hljs-number">-000</span>/Week03/blog/<span class="hljs-number">03</span>_data_race/<span class="hljs-number">03</span>/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">6</span> +<span class="hljs-number">0x84</span>
==================
Found <span class="hljs-number">1</span> data race(s)
exit status <span class="hljs-number">66</span></code></pre><p>ä¿®æ”¹çš„è¯åªéœ€è¦åœ¨ä¸¤ä¸ª goroutine ä¸­ä½¿ç”¨æ–°çš„ä¸´æ—¶å˜é‡å°±è¡Œäº†</p><pre><code class="hljs go">...
_, err := f1.Write(data)
...
_, err := f2.Write(data)
...</code></pre><p>ç»†å¿ƒçš„åŒå­¦å¯èƒ½ä¼šæœ‰è¿™ä¸ªç–‘é—®ï¼Œåœ¨ 24 è¡Œä¸ä¹Ÿæ˜¯é‡æ–°èµ‹å€¼äº†ä¹ˆï¼Œä¸ºä»€ä¹ˆåœ¨è¿™é‡Œä¼šå’Œ 19 è¡Œäº§ç”Ÿ data race å‘¢ï¼Ÿ<br>è¿™æ˜¯ç”±äº go çš„è¯­æ³•è§„åˆ™å¯¼è‡´çš„ï¼Œæˆ‘ä»¬åœ¨åˆå§‹åŒ–å˜é‡çš„æ—¶å€™å¦‚æœåœ¨åŒä¸€ä¸ªä½œç”¨åŸŸä¸‹ï¼Œå¦‚ä¸‹æ–¹ä»£ç ï¼Œè¿™é‡Œä½¿ç”¨çš„ err å…¶å®æ˜¯åŒä¸€ä¸ªå˜é‡ï¼Œåªæ˜¯ f1 f2 ä¸åŒï¼Œå…·ä½“å¯ä»¥çœ‹ <a href="https://golang.org/doc/effective_go.html#redeclaration" target="_blank" rel="noopener">effective go å½“ä¸­ Redeclaration and reassignment</a> çš„å†…å®¹</p><pre><code class="hljs go">f1, err := os.Create(<span class="hljs-string">"a"</span>)
f2, err := os.Create(<span class="hljs-string">"b"</span>)</code></pre><h4 id="æ¡ˆä¾‹å››-ä¸å—ä¿æŠ¤çš„å…¨å±€å˜é‡"><a href="#æ¡ˆä¾‹å››-ä¸å—ä¿æŠ¤çš„å…¨å±€å˜é‡" class="headerlink" title="æ¡ˆä¾‹å›› ä¸å—ä¿æŠ¤çš„å…¨å±€å˜é‡"></a>æ¡ˆä¾‹å›› ä¸å—ä¿æŠ¤çš„å…¨å±€å˜é‡</h4><pre><code class="hljs go"><span class="hljs-keyword">var</span> service = <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>&#123;&#125;

<span class="hljs-comment">// RegisterService RegisterService</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RegisterService</span><span class="hljs-params">(name, addr <span class="hljs-keyword">string</span>)</span></span> &#123;
	service[name] = addr
&#125;

<span class="hljs-comment">// LookupService LookupService</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LookupService</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;
	<span class="hljs-keyword">return</span> service[name]
&#125;</code></pre><p>è¿™ä¸ªä¹Ÿæ˜¯å¾ˆå®¹æ˜“çŠ¯çš„ä¸€ä¸ªé”™ï¼Œåœ¨ä¹‹å‰å†™ Go è®¾è®¡æ¨¡å¼è¿™ä¸ªç³»åˆ—æ–‡ç« çš„æ—¶å€™ï¼Œåº”è¯¥æœ‰æåˆ°è¿‡æˆ‘ä»¬è¦å†™å‡ºå¯æµ‹æ€§æ¯”è¾ƒé«˜çš„ä»£ç å°±è¦å°‘ç”¨æˆ–è€…æ˜¯å°½é‡é¿å…ç”¨å…¨å±€å˜é‡ï¼Œä½¿ç”¨ map ä½œä¸ºå…¨å±€å˜é‡æ¯”è¾ƒå¸¸è§çš„ä¸€ç§æƒ…å†µå°±æ˜¯é…ç½®ä¿¡æ¯ã€‚å…³äºå…¨å±€å˜é‡çš„è¯ä¸€èˆ¬çš„åšæ³•å°±æ˜¯åŠ é”ï¼Œå°±æœ¬æ–‡è¿™ä¸ªé—®é¢˜ä¹Ÿå¯ä»¥ä½¿ç”¨ sync.Map è¿™ä¸ªä¸‹ä¸€ç¯‡æ–‡ç« ä¼šè®²ï¼Œè¿™é‡Œç¯‡å¹…æœ‰é™å°±ä¸å¤šè®²äº†</p><pre><code class="hljs go"><span class="hljs-keyword">var</span> (
	service   <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>
	serviceMu sync.Mutex
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RegisterService</span><span class="hljs-params">(name, addr <span class="hljs-keyword">string</span>)</span></span> &#123;
	serviceMu.Lock()
	<span class="hljs-keyword">defer</span> serviceMu.Unlock()
	service[name] = addr
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LookupService</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;
	serviceMu.Lock()
	<span class="hljs-keyword">defer</span> serviceMu.Unlock()
	<span class="hljs-keyword">return</span> service[name]
&#125;</code></pre><h4 id="æ¡ˆä¾‹äº”-æœªå—ä¿æŠ¤çš„æˆå‘˜å˜é‡"><a href="#æ¡ˆä¾‹äº”-æœªå—ä¿æŠ¤çš„æˆå‘˜å˜é‡" class="headerlink" title="æ¡ˆä¾‹äº” æœªå—ä¿æŠ¤çš„æˆå‘˜å˜é‡"></a>æ¡ˆä¾‹äº” æœªå—ä¿æŠ¤çš„æˆå‘˜å˜é‡</h4><pre><code class="hljs go"><span class="hljs-keyword">type</span> Watchdog <span class="hljs-keyword">struct</span>&#123; last <span class="hljs-keyword">int64</span> &#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Watchdog)</span> <span class="hljs-title">KeepAlive</span><span class="hljs-params">()</span></span> &#123;
	w.last = time.Now().UnixNano() <span class="hljs-comment">// First conflicting access.</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Watchdog)</span> <span class="hljs-title">Start</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
		<span class="hljs-keyword">for</span> &#123;
			time.Sleep(time.Second)
			<span class="hljs-comment">// Second conflicting access.</span>
			<span class="hljs-keyword">if</span> w.last &lt; time.Now().Add(<span class="hljs-number">-10</span>*time.Second).UnixNano() &#123;
				fmt.Println(<span class="hljs-string">"No keepalives for 10 seconds. Dying."</span>)
				os.Exit(<span class="hljs-number">1</span>)
			&#125;
		&#125;
	&#125;()
&#125;</code></pre><p>åŒæ ·æˆå‘˜å˜é‡ä¹Ÿä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œå¯ä»¥ç”¨ <code>atomic</code> åŒ…æ¥è§£å†³ï¼ŒåŒæ ·è¿™ä¸ªæˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« ä¼šç»†è®²</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> Watchdog <span class="hljs-keyword">struct</span>&#123; last <span class="hljs-keyword">int64</span> &#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Watchdog)</span> <span class="hljs-title">KeepAlive</span><span class="hljs-params">()</span></span> &#123;
	atomic.StoreInt64(&amp;w.last, time.Now().UnixNano())
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Watchdog)</span> <span class="hljs-title">Start</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
		<span class="hljs-keyword">for</span> &#123;
			time.Sleep(time.Second)
			<span class="hljs-keyword">if</span> atomic.LoadInt64(&amp;w.last) &lt; time.Now().Add(<span class="hljs-number">-10</span>*time.Second).UnixNano() &#123;
				fmt.Println(<span class="hljs-string">"No keepalives for 10 seconds. Dying."</span>)
				os.Exit(<span class="hljs-number">1</span>)
			&#125;
		&#125;
	&#125;()
&#125;</code></pre><h3 id="æ¡ˆä¾‹å…­-ä¸€ä¸ªæœ‰è¶£çš„ä¾‹å­"><a href="#æ¡ˆä¾‹å…­-ä¸€ä¸ªæœ‰è¶£çš„ä¾‹å­" class="headerlink" title="æ¡ˆä¾‹å…­ ä¸€ä¸ªæœ‰è¶£çš„ä¾‹å­"></a>æ¡ˆä¾‹å…­ ä¸€ä¸ªæœ‰è¶£çš„ä¾‹å­</h3><p>dava åœ¨åšå®¢ä¸­æåˆ°è¿‡ä¸€ä¸ªå¾ˆæœ‰è¶£çš„ä¾‹å­çš„ <a href="https://dave.cheney.net/2014/06/27/ice-cream-makers-and-data-races" target="_blank" rel="noopener">Ice cream makers and data races</a></p><pre><code class="hljs go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-keyword">type</span> IceCreamMaker <span class="hljs-keyword">interface</span> &#123;
	<span class="hljs-comment">// Great a customer.</span>
	Hello()
&#125;

<span class="hljs-keyword">type</span> Ben <span class="hljs-keyword">struct</span> &#123;
	name <span class="hljs-keyword">string</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Ben)</span> <span class="hljs-title">Hello</span><span class="hljs-params">()</span></span> &#123;
	fmt.Printf(<span class="hljs-string">"Ben says, \"Hello my name is %s\"\n"</span>, b.name)
&#125;

<span class="hljs-keyword">type</span> Jerry <span class="hljs-keyword">struct</span> &#123;
	name <span class="hljs-keyword">string</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(j *Jerry)</span> <span class="hljs-title">Hello</span><span class="hljs-params">()</span></span> &#123;
	fmt.Printf(<span class="hljs-string">"Jerry says, \"Hello my name is %s\"\n"</span>, j.name)
&#125;

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-keyword">var</span> ben = &amp;Ben&#123;name: <span class="hljs-string">"Ben"</span>&#125;
	<span class="hljs-keyword">var</span> jerry = &amp;Jerry&#123;<span class="hljs-string">"Jerry"</span>&#125;
	<span class="hljs-keyword">var</span> maker IceCreamMaker = ben

	<span class="hljs-keyword">var</span> loop0, loop1 <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span>

	loop0 = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
		maker = ben
		<span class="hljs-keyword">go</span> loop1()
	&#125;

	loop1 = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
		maker = jerry
		<span class="hljs-keyword">go</span> loop0()
	&#125;

	<span class="hljs-keyword">go</span> loop0()

	<span class="hljs-keyword">for</span> &#123;
		maker.Hello()
	&#125;
&#125;</code></pre><p>è¿™ä¸ªä¾‹å­æœ‰è¶£çš„ç‚¹åœ¨äºï¼Œæœ€åè¾“å‡ºçš„ç»“æœä¼šæœ‰è¿™ç§ä¾‹å­</p><pre><code class="hljs go">Ben says, <span class="hljs-string">"Hello my name is Jerry"</span>
Ben says, <span class="hljs-string">"Hello my name is Jerry"</span></code></pre><p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨ <code>maker = jerry</code> è¿™ç§èµ‹å€¼æ“ä½œçš„æ—¶å€™å¹¶ä¸æ˜¯åŸå­çš„ï¼Œåœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬è®²åˆ°è¿‡ï¼Œåªæœ‰å¯¹ single machine word è¿›è¡Œèµ‹å€¼çš„æ—¶å€™æ‰æ˜¯åŸå­çš„ï¼Œè™½ç„¶è¿™ä¸ªçœ‹ä¸Šå»åªæœ‰ä¸€è¡Œï¼Œä½†æ˜¯ interface åœ¨ go ä¸­å…¶å®æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå®ƒåŒ…å«äº† type å’Œ data ä¸¤ä¸ªéƒ¨åˆ†ï¼Œæ‰€ä»¥å®ƒçš„å¤åˆ¶ä¹Ÿä¸æ˜¯åŸå­çš„ï¼Œä¼šå‡ºç°é—®é¢˜</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> <span class="hljs-keyword">interface</span> <span class="hljs-keyword">struct</span> &#123;
       Type <span class="hljs-keyword">uintptr</span>     <span class="hljs-comment">// points to the type of the interface implementation</span>
       Data <span class="hljs-keyword">uintptr</span>     <span class="hljs-comment">// holds the data for the interface's receiver</span>
&#125;</code></pre><p>è¿™ä¸ªæ¡ˆä¾‹æœ‰è¶£çš„ç‚¹è¿˜åœ¨äºï¼Œè¿™ä¸ªæ¡ˆä¾‹çš„ä¸¤ä¸ªç»“æ„ä½“çš„å†…å­˜å¸ƒå±€ä¸€æ¨¡ä¸€æ ·æ‰€ä»¥å‡ºç°é”™è¯¯ä¹Ÿä¸ä¼š panic é€€å‡ºï¼Œå¦‚æœåœ¨é‡Œé¢å†åŠ å…¥ä¸€ä¸ª string çš„å­—æ®µï¼Œå»è¯»å–å°±ä¼šå¯¼è‡´ panicï¼Œä½†æ˜¯è¿™ä¹Ÿæ°æ°è¯´æ˜è¿™ä¸ªæ¡ˆä¾‹å¾ˆå¯æ€•ï¼Œè¿™ç§é”™è¯¯åœ¨çº¿ä¸Šå®åœ¨å¤ªéš¾å‘ç°äº†ï¼Œè€Œä¸”å¾ˆæœ‰å¯èƒ½ä¼šå¾ˆè‡´å‘½ã€‚<br>è¿™ä¸ªæ¡ˆä¾‹è¿˜æœ‰ä¸€ä¸ªè¡ç”Ÿæ¡ˆä¾‹ï¼Œå¤§å®¶æœ‰å…´è¶£å¯ä»¥ç‚¹å¼€æŸ¥çœ‹ä¸€ä¸‹ï¼Œå¹¶ä¸æ˜¯è¯´è¦çœ‹èµ·æ¥ä¸€æ ·æ‰ä¸ä¼š panic <a href="https://www.ardanlabs.com/blog/2014/06/ice-cream-makers-and-data-races-part-ii.html" target="_blank" rel="noopener">https://www.ardanlabs.com/blog/2014/06/ice-cream-makers-and-data-races-part-ii.html</a></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å›é¡¾ä¸€ä¸‹ï¼Œè¿™ç¯‡æ–‡ç« é€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹è®²è§£äº† data race çš„ä½¿ç”¨æ–¹æ³•:</p><pre><code class="hljs go"><span class="hljs-keyword">go</span> build -race main.<span class="hljs-keyword">go</span>
<span class="hljs-keyword">go</span> test -race ./...</code></pre><p>ç„¶åè®²è¿°äº† data race å¦‚ä½•é€šè¿‡ GORACE ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®<br>æœ€åè®²è§£äº†å‡ ä¸ªå…¸å‹æ¡ˆä¾‹ï¼Œçœ‹å®Œè¿™ç¯‡ç›¸ä¿¡ä½ å¯¹ data race å·²ç»æœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„äº†è§£ï¼Œå¸Œæœ›å¯ä»¥åœ¨æ¥ä¸‹æ¥çš„å·¥ä½œå­¦ä¹ å½“ä¸­å¯¹ä½ æœ‰æœ‰æ‰€å¯å‘<br>æœ€ååœ¨é‡ç”³ä¸€ä¸‹å…³é”®ç‚¹ï¼š</p><ul><li>å–„ç”¨ data race è¿™ä¸ªå·¥å…·å¸®åŠ©æˆ‘ä»¬æå‰å‘ç°å¹¶å‘é”™è¯¯</li><li>ä¸è¦å¯¹æœªå®šä¹‰çš„è¡Œä¸ºåšä»»ä½•å‡è®¾ï¼Œè™½ç„¶æœ‰æ—¶å€™æˆ‘ä»¬å†™çš„åªæ˜¯ä¸€è¡Œä»£ç ï¼Œä½†æ˜¯ go ç¼–è¯‘å™¨å¯èƒ½åé¢åäº†å¾ˆå¤šäº‹æƒ…ï¼Œå¹¶ä¸æ˜¯è¯´ä¸€è¡Œå†™å®Œå°±ä¸€å®šæ˜¯åŸå­çš„</li><li>å³ä½¿æ˜¯åŸå­çš„å‡ºç°äº† data race ä¹Ÿä¸èƒ½ä¿è¯å®‰å…¨ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æœ‰å¯è§æ€§çš„é—®é¢˜ï¼Œä¸Šç¯‡æˆ‘ä»¬è®²åˆ°äº†ç°ä»£çš„ cpu åŸºæœ¬ä¸Šéƒ½ä¼šæœ‰ä¸€äº›ç¼“å­˜çš„æ“ä½œã€‚</li><li>æ‰€æœ‰å‡ºç°äº† data race çš„åœ°æ–¹éƒ½éœ€è¦è¿›è¡Œå¤„ç†</li></ul><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ul><li><a href="https://dave.cheney.net/2014/06/27/ice-cream-makers-and-data-races" target="_blank" rel="noopener">https://dave.cheney.net/2014/06/27/ice-cream-makers-and-data-races</a></li><li><a href="https://www.ardanlabs.com/blog/2014/06/ice-cream-makers-and-data-races-part-ii.html" target="_blank" rel="noopener">https://www.ardanlabs.com/blog/2014/06/ice-cream-makers-and-data-races-part-ii.html</a></li><li><a href="http://blog.golang.org/race-detector" target="_blank" rel="noopener">http://blog.golang.org/race-detector</a></li><li><a href="https://golang.org/doc/articles/race_detector.html" target="_blank" rel="noopener">https://golang.org/doc/articles/race_detector.html</a></li><li><a href="https://dave.cheney.net/2018/01/06/if-aligned-memory-writes-are-atomic-why-do-we-need-the-sync-atomic-package" target="_blank" rel="noopener">https://dave.cheney.net/2018/01/06/if-aligned-memory-writes-are-atomic-why-do-we-need-the-sync-atomic-package</a> é™¤äº†è€ƒè™‘åŸå­æ€§ä¹‹å¤–ï¼Œè¿˜è¦è€ƒè™‘å¯è§æ€§ï¼Œå¹¶ä¸æ˜¯è¯´èµ‹å€¼åŸå­äº†ï¼Œå¹¶å‘æ“ä½œå°±æ²¡æœ‰é—®é¢˜äº†</li><li><a href="https://golang.org/doc/effective_go.html#redeclaration" target="_blank" rel="noopener">https://golang.org/doc/effective_go.html#redeclaration</a></li></ul><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°"><a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°</h2><p>çœ‹åˆ°è¿™é‡Œäº†è¿˜ä¸å…³æ³¨ç‚¹èµèµ°ä¸€æ³¢</p><ul><li><a href="https://lailin.xyz">åšå®¢</a> å¯ä»¥è®¢é˜… RSS</li><li><a href="https://github.com/mohuishou" target="_blank" rel="noopener">Github</a> Follow me</li><li><a href="https://www.zhihu.com/people/mo-hui-shou-76" target="_blank" rel="noopener">çŸ¥ä¹</a> å…³æ³¨è´¦å·ï¼Œé¡ºä¾¿ç‚¹ä¸ª ğŸ‘</li><li><a href="https://toutiao.io/subjects/387401?f=new" target="_blank" rel="noopener">å¼€å‘è€…å¤´æ¡</a> è®¢é˜…è®¢é˜…å·ï¼Œé¡ºä¾¿ç‚¹ä¸ª ğŸ‘</li></ul><div><h2 id="ç›¸å…³æ¨è">ç›¸å…³æ¨è</h2><ul><li><a href="https://lailin.xyz/post/go-training-week3-waitgroup.html">Week03: Goå¹¶å‘ç¼–ç¨‹(å…­) æ·±å…¥ç†è§£ WaitGroup</a></li><li><a href="https://lailin.xyz/post/go-training-week3-atomic.html">Week03: Goå¹¶å‘ç¼–ç¨‹(äº”) æ·±å…¥ç†è§£ sync/atomic</a></li><li><a href="https://lailin.xyz/post/go-training-week3-sync.html">Week03: Goå¹¶å‘ç¼–ç¨‹(å››) æ·±å…¥ç†è§£ Mutex</a></li></ul></div></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/Goè¿›é˜¶è®­ç»ƒè¥/">Goè¿›é˜¶è®­ç»ƒè¥</a> <a class="hover-with-bg" href="/categories/Goè¿›é˜¶è®­ç»ƒè¥/Goå¹¶å‘ç¼–ç¨‹/">Goå¹¶å‘ç¼–ç¨‹</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/å­¦ä¹ ç¬”è®°/">å­¦ä¹ ç¬”è®°</a> <a class="hover-with-bg" href="/tags/Go/">Go</a> <a class="hover-with-bg" href="/tags/Goè¿›é˜¶è®­ç»ƒè¥/">Goè¿›é˜¶è®­ç»ƒè¥</a> <a class="hover-with-bg" href="/tags/å¹¶å‘/">å¹¶å‘</a></div></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext row"><article class="post-prev col-6"><a href="/post/go-training-week3-sync.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Week03: Goå¹¶å‘ç¼–ç¨‹(å››) æ·±å…¥ç†è§£ Mutex</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></article><article class="post-next col-6"><a href="/post/go-training-week3-go-memory-model.html"><span class="hidden-mobile">Week03: Goå¹¶å‘ç¼–ç¨‹(äºŒ) Go å†…å­˜æ¨¡å‹</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><script type="text/javascript">function loadUtterances(){var t="github-light",e="github-dark",s=document.documentElement.getAttribute("data-user-color-scheme");s="dark"===s?e:t,window.UtterancesThemeLight=t,window.UtterancesThemeDark=e;var n=document.createElement("script");n.setAttribute("src","https://utteranc.es/client.js"),n.setAttribute("repo","scuplus/blogComment"),n.setAttribute("issue-term","pathname"),n.setAttribute("label","utterances"),n.setAttribute("theme",s),n.setAttribute("crossorigin","anonymous"),document.getElementById("comments").appendChild(n)}waitElementVisible("comments",loadUtterances)</script></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div id="tocbot"></div></div></div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready(function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:"#post-body",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:0,scrollSmooth:!0,headingsOffset:-t}),0<$(".toc-list-item").length&&$("#toc").css("visibility","visible")})</script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","Week03: Goå¹¶å‘ç¼–ç¨‹(ä¸‰) data race&nbsp;"],cursorChar:"_",typeSpeed:70,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})</script><script defer>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-137859264-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script></body></html>