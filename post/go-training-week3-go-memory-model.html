<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/icons/touch-icon-apple.png"><link rel="icon" type="image/png" href="/icons/favicon-32x32.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="Mohuishou"><meta name="keywords" content="Go, Docker, PHP"><title>Goå¹¶å‘ç¼–ç¨‹(äºŒ) Go å†…å­˜æ¨¡å‹ - Mohuishou</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/assets/css/custom.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"lailin.xyz",root:"/",version:"1.8.7",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,onlypost:!1},web_analytics:{enable:!0,baidu:null,google:"UA-137859264-1",gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}}}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>mohuishou</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/post/go-training-01.html"><i class="iconfont icon-category-fill"></i> Go è¿›é˜¶è®­ç»ƒè¥(æ›´æ–°ä¸­)</a></li><li class="nav-item"><a class="nav-link" href="/post/go-design-pattern.html"><i class="iconfont icon-notebook"></i> Go è®¾è®¡æ¨¡å¼</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> æ›´å¤š</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/links/"><i class="iconfont icon-link-fill"></i> å‹é“¾ </a><a class="dropdown-item" href="/atom.xml"><i class="iconfont icon-rss"></i> rss </a><a class="dropdown-item" href="/tags/"><i class="iconfont icon-tags-fill"></i> æ ‡ç­¾</a></div></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/bg.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="Goå¹¶å‘ç¼–ç¨‹(äºŒ) Go å†…å­˜æ¨¡å‹"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2020-12-19 21:08" pubdate>2020å¹´12æœˆ19æ—¥ æ™šä¸Š</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3.8k å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 46 åˆ†é’Ÿ</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"><div id="sidebar"><p class="sidebar-header">Goè¿›é˜¶è®­ç»ƒè¥</p><ol class="sidebar-list sidebar-list-1"><li class="sidebar-list-item"><a>Week01: å¾®æœåŠ¡</a><ol class="sidebar-list sidebar-list-2"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-01.html">å¾®æœåŠ¡(ä¸€) å¾®æœåŠ¡æ¦‚è§ˆ</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-02.html">å¾®æœåŠ¡(äºŒ) æœåŠ¡å‘ç°&amp;å¤šç§Ÿæˆ·</a></li></ol></li><li class="sidebar-list-item"><a>Week02: Goé”™è¯¯å¤„ç†</a><ol class="sidebar-list sidebar-list-2"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-03.html">Goé”™è¯¯å¤„ç†æœ€ä½³å®è·µ</a></li></ol></li><li class="sidebar-list-item"><a>Week03: Go å¹¶å‘ç¼–ç¨‹</a><ol class="sidebar-list sidebar-list-2"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-goroutine.html">Goå¹¶å‘ç¼–ç¨‹(ä¸€) goroutine</a></li><li class="sidebar-list-item is-active-li"><a class="sidebar-link sidebar-active-link" href="/post/go-training-week3-go-memory-model.html">Goå¹¶å‘ç¼–ç¨‹(äºŒ) Go å†…å­˜æ¨¡å‹</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-data-race.html">Goå¹¶å‘ç¼–ç¨‹(ä¸‰) data race</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-sync.html">Goå¹¶å‘ç¼–ç¨‹(å››) æ·±å…¥ç†è§£ Mutex</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-atomic.html">Goå¹¶å‘ç¼–ç¨‹(äº”) æ·±å…¥ç†è§£ sync/atomic</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-waitgroup.html">Goå¹¶å‘ç¼–ç¨‹(å…­) æ·±å…¥ç†è§£ WaitGroup</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-errgroup.html">Goå¹¶å‘ç¼–ç¨‹(ä¸ƒ) æ·±å…¥ç†è§£ errgroup</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-once.html">Goå¹¶å‘ç¼–ç¨‹(å…«) æ·±å…¥ç†è§£ sync.Once</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-context.html">Goå¹¶å‘ç¼–ç¨‹(ä¹) æ·±å…¥ç†è§£ Context</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-channel.html">Goå¹¶å‘ç¼–ç¨‹(å) æ·±å…¥ç†è§£ Channel</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-sum.html">Goå¹¶å‘ç¼–ç¨‹(åä¸€) æ€»ç»“</a></li></ol></li><li class="sidebar-list-item"><a>Week04: Go å·¥ç¨‹åŒ–</a><ol class="sidebar-list sidebar-list-2"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-clean-arch.html">Goå·¥ç¨‹åŒ–(ä¸€) æ¶æ„æ•´æ´ä¹‹é“é˜…è¯»ç¬”è®°</a></li></ol></li></ol></div></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">Goå¹¶å‘ç¼–ç¨‹(äºŒ) Go å†…å­˜æ¨¡å‹</h1><div class="markdown-body"><blockquote><p>æœ¬ç³»åˆ—ä¸ºæå®¢æ—¶é—´ Go è¿›é˜¶è®­ç»ƒè¥ç¬”è®°ï¼ŒåŒæ­¥ç›´æ’­æ›´æ–°ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 1 ~ 2 ç¯‡æ–‡ç« ï¼Œåˆ° 202103 æœˆæ›´æ–°å®Œæˆ</p></blockquote><h2 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h2><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« å½“ä¸­æˆ‘ä»¬è®²åˆ°äº†ä½¿ç”¨ goroutine çš„ä¸€äº›æ³¨æ„äº‹é¡¹ï¼Œæˆ‘ä»¬å…ˆç®€å•å›é¡¾ä¸€ä¸‹:</p><ol><li><strong>è¯·å°†æ˜¯å¦å¼‚æ­¥è°ƒç”¨çš„é€‰æ‹©æƒäº¤ç»™è°ƒç”¨è€…</strong>ï¼Œä¸ç„¶å¾ˆæœ‰å¯èƒ½å¤§å®¶å¹¶ä¸çŸ¥é“ä½ åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ä½¿ç”¨äº† goroutine</li><li>å¦‚æœä½ è¦å¯åŠ¨ä¸€ä¸ª goroutine è¯·å¯¹å®ƒè´Ÿè´£<ol><li><strong>æ°¸è¿œä¸è¦å¯åŠ¨ä¸€ä¸ªä½ æ— æ³•æ§åˆ¶å®ƒé€€å‡ºï¼Œæˆ–è€…ä½ æ— æ³•çŸ¥é“å®ƒä½•æ—¶æ¨å‡ºçš„ goroutine</strong></li><li>è¿˜æœ‰ä¸Šä¸€ç¯‡æåˆ°çš„ï¼Œå¯åŠ¨ goroutine æ—¶è¯·åŠ ä¸Š panic recovery æœºåˆ¶ï¼Œé¿å…æœåŠ¡ç›´æ¥ä¸å¯ç”¨</li><li>é€ æˆ goroutine æ³„æ¼çš„ä¸»è¦åŸå› å°±æ˜¯ goroutine ä¸­é€ æˆäº†é˜»å¡ï¼Œå¹¶ä¸”æ²¡æœ‰å¤–éƒ¨æ‰‹æ®µæ§åˆ¶å®ƒé€€å‡º</li></ol></li><li><strong>å°½é‡é¿å…åœ¨è¯·æ±‚ä¸­ç›´æ¥å¯åŠ¨ goroutine æ¥å¤„ç†é—®é¢˜</strong>ï¼Œè€Œåº”è¯¥é€šè¿‡å¯åŠ¨ worker æ¥è¿›è¡Œæ¶ˆè´¹ï¼Œè¿™æ ·å¯ä»¥é¿å…ç”±äºè¯·æ±‚é‡è¿‡å¤§ï¼Œè€Œå¯¼è‡´å¤§é‡åˆ›å»º goroutine ä»è€Œå¯¼è‡´ oomï¼Œå½“ç„¶å¦‚æœè¯·æ±‚é‡æœ¬èº«éå¸¸å°ï¼Œé‚£å½“æˆ‘æ²¡è¯´</li></ol><p>é‚£æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆä½¿ç”¨ goroutine å‘¢ï¼Ÿä»Šå¤©æˆ‘ä»¬ä»åŸç†å±‚é¢æ¥äº†è§£ä¸€ä¸‹ goroutine çš„æ³¨æ„äº‹é¡¹ï¼Œæœ¬æ–‡ä»¥ Go å®˜æ–¹åšå®¢å½“ä¸­çš„ <a target="_blank" rel="noopener" href="https://golang.org/ref/mem">https://golang.org/ref/mem</a> ä¸ºä¸»å¹²ç©¿æ’è®²è§£ï¼Œå»ºè®®é˜…è¯»æœ¬æ–‡å‰å…ˆè‡ªè¡Œçœ‹å®Œä¸€éåŸæ–‡ï¼Œä¼šæœ‰æ›´å¤šçš„æ”¶è·</p><h2 id="Go-å†…å­˜æ¨¡å‹"><a href="#Go-å†…å­˜æ¨¡å‹" class="headerlink" title="Go å†…å­˜æ¨¡å‹"></a>Go å†…å­˜æ¨¡å‹</h2><p>åŒæ ·æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µä»£ç ï¼Œè¯·é—®ä¸‹é¢çš„ä»£ç å¯èƒ½ä¼šè¾“å‡ºä»€ä¹ˆï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">var</span> a, b <span class="hljs-keyword">int</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span> &#123;<br>	a = <span class="hljs-number">1</span><br>	b = <span class="hljs-number">2</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">g</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-built_in">print</span>(b)<br>	<span class="hljs-built_in">print</span>(a)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">go</span> f()<br>	g()<br>&#125;<br></code></pre></td></tr></table></figure><p>okï¼Œè¯·å¸¦ç€ä½ çš„ç­”æ¡ˆæˆ–è€…æ˜¯å›°æƒ‘æˆ‘ä»¬å¾€ä¸‹èµ°<br><img src="https://lailin.xyz/images/1608363233129-3653a44c-74a9-46dc-94b0-c6151da0c07c.svg" srcset="/img/loading.gif" alt="02_Goè¿›é˜¶03_blog_img.drawio.svg"><br>æ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„ç»“æœæ˜¯:</p><ul><li>æ‰§è¡Œé¡ºåº: 1 - 2 - 3 - 4, f å…ˆæ‰§è¡Œ, g åæ‰§è¡Œ, è¾“å‡º <code>2 1</code></li><li>æ‰§è¡Œé¡ºåº: 3 - 4 - 1 - 2, g å…ˆæ‰§è¡Œï¼Œf åæ‰§è¡Œï¼Œè¾“å‡º <code>0 0</code></li></ul><p>å°±è¿™å‡ ç§ç»“æœä¹ˆï¼Ÿå…¶å®ä¸ç„¶ï¼Œè¿˜æœ‰å¯èƒ½</p><ul><li>æ‰§è¡Œé¡ºåº: 1 - 3 - 4 - 2, <code>f</code> å…ˆæ‰§è¡Œä¸€éƒ¨åˆ†, ç„¶å <code>g</code> æ‰§è¡Œ, è¾“å‡º <code>0 1</code></li></ul><p>é‚£èƒ½ä¸èƒ½è¾“å‡º <code>2 0</code> å‘¢ï¼Ÿ</p><ul><li>å…ˆè¯´ç­”æ¡ˆï¼Œæ˜¯æœ‰å¯èƒ½çš„</li></ul><p>æ˜¯ä¸æ˜¯æ„Ÿè§‰æœ‰ç‚¹åå¸¸è¯†ï¼Ÿæ˜¯ä¸æ˜¯æ„Ÿè§‰æœ‰ç‚¹é£˜å¿½ä¸å®šï¼Ÿå¼•ç”¨å‚è€ƒæ–‡ç« é‡Œé¢æ›¹å¤§çš„ä¸€å¥è¯ï¼š</p><blockquote><p>è½¯ä»¶(<em>ç¼–è¯‘å™¨</em>)æˆ–ç¡¬ä»¶(<em>CPU</em>)ç³»ç»Ÿå¯ä»¥æ ¹æ®å…¶å¯¹ä»£ç çš„åˆ†æç»“æœï¼Œä¸€å®šç¨‹åº¦ä¸Šæ‰“ä¹±ä»£ç çš„æ‰§è¡Œé¡ºåºï¼Œä»¥è¾¾åˆ°å…¶ä¸å¯å‘Šäººçš„ç›®çš„(<em>æé«˜ CPU åˆ©ç”¨ç‡)</em></p></blockquote><p>æ‰€ä»¥æˆ‘ä»¬åœ¨ç¼–å†™å¹¶å‘ç¨‹åºçš„æ—¶å€™ä¸€å®šè¦å°å¿ƒï¼Œç„¶åå›åˆ°æˆ‘ä»¬æœ¬æ¬¡çš„ä¸»é¢˜ Go å†…å­˜æ¨¡å‹ï¼Œå°±æ˜¯è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªæ˜¯è¦äº†è§£è°å…ˆè°åï¼Œæœ‰ä¸ªä¸“æœ‰åè¯å« <code>Happens Before</code> ï¼Œå¦å¤–ä¸€ä¸ªå°±æ˜¯äº†è§£å¯è§æ€§çš„é—®é¢˜ï¼Œæˆ‘è¿™æ¬¡è¯»å–èƒ½ä¸èƒ½çœ‹åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„å†™å…¥<br>æ¥ä¸‹æ¥æˆ‘ä»¬å®˜æ–¹çš„æ–‡æ¡£<a target="_blank" rel="noopener" href="https://golang.org/ref/mem">ã€ŠThe Go Memory Modelã€‹</a>çš„æ€è·¯ä¸€æ­¥ä¸€æ­¥çš„äº†è§£è¿™äº›é—®é¢˜ï¼Œå› ä¸ºå®˜æ–¹çš„æ–‡æ¡£å†™çš„ç›¸å¯¹æ¯”è¾ƒç²¾ç‚¼ï¼Œæ‰€ä»¥ä¼šæ¯”è¾ƒéš¾æ‡‚ï¼Œæˆ‘ä¼šå°è¯•åŠ å…¥ä¸€äº›æˆ‘çš„ç†è§£è¡¥å……è¯´æ˜</p><h3 id="å¿ å‘Š"><a href="#å¿ å‘Š" class="headerlink" title="å¿ å‘Š"></a>å¿ å‘Š</h3><blockquote><p>Programs that modify data being simultaneously accessed by multiple goroutines must serialize such access.<br>To serialize access, protect the data with channel operations or other synchronization primitives such as those in the <a target="_blank" rel="noopener" href="https://golang.org/pkg/sync/"><code>sync</code></a> and <a target="_blank" rel="noopener" href="https://golang.org/pkg/sync/atomic/"><code>sync/atomic</code></a> packages.</p></blockquote><p>è¿™ä¸ªæ˜¯è¯´å¦‚æœä½ çš„ç¨‹åºå­˜åœ¨å¤šä¸ª goroutine å»è®¿é—®æ•°æ®çš„æ—¶å€™ï¼Œ<strong>å¿…é¡»åºåˆ—åŒ–çš„è®¿é—®ï¼Œ</strong>å¦‚ä½•ä¿è¯åºåˆ—åŒ–å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ channel æˆ–è€…æ˜¯ sync ä»¥åŠ sync/atomic ä¸‹é¢æä¾›çš„åŒæ­¥è¯­ä¹‰æ¥ä¿è¯</p><h3 id="Happens-Before"><a href="#Happens-Before" class="headerlink" title="Happens Before"></a>Happens Before</h3><h4 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h4><blockquote><p>Within a single goroutine, reads and writes must behave as if they executed in the order specified by the program. That is, compilers and processors may reorder the reads and writes executed within a single goroutine only when the reordering does not change the behavior within that goroutine as defined by the language specification. Because of this reordering, the execution order observed by one goroutine may differ from the order perceived by another. For example, if one goroutine executes a = 1; b = 2;, another might observe the updated value of b before the updated value of a.</p></blockquote><p>è¿™æ®µè¯å°±è§£é‡Šäº†ä¸Šé¢æˆ‘ä»¬ç¤ºä¾‹å½“ä¸­ä¸ºä»€ä¹ˆä¼šå‡ºç° <code>2 0</code> è¿™ç§æƒ…å†µã€‚<br>è¿™æ®µè¯å°±æ˜¯è¯´æˆ‘ä»¬åœ¨å•ä¸ª goroutine å½“ä¸­çš„ç¼–å†™çš„ä»£ç ä¼šæ€»æ˜¯æŒ‰ç…§æˆ‘ä»¬ç¼–å†™ä»£ç çš„é¡ºåºæ¥æ‰§è¡Œ</p><ul><li>å½“ç„¶è¿™ä¸ªä¹Ÿæ˜¯ç¬¦åˆæˆ‘ä»¬çš„ä¹ æƒ¯çš„</li><li>å½“ç„¶è¿™å¹¶ä¸è¡¨ç¤ºç¼–è¯‘å™¨åœ¨ç¼–è¯‘çš„æ—¶å€™ä¸ä¼šå¯¹æˆ‘ä»¬çš„ç¨‹åºè¿›è¡ŒæŒ‡ä»¤é‡æ’</li><li>è€Œæ˜¯è¯´åªä¼šåœ¨ä¸å½±å“è¯­è¨€è§„èŒƒå¯¹ goroutine çš„è¡Œä¸ºå®šä¹‰çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å’Œ CPU æ‰ä¼šå¯¹è¯»å–å’Œå†™å…¥çš„é¡ºåºè¿›è¡Œé‡æ–°æ’åºã€‚</li></ul><p>ä½†æ˜¯æ­£æ˜¯å› ä¸ºå­˜åœ¨è¿™ç§é‡æ’çš„æƒ…å†µï¼Œæ‰€ä»¥ä¸€ä¸ª goroutine ç›‘æµ‹åˆ°çš„æ‰§è¡Œé¡ºåºå’Œå¦å¤–ä¸€ä¸ª goroutine ç›‘æµ‹åˆ°çš„æœ‰å¯èƒ½ä¸ä¸€æ ·ã€‚å°±åƒæˆ‘ä»¬æœ€ä¸Šé¢çš„è¿™ä¸ªä¾‹å­ä¸€æ ·ï¼Œå¯èƒ½æˆ‘ä»¬åœ¨ f æ‰§è¡Œçš„é¡ºåºæ˜¯å…ˆæ‰§è¡Œ <code>a = 1</code> åæ‰§è¡Œ <code>b = 2</code> ä½†æ˜¯åœ¨ g ä¸­æˆ‘ä»¬åªçœ‹åˆ°äº† b = 2 å…·ä½“ä»€ä¹ˆæƒ…å†µå¯èƒ½ä¼šå¯¼è‡´è¿™ä¸ªå‘¢ï¼Ÿä¸è¦ç€æ€¥ï¼Œæˆ‘ä»¬åé¢è¿˜ä¼šè¯´åˆ°</p><h4 id="ç¼–è¯‘å™¨é‡æ’"><a href="#ç¼–è¯‘å™¨é‡æ’" class="headerlink" title="ç¼–è¯‘å™¨é‡æ’"></a>ç¼–è¯‘å™¨é‡æ’</h4><p>æˆ‘ä»¬æ¥çœ‹å‚è€ƒæ–‡ç« ä¸­çš„ä¸€ä¸ªç¼–è¯‘å™¨é‡æ’ä¾‹å­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">X = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i in <span class="hljs-keyword">range</span>(<span class="hljs-number">100</span>):<br>    X = <span class="hljs-number">1</span><br>    <span class="hljs-built_in">print</span> X<br></code></pre></td></tr></table></figure><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼ŒX = 1 åœ¨ for å¾ªç¯å†…éƒ¨è¢«é‡å¤èµ‹å€¼äº† 100 æ¬¡ï¼Œè¿™å®Œå…¨æ²¡æœ‰å¿…è¦ï¼Œäºæ˜¯èªæ˜çš„ç¼–è¯‘å™¨å°±ä¼šå¸®åŠ©æˆ‘ä»¬ä¼˜åŒ–æˆä¸‹é¢çš„æ ·å­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">X = <span class="hljs-number">1</span><br><span class="hljs-keyword">for</span> i in <span class="hljs-keyword">range</span>(<span class="hljs-number">100</span>):<br>    <span class="hljs-built_in">print</span> X<br></code></pre></td></tr></table></figure><p>å®Œç¾ï¼Œåœ¨å•ä¸ª goroutine ä¸­å¹¶ä¸ä¼šæ”¹å˜ç¨‹åºçš„æ‰§è¡Œï¼Œè¿™æ—¶å€™åŒæ ·ä¼šè¾“å‡º 100 æ¬¡ 1 ï¼Œå¹¶ä¸”å‡å°‘äº† 100 æ¬¡èµ‹å€¼æ“ä½œã€‚<br>ä½†æ˜¯ï¼Œå¦‚æœä¸æ­¤åŒæ—¶æˆ‘ä»¬å­˜åœ¨ä¸€ä¸ªå¦å¤–ä¸€ä¸ª goroutine å¹²äº†å¦å¤–ä¸€ä¸ªäº‹æƒ… X = 0 é‚£ä¹ˆï¼Œè¿™ä¸ªè¾“å‡ºå°±å˜çš„ä¸å¯é¢„çŸ¥äº†ï¼Œå°±æœ‰å¯èƒ½æ˜¯ 1001111101â€¦ è¿™ç§ï¼Œæ‰€ä»¥å›åˆ°åˆšå¼€å§‹çš„å¿ å‘Šï¼š<strong>è¿™ä¸ªæ˜¯è¯´å¦‚æœä½ çš„ç¨‹åºå­˜åœ¨å¤šä¸ª goroutine å»è®¿é—®æ•°æ®çš„æ—¶å€™ï¼Œå¿…é¡»åºåˆ—åŒ–çš„è®¿é—®</strong></p><h4 id="happens-before-å®šä¹‰"><a href="#happens-before-å®šä¹‰" class="headerlink" title="happens before å®šä¹‰"></a>happens before å®šä¹‰</h4><blockquote><p>To specify the requirements of reads and writes, we define happens before, a partial order on the execution of memory operations in a Go program. If event <code>e1</code> happens before event <code>e2</code>, then we say that <code>e2</code> happens after <code>e1</code>. Also, if <code>e1</code> does not happen before <code>e2</code> and does not happen after <code>e2</code>, then we say that <code>e1</code> and <code>e2</code> happen concurrently.</p></blockquote><p>è¿™æ˜¯ Happens Before çš„å®šä¹‰ï¼Œå¦‚æœ <code>e1</code> å‘ç”Ÿåœ¨ <code>e2</code> ä¹‹å‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯´ <code>e2</code> å‘ç”Ÿåœ¨ <code>e1</code> ä¹‹åï¼Œå¦‚æœ <code>e1</code> æ—¢ä¸åœ¨ <code>e2</code> å‰ï¼Œä¹Ÿä¸åœ¨ <code>e2</code> ä¹‹åï¼Œé‚£æˆ‘ä»¬å°±è¯´è¿™ä¿©æ˜¯å¹¶å‘çš„</p><blockquote><p>Within a single goroutine, the happens-before order is the order expressed by the program.</p></blockquote><p>è¿™å°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„ï¼Œåœ¨å•ä¸ª goroutine å½“ä¸­ï¼Œäº‹ä»¶å‘ç”Ÿçš„é¡ºåºï¼Œå°±æ˜¯ç¨‹åºæ‰€è¡¨è¾¾çš„é¡ºåº</p><blockquote><p>A read r of a variable <code>v</code> is allowed to observe a write <code>w</code> to <code>v</code> if both of the following hold:</p><ol><li>r does not happen before <code>w</code>.</li><li>There is no other write <code>w&#39;</code> to <code>v</code> that happens after w but before <code>r</code>.</li></ol></blockquote><p>å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªå˜é‡ <code>v</code>ï¼Œç„¶ååªè¦æ»¡è¶³ä¸‹é¢çš„ä¸¤ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆè¯»å–æ“ä½œ <code>r</code> å°±å¯ä»¥å¯¹è¿™ä¸ªå˜é‡ <code>v</code> çš„å†™å…¥æ“ä½œ <code>w</code> è¿›è¡Œç›‘æµ‹</p><ol><li>è¯»å–æ“ä½œ <code>v</code> å‘ç”Ÿåœ¨å†™å…¥æ“ä½œ <code>w</code> ä¹‹å</li><li>å¹¶ä¸”åœ¨ <code>w</code> ä¹‹åï¼Œ<code>r</code> ä¹‹å‰æ²¡æœ‰å…¶ä»–å¯¹ <code>v</code> çš„å†™å…¥æ“ä½œ <code>w&#39;</code></li></ol><p>æ³¨æ„è¿™é‡Œè¯´çš„åªæ˜¯è¯»å–æ“ä½œ r å¯ä»¥å¯¹ w è¿›è¡Œç›‘æµ‹ï¼Œä½†æ˜¯èƒ½ä¸èƒ½è¯»åˆ°å‘¢ï¼Œå¯èƒ½å¯ä»¥ä¹Ÿå¯èƒ½ä¸è¡Œ</p><blockquote><p>To guarantee that a read <code>r</code> of a variable <code>v</code> observes a particular write <code>w</code> to <code>v</code>, ensure that <code>w</code> is the only write <code>r</code> is allowed to observe. That is, <code>r</code> is guaranteed to observe <code>w</code> if both of the following hold:</p><ol><li><code>w</code> happens before <code>r</code>.</li><li>Any other write to the shared variable <code>v</code> either happens before <code>w</code> or after <code>r</code>.</li></ol></blockquote><p>ä¸ºç¡®ä¿å¯¹å˜é‡ <code>v</code> çš„è¯»å–æ“ä½œ <code>r</code> èƒ½å¤Ÿç›‘æµ‹åˆ°ç‰¹å®šçš„å¯¹ <code>v</code> è¿›è¡Œå†™å…¥çš„æ“ä½œ <code>w</code>ï¼Œéœ€ç¡®ä¿ <code>w</code> æ˜¯å”¯ä¸€å…è®¸è¢« <code>r</code> ç›‘æµ‹çš„å†™å…¥æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè‹¥ä»¥ä¸‹æ¡ä»¶å‡æˆç«‹ï¼Œåˆ™ <code>r</code> èƒ½ä¿è¯ç›‘æµ‹åˆ° <code>w</code>ï¼š</p><ol><li><code>w</code> å‘ç”Ÿåœ¨ <code>r</code> ä¹‹å‰ã€‚</li><li>å¯¹å…±äº«å˜é‡ <code>v</code> çš„å…¶å®ƒä»»ä½•å†™å…¥æ“ä½œéƒ½åªèƒ½å‘ç”Ÿåœ¨ <code>w</code> ä¹‹å‰æˆ– <code>r</code> ä¹‹åã€‚</li></ol><p>è¿™å¯¹æ¡ä»¶çš„è¦æ±‚æ¯”ç¬¬ä¸€ä¸ªæ¡ä»¶æ›´å¼ºï¼Œå®ƒéœ€è¦ç¡®ä¿æ²¡æœ‰å…¶å®ƒå†™å…¥æ“ä½œä¸ <code>w</code> æˆ– <code>r</code> å¹¶å‘ã€‚<br>åœ¨å•ä¸ª goroutine å½“ä¸­è¿™ä¸¤ä¸ªæ¡ä»¶æ˜¯ç­‰ä»·çš„ï¼Œå› ä¸ºå•ä¸ª goroutine ä¸­ä¸å­˜åœ¨å¹¶å‘ï¼Œåœ¨å¤šä¸ª goroutine ä¸­å°±å¿…é¡»ä½¿ç”¨åŒæ­¥è¯­ä¹‰æ¥ç¡®ä¿é¡ºåºï¼Œè¿™æ ·æ‰èƒ½åˆ°ä¿è¯èƒ½å¤Ÿç›‘æµ‹åˆ°é¢„æœŸçš„å†™å…¥<br><strong>å•ä¸ª goroutine çš„æƒ…å†µ</strong>ï¼š<br>æˆ‘ä»¬å¯ä»¥å‘ç°åœ¨å•ä¸ª goroutine å½“ä¸­ï¼Œè¯»å–æ“ä½œ r æ€»æ˜¯å¯ä»¥è¯»å–åˆ°ä¸Šä¸€æ¬¡ w å†™å…¥çš„å€¼çš„<br><img src="https://lailin.xyz/images/1608372439492-359ad5bf-1b06-4f4f-ae77-84e96d9f6a7f.png" srcset="/img/loading.gif" alt="image.png"><br><strong>å¤šä¸ª goroutine çš„æƒ…å†µ</strong>:<br>ä½†æ˜¯å­˜åœ¨å¤šä¸ª goroutine çš„æ—¶å€™è¿™ä¸ªå°±ä¸ä¸€å®šäº†ï¼Œr0 è¯»åˆ°çš„æ˜¯ å“ªä¸€æ¬¡å†™å…¥çš„å€¼å‘¢ï¼Ÿå¦‚æœçœ‹å›¾çš„è¯åƒæ˜¯ w4 çš„ï¼Œä½†å…¶å®ä¸ä¸€å®šï¼Œå› ä¸ºå›¾ä¸­çš„ä¸¤ä¸ª goroutine æ‰€è¡¨è¾¾çš„æ—¶é—´ç»´åº¦å¯èƒ½æ˜¯ä¸ä¸€è‡´çš„ï¼Œæ‰€ä»¥ r0 å¯èƒ½è¯»åˆ°çš„æ˜¯ w0 w3 w4 ç”šè‡³æ˜¯ w5 çš„ç»“æœï¼Œå½“ç„¶æŒ‰ç…§æˆ‘ä»¬å‰é¢è¯´çš„ç†è®ºï¼Œè¯»åˆ°çš„ä¸å¯èƒ½æ˜¯ w1 çš„ç»“æœçš„<br><img src="https://lailin.xyz/images/1608372753766-f3b66fe5-ac34-4f5e-a1b2-c74e7d3dfbc9.png" srcset="/img/loading.gif" alt="image.png"><br><strong>æ·»åŠ ä¸€äº›åŒæ­¥ç‚¹</strong><br>å¦‚ä¸‹å›¾æ‰€ç¤ºæˆ‘ä»¬é€šè¿‡ sync åŒ…ä¸­çš„ä¸€äº›åŒæ­¥è¯­ä¹‰æˆ–è€…æ˜¯ channel ä¸ºå¤šä¸ª goroutine åŠ å…¥äº† åŒæ­¥ç‚¹ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å¯¹äº r1 è€Œè¨€ï¼Œä»–å°±æ˜¯æ™šäº w4 å¹¶ä¸”æ—©äº w1 å’Œ w5 æ‰§è¡Œçš„ï¼Œæ‰€ä»¥å®ƒè¯»å–åˆ°çš„æ˜¯å†™å…¥æ“ä½œæ˜¯å¯ä»¥ç¡®å®šçš„ï¼Œæ˜¯ w4<br><img src="https://lailin.xyz/images/1608373281116-271c756e-386e-490b-aa7b-0fb2b741ed40.png" srcset="/img/loading.gif" alt="image.png"></p><blockquote><p>The initialization of variable <code>v</code> with the zero value for <code>v</code>â€˜s type behaves as a write in the memory model.</p></blockquote><p>ä»¥å˜é‡ <code>v</code> æ‰€å±ç±»å‹çš„é›¶å€¼æ¥å¯¹ <code>v</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œå…¶è¡¨ç°å¦‚åŒåœ¨å†…å­˜æ¨¡å‹ä¸­è¿›è¡Œçš„å†™å…¥æ“ä½œã€‚</p><h4 id="æœºå™¨å­—"><a href="#æœºå™¨å­—" class="headerlink" title="æœºå™¨å­—"></a>æœºå™¨å­—</h4><blockquote><p>Reads and writes of values larger than a single machine word behave as multiple machine-word-sized operations in an unspecified order.</p></blockquote><p>å¯¹å¤§äºå•ä¸ªæœºå™¨å­—çš„å€¼è¿›è¡Œè¯»å–å’Œå†™å…¥ï¼Œå…¶è¡¨ç°å¦‚åŒä»¥ä¸ç¡®å®šçš„é¡ºåºå¯¹å¤šä¸ªæœºå™¨å­—å¤§å°çš„å€¼è¿›è¡Œæ“ä½œã€‚è¦ç†è§£è¿™ä¸ªæˆ‘ä»¬é¦–å…ˆè¦ç†è§£ä»€ä¹ˆæ˜¯æœºå™¨å­—ã€‚<br>æˆ‘ä»¬ç°åœ¨å¸¸è§çš„è¿˜æœ‰ 32 ä½ç³»ç»Ÿå’Œ 64 ä½çš„ç³»ç»Ÿï¼Œcpu åœ¨æ‰§è¡Œä¸€æ¡æŒ‡ä»¤çš„æ—¶å€™å¯¹äºå•ä¸ªæœºå™¨å­—é•¿çš„çš„æ•°æ®çš„å†™å…¥å¯ä»¥ä¿è¯æ˜¯åŸå­çš„ï¼Œå¯¹äº 32 ä½çš„å°±æ˜¯ 4 ä¸ªå­—èŠ‚ï¼Œå¯¹äº 64 ä½çš„å°±æ˜¯ 8 ä¸ªå­—èŠ‚ï¼Œå¯¹äºåœ¨ 32 ä½æƒ…å†µä¸‹å»å†™å…¥ä¸€ä¸ª 8 å­—èŠ‚çš„æ•°æ®æ—¶å°±éœ€è¦æ‰§è¡Œä¸¤æ¬¡å†™å…¥æ“ä½œï¼Œè¿™ä¸¤æ¬¡æ“ä½œä¹‹é—´å°±æ²¡æœ‰åŸå­æ€§ï¼Œé‚£å°±å¯èƒ½å‡ºç°å…ˆå†™å…¥ååŠéƒ¨åˆ†çš„æ•°æ®å†å†™å…¥å‰åŠéƒ¨åˆ†ï¼Œæˆ–è€…æ˜¯å†™å…¥äº†ä¸€åŠæ•°æ®ç„¶åå†™å…¥å¤±è´¥çš„æƒ…å†µã€‚<br>ä¹Ÿå°±æ˜¯è¯´è™½ç„¶æœ‰æ—¶å€™æˆ‘ä»¬çœ‹ç€ä»…ä»…åªåšäº†ä¸€æ¬¡å†™å…¥ä½†æ˜¯è¿˜æ˜¯ä¼šæœ‰å¹¶å‘é—®é¢˜ï¼Œå› ä¸ºå®ƒæœ¬èº«ä¸æ˜¯åŸå­çš„</p><h3 id="åŒæ­¥"><a href="#åŒæ­¥" class="headerlink" title="åŒæ­¥"></a>åŒæ­¥</h3><h4 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h4><blockquote><p>Program initialization runs in a single goroutine, but that goroutine may create other goroutines, which run concurrently.<br>If a package <code>p</code> imports package <code>q</code>, the completion of <code>q</code>â€˜s <code>init</code> functions happens before the start of any of <code>p</code>â€˜s.<br>The start of the function <code>main.main</code> happens after all <code>init</code> functions have finished.</p></blockquote><ul><li>ç¨‹åºçš„åˆå§‹åŒ–è¿è¡Œåœ¨å•ä¸ª goroutine ä¸­ï¼Œä½†è¯¥ goroutine å¯èƒ½ä¼šåˆ›å»ºå…¶å®ƒå¹¶å‘è¿è¡Œçš„ goroutine</li><li>è‹¥åŒ… p å¯¼å…¥äº†åŒ… qï¼Œåˆ™ q çš„ init å‡½æ•°ä¼šåœ¨ p çš„ä»»ä½•å‡½æ•°å¯åŠ¨å‰å®Œæˆã€‚</li><li>å‡½æ•° main.main ä¼šåœ¨æ‰€æœ‰çš„ init å‡½æ•°ç»“æŸåå¯åŠ¨ã€‚<div style="background:#fffbe6;padding:10px;border:1px solid #c3c3c3;border-radius:5px;margin-bottom:5px">æ³¨æ„: åœ¨å®é™…çš„åº”ç”¨ä»£ç ä¸­ä¸è¦éšå¼çš„ä¾èµ–è¿™ä¸ªå¯åŠ¨é¡ºåº</div></li></ul><h4 id="goroutine-çš„åˆ›å»º"><a href="#goroutine-çš„åˆ›å»º" class="headerlink" title="goroutine çš„åˆ›å»º"></a>goroutine çš„åˆ›å»º</h4><blockquote><p>The <code>go</code> statement that starts a new goroutine happens before the goroutineâ€™s execution begins.</p></blockquote><p><code>go</code> è¯­å¥ä¼šåœ¨å½“å‰ goroutine å¼€å§‹æ‰§è¡Œå‰å¯åŠ¨æ–°çš„ goroutine</p><h4 id="goroutine-çš„é”€æ¯"><a href="#goroutine-çš„é”€æ¯" class="headerlink" title="goroutine çš„é”€æ¯"></a>goroutine çš„é”€æ¯</h4><blockquote><p>The exit of a goroutine is not guaranteed to happen before any event in the programã€‚</p></blockquote><p>goroutine æ— æ³•ç¡®ä¿åœ¨ç¨‹åºä¸­çš„ä»»ä½•äº‹ä»¶å‘ç”Ÿä¹‹å‰é€€å‡º</p><p>æ³¨æ„ <a target="_blank" rel="noopener" href="https://golang.org/ref/mem">ã€ŠThe Go Memory Modelã€‹</a>åŸæ–‡ä¸­è¿˜æœ‰å…³äº channelï¼Œ é”ç›¸å…³çš„é˜è¿°ï¼Œå› ä¸ºç¯‡å¹…åŸå› åœ¨æœ¬æ–‡ä¸­å°±ä¸å¤šè®²äº†ï¼Œåé¢æˆ‘ä»¬è¿˜æœ‰å•ç‹¬çš„æ–‡ç« è¯¦ç»†è®² channel å’Œ é” ç›¸å…³çš„ä½¿ç”¨ï¼Œåœ¨å¼ºè°ƒä¸€éï¼ŒåŸæ–‡ä¸€å®šè¦å¤šçœ‹å‡ é</p><h2 id="å†…å­˜é‡æ’"><a href="#å†…å­˜é‡æ’" class="headerlink" title="å†…å­˜é‡æ’"></a>å†…å­˜é‡æ’</h2><p>åœ¨ä¸Šé¢æˆ‘ä»¬è®²åˆ°äº†ç¼–è¯‘å™¨é‡æ’ï¼Œä»¥åŠåœ¨æœ€å¼€å§‹çš„ä¾‹å­ä¸­æˆ‘ä»¬æåˆ°äº†å¯èƒ½ä¼šå­˜åœ¨ <code>2 0</code> è¿™ä¸ªç­”æ¡ˆï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆã€‚å¦‚æœå¤§å®¶è´­ä¹°ç”µè„‘çš„æ—¶å€™æœ‰å»å¯¹æ¯” cpu çš„è¯åº”è¯¥å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ª cpu éƒ½ä¼šå†™ä¸€ä¸‹ä¸€çº§ç¼“å­˜ï¼ŒäºŒçº§ç¼“å­˜ï¼Œä¸‰çº§ç¼“å­˜çš„å¤§å°ï¼Œè¿™ä¸ªç¼“å­˜å°±æ˜¯è¿™é‡Œçš„ä¸€ä¸ªå…³é”®ç‚¹ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œè¶Šå¾€ä¸‹ç¼“å­˜çš„å¤§å°è¶Šå¤§é€Ÿåº¦è¶Šæ…¢ï¼Œè¿™æ˜¯ cpu ä¸ºäº†æé«˜æ‰§è¡Œé€Ÿåº¦åšçš„ç¼“å­˜ä½“ç³»ï¼Œå°±åƒæˆ‘ä»¬å¹³æ—¶åœ¨åº”ç”¨å½“ä¸­å¼•å…¥ redis ä½œä¸ºç¼“å­˜ç±»ä¼¼ï¼Œéƒ½æ˜¯ä¸ºäº†åŠ é€Ÿã€‚åŒæ—¶è¿™å°±ä¼šå¸¦æ¥ä¸€äº›æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚<br><img src="https://lailin.xyz/images/1608385154319-591875fe-fc6f-457f-8fd0-966b8e603310.png" srcset="/img/loading.gif" alt="02_Goè¿›é˜¶03_blog_img.drawio-ç¬¬ 4 é¡µ.png"><br><strong>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š</strong></p><ol><li>C1 æ‰§è¡Œ a = 1 å°† store buffer ä¸­ a çš„å€¼å†™ä¸º 1</li><li>C1 æ‰§è¡Œ b = 2 å°† store buffer ä¸­ b çš„å€¼å†™ä¸º 2, ç„¶åç”±äºæŸç§åŸå› å°† b çš„å€¼å†™å…¥åˆ°äº†å†…å­˜ä¸­</li><li>C2 å»è¯»å– b çš„å€¼ï¼Œå‘ç°ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œå°±å»å†…å­˜ä¸­è¯»ï¼Œè¿™æ—¶å€™ print å‡ºæ¥ 2</li><li>C2 å»è¯»å– a çš„å€¼ï¼Œå‘ç°ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œå°±å»å†…å­˜ä¸­è¯»ï¼Œè¿™æ—¶å€™ print å‡ºæ¥ 0</li></ol><p>äº†è§£åˆ°è¿™é‡Œä¹‹åå¯èƒ½ä¼šæœ‰ä¸€äº›ç–‘é—®ï¼Œæ—¢ç„¶ä¼šå­˜åœ¨è¿™ç§ä¸ç¡®å®šæ€§ï¼Œæˆ‘ä»¬æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å»ä¿è¯ä¸€è‡´å‘¢ï¼ŸCPU çš„ä¸€è‡´æ€§å…·ä½“åˆæ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ<br>ä¿è¯ä¸€è‡´ä»ç¨‹åºä¸Šæ¥è®²æˆ‘ä»¬å¿…é¡»ä½¿ç”¨åŒæ­¥è¯­ä¹‰çš„å·¥å…·ç¡®ä¿ä¸€è‡´ï¼Œå¦‚æœæ·±å…¥åˆ°åº•å±‚çš„è¯å°±æ˜¯ä½¿ç”¨ cpu æä¾›çš„å†…å­˜å±éšœå‘½ä»¤ï¼Œä¿è¯æ‰€æœ‰å¯¹å†…å­˜çš„æ“ä½œéƒ½å¿…é¡»è¦â€œæ‰©æ•£â€åˆ° memory ä¹‹åæ‰èƒ½ç»§ç»­æ‰§è¡Œå…¶ä»–å¯¹ memory çš„æ“ä½œã€‚<br>CPU ä¸€è‡´æ€§çš„åŸç†å»ºè®®çœ‹ä¸€ä¸‹ MSI(E)åè®®çš„å®ç°ï¼Œæˆ‘åœ¨å‚è€ƒæ–‡çŒ®ä¸­åˆ—å‡ºçš„æœ€åä¸¤ç¯‡æ–‡ç« è®²çš„å·²ç»æ¯”è¾ƒé€šä¿—æ˜“æ‡‚äº†ï¼Œåœ¨æœ¬æ–‡å°±ä¸å†å™è¿°</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><strong>æ€»ç»“</strong></h2><ul><li>Go çš„å¹¶å‘ç¼–ç¨‹éå¸¸çš„ç®€å•ï¼Œåªéœ€è¦ä½¿ç”¨ go func å°±èƒ½å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹ï¼Œä½†æ˜¯å¹¶å‘ç¼–ç¨‹æœ¬èº«å°±æ˜¯å¾ˆå®¹æ˜“å‡ºç° bug çš„ï¼Œè€Œä¸”ç”±äºå¹¶å‘å¯¼è‡´çš„ bug è¿˜ä¸å¤ªå®¹æ˜“å‘ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å†™å¹¶å‘é€»è¾‘çš„æ—¶å€™ä¸€å®šè¦éå¸¸å°å¿ƒï¼Œç”¨å®˜æ–¹çš„ä¸€å¥è¯å°±æ˜¯<strong>ä½¿ç”¨æ˜¾ç¤ºçš„åŒæ­¥</strong></li><li>æœ¬æ–‡æ›´å¤šæ˜¯æŠ›ç –å¼•ç‰è¿™é‡Œé¢æåˆ°äº†å¾ˆå¤šæœ‰æ„æ€çš„åè¯éƒ½å€¼å¾—å¥½å¥½ç ”ç©¶</li></ul><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ul><li><a target="_blank" rel="noopener" href="https://golang.org/ref/mem">https://golang.org/ref/mem</a> å®˜æ–¹æ–‡æ¡£ä¸€å®šè¦å¤šè¯»å‡ é</li><li><a target="_blank" rel="noopener" href="https://go-zh.org/ref/mem">https://go-zh.org/ref/mem</a> å®˜æ–¹æ–‡æ¡£çš„ä¸­æ–‡ç¿»è¯‘ï¼Œè‹±æ–‡æ¯”è¾ƒåƒåŠ›å¯ä»¥çœ‹è¿™ç¯‡</li><li><a target="_blank" rel="noopener" href="https://qcrao.com/2019/06/17/cch-says-memory-reorder/">https://qcrao.com/2019/06/17/cch-says-memory-reorder/</a></li><li><a target="_blank" rel="noopener" href="https://cch123.github.io/ooo/">https://cch123.github.io/ooo/</a></li><li><a target="_blank" rel="noopener" href="https://www.cs.utexas.edu/~bornholt/post/memory-models.html">https://www.cs.utexas.edu/~bornholt/post/memory-models.html</a></li><li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%9C%BA%E5%99%A8%E5%AD%97%E9%95%BF">https://baike.baidu.com/item/%E6%9C%BA%E5%99%A8%E5%AD%97%E9%95%BF</a></li><li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AD%97_(%E8%AE%A1%E7%AE%97%E6%9C%BA">https://zh.wikipedia.org/wiki/%E5%AD%97_(%E8%AE%A1%E7%AE%97%E6%9C%BA)</a>&gt;)</li><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/65245043">https://zhuanlan.zhihu.com/p/65245043</a></li><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/94811032">https://zhuanlan.zhihu.com/p/94811032</a></li></ul><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°"><a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°</h2><p>çœ‹åˆ°è¿™é‡Œäº†è¿˜ä¸å…³æ³¨ç‚¹èµèµ°ä¸€æ³¢</p><ul><li><a href="https://lailin.xyz">åšå®¢</a> å¯ä»¥è®¢é˜… RSS</li><li><a target="_blank" rel="noopener" href="https://github.com/mohuishou">Github</a> Follow me</li><li><a target="_blank" rel="noopener" href="https://www.zhihu.com/people/mo-hui-shou-76">çŸ¥ä¹</a> å…³æ³¨è´¦å·ï¼Œé¡ºä¾¿ç‚¹ä¸ª ğŸ‘</li><li><a target="_blank" rel="noopener" href="https://toutiao.io/subjects/387401?f=new">å¼€å‘è€…å¤´æ¡</a> è®¢é˜…è®¢é˜…å·ï¼Œé¡ºä¾¿ç‚¹ä¸ª ğŸ‘</li></ul><div><h2 id="ç›¸å…³æ¨è">ç›¸å…³æ¨è</h2><ul><li><a href="https://lailin.xyz/post/go-training-week4-clean-arch.html">Week04: Goå·¥ç¨‹åŒ–(ä¸€) æ¶æ„æ•´æ´ä¹‹é“é˜…è¯»ç¬”è®°</a></li><li><a href="https://lailin.xyz/post/go-training-week3-sum.html">Week03: Goå¹¶å‘ç¼–ç¨‹(åä¸€) æ€»ç»“</a></li><li><a href="https://lailin.xyz/post/go-training-week3-channel.html">Week03: Goå¹¶å‘ç¼–ç¨‹(å) æ·±å…¥ç†è§£ Channel</a></li></ul></div></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">Goè¿›é˜¶è®­ç»ƒè¥</a> <a class="hover-with-bg" href="/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/Week03-Go-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Week03: Go å¹¶å‘ç¼–ç¨‹</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">å­¦ä¹ ç¬”è®°</a> <a class="hover-with-bg" href="/tags/Go/">Go</a> <a class="hover-with-bg" href="/tags/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">Goè¿›é˜¶è®­ç»ƒè¥</a> <a class="hover-with-bg" href="/tags/%E5%B9%B6%E5%8F%91/">å¹¶å‘</a></div></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a>ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œç¦æ­¢å…¨æ–‡è½¬è½½</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/post/go-training-week3-data-race.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Goå¹¶å‘ç¼–ç¨‹(ä¸‰) data race</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></article><article class="post-next col-6"><a href="/post/go-training-week3-goroutine.html"><span class="hidden-mobile">Goå¹¶å‘ç¼–ç¨‹(ä¸€) goroutine</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><script type="text/javascript">Fluid.utils.waitElementVisible("comments",(function(){var t=document.documentElement.getAttribute("data-user-color-scheme");t="dark"===t?"github-dark":"github-light",window.UtterancesThemeLight="github-light",window.UtterancesThemeDark="github-dark";var e=document.createElement("script");e.setAttribute("src","https://utteranc.es/client.js"),e.setAttribute("repo","scuplus/blogComment"),e.setAttribute("issue-term","pathname"),e.setAttribute("label","utterances"),e.setAttribute("theme",t),e.setAttribute("crossorigin","anonymous"),document.getElementById("comments").appendChild(e)}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><div class="col-lg-7 mx-auto nopadding-x-md"><div class="container custom mx-auto"><script>!function(e,s,p,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var n,u=s.getElementsByTagName(p)[0];(n=s.createElement(p)).id="webpushr-jssdk",n.async=1,n.src="https://cdn.webpushr.com/app.min.js",u.parentNode.appendChild(n)}}(window,document,"script"),webpushr("setup",{key:"BBkZb7rpvsVqVNkORXD9T9T93MJodtpNJD5c1f2HE_XsED3r94An3CKObdyTJ6ub3ARm9LIdeDCVzKLBsK760NM"})</script></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/js/local-search.js"></script><script>document.querySelector("#local-search-input").onclick=function(){searchFunc("/local-search.xml","local-search-input","local-search-result"),this.onclick=null}</script><script defer>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-137859264-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script src="/js/boot.js"></script></body></html>