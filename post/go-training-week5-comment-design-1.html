<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/icons/touch-icon-apple.png"><link rel="icon" type="image/png" href="/icons/favicon-32x32.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content="mohuishou 的 技术博客, 关注云原生, Go, K8s, Docker, 微服务等技术"><meta name="author" content="Mohuishou"><meta name="keywords" content="Go,Docker,PHP,学习笔记,Go,Go进阶训练营,架构设计,Go进阶训练营,Week05: 评论系统架构设计"><title>评论系统架构设计（一）功能拆分&amp;架构设计 - Mohuishou</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main-8c4c5e426918ae095492d8a940e57fef.css"><link rel="stylesheet" href="/assets/css/custom-6db6671dbe84a966b9771f9ad2d73786.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"lailin.xyz",root:"/",version:"1.8.7",typing:{enable:!1,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,onlypost:!1},web_analytics:{enable:!0,baidu:null,google:"UA-137859264-1",gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}}}</script><script src="/js/utils-5ecdced2f65030c3508cf0b3db78f4ad.js"></script><script src="/js/color-schema-4678c2299d6eeb96e23435ea339c9331.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>mohuishou</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/"><i class="iconfont icon-category-fill"></i> Go 进阶训练营(更新中)</a></li><li class="nav-item"><a class="nav-link" href="/post/go-design-pattern.html"><i class="iconfont icon-notebook"></i> Go 设计模式</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 更多</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/links/"><i class="iconfont icon-link-fill"></i> 友链 </a><a class="dropdown-item" href="/atom.xml"><i class="iconfont icon-rss"></i> rss </a><a class="dropdown-item" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></div></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/bg.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="评论系统架构设计（一）功能拆分&架构设计">评论系统架构设计（一）功能拆分&架构设计</span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-03-14 18:08" pubdate>2021年3月14日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.8k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 29 分钟</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"><div class="sidebar"><p class="sidebar-header">Go进阶训练营</p><div class="sidebar-body" id="sidebar-body"><ol class="sidebar-list sidebar-list-1"><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckkm23xho0000m4t51q602czj").classList.toggle("sidebar-is-collapsed")'>Week01: 微服务</a><ol id="sidebar-ckkm23xho0000m4t51q602czj" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-01.html">微服务(一) 微服务概览</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-02.html">微服务(二) 服务发现&amp;多租户</a></li></ol></li><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckkm23ykh0003m4t53mln1w0n").classList.toggle("sidebar-is-collapsed")'>Week02: Go错误处理</a><ol id="sidebar-ckkm23ykh0003m4t53mln1w0n" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-03.html">Go错误处理最佳实践</a></li></ol></li><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckkm2667n000pm4t52z016wn0").classList.toggle("sidebar-is-collapsed")'>Week03: Go 并发编程</a><ol id="sidebar-ckkm2667n000pm4t52z016wn0" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-goroutine.html">Go并发编程(一) goroutine</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-go-memory-model.html">Go并发编程(二) Go 内存模型</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-data-race.html">Go并发编程(三) data race</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-sync.html">Go并发编程(四) 深入理解 Mutex</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-waitgroup.html">Go并发编程(六) 深入理解 WaitGroup</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-atomic.html">Go并发编程(五) 深入理解 sync/atomic</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-errgroup.html">Go并发编程(七) 深入理解 errgroup</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-once.html">Go并发编程(八) 深入理解 sync.Once</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-context.html">Go并发编程(九) 深入理解 Context</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-channel.html">Go并发编程(十) 深入理解 Channel</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-sum.html">Go并发编程(十一) 总结</a></li></ol></li><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckkm23zra000im4t5en8m0qy9").classList.toggle("sidebar-is-collapsed")'>Week04: Go 工程化</a><ol id="sidebar-ckkm23zra000im4t5en8m0qy9" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-clean-arch.html">Go工程化(一) 架构整洁之道阅读笔记</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-project-layout.html">Go工程化(二) 项目目录结构</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-wire.html">Go工程化(三) 依赖注入框架 wire</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-api-design.html">Go工程化(四) API 设计上: 项目结构 &amp; 设计</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-protoc-gen-go-gin.html">Go工程化(五) API 设计下: 基于 protobuf 自动生成 gin 代码</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-config.html">Go工程化(六) 配置管理</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-go-module.html">Go工程化(七) Go Module</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-unit-test.html">Go工程化(八) 单元测试</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-practice.html">Go工程化(九) 项目重构实践</a></li></ol></li><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckmbvf85u0004maok7enk5lqb").classList.toggle("sidebar-is-collapsed")'>Week05: 评论系统架构设计</a><ol id="sidebar-ckmbvf85u0004maok7enk5lqb" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item is-active-li"><a class="sidebar-link sidebar-active-link" href="/post/go-training-week5-comment-design-1.html">评论系统架构设计（一）功能拆分&amp;架构设计</a></li></ol></li></ol></div></div></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">评论系统架构设计（一）功能拆分&amp;架构设计</h1><div class="markdown-body"><h2 id="序"><a href="#序" class="headerlink" title="序"></a>序</h2><p>本系列为 <a target="_blank" rel="noopener" href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go 进阶训练营</a> 笔记，预计 2021Q2 完成更新，访问 <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">博客: Go 进阶训练营</a> 即可查看当前更新进度，部分文章篇幅较长，使用 PC 大屏浏览体验更佳。<strong>3 月进度: 07/15</strong> 3 月开始会尝试爆更模式，争取做到两天更新一篇文章，如果感兴趣可以拉到文章最下方获取关注方式。</p><p>时间兜兜转转终于复习到 Week05 了，训练营第 0 期也结束了，第一期也马上开始了，个人感觉整体来看还是比较值的，因为在这里我们不仅能学到 Go 的知识其实也有很多架构设计，学习方法论，以及一些职场的话题。接下来我们就来到本次课程的第一个完整案例，评论系统架构设计，据 “某公司” 技术总监毛老师说这套架构设计支撑了 “某公司” 上亿 DAU 的评论系统。</p><h2 id="功能模块拆分"><a href="#功能模块拆分" class="headerlink" title="功能模块拆分"></a>功能模块拆分</h2><div style="background:#e8f7ff;padding:10px;border:1px solid #abd2da;border-radius:5px;margin-bottom:5px">经常能够看到很多产品经理和开发的段子，但是从完成一个好的产品来说的话，开发也是必须要有一些产品知识或者是说产品理念在吧，<strong>架构设计最忌讳的就是做需求的翻译机，最重要的就是要理解产品的定位以及背景，这样才能够做出最佳的设计和抽象。</strong></div><p>ok，我们来看一下一个评论系统大概都有哪些功能</p><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1615711994750-2a36e4e4-8e53-410b-9f59-901d4b6007cd.png" srcset="/img/loading.gif" alt="image.png"></p><ul><li>发布评论: 支持回复楼层、楼中楼<ul><li>现在市面的楼中楼大概一般都是两层，基本上已经不存在无限嵌套的情况存在了</li></ul></li><li>读取评论: 按照时间、热度排序</li><li>删除评论: 用户删除、作者删除</li><li>管理评论: 作者置顶、后台运营管理(搜索、删除、审核等)</li></ul><p>评论如果往小了做可能就是一个小的功能模块，例如视频的评论，但是如果往大了做可能就是一个评论平台甚至是评论中台，可以承接例如文章，文件等各种业务形态的评论，可以接入到不同的业务系统当中</p><div style="background:#e8f7ff;padding:10px;border:1px solid #abd2da;border-radius:5px;margin-bottom:5px">需要注意的是，切忌一口气吃成一个大胖子，很多做技术的同学都非常有技术追求，但是如果涉及一个非常完美但是无法落地的架构，那是没有任何意义的，因为这样的系统无法产生的任何价值，但是在设计的时候也不能把未来的路堵死了，这会导致后续大量的返工。<br>所以我们在开始行动之前需要花大量的时间进行思考真正编码的时间不到 5%（这是毛大说的，但是个人更倾向二八原则，也就是80%时间思考设计，20%时间实际编码）</div><h2 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h2><ul><li>架构设计一般习惯采用先把大块的服务画出来，然后用箭头标明数据流（毛老师）</li><li>一个好的架构设计不应该太复杂，一个好的架构设计应该可以在一个信封上画出来（jeff.dean）</li><li>尽量避免环形依赖，数据双向请求</li></ul><h3 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h3><p>架构设计还是有很多方法论的，例如 C4 什么的，这里课上没有细说，我也不扩展了，下面看一下这个评论系统的整体设计</p><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1615720341172-b40baa9d-4507-43bf-8510-77f09d2f5671.jpeg" srcset="/img/loading.gif" alt="Frame 1 (5).jpg"></p><ul><li><p><strong>envoy</strong>: 这一层是 API 网关层，这一层主要会做认证鉴权，流量管控相关的事情，是一个公共服务</p></li><li><p><strong>comment</strong>: BFF 层</p><ul><li>前端和移动端服务的 API 都由这一层提供</li><li>做服务相关的编排，例如去调用账号服务的 API 汇聚用户相关的信息，调用敏感词服务判定是否存在敏感词汇</li><li>这一层抽象将评论本身的功能呢逻辑和业务平台的业务逻辑进行的隔离</li></ul></li><li><strong>comment-service</strong>: 评论主服务<ul><li>这一层只关注评论功能的 API，例如评论的 CRUD，以及服务的稳定性和可用性</li></ul></li></ul><div style="background:#e8f7ff;padding:10px;border:1px solid #abd2da;border-radius:5px;margin-bottom:5px">罗马不是一天建成的，架构也不是一次就能设计好的，最开始其实 comment 和 comment service 是一个服务，这就导致这个服务很重，平台相关的业务逻辑与评论的本身的功能耦合在了一起导致很不好迭代，例如可能会有这种需求，新用户第一次评论就有一些积分奖励，这种气势在 comment 层做就可以了</div><ul><li>comment-job: 例如 kafka 进行削峰填谷，避免大量请求将服务打挂</li><li>comment-admin: 面向运营和管理员的服务<ul><li>这个服务和 comment service 共用存储，他们本质上其实是一个服务，但是由于运营平台的权限相对来说会比较大，如果和用户的后台服务进行耦合会有安全风险。</li><li>由于运营相关的服务的查询常常会比较复杂，这里利用 canal 定于 mysql 的 binlog 将数据写入到 es 中，然后通过 es 来进行检索。</li></ul></li></ul><div style="background:#e8f7ff;padding:10px;border:1px solid #abd2da;border-radius:5px;margin-bottom:5px">这里其实需要注意，面向运营的后台会有很多复杂的查询，如果直接在 mysql 这种数据库进行查询的话一个是效率非常的低下，即使有索引也不一定能够命中，因为查询条件往往会比较复杂。其次是如果再没有做主从的情况下，直接查询线上数据库，可能一个复杂查询就会把线上数据库查挂，风险非常的高</div><p>关于为什么有 API 网关和 BFF 层，感兴趣的话可以查看前面的这篇文章 <a href="https://lailin.xyz/post/go-training-01.html">微服务(一) 微服务概览</a></p><h3 id="comment-service"><a href="#comment-service" class="headerlink" title="comment service"></a>comment service</h3><h4 id="读数据"><a href="#读数据" class="headerlink" title="读数据"></a>读数据</h4><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1615726681372-1004d363-84f2-4f7c-a1d0-8767065748ae.jpeg" srcset="/img/loading.gif" alt="读数据-01.jpg"><br>先看一下之前犯过的一些“错”:</p><ol><li>看从 redis 当中读取缓存，发现缓存不存在</li><li>然后就从数据库中读取数据，并且重建缓存，重建缓存的时候会将所有的评论数据都捞出来</li><li>然后使用 errgroup 批量写入 redis</li></ol><p>看看有什么问题：</p><ol><li>首先是并发写入 redis 会导致用户的体验不好，因为可能会出现数据不一致的情况，例如先出现第 10 页的数据然后再出现第四页的数据，再刷新就好。</li><li>然后是捞取所有的数据的做法在数据量很小的时候还好，只要数据量稍微大一些，然后缓存抖动一下，就会触发大量的 cache miss 进行重建缓存。然后这个时候 comment service 服务就会很容易 OOM。<ol><li>这个很明显可以想到的解决方法就是，重建的时候不要捞所有的数据，只捞一部分</li><li>这么做在服务的访问量不是特别大的情况下有用，但是如果 QPS 比较高的话，还是可能会出现 OOM 的情况，因为同一时间的 cache rebuild 请求太多了</li></ol></li></ol><p>那后面是怎么解决的呢，看下面的这张图<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1615726927411-f57cd8b2-6e7f-47e4-a2d7-f0783fd16ac2.jpeg" srcset="/img/loading.gif" alt="读数据.jpg"></p><ol><li>先从 redis 中读取缓存，缓存读取失败</li><li>就从数据库中获取当前页的数据</li><li>然后发送一条回源消息到 kafka</li><li>然后 comment job 从 kafka 中消费获取到回源指令之后，从数据库读取数据</li><li>然后写入到 redis 当中</li></ol><p>我们来看问题解决了么</p><ul><li>用户读取数据不一致的问题：只要我们写入的时候不并发写就行了</li><li>OOM 的问题<ul><li>comment service 不会 OOM，它不负责重建缓存了</li><li>comment job 也不会，首先 kafka 已经帮忙挡住了峰值流量</li><li>其次我们还可以在 comment service 发送和 comment job 消费的时候加上 local cache 一段时间内只要是相同的 cache rebuild 我们就只执行一次，这样就可以避免重复执行</li><li>除此之外 comment job 是一个无状态的服务，我们可以很容易的对它进行 HPA</li></ul></li></ul><p>这么做也有一个问题就是可能短时间内 mysql 的压力会大一些，不过也有部分方法可以缓解这个问题</p><h4 id="写数据"><a href="#写数据" class="headerlink" title="写数据"></a>写数据</h4><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1615728315373-78b0fb2a-d442-4f0a-a54b-292846f05589.jpeg" srcset="/img/loading.gif" alt="写数据.jpg"></p><p>写数据其实和读数据类似，首先还是从产品逻辑上，我们认为刚发布的评论存在短时间的延迟（通常只有几 ms）是可以接受的。</p><ul><li>所以我们写数据的时候直接写到消息队列当中</li><li>然后通过 comment job 进行消费，然后写入到数据库当中</li><li>我们可以通过 hash(comment_subject) % N(partitions) 的方式来分发消息，保证每个主题的评论都在同一个 partitions 当中（因为 kafka 是全局并行局部串行的，这么做可以提高吞吐）</li></ul><h3 id="comment-admin"><a href="#comment-admin" class="headerlink" title="comment admin"></a>comment admin</h3><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1615728831427-64fcbe9a-bb87-40da-843a-2c5d30e47d27.jpeg" srcset="/img/loading.gif" alt="comment admin.jpg"></p><ul><li>mysql binlog 中的数据被 canal 中间件流式消费，获取到业务的原始 CUD 操作，需要回放录入到 es 中<ul><li>但是 es 中的数据最终是面向运营体系提供服务能力，需要检索的数据维度比较多，在入 es 前需要做一个异构的 joiner，把单表变宽预处理好 join 逻辑，然后倒入到 es 中。</li><li>例如我们数据库中可能只存了用户 id 这里就可以把用户名称头像等信息捞出来和当前评论组合在一起。</li></ul></li><li>一般来说，运营后台的检索条件都是组合的，使用 es 的好处是避免依赖 mysql 来做多条件组合检索，同时 mysql 毕竟是 oltp 面向线上联机事务处理的。通过冗余数据的方式，使用其他引擎来实现。</li></ul><h3 id="comment"><a href="#comment" class="headerlink" title="comment"></a>comment</h3><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1615729157231-9dbe9b53-bccb-426e-9766-1f9f212b357e.jpeg" srcset="/img/loading.gif" alt="comment.jpg"><br>comment 作为 BFF，是面向端，面向平台，面向业务组合的服务。所以平台扩展的能力，我们都在 comment 服务来实现，方便统一和准入平台，以统一的接口形式提供平台化的能力。</p><ul><li>依赖其他 gRPC 服务，整合统一平台测的逻辑(比如发布评论用户等级限定)。</li><li>直接向端上提供接口，提供数据的读写接口，甚至可以整合端上，提供统一的端上 SDK。</li><li>需要对非核心依赖的 gRPC 服务进行降级，当这些服务不稳定时。</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在互联网服务当中，评论算是一个很常见的服务了，但是想要做一个支撑上亿日活的评论服务还是很不容易的，这一部分的话我最大的收获可能是在不同的数据选型上，什么时候我们应该使用 redis 什么时候我们应该使用 kafka 什么时候应该使用 es，如果这是一道系统设计题让我来进行设计的话，再次之前大概率是不会想到使用 canel 订阅 MySQL 数据到 ES 的这种操作的，这是上半部分，下半部分我们会一起看看存储设计和可用性设计。</p><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ol><li><a target="_blank" rel="noopener" href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go 进阶训练营-极客时间</a></li></ol><div><h2 id="相关推荐">相关推荐</h2><ul><li><a href="https://lailin.xyz/post/go-training-week4-practice.html">Go工程化(九) 项目重构实践</a></li><li><a href="https://lailin.xyz/post/go-training-week4-unit-test.html">Go工程化(八) 单元测试</a></li><li><a href="https://lailin.xyz/post/go-training-week4-go-module.html">Go工程化(七) Go Module</a></li></ul></div></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">Go进阶训练营</a> <a class="hover-with-bg" href="/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/Week05-%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/">Week05: 评论系统架构设计</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> <a class="hover-with-bg" href="/tags/Go/">Go</a> <a class="hover-with-bg" href="/tags/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">Go进阶训练营</a> <a class="hover-with-bg" href="/tags/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/">架构设计</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a>，转载请注明出处，禁止全文转载</p><div class="post-prevnext"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/post/go-training-week4-practice.html"><span class="hidden-mobile">Go工程化(九) 项目重构实践</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><script type="text/javascript">Fluid.utils.waitElementVisible("comments",function(){var t="github-light",e="github-dark",s="dark"===(s=document.documentElement.getAttribute("data-user-color-scheme"))?e:t;window.UtterancesThemeLight=t,window.UtterancesThemeDark=e;e=document.createElement("script");e.setAttribute("src","https://utteranc.es/client.js"),e.setAttribute("repo","scuplus/blogComment"),e.setAttribute("issue-term","pathname"),e.setAttribute("label","utterances"),e.setAttribute("theme",s),e.setAttribute("crossorigin","anonymous"),document.getElementById("comments").appendChild(e)})</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div><div id="bottom"><div id="bottom-drawer" class="bottom-drawer"><div class="sidebar"><p class="sidebar-header">Go进阶训练营</p><div class="sidebar-body" id="sidebar-body"><ol class="sidebar-list sidebar-list-1"><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckkm23xho0000m4t51q602czj").classList.toggle("sidebar-is-collapsed")'>Week01: 微服务</a><ol id="sidebar-ckkm23xho0000m4t51q602czj" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-01.html">微服务(一) 微服务概览</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-02.html">微服务(二) 服务发现&amp;多租户</a></li></ol></li><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckkm23ykh0003m4t53mln1w0n").classList.toggle("sidebar-is-collapsed")'>Week02: Go错误处理</a><ol id="sidebar-ckkm23ykh0003m4t53mln1w0n" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-03.html">Go错误处理最佳实践</a></li></ol></li><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckkm2667n000pm4t52z016wn0").classList.toggle("sidebar-is-collapsed")'>Week03: Go 并发编程</a><ol id="sidebar-ckkm2667n000pm4t52z016wn0" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-goroutine.html">Go并发编程(一) goroutine</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-go-memory-model.html">Go并发编程(二) Go 内存模型</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-data-race.html">Go并发编程(三) data race</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-sync.html">Go并发编程(四) 深入理解 Mutex</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-atomic.html">Go并发编程(五) 深入理解 sync/atomic</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-waitgroup.html">Go并发编程(六) 深入理解 WaitGroup</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-errgroup.html">Go并发编程(七) 深入理解 errgroup</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-once.html">Go并发编程(八) 深入理解 sync.Once</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-context.html">Go并发编程(九) 深入理解 Context</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-channel.html">Go并发编程(十) 深入理解 Channel</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week3-sum.html">Go并发编程(十一) 总结</a></li></ol></li><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckkm23zra000im4t5en8m0qy9").classList.toggle("sidebar-is-collapsed")'>Week04: Go 工程化</a><ol id="sidebar-ckkm23zra000im4t5en8m0qy9" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-clean-arch.html">Go工程化(一) 架构整洁之道阅读笔记</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-project-layout.html">Go工程化(二) 项目目录结构</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-wire.html">Go工程化(三) 依赖注入框架 wire</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-api-design.html">Go工程化(四) API 设计上: 项目结构 &amp; 设计</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-protoc-gen-go-gin.html">Go工程化(五) API 设计下: 基于 protobuf 自动生成 gin 代码</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-config.html">Go工程化(六) 配置管理</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-go-module.html">Go工程化(七) Go Module</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-unit-test.html">Go工程化(八) 单元测试</a></li><li class="sidebar-list-item"><a class="sidebar-link" href="/post/go-training-week4-practice.html">Go工程化(九) 项目重构实践</a></li></ol></li><li class="sidebar-list-item"><a class="sidebar-title" onclick='document.querySelector("#sidebar-ckmbvf85u0004maok7enk5lqb").classList.toggle("sidebar-is-collapsed")'>Week05: 评论系统架构设计</a><ol id="sidebar-ckmbvf85u0004maok7enk5lqb" class="sidebar-list sidebar-list-2 sidebar-is-collapsible"><li class="sidebar-list-item is-active-li"><a class="sidebar-link sidebar-active-link" href="/post/go-training-week5-comment-design-1.html">评论系统架构设计（一）功能拆分&amp;架构设计</a></li></ol></li></ol></div></div><div id="toc-mobile"><div class="toc-body" id="toc-body-mobile"></div></div></div><div id="bottom-tab"><a class="sub-menu" onclick='showBottomDrawer(this,"#bottom-drawer .sidebar")'><i class="iconfont"></i> 章节 </a><a class="sub-menu" onclick='showBottomDrawer(this,"#bottom-drawer #toc-mobile")'><i class="iconfont"></i> 目录 </a><a href="#comments" class="sub-menu" onclick='showBottomDrawer(this,"#comments")'><i class="iconfont"></i> 评论</a></div></div><script>function showBottomDrawer(s,t){let e=document.querySelector("#bottom-tab");e.childNodes.forEach(t=>{t!=s&&t.classList&&t.classList.remove("active")}),"#comments"!=t&&s.classList.toggle("active");let o=document.querySelector("#bottom-drawer"),c=document.querySelector(t);o.childNodes.forEach(t=>{t!=c&&t.classList&&t.classList.remove("active")}),c.classList.toggle("active"),"#comments"!=t?(c.classList.contains("active")&&!o.classList.contains("active")&&o.classList.add("active"),!c.classList.contains("active")&&o.classList.contains("active")&&o.classList.remove("active")):o.classList.remove("active")}document.onreadystatechange=function(t){let s=$("#bottom-drawer");s.height()<=0||window.tocbot.init({tocSelector:"#toc-body-mobile",contentSelector:".markdown-body",headingSelector:"h1,h2,h3,h4",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:20})}</script></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><div class="col-lg-7 mx-auto nopadding-x-md"><div class="container custom mx-auto"><script>!function(e,s,p){var r;void 0===e.webpushr&&(e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)},r=s.getElementsByTagName(p)[0],(p=s.createElement(p)).id="webpushr-jssdk",p.async=1,p.src="https://cdn.webpushr.com/app.min.js",r.parentNode.appendChild(p))}(window,document,"script"),webpushr("setup",{key:"BBkZb7rpvsVqVNkORXD9T9T93MJodtpNJD5c1f2HE_XsED3r94An3CKObdyTJ6ub3ARm9LIdeDCVzKLBsK760NM"})</script></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script><script src="/js/debouncer-c523e4d3f8b7b837c19f74984acbabf7.js"></script><script src="/js/events-f495e9aefe2285fc712ba316bdf01b26.js"></script><script src="/js/plugins-93fa930e12b7596433529edc1b5458df.js"></script><script src="/js/lazyload-e96b3165477d429bf8096bdbd068d816.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script src="/js/local-search-c277a106ee2a2e265fcd58887e53c0fb.js"></script><script>document.querySelector("#local-search-input").onclick=function(){searchFunc("/local-search.xml","local-search-input","local-search-result"),this.onclick=null}</script><script defer>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-137859264-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script>let sidebarBody=document.querySelector(".sidebar .sidebar-body"),sidebarActive=document.querySelector(".sidebar .is-active-li"),bc=sidebarBody.getBoundingClientRect(),ac=sidebarActive.getBoundingClientRect(),t=ac.y-bc.y-bc.height/2;0<t&&sidebarBody.scrollTo({top:t,behavior:"smooth"})</script><script src="/js/boot-b4d619350e67f5b3ceeb2164d30268e0.js"></script><script src="/assets/js/post-content-4067526c74af06e5ffe9a190633d525a.js"></script></body></html>