<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/icons/touch-icon-apple.png"><link rel="icon" type="image/png" href="/icons/favicon-32x32.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content><meta name="author" content="Mohuishou"><meta name="keywords" content="Go, Docker, PHP"><title>Week03: Goå¹¶å‘ç¼–ç¨‹(å…«) æ·±å…¥ç†è§£ sync.Once - Mohuishou</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/assets/css/custom.css"><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script></head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>mohuishou</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> å‹é“¾</a></li><li class="nav-item"><a class="nav-link" href="/atom.xml"><i class="iconfont icon-rss"></i> rss</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner intro-2" id="background" parallax="true" style="background:url(/img/bg.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container page-header text-center fade-in-up"><span class="h2" id="subtitle"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2020-12-28 14:29" pubdate>2020å¹´12æœˆ28æ—¥ ä¸‹åˆ</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 745 å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 10 åˆ†é’Ÿ</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto" id="post"><h1 style="display:none">Week03: Goå¹¶å‘ç¼–ç¨‹(å…«) æ·±å…¥ç†è§£ sync.Once</h1><div class="markdown-body" id="post-body"><blockquote><p>æœ¬ç³»åˆ—ä¸ºæå®¢æ—¶é—´ Go è¿›é˜¶è®­ç»ƒè¥ç¬”è®°ï¼ŒåŒæ­¥ç›´æ’­æ›´æ–°ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 1 ~ 2 ç¯‡æ–‡ç« ï¼Œåˆ° 202103 æœˆæ›´æ–°å®Œæˆ</p></blockquote><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ã€Š<a href="https://lailin.xyz/post/go-training-week3-errgroup.html">Week03: Go å¹¶å‘ç¼–ç¨‹(ä¸ƒ) æ·±å…¥ç†è§£ errgroup</a>ã€‹å½“ä¸­çœ‹ <code>errgourp</code> æºç çš„æ—¶å€™æˆ‘ä»¬å‘ç°æœ€åè¿”å› <code>err</code> æ˜¯é€šè¿‡ once æ¥åªä¿è¯è¿”å›ä¸€ä¸ªé nil çš„å€¼çš„ï¼Œæœ¬æ–‡å°±æ¥çœ‹ä¸€ä¸‹ Once çš„ä½¿ç”¨ä¸å®ç°</p><h2 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h2><p>once çš„ä½¿ç”¨å¾ˆç®€å•</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;
	<span class="hljs-keyword">var</span> (
		o  sync.Once
		wg sync.WaitGroup
	)

	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;
		wg.Add(<span class="hljs-number">1</span>)

		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-keyword">int</span>)</span></span> &#123;
			<span class="hljs-keyword">defer</span> wg.Done()
			o.Do(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;
				fmt.Println(<span class="hljs-string">"once"</span>, i)
			&#125;)
		&#125;(i)
	&#125;

	wg.Wait()
&#125;</code></pre><p>è¾“å‡º</p><pre><code class="hljs go">â¯ <span class="hljs-keyword">go</span> run ./main.<span class="hljs-keyword">go</span>
once <span class="hljs-number">9</span></code></pre><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><pre><code class="hljs go"><span class="hljs-keyword">type</span> Once <span class="hljs-keyword">struct</span> &#123;
	done <span class="hljs-keyword">uint32</span>
	m    Mutex
&#125;</code></pre><p>done ç”¨äºåˆ¤å®šå‡½æ•°æ˜¯å¦æ‰§è¡Œï¼Œå¦‚æœä¸ä¸º 0 ä¼šç›´æ¥è¿”å›</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(o *Once)</span> <span class="hljs-title">Do</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>()</span>)</span> &#123;
	<span class="hljs-comment">// Note: Here is an incorrect implementation of Do:</span>
	<span class="hljs-comment">//</span>
	<span class="hljs-comment">//	if atomic.CompareAndSwapUint32(&amp;o.done, 0, 1) &#123;</span>
	<span class="hljs-comment">//		f()</span>
	<span class="hljs-comment">//	&#125;</span>
	<span class="hljs-comment">//</span>
	<span class="hljs-comment">// Do guarantees that when it returns, f has finished.</span>
	<span class="hljs-comment">// This implementation would not implement that guarantee:</span>
	<span class="hljs-comment">// given two simultaneous calls, the winner of the cas would</span>
	<span class="hljs-comment">// call f, and the second would return immediately, without</span>
	<span class="hljs-comment">// waiting for the first's call to f to complete.</span>
	<span class="hljs-comment">// This is why the slow path falls back to a mutex, and why</span>
	<span class="hljs-comment">// the atomic.StoreUint32 must be delayed until after f returns.</span>

	<span class="hljs-keyword">if</span> atomic.LoadUint32(&amp;o.done) == <span class="hljs-number">0</span> &#123;
		<span class="hljs-comment">// Outlined slow-path to allow inlining of the fast-path.</span>
		o.doSlow(f)
	&#125;
&#125;</code></pre><p>çœ‹ go çš„æºç çœŸçš„å¯ä»¥å­¦åˆ°å¾ˆå¤šä¸œè¥¿ï¼Œåœ¨è¿™é‡Œè¿˜ç»™å‡ºäº†å¾ˆå®¹æ˜“çŠ¯é”™çš„ä¸€ç§å®ç°</p><pre><code class="hljs go"><span class="hljs-keyword">if</span> atomic.CompareAndSwapUint32(&amp;o.done, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) &#123;
	f()
&#125;</code></pre><p>å¦‚æœè¿™ä¹ˆå®ç°æœ€å¤§çš„é—®é¢˜æ˜¯ï¼Œå¦‚æœå¹¶å‘è°ƒç”¨ï¼Œä¸€ä¸ª goroutine æ‰§è¡Œï¼Œå¦å¤–ä¸€ä¸ªä¸ä¼šç­‰æ­£åœ¨æ‰§è¡Œçš„è¿™ä¸ªæˆåŠŸä¹‹åè¿”å›ï¼Œè€Œæ˜¯ç›´æ¥å°±è¿”å›äº†ï¼Œè¿™å°±ä¸èƒ½ä¿è¯ä¼ å…¥çš„æ–¹æ³•ä¸€å®šä¼šå…ˆæ‰§è¡Œä¸€æ¬¡äº†<br>æ‰€ä»¥å›å¤´çœ‹å®˜æ–¹çš„å®ç°</p><pre><code class="hljs go"><span class="hljs-keyword">if</span> atomic.LoadUint32(&amp;o.done) == <span class="hljs-number">0</span> &#123;
    <span class="hljs-comment">// Outlined slow-path to allow inlining of the fast-path.</span>
    o.doSlow(f)
&#125;</code></pre><p>ä¼šå…ˆåˆ¤æ–­ done æ˜¯å¦ä¸º 0ï¼Œå¦‚æœä¸ä¸º 0 è¯´æ˜è¿˜æ²¡æ‰§è¡Œè¿‡ï¼Œå°±è¿›å…¥ <code>doSlow</code></p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(o *Once)</span> <span class="hljs-title">doSlow</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>()</span>)</span> &#123;
	o.m.Lock()
	<span class="hljs-keyword">defer</span> o.m.Unlock()
	<span class="hljs-keyword">if</span> o.done == <span class="hljs-number">0</span> &#123;
		<span class="hljs-keyword">defer</span> atomic.StoreUint32(&amp;o.done, <span class="hljs-number">1</span>)
		f()
	&#125;
&#125;</code></pre><p>åœ¨ <code>doSlow</code> å½“ä¸­ä½¿ç”¨äº†äº’æ–¥é”æ¥ä¿è¯åªä¼šæ‰§è¡Œä¸€æ¬¡</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li>Once ä¿è¯äº†ä¼ å…¥çš„å‡½æ•°åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œè¿™å¸¸ç”¨åœ¨å•ä¾‹æ¨¡å¼ï¼Œé…ç½®æ–‡ä»¶åŠ è½½ï¼Œåˆå§‹åŒ–è¿™äº›åœºæ™¯ä¸‹</li><li>ä½†æ˜¯éœ€è¦æ³¨æ„ã€‚Once æ˜¯ä¸èƒ½å¤ç”¨çš„ï¼Œåªè¦æ‰§è¡Œè¿‡äº†ï¼Œå†ä¼ å…¥å…¶ä»–çš„æ–¹æ³•ä¹Ÿä¸ä¼šå†æ‰§è¡Œäº†</li><li>å¹¶ä¸” Once.Do åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å¦‚æœ f å‡ºç° panicï¼Œåé¢ä¹Ÿä¸ä¼šå†æ‰§è¡Œäº†</li></ul><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://pkg.go.dev/sync#Once" target="_blank" rel="noopener">https://pkg.go.dev/sync#Once</a></li><li><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-sync-primitives/#once" target="_blank" rel="noopener">6.2 åŒæ­¥åŸè¯­ä¸é”</a></li></ol><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°"><a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°</h2><p>çœ‹åˆ°è¿™é‡Œäº†è¿˜ä¸å…³æ³¨ç‚¹èµèµ°ä¸€æ³¢</p><ul><li><a href="https://lailin.xyz">åšå®¢</a> å¯ä»¥è®¢é˜… RSS</li><li><a href="https://github.com/mohuishou" target="_blank" rel="noopener">Github</a> Follow me</li><li><a href="https://www.zhihu.com/people/mo-hui-shou-76" target="_blank" rel="noopener">çŸ¥ä¹</a> å…³æ³¨è´¦å·ï¼Œé¡ºä¾¿ç‚¹ä¸ª ğŸ‘</li><li><a href="https://toutiao.io/subjects/387401?f=new" target="_blank" rel="noopener">å¼€å‘è€…å¤´æ¡</a> è®¢é˜…è®¢é˜…å·ï¼Œé¡ºä¾¿ç‚¹ä¸ª ğŸ‘</li></ul><div><h2 id="ç›¸å…³æ¨è">ç›¸å…³æ¨è</h2><ul><li><a href="https://lailin.xyz/post/go-training-week3-errgroup.html">Week03: Goå¹¶å‘ç¼–ç¨‹(ä¸ƒ) æ·±å…¥ç†è§£ errgroup</a></li><li><a href="https://lailin.xyz/post/go-training-week3-waitgroup.html">Week03: Goå¹¶å‘ç¼–ç¨‹(å…­) æ·±å…¥ç†è§£ WaitGroup</a></li><li><a href="https://lailin.xyz/post/go-training-week3-atomic.html">Week03: Goå¹¶å‘ç¼–ç¨‹(äº”) æ·±å…¥ç†è§£ sync/atomic</a></li></ul></div></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/Goè¿›é˜¶è®­ç»ƒè¥/">Goè¿›é˜¶è®­ç»ƒè¥</a> <a class="hover-with-bg" href="/categories/Goè¿›é˜¶è®­ç»ƒè¥/Goå¹¶å‘ç¼–ç¨‹/">Goå¹¶å‘ç¼–ç¨‹</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/å­¦ä¹ ç¬”è®°/">å­¦ä¹ ç¬”è®°</a> <a class="hover-with-bg" href="/tags/Go/">Go</a> <a class="hover-with-bg" href="/tags/Goè¿›é˜¶è®­ç»ƒè¥/">Goè¿›é˜¶è®­ç»ƒè¥</a> <a class="hover-with-bg" href="/tags/å¹¶å‘/">å¹¶å‘</a></div></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext row"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/post/go-training-week3-errgroup.html"><span class="hidden-mobile">Week03: Goå¹¶å‘ç¼–ç¨‹(ä¸ƒ) æ·±å…¥ç†è§£ errgroup</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><script type="text/javascript">function loadUtterances(){var t="github-light",e="github-dark",s=document.documentElement.getAttribute("data-user-color-scheme");s="dark"===s?e:t,window.UtterancesThemeLight=t,window.UtterancesThemeDark=e;var n=document.createElement("script");n.setAttribute("src","https://utteranc.es/client.js"),n.setAttribute("repo","scuplus/blogComment"),n.setAttribute("issue-term","pathname"),n.setAttribute("label","utterances"),n.setAttribute("theme",s),n.setAttribute("crossorigin","anonymous"),document.getElementById("comments").appendChild(n)}waitElementVisible("comments",loadUtterances)</script></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div id="tocbot"></div></div></div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready(function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:"#post-body",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:0,scrollSmooth:!0,headingsOffset:-t}),0<$(".toc-list-item").length&&$("#toc").css("visibility","visible")})</script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","Week03: Goå¹¶å‘ç¼–ç¨‹(å…«) æ·±å…¥ç†è§£ sync.Once&nbsp;"],cursorChar:"_",typeSpeed:70,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})</script><script defer>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-137859264-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script></body></html>