<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/icons/touch-icon-apple.png"><link rel="icon" type="image/png" href="/icons/favicon-32x32.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content="mohuishou 的 技术博客, 关注云原生, Go, K8s, Docker, 微服务等技术"><meta name="author" content="Mohuishou"><meta name="keywords" content="Go,Docker,PHP,Go,k8s,kubernetes,云原生,kind,kubernetes 系列,Kubernetes 扩展: Operator"><title>2. Kind: 如何快速搭建本地 K8s 开发环境？ - Mohuishou</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main-442214b0b65670dd46af7df7ed93c28e.css"><link rel="stylesheet" href="/assets/css/custom-0e36f72be6c0aff220c940db3074a9fc.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"lailin.xyz",root:"/",version:"1.8.7",typing:{enable:!1,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,onlypost:!1},web_analytics:{enable:!0,baidu:null,google:"UA-137859264-1",gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}}}</script><script src="/js/utils-5ecdced2f65030c3508cf0b3db78f4ad.js"></script><script src="/js/color-schema-46bfe5914503d369a38135850f0aac19.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>mohuishou</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/post/operator-01-overview.html"><i class="iconfont icon-category-fill"></i> kubernetes 系列</a></li><li class="nav-item"><a class="nav-link" href="/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/"><i class="iconfont icon-category-fill"></i> Go 进阶训练营(更新中)</a></li><li class="nav-item"><a class="nav-link" href="/post/go-design-pattern.html"><i class="iconfont icon-notebook"></i> Go 设计模式</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 更多</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/links/"><i class="iconfont icon-link-fill"></i> 友链 </a><a class="dropdown-item" href="/atom.xml"><i class="iconfont icon-rss"></i> rss </a><a class="dropdown-item" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></div></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/bg.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="2. Kind: 如何快速搭建本地 K8s 开发环境？">2. Kind: 如何快速搭建本地 K8s 开发环境？</span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-05-07 01:00" pubdate>2021年5月7日 凌晨</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 27 分钟</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"><div class="sidebar"><p class="sidebar-header">kubernetes 系列</p><div class="sidebar-body" id="sidebar-body"><ol class="sidebar-list sidebar-list-1"><li class="sidebar-list-item"><a class="sidebar-title sidebar-title-ckocu80bd000kgqos3jgx2mfq" data-cid="ckocu80bd000kgqos3jgx2mfq" onclick='switchSideBar("ckocu80bd000kgqos3jgx2mfq")'>Kubernetes 扩展: Operator(2)</a><ol data-cid="ckocu80bd000kgqos3jgx2mfq" class="sidebar-list sidebar-list-2 sidebar-is-collapsible sidebar-ckocu80bd000kgqos3jgx2mfq"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-01-overview.html">1. Operator概述: 如何对 Kubernetes 进行扩展</a></li><li class="sidebar-list-item is-active-li"><a class="sidebar-link sidebar-active-link" href="/post/operator-02-use-kind-create-k8s-local-cluster.html">2. Kind: 如何快速搭建本地 K8s 开发环境？</a></li></ol></li></ol></div></div><script>function switchSideBar(s){$(".sidebar-title-"+s).toggleClass("sidebar-title-collapsed"),$(".sidebar-"+s).toggleClass("sidebar-is-collapsed")}</script></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">2. Kind: 如何快速搭建本地 K8s 开发环境？</h1><div class="markdown-body"><p>上篇文章中我们讲到了 k8s 中有哪些扩展点，开始 Operator 开发相关之前我们需要先把本地环境搭建好</p><h2 id="一、依赖检查"><a href="#一、依赖检查" class="headerlink" title="一、依赖检查"></a>一、依赖检查</h2><p>开始之前需要先检查一下</p><ul><li>是否已经安装好了 Docker 环境<ul><li>如果还没安装 Mac/Windows 的用户可以直接安装 <a target="_blank" rel="noopener" href="https://www.docker.com/products/docker-desktop">Docker Desktop</a></li><li>Windows 用户推荐使用 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">WSL2</a></li></ul></li><li>是否已经安装好了 Golang 环境, Go 版本最好 &gt;= 1.15<ul><li>如果没有可以参考<a target="_blank" rel="noopener" href="https://learn.go.dev/">官方文档</a>进行安装</li></ul></li></ul><h2 id="二、使用-Kind-搭建本地开发环境"><a href="#二、使用-Kind-搭建本地开发环境" class="headerlink" title="二、使用 Kind 搭建本地开发环境"></a>二、使用 Kind 搭建本地开发环境</h2><h3 id="2-1-安装"><a href="#2-1-安装" class="headerlink" title="2.1 安装"></a>2.1 安装</h3><p>如果本地存在 Golang 环境可以直接执行下方命令进行安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">GO111MODULE=<span class="hljs-string">&quot;on&quot;</span> go get sigs.k8s.io/kind@v0.10.0 &amp;&amp; kind create cluster<br></code></pre></td></tr></table></figure><p>如果不想通过源码安装可以查看<a target="_blank" rel="noopener" href="https://kind.sigs.k8s.io/docs/user/quick-start/#installation">官方文档</a>直接安装编译好的二进制文件</p><p>执行下方命令可以输出 kind 的版本就表示安装好了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">❯ kind version<br>kind v0.10.0 go1.16 linux/amd64<br></code></pre></td></tr></table></figure><h3 id="2-2-创建一个-K8s-集群"><a href="#2-2-创建一个-K8s-集群" class="headerlink" title="2.2 创建一个 K8s 集群"></a>2.2 创建一个 K8s 集群</h3><p>使用下方命令即可创建一个简单的单节点 K8s 集群</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">node create clutser<br></code></pre></td></tr></table></figure><p>集群的创建时间和你的网络环境以及机器的性能有关系，kind 会去 docker hub 上拉取 <a target="_blank" rel="noopener" href="https://hub.docker.com/r/kindest/node/tags?page=1&amp;ordering=last_updated">kindest/node</a> 镜像，这个镜像大概有 400M 的大小，当出现下方的提示的时候就说明集群创建好了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">❯ kind create cluster<br>Creating cluster <span class="hljs-string">&quot;kind&quot;</span> ...<br> ✓ Ensuring node image (kindest/node:v1.20.2) 🖼<br> ✓ Preparing nodes 📦<br> ✓ Writing configuration 📜<br> ✓ Starting control-plane 🕹️<br> ✓ Installing CNI 🔌<br> ✓ Installing StorageClass 💾<br>Set kubectl context to <span class="hljs-string">&quot;kind-kind&quot;</span><br>You can now use your cluster with:<br><br>kubectl cluster-info --context kind-kind<br><br>Thanks <span class="hljs-keyword">for</span> using kind! 😊<br></code></pre></td></tr></table></figure><p>我们可以使用 <code>kind get clusters</code> 获取我们创建的集群列表，kind 支持创建多个集群，不手动指定集群名称的时候默认名为 <code>kind</code> ，我们也可以像下面一样在创建集群的时候使用 <code>--name</code> 指定集群名称</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kind create cluster --name mohuishou<br></code></pre></td></tr></table></figure><p>可以看到我们两个集群都创建好了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">❯ kind get clusters<br>kind<br>mohuishou<br></code></pre></td></tr></table></figure><p>现在我们只需要一个集群，所以可以先使用 <code>kind delete clusters mohuishou</code> 将刚刚创建的集群先删除掉</p><h3 id="2-3-使用集群"><a href="#2-3-使用集群" class="headerlink" title="2.3 使用集群"></a>2.3 使用集群</h3><p>下面我们来看一下 <code>kubectl</code> 的常用命令是否都可以正常使用，并且部署一个简单的 web 服务试试</p><h4 id="查看集群信息"><a href="#查看集群信息" class="headerlink" title="查看集群信息"></a>查看集群信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">❯ kubectl  cluster-info --context kind-kind<br>Kubernetes master is running at https://127.0.0.1:41801<br>KubeDNS is running at https://127.0.0.1:41801/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy<br><br>To further debug and diagnose cluster problems, use <span class="hljs-string">&#x27;kubectl cluster-info dump&#x27;</span>.<br></code></pre></td></tr></table></figure><p>可以看到我们 k8s master 地址和 dns 的地址，注意一般情况下我们只创建一个集群不需要指定 <code>--context cluster name</code> 但是创建了多个集群时这个基本就是必须的一个命令了。如果不加这个参数可能会报下面的错误</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">The connection to the server localhost:8080 was refused - did you specify the right host or port?<br></code></pre></td></tr></table></figure><p>这是因为 <code>kubectl</code>默认连接的 apiserver 地址是 <code>localhost:8080</code>但是我们的 <code>apiserver</code> 地址不是这个所以报错。</p><p><strong>为什么我们使用 <code>--context cluster-name</code> 就可以了呢？</strong></p><p>这是因为 kind 在创建集群的时候会修改 <code>$HOME/.kube/config</code> 的配置，将集群的 apiserver 地址，证书等相关信息都自动写入进去了</p><p><strong>每次命令都要加上这个参数好麻烦怎么办？</strong></p><p>我们可以使用 <code>kubectl config use-context context-name</code> 来进行设置，设置好了之后我们后续就不用每次都加上 <code>–context</code> 的参数了，同时还可以通过 <code>kubectl config current-context</code> 查询我们当前默认操作的集群是哪一个</p><h4 id="查看集群节点列表"><a href="#查看集群节点列表" class="headerlink" title="查看集群节点列表"></a>查看集群节点列表</h4><p>可以发现我们部署的是一个单节点的 <code>v1.20.2</code> 的集群</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">❯ kubectl get no<br>NAME                 STATUS   ROLES                  AGE   <span class="hljs-keyword">VERSION</span><br>kind-control-plane   Ready    control-plane,<span class="hljs-keyword">master</span>   <span class="hljs-title">20m</span>   v1.<span class="hljs-number">20.2</span><br></code></pre></td></tr></table></figure><h4 id="部署一个-Nginx-服务"><a href="#部署一个-Nginx-服务" class="headerlink" title="部署一个 Nginx 服务"></a>部署一个 Nginx 服务</h4><p>使用下方代码创建一个 <code>nginx.yml</code> 文件，然后使用 <code>kubectl apply -f nginx.yml</code> 就可以完成部署了</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-deployment</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.14.2</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br><br></code></pre></td></tr></table></figure><p>查看当前 deployment 的状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">❯ kubectl get deployment<br>NAME               READY   UP-TO-DATE   AVAILABLE   AGE<br>nginx-deployment   0/3     3            0           39s<br></code></pre></td></tr></table></figure><p>查看 pod 的状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">❯ kubectl get pods         <br>NAME                                READY   STATUS    RESTARTS   AGE<br>nginx-deployment-66b6c48dd5-2s5cb   1/1     Running   0          84s<br>nginx-deployment-66b6c48dd5-8wf8b   1/1     Running   0          84s<br>nginx-deployment-66b6c48dd5-zc6vd   1/1     Running   0          84s<br></code></pre></td></tr></table></figure><p>由于我们没有做服务暴露，所以是不能直接访问对应的服务的，我们可以用 <code>kubectl</code> 提供的端口转发功能来讲流量从本地转发给 k8s 集群</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">❯ kubectl port-forward nginx-deployment-66b6c48dd5-2s5cb 30080:80<br>Forwarding from 127.0.0.1:30080 -&gt; 80<br>Forwarding from [::1]:30080 -&gt; 80<br>Handling connection <span class="hljs-keyword">for</span> 30080<br></code></pre></td></tr></table></figure><p>我们访问 <a target="_blank" rel="noopener" href="http://localhost:30080">http://localhost:30080</a> 就会发现这个熟悉的 nginx 界面</p><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/20210424210804.png" srcset="/img/loading.gif" alt="image-20210424210804343"></p><p>到这里可以发现我们集群已经是可以使用了</p><h3 id="2-4-进阶使用"><a href="#2-4-进阶使用" class="headerlink" title="2.4 进阶使用"></a>2.4 进阶使用</h3><h4 id="2-4-1-创建一个多节点的集群"><a href="#2-4-1-创建一个多节点的集群" class="headerlink" title="2.4.1 创建一个多节点的集群"></a>2.4.1 创建一个多节点的集群</h4><p><code>kind</code> 默认创建的是一个单节点的集群，我们可以通过修改配置创建一个高可用的集群，我们创建一个 3 个 master 节点，两个 worker 节点的集群</p><p><code>kind create cluster --name mohuishou-ha --config kind-ha.yml</code></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-attr">kind:</span> Cluster<br><span class="hljs-attr">apiVersion:</span> kind.x-k8s.io/v1alpha4<br><span class="hljs-attr">nodes:</span><br>  - <span class="hljs-attr">role:</span> control-plane<br>  - <span class="hljs-attr">role:</span> control-plane<br>  - <span class="hljs-attr">role:</span> control-plane<br>  - <span class="hljs-attr">role:</span> worker<br>  - <span class="hljs-attr">role:</span> worker<br></code></pre></td></tr></table></figure><p>看一下节点即可验证</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">❯ kubectl --context kind-mohuishou-ha get no                 <br>NAME                          STATUS   ROLES                  AGE     VERSION<br>mohuishou-ha-control-plane    Ready    control-plane,master   16m     v1.20.2<br>mohuishou-ha-control-plane2   Ready    control-plane,master   14m     v1.20.2<br>mohuishou-ha-control-plane3   Ready    control-plane,master   13m     v1.20.2<br>mohuishou-ha-worker           Ready    &lt;none&gt;                 5m52s   v1.20.2<br>mohuishou-ha-worker2          Ready    &lt;none&gt;                 5m52s   v1.20.2<br></code></pre></td></tr></table></figure><h4 id="2-4-2-Load-Image"><a href="#2-4-2-Load-Image" class="headerlink" title="2.4.2 Load Image"></a>2.4.2 Load Image</h4><p>一般来说我们在 k8s 内部署应用需要先把容器镜像推送到到镜像仓库当中，这样在本地开发的时候相对来说会比较麻烦，特别是镜像比较大的时候，往返会有两次网络消耗，为了解决这个问题我们可以使用 <code>kind</code> load 镜像的功能直接把镜像。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kind load docker-image my-custom-image-0 my-custom-image-1 --name kind<br></code></pre></td></tr></table></figure><p><strong>排坑指南：load image 成功，但是部署 pod 报错</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Failed to pull image <span class="hljs-string">&quot;controller:latest&quot;</span>: rpc error: code = Unknown desc = failed to pull and unpack image <span class="hljs-string">&quot;docker.io/library/controller:latest&quot;</span>: failed to resolve reference <span class="hljs-string">&quot;docker.io/library/controller:latest&quot;</span>: pull access denied, repository does not exist or may require authorization: server message: insufficient_scope: authorization failed<br></code></pre></td></tr></table></figure><p>这个问题之前卡了我很久，还是有点坑</p><ol><li><p>进入节点查看: 镜像是否存在</p><ul><li><p>获取节点名</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">▶ kubectl get nodes<br>NAME                 STATUS   ROLES                  AGE    VERSION<br>kind-control-plane   Ready    control-plane,master   2d1h   v1.20.2<br></code></pre></td></tr></table></figure></li><li><p>进入终端</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker <span class="hljs-built_in">exec</span> -it kind-control-plane bash<br></code></pre></td></tr></table></figure></li><li><p>查看镜像是否存在，kind 创建的集群使用的是 containerd 所以我们使用 <code>crictl</code> 命令来获取</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">crictl img | grep controller<br>docker.io/library/controller   latest    421cbf77618ba       72.1MB<br></code></pre></td></tr></table></figure></li></ul></li><li><p>如果镜像存在，也就是我们上面看到的情况，这时候就要检查一下我们部署的 yaml 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl -n node-pool-operator-system  get deployment -o yaml | grep imagePullPolicy<br></code></pre></td></tr></table></figure><p>是否存在: <code>imagePullPolicy: Always</code> 如果我们没有改 yaml 的话默认会是这个配置，这个配置会导致每次都去镜像仓库拉取镜像，改成 <code>imagePullPolicy: IfNotPresent</code> 就可以了</p></li><li><p>如果镜像不存在：这时候要检查一下有没有指定 cluster-name，在存在多个集群的情况下可能没有加载到我们想要的集群，加上 <code>--name cluster-name</code> 即可</p></li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>kind</code> 在创建集群的时候实际上使用的是 <code>kubeadm</code> 所以还可以修改 <code>kubeadm</code> 的配置来修改默认的镜像地址，节点标签污点等信息，除此之外还可以配置 <code>PV/PVC</code> <code>CNI</code> 插件等配置，如果有需求的话可以查阅 kind 的官方文档</p><p>不过要注意的是 kind 不支持给运行的集群添加节点，如果需要多节点集群的话得提前规划好节点数量</p><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul><li>kind – Configuration<a target="_blank" rel="noopener" href="https://kind.sigs.k8s.io/docs/user/configuration/">https://kind.sigs.k8s.io/docs/user/configuration/</a></li><li>Docker Desktop<a target="_blank" rel="noopener" href="https://www.docker.com/products/docker-desktop">https://www.docker.com/products/docker-desktop</a></li><li>WSL2<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">https://docs.microsoft.com/en-us/windows/wsl/install-win10</a></li><li>Getting Started - go.dev <a target="_blank" rel="noopener" href="https://learn.go.dev/">https://learn.go.dev/</a></li><li>使用 Kind 搭建你的本地 Kubernetes 集群<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000018720465">https://segmentfault.com/a/1190000018720465</a></li></ul><h2 id="关注我获取更新"><a href="#关注我获取更新" class="headerlink" title="关注我获取更新"></a>关注我获取更新<a class="anchorjs-link" aria-label="Anchor" data-anchorjs-icon="" href="#关注我获取更新" style="font:1em/1 anchorjs-icons;padding-left:.375em"></a></h2><div class="row"><div class="col-lg-6"><img style="width:100%" src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png" srcset="/img/loading.gif" alt="wechat"></div><div class="col-lg-2 col-4"><a target="_blank" href="http://s.zhihu.com/B4RT3"><img style="width:100%" src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png" srcset="/img/loading.gif" alt="知乎"></a></div><div class="col-lg-2 col-4"><a target="_blank" href="https://toutiao.io/subjects/387401?f=new"><img style="width:100%" src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png" srcset="/img/loading.gif" alt="开发者头条"></a></div><div class="col-lg-2 col-4"><a target="_blank" href="https://github.com/mohuishou"><img style="width:100%" src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png" srcset="/img/loading.gif" alt="github"></a></div></div><script>document.addEventListener("DOMContentLoaded",t=>{let e=$("#toc");1<=e.height()&&e.append(`
    <a
      class="fancybox fancybox.image"
      target="_blank" href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"
      itemscope=""
      itemtype="http://schema.org/ImageObject"
      itemprop="url"
      data-fancybox="default"
      rel="default noopener"
      title="wechat"
      data-caption="wechat"
      ><img
        style="width: 100%"
        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"
        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"
        alt="wechat"
      />
    `)})</script><h2 id="猜你喜欢">猜你喜欢</h2><ul><li><a href="/post/operator-01-overview.html" rel="recommend">1. Operator概述: 如何对 Kubernetes 进行扩展</a> <span></span></li><li><a href="/post/array.html" rel="recommend">Go数据结构与算法02-数组上: 深入理解 slice</a> <span></span></li><li><a href="/post/array_2.html" rel="recommend">Go数据结构与算法03-数组下: 使用 GDB 调试 Golang 代码</a> <span></span></li><li><a href="/post/defer.html" rel="recommend">Go数据结构与算法05-栈下: 深入理解 defer</a> <span></span></li><li><a href="/post/go-new-struct-style-select.html" rel="recommend">Go Struct 初始化风格的抉择</a> <span></span></li></ul></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/kubernetes-%E7%B3%BB%E5%88%97/">kubernetes 系列</a> <a class="hover-with-bg" href="/categories/kubernetes-%E7%B3%BB%E5%88%97/Kubernetes-%E6%89%A9%E5%B1%95-Operator/">Kubernetes 扩展: Operator</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/Go/">Go</a> <a class="hover-with-bg" href="/tags/k8s/">k8s</a> <a class="hover-with-bg" href="/tags/kubernetes/">kubernetes</a> <a class="hover-with-bg" href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a> <a class="hover-with-bg" href="/tags/kind/">kind</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a>，转载请注明出处，禁止全文转载</p><div class="post-prevnext"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/post/operator-01-overview.html"><span class="hidden-mobile">1. Operator概述: 如何对 Kubernetes 进行扩展</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments"><script type="text/javascript">var light="github-light",dark="github-dark",schema="dark"===(schema=document.documentElement.getAttribute("data-user-color-scheme"))?dark:light;window.UtterancesThemeLight=light,window.UtterancesThemeDark=dark;var s=document.createElement("script");s.setAttribute("src","https://utteranc.es/client.js"),s.setAttribute("repo","scuplus/blogComment"),s.setAttribute("issue-term","pathname"),s.setAttribute("label","utterances"),s.setAttribute("theme",schema),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async","async"),document.getElementById("comments").appendChild(s)</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div><div id="bottom"><div id="bottom-drawer" class="bottom-drawer"><div class="sidebar"><p class="sidebar-header">kubernetes 系列</p><div class="sidebar-body" id="sidebar-body"><ol class="sidebar-list sidebar-list-1"><li class="sidebar-list-item"><a class="sidebar-title sidebar-title-ckocu80bd000kgqos3jgx2mfq" data-cid="ckocu80bd000kgqos3jgx2mfq" onclick='switchSideBar("ckocu80bd000kgqos3jgx2mfq")'>Kubernetes 扩展: Operator(2)</a><ol data-cid="ckocu80bd000kgqos3jgx2mfq" class="sidebar-list sidebar-list-2 sidebar-is-collapsible sidebar-ckocu80bd000kgqos3jgx2mfq"><li class="sidebar-list-item"><a class="sidebar-link" href="/post/operator-01-overview.html">1. Operator概述: 如何对 Kubernetes 进行扩展</a></li><li class="sidebar-list-item is-active-li"><a class="sidebar-link sidebar-active-link" href="/post/operator-02-use-kind-create-k8s-local-cluster.html">2. Kind: 如何快速搭建本地 K8s 开发环境？</a></li></ol></li></ol></div></div><script>function switchSideBar(s){$(".sidebar-title-"+s).toggleClass("sidebar-title-collapsed"),$(".sidebar-"+s).toggleClass("sidebar-is-collapsed")}</script><div id="toc-mobile"><div class="toc-body" id="toc-body-mobile"></div></div></div><div id="bottom-tab"><a class="sub-menu" onclick='showBottomDrawer(this,"#bottom-drawer .sidebar")'><i class="iconfont"></i> 章节 </a><a class="sub-menu" onclick='showBottomDrawer(this,"#bottom-drawer #toc-mobile")'><i class="iconfont"></i> 目录 </a><a href="#comments" class="sub-menu" onclick='showBottomDrawer(this,"#comments")'><i class="iconfont"></i> 评论</a></div></div><script>function showBottomDrawer(s,t){let e=document.querySelector("#bottom-tab");e.childNodes.forEach(t=>{t!=s&&t.classList&&t.classList.remove("active")}),"#comments"!=t&&s.classList.toggle("active");let o=document.querySelector("#bottom-drawer"),c=document.querySelector(t);o.childNodes.forEach(t=>{t!=c&&t.classList&&t.classList.remove("active")}),c.classList.toggle("active"),"#comments"!=t?(c.classList.contains("active")&&!o.classList.contains("active")&&o.classList.add("active"),!c.classList.contains("active")&&o.classList.contains("active")&&o.classList.remove("active")):o.classList.remove("active")}document.onreadystatechange=function(t){let s=$("#bottom-drawer");s.height()<=0||window.tocbot.init({tocSelector:"#toc-body-mobile",contentSelector:".markdown-body",headingSelector:"h1,h2,h3,h4",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:20})}</script></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><div class="col-lg-7 mx-auto nopadding-x-md"><div class="container custom mx-auto"><script>!function(e,s,p){var r;void 0===e.webpushr&&(e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)},r=s.getElementsByTagName(p)[0],(p=s.createElement(p)).id="webpushr-jssdk",p.async=1,p.src="https://cdn.webpushr.com/app.min.js",r.parentNode.appendChild(p))}(window,document,"script"),webpushr("setup",{key:"BBkZb7rpvsVqVNkORXD9T9T93MJodtpNJD5c1f2HE_XsED3r94An3CKObdyTJ6ub3ARm9LIdeDCVzKLBsK760NM"})</script></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script><script src="/js/debouncer-c523e4d3f8b7b837c19f74984acbabf7.js"></script><script src="/js/events-4e84ef10eba726c5b41efcb456e3626a.js"></script><script src="/js/plugins-ca6fb836896e0a0e60d594acac4010f1.js"></script><script src="/js/lazyload-e96b3165477d429bf8096bdbd068d816.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script src="/js/local-search-c277a106ee2a2e265fcd58887e53c0fb.js"></script><script>document.querySelector("#local-search-input").onclick=function(){searchFunc("/local-search.xml","local-search-input","local-search-result"),this.onclick=null}</script><script defer>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-137859264-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script>let sidebarBody=document.querySelector(".sidebar .sidebar-body"),sidebarActive=document.querySelector(".sidebar .is-active-li"),bc=sidebarBody.getBoundingClientRect(),ac=sidebarActive.getBoundingClientRect(),t=ac.y-bc.y-bc.height/2;0<t&&sidebarBody.scrollTo({top:t,behavior:"smooth"})</script><script src="/js/boot-b4d619350e67f5b3ceeb2164d30268e0.js"></script></body></html>