<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>3. KubeBuilder ç®€æ˜æ•™ç¨‹</title>
    <link href="/post/operator-03-kubebuilder-tutorial.html"/>
    <url>/post/operator-03-kubebuilder-tutorial.html</url>
    
    <content type="html"><![CDATA[<h2 id="Operator-æ¦‚è¿°"><a href="#Operator-æ¦‚è¿°" class="headerlink" title="Operator æ¦‚è¿°"></a>Operator æ¦‚è¿°</h2><p>Operator æ˜¯ Kubernetes çš„æ‰©å±•è½¯ä»¶ï¼Œå®ƒåˆ©ç”¨ <a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/api-extension/custom-resources/">å®šåˆ¶èµ„æº</a> ç®¡ç†åº”ç”¨åŠå…¶ç»„ä»¶ã€‚ Operator éµå¾ª Kubernetes çš„ç†å¿µï¼Œç‰¹åˆ«æ˜¯åœ¨<a href="https://kubernetes.io/zh/docs/concepts/architecture/controller/">æ§åˆ¶å™¨</a> æ–¹é¢<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="Operator æ¨¡å¼ | Kubernetes: https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/">[1]</span></a></sup></p><p>k8s çš„æ˜¯ä¸€ä¸ªé«˜åº¦è‡ªåŠ¨åŒ–çš„ç³»ç»Ÿï¼Œå…¶ä¸­æ¶µç›–äº†å¸¸è§åº”ç”¨ç¨‹åºæ‰€éœ€çš„å¤§éƒ¨åˆ†åŠŸèƒ½ï¼Œä¾‹å¦‚æœåŠ¡å‘ç°ï¼Œè´Ÿè½½å‡è¡¡ï¼ŒHPAç­‰ç­‰ï¼Œè¿™äº›åŠŸèƒ½æ˜¯ç”± k8s è‡ªå¸¦çš„ä¸€äº›æ§åˆ¶å™¨å®ç°çš„ï¼Œä½†æ˜¯éœ€æ±‚æ€»æ˜¯æ°¸æ— æ­¢å¢ƒçš„ï¼Œå½“æˆ‘ä»¬æœ‰ç±»ä¼¼éœ€æ±‚ä½†æ˜¯ k8s åˆæ— æ³•å¾ˆå¥½çš„æ»¡è¶³çš„æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ Operator å’Œ Custome Resourceï¼ˆè‡ªå®šä¹‰èµ„æºï¼‰æ¥è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœã€‚</p><p>ä¾‹å¦‚å¸¸è§çš„éœ€æ±‚å°±æœ‰éƒ¨ç½²ä¸€ä¸ªæ•°æ®åº“ï¼ŒèŠ‚ç‚¹è‡ªåŠ¨åŒ–è¿ç»´ï¼Œæ—¥å¿—é‡‡é›†ç»„ä»¶é…ç½®ç­‰ç­‰</p><p>ä» Operator ç†å¿µçš„æå‡ºåˆ°ç°åœ¨å·²ç»æœ‰äº†å¾ˆå¤šå·¥å…·å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿä½æˆæœ¬çš„å¼€å‘ï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„å°±æ˜¯ CoreOS å¼€æºçš„ operator-sdk<sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" aria-label="operator-sdk: https://sdk.operatorframework.io/">[3]</span></a></sup>å’Œ k8s sig å°ç»„ç»´æŠ¤çš„ kubebuilder<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="kubebuilder å®˜æ–¹æ–‡æ¡£, è¿™ä¸ªæ˜¯ master åˆ†æ”¯çš„æ–‡æ¡£ï¼Œå¾… 3.0 å‘å¸ƒåå»æ‰ master å³å¯: https://master.book.kubebuilder.io/quick-start.html">[2]</span></a></sup>ï¼Œæˆ‘ä»¬è¿™ä¸ªç³»åˆ—é€‰ç”¨ kubebuilderã€‚</p><p>å¼€å§‹ä¹‹å‰æˆ‘ä»¬å…ˆäº†è§£ä¸¤ä¸ªé©¬ä¸Šå°±ä¼šæ¶‰åŠåˆ°çš„æ ¸å¿ƒæ¦‚å¿µ</p><h2 id="GV-amp-GVK-amp-GVR"><a href="#GV-amp-GVK-amp-GVR" class="headerlink" title="GV &amp; GVK &amp; GVR"></a>GV &amp; GVK &amp; GVR</h2><ul><li><p>GV: Api Group &amp; Version</p><ul><li>API Group æ˜¯ç›¸å…³ API åŠŸèƒ½çš„é›†åˆ</li><li>æ¯ä¸ª Group æ‹¥æœ‰ä¸€æˆ–å¤šä¸ª Versions</li></ul></li><li><p>GVK: Group Version Kind</p><ul><li>æ¯ä¸ª GV éƒ½åŒ…å« N ä¸ª api ç±»å‹ï¼Œç§°ä¹‹ä¸º <code>Kinds</code>ï¼Œä¸åŒ <code>Version</code> åŒä¸€ä¸ª <code>Kinds</code> å¯èƒ½ä¸åŒ</li></ul></li><li>GVR: Group Version Resource<ul><li><code>Resource</code> æ˜¯ <code>Kind</code> çš„å¯¹è±¡æ ‡è¯†ï¼Œä¸€èˆ¬æ¥ <code>Kind</code> å’Œ <code>Resource</code> æ˜¯ <code>1:1</code> çš„ï¼Œä½†æ˜¯æœ‰æ—¶å€™å­˜åœ¨ <code>1:n</code> çš„å…³ç³»ï¼Œä¸è¿‡å¯¹äº Operator æ¥è¯´éƒ½æ˜¯ <code>1:1</code> çš„å…³ç³»</li></ul></li></ul><p>ä¸¾ä¸ªğŸŒ°ï¼Œæˆ‘ä»¬åœ¨ k8s ä¸­çš„ yaml æ–‡ä»¶éƒ½æœ‰ä¸‹é¢è¿™ä¹ˆä¸¤è¡Œï¼Œä¾‹å¦‚ä¸Šç¯‡æ–‡ç« æˆ‘ä»¬éƒ¨ç½²çš„ <code>nginx deployment</code> </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span> <span class="hljs-comment"># è¿™ä¸ªæ˜¯ GVï¼ŒG æ˜¯ appsï¼ŒV æ˜¯ v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>    <span class="hljs-comment"># è¿™ä¸ªå°±æ˜¯ Kind</span><br><span class="hljs-attr">sepc:</span>               <span class="hljs-comment"># åŠ ä¸Šä¸‹æ”¾çš„ spec å°±æ˜¯ Resourceäº†</span><br>  <span class="hljs-string">...</span><br></code></pre></td></tr></table></figure><p>æ ¹æ® GVK K8s å°±èƒ½æ‰¾åˆ°ä½ åˆ°åº•è¦åˆ›å»ºä»€ä¹ˆç±»å‹çš„èµ„æºï¼Œæ ¹æ®ä½ å®šä¹‰çš„ Spec åˆ›å»ºå¥½èµ„æºä¹‹åå°±æˆä¸ºäº† Resourceï¼Œä¹Ÿå°±æ˜¯ GVRã€‚GVK/GVR å°±æ˜¯ K8s èµ„æºçš„åæ ‡ï¼Œæ˜¯æˆ‘ä»¬åˆ›å»º/åˆ é™¤/ä¿®æ”¹/è¯»å–èµ„æºçš„åŸºç¡€<sup id="fnref:4" class="footnote-ref"><a href="#fn:4" rel="footnote"><span class="hint--top hint--rounded" aria-label="æ·±å…¥è§£æ Kubebuilderï¼šè®©ç¼–å†™ CRD å˜å¾—æ›´ç®€å•: https://developer.aliyun.com/article/719215">[4]</span></a></sup>ã€‚</p><h2 id="KubeBuilder-ç®€æ˜æ•™ç¨‹"><a href="#KubeBuilder-ç®€æ˜æ•™ç¨‹" class="headerlink" title="KubeBuilder ç®€æ˜æ•™ç¨‹"></a>KubeBuilder ç®€æ˜æ•™ç¨‹</h2><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><ul><li><p>è®¿é—®å®˜æ–¹ä»“åº“ä¸‹è½½å·²ç»ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶: <a href="https://github.com/kubernetes-sigs/kubebuilder/releases">Releases Â· kubernetes-sigs/kubebuilder (github.com)</a></p><ul><li>æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ kubebuilder å·²ç»æ¨å‡ºäº† <code>v3.0.0-rc.0</code> ç‰ˆæœ¬ï¼Œæ‰€ä»¥ä¸ºäº†é¿å…åˆšå†™å®Œæ–°ç‰ˆå°±å·²ç» release äº†çš„å°´å°¬æƒ…å†µï¼Œæœ¬æ–‡ç›´æ¥ä½¿ç”¨çš„æ˜¯ 3.0 ç‰ˆæœ¬</li><li>ä¸‹è½½å¥½äº†ä¹‹åè®°å¾—å°†å¯¹åº”æ–‡ä»¶åŠ å…¥ <code>PATH</code> å½“ä¸­</li></ul></li><li><p>å®‰è£…æˆåŠŸä¹‹åä½¿ç”¨ <code>kubebuilder version</code> å¯ä»¥æŸ¥çœ‹å®‰è£…çš„ç‰ˆæœ¬ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ kubebuilder version<br>Version: main.version&#123;KubeBuilderVersion:<span class="hljs-string">&quot;3.0.0-rc.0&quot;</span>, KubernetesVendor:<span class="hljs-string">&quot;1.19.2&quot;</span>, GitCommit:<span class="hljs-string">&quot;90fe4124c4c6965c6bfac63339888956952cda90&quot;</span>, BuildDate:<span class="hljs-string">&quot;2021-04-08T17:36:28Z&quot;</span>, GoOs:<span class="hljs-string">&quot;linux&quot;</span>, GoArch:<span class="hljs-string">&quot;amd64&quot;</span>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="é¡¹ç›®åˆå§‹åŒ–"><a href="#é¡¹ç›®åˆå§‹åŒ–" class="headerlink" title="é¡¹ç›®åˆå§‹åŒ–"></a>é¡¹ç›®åˆå§‹åŒ–</h3><p>å…ˆåˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶å¤¹ï¼Œç„¶ååœ¨æ–‡ä»¶å¤¹å†…æ‰§è¡Œä¸‹æ–¹å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubebuilder init --domain lailin.xyz --repo github.com/mohuishou/blog-code/k8s-operator/02-kubebuilder<br></code></pre></td></tr></table></figure><ul><li><code>â€“-domain lailin.xyz</code> æˆ‘ä»¬çš„é¡¹ç›®çš„åŸŸå</li><li><code>--repo xxx</code> æ˜¯ä»“åº“åœ°å€ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ <code>go mode</code>ä¸­çš„<code>repo</code>åœ°å€</li></ul><p>å¦‚æœä½  <code>golang</code> ç‰ˆæœ¬è¿‡ä½æˆ–è€…è¿‡é«˜éƒ½æœ‰å¯èƒ½å‡ºç°ä¸‹æ–¹çš„é”™è¯¯ä¿¡æ¯ï¼Œæˆ‘è¿™é‡Œæ˜¯å› ä¸ºä½¿ç”¨çš„ <code>1.16</code> ç‰ˆæœ¬å¤ªé«˜äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">2021/04/25 20:47:14 failed to initialize project: unable to run pre-scaffold tasks of <span class="hljs-string">&quot;base.go.kubebuilder.io/v3&quot;</span>: go version <span class="hljs-string">&#x27;go1.16&#x27;</span> is incompatible because <span class="hljs-string">&#x27;requires 1.13 &lt;= version &lt; 1.16&#x27;</span>. You can skip this check using the --skip-go-version-check flag<br></code></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µä¸‹å¯ä»¥æ·»åŠ  <code>--skip-go-version-check</code> å¿½ç•¥è¿™ä¸ªé”™è¯¯ï¼Œä½†æ˜¯è¿˜æ˜¯å»ºè®®ä½¿ç”¨å®˜æ–¹æ¨èçš„ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubebuilder init --domain lailin.xyz --repo github.com/mohuishou/blog-code/k8s-operator/02-kubebuilder --skip-go-version-check<br></code></pre></td></tr></table></figure><h4 id="é¡¹ç›®ç›®å½•"><a href="#é¡¹ç›®ç›®å½•" class="headerlink" title="é¡¹ç›®ç›®å½•"></a>é¡¹ç›®ç›®å½•</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">.<br>â”œâ”€â”€ Dockerfile<br>â”œâ”€â”€ Makefile <span class="hljs-comment"># è¿™é‡Œå®šä¹‰äº†å¾ˆå¤šè„šæœ¬å‘½ä»¤ï¼Œä¾‹å¦‚è¿è¡Œæµ‹è¯•ï¼Œå¼€å§‹æ‰§è¡Œç­‰</span><br>â”œâ”€â”€ PROJECT  <span class="hljs-comment"># è¿™é‡Œæ˜¯ kubebuilder çš„ä¸€äº›å…ƒæ•°æ®ä¿¡æ¯</span><br>â”œâ”€â”€ config<br>â”‚   â”œâ”€â”€ default    <span class="hljs-comment"># ä¸€äº›é»˜è®¤é…ç½®</span><br>â”‚   â”œâ”€â”€ manager    <span class="hljs-comment"># éƒ¨ç½² crd æ‰€éœ€çš„ yaml</span><br>â”‚   â”œâ”€â”€ prometheus <span class="hljs-comment"># ç›‘æ§æŒ‡æ ‡æ•°æ®é‡‡é›†é…ç½®</span><br>â”‚   â””â”€â”€ rbac <span class="hljs-comment"># éƒ¨ç½²æ‰€éœ€çš„ rbac æˆæƒ yaml</span><br>â”œâ”€â”€ go.mod<br>â”œâ”€â”€ go.sum<br>â”œâ”€â”€ hack<br>â”‚   â””â”€â”€ boilerplate.go.txt<br>â””â”€â”€ main.go<br></code></pre></td></tr></table></figure><h4 id="åˆ›å»º-api"><a href="#åˆ›å»º-api" class="headerlink" title="åˆ›å»º api"></a>åˆ›å»º api</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubebuilder create api --group apps --version v1 --kind Application<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä¹‹åæˆ‘ä»¬å¯ä»¥å‘ç°é¡¹ç›®ç»“æ„å‘ç”Ÿäº†ä¸€äº›å˜åŒ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">.<br>â”œâ”€â”€ api<br>â”‚   â””â”€â”€ v1<br>â”‚       â”œâ”€â”€ application_types.go <span class="hljs-comment"># è¿™é‡Œæ˜¯å®šä¹‰ spec çš„åœ°æ–¹</span><br>â”‚       â”œâ”€â”€ groupversion_info.go <span class="hljs-comment"># GV çš„å®šä¹‰ï¼Œä¸€èˆ¬æ— éœ€ä¿®æ”¹</span><br>â”‚       â””â”€â”€ zz_generated.deepcopy.go<br>â”œâ”€â”€ config<br>â”‚   â”œâ”€â”€ crd <span class="hljs-comment"># è‡ªåŠ¨ç”Ÿæˆçš„ crd æ–‡ä»¶ï¼Œä¸ç”¨ä¿®æ”¹è¿™é‡Œï¼Œåªéœ€è¦ä¿®æ”¹äº† v1 ä¸­çš„ go æ–‡ä»¶ä¹‹åæ‰§è¡Œ make generate å³å¯</span><br>â”‚   â”œâ”€â”€ default<br>â”‚   â”œâ”€â”€ manager<br>â”‚   â”œâ”€â”€ prometheus<br>â”‚   â”œâ”€â”€ rbac<br>â”‚   â””â”€â”€ samples <span class="hljs-comment"># è¿™é‡Œæ˜¯ crd ç¤ºä¾‹æ–‡ä»¶ï¼Œå¯ä»¥ç”¨æ¥éƒ¨ç½²åˆ°é›†ç¾¤å½“ä¸­</span><br>â”œâ”€â”€ controllers<br>â”‚   â”œâ”€â”€ application_controller.go <span class="hljs-comment"># åœ¨è¿™é‡Œå®ç° controller çš„é€»è¾‘</span><br>â”‚   â””â”€â”€ suite_test.go <span class="hljs-comment"># è¿™é‡Œå†™æµ‹è¯•</span><br><br></code></pre></td></tr></table></figure><h3 id="å®ç°-Controller"><a href="#å®ç°-Controller" class="headerlink" title="å®ç° Controller"></a>å®ç° Controller</h3><h4 id="å®šä¹‰-CR"><a href="#å®šä¹‰-CR" class="headerlink" title="å®šä¹‰ CR"></a>å®šä¹‰ CR</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// api/v1/application_types.go</span><br><br><span class="hljs-comment">// ApplicationSpec defines the desired state of Application</span><br><span class="hljs-keyword">type</span> ApplicationSpec <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster</span><br><span class="hljs-comment">// Important: Run &quot;make&quot; to regenerate code after modifying this file</span><br><br><span class="hljs-comment">// Product è¯¥åº”ç”¨æ‰€å±çš„äº§å“</span><br>Product <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;product,omitempty&quot;`</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>ä¿®æ”¹ä¹‹åæˆ‘ä»¬æ‰§è¡Œä¸€ä¸‹  <code>make manifests generate</code> å¯ä»¥å‘ç°å·²ç»ç”Ÿæˆäº†ç›¸å…³çš„å­—æ®µï¼Œå¹¶ä¸”ä»£ç ä¸­çš„å­—æ®µæ³¨é‡Šä¹Ÿå°±æ˜¯ yaml æ–‡ä»¶ä¸­çš„æ³¨é‡Š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># config/crd/bases/apps.lailin.xyz_applications.yaml</span><br><span class="hljs-string">......</span><br><span class="hljs-attr">properties:</span><br>              <span class="hljs-attr">product:</span><br>                <span class="hljs-attr">description:</span> <span class="hljs-string">Product</span> <span class="hljs-string">è¯¥åº”ç”¨æ‰€å±çš„äº§å“</span><br>                <span class="hljs-attr">type:</span> <span class="hljs-string">string</span><br><span class="hljs-string">......</span><br></code></pre></td></tr></table></figure><h4 id="å®ç°-controller"><a href="#å®ç°-controller" class="headerlink" title="å®ç° controller"></a>å®ç° controller</h4><p>kubebuilder å·²ç»å¸®æˆ‘ä»¬å®ç°äº† Operator æ‰€éœ€çš„å¤§éƒ¨åˆ†é€»è¾‘ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ <code>Reconcile</code> ä¸­å®ç°ä¸šåŠ¡é€»è¾‘å°±è¡Œäº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// controllers/application_controller.go</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *ApplicationReconciler)</span> <span class="hljs-title">Reconcile</span><span class="hljs-params">(ctx context.Context, req ctrl.Request)</span> <span class="hljs-params">(ctrl.Result, error)</span></span> &#123;<br>_ = r.Log.WithValues(<span class="hljs-string">&quot;application&quot;</span>, req.NamespacedName)<br><br>r.Log.Info(<span class="hljs-string">&quot;app changed&quot;</span>, <span class="hljs-string">&quot;ns&quot;</span>, req.Namespace)<br><br><span class="hljs-keyword">return</span> ctrl.Result&#123;&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>é€»è¾‘ä¿®æ”¹å¥½ä¹‹åï¼Œæˆ‘ä»¬å…ˆæ‰§è¡Œ <code>make install</code> å®‰è£… <code>CRD</code>ï¼Œç„¶åæ‰§è¡Œ <code>make run</code>è¿è¡Œ  controller</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">go run ./main.go<br>2021-04-25T21:55:55.578+0800    INFO    controller-runtime.metrics     metrics server is starting to listen     &#123;<span class="hljs-string">&quot;addr&quot;</span>: <span class="hljs-string">&quot;:8080&quot;</span>&#125;<br>2021-04-25T21:55:55.579+0800    INFO    setup   starting manager<br>2021-04-25T21:55:55.579+0800    INFO    controller-runtime.manager     starting metrics server  &#123;<span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/metrics&quot;</span>&#125;<br>2021-04-25T21:55:55.579+0800    INFO    controller-runtime.manager.controller.application       Starting EventSource    &#123;<span class="hljs-string">&quot;reconciler group&quot;</span>: <span class="hljs-string">&quot;apps.lailin.xyz&quot;</span>, <span class="hljs-string">&quot;reconciler kind&quot;</span>: <span class="hljs-string">&quot;Application&quot;</span>, <span class="hljs-string">&quot;source&quot;</span>: <span class="hljs-string">&quot;kind source: /, Kind=&quot;</span>&#125;<br>2021-04-25T21:55:55.680+0800    INFO    controller-runtime.manager.controller.application       Starting Controller     &#123;<span class="hljs-string">&quot;reconciler group&quot;</span>: <span class="hljs-string">&quot;apps.lailin.xyz&quot;</span>, <span class="hljs-string">&quot;reconciler kind&quot;</span>: <span class="hljs-string">&quot;Application&quot;</span>&#125;<br>2021-04-25T21:55:55.680+0800    INFO    controller-runtime.manager.controller.application       Starting workers        &#123;<span class="hljs-string">&quot;reconciler group&quot;</span>: <span class="hljs-string">&quot;apps.lailin.xyz&quot;</span>, <span class="hljs-string">&quot;reconciler kind&quot;</span>: <span class="hljs-string">&quot;Application&quot;</span>, <span class="hljs-string">&quot;worker count&quot;</span>: 1&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬éƒ¨ç½²ä¸€ä¸ªæµ‹è¯•çš„ crd <code>kubectl apply -f config/samples/apps_v1_application.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps.lailin.xyz/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Application</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">application-sample</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-comment"># Add fields here</span><br>  <span class="hljs-attr">product:</span> <span class="hljs-string">test</span><br></code></pre></td></tr></table></figure><p>ç„¶åå¯ä»¥çœ‹åˆ°ä¹‹å‰å†™çš„æ—¥å¿—é€»è¾‘å·²ç»è§¦å‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">2021-04-25T21:57:12.618+0800    INFO    controllers.Application app changed     &#123;<span class="hljs-string">&quot;ns&quot;</span>: <span class="hljs-string">&quot;default&quot;</span>&#125;<br></code></pre></td></tr></table></figure><h3 id="Kubebuilder-æ³¨é‡Š"><a href="#Kubebuilder-æ³¨é‡Š" class="headerlink" title="Kubebuilder æ³¨é‡Š"></a>Kubebuilder æ³¨é‡Š</h3><p>åœ¨ç”Ÿæˆçš„ä»£ç å½“ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾ˆå¤š <code>//+kubebuilder:xxx</code> å¼€å¤´çš„æ³¨é‡Šï¼Œå¯¹ Go æ¯”è¾ƒç†Ÿæ‚‰çš„åŒå­¦åº”è¯¥çŸ¥é“è¿™äº›æ³¨é‡Šæ˜¯ç»™å¯¹åº”çš„ä»£ç ç”Ÿæˆå™¨æœåŠ¡çš„ï¼Œåœ¨ Go ä¸­æœ‰ä¸€ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„å¥—è·¯å°±æ˜¯åˆ©ç”¨ <code>go gennerate</code>ç”Ÿæˆå¯¹åº”çš„ go ä»£ç ã€‚</p><p>kubebuilder ä½¿ç”¨ <a href="https://cloudnative.to/reference/controller-gen.html">controller-gen</a> ç”Ÿæˆä»£ç å’Œå¯¹åº”çš„ yaml æ–‡ä»¶ï¼Œè¿™å…¶ä¸­ä¸»è¦åŒ…å« CRD ç”Ÿæˆã€éªŒè¯ã€å¤„ç†è¿˜æœ‰ WebHook çš„ RBAC çš„ç”ŸæˆåŠŸèƒ½ï¼Œä¸‹é¢æˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹ï¼Œå®Œæ•´ç‰ˆå¯ä»¥çœ‹ kubebuilder çš„<a href="https://master.book.kubebuilder.io/quick-start.html">å®˜æ–¹æ–‡æ¡£</a></p><ul><li>CRD ç”Ÿæˆ<ul><li><code>//+kubebuilder:subresource:status</code> å¼€å¯ status å­èµ„æºï¼Œæ·»åŠ è¿™ä¸ªæ³¨é‡Šä¹‹åå°±å¯ä»¥å¯¹ <code>status</code>è¿›è¡Œæ›´æ–°æ“ä½œäº†</li><li><code>//+groupName=nodes.lailin.xyz</code> æŒ‡å®š groupname</li><li><code>//+kubebuilder:printcolumn</code> ä¸º <code>kubectl get xxx</code> æ·»åŠ ä¸€åˆ—ï¼Œè¿™ä¸ªæŒºæœ‰ç”¨çš„</li><li>â€¦â€¦</li></ul></li><li>CRD éªŒè¯ï¼Œåˆ©ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ ä¸€äº›æ³¨é‡Šï¼Œå°±ç»™å¯ä»¥å®Œæˆå¤§éƒ¨åˆ†éœ€è¦æ ¡éªŒçš„åŠŸèƒ½<ul><li><code>//+kubebuilder:default:=&lt;any&gt;</code> ç»™å­—æ®µè®¾ç½®é»˜è®¤å€¼</li><li><code>//+kubebuilder:validation:Pattern:=string</code> ä½¿ç”¨æ­£åˆ™éªŒè¯å­—æ®µ</li><li>â€¦â€¦</li></ul></li><li>Webhook<ul><li><code>//+kubebuilder:webhook</code> ç”¨äºæŒ‡å®š webhook å¦‚ä½•ç”Ÿæˆï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥æŒ‡å®šåªç›‘å¬ <code>Update</code> äº‹ä»¶çš„ webhook</li></ul></li><li>RBAC ç”¨äºç”Ÿæˆ rbac çš„æƒé™<ul><li><code>//+kubebuilder:rbac</code> </li></ul></li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ç¯‡æ–‡ç« ä¸»è¦è®²è§£äº† <code>kubebuilder</code>çš„å®‰è£…ä½¿ç”¨æ–¹å¼ï¼Œä»¥åŠæ¶‰åŠåˆ°çš„ä¸€äº›ç®€å•çš„æ¦‚å¿µï¼Œé¡¹ç›®ç›®å½•ç»“æ„çš„è¯´æ˜ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« æˆ‘ä»¬å°±ä¸€èµ·æ¥å®ç°ä¸€ä¸ªçœŸå®çš„ Operator éœ€æ±‚</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span>Operator æ¨¡å¼ | Kubernetes: <a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/">https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/</a><br><a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span>kubebuilder å®˜æ–¹æ–‡æ¡£, è¿™ä¸ªæ˜¯ master åˆ†æ”¯çš„æ–‡æ¡£ï¼Œå¾… 3.0 å‘å¸ƒåå»æ‰ master å³å¯: <a href="https://master.book.kubebuilder.io/quick-start.html">https://master.book.kubebuilder.io/quick-start.html</a><br><a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:3" class="footnote-text"><span>operator-sdk: <a href="https://sdk.operatorframework.io/">https://sdk.operatorframework.io/</a><br><a href="#fnref:3" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:4" class="footnote-text"><span>æ·±å…¥è§£æ Kubebuilderï¼šè®©ç¼–å†™ CRD å˜å¾—æ›´ç®€å•: <a href="https://developer.aliyun.com/article/719215">https://developer.aliyun.com/article/719215</a><br><a href="#fnref:4" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>kubernetes ç³»åˆ—</category>
      
      <category>Kubernetes æ‰©å±•: Operator</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>k8s</tag>
      
      <tag>operator</tag>
      
      <tag>kubernetes</tag>
      
      <tag>äº‘åŸç”Ÿ</tag>
      
      <tag>kubebuilder</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2. Kind: å¦‚ä½•å¿«é€Ÿæ­å»ºæœ¬åœ° K8s å¼€å‘ç¯å¢ƒï¼Ÿ</title>
    <link href="/post/operator-02-use-kind-create-k8s-local-cluster.html"/>
    <url>/post/operator-02-use-kind-create-k8s-local-cluster.html</url>
    
    <content type="html"><![CDATA[<p>ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬è®²åˆ°äº† k8s ä¸­æœ‰å“ªäº›æ‰©å±•ç‚¹ï¼Œå¼€å§‹ Operator å¼€å‘ç›¸å…³ä¹‹å‰æˆ‘ä»¬éœ€è¦å…ˆæŠŠæœ¬åœ°ç¯å¢ƒæ­å»ºå¥½</p><h2 id="ä¸€ã€ä¾èµ–æ£€æŸ¥"><a href="#ä¸€ã€ä¾èµ–æ£€æŸ¥" class="headerlink" title="ä¸€ã€ä¾èµ–æ£€æŸ¥"></a>ä¸€ã€ä¾èµ–æ£€æŸ¥</h2><p>å¼€å§‹ä¹‹å‰éœ€è¦å…ˆæ£€æŸ¥ä¸€ä¸‹</p><ul><li>æ˜¯å¦å·²ç»å®‰è£…å¥½äº† Docker ç¯å¢ƒ<ul><li>å¦‚æœè¿˜æ²¡å®‰è£… Mac/Windows çš„ç”¨æˆ·å¯ä»¥ç›´æ¥å®‰è£… <a href="https://www.docker.com/products/docker-desktop">Docker Desktop</a></li><li>Windows ç”¨æˆ·æ¨èä½¿ç”¨ <a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">WSL2</a></li></ul></li><li>æ˜¯å¦å·²ç»å®‰è£…å¥½äº† Golang ç¯å¢ƒ, Go ç‰ˆæœ¬æœ€å¥½ &gt;= 1.15<ul><li>å¦‚æœæ²¡æœ‰å¯ä»¥å‚è€ƒ<a href="https://learn.go.dev/">å®˜æ–¹æ–‡æ¡£</a>è¿›è¡Œå®‰è£…</li></ul></li></ul><h2 id="äºŒã€ä½¿ç”¨-Kind-æ­å»ºæœ¬åœ°å¼€å‘ç¯å¢ƒ"><a href="#äºŒã€ä½¿ç”¨-Kind-æ­å»ºæœ¬åœ°å¼€å‘ç¯å¢ƒ" class="headerlink" title="äºŒã€ä½¿ç”¨ Kind æ­å»ºæœ¬åœ°å¼€å‘ç¯å¢ƒ"></a>äºŒã€ä½¿ç”¨ Kind æ­å»ºæœ¬åœ°å¼€å‘ç¯å¢ƒ</h2><h3 id="2-1-å®‰è£…"><a href="#2-1-å®‰è£…" class="headerlink" title="2.1 å®‰è£…"></a>2.1 å®‰è£…</h3><p>å¦‚æœæœ¬åœ°å­˜åœ¨ Golang ç¯å¢ƒå¯ä»¥ç›´æ¥æ‰§è¡Œä¸‹æ–¹å‘½ä»¤è¿›è¡Œå®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">GO111MODULE=<span class="hljs-string">&quot;on&quot;</span> go get sigs.k8s.io/kind@v0.10.0 &amp;&amp; kind create cluster<br></code></pre></td></tr></table></figure><p>å¦‚æœä¸æƒ³é€šè¿‡æºç å®‰è£…å¯ä»¥æŸ¥çœ‹<a href="https://kind.sigs.k8s.io/docs/user/quick-start/#installation">å®˜æ–¹æ–‡æ¡£</a>ç›´æ¥å®‰è£…ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶</p><p>æ‰§è¡Œä¸‹æ–¹å‘½ä»¤å¯ä»¥è¾“å‡º kind çš„ç‰ˆæœ¬å°±è¡¨ç¤ºå®‰è£…å¥½äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ kind version<br>kind v0.10.0 go1.16 linux/amd64<br></code></pre></td></tr></table></figure><h3 id="2-2-åˆ›å»ºä¸€ä¸ª-K8s-é›†ç¾¤"><a href="#2-2-åˆ›å»ºä¸€ä¸ª-K8s-é›†ç¾¤" class="headerlink" title="2.2 åˆ›å»ºä¸€ä¸ª K8s é›†ç¾¤"></a>2.2 åˆ›å»ºä¸€ä¸ª K8s é›†ç¾¤</h3><p>ä½¿ç”¨ä¸‹æ–¹å‘½ä»¤å³å¯åˆ›å»ºä¸€ä¸ªç®€å•çš„å•èŠ‚ç‚¹ K8s é›†ç¾¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">node create clutser<br></code></pre></td></tr></table></figure><p>é›†ç¾¤çš„åˆ›å»ºæ—¶é—´å’Œä½ çš„ç½‘ç»œç¯å¢ƒä»¥åŠæœºå™¨çš„æ€§èƒ½æœ‰å…³ç³»ï¼Œkind ä¼šå» docker hub ä¸Šæ‹‰å– <a href="https://hub.docker.com/r/kindest/node/tags?page=1&amp;ordering=last_updated">kindest/node</a> é•œåƒï¼Œè¿™ä¸ªé•œåƒå¤§æ¦‚æœ‰ 400M çš„å¤§å°ï¼Œå½“å‡ºç°ä¸‹æ–¹çš„æç¤ºçš„æ—¶å€™å°±è¯´æ˜é›†ç¾¤åˆ›å»ºå¥½äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ kind create cluster<br>Creating cluster <span class="hljs-string">&quot;kind&quot;</span> ...<br> âœ“ Ensuring node image (kindest/node:v1.20.2) ğŸ–¼<br> âœ“ Preparing nodes ğŸ“¦<br> âœ“ Writing configuration ğŸ“œ<br> âœ“ Starting control-plane ğŸ•¹ï¸<br> âœ“ Installing CNI ğŸ”Œ<br> âœ“ Installing StorageClass ğŸ’¾<br>Set kubectl context to <span class="hljs-string">&quot;kind-kind&quot;</span><br>You can now use your cluster with:<br><br>kubectl cluster-info --context kind-kind<br><br>Thanks <span class="hljs-keyword">for</span> using kind! ğŸ˜Š<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>kind get clusters</code> è·å–æˆ‘ä»¬åˆ›å»ºçš„é›†ç¾¤åˆ—è¡¨ï¼Œkind æ”¯æŒåˆ›å»ºå¤šä¸ªé›†ç¾¤ï¼Œä¸æ‰‹åŠ¨æŒ‡å®šé›†ç¾¤åç§°çš„æ—¶å€™é»˜è®¤åä¸º <code>kind</code> ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åƒä¸‹é¢ä¸€æ ·åœ¨åˆ›å»ºé›†ç¾¤çš„æ—¶å€™ä½¿ç”¨ <code>--name</code> æŒ‡å®šé›†ç¾¤åç§°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kind create cluster --name mohuishou<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¸¤ä¸ªé›†ç¾¤éƒ½åˆ›å»ºå¥½äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ kind get clusters<br>kind<br>mohuishou<br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªé›†ç¾¤ï¼Œæ‰€ä»¥å¯ä»¥å…ˆä½¿ç”¨ <code>kind delete clusters mohuishou</code> å°†åˆšåˆšåˆ›å»ºçš„é›†ç¾¤å…ˆåˆ é™¤æ‰</p><h3 id="2-3-ä½¿ç”¨é›†ç¾¤"><a href="#2-3-ä½¿ç”¨é›†ç¾¤" class="headerlink" title="2.3 ä½¿ç”¨é›†ç¾¤"></a>2.3 ä½¿ç”¨é›†ç¾¤</h3><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ <code>kubectl</code> çš„å¸¸ç”¨å‘½ä»¤æ˜¯å¦éƒ½å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œå¹¶ä¸”éƒ¨ç½²ä¸€ä¸ªç®€å•çš„ web æœåŠ¡è¯•è¯•</p><h4 id="æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯"><a href="#æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯"></a>æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ kubectl  cluster-info --context kind-kind<br>Kubernetes master is running at https://127.0.0.1:41801<br>KubeDNS is running at https://127.0.0.1:41801/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy<br><br>To further debug and diagnose cluster problems, use <span class="hljs-string">&#x27;kubectl cluster-info dump&#x27;</span>.<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ k8s  master åœ°å€å’Œ dns çš„åœ°å€ï¼Œæ³¨æ„ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬åªåˆ›å»ºä¸€ä¸ªé›†ç¾¤ä¸éœ€è¦æŒ‡å®š <code>--context cluster name</code> ä½†æ˜¯åˆ›å»ºäº†å¤šä¸ªé›†ç¾¤æ—¶è¿™ä¸ªåŸºæœ¬å°±æ˜¯å¿…é¡»çš„ä¸€ä¸ªå‘½ä»¤äº†ã€‚å¦‚æœä¸åŠ è¿™ä¸ªå‚æ•°å¯èƒ½ä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">The connection to the server localhost:8080 was refused - did you specify the right host or port?<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸º <code>kubectl</code>é»˜è®¤è¿æ¥çš„ apiserver åœ°å€æ˜¯ <code>localhost:8080</code>ä½†æ˜¯æˆ‘ä»¬çš„ <code>apiserver</code> åœ°å€ä¸æ˜¯è¿™ä¸ªæ‰€ä»¥æŠ¥é”™ã€‚</p><p><strong>ä¸ºä»€ä¹ˆæˆ‘ä»¬ä½¿ç”¨ <code>--context cluster-name</code> å°±å¯ä»¥äº†å‘¢ï¼Ÿ</strong></p><p>è¿™æ˜¯å› ä¸º kind åœ¨åˆ›å»ºé›†ç¾¤çš„æ—¶å€™ä¼šä¿®æ”¹ <code>$HOME/.kube/config</code> çš„é…ç½®ï¼Œå°†é›†ç¾¤çš„ apiserver åœ°å€ï¼Œè¯ä¹¦ç­‰ç›¸å…³ä¿¡æ¯éƒ½è‡ªåŠ¨å†™å…¥è¿›å»äº†</p><p><strong>æ¯æ¬¡å‘½ä»¤éƒ½è¦åŠ ä¸Šè¿™ä¸ªå‚æ•°å¥½éº»çƒ¦æ€ä¹ˆåŠï¼Ÿ</strong></p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>kubectl config use-context context-name</code> æ¥è¿›è¡Œè®¾ç½®ï¼Œè®¾ç½®å¥½äº†ä¹‹åæˆ‘ä»¬åç»­å°±ä¸ç”¨æ¯æ¬¡éƒ½åŠ ä¸Š <code>â€“context</code> çš„å‚æ•°äº†ï¼ŒåŒæ—¶è¿˜å¯ä»¥é€šè¿‡ <code>kubectl config current-context</code> æŸ¥è¯¢æˆ‘ä»¬å½“å‰é»˜è®¤æ“ä½œçš„é›†ç¾¤æ˜¯å“ªä¸€ä¸ª</p><h4 id="æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨"><a href="#æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨" class="headerlink" title="æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨"></a>æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨</h4><p>å¯ä»¥å‘ç°æˆ‘ä»¬éƒ¨ç½²çš„æ˜¯ä¸€ä¸ªå•èŠ‚ç‚¹çš„ <code>v1.20.2</code> çš„é›†ç¾¤</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">â¯ kubectl get no<br>NAME                 STATUS   ROLES                  AGE   <span class="hljs-keyword">VERSION</span><br>kind-control-plane   Ready    control-plane,<span class="hljs-keyword">master</span>   <span class="hljs-title">20m</span>   v1.<span class="hljs-number">20.2</span><br></code></pre></td></tr></table></figure><h4 id="éƒ¨ç½²ä¸€ä¸ª-Nginx-æœåŠ¡"><a href="#éƒ¨ç½²ä¸€ä¸ª-Nginx-æœåŠ¡" class="headerlink" title="éƒ¨ç½²ä¸€ä¸ª Nginx æœåŠ¡"></a>éƒ¨ç½²ä¸€ä¸ª Nginx æœåŠ¡</h4><p>ä½¿ç”¨ä¸‹æ–¹ä»£ç åˆ›å»ºä¸€ä¸ª <code>nginx.yml</code> æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨ <code>kubectl apply -f nginx.yml</code> å°±å¯ä»¥å®Œæˆéƒ¨ç½²äº†</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-deployment</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.14.2</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br><br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹å½“å‰ deployment çš„çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ kubectl get deployment<br>NAME               READY   UP-TO-DATE   AVAILABLE   AGE<br>nginx-deployment   0/3     3            0           39s<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹ pod çš„çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ kubectl get pods         <br>NAME                                READY   STATUS    RESTARTS   AGE<br>nginx-deployment-66b6c48dd5-2s5cb   1/1     Running   0          84s<br>nginx-deployment-66b6c48dd5-8wf8b   1/1     Running   0          84s<br>nginx-deployment-66b6c48dd5-zc6vd   1/1     Running   0          84s<br></code></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬æ²¡æœ‰åšæœåŠ¡æš´éœ²ï¼Œæ‰€ä»¥æ˜¯ä¸èƒ½ç›´æ¥è®¿é—®å¯¹åº”çš„æœåŠ¡çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code>kubectl</code> æä¾›çš„ç«¯å£è½¬å‘åŠŸèƒ½æ¥è®²æµé‡ä»æœ¬åœ°è½¬å‘ç»™ k8s é›†ç¾¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ kubectl port-forward nginx-deployment-66b6c48dd5-2s5cb 30080:80<br>Forwarding from 127.0.0.1:30080 -&gt; 80<br>Forwarding from [::1]:30080 -&gt; 80<br>Handling connection <span class="hljs-keyword">for</span> 30080<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è®¿é—® <a href="http://localhost:30080">http://localhost:30080</a> å°±ä¼šå‘ç°è¿™ä¸ªç†Ÿæ‚‰çš„ nginx ç•Œé¢</p><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/20210424210804.png" alt="image-20210424210804343"></p><p>åˆ°è¿™é‡Œå¯ä»¥å‘ç°æˆ‘ä»¬é›†ç¾¤å·²ç»æ˜¯å¯ä»¥ä½¿ç”¨äº†</p><h3 id="2-4-è¿›é˜¶ä½¿ç”¨"><a href="#2-4-è¿›é˜¶ä½¿ç”¨" class="headerlink" title="2.4 è¿›é˜¶ä½¿ç”¨"></a>2.4 è¿›é˜¶ä½¿ç”¨</h3><h4 id="2-4-1-åˆ›å»ºä¸€ä¸ªå¤šèŠ‚ç‚¹çš„é›†ç¾¤"><a href="#2-4-1-åˆ›å»ºä¸€ä¸ªå¤šèŠ‚ç‚¹çš„é›†ç¾¤" class="headerlink" title="2.4.1 åˆ›å»ºä¸€ä¸ªå¤šèŠ‚ç‚¹çš„é›†ç¾¤"></a>2.4.1 åˆ›å»ºä¸€ä¸ªå¤šèŠ‚ç‚¹çš„é›†ç¾¤</h4><p><code>kind</code> é»˜è®¤åˆ›å»ºçš„æ˜¯ä¸€ä¸ªå•èŠ‚ç‚¹çš„é›†ç¾¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®åˆ›å»ºä¸€ä¸ªé«˜å¯ç”¨çš„é›†ç¾¤ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª 3 ä¸ª master  èŠ‚ç‚¹ï¼Œä¸¤ä¸ª worker èŠ‚ç‚¹çš„é›†ç¾¤</p><p><code>kind create cluster --name mohuishou-ha --config kind-ha.yml</code></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-attr">kind:</span> Cluster<br><span class="hljs-attr">apiVersion:</span> kind.x-k8s.io/v1alpha4<br><span class="hljs-attr">nodes:</span><br>  - <span class="hljs-attr">role:</span> control-plane<br>  - <span class="hljs-attr">role:</span> control-plane<br>  - <span class="hljs-attr">role:</span> control-plane<br>  - <span class="hljs-attr">role:</span> worker<br>  - <span class="hljs-attr">role:</span> worker<br></code></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹èŠ‚ç‚¹å³å¯éªŒè¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ kubectl --context kind-mohuishou-ha get no                 <br>NAME                          STATUS   ROLES                  AGE     VERSION<br>mohuishou-ha-control-plane    Ready    control-plane,master   16m     v1.20.2<br>mohuishou-ha-control-plane2   Ready    control-plane,master   14m     v1.20.2<br>mohuishou-ha-control-plane3   Ready    control-plane,master   13m     v1.20.2<br>mohuishou-ha-worker           Ready    &lt;none&gt;                 5m52s   v1.20.2<br>mohuishou-ha-worker2          Ready    &lt;none&gt;                 5m52s   v1.20.2<br></code></pre></td></tr></table></figure><h4 id="2-4-2-Load-Image"><a href="#2-4-2-Load-Image" class="headerlink" title="2.4.2 Load Image"></a>2.4.2 Load Image</h4><p>ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬åœ¨ k8s å†…éƒ¨ç½²åº”ç”¨éœ€è¦å…ˆæŠŠå®¹å™¨é•œåƒæ¨é€åˆ°åˆ°é•œåƒä»“åº“å½“ä¸­ï¼Œè¿™æ ·åœ¨æœ¬åœ°å¼€å‘çš„æ—¶å€™ç›¸å¯¹æ¥è¯´ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œç‰¹åˆ«æ˜¯é•œåƒæ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œå¾€è¿”ä¼šæœ‰ä¸¤æ¬¡ç½‘ç»œæ¶ˆè€—ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>kind</code> load é•œåƒçš„åŠŸèƒ½ç›´æ¥æŠŠé•œåƒåŠ è½½åˆ°é›†ç¾¤ä¸­</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kind load docker-image my-custom-image-0 my-custom-image-1 --name kind<br></code></pre></td></tr></table></figure><p><strong>æ’å‘æŒ‡å—ï¼šload image æˆåŠŸï¼Œä½†æ˜¯éƒ¨ç½² pod æŠ¥é”™</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Failed to pull image <span class="hljs-string">&quot;controller:latest&quot;</span>: rpc error: code = Unknown desc = failed to pull and unpack image <span class="hljs-string">&quot;docker.io/library/controller:latest&quot;</span>: failed to resolve reference <span class="hljs-string">&quot;docker.io/library/controller:latest&quot;</span>: pull access denied, repository does not exist or may require authorization: server message: insufficient_scope: authorization failed<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªé—®é¢˜ä¹‹å‰å¡äº†æˆ‘å¾ˆä¹…ï¼Œè¿˜æ˜¯æœ‰ç‚¹å‘</p><ol><li><p>è¿›å…¥èŠ‚ç‚¹æŸ¥çœ‹: é•œåƒæ˜¯å¦å­˜åœ¨</p><ul><li><p>è·å–èŠ‚ç‚¹å</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">â–¶ kubectl get nodes<br>NAME                 STATUS   ROLES                  AGE    VERSION<br>kind-control-plane   Ready    control-plane,master   2d1h   v1.20.2<br></code></pre></td></tr></table></figure></li><li><p>è¿›å…¥ç»ˆç«¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker <span class="hljs-built_in">exec</span> -it kind-control-plane bash<br></code></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹é•œåƒæ˜¯å¦å­˜åœ¨ï¼Œkind åˆ›å»ºçš„é›†ç¾¤ä½¿ç”¨çš„æ˜¯ containerd æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ <code>crictl</code> å‘½ä»¤æ¥è·å–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">crictl img | grep controller<br>docker.io/library/controller   latest    421cbf77618ba       72.1MB<br></code></pre></td></tr></table></figure></li></ul></li><li><p>å¦‚æœé•œåƒå­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢çœ‹åˆ°çš„æƒ…å†µï¼Œè¿™æ—¶å€™å°±è¦æ£€æŸ¥ä¸€ä¸‹æˆ‘ä»¬éƒ¨ç½²çš„ yaml æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl -n node-pool-operator-system  get deployment -o yaml | grep imagePullPolicy<br></code></pre></td></tr></table></figure><p>æ˜¯å¦å­˜åœ¨: <code>imagePullPolicy: Always</code> å¦‚æœæˆ‘ä»¬æ²¡æœ‰æ”¹ yaml çš„è¯é»˜è®¤ä¼šæ˜¯è¿™ä¸ªé…ç½®ï¼Œè¿™ä¸ªé…ç½®ä¼šå¯¼è‡´æ¯æ¬¡éƒ½å»é•œåƒä»“åº“æ‹‰å–é•œåƒï¼Œæ”¹æˆ <code>imagePullPolicy: IfNotPresent</code> å°±å¯ä»¥äº†</p></li><li><p>å¦‚æœé•œåƒä¸å­˜åœ¨ï¼šè¿™æ—¶å€™è¦æ£€æŸ¥ä¸€ä¸‹æœ‰æ²¡æœ‰æŒ‡å®š cluster-nameï¼Œåœ¨å­˜åœ¨å¤šä¸ªé›†ç¾¤çš„æƒ…å†µä¸‹å¯èƒ½æ²¡æœ‰åŠ è½½åˆ°æˆ‘ä»¬æƒ³è¦çš„é›†ç¾¤ï¼ŒåŠ ä¸Š <code>--name cluster-name</code> å³å¯</p></li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><code>kind</code> åœ¨åˆ›å»ºé›†ç¾¤çš„æ—¶å€™å®é™…ä¸Šä½¿ç”¨çš„æ˜¯ <code>kubeadm</code> æ‰€ä»¥è¿˜å¯ä»¥ä¿®æ”¹ <code>kubeadm</code> çš„é…ç½®æ¥ä¿®æ”¹é»˜è®¤çš„é•œåƒåœ°å€ï¼ŒèŠ‚ç‚¹æ ‡ç­¾æ±¡ç‚¹ç­‰ä¿¡æ¯ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜å¯ä»¥é…ç½® <code>PV/PVC</code> <code>CNI</code> æ’ä»¶ç­‰é…ç½®ï¼Œå¦‚æœæœ‰éœ€æ±‚çš„è¯å¯ä»¥æŸ¥é˜… kind çš„å®˜æ–¹æ–‡æ¡£</p><p>ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ kind ä¸æ”¯æŒç»™è¿è¡Œçš„é›†ç¾¤æ·»åŠ èŠ‚ç‚¹ï¼Œå¦‚æœéœ€è¦å¤šèŠ‚ç‚¹é›†ç¾¤çš„è¯å¾—æå‰è§„åˆ’å¥½èŠ‚ç‚¹æ•°é‡</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ul><li>kind â€“ Configuration<a href="https://kind.sigs.k8s.io/docs/user/configuration/">https://kind.sigs.k8s.io/docs/user/configuration/</a></li><li>Docker Desktop<a href="https://www.docker.com/products/docker-desktop">https://www.docker.com/products/docker-desktop</a></li><li>WSL2<a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">https://docs.microsoft.com/en-us/windows/wsl/install-win10</a></li><li>Getting Started - go.dev <a href="https://learn.go.dev/">https://learn.go.dev/</a></li><li>ä½¿ç”¨ Kind æ­å»ºä½ çš„æœ¬åœ° Kubernetes é›†ç¾¤<a href="https://segmentfault.com/a/1190000018720465">https://segmentfault.com/a/1190000018720465</a></li></ul><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>kubernetes ç³»åˆ—</category>
      
      <category>Kubernetes æ‰©å±•: Operator</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>k8s</tag>
      
      <tag>kubernetes</tag>
      
      <tag>äº‘åŸç”Ÿ</tag>
      
      <tag>kind</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>1. Operatoræ¦‚è¿°: å¦‚ä½•å¯¹ Kubernetes è¿›è¡Œæ‰©å±•</title>
    <link href="/post/operator-01-overview.html"/>
    <url>/post/operator-01-overview.html</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘æœ‰ç‚¹å¤ªå¿™äº†ï¼Œæ‰€ä»¥æ›´æ–°æ¯”è¾ƒæ…¢ï¼Œç„¶åä¹‹å‰ Go è¿›é˜¶è®­ç»ƒè¥æ›´æ–°çš„æœ‰ç‚¹å¤ªä¹…äº†ï¼Œå‡†å¤‡æ¢æ¢è„‘å­ï¼Œè™½ç„¶æˆ‘å·¥ä½œä¸Šä¸€ç›´å’Œ Kubernetes æ‰“äº¤é“ä½†æ˜¯è¿˜ä¸€ç›´æ²¡æœ‰æ›´æ–°è¿‡è¿™ä¸€å—çš„ç›¸å…³å†…å®¹ï¼Œæ‰€ä»¥å°±æœ‰äº†æ¥ä¸‹æ¥çš„è¿™ä¸ªç³»åˆ—ã€‚</p><blockquote><p>PS: å¯¹äºè¿™ä¸€å—ä½œè€…æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªåˆå­¦è€…ï¼Œæœ‰æ‰€é”™æ¼ï¼Œåœ¨æ‰€éš¾å…ï¼Œå¸Œæœ›å‘ç°çš„å¤§ä½¬å¯ä»¥å¸®åŠ©æŒ‡æ­£ï¼Œä¸‡åˆ†æ„Ÿè°¢ </p></blockquote><p>Kubernetesæ‰©å±•: Operator è¿™ä¸ªç³»åˆ—æ–‡ç« ä¸»è¦é¢å‘çš„æ˜¯å¯¹ Kubernetes çš„åŸºæœ¬æ¦‚å¿µå·²ç»æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œæƒ³å¯¹ Kubernetes è¿›è¡Œä¸€äº›æ‰©å±•å¼€å‘æˆ–è€…æ˜¯å¯¹ Kubernetes çš„å·¥ä½œæ¨¡å¼èƒ½å¤Ÿæœ‰æ›´æ·±å…¥äº†è§£çš„åŒå­¦ï¼ˆPSï¼šå’Œæˆ‘å·®ä¸å¤šï¼‰ã€‚è¿™ä¸ªå°ç³»åˆ—ä¼šæ›´æ–° 9 - 10 ç¯‡æ–‡ç« ï¼Œè¿™æ˜¯ç¬¬ä¸€ç¯‡ <strong>Operatoræ¦‚è¿°: å¦‚ä½•å¯¹ Kubernetes è¿›è¡Œæ‰©å±•</strong>ï¼Œæ¥ä¸‹æ¥ä¸¤å‘¨å·¥ä½œæ—¥æ¯å¤©ä¼šæ›´æ–°ä¸€ç¯‡ï¼Œæƒ³è¦åŠæ—¶è·å–æ›´æ–°å¯ä»¥ç§»åŠ¨åˆ°æ–‡ç« åº•éƒ¨å…³æ³¨å¾®ä¿¡è®¢é˜…å·ã€‚</p><h2 id="Kubernetes-æœ‰å“ªäº›æ‰©å±•ç‚¹ï¼Ÿ"><a href="#Kubernetes-æœ‰å“ªäº›æ‰©å±•ç‚¹ï¼Ÿ" class="headerlink" title="Kubernetes  æœ‰å“ªäº›æ‰©å±•ç‚¹ï¼Ÿ"></a>Kubernetes  æœ‰å“ªäº›æ‰©å±•ç‚¹ï¼Ÿ</h2><p>Kubernetes æ˜¯ä¸€ä¸ªå¯ç§»æ¤çš„ã€å¯æ‰©å±•çš„å¼€æºå¹³å°ï¼Œç”¨äºç®¡ç†å®¹å™¨åŒ–çš„å·¥ä½œè´Ÿè½½å’ŒæœåŠ¡ï¼Œå¯ä¿ƒè¿›å£°æ˜å¼é…ç½®å’Œè‡ªåŠ¨åŒ–ã€‚ Kubernetes æ‹¥æœ‰ä¸€ä¸ªåºå¤§ä¸”å¿«é€Ÿå¢é•¿çš„ç”Ÿæ€ç³»ç»Ÿã€‚Kubernetes çš„æœåŠ¡ã€æ”¯æŒå’Œå·¥å…·å¹¿æ³›å¯ç”¨<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="Kubernetes æ˜¯ä»€ä¹ˆï¼Ÿhttps://kubernetes.io/zh/docs/concepts/overview/what-is-kubernetes/">[1]</span></a></sup>ã€‚</p><p>è™½ç„¶ç°åœ¨ Kubernetes å·²ç»æ˜¯å®¹å™¨ç¼–æ’çš„äº‹å®æ ‡å‡†ï¼Œå…¶æœ¬èº«çš„åŠŸèƒ½ä¹Ÿéå¸¸ä¸°å¯Œå¹¶ä¸”çµæ´»ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½æ»¡è¶³æ‰€æœ‰äººçš„éœ€æ±‚ï¼Œåœ¨é‡åˆ° Kubernetes æä¾›çš„èƒ½åŠ›æ— æ³•æ»¡è¶³æˆ‘ä»¬éœ€æ±‚çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨å…¶å¼ºå¤§çš„æ‰©å±•èƒ½åŠ›è¿›è¡Œå®šåˆ¶ã€‚</p><p>æ‰€ä»¥é—®é¢˜æ¥äº†: <strong>Kubernetes  æœ‰å“ªäº›æ‰©å±•ç‚¹å‘¢ï¼Ÿ</strong></p><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/20210429235903.png" alt="kubernate æ‰©å±•"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä»å®¢æˆ·ç«¯åˆ°åº•å±‚å®¹å™¨è¿è¡Œæ—¶ï¼Œç»å¤§éƒ¨åˆ†åœ°æ–¹ Kubernetes éƒ½ä¸ºæˆ‘ä»¬é¢„ç•™äº†æ‰©å±•ç‚¹ï¼Œæˆ‘ä»¬ä»ä¸Šå¾€ä¸‹ä¸€ä¸ªä¸€ä¸ªçš„æ¥çœ‹</p><h3 id="1-kubectl"><a href="#1-kubectl" class="headerlink" title="1. kubectl"></a>1. kubectl</h3><p>kubectl æ˜¯æˆ‘ä»¬å¹³æ—¶å’Œ Kubernetes äº¤äº’ä½¿ç”¨çš„æœ€å¤šçš„å®¢æˆ·ç«¯å·¥å…·ï¼Œå¸¸è§çš„è¿ç»´æ“ä½œéƒ½ä¼šé€šè¿‡ kubectl æ¥å®Œæˆï¼Œkubectl ä¸ºæˆ‘ä»¬æä¾›äº†æ’ä»¶æœºåˆ¶æ¥æ–¹ä¾¿æ‰©å±•ã€‚</p><p>kubectl æ’ä»¶å…¶å®å°±æ˜¯ä»¥<code>kubectl-</code>ä¸ºå‰ç¼€çš„ä»»æ„å¯æ‰§è¡Œæ–‡ä»¶ ï¼Œæ‰§è¡Œ kubectl æ’ä»¶çš„æ—¶å€™å¯ä»¥é€šè¿‡ <code>kubectl æ’ä»¶å å‚æ•°</code> çš„æ–¹å¼è¿è¡Œæ’ä»¶ã€‚</p><p>å°±åƒ Ubuntu ä½¿ç”¨ apt ç®¡ç†è½¯ä»¶ï¼Œmac å¯ä»¥ä½¿ç”¨ brew ä¸€æ ·ï¼Œkubectl ä¹Ÿæœ‰ç±»ä¼¼çš„æ’ä»¶ç®¡ç†å·¥å…· krew <sup id="fnref:4" class="footnote-ref"><a href="#fn:4" rel="footnote"><span class="hint--top hint--rounded" aria-label="kubectl æ’ä»¶ç®¡ç†å·¥å…· krew https://github.com/kubernetes-sigs/krew">[4]</span></a></sup> ï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥ä» <a href="https://krew.sigs.Kubernetes.io/plugins/">https://krew.sigs.Kubernetes.io/plugins/</a> æŸ¥æ‰¾æ˜¯å¦å·²ç»å­˜åœ¨æˆ‘ä»¬éœ€è¦çš„æ’ä»¶ </p><h3 id="2-APIServer"><a href="#2-APIServer" class="headerlink" title="2. APIServer"></a>2. APIServer</h3><h4 id="èšåˆå±‚"><a href="#èšåˆå±‚" class="headerlink" title="èšåˆå±‚"></a>èšåˆå±‚</h4><p>ä» Kubernetes v1.7 ç‰ˆæœ¬ä¹‹å APIServer å¼•å…¥äº†èšåˆå±‚çš„åŠŸèƒ½ï¼Œè¿™ä¸ªåŠŸèƒ½å¯ä»¥è®©æ¯ä¸ªå¼€å‘è€…éƒ½èƒ½å¤Ÿå®ç°èšåˆ API æœåŠ¡æš´éœ²å®ƒä»¬éœ€è¦çš„æ¥å£ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦é‡æ–°ç¼–è¯‘ Kubernetes çš„ä»»ä½•ä»£ç <sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" aria-label="ä½ è¯¥å¦‚ä½•ä¸º Kubernetes å®šåˆ¶ç‰¹æ€§: https://draveness.me/cloud-native-kubernetes-extension/">[3]</span></a></sup>ã€‚</p><p>å¦‚æœæˆ‘ä»¬å°†ä¸‹é¢è¿™ä¸ªèµ„æºæäº¤ç»™ Kubernetes ä¹‹åï¼Œç”¨æˆ·åœ¨è®¿é—® API æœåŠ¡å™¨çš„ <code>/apis/metrics.Kubernetes.io/v1beta1</code> è·¯å¾„æ—¶ï¼Œä¼šè¢«è½¬å‘åˆ°é›†ç¾¤ä¸­çš„ <code>metrics-server.kube-system.svc</code> æœåŠ¡ä¸Š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apiregistration.Kubernetes.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">APIService</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">v1beta1.metrics.Kubernetes.io</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">service:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">metrics-server</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">group:</span> <span class="hljs-string">metrics.Kubernetes.io</span><br>  <span class="hljs-attr">version:</span> <span class="hljs-string">v1beta1</span><br>  <span class="hljs-attr">insecureSkipTLSVerify:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">groupPriorityMinimum:</span> <span class="hljs-number">100</span><br>  <span class="hljs-attr">versionPriority:</span> <span class="hljs-number">100</span><br></code></pre></td></tr></table></figure><h4 id="å‡†å…¥æ§åˆ¶"><a href="#å‡†å…¥æ§åˆ¶" class="headerlink" title="å‡†å…¥æ§åˆ¶"></a>å‡†å…¥æ§åˆ¶</h4><p>é™¤æ­¤ä¹‹å¤–æ— è®ºæ˜¯ä» kubectl è¿˜æ˜¯ client-go ç­‰å…¶ä»–å®¢æˆ·ç«¯å‘èµ·çš„è¯·æ±‚éƒ½ä¼šå‘é€åˆ° APIServer ç»è¿‡ è®¤è¯ -&gt;  é‰´æƒ -&gt; å‡†å…¥æ§åˆ¶ çš„æ­¥éª¤ï¼Œè¿™å…¶ä¸­çš„æ¯ä¸€æ­¥æˆ‘ä»¬éƒ½å¯ä»¥å¯¹å…¶è¿›è¡Œæ‰©å±•ï¼Œè€Œè¿™å…¶ä¸­ç”¨çš„æœ€å¤šçš„å°±æ˜¯å‡†å…¥æ§åˆ¶çš„æ‰©å±•ï¼Œè¿™ä¸€å—åç»­ä¼šä¸€ç¯‡æ–‡ç« è¯¦ç»†è®²åˆ°ã€‚</p><p>å‡†å…¥æ§åˆ¶å½“ä¸­åˆä¼šå…ˆç»è¿‡ï¼Œå˜æ›´å‡†å…¥æ§åˆ¶ MutatingAdmissionWebhookï¼Œç„¶åå†ç»è¿‡éªŒè¯å‡†å…¥æ§åˆ¶ ValidatingAdmissionWebhookï¼Œä»»ä½•ä¸€ä¸ªå‡†å…¥æ§åˆ¶å™¨è¿”å›äº†é”™è¯¯è¿™ä¸ªè¯·æ±‚éƒ½ä¼šå¤±è´¥ï¼Œä¾‹å¦‚è¿™ä¸¤ä¸ªå‡†å…¥æ§åˆ¶å™¨æˆ‘ä»¬å¯ä»¥åšå¾ˆå¤šäº‹æƒ…ï¼Œä¾‹å¦‚æ³¨å…¥ sidecarï¼ŒéªŒè¯èµ„æºï¼Œè°ƒæ•´ pod çš„é…é¢ç­‰ç­‰ã€‚</p><h3 id="3-Kubernetes-èµ„æº"><a href="#3-Kubernetes-èµ„æº" class="headerlink" title="3. Kubernetes èµ„æº"></a>3. Kubernetes èµ„æº</h3><p>æˆ‘ä»¬å¸¸ç”¨çš„ Deploymentã€Podã€Node ç­‰éƒ½æ˜¯ Kubernetes å®˜æ–¹æä¾›çš„å†…ç½®èµ„æºï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™å†…ç½®çš„èµ„æºæ— æ³•æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚çš„æ—¶å€™ï¼Œå°±å¯ä»¥ä½¿ç”¨ CustomResource ä¹Ÿå°±æ˜¯è‡ªå®šä¹‰èµ„æºã€‚è‡ªå®šä¹‰èµ„æºå¸¸å¸¸ä¼šå’Œ Controller ä¸€èµ·é…åˆä½¿ç”¨ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ä½¿ç”¨è‡ªå®šä¹‰èµ„æºçš„æ—¶å€™éœ€è¦æ€è€ƒä¸€ä¸‹å¦‚æœåªæ˜¯ä¸€äº›é…ç½®å¯èƒ½ ConfigMap ä¼šæ›´åŠ é€‚åˆï¼Œä¸è¦æ»¥ç”¨è¿™ä¸ªç‰¹æ€§ã€‚</p><h3 id="4-Controller-æ§åˆ¶å™¨"><a href="#4-Controller-æ§åˆ¶å™¨" class="headerlink" title="4. Controller æ§åˆ¶å™¨"></a>4. Controller æ§åˆ¶å™¨</h3><p>Kubernetes ä¸­èµ„æºçš„çŠ¶æ€çš„ç»´æŠ¤éƒ½æ˜¯ Controller æ¥å®ç°çš„ï¼ŒController ä¼šä¸æ–­çš„å°è¯•å°†ä¸€ä¸ªèµ„æºè°ƒæ•´ä¸ºæˆ‘ä»¬æè¿°çš„çŠ¶æ€ï¼Œè¿™å…¶å®ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å£°æ˜å¼ apiï¼Œå£°æ˜å¼ api èƒŒåå…·ä½“çš„æ´»éƒ½æ˜¯ Controller å¹²çš„ã€‚Controller ä¸€èˆ¬ä¼šé…åˆç€ CRD ä¸€èµ·ä½¿ç”¨ã€‚</p><h3 id="5-Schedule-è°ƒåº¦å™¨"><a href="#5-Schedule-è°ƒåº¦å™¨" class="headerlink" title="5. Schedule è°ƒåº¦å™¨"></a>5. Schedule è°ƒåº¦å™¨</h3><p>è°ƒåº¦å™¨æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ§åˆ¶å™¨ï¼Œè´Ÿè´£ç›‘è§† Pod å˜åŒ–å¹¶å°† Pod åˆ†æ´¾ç»™èŠ‚ç‚¹ï¼Œè°ƒåº¦å™¨å¯ä»¥è¢«ç›´æ¥æ›¿æ¢æ‰æˆ–è€…æ˜¯ä½¿ç”¨å¤šä¸ªè°ƒåº¦å™¨ï¼Œé™¤æ­¤ä¹‹å¤–å®˜æ–¹é»˜è®¤çš„è°ƒåº¦å™¨ä¹Ÿæ”¯æŒ WebHookã€‚<sup id="fnref:5" class="footnote-ref"><a href="#fn:5" rel="footnote"><span class="hint--top hint--rounded" aria-label="Scheduler extender https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/scheduler_extender.md">[5]</span></a></sup></p><h3 id="6-CNI-ç½‘ç»œæ’ä»¶"><a href="#6-CNI-ç½‘ç»œæ’ä»¶" class="headerlink" title="6. CNI ç½‘ç»œæ’ä»¶"></a>6. CNI ç½‘ç»œæ’ä»¶</h3><p>CNI ç½‘ç»œæ’ä»¶ï¼Œå…¨ç§° Container Network Interfaceï¼ˆå®¹å™¨ç½‘ç»œæ¥å£ï¼‰åŒ…å«ä¸€ç»„ç”¨äºå¼€å‘æ’ä»¶å»é…ç½® Linux å®¹å™¨ä¸­ç½‘å¡çš„æ¥å£å’Œæ¡†æ¶ã€‚ä¸€èˆ¬æˆ‘ä»¬ä¸ä¼šå»å¯¹ç½‘ç»œæ’ä»¶åšå®šåˆ¶å¼€å‘ï¼Œè€Œæ˜¯é‡‡ç”¨å¼€æºçš„ç»„ä»¶ï¼Œä¾‹å¦‚ Flannelã€Ciliumï¼Œå¦‚æœä½¿ç”¨äº‘æœåŠ¡çš„ Kubernetes è¿˜ä¼šé‡åˆ°ä¸€äº›å®šåˆ¶çš„ç½‘ç»œæ’ä»¶ï¼Œ ä¾‹å¦‚é˜¿é‡Œäº‘æœ‰ Terwayã€‚</p><h3 id="7-CSI-å­˜å‚¨æ’ä»¶"><a href="#7-CSI-å­˜å‚¨æ’ä»¶" class="headerlink" title="7. CSI å­˜å‚¨æ’ä»¶"></a>7. CSI å­˜å‚¨æ’ä»¶</h3><p>CSI å­˜å‚¨æ’ä»¶ï¼Œå…¨ç§° Container Storage Interfaceï¼Œå¯ä»¥é€šè¿‡ CSI æ¥å£æ”¯æŒä¸åŒçš„å­˜å‚¨ç±»å‹</p><h3 id="8-CRI-å®¹å™¨è¿è¡Œæ—¶"><a href="#8-CRI-å®¹å™¨è¿è¡Œæ—¶" class="headerlink" title="8. CRI å®¹å™¨è¿è¡Œæ—¶"></a>8. CRI å®¹å™¨è¿è¡Œæ—¶</h3><p>CRI å®¹å™¨è¿è¡Œæ—¶ï¼Œå…¨ç§° Container Runtime Interfaceï¼Œæ˜¯ä¸€ç»„ç”¨äºç®¡ç†å®¹å™¨è¿è¡Œæ—¶å’Œé•œåƒçš„ gRPC æ¥å£ï¼Œåˆ©ç”¨è¿™ä¸ªæ¥å£å¯ä»¥æ”¯æŒ dockerã€containerd ç­‰ä¸åŒçš„å®¹å™¨è¿è¡Œæ—¶</p><h2 id="Operator"><a href="#Operator" class="headerlink" title="Operator"></a>Operator</h2><p>Kubernetes æ˜¯ä¸€ä¸ªé«˜åº¦å¯æ‰©å±•çš„ç³»ç»Ÿï¼Œè™½ç„¶å®ƒçš„æ‰©å±•ç‚¹è¿™ä¹ˆå¤šï¼Œä½†æ˜¯ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬æ¥è§¦çš„æ¯”è¾ƒå¤šçš„è¿˜æ˜¯ è‡ªå®šä¹‰èµ„æºï¼Œæ§åˆ¶å™¨ï¼Œå‡†å…¥æ§åˆ¶ï¼Œæœ‰äº›è¿˜ä¼šå¯¹ kubectl å’Œ è°ƒåº¦å™¨åšä¸€äº›æ‰©å±•ï¼Œå…¶ä»–çš„å¤§éƒ¨åˆ†ä½¿ç”¨æˆç†Ÿçš„å¼€æºç»„ä»¶å°±å¯ä»¥äº†ã€‚è€Œæˆ‘ä»¬è¿™ä¸ªç³»åˆ—å…³æ³¨çš„ Operator å°±ä¼šæ¶‰åŠåˆ° è‡ªå®šä¹‰èµ„æºï¼Œæ§åˆ¶å™¨å’Œå‡†å…¥æ§åˆ¶ã€‚</p><p>Operator éµå¾ª Kubernetes çš„ç†å¿µï¼Œå®ƒåˆ©ç”¨è‡ªå®šä¹‰èµ„æºç®¡ç†åº”ç”¨åŠå…¶ç»„ä»¶ï¼Œ Operator æ¨¡å¼ä¼šå°è£…ä½ ç¼–å†™çš„ä»»åŠ¡è‡ªåŠ¨åŒ–ä»£ç ã€‚</p><p>Operator å¸¸è§ä½¿ç”¨èŒƒå›´åŒ…æ‹¬:<sup id="fnref:6" class="footnote-ref"><a href="#fn:6" rel="footnote"><span class="hint--top hint--rounded" aria-label="Operator æ¨¡å¼ https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/">[6]</span></a></sup></p><ul><li>æŒ‰éœ€éƒ¨ç½²åº”ç”¨</li><li>è·å–/è¿˜åŸåº”ç”¨çŠ¶æ€çš„å¤‡ä»½</li><li>å¤„ç†åº”ç”¨ä»£ç çš„å‡çº§ä»¥åŠç›¸å…³æ”¹åŠ¨ã€‚ä¾‹å¦‚ï¼Œæ•°æ®åº“ schema æˆ–é¢å¤–çš„é…ç½®è®¾ç½®</li><li>å‘å¸ƒä¸€ä¸ª serviceï¼Œè¦æ±‚ä¸æ”¯æŒ Kubernetes API çš„åº”ç”¨ä¹Ÿèƒ½å‘ç°å®ƒ</li><li>æ¨¡æ‹Ÿæ•´ä¸ªæˆ–éƒ¨åˆ†é›†ç¾¤ä¸­çš„æ•…éšœä»¥æµ‹è¯•å…¶ç¨³å®šæ€§</li><li>åœ¨æ²¡æœ‰å†…éƒ¨æˆå‘˜é€‰ä¸¾ç¨‹åºçš„æƒ…å†µä¸‹ï¼Œä¸ºåˆ†å¸ƒå¼åº”ç”¨é€‰æ‹©é¦–é¢†è§’è‰²</li></ul><p>ä» Operator ç†å¿µçš„æå‡ºåˆ°ç°åœ¨å·²ç»æœ‰äº†å¾ˆå¤šå·¥å…·å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿä½æˆæœ¬çš„å¼€å‘ï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„å°±æ˜¯ CoreOS å¼€æºçš„ operator-sdk å’Œ k8s sig å°ç»„ç»´æŠ¤çš„ kubebuilderï¼Œæˆ‘ä»¬è¿™ä¸ªç³»åˆ—é€‰ç”¨ kubebuilderã€‚</p><p>é™¤äº†æˆ‘ä»¬è‡ªå·±å¼€å‘ä¹‹å¤–è¿˜å¯ä»¥åœ¨ <a href="https://operatorhub.io/">https://operatorhub.io/</a> ä¸Šæ‰¾åˆ°åˆ«äººå¼€å‘çš„ç°æˆçš„ Operator è¿›è¡Œä½¿ç”¨</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Kubernetes  ä» 2014 å¹´å‘å¸ƒè‡³ä»Šå·²ç» 7 å¹´äº†ï¼Œæˆ‘ä»æ¯•ä¸šåŠ å…¥åˆ°ç°åœ¨çš„å›¢é˜Ÿä»äº‹å‘¨è¾¹çš„å·¥ä½œä¹Ÿå·²ç»å¿« 3 å¹´äº†ï¼ŒæœŸé—´è™½ç„¶å¯¹ Kubernetes  å·²ç»æœ‰äº†åŸºæœ¬çš„äº†è§£ä½†æ˜¯è¿˜æ˜¯ä¸€ç›´éƒ½æ²¡æœ‰å¯¹ Kubernetes  æœ¬èº«è¿›è¡Œè¿‡æ‰©å±•çš„å¼€å‘ï¼Œè¿™ç¯‡æ–‡ç« å†™å®Œä¹‹åç®—æ˜¯å¯¹ Kubernetes æ‰©å±•å¼€å‘æœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„äº†è§£ï¼Œå¸Œæœ›å¯¹ä½ ä¹Ÿèƒ½æœ‰æ‰€å¸®åŠ©ã€‚  </p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span>Kubernetes æ˜¯ä»€ä¹ˆï¼Ÿ<a href="https://kubernetes.io/zh/docs/concepts/overview/what-is-kubernetes/">https://kubernetes.io/zh/docs/concepts/overview/what-is-kubernetes/</a><br><a href="#fnref:1" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:2" class="footnote-text"><span>æ‰©å±• Kubernetes <a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/">https://kubernetes.io/zh/docs/concepts/extend-kubernetes/</a><br><a href="#fnref:2" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:3" class="footnote-text"><span>ä½ è¯¥å¦‚ä½•ä¸º Kubernetes å®šåˆ¶ç‰¹æ€§: <a href="https://draveness.me/cloud-native-kubernetes-extension/">https://draveness.me/cloud-native-kubernetes-extension/</a><br><a href="#fnref:3" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:4" class="footnote-text"><span>kubectl æ’ä»¶ç®¡ç†å·¥å…· krew <a href="https://github.com/kubernetes-sigs/krew">https://github.com/kubernetes-sigs/krew</a><br><a href="#fnref:4" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:5" class="footnote-text"><span>Scheduler extender <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/scheduler_extender.md">https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/scheduler_extender.md</a><br><a href="#fnref:5" rev="footnote" class="footnote-backref"> â†©</a></span></span></li><li><span id="fn:6" class="footnote-text"><span>Operator æ¨¡å¼ <a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/">https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/</a><br><a href="#fnref:6" rev="footnote" class="footnote-backref"> â†©</a></span></span></li></ol></div></section><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>kubernetes ç³»åˆ—</category>
      
      <category>Kubernetes æ‰©å±•: Operator</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>k8s</tag>
      
      <tag>operator</tag>
      
      <tag>äº‘åŸç”Ÿ</tag>
      
      <tag>Kubernetes</tag>
      
      <tag>æ¦‚å¿µ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¯ç”¨æ€§(äº”) è‡ªé€‚åº”é™æµ</title>
    <link href="/post/go-training-week6-4-auto-limiter.html"/>
    <url>/post/go-training-week6-4-auto-limiter.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p>åœ¨å‰é¢é™æµçš„ä¸‰ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ä»¤ç‰Œæ¡¶ã€æ¼æ¡¶ç®—æ³•çš„åŸç†ã€å®ç°ä»¥åŠä½¿ç”¨æ–¹å¼ï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰è§‰å¾—è¿™ä¸¤ç§ç®—æ³•å­˜åœ¨ç€ä¸€äº›é—®é¢˜ã€‚</p><ul><li><a href="https://lailin.xyz/post/go-training-week6-2-token-bucket-1.html">Go å¯ç”¨æ€§(äºŒ) é™æµ 1: ä»¤ç‰Œæ¡¶åŸç†åŠä½¿ç”¨</a></li><li><a href="https://lailin.xyz/post/go-training-week6-3-token-bucket-2.html">Go å¯ç”¨æ€§(ä¸‰) é™æµ 2: ä»¤ç‰Œæ¡¶çš„å®ç° rate/limt</a></li><li><a href="https://lailin.xyz/post/go-training-week6-4-leaky-bucket.html">Go å¯ç”¨æ€§(å››) é™æµ 3: æ¼æ¡¶ç®—æ³•</a></li></ul><p>è¿™ä¸¤ç§ç®—æ³•æœ€å¤§çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯ä»–ä»¬éƒ½å±äºéœ€è¦æå‰è®¾ç½®é˜ˆå€¼çš„ç®—æ³•ï¼ŒåŸºäº QPS è¿›è¡Œé™æµçš„æ—¶å€™æœ€éº»çƒ¦çš„å°±æ˜¯è¿™ä¸ªé˜ˆå€¼åº”è¯¥æ€ä¹ˆè®¾å®šã€‚ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡å‹æµ‹æ¥å†³å®šè¿™ä¸ªé˜ˆå€¼ã€‚</p><ul><li>ä½†æ˜¯å¦‚æœæ¯ä¸ªç³»ç»Ÿä¸Šçº¿å‰éƒ½è¦ç»è¿‡å¾ˆä¸¥æ ¼çš„å‹æµ‹ï¼Œé‚£ä¹ˆæˆæœ¬ç›¸å¯¹æ¥è¯´ä¼šæ¯”è¾ƒå¤§</li><li>å¹¶ä¸”æˆ‘ä»¬å¾ˆå¤šæ—¶å€™å‹æµ‹éƒ½ä¼šåœ¨æµ‹è¯•ç¯å¢ƒè¿›è¡Œå‹æµ‹ï¼Œæµ‹è¯•ç¯å¢ƒä¸€èˆ¬æ¥è¯´å’Œç”Ÿäº§ç¯å¢ƒä¼šæœ‰ä¸€å®šçš„å·®å¼‚ï¼Œå³ä½¿æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒåšäº†å‹æµ‹ï¼Œç°åœ¨æˆ‘ä»¬çš„åº”ç”¨éƒ½æ˜¯ä»¥å®¹å™¨çš„å½¢å¼è·‘åœ¨ä¸åŒçš„å®¿ä¸»æœºä¸Šçš„ï¼Œæ¯å°å®¿ä¸»æœºä¸Šçš„å·®å¼‚ï¼Œä»¥åŠä¸åŒçš„è´Ÿè½½éƒ½ä¼šå¯¼è‡´è¿™ä¸ªå‹æµ‹æ—¶çš„ç»“æœä¸ä¸€å®šå°±ä¸€å®šæ˜¯æ­£ç¡®çš„</li><li>å½“æˆ‘ä»¬çš„æœºå™¨å‹å·ã€æ•°é‡ç­‰å‘ç”Ÿæ”¹å˜æ—¶ï¼Œä¹‹å‰å‹æµ‹çš„æŒ‡æ ‡èƒ½ä¸èƒ½ç”¨å…¶å®æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œè¿™äº›æ•°æ®å¯¹äºç³»ç»Ÿè´Ÿè½½çš„å½±å“å…¶å®ä¸æ˜¯çº¿æ€§çš„ï¼Œä¸¾ä¸ªä¾‹å­ä¹‹å‰ä¸€å°æœºå™¨ï¼Œåé¢å†åŠ ä¸€å°ï¼Œè´Ÿè½½å°±ä¸€å®šèƒ½åˆ° 2 å€ä¹ˆï¼Ÿå…¶å®æ˜¯ä¸ä¸€å®šçš„</li><li>å¦‚æœéœ€è¦ä¿®æ”¹é™æµçš„å€¼ï¼Œè™½ç„¶ä¹‹å‰æˆ‘ä»¬å°†ä»¤ç‰Œæ¡¶çš„é™æµæ˜¯å¯ä»¥åŠ¨æ€è°ƒæ•´ï¼Œä½†æ˜¯é äººå»è°ƒæ•´ï¼Œå¦‚æœçœŸå‡ºç°é—®é¢˜ç„¶åå†å«è¿ç»´æˆ–è€…æ˜¯å¼€å‘åŒå­¦å»è°ƒæ•´å¯èƒ½é»„èŠ±èœéƒ½å‡‰äº†</li></ul><p>æ—¢ç„¶è¿™ç§æ–¹å¼æœ‰è¿™ä¹ˆå¤šçš„ç¼ºç‚¹ï¼Œé‚£æœ‰æ²¡æœ‰åŠæ³•è§£å†³å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ä»Šå¤©è®²åˆ°çš„ <strong>è‡ªé€‚åº”é™æµ</strong></p><h2 id="è‡ªé€‚åº”é™æµ"><a href="#è‡ªé€‚åº”é™æµ" class="headerlink" title="è‡ªé€‚åº”é™æµ"></a>è‡ªé€‚åº”é™æµ</h2><h3 id="è‡ªé€‚åº”é™æµæ€ä¹ˆåš"><a href="#è‡ªé€‚åº”é™æµæ€ä¹ˆåš" class="headerlink" title="è‡ªé€‚åº”é™æµæ€ä¹ˆåš"></a>è‡ªé€‚åº”é™æµæ€ä¹ˆåš</h3><p>å‰é¢æˆ‘ä»¬é‡åˆ°çš„ä¸»è¦é—®é¢˜å°±æ˜¯æ¯ä¸ªæœåŠ¡å®ä¾‹çš„é™æµé˜ˆå€¼å®é™…åº”è¯¥æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæˆ‘ä»¬åº”è¯¥æ ¹æ®ç³»ç»Ÿèƒ½å¤Ÿæ‰¿è½½çš„æœ€å¤§ååé‡ï¼Œæ¥è¿›è¡Œé™æµï¼Œå½“å½“å‰çš„æµé‡å¤§äºæœ€å¤§ååçš„æ—¶å€™å°±é™åˆ¶æµé‡è¿›å…¥ï¼Œåä¹‹åˆ™å…è®¸é€šè¿‡ã€‚é‚£ç°åœ¨çš„é—®é¢˜å°±æ˜¯</p><ul><li><strong>ç³»ç»Ÿçš„ååé‡è¯¥å¦‚ä½•è®¡ç®—ï¼Ÿ</strong></li><li><strong>ä»€ä¹ˆæ—¶å€™ç³»ç»Ÿçš„ååé‡å°±æ˜¯æœ€å¤§çš„ååé‡äº†ï¼Ÿ</strong></li></ul><h4 id="è®¡ç®—ååé‡ï¼šåˆ©ç‰¹å°”æ³•åˆ™-L-Î»-W"><a href="#è®¡ç®—ååé‡ï¼šåˆ©ç‰¹å°”æ³•åˆ™-L-Î»-W" class="headerlink" title="è®¡ç®—ååé‡ï¼šåˆ©ç‰¹å°”æ³•åˆ™ L = Î» * W"></a>è®¡ç®—ååé‡ï¼šåˆ©ç‰¹å°”æ³•åˆ™ L = Î» * W</h4><blockquote><p>åˆ©ç‰¹å°”æ³•åˆ™ç”±éº»çœç†å·¥å¤§å­¦æ–¯éš†å•†å­¦é™¢ï¼ˆMIT Sloan School of Managementï¼‰çš„æ•™æˆ John Littleï¹äº 1961 å¹´æ‰€æå‡ºä¸è¯æ˜ã€‚å®ƒæ˜¯ä¸€ä¸ªæœ‰å…³æå‰æœŸä¸åœ¨åˆ¶å“å…³ç³»çš„ç®€å•æ•°å­¦å…¬å¼ï¼Œè¿™ä¸€æ³•åˆ™ä¸ºç²¾ç›Šç”Ÿäº§çš„æ”¹å–„æ–¹å‘æŒ‡æ˜äº†é“è·¯ã€‚ â€”- <a href="https://wiki.mbalib.com/wiki/%E5%88%A9%E7%89%B9%E5%B0%94%E6%B3%95%E5%88%99">MBA æ™ºåº“ç™¾ç§‘ (mbalib.com)</a></p></blockquote><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1618149289604-8e317c82-9a06-4369-99ca-61f138515439.png" alt="image.png"><br>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¦‚æœæˆ‘ä»¬å¼€ä¸€ä¸ªå°åº—ï¼Œå¹³å‡æ¯åˆ†é’Ÿè¿›åº— 2 ä¸ªå®¢äºº(Î»)ï¼Œæ¯ä½å®¢äººä»ç­‰å¾…åˆ°å®Œæˆäº¤æ˜“éœ€è¦ 4 åˆ†é’Ÿ(W)ï¼Œé‚£æˆ‘ä»¬åº—é‡Œèƒ½æ‰¿è½½çš„å®¢äººæ•°é‡å°±æ˜¯ 2 * 4 = 8 ä¸ªäºº</p><p>åŒç†ï¼Œæˆ‘ä»¬å¯ä»¥å°† <code>Î»</code>  å½“åš QPSï¼Œ <code>W</code>  å‘¢æ˜¯æ¯ä¸ªè¯·æ±‚éœ€è¦èŠ±è´¹çš„æ—¶é—´ï¼Œé‚£æˆ‘ä»¬çš„ç³»ç»Ÿçš„ååå°±æ˜¯ <code>L = Î» * W</code> ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆ©ç‰¹å°”æ³•åˆ™æ¥è®¡ç®—ç³»ç»Ÿçš„ååé‡ã€‚</p><h4 id="ä»€ä¹ˆæ—¶å€™ç³»ç»Ÿçš„ååé‡å°±æ˜¯æœ€å¤§çš„ååé‡ï¼Ÿ"><a href="#ä»€ä¹ˆæ—¶å€™ç³»ç»Ÿçš„ååé‡å°±æ˜¯æœ€å¤§çš„ååé‡ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ—¶å€™ç³»ç»Ÿçš„ååé‡å°±æ˜¯æœ€å¤§çš„ååé‡ï¼Ÿ"></a>ä»€ä¹ˆæ—¶å€™ç³»ç»Ÿçš„ååé‡å°±æ˜¯æœ€å¤§çš„ååé‡ï¼Ÿ</h4><p>é¦–å…ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»Ÿè®¡è¿‡å»ä¸€æ®µæ—¶é—´çš„æ•°æ®ï¼Œè·å–åˆ°å¹³å‡æ¯ç§’çš„è¯·æ±‚é‡ï¼Œä¹Ÿå°±æ˜¯ QPSï¼Œä»¥åŠè¯·æ±‚çš„è€—æ—¶æ—¶é—´ï¼Œä¸ºäº†é¿å…å‡ºç°å‰é¢ 900ms ä¸€ä¸ªè¯·æ±‚éƒ½æ²¡æœ‰æœ€å 100ms è¯·æ±‚ç‰¹åˆ«å¤šçš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ»‘åŠ¨çª—å£ç®—æ³•æ¥è¿›è¡Œç»Ÿè®¡ã€‚</p><p>æœ€å®¹æ˜“æƒ³åˆ°çš„å°±æ˜¯æˆ‘ä»¬ä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ï¼Œå°±æŠŠè¿™äº›å€¼ç»™ä¿å­˜ä¸‹æ¥ï¼Œç„¶åè®¡ç®—ä¸€ä¸ªååçš„æœ€å¤§å€¼ï¼Œç”¨è¿™ä¸ªæ¥è¡¨ç¤ºæˆ‘ä»¬çš„æœ€å¤§ååé‡å°±å¯ä»¥äº†ã€‚ä½†æ˜¯è¿™æ ·å­˜åœ¨ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬å¾ˆå¤šç³»ç»Ÿå…¶å®éƒ½ä¸æ˜¯ç‹¬å ä¸€å°æœºå™¨çš„ï¼Œä¸€ä¸ªç‰©ç†æœºä¸Šé¢å¾€å¾€æœ‰å¾ˆå¤šæœåŠ¡ï¼Œå¹¶ä¸”ä¸€èˆ¬è¿˜å­˜åœ¨ä¸€äº›è¶…å–ï¼Œæ‰€ä»¥å¯èƒ½ç¬¬ä¸€ä¸ªå°æ—¶æœ€å¤§å¤„ç†èƒ½åŠ›æ˜¯ 100ï¼Œä½†æ˜¯è¿™å°èŠ‚ç‚¹ä¸Šå…¶ä»–æœåŠ¡å®ä¾‹åŒæ—¶éƒ½åœ¨æŠ¢å èµ„æºçš„æ—¶å€™ï¼Œè¿™ä¸ªå¤„ç†èƒ½åŠ›æœ€å¤šå°±åªèƒ½åˆ° 80 äº†</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ•°æ®æ¥åšå¯å‘é˜ˆå€¼ï¼Œåªè¦è¿™ä¸ªæŒ‡æ ‡è¾¾åˆ°äº†é˜ˆå€¼é‚£æˆ‘ä»¬å°±è¿›å…¥æµæ§å½“ä¸­ã€‚å¸¸è§çš„é€‰æ‹©ä¸€èˆ¬æ˜¯ CPUã€Memoryã€System Loadï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥ CPU ä¸ºä¾‹</p><p>åªè¦æˆ‘ä»¬çš„ CPU è´Ÿè½½è¶…è¿‡ 80% çš„æ—¶å€™ï¼Œè·å–è¿‡å» 5s çš„æœ€å¤§ååæ•°æ®ï¼Œç„¶åå†ç»Ÿè®¡å½“å‰ç³»ç»Ÿä¸­çš„è¯·æ±‚æ•°é‡ï¼Œåªè¦å½“å‰ç³»ç»Ÿä¸­çš„è¯·æ±‚æ•°å¤§äºæœ€å¤§ååé‚£ä¹ˆæˆ‘ä»¬å°±ä¸¢å¼ƒè¿™ä¸ªè¯·æ±‚ã€‚</p><h3 id="kratos-è‡ªé€‚åº”é™æµåˆ†æ"><a href="#kratos-è‡ªé€‚åº”é™æµåˆ†æ" class="headerlink" title="kratos è‡ªé€‚åº”é™æµåˆ†æ"></a>kratos è‡ªé€‚åº”é™æµåˆ†æ</h3><h3 id="é™æµå…¬å¼"><a href="#é™æµå…¬å¼" class="headerlink" title="é™æµå…¬å¼"></a>é™æµå…¬å¼</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// PS: å®˜æ–¹æ–‡æ¡£è¿™é‡Œå†™çš„æ˜¯ cpu &gt; 800 AND (Now - PrevDrop) &lt; 1s</span><br><span class="hljs-comment">// åº”è¯¥æ˜¯å†™é”™äº†ï¼Œç­‰ä¸‹çœ‹æºç å°±çŸ¥é“äº†</span><br>(cpu &gt; <span class="hljs-number">800</span> OR (Now - PrevDrop) &lt; <span class="hljs-number">1</span>s) AND (MaxPass * MinRt * windows / <span class="hljs-number">1000</span>) &lt; InFlight<br></code></pre></td></tr></table></figure><ul><li><code>cpu &gt; 800</code>  è¡¨ç¤º CPU è´Ÿè½½å¤§äº 80% è¿›å…¥é™æµ</li><li><code>(Now - PrevDrop) &lt; 1s</code>  è¿™ä¸ªè¡¨ç¤ºåªè¦è§¦å‘è¿‡ 1 æ¬¡é™æµï¼Œé‚£ä¹ˆ 1s å†…éƒ½ä¼šå»åšé™æµçš„åˆ¤å®šï¼Œè¿™æ˜¯ä¸ºäº†é¿å…åå¤å‡ºç°é™æµæ¢å¤å¯¼è‡´è¯·æ±‚æ—¶é—´å’Œç³»ç»Ÿè´Ÿè½½äº§ç”Ÿå¤§é‡æ¯›åˆº</li><li><code>(MaxPass * MinRt * windows / 1000) &lt; InFlight</code>  åˆ¤æ–­å½“å‰è´Ÿè½½æ˜¯å¦å¤§äºæœ€å¤§è´Ÿè½½<ul><li><code>InFlight</code>  è¡¨ç¤ºå½“å‰ç³»ç»Ÿä¸­æœ‰å¤šå°‘è¯·æ±‚</li><li><code>(MaxPass * MinRt * windows / 1000)</code>  è¡¨ç¤ºè¿‡å»ä¸€æ®µæ—¶é—´çš„æœ€å¤§è´Ÿè½½</li><li><code>MaxPass</code>  è¡¨ç¤ºæœ€è¿‘ 5s å†…ï¼Œå•ä¸ªé‡‡æ ·çª—å£ä¸­æœ€å¤§çš„è¯·æ±‚æ•°</li><li><code>MinRt</code>  è¡¨ç¤ºæœ€è¿‘ 5s å†…ï¼Œå•ä¸ªé‡‡æ ·çª—å£ä¸­æœ€å°çš„å“åº”æ—¶é—´</li><li><code>windows</code>  è¡¨ç¤ºä¸€ç§’å†…é‡‡æ ·çª—å£çš„æ•°é‡ï¼Œé»˜è®¤é…ç½®ä¸­æ˜¯ 5s 50 ä¸ªé‡‡æ ·ï¼Œé‚£ä¹ˆ windows çš„å€¼ä¸º 10ã€‚</li></ul></li></ul><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="BBR-ç»“æ„ä½“"><a href="#BBR-ç»“æ„ä½“" class="headerlink" title="BBR ç»“æ„ä½“"></a>BBR ç»“æ„ä½“</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> BBR <span class="hljs-keyword">struct</span> &#123;<br>cpu             cpuGetter<br>    <span class="hljs-comment">// è¯·æ±‚æ•°ï¼Œå’Œå“åº”æ—¶é—´çš„é‡‡æ ·æ•°æ®ï¼Œä½¿ç”¨æ»‘åŠ¨çª—å£è¿›è¡Œç»Ÿè®¡</span><br>passStat        metric.RollingCounter<br>rtStat          metric.RollingCounter<br><br>    <span class="hljs-comment">// å½“å‰ç³»ç»Ÿä¸­çš„è¯·æ±‚æ•°</span><br>inFlight        <span class="hljs-keyword">int64</span><br><span class="hljs-comment">// æ¯ç§’é’Ÿå†…çš„é‡‡æ ·æ•°é‡ï¼Œé»˜è®¤æ˜¯10</span><br>    winBucketPerSec <span class="hljs-keyword">int64</span><br>    <span class="hljs-comment">// å•ä¸ª bucket çš„æ—¶é—´</span><br>bucketDuration  time.Duration<br><span class="hljs-comment">// çª—å£æ•°é‡</span><br>    winSize         <span class="hljs-keyword">int</span><br><span class="hljs-comment">// é…ç½®</span><br>    conf            *Config<br>prevDrop        atomic.Value<br>    <span class="hljs-comment">// è¡¨ç¤ºæœ€è¿‘ 5s å†…ï¼Œå•ä¸ªé‡‡æ ·çª—å£ä¸­æœ€å¤§çš„è¯·æ±‚æ•°çš„ç¼“å­˜æ•°æ®</span><br>maxPASSCache    atomic.Value<br>    <span class="hljs-comment">// è¡¨ç¤ºæœ€è¿‘ 5s å†…ï¼Œå•ä¸ªé‡‡æ ·çª—å£ä¸­æœ€å°çš„å“åº”æ—¶é—´çš„ç¼“å­˜æ•°æ®</span><br>minRtCache      atomic.Value<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Allow-åˆ¤æ–­è¯·æ±‚æ˜¯å¦å…è®¸é€šè¿‡"><a href="#Allow-åˆ¤æ–­è¯·æ±‚æ˜¯å¦å…è®¸é€šè¿‡" class="headerlink" title="Allow: åˆ¤æ–­è¯·æ±‚æ˜¯å¦å…è®¸é€šè¿‡"></a>Allow: åˆ¤æ–­è¯·æ±‚æ˜¯å¦å…è®¸é€šè¿‡</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *BBR)</span> <span class="hljs-title">Allow</span><span class="hljs-params">(ctx context.Context, opts ...limit.AllowOption)</span> <span class="hljs-params">(<span class="hljs-keyword">func</span>(info limit.DoneInfo)</span>, <span class="hljs-title">error</span>)</span> &#123;<br><span class="hljs-comment">// ... çœç•¥é…ç½®ä¿®æ”¹ä»£ç </span><br><br>    <span class="hljs-keyword">if</span> l.shouldDrop() &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, ecode.LimitExceed<br>&#125;<br><br>atomic.AddInt64(&amp;l.inFlight, <span class="hljs-number">1</span>)<br>stime := time.Since(initTime)<br><br><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(do limit.DoneInfo)</span></span> &#123;<br>rt := <span class="hljs-keyword">int64</span>((time.Since(initTime) - stime) / time.Millisecond)<br>l.rtStat.Add(rt)<br>atomic.AddInt64(&amp;l.inFlight, <span class="hljs-number">-1</span>)<br><span class="hljs-keyword">switch</span> do.Op &#123;<br><span class="hljs-keyword">case</span> limit.Success:<br>l.passStat.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">return</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯ç»™ä¸­é—´ä»¶ä½¿ç”¨çš„</p><ul><li>é¦–å…ˆä½¿ç”¨ <code>shouldDrop</code>  æ–¹æ³•åˆ¤æ–­è¿™ä¸ªè¯·æ±‚æ˜¯å¦åº”è¯¥ä¸¢å¼ƒ</li><li>å¦‚æœæˆåŠŸæ”¾è¡Œï¼Œé‚£ä¹ˆå½“å‰ç³»ç»Ÿä¸­çš„è¯·æ±‚æ•°å°± +1</li><li>ç„¶åè¿”å›ä¸€ä¸ª <code>function</code>  ç”¨äºè¯·æ±‚ç»“æŸä¹‹å<ul><li>ç»Ÿè®¡è¯·æ±‚çš„å“åº”æ—¶é—´</li><li>å¦‚æœè¯·æ±‚æˆåŠŸäº†ï¼Œç»™æˆåŠŸçš„è¯·æ±‚æ•° +1</li><li>å¹¶ä¸”å½“å‰ç³»ç»Ÿä¸­çš„è¯·æ±‚æ•°é‡ <code>Inflight</code>  -1</li></ul></li></ul><h4 id="shouldDrop-åˆ¤æ–­è¯·æ±‚æ˜¯å¦åº”è¯¥è¢«ä¸¢å¼ƒ"><a href="#shouldDrop-åˆ¤æ–­è¯·æ±‚æ˜¯å¦åº”è¯¥è¢«ä¸¢å¼ƒ" class="headerlink" title="shouldDrop: åˆ¤æ–­è¯·æ±‚æ˜¯å¦åº”è¯¥è¢«ä¸¢å¼ƒ"></a>shouldDrop: åˆ¤æ–­è¯·æ±‚æ˜¯å¦åº”è¯¥è¢«ä¸¢å¼ƒ</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *BBR)</span> <span class="hljs-title">shouldDrop</span><span class="hljs-params">()</span> <span class="hljs-title">bool</span></span> &#123;<br><span class="hljs-keyword">if</span> l.cpu() &lt; l.conf.CPUThreshold &#123;<br>prevDrop, _ := l.prevDrop.Load().(time.Duration)<br><span class="hljs-keyword">if</span> prevDrop == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">if</span> time.Since(initTime)-prevDrop &lt;= time.Second &#123;<br>inFlight := atomic.LoadInt64(&amp;l.inFlight)<br><span class="hljs-keyword">return</span> inFlight &gt; <span class="hljs-number">1</span> &amp;&amp; inFlight &gt; l.maxFlight()<br>&#125;<br>l.prevDrop.Store(time.Duration(<span class="hljs-number">0</span>))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>inFlight := atomic.LoadInt64(&amp;l.inFlight)<br>drop := inFlight &gt; <span class="hljs-number">1</span> &amp;&amp; inFlight &gt; l.maxFlight()<br><span class="hljs-keyword">if</span> drop &#123;<br>prevDrop, _ := l.prevDrop.Load().(time.Duration)<br><span class="hljs-keyword">if</span> prevDrop != <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> drop<br>&#125;<br>l.prevDrop.Store(time.Since(initTime))<br>&#125;<br><span class="hljs-keyword">return</span> drop<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•å…¶å®å°±æ˜¯å¼€å¤´è®²åˆ°çš„é™æµå…¬å¼äº†ï¼Œé€»è¾‘å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1618158541909-f94f46a3-fad8-47d3-a389-395a57116c55.png" alt="Goå¯ç”¨æ€§ é™æµ-åˆ†å¸ƒå¼é™æµ-kratos é™æµç­–ç•¥.png"></p><ul><li>é¦–å…ˆçœ‹ CPU çš„ä½¿ç”¨ç‡æ˜¯å¦è¾¾åˆ°äº†é˜ˆå€¼</li><li>å¦‚æœæ²¡åˆ°ï¼Œåˆ™å›å»åˆ¤æ–­ä¸€ä¸‹ä¸Šæ¬¡è§¦å‘é™æµåˆ°ç°åœ¨æ˜¯å¦åœ¨ä¸€ç§’ä»¥å†…<ul><li>å¦‚æœåœ¨ä¸€ç§’å†…ï¼Œå°±åˆ¤æ–­å½“å‰è´Ÿè½½æ˜¯å¦è¶…è¿‡é™åˆ¶ï¼Œå¦‚æœè¶…è¿‡äº†å°±éœ€è¦ä¸¢å¼ƒ</li><li>å¦‚æœä¸åœ¨ 1s å†…æˆ–è€…æ˜¯è¯·æ±‚æ•°é‡å·²ç»é™ä¸‹æ¥äº†ï¼Œé‚£ä¹ˆå°±å§ <code>prevDrop</code>  æ¸…é›¶ç„¶åè¿”å› false</li></ul></li><li>å¦‚æœåˆ°äº†ï¼Œåˆ™åˆ¤æ–­ä¸€ä¸‹å½“å‰è´Ÿè½½æ˜¯å¦è¶…è¿‡é™åˆ¶<ul><li>å¦‚æœè¶…è¿‡äº†ï¼Œåˆ™è®¾ç½®ä¸¢å¼ƒæ—¶é—´ <code>prevDrop</code>ï¼Œè¿”å› true éœ€è¦ä¸¢å¼ƒè¯·æ±‚</li><li>å¦‚æœæ²¡è¶…è¿‡ç›´æ¥è¿”å› false</li></ul></li></ul><h4 id="maxFlight-ç³»ç»Ÿçš„æœ€å¤§è´Ÿè½½"><a href="#maxFlight-ç³»ç»Ÿçš„æœ€å¤§è´Ÿè½½" class="headerlink" title="maxFlight: ç³»ç»Ÿçš„æœ€å¤§è´Ÿè½½"></a>maxFlight: ç³»ç»Ÿçš„æœ€å¤§è´Ÿè½½</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *BBR)</span> <span class="hljs-title">maxFlight</span><span class="hljs-params">()</span> <span class="hljs-title">int64</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">int64</span>(math.Floor(<span class="hljs-keyword">float64</span>(l.maxPASS()*l.minRT()*l.winBucketPerSec)/<span class="hljs-number">1000.0</span> + <span class="hljs-number">0.5</span>))<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå°±æ˜¯è®¡ç®—è¿‡å»ä¸€æ®µæ—¶é—´ç³»ç»Ÿçš„æœ€å¤§è´Ÿè½½æ˜¯å¤šå°‘</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ç¯‡æ–‡ç« æˆ‘ä»¬è®²äº†ä¸€ä¸‹ä¸ºä»€ä¹ˆéœ€è¦è‡ªé€‚åº”é™æµï¼Œä»¤ç‰Œæ¡¶å’Œæ¼æ¡¶è¿™ç±»éœ€è¦æ‰‹åŠ¨è®¾ç½® rps ç®—æ³•çš„é—®é¢˜æ‰€åœ¨ï¼Œäº†è§£äº†è‡ªé€‚åº”é™æµçš„å®ç°åŸç†ï¼Œæœ€åçœ‹äº†ä¸€ä¸‹ kratos å½“ä¸­æ˜¯å¦‚ä½•å®ç°è‡ªé€‚åº”é™æµçš„ã€‚ä½†æ˜¯ç”±äºç¯‡å¹…å…³ç³»ï¼ŒCPU çš„æ•°æ®å¦‚ä½•è¿›è¡Œç»Ÿè®¡ï¼Œæ–‡ç« ä¸­æåˆ°äº†å¾ˆå¤šæ¬¡çš„æ»‘åŠ¨çª—å£æ˜¯ä¸ªä»€ä¹ˆåŸç†è¿™äº›çŸ¥è¯†ç‚¹å¤§å®¶å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ kratos ä¸­çš„æºç ï¼Œæˆ–è€…å»çœ‹æå®¢æ—¶é—´çš„ Go è¿›é˜¶è®­ç»ƒè¥éƒ½æœ‰è®²åˆ°ã€‚</p><p>kratos ä¸­çš„é™æµç®—æ³•å…¶å®çµæ„Ÿæºäº Google SREï¼Œå®ç°ä¸Šå‚è€ƒäº† sentinelï¼Œå…¶ä¸­ä¸€ä¸ªæœ‰æ„æ€çš„ç‚¹æ˜¯ sentinel é»˜è®¤ä½¿ç”¨ load ä½œä¸ºå¯å‘é˜ˆå€¼ï¼Œè€Œ kratos ä½¿ç”¨äº† cpuï¼Œkratos ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ cpu å‘¢ï¼Ÿè¿™ä¸ªå¤§å®¶å¯ä»¥è‡ªå·±æƒ³æƒ³ï¼ˆç­”æ¡ˆå¯ä»¥è‡ªè¡Œè§‚çœ‹æå®¢æ—¶é—´çš„ Go è¿›é˜¶è®­ç»ƒè¥ï¼‰</p><p>è€Œ sentinel çš„å®ç°å…¶å®æ˜¯å‚è€ƒäº† TCP ä¸­çš„ BBR ç®—æ³•ï¼Œåœ¨ BBR çš„åŸºç¡€ä¸ŠåŠ ä¸Šäº† load ä½œä¸ºå¯å‘é˜ˆå€¼çš„åˆ¤æ–­ï¼Œæ‰€ä»¥å¤šäº†è§£ä¸€ä¸‹åŸºç¡€çŸ¥è¯†æ€»æ˜¯æ²¡é”™çš„ï¼ŒæŒ‡ä¸å®šå½“ä¸‹é‡åˆ°çš„åœºæ™¯å°±èƒ½è§£å†³ã€‚</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go è¿›é˜¶è®­ç»ƒè¥-æå®¢æ—¶é—´</a></li><li><a href="https://kunzhao.org/docs/cloud-plus-bbs/bilibili-high-availability/">B ç«™é«˜å¯ç”¨æ¶æ„å®è·µ | èµµå¤çš„ä¸ªäººç½‘ç«™ (kunzhao.org)</a></li><li><a href="https://wiki.mbalib.com/wiki/%E5%88%A9%E7%89%B9%E5%B0%94%E6%B3%95%E5%88%99">åˆ©ç‰¹å°”æ³•åˆ™ - MBA æ™ºåº“ç™¾ç§‘ (mbalib.com)</a></li><li><a href="https://aws.amazon.com/cn/blogs/china/talking-about-network-optimization-from-the-flow-control-algorithm/">ä»æµé‡æ§åˆ¶ç®—æ³•è°ˆç½‘ç»œä¼˜åŒ– â€“ ä» CUBIC åˆ° BBRv2 ç®—æ³• | äºšé©¬é€Š AWS å®˜æ–¹åšå®¢ (amazon.com)</a></li><li><a href="https://github.com/go-kratos/kratos/blob/v1.0.x/docs/ratelimit.md">kratos/ratelimit.md at v1.0.x Â· go-kratos/kratos (github.com)</a></li><li><a href="https://my.oschina.net/u/3162806/blog/4525952">é™æµå™¨ç³»åˆ—(3)â€“è‡ªé€‚åº”é™æµ - éƒæ´ªèŒƒçš„ä¸ªäººç©ºé—´ - OSCHINA - ä¸­æ–‡å¼€æºæŠ€æœ¯äº¤æµç¤¾åŒº</a></li><li><a href="https://en.wikipedia.org/wiki/TCP_congestion_control#TCP_BBR">TCP congestion control - Wikipedia</a></li><li><a href="https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81">ç³»ç»Ÿè‡ªé€‚åº”é™æµ Â· alibaba/Sentinel Wiki Â· GitHub</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week06: å¾®æœåŠ¡å¯ç”¨æ€§è®¾è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¾®æœåŠ¡</tag>
      
      <tag>å¯ç”¨æ€§</tag>
      
      <tag>è¿‡è½½ä¿æŠ¤</tag>
      
      <tag>é™æµ</tag>
      
      <tag>ä»¤ç‰Œæ¡¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¯ç”¨æ€§(å››) æ¼æ¡¶ç®—æ³•</title>
    <link href="/post/go-training-week6-4-leaky-bucket.html"/>
    <url>/post/go-training-week6-4-leaky-bucket.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p>åœ¨å‰é¢ä¸¤ç¯‡æ–‡ç« å½“ä¸­æˆ‘ä»¬å­¦ä¹ äº†ä»¤ç‰Œæ¡¶ç®—æ³•çš„ä½¿ç”¨å’Œå®ç°ï¼Œä»Šå¤©æˆ‘ä»¬å°±ä¸€èµ·æ¥çœ‹ä¸€çœ‹å¦å¤–ä¸€ç§å¸¸è§çš„é™æµç®—æ³•ï¼Œæ¼æ¡¶ç®—æ³•</p><h2 id="æ¼æ¡¶ç®—æ³•"><a href="#æ¼æ¡¶ç®—æ³•" class="headerlink" title="æ¼æ¡¶ç®—æ³•"></a>æ¼æ¡¶ç®—æ³•</h2><h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><blockquote><p>æ¼æ¡¶ç®—æ³•(Leaky Bucket) æ˜¯ç½‘ç»œä¸–ç•Œä¸­æµé‡æ•´å½¢ï¼ˆTraffic Shapingï¼‰æˆ–é€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰æ—¶ç»å¸¸ä½¿ç”¨çš„ä¸€ç§ç®—æ³•ï¼Œå®ƒçš„ä¸»è¦ç›®çš„æ˜¯æ§åˆ¶æ•°æ®æ³¨å…¥åˆ°ç½‘ç»œçš„é€Ÿç‡ï¼Œå¹³æ»‘ç½‘ç»œä¸Šçš„çªå‘æµé‡ã€‚æ¼æ¡¶ç®—æ³•æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œé€šè¿‡å®ƒï¼Œçªå‘æµé‡å¯ä»¥è¢«æ•´å½¢ä»¥ä¾¿ä¸ºç½‘ç»œæä¾›ä¸€ä¸ªç¨³å®šçš„æµé‡ã€‚ â€” <a href="https://baike.baidu.com/item/%E6%BC%8F%E6%A1%B6%E7%AE%97%E6%B3%95">ç™¾åº¦ç™¾ç§‘</a></p></blockquote><p>æ¼æ¡¶ç®—æ³•å…¶å®éå¸¸å½¢è±¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ¼æ°´çš„æ¡¶ï¼Œå½“æœ‰çªå‘æµé‡æ¥ä¸´çš„æ—¶å€™ï¼Œä¼šå…ˆåˆ°æ¡¶é‡Œé¢ï¼Œæ¡¶ä¸‹æœ‰ä¸€ä¸ªæ´ï¼Œå¯ä»¥ä»¥å›ºå®šçš„é€Ÿç‡å‘å¤–æµæ°´ï¼Œå¦‚æœæ°´çš„ä»æ¡¶ä¸­å¤–æº¢äº†å‡ºæ¥ï¼Œé‚£ä¹ˆè¿™ä¸ªè¯·æ±‚å°±ä¼šè¢«æ‹’ç»æ‰ã€‚å…·ä½“çš„è¡¨ç°å°±ä¼šå‘ä¸‹å›¾å³ä¾§çš„å›¾è¡¨ä¸€æ ·ï¼Œçªå‘æµé‡å°±è¢«æ•´å½¢æˆäº†ä¸€ä¸ªå¹³æ»‘çš„æµé‡ã€‚<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1617718978961-0a125409-6fbb-4ca9-b335-5bef61cd44a8.png" alt="image.png"></p><p>æ¼æ¡¶ç®—æ³•çš„ä¸»è¦ä½œç”¨å°±æ˜¯é¿å…å‡ºç°æœ‰çš„æ—¶å€™æµé‡å¾ˆé«˜ï¼Œæœ‰çš„æ—¶å€™åˆå¾ˆä½ï¼Œå¯¼è‡´ç³»ç»Ÿå‡ºç°æ—±çš„æ—±æ­»ï¼Œæ¶çš„æ¶æ­»çš„è¿™ç§æƒ…å†µã€‚</p><p>Go ä¸­æ¯”è¾ƒå¸¸ç”¨çš„æ¼æ¡¶ç®—æ³•çš„å®ç°å°±æ˜¯æ¥è‡ª uber çš„ <a href="https://pkg.go.dev/go.uber.org/ratelimit">ratelimit</a>ï¼Œä¸‹é¢æˆ‘ä»¬å°±ä¼šçœ‹ä¸€ä¸‹è¿™ä¸ªåº“çš„ä½¿ç”¨æ–¹å¼å’Œæºç </p><h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Clock<br><span class="hljs-keyword">type</span> Limiter<br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">(rate <span class="hljs-keyword">int</span>, opts ...Option)</span> <span class="hljs-title">Limiter</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUnlimited</span><span class="hljs-params">()</span> <span class="hljs-title">Limiter</span></span><br><span class="hljs-keyword">type</span> Option<br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Per</span><span class="hljs-params">(per time.Duration)</span> <span class="hljs-title">Option</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithClock</span><span class="hljs-params">(clock Clock)</span> <span class="hljs-title">Option</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithSlack</span><span class="hljs-params">(slack <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">Option</span></span><br></code></pre></td></tr></table></figure><p><code>Clock</code>  æ˜¯ä¸€ä¸ªæ¥å£ï¼Œè®¡æ—¶å™¨çš„æœ€å°å®ç°ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯å½“å‰çš„æ—¶é—´å’Œç¡çœ </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Clock <span class="hljs-keyword">interface</span> &#123;<br>Now() time.Time<br>Sleep(time.Duration)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Limiter</code>  ä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼Œåªæœ‰ä¸€ä¸ª <code>Take</code>  æ–¹æ³•ï¼Œæ‰§è¡Œè¿™ä¸ªæ–¹æ³•çš„æ—¶å€™å¦‚æœè§¦å‘äº† rps é™åˆ¶åˆ™ä¼šé˜»å¡ä½</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Limiter <span class="hljs-keyword">interface</span> &#123;<br><span class="hljs-comment">// Take should block to make sure that the RPS is met.</span><br>Take() time.Time<br>&#125;<br></code></pre></td></tr></table></figure><p><code>NewLimter</code>  å’Œ <code>NewUnlimited</code>  ä¼šåˆ†åˆ«åˆå§‹åŒ–ä¸€ä¸ªæ— é”çš„é™é€Ÿå™¨å’Œæ²¡æœ‰ä»»ä½•é™åˆ¶çš„é™é€Ÿå™¨</p><p><code>Option</code>  æ˜¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™çš„é¢å¤–å‚æ•°ï¼Œè¿™ç§ä½¿ç”¨å§¿åŠ¿åœ¨ä¹‹å‰ Go å·¥ç¨‹åŒ–çš„æ–‡ç« <a href="https://lailin.xyz/post/go-training-week4-config.html">ã€ŠGo å·¥ç¨‹åŒ–(å…­) é…ç½®ç®¡ç†ã€‹</a>å½“ä¸­æœ‰è®²åˆ°ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸å†èµ˜è¿°äº†</p><p><code>Option</code>  æœ‰ä¸‰ä¸ªæ–¹æ³•</p><ul><li><code>Per</code>  å¯ä»¥ä¿®æ”¹æ—¶é—´å•ä½ï¼Œé»˜è®¤æ˜¯ç§’æ‰€ä»¥æˆ‘ä»¬é»˜è®¤é™åˆ¶çš„æ˜¯ rpsï¼Œå¦‚æœæ”¹æˆåˆ†é’Ÿé‚£ä¹ˆå°±æ˜¯ rpm äº†</li><li><code>WithClock</code>  å¯ä»¥ä¿®æ”¹æ—¶é’Ÿï¼Œè¿™ä¸ªç”¨äºåœ¨æµ‹è¯•çš„æ—¶å€™å¯ä»¥ mock æ‰ä¸ä½¿ç”¨çœŸå®çš„æ—¶é—´</li><li><code>WithSlack</code>  ç”¨äºä¿®æ”¹æ¾å¼›æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å…è®¸çš„çªå‘æµé‡çš„å¤§å°ï¼Œé»˜è®¤æ˜¯ <code>Pre / 10</code> ï¼Œè¿™ä¸ªåé¢ä¼šè®²åˆ°</li></ul><h3 id="æ¡ˆä¾‹-10-è¡Œä»£ç å®ç°ä¸€ä¸ªåŸºäºæ¼æ¡¶ç®—æ³•çš„-ip-é™æµä¸­é—´ä»¶"><a href="#æ¡ˆä¾‹-10-è¡Œä»£ç å®ç°ä¸€ä¸ªåŸºäºæ¼æ¡¶ç®—æ³•çš„-ip-é™æµä¸­é—´ä»¶" class="headerlink" title="æ¡ˆä¾‹: 10 è¡Œä»£ç å®ç°ä¸€ä¸ªåŸºäºæ¼æ¡¶ç®—æ³•çš„ ip é™æµä¸­é—´ä»¶"></a>æ¡ˆä¾‹: 10 è¡Œä»£ç å®ç°ä¸€ä¸ªåŸºäºæ¼æ¡¶ç®—æ³•çš„ ip é™æµä¸­é—´ä»¶</h3><p>æ¡ˆä¾‹æˆ‘ä»¬ä½¿ç”¨å’Œä»¤ç‰Œæ¡¶ç±»ä¼¼çš„æ¡ˆä¾‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewLimiter</span><span class="hljs-params">(rps <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">gin</span>.<span class="hljs-title">HandlerFunc</span></span> &#123;<br>limiters := &amp;sync.Map&#123;&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br><span class="hljs-comment">// è·å–é™é€Ÿå™¨</span><br><span class="hljs-comment">// key é™¤äº† ip ä¹‹å¤–ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–çš„ï¼Œä¾‹å¦‚ headerï¼Œuser name ç­‰</span><br>key := c.ClientIP()<br>l, _ := limiters.LoadOrStore(key, ratelimit.New(rps))<br>now := l.(ratelimit.Limiter).Take()<br>fmt.Printf(<span class="hljs-string">&quot;now: %s\n&quot;</span>, now)<br>c.Next()<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸Šä¹Ÿæ˜¯æ¯”è¾ƒç®€å•çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>e := gin.Default()<br><span class="hljs-comment">// æ–°å»ºä¸€ä¸ªé™é€Ÿå™¨ï¼Œå…è®¸çªå‘ 3 ä¸ªå¹¶å‘</span><br>e.Use(NewLimiter(<span class="hljs-number">3</span>))<br>e.GET(<span class="hljs-string">&quot;ping&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>c.String(http.StatusOK, <span class="hljs-string">&quot;pong&quot;</span>)<br>&#125;)<br>e.Run(<span class="hljs-string">&quot;:8080&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç”¨ <code>go-stress-testing</code>  è¿›è¡Œå‹æµ‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span>-stress-testing-linux -c <span class="hljs-number">100</span> -u http:<span class="hljs-comment">//localhost:8080/ping</span><br><br>â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€<br> è€—æ—¶ â”‚ å¹¶å‘æ•°â”‚  æˆåŠŸæ•°â”‚ å¤±è´¥æ•° â”‚   qps  â”‚æœ€é•¿è€—æ—¶â”‚æœ€çŸ­è€—æ—¶ â”‚å¹³å‡è€—æ—¶ â”‚ä¸‹è½½å­—èŠ‚ â”‚å­—èŠ‚æ¯ç§’ â”‚ é”™è¯¯ç <br>â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€<br>   <span class="hljs-number">1</span>sâ”‚     <span class="hljs-number">13</span>â”‚     <span class="hljs-number">13</span>â”‚      <span class="hljs-number">0</span>â”‚  <span class="hljs-number">233.55</span>â”‚  <span class="hljs-number">676.10</span>â”‚    <span class="hljs-number">5.82</span>â”‚   <span class="hljs-number">85.64</span>â”‚      <span class="hljs-number">52</span>â”‚      <span class="hljs-number">51</span>â”‚<span class="hljs-number">200</span>:<span class="hljs-number">13</span><br>   <span class="hljs-number">2</span>sâ”‚     <span class="hljs-number">16</span>â”‚     <span class="hljs-number">16</span>â”‚      <span class="hljs-number">0</span>â”‚   <span class="hljs-number">62.25</span>â”‚ <span class="hljs-number">1675.17</span>â”‚    <span class="hljs-number">5.82</span>â”‚  <span class="hljs-number">321.30</span>â”‚      <span class="hljs-number">64</span>â”‚      <span class="hljs-number">31</span>â”‚<span class="hljs-number">200</span>:<span class="hljs-number">16</span><br>   <span class="hljs-number">3</span>sâ”‚     <span class="hljs-number">19</span>â”‚     <span class="hljs-number">19</span>â”‚      <span class="hljs-number">0</span>â”‚   <span class="hljs-number">31.24</span>â”‚ <span class="hljs-number">2673.94</span>â”‚    <span class="hljs-number">5.82</span>â”‚  <span class="hljs-number">640.20</span>â”‚      <span class="hljs-number">76</span>â”‚      <span class="hljs-number">25</span>â”‚<span class="hljs-number">200</span>:<span class="hljs-number">19</span><br>   <span class="hljs-number">3</span>sâ”‚     <span class="hljs-number">20</span>â”‚     <span class="hljs-number">20</span>â”‚      <span class="hljs-number">0</span>â”‚   <span class="hljs-number">26.37</span>â”‚ <span class="hljs-number">3006.49</span>â”‚    <span class="hljs-number">5.82</span>â”‚  <span class="hljs-number">758.51</span>â”‚      <span class="hljs-number">80</span>â”‚      <span class="hljs-number">26</span>â”‚<span class="hljs-number">200</span>:<span class="hljs-number">20</span><br><br><br>*************************  ç»“æœ stat  ****************************<br>å¤„ç†åç¨‹æ•°é‡: <span class="hljs-number">20</span><br>è¯·æ±‚æ€»æ•°ï¼ˆå¹¶å‘æ•°*è¯·æ±‚æ•° -c * -nï¼‰: <span class="hljs-number">20</span> æ€»è¯·æ±‚æ—¶é—´: <span class="hljs-number">3.011</span> ç§’ successNum: <span class="hljs-number">20</span> failureNum: <span class="hljs-number">0</span><br>*************************  ç»“æœ end   ****************************<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹ç»“æœå‘ç°ä¸ºä»€ä¹ˆç¬¬ä¸€ç§’çš„æ—¶å€™å®Œæˆäº† 13 ä¸ªè¯·æ±‚ï¼Œä¸æ˜¯é™åˆ¶çš„ 3rps ä¹ˆï¼Ÿä¸è¦æ…Œï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒçš„å®ç°å°±çŸ¥é“äº†</p><h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><p>è¿™ä¸ªåº“æœ‰åŸºäºäº’æ–¥é”çš„å®ç°å’ŒåŸºäº CAS çš„æ— é”å®ç°ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯æ— é”å®ç°ç‰ˆæœ¬ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸»è¦çœ‹æ— é”å®ç°çš„æºç </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> state <span class="hljs-keyword">struct</span> &#123;<br>last     time.Time<br>sleepFor time.Duration<br>&#125;<br><br><span class="hljs-keyword">type</span> atomicLimiter <span class="hljs-keyword">struct</span> &#123;<br>state unsafe.Pointer<br><span class="hljs-comment">//lint:ignore U1000 Padding is unused but it is crucial to maintain performance</span><br><span class="hljs-comment">// of this rate limiter in case of collocation with other frequently accessed memory.</span><br>padding [<span class="hljs-number">56</span>]<span class="hljs-keyword">byte</span> <span class="hljs-comment">// cache line size - state pointer size = 64 - 8; created to avoid false sharing.</span><br><br>perRequest time.Duration<br>maxSlack   time.Duration<br>clock      Clock<br>&#125;<br></code></pre></td></tr></table></figure><p><code>atomicLimiter</code>  ç»“æ„ä½“</p><ul><li><code>state</code>  æ˜¯ä¸€ä¸ªçŠ¶æ€çš„æŒ‡é’ˆï¼Œç”¨äºå­˜å‚¨ä¸Šä¸€æ¬¡çš„æ‰§è¡Œçš„æ—¶é—´ï¼Œä»¥åŠéœ€è¦ <code>sleep</code>  çš„æ—¶é—´</li><li><code>padding</code>  æ˜¯ä¸€ä¸ªæ— æ„ä¹‰çš„å¡«å……æ•°æ®ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œé¿å… cpu ç¼“å­˜çš„ false sharing<ul><li>ä¹‹å‰åœ¨è®² <a href="https://lailin.xyz/post/go-training-week3-go-memory-model.html">Go å¹¶å‘ç¼–ç¨‹(äºŒ) Go å†…å­˜æ¨¡å‹</a> çš„æ—¶å€™æœ‰è®²åˆ°ï¼Œä¸ºäº†èƒ½å¤Ÿæœ€å¤§é™åº¦çš„åˆ©ç”¨ CPU çš„èƒ½åŠ›ï¼Œä¼šåšå¾ˆå¤šä¸§å¿ƒç—…ç‹‚çš„ä¼˜åŒ–ï¼Œå…¶ä¸­ä¸€ç§å°±æ˜¯ cpu cache</li><li>cpu cache ä¸€èˆ¬æ˜¯ä»¥ cache line ä¸ºå•ä½çš„ï¼Œåœ¨ 64 ä½çš„æœºå™¨ä¸Šä¸€èˆ¬æ˜¯ 64 å­—èŠ‚</li><li>æ‰€ä»¥å¦‚æœæˆ‘ä»¬é«˜é¢‘å¹¶å‘è®¿é—®çš„æ•°æ®å°äº 64 å­—èŠ‚çš„æ—¶å€™å°±å¯èƒ½ä¼šå’Œå…¶ä»–æ•°æ®ä¸€èµ·ç¼“å­˜ï¼Œå…¶ä»–æ•°æ®å¦‚æœå‡ºç°æ”¹å˜å°±ä¼šå¯¼è‡´ cpu è®¤ä¸ºç¼“å­˜å¤±æ•ˆï¼Œè¿™å°±æ˜¯ false sharing</li><li>æ‰€ä»¥åœ¨è¿™é‡Œä¸ºäº†å°½å¯èƒ½æé«˜æ€§èƒ½ï¼Œå¡«å……äº† 56 å­—èŠ‚çš„æ— æ„ä¹‰æ•°æ®ï¼Œå› ä¸º state æ˜¯ä¸€ä¸ªæŒ‡é’ˆå ç”¨äº† 8 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ <code>64 - 8 = 56</code></li></ul></li><li>å‰©ä¸‹ä¸‰ä¸ªå­—æ®µå’Œ <code>Option</code>  ä¸­çš„ä¸‰ä¸ªæ–¹æ³•æ„ä¹‰å¯¹åº”<ul><li><code>perRequest</code>  å°±æ˜¯å•ä½ï¼Œé»˜è®¤æ˜¯ç§’</li><li><code>maxSlack</code>  æ¾å¼›æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å…è®¸çš„çªå‘æµé‡çš„å¤§å°ï¼Œé»˜è®¤æ˜¯ <code>Pre / 10</code> ï¼Œè¿™ä¸ªåé¢ä¼šè®²åˆ°</li><li><code>clock</code>  æ—¶é’Ÿï¼Œè¿™ä¸ªç”¨äºåœ¨æµ‹è¯•çš„æ—¶å€™å¯ä»¥ mock æ‰ä¸ä½¿ç”¨çœŸå®çš„æ—¶é—´</li></ul></li></ul><p>æ¥ä¸‹æ¥çœ‹çœ‹æœ€ä¸»è¦çš„ <code>Take</code>  æ–¹æ³•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *atomicLimiter)</span> <span class="hljs-title">Take</span><span class="hljs-params">()</span> <span class="hljs-title">time</span>.<span class="hljs-title">Time</span></span> &#123;<br><span class="hljs-keyword">var</span> (<br>        <span class="hljs-comment">// çŠ¶æ€</span><br>newState state<br>        <span class="hljs-comment">// ç”¨äºè¡¨ç¤ºåŸå­æ“ä½œæ˜¯å¦æˆåŠŸ</span><br>taken    <span class="hljs-keyword">bool</span><br>        <span class="hljs-comment">// éœ€è¦ sleep çš„æ—¶é—´</span><br>interval time.Duration<br>)<br><br>    <span class="hljs-comment">// å¦‚æœ CAS æ“ä½œä¸æˆåŠŸå°±ä¸€ç›´å°è¯•</span><br><span class="hljs-keyword">for</span> !taken &#123;<br>        <span class="hljs-comment">// è·å–å½“å‰çš„æ—¶é—´</span><br>now := t.clock.Now()<br><br>        <span class="hljs-comment">// load å‡ºä¸Šä¸€æ¬¡è°ƒç”¨çš„æ—¶é—´</span><br>previousStatePointer := atomic.LoadPointer(&amp;t.state)<br>oldState := (*state)(previousStatePointer)<br><br>newState = state&#123;<br>last:     now,<br>sleepFor: oldState.sleepFor,<br>&#125;<br><br><span class="hljs-comment">// å¦‚æœ last æ˜¯é›¶å€¼çš„è¯ï¼Œè¡¨ç¤ºä¹‹å‰å°±æ²¡ç”¨è¿‡ï¼Œç›´æ¥ä¿å­˜è¿”å›å³å¯</span><br><span class="hljs-keyword">if</span> oldState.last.IsZero() &#123;<br>taken = atomic.CompareAndSwapPointer(&amp;t.state, previousStatePointer, unsafe.Pointer(&amp;newState))<br><span class="hljs-keyword">continue</span><br>&#125;<br><br><span class="hljs-comment">// sleepFor æ˜¯éœ€è¦ç¡çœ çš„æ—¶é—´ï¼Œç”±äºå¼•å…¥äº†æ¾å¼›æ—¶é—´ï¼Œæ‰€ä»¥ sleepFor å¯èƒ½æ˜¯ä¸€ä¸ª</span><br>        <span class="hljs-comment">// maxSlack ~ 0 ä¹‹é—´çš„ä¸€ä¸ªå€¼ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å°†ç°åœ¨çš„éœ€è¦ sleep çš„æ—¶é—´å’Œä¸Šä¸€æ¬¡</span><br>        <span class="hljs-comment">// sleepFor çš„å€¼ç›¸åŠ </span><br>newState.sleepFor += t.perRequest - now.Sub(oldState.last)<br><br>        <span class="hljs-comment">// å¦‚æœè·ç¦»ä¸Šä¸€æ¬¡è°ƒç”¨å·²ç»å¾ˆä¹…äº†ï¼ŒsleepFor å¯èƒ½ä¼šæ˜¯ä¸€ä¸ªå¾ˆå°çš„å€¼</span><br>        <span class="hljs-comment">// æœ€å°å€¼åªèƒ½æ˜¯ maxSlack çš„å¤§å°</span><br><span class="hljs-keyword">if</span> newState.sleepFor &lt; t.maxSlack &#123;<br>newState.sleepFor = t.maxSlack<br>&#125;<br><br>        <span class="hljs-comment">// å¦‚æœ sleepFor å¤§äº 0  çš„è¯ï¼Œè®¡ç®—å‡ºéœ€è¦ sleep çš„æ—¶é—´</span><br>        <span class="hljs-comment">// ç„¶åå°† state.sleepFor ç½®é›¶</span><br><span class="hljs-keyword">if</span> newState.sleepFor &gt; <span class="hljs-number">0</span> &#123;<br>newState.last = newState.last.Add(newState.sleepFor)<br>interval, newState.sleepFor = newState.sleepFor, <span class="hljs-number">0</span><br>&#125;<br><br>        <span class="hljs-comment">// ä¿å­˜çŠ¶æ€</span><br>taken = atomic.CompareAndSwapPointer(&amp;t.state, previousStatePointer, unsafe.Pointer(&amp;newState))<br>&#125;<br><br>    <span class="hljs-comment">// sleep interval</span><br>t.clock.Sleep(interval)<br><span class="hljs-keyword">return</span> newState.last<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»Šå¤©å­¦ä¹ äº†æ¼æ¡¶çš„å®ç°åŸç†ä»¥åŠä½¿ç”¨æ–¹å¼ï¼Œæ¼æ¡¶å’Œä»¤ç‰Œæ¡¶çš„æœ€å¤§çš„åŒºåˆ«å°±æ˜¯ï¼Œä»¤ç‰Œæ¡¶æ˜¯æ”¯æŒçªå‘æµé‡çš„ï¼Œä½†æ˜¯æ¼æ¡¶æ˜¯ä¸æ”¯æŒçš„ã€‚ä½†æ˜¯ uber çš„è¿™ä¸ªåº“é€šè¿‡å¼•å…¥å¼¹æ€§æ—¶é—´çš„æ–¹å¼ä¹Ÿè®©æ¼æ¡¶ç®—æ³•æœ‰äº†ç±»ä¼¼ä»¤ç‰Œæ¡¶èƒ½å¤Ÿåº”å¯¹éƒ¨åˆ†çªå‘æµé‡çš„èƒ½åŠ›ï¼Œå¹¶ä¸”å®ç°ä¸Šè¿˜éå¸¸çš„ç®€å•ï¼Œå€¼å¾—å­¦ä¹ ã€‚</p><p>å¤šçœ‹çœ‹å¥½çš„è½®å­çš„å®ç°æ€»ä¼šå­¦åˆ°ä¸€äº›æ–°å§¿åŠ¿ï¼Œä»Šå¤©å°±å­¦åˆ°äº†ä½¿ç”¨ padding å¡«å……æ¥é¿å… false sharing æé«˜æ€§èƒ½çš„æ“ä½œ</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go è¿›é˜¶è®­ç»ƒè¥-æå®¢æ—¶é—´</a></li><li><a href="https://eddycjy.com/posts/microservice/leaky-token-buckets/">â€œå¸¦ä½ å¿«é€Ÿäº†è§£ï¼šé™æµä¸­çš„æ¼æ¡¶å’Œä»¤ç‰Œæ¡¶ç®—æ³•â€</a></li><li><a href="https://pkg.go.dev/go.uber.org/ratelimit">ratelimit Â· pkg.go.dev</a></li><li><a href="https://github.com/uber-go/ratelimit/blob/main/limiter_atomic.go">ratelimit/limiter_atomic.go at main Â· uber-go/ratelimit (github.com)</a></li><li><a href="https://baike.baidu.com/item/%E6%BC%8F%E6%A1%B6%E7%AE%97%E6%B3%95">æ¼æ¡¶ç®—æ³•_ç™¾åº¦ç™¾ç§‘ (baidu.com)</a></li><li><a href="https://pengrl.com/p/9125/">åˆ©ç”¨ CPU cache ç‰¹æ€§ä¼˜åŒ– Go ç¨‹åº</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week06: å¾®æœåŠ¡å¯ç”¨æ€§è®¾è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¾®æœåŠ¡</tag>
      
      <tag>å¯ç”¨æ€§</tag>
      
      <tag>è¿‡è½½ä¿æŠ¤</tag>
      
      <tag>é™æµ</tag>
      
      <tag>ä»¤ç‰Œæ¡¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¯ç”¨æ€§(ä¸‰) ä»¤ç‰Œæ¡¶çš„å®ç° rate/limt</title>
    <link href="/post/go-training-week6-3-token-bucket-2.html"/>
    <url>/post/go-training-week6-3-token-bucket-2.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç«  <a href="https://lailin.xyz/post/go-training-week6-2-token-bucket-1.html">Go å¯ç”¨æ€§(äºŒ) é™æµ 1: ä»¤ç‰Œæ¡¶åŸç†åŠä½¿ç”¨</a> å½“ä¸­æˆ‘ä»¬ç®€å•çš„ä»‹ç»äº†ä»¤ç‰Œæ¡¶å®ç°çš„åŸç†ï¼Œç„¶ååˆ©ç”¨ <a href="https://pkg.go.dev/golang.org/x/time/rate">/x/time/rate</a> è¿™ä¸ªåº“ 10 è¡Œä»£ç å†™äº†ä¸€ä¸ªåŸºäº ip çš„ gin é™æµä¸­é—´ä»¶ï¼Œé‚£è¿™ä¸ªåŠŸèƒ½æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä»æºç å±‚é¢æ¥äº†è§£ä¸€ä¸‹è¿™ä¸ªåº“çš„å®ç°ã€‚è¿™ä¸ªå®ç°å¾ˆæœ‰æ„æ€ï¼Œå¹¶æ²¡æœ‰çœŸæ­£çš„ä½¿ç”¨ä¸€ä¸ªå®šæ—¶å™¨ä¸æ–­çš„ç”Ÿæˆä»¤ç‰Œï¼Œè€Œæ˜¯é è®¡ç®—çš„æ–¹å¼æ¥å®Œæˆ</p><h2 id="rate-limt"><a href="#rate-limt" class="headerlink" title="rate/limt"></a>rate/limt</h2><blockquote><p>æœ¬æ–‡æºç åŸºäº <a href="https://pkg.go.dev/golang.org/x/time@v0.0.0-20210220033141-f8bda1e9f3ba/rate">https://pkg.go.dev/golang.org/x/time@v0.0.0-20210220033141-f8bda1e9f3ba/rate</a></p></blockquote><p>ä¸Šå›æˆ‘ä»¬è®²åˆ°ï¼Œä½¿ç”¨é™é€Ÿå™¨çš„æ—¶å€™æˆ‘ä»¬éœ€è¦è°ƒç”¨ <code>NewLimiter</code>  æ–¹æ³•ï¼Œç„¶å <code>Limiter</code>  æä¾›äº†ä¸‰ç»„é™é€Ÿçš„æ–¹æ³•ï¼Œè¿™ä¸‰ç»„æ–¹æ³•å…¶å®éƒ½æ˜¯é€šè¿‡è°ƒç”¨ <code>reserveN</code>  å®ç°çš„ <code>reserveN</code>  è¿”å›ä¸€ä¸ª <code>*Reservation</code>  æŒ‡é’ˆï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªç»“æ„ä½“å§ã€‚</p><p><strong>Limiter</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Limiter <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">// äº’æ–¥é”</span><br>mu     sync.Mutex<br><br>    <span class="hljs-comment">// æ¯ç§’äº§ç”Ÿ token çš„é€Ÿåº¦, å…¶å®æ˜¯ float64 çš„ä¸€ä¸ªåˆ«å</span><br>limit  Limit<br><br>    <span class="hljs-comment">// æ¡¶çš„å¤§å°</span><br>burst  <span class="hljs-keyword">int</span><br><br>    <span class="hljs-comment">// å½“å‰æ—¶é—´èŠ‚ç‚¹æ‹¥æœ‰çš„ tokens æ•°é‡</span><br>tokens <span class="hljs-keyword">float64</span><br><br><span class="hljs-comment">// ä¸Šæ¬¡æ›´æ–° token çš„æ—¶é—´</span><br>last time.Time<br><br><span class="hljs-comment">// ä¸Šæ¬¡é™é€Ÿçš„æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´å¯èƒ½æ˜¯è¿‡å»çš„æŸä¸ªæ—¶é—´ä¹Ÿå¯èƒ½æ˜¯å°†æ¥çš„æŸä¸ªæ—¶é—´</span><br>lastEvent time.Time<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Reservation</strong><br>è¿™ä¸ªç»“æ„ä½“æŒºæœ‰æ„æ€çš„ï¼Œè¡¨ç¤ºé¢„çº¦æŸä¸ªæ—¶é—´çš„ token</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Reservation <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">// æ˜¯å¦èƒ½é¢„çº¦ä¸Š</span><br>ok        <span class="hljs-keyword">bool</span><br>    <span class="hljs-comment">// limter</span><br>lim       *Limiter<br>    <span class="hljs-comment">// é¢„çº¦çš„ token æ•°é‡</span><br>tokens    <span class="hljs-keyword">int</span><br>    <span class="hljs-comment">// token å®é™…ä½¿ç”¨çš„æ—¶é—´</span><br>timeToAct time.Time<br><span class="hljs-comment">// ä¿å­˜ä¸€ä¸‹é€Ÿç‡ï¼Œå› ä¸º lim çš„é€Ÿç‡æ˜¯å¯ä»¥è¢«åŠ¨æ€è°ƒæ•´çš„ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ç”¨</span><br>limit Limit<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªåº“å¹¶æ²¡æœ‰ä½¿ç”¨å®šæ—¶å™¨æ¥å‘æ”¾ token è€Œæ˜¯ç”¨äº† lazyload çš„æ–¹å¼ï¼Œç­‰éœ€è¦æ¶ˆè´¹ token çš„æ—¶å€™æ‰é€šè¿‡æ—¶é—´å»è®¡ç®—ç„¶åæ›´æ–° token çš„æ•°é‡ï¼Œä¸‹é¢æˆ‘ä»¬å…ˆé€šè¿‡ä¸€ä¸ªä¾‹å­æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæµç¨‹æ˜¯æ€ä¹ˆè·‘çš„<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1617121384819-00164807-a2c9-4976-a7ab-4169a45a7d0d.png" alt="blog.png"><br>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªé™é€Ÿå™¨ï¼Œå®ƒçš„ token ç”Ÿæˆé€Ÿåº¦ä¸º 1ï¼Œä¹Ÿå°±æ˜¯ä¸€ç§’ä¸€ä¸ªï¼Œæ¡¶çš„å¤§å°ä¸º 10ï¼Œæ¯ä¸ªæ ¼å­è¡¨ç¤ºä¸€ç§’çš„æ—¶é—´é—´éš”</p><ul><li><code>last</code>  è¡¨ç¤ºä¸Šä¸€æ¬¡æ›´æ–° token æ—¶è¿˜æœ‰ 2 ä¸ª tokenã€‚</li><li>ç°åœ¨æˆ‘æœ‰ä¸€ä¸ªè¯·æ±‚è¿›æ¥ï¼Œæˆ‘æ€»å…±éœ€è¦ 7 ä¸ª token æ‰èƒ½å®Œæˆè¿™ä¸ªè¯·æ±‚</li><li><code>now</code>  è¡¨ç¤ºæˆ‘ç°åœ¨è¿›æ¥çš„æ—¶é—´ï¼Œè·ç¦» last å·²ç»è¿‡å»äº† 2sï¼Œé‚£ä¹ˆç°åœ¨å°±æœ‰ 4 ä¸ª token</li><li>æ‰€ä»¥æˆ‘å¦‚æœéœ€è¦ 7 ä¸ª token é‚£ä¹ˆä¹Ÿå°±è¿˜éœ€è¦ç­‰å¾… 3s ä¸­æ‰çœŸçš„æœ‰ 7 ä¸ªï¼Œæ‰€ä»¥è¿™å°±æ˜¯ <code>timeToAct</code>  æ‰€åœ¨çš„æ—¶é—´èŠ‚ç‚¹</li><li>é¢„çº¦æˆåŠŸä¹‹åæ›´æ–° <code>last = now</code> ã€<code>token = -3</code>  å› ä¸º token å·²ç»è¢«é¢„çº¦å‡ºå»äº†æ‰€ä»¥ç°åœ¨å‰©ä¸‹çš„å°±æ˜¯è´Ÿæ•°äº†</li></ul><h3 id="æ¶ˆè´¹-token"><a href="#æ¶ˆè´¹-token" class="headerlink" title="æ¶ˆè´¹ token"></a>æ¶ˆè´¹ token</h3><p>æ€»å…±æœ‰ä¸‰ç»„æ¶ˆè´¹ token çš„æ–¹æ³• <code></code>AllowN, ReserveN, and WaitN<code>æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨çš„</code>reserveN`  è¿™ä¸ªæ–¹æ³•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// now: éœ€è¦æ¶ˆè´¹ token çš„æ—¶é—´ç‚¹</span><br><span class="hljs-comment">// n: éœ€è¦å¤šå°‘ä¸ª token</span><br><span class="hljs-comment">// maxFutureReserve: èƒ½å¤Ÿç­‰å¾…çš„æœ€é•¿æ—¶é—´</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">reserveN</span><span class="hljs-params">(now time.Time, n <span class="hljs-keyword">int</span>, maxFutureReserve time.Duration)</span> <span class="hljs-title">Reservation</span></span> &#123;<br>lim.mu.Lock()<br><br>    <span class="hljs-comment">// å¦‚æœå‘æ”¾ä»¤ç‰Œçš„é€Ÿåº¦æ— ç©·å¤§çš„è¯ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›å°±è¡Œäº†ï¼Œè¦å¤šå°‘å¯ä»¥ç»™å¤šå°‘</span><br><span class="hljs-keyword">if</span> lim.limit == Inf &#123;<br>lim.mu.Unlock()<br><span class="hljs-keyword">return</span> Reservation&#123;<br>ok:        <span class="hljs-literal">true</span>,<br>lim:       lim,<br>tokens:    n,<br>timeToAct: now,<br>&#125;<br>&#125;<br><br>    <span class="hljs-comment">// advance æ–¹æ³•ä¼šå»è®¡ç®—å½“å‰æœ‰å¤šå°‘ä¸ª token</span><br>    <span class="hljs-comment">// åé¢ä¼šè®²åˆ°ï¼Œnow å…¶å®å°±æ˜¯ä¼ å…¥çš„æ—¶é—´ï¼Œä½†æ˜¯ last å¯èƒ½ä¼šå˜</span><br>now, last, tokens := lim.advance(now)<br><br><span class="hljs-comment">// å‘æ”¾ token ä¹‹åè¿˜å‰©å¤šå°‘</span><br>tokens -= <span class="hljs-keyword">float64</span>(n)<br><br><span class="hljs-comment">// æ ¹æ® token æ•°é‡è®¡ç®—éœ€è¦ç­‰å¾…çš„æ—¶é—´</span><br><span class="hljs-keyword">var</span> waitDuration time.Duration<br><span class="hljs-keyword">if</span> tokens &lt; <span class="hljs-number">0</span> &#123;<br>waitDuration = lim.limit.durationFromTokens(-tokens)<br>&#125;<br><br><span class="hljs-comment">// è®¡ç®—æ˜¯å¦å¯ä»¥å‘æ”¾ï¼Œå¦‚æœéœ€è¦çš„é‡æ¯”æ¡¶çš„å®¹é‡è¿˜å¤§è‚¯å®šæ˜¯ä¸è¡Œçš„</span><br>    <span class="hljs-comment">// ç„¶åå°±æ˜¯çœ‹éœ€è¦èƒ½å¦å®¹å¿éœ€è¦ç­‰å¾…çš„æ—¶é—´</span><br>ok := n &lt;= lim.burst &amp;&amp; waitDuration &lt;= maxFutureReserve<br><br><span class="hljs-comment">// Prepare reservation</span><br>r := Reservation&#123;<br>ok:    ok,<br>lim:   lim,<br>limit: lim.limit,<br>&#125;<br>    <span class="hljs-comment">// å¦‚æœå¯ä»¥çš„è¯ï¼Œå°±æŠŠ token åˆ†é…ç»™é¢„çº¦è€…</span><br><span class="hljs-keyword">if</span> ok &#123;<br>r.tokens = n<br>r.timeToAct = now.Add(waitDuration)<br>&#125;<br><br><span class="hljs-comment">// æ›´æ–°å„ä¸ªå­—æ®µçš„çŠ¶æ€</span><br><span class="hljs-keyword">if</span> ok &#123;<br>lim.last = now<br>lim.tokens = tokens<br>lim.lastEvent = r.timeToAct<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// ä¸ºä»€ä¹ˆä¸ ok ä¹Ÿè¦æ›´æ–° last å‘¢ï¼Ÿå› ä¸º last å¯èƒ½ä¼šæ”¹å˜</span><br>lim.last = last<br>&#125;<br><br>lim.mu.Unlock()<br><span class="hljs-keyword">return</span> r<br>&#125;<br></code></pre></td></tr></table></figure><p><code>advance</code>  æ–¹æ³•ç”¨äºè®¡ç®— token çš„æ•°é‡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// now æ˜¯ä¼ å…¥çš„å½“å‰çš„æ—¶é—´ç‚¹ï¼Œè¿”å›çš„ newNow å…¶å®å°±æ˜¯ä¼ å…¥çš„å‚æ•°ï¼Œæ²¡æœ‰ä»»ä½•æ”¹å˜</span><br><span class="hljs-comment">// newLast æ˜¯æ›´æ–° token çš„æ—¶é—´</span><br><span class="hljs-comment">// newTokens æ˜¯ token çš„æ•°é‡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">advance</span><span class="hljs-params">(now time.Time)</span> <span class="hljs-params">(newNow time.Time, newLast time.Time, newTokens <span class="hljs-keyword">float64</span>)</span></span> &#123;<br><span class="hljs-comment">// å¦‚æœå½“å‰æ—¶é—´æ¯”ä¸Šæ¬¡æ›´æ–° token çš„æ—¶é—´è¿˜è¦æ—©ï¼Œé‚£ä¹ˆå°±é‡ç½®ä¸€ä¸‹ last</span><br>    last := lim.last<br><span class="hljs-keyword">if</span> now.Before(last) &#123;<br>last = now<br>&#125;<br><br><span class="hljs-comment">// è¿™é‡Œä¸ºäº†é˜²æ­¢æº¢å‡ºï¼Œå…ˆè®¡ç®—äº†å°†æ¡¶å¡«æ»¡éœ€è¦èŠ±è´¹çš„æœ€å¤§æ—¶é—´</span><br>maxElapsed := lim.limit.durationFromTokens(<span class="hljs-keyword">float64</span>(lim.burst) - lim.tokens)<br>    <span class="hljs-comment">// è®¡ç®—æ—¶é—´å·®ï¼Œå¦‚æœå¤§äºæœ€å¤§æ—¶é—´çš„è¯ï¼Œå°±å–æœ€å¤§å€¼</span><br>elapsed := now.Sub(last)<br><span class="hljs-keyword">if</span> elapsed &gt; maxElapsed &#123;<br>elapsed = maxElapsed<br>&#125;<br><br><span class="hljs-comment">// è®¡ç®—è¿™æ®µæ—¶é—´ç”Ÿæˆçš„ token æ•°é‡ï¼Œå¦‚æœå¤§äºæ¡¶çš„å®¹é‡ï¼Œå°±å–æ¡¶çš„å®¹é‡</span><br>delta := lim.limit.tokensFromDuration(elapsed)<br>tokens := lim.tokens + delta<br><span class="hljs-keyword">if</span> burst := <span class="hljs-keyword">float64</span>(lim.burst); tokens &gt; burst &#123;<br>tokens = burst<br>&#125;<br><br><span class="hljs-keyword">return</span> now, last, tokens<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯å…ˆå»è®¡ç®—äº†æ—¶é—´çš„æœ€å¤§å€¼ï¼Œå› ä¸ºåˆå§‹åŒ–çš„æ—¶å€™æ²¡ä¸º <code>last</code>  èµ‹å€¼ï¼Œæ‰€ä»¥ <code>now.Before(last)</code>  å‡ºæ¥çš„ç»“æœå¯èƒ½æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„å€¼ï¼Œå†å»è®¡ç®— tokens æ•°é‡å¾ˆå¯èƒ½æº¢å‡º</p><p><strong>durationFromTokens</strong> æ ¹æ® tokens çš„æ•°é‡è®¡ç®—éœ€è¦èŠ±è´¹çš„æ—¶é—´</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(limit Limit)</span> <span class="hljs-title">durationFromTokens</span><span class="hljs-params">(tokens <span class="hljs-keyword">float64</span>)</span> <span class="hljs-title">time</span>.<span class="hljs-title">Duration</span></span> &#123;<br>seconds := tokens / <span class="hljs-keyword">float64</span>(limit)<br><span class="hljs-keyword">return</span> time.Nanosecond * time.Duration(<span class="hljs-number">1e9</span>*seconds)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>tokensFromDuration</strong> æ ¹æ®æ—¶é—´è®¡ç®— tokens çš„æ•°é‡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(limit Limit)</span> <span class="hljs-title">tokensFromDuration</span><span class="hljs-params">(d time.Duration)</span> <span class="hljs-title">float64</span></span> &#123;<br><span class="hljs-comment">// è¿™é‡Œé€šè¿‡æ‹†åˆ†æ•´æ•°å’Œå°æ•°éƒ¨åˆ†å¯ä»¥å‡å°‘æ—¶é—´ä¸Šçš„è¯¯å·®</span><br>sec := <span class="hljs-keyword">float64</span>(d/time.Second) * <span class="hljs-keyword">float64</span>(limit)<br>nsec := <span class="hljs-keyword">float64</span>(d%time.Second) * <span class="hljs-keyword">float64</span>(limit)<br><span class="hljs-keyword">return</span> sec + nsec/<span class="hljs-number">1e9</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ¶ˆè´¹-token-æ€»ç»“"><a href="#æ¶ˆè´¹-token-æ€»ç»“" class="headerlink" title="æ¶ˆè´¹ token æ€»ç»“"></a>æ¶ˆè´¹ token æ€»ç»“</h3><p>æ¶ˆè´¹ token çš„é€»è¾‘å°±è®²å®Œäº†ï¼Œæˆ‘ä»¬å¤§æ¦‚æ€»ç»“ä¸€ä¸‹</p><ul><li>éœ€è¦æ¶ˆè´¹çš„æ—¶å€™ï¼Œå…ˆå»è®¡ç®—ä¸€ä¸‹ï¼Œä»è¿‡å»åˆ°ç°åœ¨å¯ä»¥ç”Ÿæˆå¤šå°‘ä¸ª token</li><li>ç„¶åæˆ‘ä»¬é€šè¿‡éœ€è¦çš„ token å‡å»ç°åœ¨æ‹¥æœ‰çš„ token æ•°é‡ï¼Œå°±å¾—åˆ°äº†éœ€è¦é¢„çº¦çš„ token æ•°é‡</li><li>å†é€šè¿‡ token æ•°é‡è½¬æ¢æˆæ—¶é—´ï¼Œå°±å¯ä»¥å¾—åˆ°éœ€è¦ç­‰å¾…çš„æ—¶é—´é•¿åº¦ï¼Œä»¥åŠæ˜¯å¦å¯ä»¥æ¶ˆè´¹</li><li>ç„¶åå†é€šè¿‡ä¸åŒçš„æ¶ˆè´¹æ–¹æ³•è¿›è¡Œæ¶ˆè´¹</li></ul><h3 id="WaitN"><a href="#WaitN" class="headerlink" title="WaitN"></a>WaitN</h3><p>å…¶ä»–ä¸¤ç±»æ¶ˆè´¹æ–¹æ³•éƒ½å¾ˆç®€å•ï¼Œè°ƒç”¨ <code>Reservation</code>  è¿›è¡Œè¿”å›ï¼Œ <code>WaitN</code>  è¿˜æœ‰ä¸€ç‚¹é€»è¾‘ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ctx ç”¨äºæ§åˆ¶è¶…æ—¶, n æ˜¯éœ€è¦æ¶ˆè´¹çš„ token æ•°é‡ï¼Œå¦‚æœ context çš„ Deadline æ—©äºè¦ç­‰å¾…çš„æ—¶é—´å°±ä¼šç›´æ¥è¿”å›å¤±è´¥</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">WaitN</span><span class="hljs-params">(ctx context.Context, n <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(err error)</span></span> &#123;<br>lim.mu.Lock()<br>burst := lim.burst<br>limit := lim.limit<br>lim.mu.Unlock()<br><br>    <span class="hljs-comment">// å…ˆçœ‹ä¸€ä¸‹æ˜¯ä¸æ˜¯å·²ç»è¶…å‡ºæ¶ˆè´¹æé™äº†</span><br><span class="hljs-keyword">if</span> n &gt; burst &amp;&amp; limit != Inf &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;rate: Wait(n=%d) exceeds limiter&#x27;s burst %d&quot;</span>, n, burst)<br>&#125;<br><br>    <span class="hljs-comment">// å¦‚æœ ctx å·²ç»ç»“æŸäº†ä¹Ÿä¸ç”¨ç­‰äº†</span><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br><span class="hljs-keyword">return</span> ctx.Err()<br><span class="hljs-keyword">default</span>:<br>&#125;<br><br><span class="hljs-comment">// è®¡ç®—ä¸€ä¸‹å¯ä»¥ç­‰å¾…çš„æ—¶é—´</span><br>now := time.Now()<br>waitLimit := InfDuration<br><span class="hljs-keyword">if</span> deadline, ok := ctx.Deadline(); ok &#123;<br>waitLimit = deadline.Sub(now)<br>&#125;<br><br><span class="hljs-comment">// è°ƒç”¨ reserveN å¾—åˆ°é¢„çº¦æ•°æ®</span><br>r := lim.reserveN(now, n, waitLimit)<br><br>    <span class="hljs-comment">// å¦‚æœä¸ ok è¯´æ˜é¢„çº¦ä¸åˆ°</span><br><span class="hljs-keyword">if</span> !r.ok &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;rate: Wait(n=%d) would exceed context deadline&quot;</span>, n)<br>&#125;<br><br><span class="hljs-comment">// å¦‚æœå¯ä»¥é¢„çº¦åˆ°ï¼Œè®¡ç®—ä¸€ä¸‹éœ€è¦ç­‰å¤šä¹…</span><br>delay := r.DelayFrom(now)<br><span class="hljs-keyword">if</span> delay == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br>    <span class="hljs-comment">// å¯åŠ¨ä¸€ä¸ª timer è¿›è¡Œå®šæ—¶</span><br>t := time.NewTimer(delay)<br><span class="hljs-keyword">defer</span> t.Stop()<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-t.C:<br><span class="hljs-comment">// We can proceed.</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br><span class="hljs-comment">// å¦‚æœ context ä¸»åŠ¨å–æ¶ˆäº†ï¼Œé‚£ä¹ˆå€¼é’±é¢„çº¦çš„ token æ•°é‡éœ€è¦å½’è¿˜</span><br>r.Cancel()<br><span class="hljs-keyword">return</span> ctx.Err()<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å–æ¶ˆæ¶ˆè´¹"><a href="#å–æ¶ˆæ¶ˆè´¹" class="headerlink" title="å–æ¶ˆæ¶ˆè´¹"></a>å–æ¶ˆæ¶ˆè´¹</h3><p><code>WaitN</code>  å½“ä¸­å¦‚æœé¢„çº¦ä¸Šäº†ï¼Œä½†æ˜¯ <code>Context</code>  å–æ¶ˆäº†ï¼Œä¼šè°ƒç”¨ <code>CancelAt</code>  å½’è¿˜ tokens æˆ‘ä»¬æ¥ä¸€èµ·çœ‹ä¸€ä¸‹æ˜¯æ€ä¹ˆå®ç°çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Reservation)</span> <span class="hljs-title">CancelAt</span><span class="hljs-params">(now time.Time)</span></span> &#123;<br>    <span class="hljs-comment">// ä¸ ok è¯´æ˜æ²¡æœ‰é¢„çº¦ä¸Šï¼Œç›´æ¥è¿”å›å°±è¡Œäº†</span><br><span class="hljs-keyword">if</span> !r.ok &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><br>r.lim.mu.Lock()<br><span class="hljs-keyword">defer</span> r.lim.mu.Unlock()<br><br>    <span class="hljs-comment">// å¦‚æœæ²¡æœ‰é€Ÿç‡é™åˆ¶ï¼Œæˆ–è€…æ²¡æœ‰æ¶ˆè´¹ token æˆ– token å·²ç»è¢«æ¶ˆè´¹äº†ï¼Œéƒ½ä¸ç”¨è¿˜äº†</span><br><span class="hljs-keyword">if</span> r.lim.limit == Inf || r.tokens == <span class="hljs-number">0</span> || r.timeToAct.Before(now) &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// è®¡ç®—éœ€è¦è¿˜çš„ token æ•°é‡</span><br>    <span class="hljs-comment">// è¿™é‡Œè¯´æ˜¯éœ€è¦å‡å»å·²ç»é¢„æ”¯çš„ token æ•°é‡ï¼Œä½†æ˜¯æˆ‘å‘ç°åº”è¯¥æ˜¯ä¸ª bugï¼Œæ„Ÿè§‰è¿™é‡Œå‡é‡å¤äº†</span><br>restoreTokens := <span class="hljs-keyword">float64</span>(r.tokens) - r.limit.tokensFromDuration(r.lim.lastEvent.Sub(r.timeToAct))<br><span class="hljs-keyword">if</span> restoreTokens &lt;= <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><br>    <span class="hljs-comment">// è®¡ç®—å½“å‰æ‹¥æœ‰çš„ tokens æ•°é‡</span><br>now, _, tokens := r.lim.advance(now)<br><br><span class="hljs-comment">// å½“å‰æ‹¥æœ‰çš„åŠ ä¸Šéœ€è¦å½’è¿˜çš„å°±æ˜¯ç°æœ‰çš„ï¼Œä½†æ˜¯ä¸èƒ½å¤§äºæ¡¶çš„å®¹é‡</span><br>tokens += restoreTokens<br><span class="hljs-keyword">if</span> burst := <span class="hljs-keyword">float64</span>(r.lim.burst); tokens &gt; burst &#123;<br>tokens = burst<br>&#125;<br><br><span class="hljs-comment">// æ›´æ–° tokens æ•°é‡</span><br>r.lim.last = now<br>r.lim.tokens = tokens<br><br>    <span class="hljs-comment">// å¦‚æœç›¸ç­‰è¯´æ˜åé¢æ²¡æœ‰æ–°çš„ token æ¶ˆè´¹ï¼Œæ‰€ä»¥å°†çŠ¶æ€é‡ç½®åˆ°ä¸Šä¸€æ¬¡</span><br><span class="hljs-keyword">if</span> r.timeToAct == r.lim.lastEvent &#123;<br>prevEvent := r.timeToAct.Add(r.limit.durationFromTokens(<span class="hljs-keyword">float64</span>(-r.tokens)))<br><span class="hljs-keyword">if</span> !prevEvent.Before(now) &#123;<br>r.lim.lastEvent = prevEvent<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å­˜åœ¨çš„é—®é¢˜"><a href="#å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="å­˜åœ¨çš„é—®é¢˜"></a>å­˜åœ¨çš„é—®é¢˜</h2><p>é™¤äº†ä¸Šé¢æåˆ°çš„æ„Ÿè§‰ cancelAt å¯èƒ½æœ‰ä¸€ä¸ª bug å¤–ï¼Œäº‘ç¥çš„åšå®¢è¿˜æåˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœæˆ‘ä»¬ cancel äº†çš„è¯ï¼Œåé¢å·²ç»åœ¨ç­‰å¾…çš„ä»»åŠ¡æ˜¯ä¸ä¼šé‡æ–°è°ƒæ•´çš„ï¼Œä¸¾ä¸ªä¾‹å­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">wait</span><span class="hljs-params">()</span></span> &#123;<br>l := rate.NewLimiter(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>)<br>t := time.Now()<br>l.ReserveN(t, <span class="hljs-number">10</span>)<br><br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><br>ctx, cancel := context.WithTimeout(context.TODO(), time.Hour)<br><span class="hljs-keyword">defer</span> cancel()<br><br>    <span class="hljs-comment">// æ³¨é‡Šæ‰ä¸‹é¢è¿™æ®µå°±ä¸ä¼šæå‰ cancel</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br><span class="hljs-comment">// æ¨¡æ‹Ÿå‡ºç°é—®é¢˜, 200mså°±å–æ¶ˆäº†</span><br>time.Sleep(<span class="hljs-number">200</span> * time.Millisecond)<br>cancel()<br>&#125;()<br><br>wg.Add(<span class="hljs-number">2</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br><span class="hljs-comment">// å¦‚æœè¦ç­‰ï¼Œè¿™ä¸ªè¦ç­‰ 1s æ‰èƒ½æ‰§è¡Œï¼Œä½†æ˜¯æˆ‘ä»¬çš„ ctx 200ms å°±ä¼šå–æ¶ˆ</span><br>l.WaitN(ctx, <span class="hljs-number">10</span>)<br>fmt.Printf(<span class="hljs-string">&quot;[1] cost: %s\n&quot;</span>, time.Since(t))<br>&#125;()<br><br>time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)<br><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br><span class="hljs-comment">// æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸ªè¦ç­‰ 1.2 s æ‰èƒ½æ‰§è¡Œï¼Œä½†æ˜¯æˆ‘ä»¬å‰é¢éƒ½å–æ¶ˆäº†</span><br><span class="hljs-comment">// è¿™ä¸ªæ˜¯ä¸æ˜¯åº”è¯¥å°±åªéœ€è¦ç­‰ 200ms å°±æ‰§è¡Œäº†</span><br>ctx, cancel := context.WithTimeout(context.Background(), time.Hour)<br><span class="hljs-keyword">defer</span> cancel()<br>l.WaitN(ctx, <span class="hljs-number">2</span>)<br>fmt.Printf(<span class="hljs-string">&quot;[2] cost: %s\n&quot;</span>, time.Since(t))<br>&#125;()<br><br>wg.Wait()<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ä¸æå‰ cancel çš„ç»“æœ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[1] cost: 1.0002113s<br>[2] cost: 1.2007347s<br></code></pre></td></tr></table></figure><p>å†çœ‹çœ‹æå‰ cancel çš„ç»“æœ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[1] cost: 200.8268ms<br>[2] cost: 1.201066s<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å°±æ˜¯ 1 æœ‰å˜åŒ–ï¼Œä» 1s -&gt; 200ms ä½†æ˜¯ 2 ä¸€ç›´éƒ½è¦ç­‰ 1.2s</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»”ç»†çœ‹äº†ä¸€ä¸‹ä»¤ç‰Œæ¡¶çš„å®ç°ï¼Œä½†æ˜¯ä¹Ÿç•™ä¸‹äº†ä¸€ä¸ªç–‘é—®ï¼Œå¦‚æœå“ªä½ç«¥é‹çŸ¥é“å¸Œæœ›å¯ä»¥ç•™è¨€å‘Šè¯‰æˆ‘ï¼Œåœ¨å–æ¶ˆçš„æ—¶å€™ï¼Œä¼šå‡æ‰ä¸€ä¸ªé¢„çº¦çš„æ—¶é—´ï¼Œä½†æ˜¯æˆ‘å‘ç°è¿™é‡Œå…¶å®åº”è¯¥æ˜¯é‡å¤å‡äº†ä¸€æ¬¡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">restoreTokens := <span class="hljs-keyword">float64</span>(r.tokens) - r.limit.tokensFromDuration(r.lim.lastEvent.Sub(r.timeToAct))<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯æµ‹è¯•ä»£ç </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>t0 := time.Now()<br>t1 := time.Now().Add(<span class="hljs-number">100</span> * time.Millisecond)<br>t2 := time.Now().Add(<span class="hljs-number">200</span> * time.Millisecond)<br>t3 := time.Now().Add(<span class="hljs-number">300</span> * time.Millisecond)<br><br>l := rate.NewLimiter(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>)<br>l.ReserveN(t0, <span class="hljs-number">15</span>) <span class="hljs-comment">// æ¡¶é‡Œè¿˜å‰© 5 ä¸ª token</span><br>fmt.Printf(<span class="hljs-string">&quot;%+v\n&quot;</span>, l)<br><br>r := l.ReserveN(t1, <span class="hljs-number">10</span>) <span class="hljs-comment">// æ¡¶è¿˜æœ‰ -4 ä¸ªï¼Œ</span><br>fmt.Printf(<span class="hljs-string">&quot;%+v\n&quot;</span>, l)<br><br><span class="hljs-comment">// æ³¨é‡Šæ‰ä¸‹é¢ä¸¤è¡Œï¼Œæœ€åç»“æœè¿˜å‰© 8 ä¸ª token</span><br>l.ReserveN(t2, <span class="hljs-number">2</span>) <span class="hljs-comment">// æ¡¶é‡Œè¿˜æœ‰ -5 ä¸ª</span><br>fmt.Printf(<span class="hljs-string">&quot;%+v\n&quot;</span>, l)<br><br>r.CancelAt(t3)<br>fmt.Printf(<span class="hljs-string">&quot;%+v\n&quot;</span>, l)<br><span class="hljs-comment">// å½’è¿˜ä¹‹å‰å€Ÿçš„ï¼Œè¿è¡Œç»“æœ æ¡¶é‡Œè¿˜æœ‰ 4 ä¸ª</span><br><span class="hljs-comment">// ä½†æ˜¯è¿™é‡Œä¸åº”è¯¥å‰©ä¸‹ 6 ä¸ªä¹ˆï¼Œæœ¬æ¥æœ‰ 5 ä¸ªï¼Œ300ms ç”Ÿæˆäº† 3 ä¸ªï¼Œåé¢åˆé¢„æ”¯å‡ºå» 2 ä¸ª</span><br><span class="hljs-comment">// è€Œä¸”æˆ‘å‘ç°å¦‚æœæˆ‘æ³¨é‡Šæ‰é¢„æ”¯ä¸¤ä¸ªçš„ä»£ç ï¼Œç»“æœå’Œæˆ‘é¢„æœŸçš„ä¸€è‡´ï¼Œå‰©ä½™ 8 ä¸ªtoken</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><p><a href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go è¿›é˜¶è®­ç»ƒè¥-æå®¢æ—¶é—´</a></p></li><li><p><a href="https://en.wikipedia.org/wiki/Token_bucket">Token bucket - Wikipedia</a></p></li><li><a href="https://baike.baidu.com/item/%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95">ä»¤ç‰Œæ¡¶ç®—æ³•_ç™¾åº¦ç™¾ç§‘ (baidu.com)</a></li><li><a href="https://zhuanlan.zhihu.com/p/158948815">é™æµçš„æ¦‚å¿µï¼Œç®—æ³•ï¼Œåˆ†å¸ƒå¼é™æµä»¥åŠå¾®æœåŠ¡æ¶æ„ä¸‹é™æµçš„éš¾ç‚¹ - çŸ¥ä¹ (zhihu.com)</a></li><li><a href="https://zhuanlan.zhihu.com/p/164503398">ä»¤ç‰Œæ¡¶å·¥ä½œåŸç† - çŸ¥ä¹ (zhihu.com)</a></li><li><a href="https://pkg.go.dev/golang.org/x/time/rate">/x/time/rate</a></li><li><a href="https://pandaychen.github.io/2020/04/05/GOLANG-X-RATELIMIT-ANALYSIS/">å¼€æºé™æµç»„ä»¶åˆ†æï¼ˆäºŒï¼‰ï¼šGolang-time/rate é™é€Ÿç®—æ³•å®ç°åˆ†æ - ç†Šå–µå›çš„åšå®¢ | PANDAYCHEN</a></li><li><a href="http://xiaorui.cc/archives/5930">Golang rate æ— æ³•å»¶è¿Ÿé‡æ’çš„ BUG â€“ å³°äº‘å°±å¥¹äº† (xiaorui.cc)</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week06: å¾®æœåŠ¡å¯ç”¨æ€§è®¾è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¾®æœåŠ¡</tag>
      
      <tag>å¯ç”¨æ€§</tag>
      
      <tag>è¿‡è½½ä¿æŠ¤</tag>
      
      <tag>é™æµ</tag>
      
      <tag>ä»¤ç‰Œæ¡¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¯ç”¨æ€§(äºŒ) ä»¤ç‰Œæ¡¶åŸç†åŠä½¿ç”¨</title>
    <link href="/post/go-training-week6-2-token-bucket-1.html"/>
    <url>/post/go-training-week6-2-token-bucket-1.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p><strong>3 æœˆè¿›åº¦: 10/15</strong>ï¼Œç»ˆäºå®Œæˆäº† 2/3 äº†ï¼Œåç»­æ–‡ç« ä¼šåœ¨é•¿åº¦ä¸Šåšä¸€äº›è°ƒæ•´ï¼Œä¹‹å‰çš„æ–‡ç« é•¿åº¦æœ‰çš„å®åœ¨æ˜¯æ¯”è¾ƒé•¿ï¼Œè¿™æ ·ä¼šå¯¼è‡´ä¸å¤ªä¾¿äºé˜…è¯»ï¼Œç‰¹åˆ«æ˜¯ç°åœ¨å¾ˆå¤šéƒ½æ˜¯ä½¿ç”¨æ‰‹æœºè¿›è¡ŒæŸ¥çœ‹ï¼Œæ‰€ä»¥åé¢æ¯å¤©æ–‡ç« çš„é•¿åº¦ä¼šå°½é‡æ§åˆ¶åœ¨ 2k - 3k è¿™ä¸ªé•¿åº¦ï¼Œå¤ªçŸ­äº†æ²¡å•¥å†…å®¹ï¼Œå¤ªé•¿äº†é˜…è¯»ä¸Šä¼šæœ‰ä¸€äº›ç–²åŠ³</p><p>ä»è¿™ç¯‡æ–‡ç« å¼€å§‹ä¼šå¼€å§‹è®²ä¸€è®²é™æµè¯¥å¦‚ä½•åšï¼Œä¼šç»“åˆ Go è¿›é˜¶è®­ç»ƒè¥ ä¸­çš„å†…å®¹ã€ç½‘ä¸ŠæŸ¥é˜…çš„ä¸€äº›èµ„æ–™ä»¥åŠä¸ªäººä¸€äº›å¾®å°çš„ç»éªŒè¿›è¡Œæ€»ç»“ï¼Œè¿™ä¸€éƒ¨åˆ†é¢„è®¡æ€»å…±ä¼šæœ‰ 7 ç¯‡æ–‡ç« ï¼Œä»Šå¤©æˆ‘ä»¬æ¥å¼€å§‹ç¬¬ä¸€ç¯‡ï¼Œä»¤ç‰Œæ¡¶çš„åŸç†åŠä½¿ç”¨ã€‚</p><h2 id="ä»¤ç‰Œæ¡¶"><a href="#ä»¤ç‰Œæ¡¶" class="headerlink" title="ä»¤ç‰Œæ¡¶"></a>ä»¤ç‰Œæ¡¶</h2><h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1616948682303-85f82a16-c93e-4a35-a9f0-0b480480b374.jpg" alt=""><br>å¦‚ä¸Šå›¾[<a href="https://zhuanlan.zhihu.com/p/164503398">5</a>] æ‰€ç¤ºï¼Œä»¤ç‰Œæ¡¶çš„å¤§æ¦‚åŸç†æ˜¯ï¼š</p><ol><li>æˆ‘ä»¬ä»¥ <code>r/s</code>  çš„é€Ÿåº¦å‘æ¡¶å†…æ”¾ç½®ä»¤ç‰Œï¼Œæ¡¶çš„å®¹é‡ä¸º <code>b</code> , å¦‚æœæ¡¶æ»¡äº†ä»¤ç‰Œå°†ä¼šä¸¢å¼ƒ</li><li>å½“è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œæˆ‘ä»¬å‘æ¡¶å†…è·å–ä»¤ç‰Œï¼Œå¦‚æœä»¤ç‰Œè¶³å¤Ÿï¼Œæˆ‘ä»¬å°±é€šè¿‡è½¬å‘è¯·æ±‚</li><li>å¦‚æœæ¡¶å†…çš„ä»¤ç‰Œæ•°é‡ä¸å¤Ÿï¼Œé‚£ä¹ˆè¿™ä¸ªè¯·æ±‚ä¼šè¢«ç¼“å­˜ç­‰å¾…ä»¤ç‰Œè¶³å¤Ÿæ—¶è½¬å‘ï¼Œæˆ–è€…æ˜¯è¢«ç›´æ¥ä¸¢å¼ƒæ‰</li></ol><p><strong>ç”±äºæ¡¶çš„å­˜åœ¨ï¼Œæ‰€ä»¥ä»¤ç‰Œæ¡¶ç®—æ³•ä¸ä»…å¯ä»¥é™æµè¿˜å¯ä»¥åº”å¯¹çªå‘æµé‡çš„æƒ…å†µ</strong></p><p>ä¸¾ä¸ªä¾‹å­ï¼šå‡è®¾æˆ‘ä»¬æ¡¶çš„å®¹é‡æ˜¯ 100ï¼Œé€Ÿåº¦æ˜¯ 10 rpsï¼Œé‚£ä¹ˆåœ¨æˆ‘ä»¬æ¡¶æ»¡çš„æƒ…å†µä¸‹ï¼Œå¦‚æœçªç„¶æ¥ 100 ä¸ªè¯·æ±‚æ˜¯å¯ä»¥æ»¡è¶³çš„ï¼Œä½†æ˜¯åç»­çš„è¯·æ±‚å°±ä¼šè¢«é™åˆ¶åˆ° 10 rps</p><p><strong>å­˜åœ¨ä¸‹é¢ä¸¤ç§ç‰¹æ®Šæƒ…å†µ</strong></p><ul><li>å¦‚æœæ¡¶çš„å®¹é‡ä¸º 0ï¼Œé‚£ä¹ˆç›¸å½“äºç¦æ­¢è¯·æ±‚ï¼Œå› ä¸ºæ‰€æœ‰çš„ä»¤ç‰Œéƒ½è¢«ä¸¢å¼ƒäº†</li><li>å¦‚æœä»¤ç‰Œæ”¾ç½®é€Ÿç‡ä¸ºæ— ç©·å¤§ï¼Œé‚£ä¹ˆç›¸å½“äºæ²¡æœ‰é™åˆ¶</li></ul><p>ä»¤ç‰Œæ¡¶æœ€å¸¸è§çš„å®ç°å°±æ˜¯ Go å®˜æ–¹çš„ <a href="https://pkg.go.dev/golang.org/x/time/rate">golang.org/x/time/rate</a>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹çœ‹è¿™ä¸ªåº“å¦‚ä½•ä½¿ç”¨å§</p><h3 id="ä½¿ç”¨æ–¹æ³•"><a href="#ä½¿ç”¨æ–¹æ³•" class="headerlink" title="ä½¿ç”¨æ–¹æ³•"></a>ä½¿ç”¨æ–¹æ³•</h3><h4 id="æ–¹æ³•ä¸€è§ˆ"><a href="#æ–¹æ³•ä¸€è§ˆ" class="headerlink" title="æ–¹æ³•ä¸€è§ˆ"></a>æ–¹æ³•ä¸€è§ˆ</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// é™æµå™¨ç»“æ„ä½“</span><br><span class="hljs-keyword">type</span> Limiter<br><span class="hljs-comment">// æ„å»ºä¸€ä¸ªé™æµå™¨ï¼Œr æ˜¯æ¯ç§’æ”¾å…¥çš„ä»¤ç‰Œæ•°é‡ï¼Œb æ˜¯æ¡¶çš„å¤§å°</span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewLimiter</span><span class="hljs-params">(r Limit, b <span class="hljs-keyword">int</span>)</span> *<span class="hljs-title">Limiter</span></span><br><br><span class="hljs-comment">// åˆ†åˆ«è¿”å› b å’Œ r çš„å€¼</span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">Burst</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">Limit</span><span class="hljs-params">()</span> <span class="hljs-title">Limit</span></span><br><br><span class="hljs-comment">// token æ¶ˆè´¹æ–¹æ³•</span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">Allow</span><span class="hljs-params">()</span> <span class="hljs-title">bool</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">AllowN</span><span class="hljs-params">(now time.Time, n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">Reserve</span><span class="hljs-params">()</span> *<span class="hljs-title">Reservation</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">ReserveN</span><span class="hljs-params">(now time.Time, n <span class="hljs-keyword">int</span>)</span> *<span class="hljs-title">Reservation</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">Wait</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-params">(err error)</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">WaitN</span><span class="hljs-params">(ctx context.Context, n <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(err error)</span></span><br><br><span class="hljs-comment">// åŠ¨æ€æµæ§</span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">SetBurst</span><span class="hljs-params">(newBurst <span class="hljs-keyword">int</span>)</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">SetBurstAt</span><span class="hljs-params">(now time.Time, newBurst <span class="hljs-keyword">int</span>)</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">SetLimit</span><span class="hljs-params">(newLimit Limit)</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">SetLimitAt</span><span class="hljs-params">(now time.Time, newLimit Limit)</span></span><br></code></pre></td></tr></table></figure><h4 id="åˆå§‹åŒ–ä»¤ç‰Œæ¡¶"><a href="#åˆå§‹åŒ–ä»¤ç‰Œæ¡¶" class="headerlink" title="åˆå§‹åŒ–ä»¤ç‰Œæ¡¶"></a>åˆå§‹åŒ–ä»¤ç‰Œæ¡¶</h4><p>ç›´æ¥è°ƒç”¨ <code>NewLimiter(r Limit, b int)</code>  å³å¯ï¼Œ <code>r</code>  è¡¨ç¤ºæ¯ç§’äº§ç”Ÿ token çš„é€Ÿåº¦ï¼Œ <code>b</code>  è¡¨ç¤ºæ¡¶çš„å¤§å°</p><h4 id="Token-æ¶ˆè´¹"><a href="#Token-æ¶ˆè´¹" class="headerlink" title="Token æ¶ˆè´¹"></a>Token æ¶ˆè´¹</h4><p>æ€»å…±æœ‰ä¸‰ç§ token æ¶ˆè´¹çš„æ–¹å¼ï¼Œæœ€å¸¸ç”¨çš„æ˜¯ä½¿ç”¨ <code>Wait</code>  é˜»å¡ç­‰å¾…<br>**<br><strong>Allow</strong></p><p><code>Allow</code>  å°±æ˜¯ <code>AllowN(now,1)</code>  çš„åˆ«åï¼Œ <code>AllowN</code>  è¡¨ç¤ºæˆªæ­¢åˆ° <code>now</code>  è¿™ä¸ªæ—¶é—´ç‚¹ï¼Œæ˜¯å¦å­˜åœ¨ <code>n</code>  ä¸ª tokenï¼Œå¦‚æœå­˜åœ¨é‚£ä¹ˆå°±è¿”å› true åä¹‹è¿”å› falseï¼Œå¦‚æœæˆ‘ä»¬é™æµæ¯”è¾ƒä¸¥æ ¼ï¼Œæ²¡æœ‰èµ„æºå°±ç›´æ¥ä¸¢å¼ƒå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">Allow</span><span class="hljs-params">()</span> <span class="hljs-title">bool</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">AllowN</span><span class="hljs-params">(now time.Time, n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span><br></code></pre></td></tr></table></figure><p>**<br><strong>Reserve</strong></p><p>åŒç† <code>Reserve</code>  ä¹Ÿæ˜¯ <code>ReserveN(now, 1)</code>  çš„åˆ«åï¼Œ <code>ReserveN</code>  å…¶å®å’Œ <code>AllowN</code>  ç±»ä¼¼ï¼Œè¡¨ç¤ºæˆªæ­¢åˆ° <code>now</code>  è¿™ä¸ªæ—¶é—´ç‚¹ï¼Œæ˜¯å¦å­˜åœ¨ <code>n</code>  ä¸ª tokenï¼Œåªæ˜¯ <code>AllowN</code>  ç›´æ¥è¿”å› true or falseï¼Œä½†æ˜¯ <code>ReserveN</code>  è¿”å›ä¸€ä¸ª <code>Reservation</code>  å¯¹è±¡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">Reserve</span><span class="hljs-params">()</span> *<span class="hljs-title">Reservation</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">ReserveN</span><span class="hljs-params">(now time.Time, n <span class="hljs-keyword">int</span>)</span> *<span class="hljs-title">Reservation</span></span><br></code></pre></td></tr></table></figure><p><code>Reservation</code>  æœ‰ 5 ä¸ªæ–¹æ³•ï¼Œé€šè¿‡è°ƒç”¨ <code>OK</code>  æˆ‘ä»¬å¯ä»¥çŸ¥é“æ˜¯å¦é€šè¿‡ç­‰å¾…å¯ä»¥è·å–åˆ° N ä¸ª tokenï¼Œå¦‚æœå¯ä»¥é€šè¿‡ <code>Delay</code>  æ–¹æ³•æˆ‘ä»¬å¯ä»¥å¾—çŸ¥éœ€è¦ç­‰å¾…çš„æ—¶é—´ï¼Œå¦‚æœæˆ‘ä»¬ä¸æƒ³ç­‰äº†å¯ä»¥è°ƒç”¨ <code>Cancel</code>  æ–¹æ³•å½’è¿˜ token</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Reservation<br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Reservation)</span> <span class="hljs-title">Cancel</span><span class="hljs-params">()</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Reservation)</span> <span class="hljs-title">CancelAt</span><span class="hljs-params">(now time.Time)</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Reservation)</span> <span class="hljs-title">Delay</span><span class="hljs-params">()</span> <span class="hljs-title">time</span>.<span class="hljs-title">Duration</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Reservation)</span> <span class="hljs-title">DelayFrom</span><span class="hljs-params">(now time.Time)</span> <span class="hljs-title">time</span>.<span class="hljs-title">Duration</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Reservation)</span> <span class="hljs-title">OK</span><span class="hljs-params">()</span> <span class="hljs-title">bool</span></span><br></code></pre></td></tr></table></figure><p>**<br><strong>Wait</strong></p><p><code>Wait</code>  æ˜¯æœ€å¸¸ç”¨çš„ï¼Œ <code>Wait</code>  æ˜¯ <code>WaitN(ctx, 1)</code>  çš„åˆ«åï¼Œ <code>WaitN(ctx, n)</code>  è¡¨ç¤ºå¦‚æœå­˜åœ¨ <code>n</code>  ä¸ªä»¤ç‰Œå°±ç›´æ¥è½¬å‘ï¼Œä¸å­˜åœ¨æˆ‘ä»¬å°±ç­‰ï¼Œç­‰å¾…å­˜åœ¨ä¸ºæ­¢ï¼Œä¼ å…¥çš„ <code>ctx</code>  çš„ <code>Deadline</code>  å°±æ˜¯ç­‰å¾…çš„ Deadline</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">Wait</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-params">(err error)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">WaitN</span><span class="hljs-params">(ctx context.Context, n <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(err error)</span></span><br></code></pre></td></tr></table></figure><h4 id="åŠ¨æ€æµæ§"><a href="#åŠ¨æ€æµæ§" class="headerlink" title="åŠ¨æ€æµæ§"></a>åŠ¨æ€æµæ§</h4><p>é€šè¿‡è°ƒç”¨ <code>SetBurst</code>  å’Œ <code>SetLimit</code>  å¯ä»¥åŠ¨æ€çš„è®¾ç½®æ¡¶çš„å¤§å°å’Œ token ç”Ÿäº§é€Ÿç‡ï¼Œå…¶ä¸­ <code>SetBurstAt</code>  å’Œ <code>SetLimitAt</code>  ä¼šå°†ä¼ å…¥çš„æ—¶é—´ <code>now</code>  è®¾ç½®ä¸ºæµæ§æœ€åçš„æ›´æ–°æ—¶é—´</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">SetBurst</span><span class="hljs-params">(newBurst <span class="hljs-keyword">int</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">SetBurstAt</span><span class="hljs-params">(now time.Time, newBurst <span class="hljs-keyword">int</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">SetLimit</span><span class="hljs-params">(newLimit Limit)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span> <span class="hljs-title">SetLimitAt</span><span class="hljs-params">(now time.Time, newLimit Limit)</span></span><br></code></pre></td></tr></table></figure><h3 id="æ¡ˆä¾‹-10-è¡Œä»£ç å®ç°-åŸºäº-ip-çš„-gin-é™æµä¸­é—´ä»¶"><a href="#æ¡ˆä¾‹-10-è¡Œä»£ç å®ç°-åŸºäº-ip-çš„-gin-é™æµä¸­é—´ä»¶" class="headerlink" title="æ¡ˆä¾‹: 10 è¡Œä»£ç å®ç° åŸºäº ip çš„ gin é™æµä¸­é—´ä»¶"></a>æ¡ˆä¾‹: 10 è¡Œä»£ç å®ç° åŸºäº ip çš„ gin é™æµä¸­é—´ä»¶</h3><p>æ­£å¥½ä¸Šå‘¨æˆ‘ä»¬æœ‰ä¸ªç±»ä¼¼çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å°±æ¥ç®€å•å®ç°ä¸€ä¸‹ï¼Œå…¶å®ä¸»è¦å°±æ˜¯ä½¿ç”¨äº† <code>sync.map</code>  æ¥ä¸ºæ¯ä¸€ä¸ª ip åˆ›å»ºä¸€ä¸ª limiterï¼Œå½“ç„¶è¿™ä¸ª key ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–çš„å€¼ï¼Œä¾‹å¦‚ç”¨æˆ·åç­‰</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewLimiter</span><span class="hljs-params">(r rate.Limit, b <span class="hljs-keyword">int</span>, t time.Duration)</span> <span class="hljs-title">gin</span>.<span class="hljs-title">HandlerFunc</span></span> &#123;<br>limiters := &amp;sync.Map&#123;&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br><span class="hljs-comment">// è·å–é™é€Ÿå™¨</span><br><span class="hljs-comment">// key é™¤äº† ip ä¹‹å¤–ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–çš„ï¼Œä¾‹å¦‚ headerï¼Œuser name ç­‰</span><br>key := c.ClientIP()<br>l, _ := limiters.LoadOrStore(key, rate.NewLimiter(r, b))<br><br><span class="hljs-comment">// è¿™é‡Œæ³¨æ„ä¸è¦ç›´æ¥ä½¿ç”¨ gin çš„ context é»˜è®¤æ˜¯æ²¡æœ‰è¶…æ—¶æ—¶é—´çš„</span><br>ctx, cancel := context.WithTimeout(c, t)<br><span class="hljs-keyword">defer</span> cancel()<br><br><span class="hljs-keyword">if</span> err := l.(*rate.Limiter).Wait(ctx); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// è¿™é‡Œå…ˆä¸å¤„ç†æ—¥å¿—äº†ï¼Œå¦‚æœè¿”å›é”™è¯¯å°±ç›´æ¥ 429</span><br>c.AbortWithStatusJSON(http.StatusTooManyRequests, gin.H&#123;<span class="hljs-string">&quot;error&quot;</span>: err&#125;)<br>&#125;<br>c.Next()<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨çš„æ—¶å€™åªéœ€è¦ use ä¸€ä¸‹ä¸­é—´ä»¶å°±å¯ä»¥äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>e := gin.Default()<br><span class="hljs-comment">// æ–°å»ºä¸€ä¸ªé™é€Ÿå™¨ï¼Œå…è®¸çªå‘ 10 ä¸ªå¹¶å‘ï¼Œé™é€Ÿ 3rpsï¼Œè¶…è¿‡ 500ms å°±ä¸å†ç­‰å¾…</span><br>e.Use(NewLimiter(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>, <span class="hljs-number">500</span>*time.Millisecond))<br>e.GET(<span class="hljs-string">&quot;ping&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>c.String(http.StatusOK, <span class="hljs-string">&quot;pong&quot;</span>)<br>&#125;)<br>e.Run(<span class="hljs-string">&quot;:8080&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä½¿ç”¨ <code>go-stress-testing</code>  æ¥å‹æµ‹ä¸€ä¸‹ï¼Œ20 ä¸ªå¹¶å‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"> ~/gopath/bin/go-stress-testing-mac -c 20 -n 1 -u http://127.0.0.1:8080/ping<br><br>å¼€å§‹å¯åŠ¨  å¹¶å‘æ•°:20 è¯·æ±‚æ•°:1 è¯·æ±‚å‚æ•°:<br><br>â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€<br>  è€—æ—¶â”‚  å¹¶å‘æ•°â”‚  æˆåŠŸæ•°â”‚  å¤±è´¥æ•°â”‚   qps  â”‚ æœ€é•¿è€—æ—¶â”‚  æœ€çŸ­è€—æ—¶â”‚ å¹³å‡è€—æ—¶â”‚  ä¸‹è½½å­—èŠ‚â”‚ å­—èŠ‚æ¯ç§’â”‚ é”™è¯¯ç <br>â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€<br>   1sâ”‚     20â”‚     11â”‚      9â”‚   63.79â”‚  438.48â”‚   45.37â”‚  313.53â”‚     152â”‚     259â”‚200:11;429:9<br><br><br>*************************  ç»“æœ <span class="hljs-built_in">stat</span>  ****************************<br>å¤„ç†åç¨‹æ•°é‡: 20<br>è¯·æ±‚æ€»æ•°ï¼ˆå¹¶å‘æ•°*è¯·æ±‚æ•° -c * -nï¼‰: 20 æ€»è¯·æ±‚æ—¶é—´: 0.586 ç§’ successNum: 11 failureNum: 9<br>*************************  ç»“æœ end   ****************************<br></code></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°æ€»å…±æˆåŠŸäº† 11 ä¸ªè¯·æ±‚ï¼Œå¤±è´¥äº† 9 ä¸ªï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ¡¶çš„å¤§å°æ˜¯ 10 æ‰€ä»¥å‰ 10 ä¸ªè¯·æ±‚éƒ½å¾ˆå¿«å°±ç»“æŸäº†ï¼Œç¬¬ 11 ä¸ªè¯·æ±‚ç­‰å¾… 333.3 ms å°±å¯ä»¥å®Œæˆï¼Œå°äºè¶…æ—¶æ—¶é—´ 500msï¼Œæ‰€ä»¥å¯ä»¥æ”¾è¡Œï¼Œä½†æ˜¯åé¢çš„è¯·æ±‚ç¡®æ˜¯ç­‰ä¸äº†äº†ï¼Œæ‰€ä»¥å°±éƒ½å¤±è´¥äº†ï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°æœ€åä¸€ä¸ªæˆåŠŸçš„è¯·æ±‚çš„è€—æ—¶ä¸º <code>336.83591ms</code>  è€Œå…¶ä»–çš„è¯·æ±‚è€—æ—¶éƒ½å¾ˆçŸ­</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">[GIN-debug] Listening and serving HTTP on :8080<br>[GIN] 2021/03/29 - 13:15:55 | 200 |     1.48104ms |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 429 |    1.107689ms |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 429 |    1.746222ms |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 429 |      866.35Âµs |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 429 |    1.870403ms |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 429 |    2.231912ms |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 429 |    1.832506ms |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 429 |     613.741Âµs |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 200 |    1.454753ms |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 200 |     1.37802ms |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 200 |    1.428062ms |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 200 |      40.782Âµs |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 200 |    1.046146ms |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 429 |      1.7624ms |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 429 |    1.803124ms |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 200 |       41.67Âµs |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 200 |     1.42315ms |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 200 |    1.371483ms |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 200 |     731.091Âµs |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br>[GIN] 2021/03/29 - 13:15:55 | 200 |   336.83591ms |       127.0.0.1 | GET      <span class="hljs-string">&quot;/ping&quot;</span><br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ç¯‡ä¸»è¦ä»‹ç»äº†ä¸€ä¸‹ä»¤ç‰Œæ¡¶çš„å®ç°åŸç†ï¼Œä»¥åŠ Go å®˜æ–¹å®ç°å¦‚ä½•ä½¿ç”¨ï¼Œæœ€åè®²äº†ä¸€ä¸ªä½¿ç”¨æ¡ˆä¾‹ï¼Œä¸‹ä¸€ç¯‡æˆ‘ä»¬å†æ¥å­¦ä¹ ä¸€ä¸‹æºç æ˜¯æ€ä¹ˆå®ç°çš„</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go è¿›é˜¶è®­ç»ƒè¥-æå®¢æ—¶é—´</a></li><li><a href="https://en.wikipedia.org/wiki/Token_bucket">Token bucket - Wikipedia</a></li><li><a href="https://baike.baidu.com/item/%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95">ä»¤ç‰Œæ¡¶ç®—æ³•_ç™¾åº¦ç™¾ç§‘ (baidu.com)</a></li><li><a href="https://zhuanlan.zhihu.com/p/158948815">é™æµçš„æ¦‚å¿µï¼Œç®—æ³•ï¼Œåˆ†å¸ƒå¼é™æµä»¥åŠå¾®æœåŠ¡æ¶æ„ä¸‹é™æµçš„éš¾ç‚¹ - çŸ¥ä¹ (zhihu.com)</a></li><li><a href="https://zhuanlan.zhihu.com/p/164503398">ä»¤ç‰Œæ¡¶å·¥ä½œåŸç† - çŸ¥ä¹ (zhihu.com)</a></li><li><a href="https://pkg.go.dev/golang.org/x/time/rate">golang.org/x/time/rate</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week06: å¾®æœåŠ¡å¯ç”¨æ€§è®¾è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¾®æœåŠ¡</tag>
      
      <tag>å¯ç”¨æ€§</tag>
      
      <tag>è¿‡è½½ä¿æŠ¤</tag>
      
      <tag>é™æµ</tag>
      
      <tag>ä»¤ç‰Œæ¡¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¯ç”¨æ€§(ä¸€) éš”ç¦»è®¾è®¡</title>
    <link href="/post/go-training-week6-usability-1-bulkhe.html"/>
    <url>/post/go-training-week6-usability-1-bulkhe.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p><strong>3 æœˆè¿›åº¦: 09/15</strong></p><p>éš”ç¦»è®¾è®¡æºäºèˆ¹èˆ¶è¡Œä¸šï¼Œä¸€èˆ¬è€Œè¨€æ— è®ºå¤§èˆ¹è¿˜æ˜¯å°èˆ¹ï¼Œéƒ½ä¼šæœ‰ä¸€äº›éš”æ¿ï¼Œå°†èˆ¹åˆ†ä¸ºä¸åŒçš„ç©ºé—´ï¼Œè¿™æ ·å¦‚æœæœ‰èˆ¹èˆ±æ¼æ°´ä¸€èˆ¬åªä¼šå½±å“è¿™ä¸€å°å—ç©ºé—´ï¼Œä¸è‡³äºæŠŠæ•´ä¸ªèˆ¹éƒ½ç»™ææ²‰äº†ã€‚</p><p>åŒæ ·æˆ‘ä»¬çš„è½¯ä»¶æœåŠ¡ä¹Ÿæ˜¯ä¸€ä¸ªé“ç†ï¼Œæˆ‘ä»¬è¦å°½é‡é¿å…å‡ºç°ä¸€ä¸ªé—®é¢˜å°±æŠŠè¿™ä¸ªä¸šåŠ¡ç»™ææŒ‚çš„æƒ…å†µå‡ºç°ã€‚</p><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1616682187683-fee45154-b69e-438c-8c09-53dfe5f32916.png" alt=""><br>ä¸€èˆ¬è€Œè¨€ç±»ä¼¼çš„æ–‡ç« éƒ½ä¼šå‘Šè¯‰å¤§å®¶æœåŠ¡éš”ç¦»åº”è¯¥åˆ†ä¸ºå“ªé‡Œç±»å‹ï¼Œæˆ–è€…é‚£äº›çº§åˆ«ï¼Œç„¶åä¸€èˆ¬åˆ†åˆ«æ€ä¹ˆåšï¼Œä»Šå¤©æˆ‘ä»¬æ¢ä¸€ä¸ªå¥—è·¯ï¼Œæˆ‘ä»¬ä»ä¸€ä¸ªæœåŠ¡æ¼”è¿›çš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬æœåŠ¡éš”ç¦»æ˜¯æ€ä¹ˆåšçš„</p><h2 id="æœåŠ¡çš„æ¼”è¿›"><a href="#æœåŠ¡çš„æ¼”è¿›" class="headerlink" title="æœåŠ¡çš„æ¼”è¿›"></a>æœåŠ¡çš„æ¼”è¿›</h2><p>PS: æ¥ä¸‹æ¥çš„éƒ¨åˆ†æ¶æ„çº¯å±çæ‰¯ï¼Œä½†æ˜¯é“ç†æ˜¯å·®ä¸å¤šçš„ï¼Œè¾›è‹¦å„ä½å‡‘åˆçœ‹ä¸€ä¸‹äº†</p><p>å¦‚ä¸‹å›¾ï¼Œä»Šå¤©å¤©æ°”ä¸é”™ï¼Œæˆ‘ä»¬å¼€å§‹åˆ›ä¸šï¼ˆå¤©æ°”å’Œåˆ›ä¸šæœ‰å•¥å…³ç³»ï¼Ÿï¼Ÿï¼Ÿï¼‰ï¼Œæäº†ä¸€ä¸ªç”µå•†ç½‘ç«™ï¼Œç”±äºå‰æœŸäººæ‰‹ä¸è¶³æŠ€æœ¯ä¹Ÿä¸å¤Ÿï¼Œå°±ä¸€ä¸ªæœåŠ¡å’Œä¸€ä¸ªæ•°æ®åº“å°±å¼€å§‹å¯¹å¤–æä¾›æœåŠ¡äº†<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1616682861837-8c345d62-e181-478e-b51f-81a46bf33aee.jpeg" alt="v1.jpg"><br>éšç€è´§ç‰©çš„ä¸æ–­ä¸Šæ¶ï¼Œæˆ‘ä»¬å‘ç°äº§å“ç›¸å…³ä»‹ç»çš„å›¾ç‰‡ã€è§†é¢‘ç­‰ä¿¡æ¯å ç”¨äº†æˆ‘ä»¬æœåŠ¡çš„å¤§éƒ¨åˆ†å¸¦å®½ï¼Œå¹¶ä¸”ä¹Ÿä¸å¤ªå¥½ç®¡ç†ï¼Œç”¨æˆ·è®¿é—®å‘¢ä¹Ÿæ¯”è¾ƒæ…¢ï¼Œå½±å“äº†å‰æ‰‹çš„ä½“éªŒï¼Œè¿™æ—¶å€™æˆ‘ä»¬åšäº†ä¸€æ³¢ä¼˜åŒ–ï¼ŒæŠŠé™æ€èµ„æºçš„æ•°æ®ä½¿ç”¨äº‘æœåŠ¡å•†æä¾›çš„å¯¹è±¡å­˜å‚¨ç»™ä¿å­˜äº†èµ·æ¥ï¼Œç„¶ååœ¨å‰é¢æ¥å…¥äº†ä¸€ä¸ª CDN ç»™ç”¨æˆ·æä¾›æ›´å¥½çš„ä½“éªŒã€‚</p><p><strong>è¿™å°±æ˜¯ç¬¬ä¸€æ¬¡éš”ç¦»ï¼ŒåŠ¨é™éš”ç¦»ï¼Œæˆ‘ä»¬ä½¿ç”¨å¯¹è±¡å­˜å‚¨å’Œ CDN å°†é™æ€èµ„æºå’ŒåŠ¨æ€ API è¿›è¡Œäº†éš”ç¦»</strong><br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1616682867673-bcc803dd-6d8a-4868-a4bb-c26401d21951.jpeg" alt="v2.jpg"><br>ç„¶åçªç„¶æœ‰ä¸€å¤©æˆ‘ä»¬å‘ç°ï¼Œç”¨æˆ·å¤§é‡æŠ•è¯‰è¯´ä»€ä¹ˆåƒåœ¾ç½‘ç«™ï¼Œçªç„¶è®¿é—®è¿™ä¹ˆæ…¢ï¼Œè¿›è¿‡ç´§é”£å¯†é¼“çš„æ’æŸ¥å‘ç°ï¼ŒåŸæ¥æ˜¯æˆ‘ä»¬çš„è¿è¥åŒå­¦åœ¨åå°è¿›è¡Œæ•°æ®ç»Ÿè®¡å‡†å¤‡å‡ºæŠ¥å‘Šçš„æ—¶å€™å½±å“äº†ç”Ÿäº§çš„æ•°æ®åº“ï¼Œå¯¼è‡´å½±å“äº†æˆ‘ä»¬çš„ç”¨æˆ·ã€‚</p><p>è¿™æ€ä¹ˆèƒ½è¡Œå‘¢ï¼Œæ€ä¹ˆå¯ä»¥å½±å“æˆ‘ä»¬çš„è¡£é£Ÿçˆ¶æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰è¿›è¡Œäº†ä¸€æ³¢ä¼˜åŒ–ï¼Œæˆ‘ä»¬å¯¹æ•°æ®åº“è¿›è¡Œäº†ä¸»ä»åˆ†ç¦»ï¼Œç„¶åå°†è¿è¥åå°å’Œæˆ‘ä»¬çš„å•†åŸä¸»æœåŠ¡åšäº†æ‹†åˆ†ï¼Œåç»­æ‰€æœ‰çš„ç»Ÿè®¡æŸ¥è¯¢è¯·æ±‚æˆ‘ä»¬éƒ½ä»ä»åº“æŸ¥è¯¢ï¼Œå…¶ä»–è¯·æ±‚æ‰ä¼šå»ä¿®æ”¹ä¸»åº“ã€‚</p><p><strong>æ˜¯æ»´ï¼Œæˆ‘ä»¬åˆåšäº†ä¸€æ¬¡éš”ç¦»ï¼Œä¸€ä¸ªæ˜¯å°†æ•°æ®åº“åšäº†ä¸»ä»éš”ç¦»ï¼Œå¦å¤–ä¸€ä¸ªæŒ‰ç…§ä¸åŒçš„ç”¨æˆ·å±æ€§ï¼Œåšäº†ç”¨æˆ·éš”ç¦»ã€‚å½“ç„¶è¿™æ˜¯æ¯”è¾ƒå®è§‚çš„åœ¨è¿™è¿‡ç¨‹ä¸­æˆ‘ä»¬è‚¯å®šä¹Ÿä¼šå¯¹æ•°æ®ä¸­çš„è¡¨è¿›è¡Œä¸€äº›æ‹†åˆ†è®¾è®¡ï¼Œä¾‹å¦‚å°†ç»å¸¸å˜åŒ–çš„æ•°æ®å’Œä¸å¤ªç»å¸¸å˜åŒ–çš„æ•°æ®åˆ†é…åˆ°ä¸¤å¼ è¡¨ç­‰ã€‚</strong><br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1616682875486-e25112ea-7339-4f10-b899-73bcda442ee5.jpeg" alt="v3.jpg"></p><p>ä¸çŸ¥é“æ˜¯éšç€ä¸€äº›çˆ†æ¬¾æ´»åŠ¨çš„é€€å‡ºï¼Œä»¥åŠä¸çŸ¥åå¤§ V çš„æ¨å¹¿ä½¿å¾—æˆ‘ä»¬çš„ä¸šåŠ¡æ¬£æ¬£å‘ä¸Šï¼Œè¿˜æ˜¯æˆ‘ä»¬æ–°æ¥çš„æŠ€æœ¯æ€»ç›‘ä¸ºäº† KPI æˆ‘ä»¬è¿›è¡Œäº†è½°è½°çƒˆçƒˆçš„å¾®æœåŠ¡æ”¹é€ çš„æ´»åŠ¨ï¼Œæœ€åç»è¿‡é•¿è¾¾ä¸€å¹´å¤šçš„æ”¹é€ ï¼Œæˆ‘ä»¬çš„æœåŠ¡æ¶æ„æ”¹é€ æˆäº†ä¸‹é¢è¿™ä¸ªæ¨¡æ ·ã€‚</p><p>æˆ‘ä»¬çš„è¯·æ±‚æ‰è®¿é—®ä¹‹å‰éƒ½ä¼šå…ˆç»è¿‡ WAF é˜²ç«å¢™ï¼Œç„¶ååœ¨åˆ°å¯¹åº”çš„ CDN èŠ‚ç‚¹ç„¶åç»è¿‡æˆ‘ä»¬çš„ API ç½‘å…³åˆ° BFF å±‚ã€‚ç„¶å BFF å±‚å†å»è°ƒç”¨å„ç§æœåŠ¡èšåˆæˆä¸šåŠ¡æ•°æ®å¹¶ä¸”è¿”å›ã€‚</p><p><strong>æˆ‘ä»¬å…¶å®åˆåšäº†ä¸€å±‚æŒ‰ç…§æœåŠ¡çš„éš”ç¦»ï¼Œæˆ‘ä»¬å°†ä¸€ä¸ªå•ä½“æœåŠ¡æ‹†åˆ†æˆäº†ä¸€ä¸ªä¸ªçš„å°æœåŠ¡ï¼Œå°±ä¸ä¼šå‡ºç°è¯„è®ºæŒ‚æ‰äº†å¯¼è‡´æ•´ä¸ªæœåŠ¡æŒ‚æ‰æ— æ³•ä¸‹å•çš„æƒ…å†µã€‚</strong><br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1616683768644-9612104e-32b1-4dbd-a560-66624867c1f1.png" alt="v4.png"><br>å¾®æœåŠ¡æ”¹é€ å®Œæˆä¹‹åæˆ‘ä»¬å‘ç°ï¼Œçš„ç¡®æ•´ä½“çš„æœåŠ¡è´¨é‡éƒ½å¥½äº†å¾ˆå¤šï¼Œä½†æ˜¯çªå¦‚å…¶æ¥çš„ä¸€ä¸ª bug å¯¼è‡´æˆ‘ä»¬çš„ç›‘æ§å¤§é‡å‘Šè­¦ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼ŒåŸæ¥æ˜¯æˆ‘ä»¬çš„æ¨èæœåŠ¡å‡ºç°äº†ä¸€ä¸ªå†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œç„¶åæˆ‘ä»¬çš„æœåŠ¡é™åˆ¶åšçš„ä¸å¤Ÿå¥½æ ¹æœ¬æ²¡æœ‰è®¾ç½®ä»»ä½•é™åˆ¶ï¼Œè¿™å°±å¯¼è‡´å®ƒå ç”¨äº†èµ„æºæ± ä¸­çš„å¤§é‡èµ„æºï¼Œè®©æˆ‘ä»¬çš„å…¶ä»–æœåŠ¡èµ„æºç´§ç¼ºã€‚</p><p>ç„¶åæˆ‘ä»¬å°±åˆåšäº†ä¸€ä¸ªæ”¹é€ ï¼Œæˆ‘ä»¬æŠŠæ”¯ä»˜å’Œå•†åŸè¿™ç§æœ€é‡è¦çš„ä¸šåŠ¡å•ç‹¬æ”¾åœ¨äº†ä¸€ä¸ªæ± å­é‡Œé¢ï¼Œå¯¹äºåƒè¯„è®ºæ¨èè¿™ç§æ²¡æœ‰é‚£ä¹ˆé‡è¦çš„ä¸šåŠ¡æ”¾åœ¨å…±äº«çš„èµ„æºæ± å½“ä¸­ã€‚</p><p><strong>æ‰€ä»¥è¿™ä¸€æ¬¡æˆ‘ä»¬æŒ‰ç…§æœåŠ¡çš„ä¼˜å…ˆçº§è¿›è¡Œäº†éš”ç¦»</strong><br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1616684093160-fc520e2b-60c0-4c79-be59-a424c2dca9fa.png" alt="v5.png"><br>ç„¶åçªç„¶æœ‰ä¸€å¤©ï¼Œæˆ‘ä»¬çš„ä¸€ä¸ªå•†å“æˆä¸ºäº†çˆ†æ¬¾ï¼Œå¤§é‡ç”¨æˆ·æ¶Œå…¥è®¿é—®ï¼ŒæˆåŠŸå°†æˆ‘ä»¬çš„ cache æ‰“æŒ‚ï¼Œåç»­æˆ‘ä»¬åšäº†ä»€ä¹ˆæ”¹åŠ¨å‘¢ï¼Œæˆ‘ä»¬å°† remote cache æå‡ä¸ºäº† local cacheï¼Œåœ¨ sdk å½“ä¸­è‡ªåŠ¨è¯†åˆ«å‡ºçƒ­ç‚¹æµé‡ï¼Œç„¶åå°†å…¶ç¼“å­˜ï¼Œå¤§å¤§å‡å°‘äº† redis çš„å‹åŠ›</p><p><strong>è¿™ä¸€æ¬¡æˆ‘ä»¬å°±å°†çƒ­ç‚¹æ•°æ®è¿›è¡Œäº†éš”ç¦»</strong><br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1616685784499-6e9c1df5-44e1-437b-a400-099b1fcbeee6.png" alt="V6.png"><br>å¥½å•¦ï¼Œçæ‰¯ç»“æŸæ€»ç»“ä¸€ä¸‹å§</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡ä¸Šé¢çº¯å±è™šæ„çš„é¢å‘äº‹æ•…é©±åŠ¨çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬éš”ç¦»è®¾è®¡ä¸€èˆ¬åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š</p><ul><li>æœåŠ¡éš”ç¦»<ul><li>åŠ¨é™éš”ç¦»ï¼šä¾‹å¦‚ä¸Šé¢è®²åˆ°çš„ CDN</li><li>è¯»å†™éš”ç¦»ï¼šä¾‹å¦‚ä¸Šé¢è®²åˆ°çš„ä¸»ä»ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰å¸¸è§çš„ CQRS æ¨¡å¼ï¼Œåˆ†åº“åˆ†è¡¨ç­‰</li></ul></li><li>è½»é‡éš”ç¦»<ul><li>æ ¸å¿ƒéš”ç¦»ï¼šä¾‹å¦‚ä¸Šé¢è®²åˆ°å°†æ ¸å¿ƒä¸šåŠ¡ç‹¬ç«‹éƒ¨ç½²ï¼Œéæ ¸å¿ƒä¸šåŠ¡å…±äº«èµ„æº</li><li>çƒ­ç‚¹éš”ç¦»ï¼šä¾‹å¦‚ä¸Šé¢è®²åˆ°çš„ remote cache åˆ° local cache</li><li>ç”¨æˆ·éš”ç¦»ï¼šä¸åŒçš„ç”¨æˆ·å¯èƒ½æœ‰ä¸åŒçš„çº§åˆ«ï¼Œä¾‹å¦‚ä¸Šé¢è®²åˆ°çš„å¤–éƒ¨ç”¨æˆ·å’Œç®¡ç†å‘˜</li></ul></li><li>ç‰©ç†éš”ç¦»<ul><li>çº¿ç¨‹ï¼šå¸¸è§çš„ä¾‹å­å°±æ˜¯çº¿ç¨‹æ± ï¼Œè¿™ä¸ªåœ¨ Golang ä¸­ä¸€èˆ¬ä¸ç”¨è¿‡å¤šè€ƒè™‘ï¼Œruntime å·²ç»å¸®æˆ‘ä»¬ç®¡ç†å¥½äº†ï¼ˆåç»­æœ‰ä¸€ä¸ªç³»åˆ—è®²è¿™ä¸ªï¼‰</li><li>è¿›ç¨‹ï¼šæˆ‘ä»¬ç°åœ¨ä¸€èˆ¬ä½¿ç”¨å®¹å™¨åŒ–æœåŠ¡ï¼Œè·‘åœ¨ k8s ä¸Šè¿™å°±æ˜¯ä¸€ç§è¿›ç¨‹çº§åˆ«çš„éš”ç¦»</li><li>æœºæˆ¿ï¼šæˆ‘ä»¬ç›®å‰åœ¨ K8s çš„åŸºç¡€ä¸Šåšä¸€äº›å¼€å‘ï¼Œå¸¸è§çš„ä¸€ç§åšæ³•å°±æ˜¯å°†æˆ‘ä»¬çš„æœåŠ¡çš„ä¸åŒå‰¯æœ¬å°½é‡çš„åˆ†é…åœ¨ä¸åŒçš„å¯ç”¨åŒºï¼Œå®é™…ä¸Šå°±æ˜¯äº‘å‚å•†çš„ä¸åŒæœºæˆ¿ï¼Œé¿å…æœºæˆ¿åœç”µæˆ–è€…ç€ç«ä¹‹ç±»çš„å½±å“</li><li>é›†ç¾¤ï¼šéå¸¸é‡è¦çš„æœåŠ¡æˆ‘ä»¬å¯ä»¥éƒ¨ç½²å¤šå¥—ï¼Œåœ¨ç‰©ç†ä¸Šè¿›è¡Œéš”ç¦»ï¼Œå¸¸è§çš„æœ‰å¼‚åœ°éƒ¨ç½²ï¼Œä¹Ÿå¯èƒ½å°±éƒ¨ç½²åœ¨åŒä¸€ä¸ªåŒºåŸŸ</li></ul></li></ul><p>ä»Šå¤©çš„å†…å®¹å°±åˆ°è¿™é‡Œï¼Œç”»å›¾çœŸçš„å¥½è´¹æ—¶é—´ï¼Œä¸‹ç¯‡æ–‡ç« è®²ä¸€è®²è¿‡è½½ä¿æŠ¤-ä»¤ç‰Œæ¡¶ï¼Œæ•¬è¯·æœŸå¾…</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go è¿›é˜¶è®­ç»ƒè¥-æå®¢æ—¶é—´</a></li><li><a href="https://zhuanlan.zhihu.com/p/40475855">æ¶æ„è®¾è®¡ä¹‹ã€ŒæœåŠ¡éš”ç¦»ã€</a></li><li><a href="https://time.geekbang.org/column/article/3917">42 | å¼¹åŠ›è®¾è®¡ç¯‡ä¹‹â€œéš”ç¦»è®¾è®¡â€-æå®¢æ—¶é—´</a></li><li><a href="https://time.geekbang.org/column/article/3912">41 | å¼¹åŠ›è®¾è®¡ç¯‡ä¹‹â€œè®¤è¯†æ•…éšœå’Œå¼¹åŠ›è®¾è®¡â€-æå®¢æ—¶é—´</a></li><li><a href="https://developer.aliyun.com/article/712982">å¦‚ä½•è®¾è®¡é«˜å¯ç”¨ç³»ç»Ÿä¹‹æ•…éšœéš”ç¦»-é˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒº</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week06: å¾®æœåŠ¡å¯ç”¨æ€§è®¾è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¾®æœåŠ¡</tag>
      
      <tag>å¯ç”¨æ€§</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¹¶å‘ç¼–ç¨‹(åäºŒ) Singleflight</title>
    <link href="/post/go-training-week5-singleflight.html"/>
    <url>/post/go-training-week5-singleflight.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p><strong>3 æœˆè¿›åº¦: 08/15</strong> ï¼ˆæœˆåˆå®šçš„ç›®æ ‡æ„Ÿè§‰å¿«å®Œä¸æˆäº†ï¼‰</p><p>è¿™ä¸€ç¯‡æ–‡ç« çš„å†…å®¹æ˜¯åœ¨ <a href="https://lailin.xyz/post/go-training-week5-comment-design-1.html">Week05: è¯„è®ºç³»ç»Ÿæ¶æ„è®¾è®¡</a> å½“ä¸­çš„å¯ç”¨æ€§è®¾è®¡å½“ä¸­æåˆ°çš„ï¼Œä½†æ˜¯è¿™ä¸ªå±äº Go å®˜æ–¹æ‰©å±•åŒæ­¥åŒ… (<a href="https://pkg.go.dev/golang.org/x/sync/singleflight">golang.org/x/sync/singleflight</a>) çš„ä¸€ä¸ªåº“ï¼Œä¸ºäº†è®©å†…å®¹ç»Ÿä¸€å°±æ”¾åˆ°è¿™é‡Œäº†ã€‚</p><p>åºŸè¯åˆ°æ­¤ç»“æŸï¼Œæ­£å¼è¿›å…¥ä»Šå¤©çš„å†…å®¹</p><h2 id="SingleFlight"><a href="#SingleFlight" class="headerlink" title="SingleFlight"></a>SingleFlight</h2><h3 id="ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦-SingleFlightï¼ˆä½¿ç”¨åœºæ™¯ï¼‰ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦-SingleFlightï¼ˆä½¿ç”¨åœºæ™¯ï¼‰ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ SingleFlightï¼ˆä½¿ç”¨åœºæ™¯ï¼‰ï¼Ÿ"></a>ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ SingleFlightï¼ˆä½¿ç”¨åœºæ™¯ï¼‰ï¼Ÿ</h3><p>ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬åœ¨å†™ä¸€å†™å¯¹å¤–çš„æœåŠ¡çš„æ—¶å€™éƒ½ä¼šæœ‰ä¸€å±‚ cache ä½œä¸ºç¼“å­˜ï¼Œç”¨æ¥å‡å°‘åº•å±‚æ•°æ®åº“çš„å‹åŠ›ï¼Œä½†æ˜¯åœ¨é‡åˆ°ä¾‹å¦‚ redis æŠ–åŠ¨æˆ–è€…å…¶ä»–æƒ…å†µå¯èƒ½ä¼šå¯¼è‡´å¤§é‡çš„ cache miss å‡ºç°ã€‚</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯èƒ½å­˜åœ¨æ¥è‡ªæ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯çš„ç”¨æˆ·æœ‰ 1000 çš„å¹¶å‘è¯·æ±‚ï¼Œä»–ä»¬éƒ½è®¿é—®çš„è·å–æ–‡ç« åˆ—è¡¨çš„æ¥å£ï¼Œè·å–å‰ 20 æ¡ä¿¡æ¯ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æœåŠ¡ç›´æ¥å»è®¿é—® redis å‡ºç° cache miss é‚£ä¹ˆæˆ‘ä»¬å°±ä¼šå»è¯·æ±‚ 1000 æ¬¡æ•°æ®åº“ï¼Œè¿™æ—¶å¯èƒ½ä¼šç»™æ•°æ®åº“å¸¦æ¥è¾ƒå¤§çš„å‹åŠ›ï¼ˆè¿™é‡Œçš„ 1000 åªæ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå®é™…ä¸Šå¯èƒ½è¿œå¤§äºè¿™ä¸ªå€¼ï¼‰å¯¼è‡´æˆ‘ä»¬çš„æœåŠ¡å¼‚å¸¸æˆ–è€…è¶…æ—¶ã€‚<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1616344003127-d6a6a921-8913-4dd0-aa1e-cdd032cd6df5.jpeg" alt="Frame 1.jpg"><br>è¿™æ—¶å€™å°±å¯ä»¥ä½¿ç”¨ singleflight åº“äº†ï¼Œç›´è¯‘è¿‡æ¥å°±æ˜¯å•é£ï¼Œè¿™ä¸ªåº“çš„ä¸»è¦ä½œç”¨å°±æ˜¯å°†ä¸€ç»„ç›¸åŒçš„è¯·æ±‚åˆå¹¶æˆä¸€ä¸ªè¯·æ±‚ï¼Œå®é™…ä¸Šåªä¼šå»è¯·æ±‚ä¸€æ¬¡ï¼Œç„¶åå¯¹æ‰€æœ‰çš„è¯·æ±‚è¿”å›ç›¸åŒçš„ç»“æœã€‚<br>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä½¿ç”¨ singleflight ä¹‹åï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ªè¯·æ±‚çš„æ—¶é—´å‘¨æœŸå†…å®é™…ä¸Šåªä¼šå‘åº•å±‚çš„æ•°æ®åº“å‘èµ·ä¸€æ¬¡è¯·æ±‚å¤§å¤§å‡å°‘å¯¹æ•°æ®åº“çš„å‹åŠ›ã€‚<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1616344014634-6cd2cdbf-2eaf-450d-836d-083b1d2fc35e.jpeg" alt="Frame 2.jpg"></p><h3 id="SingleFlight-åŒ…æ€ä¹ˆç”¨ï¼ˆä½¿ç”¨æ•™ç¨‹ï¼‰ï¼Ÿ"><a href="#SingleFlight-åŒ…æ€ä¹ˆç”¨ï¼ˆä½¿ç”¨æ•™ç¨‹ï¼‰ï¼Ÿ" class="headerlink" title="SingleFlight åŒ…æ€ä¹ˆç”¨ï¼ˆä½¿ç”¨æ•™ç¨‹ï¼‰ï¼Ÿ"></a>SingleFlight åŒ…æ€ä¹ˆç”¨ï¼ˆä½¿ç”¨æ•™ç¨‹ï¼‰ï¼Ÿ</h3><h4 id="å‡½æ•°ç­¾å"><a href="#å‡½æ•°ç­¾å" class="headerlink" title="å‡½æ•°ç­¾å"></a>å‡½æ•°ç­¾å</h4><p>ä¸»è¦æ˜¯ä¸€ä¸ª <code>Group</code>  ç»“æ„ä½“ï¼Œä¸‰ä¸ªæ–¹æ³•ï¼Œå…·ä½“ä¿¡æ¯çœ‹ä¸‹æ–¹æ³¨é‡Š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Group<br>    <span class="hljs-comment">// Do æ‰§è¡Œå‡½æ•°, å¯¹åŒä¸€ä¸ª key å¤šæ¬¡è°ƒç”¨çš„æ—¶å€™ï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ²¡æœ‰æ‰§è¡Œå®Œçš„æ—¶å€™</span><br><span class="hljs-comment">// åªä¼šæ‰§è¡Œä¸€æ¬¡ fn å…¶ä»–çš„è°ƒç”¨ä¼šé˜»å¡ä½ç­‰å¾…è¿™æ¬¡è°ƒç”¨è¿”å›</span><br><span class="hljs-comment">// v, err æ˜¯ä¼ å…¥çš„ fn çš„è¿”å›å€¼</span><br><span class="hljs-comment">// shared è¡¨ç¤ºæ˜¯å¦çœŸæ­£æ‰§è¡Œäº† fn è¿”å›çš„ç»“æœï¼Œè¿˜æ˜¯è¿”å›çš„å…±äº«çš„ç»“æœ</span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">Do</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>, fn <span class="hljs-keyword">func</span>()</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span>) <span class="hljs-params">(v <span class="hljs-keyword">interface</span>&#123;&#125;, err error, shared <span class="hljs-keyword">bool</span>)</span></span><br><br><span class="hljs-comment">// DoChan å’Œ Do ç±»ä¼¼ï¼Œåªæ˜¯ DoChan è¿”å›ä¸€ä¸ª channelï¼Œä¹Ÿå°±æ˜¯åŒæ­¥ä¸å¼‚æ­¥çš„åŒºåˆ«</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">DoChan</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>, fn <span class="hljs-keyword">func</span>()</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span>) &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">Result</span></span><br><br>    <span class="hljs-comment">// Forget ç”¨äºé€šçŸ¥ Group åˆ é™¤æŸä¸ª key è¿™æ ·åé¢ç»§ç»­è¿™ä¸ª key çš„è°ƒç”¨çš„æ—¶å€™å°±ä¸ä¼šåœ¨é˜»å¡ç­‰å¾…äº†</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">Forget</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span></span><br></code></pre></td></tr></table></figure><h4 id="ä½¿ç”¨ç¤ºä¾‹"><a href="#ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h4><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å®é™…ä¸Šæˆ‘ä»¬æ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼Œå…ˆä½¿ç”¨ä¸€ä¸ªæ™®é€šçš„ä¾‹å­ï¼Œè¿™æ—¶ä¸€ä¸ªè·å–æ–‡ç« è¯¦æƒ…çš„å‡½æ•°ï¼Œæˆ‘ä»¬åœ¨å‡½æ•°é‡Œé¢ä½¿ç”¨ä¸€ä¸ª count æ¨¡æ‹Ÿä¸åŒå¹¶å‘ä¸‹çš„è€—æ—¶çš„ä¸åŒï¼Œå¹¶å‘è¶Šå¤šè¯·æ±‚è€—æ—¶è¶Šå¤š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getArticle</span><span class="hljs-params">(id <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(article <span class="hljs-keyword">string</span>, err error)</span></span> &#123;<br><span class="hljs-comment">// å‡è®¾è¿™é‡Œä¼šå¯¹æ•°æ®åº“è¿›è¡Œè°ƒç”¨, æ¨¡æ‹Ÿä¸åŒå¹¶å‘ä¸‹è€—æ—¶ä¸åŒ</span><br>atomic.AddInt32(&amp;count, <span class="hljs-number">1</span>)<br>time.Sleep(time.Duration(count) * time.Millisecond)<br><br><span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;article: %d&quot;</span>, id), <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä½¿ç”¨ singleflight çš„æ—¶å€™å°±åªéœ€è¦ <code>new(singleflight.Group)</code>  ç„¶åè°ƒç”¨ä¸€ä¸‹ç›¸å¯¹åº”çš„ Do æ–¹æ³•å°±å¯äº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">singleflightGetArticle</span><span class="hljs-params">(sg *singleflight.Group, id <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(<span class="hljs-keyword">string</span>, error)</span></span> &#123;<br>v, err, _ := sg.Do(fmt.Sprintf(<span class="hljs-string">&quot;%d&quot;</span>, id), <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span></span> &#123;<br><span class="hljs-keyword">return</span> getArticle(id)<br>&#125;)<br><br><span class="hljs-keyword">return</span> v.(<span class="hljs-keyword">string</span>), err<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ•ˆæœæµ‹è¯•"><a href="#æ•ˆæœæµ‹è¯•" class="headerlink" title="æ•ˆæœæµ‹è¯•"></a>æ•ˆæœæµ‹è¯•</h4><p>å…‰è¯´ä¸ç»ƒå‡æŠŠå¼ï¼Œå†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•ä»£ç ï¼Œä¸‹é¢æˆ‘ä»¬å¯åŠ¨ 1000 ä¸ª Goroutine å»å¹¶å‘è°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> count <span class="hljs-keyword">int32</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>time.AfterFunc(<span class="hljs-number">1</span>*time.Second, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>atomic.AddInt32(&amp;count, -count)<br>&#125;)<br><br><span class="hljs-keyword">var</span> (<br>wg  sync.WaitGroup<br>now = time.Now()<br>n   = <span class="hljs-number">1000</span><br>sg  = &amp;singleflight.Group&#123;&#125;<br>)<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// res, _ := singleflightGetArticle(sg, 1)</span><br>res, _ := getArticle(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">if</span> res != <span class="hljs-string">&quot;article: 1&quot;</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;err&quot;</span>)<br>&#125;<br>wg.Done()<br>&#125;()<br>&#125;<br><br>wg.Wait()<br>fmt.Printf(<span class="hljs-string">&quot;åŒæ—¶å‘èµ· %d æ¬¡è¯·æ±‚ï¼Œè€—æ—¶: %s&quot;</span>, n, time.Since(now))<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ˜¯è°ƒç”¨ <code>getArticle</code>  æ–¹æ³•çš„è€—æ—¶ï¼ŒèŠ±è´¹äº† 1s å¤š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ç›´æ¥è°ƒç”¨çš„è¯·æ±‚è€—æ—¶</span><br>â¯ go run ./1.go<br>åŒæ—¶å‘èµ· 1000 æ¬¡è¯·æ±‚ï¼Œè€—æ—¶: 1.0022831s<br></code></pre></td></tr></table></figure><p>è€Œä½¿ç”¨ singleflight çš„æ–¹æ³•ï¼ŒèŠ±è´¹äº†ä¸åˆ° 3ms</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä½¿ç”¨ singleflight çš„è¯·æ±‚è€—æ—¶</span><br>â¯ go run ./1.go<br>åŒæ—¶å‘èµ· 1000 æ¬¡è¯·æ±‚ï¼Œè€—æ—¶: 2.5119ms<br></code></pre></td></tr></table></figure><p>å½“ç„¶æ¯ä¸ªåº“éƒ½æœ‰è‡ªå·±çš„ä½¿ç”¨åœºæ™¯ï¼Œè½¯ä»¶é¢†åŸŸé‡Œé¢æ²¡æœ‰é“¶å¼¹ï¼Œå¦‚æœæˆ‘ä»¬ç”¨çš„ä¸å¤ªå¥½çš„è¯ç”šè‡³å¯èƒ½ä¼šå¾—åˆ°é€‚å¾—å…¶åçš„æ•ˆæœï¼Œè€Œå¤šçœ‹æºç ä¸ä»…èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬è¿›è¡Œå­¦ä¹ ï¼Œä¹Ÿå¯ä»¥å°½é‡å°‘è¸©å‘</p><h3 id="å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼ˆæºç åˆ†æï¼‰ï¼Ÿ"><a href="#å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼ˆæºç åˆ†æï¼‰ï¼Ÿ" class="headerlink" title="å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼ˆæºç åˆ†æï¼‰ï¼Ÿ"></a>å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼ˆæºç åˆ†æï¼‰ï¼Ÿ</h3><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">æœ¬æ–‡åŸºäº <a href="https://pkg.go.dev/golang.org/x/sync@v0.0.0-20210220032951-036812b2e83c/singleflight">https://pkg.go.dev/golang.org/x/sync@v0.0.0-20210220032951-036812b2e83c/singleflight</a> è¿›è¡Œåˆ†æï¼Œè¿™ä¸ªåº“çš„å®ç°å¾ˆç®€å•ï¼Œä½†æ˜¯åŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œè¿˜æœ‰ä¸€äº›å°æŠ€å·§ï¼Œéå¸¸å€¼å¾—å­¦ä¹ </div><h4 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Group <span class="hljs-keyword">struct</span> &#123;<br>mu sync.Mutex       <span class="hljs-comment">// protects m</span><br>m  <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*call <span class="hljs-comment">// lazily initialized</span><br>&#125;<br></code></pre></td></tr></table></figure><p>Group ç»“æ„ä½“ç”±ä¸€ä¸ªäº’æ–¥é”å’Œä¸€ä¸ª map ç»„æˆï¼Œå¯ä»¥çœ‹åˆ°æ³¨é‡Š map æ˜¯æ‡’åŠ è½½çš„ï¼Œæ‰€ä»¥ Group åªè¦å£°æ˜å°±å¯ä»¥ä½¿ç”¨ï¼Œä¸ç”¨è¿›è¡Œé¢å¤–çš„åˆå§‹åŒ–é›¶å€¼å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚call ä¿å­˜äº†å½“å‰è°ƒç”¨å¯¹åº”çš„ä¿¡æ¯ï¼Œmap çš„é”®å°±æ˜¯æˆ‘ä»¬è°ƒç”¨ <code>Do</code>  æ–¹æ³•ä¼ å…¥çš„ key</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> call <span class="hljs-keyword">struct</span> &#123;<br>wg sync.WaitGroup<br><br><span class="hljs-comment">// å‡½æ•°çš„è¿”å›å€¼ï¼Œåœ¨ wg è¿”å›å‰åªä¼šå†™å…¥ä¸€æ¬¡</span><br>val <span class="hljs-keyword">interface</span>&#123;&#125;<br>err error<br><br><span class="hljs-comment">// ä½¿ç”¨è°ƒç”¨äº† Forgot æ–¹æ³•</span><br>forgotten <span class="hljs-keyword">bool</span><br><br>    <span class="hljs-comment">// ç»Ÿè®¡è°ƒç”¨æ¬¡æ•°ä»¥åŠè¿”å›çš„ channel</span><br>dups  <span class="hljs-keyword">int</span><br>chans []<span class="hljs-keyword">chan</span>&lt;- Result<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Do"><a href="#Do" class="headerlink" title="Do"></a>Do</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">Do</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>, fn <span class="hljs-keyword">func</span>()</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span>) <span class="hljs-params">(v <span class="hljs-keyword">interface</span>&#123;&#125;, err error, shared <span class="hljs-keyword">bool</span>)</span></span> &#123;<br>g.mu.Lock()<br><br>    <span class="hljs-comment">// å‰é¢æåˆ°çš„æ‡’åŠ è½½</span><br>    <span class="hljs-keyword">if</span> g.m == <span class="hljs-literal">nil</span> &#123;<br>g.m = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*call)<br>&#125;<br><br>    <span class="hljs-comment">// ä¼šå…ˆå»çœ‹ key æ˜¯å¦å·²ç»å­˜åœ¨</span><br><span class="hljs-keyword">if</span> c, ok := g.m[key]; ok &#123;<br>       <span class="hljs-comment">// å¦‚æœå­˜åœ¨å°±ä¼šè§£é”</span><br>c.dups++<br>g.mu.Unlock()<br><br>        <span class="hljs-comment">// ç„¶åç­‰å¾… WaitGroup æ‰§è¡Œå®Œæ¯•ï¼Œåªè¦ä¸€æ‰§è¡Œå®Œï¼Œæ‰€æœ‰çš„ wait éƒ½ä¼šè¢«å”¤é†’</span><br>c.wg.Wait()<br><br>        <span class="hljs-comment">// è¿™é‡ŒåŒºåˆ† panic é”™è¯¯å’Œ runtime çš„é”™è¯¯ï¼Œé¿å…å‡ºç°æ­»é”ï¼Œåé¢å¯ä»¥çœ‹åˆ°ä¸ºä»€ä¹ˆè¿™ä¹ˆåš</span><br><span class="hljs-keyword">if</span> e, ok := c.err.(*panicError); ok &#123;<br><span class="hljs-built_in">panic</span>(e)<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> c.err == errGoexit &#123;<br>runtime.Goexit()<br>&#125;<br><span class="hljs-keyword">return</span> c.val, c.err, <span class="hljs-literal">true</span><br>&#125;<br><br>    <span class="hljs-comment">// å¦‚æœæˆ‘ä»¬æ²¡æœ‰æ‰¾åˆ°è¿™ä¸ª key å°± new call</span><br>c := <span class="hljs-built_in">new</span>(call)<br><br>    <span class="hljs-comment">// ç„¶åè°ƒç”¨ waitgroup è¿™é‡Œåªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨ä¼š add 1ï¼Œå…¶ä»–çš„éƒ½ä¼šè°ƒç”¨ wait é˜»å¡æ‰</span><br>    <span class="hljs-comment">// æ‰€ä»¥è¿™è¦è¿™æ¬¡è°ƒç”¨è¿”å›ï¼Œæ‰€æœ‰é˜»å¡çš„è°ƒç”¨éƒ½ä¼šè¢«å”¤é†’</span><br>c.wg.Add(<span class="hljs-number">1</span>)<br>g.m[key] = c<br>g.mu.Unlock()<br><br>    <span class="hljs-comment">// ç„¶åæˆ‘ä»¬è°ƒç”¨ doCall å»æ‰§è¡Œ</span><br>g.doCall(c, key, fn)<br><span class="hljs-keyword">return</span> c.val, c.err, c.dups &gt; <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="doCall"><a href="#doCall" class="headerlink" title="doCall"></a>doCall</h4><p>è¿™ä¸ªæ–¹æ³•çš„å®ç°æœ‰ç‚¹æ„æ€ï¼Œä½¿ç”¨äº†ä¸¤ä¸ª defer å·§å¦™çš„å°† runtime çš„é”™è¯¯å’Œæˆ‘ä»¬ä¼ å…¥ function çš„ panic åŒºåˆ«å¼€æ¥é¿å…äº†ç”±äºä¼ å…¥çš„ function panic å¯¼è‡´çš„æ­»é”</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">doCall</span><span class="hljs-params">(c *call, key <span class="hljs-keyword">string</span>, fn <span class="hljs-keyword">func</span>()</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span>)</span> &#123;<br>normalReturn := <span class="hljs-literal">false</span><br>recovered := <span class="hljs-literal">false</span><br><br>    <span class="hljs-comment">// ç¬¬ä¸€ä¸ª defer æ£€æŸ¥ runtime é”™è¯¯</span><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><br>&#125;()<br><br>    <span class="hljs-comment">// ä½¿ç”¨ä¸€ä¸ªåŒ¿åå‡½æ•°æ¥æ‰§è¡Œ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> !normalReturn &#123;<br>                <span class="hljs-comment">// å¦‚æœ panic äº†æˆ‘ä»¬å°± recover æ‰ï¼Œç„¶å new ä¸€ä¸ª panic çš„é”™è¯¯</span><br>                <span class="hljs-comment">// åé¢åœ¨ä¸Šå±‚é‡æ–° panic</span><br><span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> &#123;<br>c.err = newPanicError(r)<br>&#125;<br>&#125;<br>&#125;()<br><br>c.val, c.err = fn()<br><br>        <span class="hljs-comment">// å¦‚æœ fn æ²¡æœ‰ panic å°±ä¼šæ‰§è¡Œåˆ°è¿™ä¸€æ­¥ï¼Œå¦‚æœ panic äº†å°±ä¸ä¼šæ‰§è¡Œåˆ°è¿™ä¸€æ­¥</span><br>        <span class="hljs-comment">// æ‰€ä»¥å¯ä»¥é€šè¿‡è¿™ä¸ªå˜é‡æ¥åˆ¤æ–­æ˜¯å¦ panic äº†</span><br>normalReturn = <span class="hljs-literal">true</span><br>&#125;()<br><br>    <span class="hljs-comment">// å¦‚æœ normalReturn ä¸º false å°±è¡¨ç¤ºï¼Œæˆ‘ä»¬çš„ fn panic äº†</span><br>    <span class="hljs-comment">// å¦‚æœæ‰§è¡Œåˆ°äº†è¿™ä¸€æ­¥ï¼Œä¹Ÿè¯´æ˜æˆ‘ä»¬çš„ fn  recover ä½äº†ï¼Œä¸æ˜¯ç›´æ¥ runtime exit</span><br><span class="hljs-keyword">if</span> !normalReturn &#123;<br>recovered = <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†æ¥çœ‹çœ‹ç¬¬ä¸€ä¸ª defer ä¸­çš„ä»£ç </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// å¦‚æœæ—¢æ²¡æœ‰æ­£å¸¸æ‰§è¡Œå®Œæ¯•ï¼Œåˆæ²¡æœ‰ recover é‚£å°±è¯´æ˜éœ€è¦ç›´æ¥é€€å‡ºäº†</span><br><span class="hljs-keyword">if</span> !normalReturn &amp;&amp; !recovered &#123;<br>c.err = errGoexit<br>&#125;<br><br>c.wg.Done()<br>g.mu.Lock()<br><span class="hljs-keyword">defer</span> g.mu.Unlock()<br><br>       <span class="hljs-comment">// å¦‚æœå·²ç» forgot è¿‡äº†ï¼Œå°±ä¸è¦é‡å¤åˆ é™¤è¿™ä¸ª key äº†</span><br><span class="hljs-keyword">if</span> !c.forgotten &#123;<br><span class="hljs-built_in">delete</span>(g.m, key)<br>&#125;<br><br><span class="hljs-keyword">if</span> e, ok := c.err.(*panicError); ok &#123;<br><span class="hljs-comment">// å¦‚æœè¿”å›çš„æ˜¯ panic é”™è¯¯ï¼Œä¸ºäº†é¿å… channel æ­»é”ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿è¿™ä¸ª panic æ— æ³•è¢«æ¢å¤</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(c.chans) &gt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-built_in">panic</span>(e)<br><span class="hljs-keyword">select</span> &#123;&#125; <span class="hljs-comment">// Keep this goroutine around so that it will appear in the crash dump.</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-built_in">panic</span>(e)<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> c.err == errGoexit &#123;<br><span class="hljs-comment">// å·²ç»å‡†å¤‡é€€å‡ºäº†ï¼Œä¹Ÿå°±ä¸ç”¨åšå…¶ä»–æ“ä½œäº†</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// æ­£å¸¸æƒ…å†µä¸‹å‘ channel å†™å…¥æ•°æ®</span><br><span class="hljs-keyword">for</span> _, ch := <span class="hljs-keyword">range</span> c.chans &#123;<br>ch &lt;- Result&#123;c.val, c.err, c.dups &gt; <span class="hljs-number">0</span>&#125;<br>&#125;<br>&#125;<br>&#125;()<br></code></pre></td></tr></table></figure><h4 id="DoChan"><a href="#DoChan" class="headerlink" title="DoChan"></a>DoChan</h4><p>Do chan å’Œ Do ç±»ä¼¼ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªæ˜¯åŒæ­¥ç­‰å¾…ï¼Œä¸€ä¸ªæ˜¯å¼‚æ­¥è¿”å›ï¼Œä¸»è¦å®ç°ä¸Šå°±æ˜¯ï¼Œå¦‚æœè°ƒç”¨ DoChan ä¼šç»™ call.chans æ·»åŠ ä¸€ä¸ª channel è¿™æ ·ç­‰ç¬¬ä¸€æ¬¡è°ƒç”¨æ‰§è¡Œå®Œæ¯•ä¹‹åå°±ä¼šå¾ªç¯å‘è¿™äº› channel å†™å…¥æ•°æ®</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">DoChan</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>, fn <span class="hljs-keyword">func</span>()</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span>) &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">Result</span></span> &#123;<br>ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Result, <span class="hljs-number">1</span>)<br>g.mu.Lock()<br><span class="hljs-keyword">if</span> g.m == <span class="hljs-literal">nil</span> &#123;<br>g.m = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*call)<br>&#125;<br><span class="hljs-keyword">if</span> c, ok := g.m[key]; ok &#123;<br>c.dups++<br>c.chans = <span class="hljs-built_in">append</span>(c.chans, ch)<br>g.mu.Unlock()<br><span class="hljs-keyword">return</span> ch<br>&#125;<br>c := &amp;call&#123;chans: []<span class="hljs-keyword">chan</span>&lt;- Result&#123;ch&#125;&#125;<br>c.wg.Add(<span class="hljs-number">1</span>)<br>g.m[key] = c<br>g.mu.Unlock()<br><br><span class="hljs-keyword">go</span> g.doCall(c, key, fn)<br><br><span class="hljs-keyword">return</span> ch<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Forget"><a href="#Forget" class="headerlink" title="Forget"></a>Forget</h4><p>forget ç”¨äºæ‰‹åŠ¨é‡Šæ”¾æŸä¸ª key ä¸‹æ¬¡è°ƒç”¨å°±ä¸ä¼šé˜»å¡ç­‰å¾…äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">Forget</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span></span> &#123;<br>g.mu.Lock()<br><span class="hljs-keyword">if</span> c, ok := g.m[key]; ok &#123;<br>c.forgotten = <span class="hljs-literal">true</span><br>&#125;<br><span class="hljs-built_in">delete</span>(g.m, key)<br>g.mu.Unlock()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æœ‰å“ªäº›æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰ï¼Ÿ"><a href="#æœ‰å“ªäº›æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰ï¼Ÿ" class="headerlink" title="æœ‰å“ªäº›æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰ï¼Ÿ"></a>æœ‰å“ªäº›æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰ï¼Ÿ</h3><p>å•é£è™½å¥½ä½†ä¹Ÿä¸è¦æ»¥ç”¨å“¦ï¼Œè¿˜æ˜¯å­˜åœ¨ä¸€äº›å‘çš„</p><h3 id="1-ä¸€ä¸ªé˜»å¡ï¼Œå…¨å‘˜ç­‰å¾…"><a href="#1-ä¸€ä¸ªé˜»å¡ï¼Œå…¨å‘˜ç­‰å¾…" class="headerlink" title="1. ä¸€ä¸ªé˜»å¡ï¼Œå…¨å‘˜ç­‰å¾…"></a>1. ä¸€ä¸ªé˜»å¡ï¼Œå…¨å‘˜ç­‰å¾…</h3><p>ä½¿ç”¨ singleflight æˆ‘ä»¬æ¯”è¾ƒå¸¸è§çš„æ˜¯ç›´æ¥ä½¿ç”¨ Do æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªæç«¯æƒ…å†µä¸‹ä¼šå¯¼è‡´æ•´ä¸ªç¨‹åº hang ä½ï¼Œå¦‚æœæˆ‘ä»¬çš„ä»£ç å‡ºç‚¹é—®é¢˜ï¼Œæœ‰ä¸€ä¸ªè°ƒç”¨ hang ä½äº†ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´æ‰€æœ‰çš„è¯·æ±‚éƒ½ hang ä½</p><p>è¿˜æ˜¯ä¹‹å‰çš„ä¾‹å­ï¼Œæˆ‘ä»¬åŠ ä¸€ä¸ª select æ¨¡æ‹Ÿé˜»å¡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">singleflightGetArticle</span><span class="hljs-params">(sg *singleflight.Group, id <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(<span class="hljs-keyword">string</span>, error)</span></span> &#123;<br>v, err, _ := sg.Do(fmt.Sprintf(<span class="hljs-string">&quot;%d&quot;</span>, id), <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span></span> &#123;<br><span class="hljs-comment">// æ¨¡æ‹Ÿå‡ºç°é—®é¢˜ï¼Œhang ä½</span><br><span class="hljs-keyword">select</span> &#123;&#125;<br><span class="hljs-keyword">return</span> getArticle(id)<br>&#125;)<br><br><span class="hljs-keyword">return</span> v.(<span class="hljs-keyword">string</span>), err<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œå°±ä¼šå‘ç°æ­»é”äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">fatal error: all goroutines are asleep - deadlock!<br><br>goroutine <span class="hljs-number">1</span> [<span class="hljs-keyword">select</span> (no cases)]:<br></code></pre></td></tr></table></figure><p>è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ DoChan ç»“åˆ select åšè¶…æ—¶æ§åˆ¶</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">singleflightGetArticle</span><span class="hljs-params">(ctx context.Context, sg *singleflight.Group, id <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(<span class="hljs-keyword">string</span>, error)</span></span> &#123;<br>result := sg.DoChan(fmt.Sprintf(<span class="hljs-string">&quot;%d&quot;</span>, id), <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span></span> &#123;<br><span class="hljs-comment">// æ¨¡æ‹Ÿå‡ºç°é—®é¢˜ï¼Œhang ä½</span><br><span class="hljs-keyword">select</span> &#123;&#125;<br><span class="hljs-keyword">return</span> getArticle(id)<br>&#125;)<br><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> r := &lt;-result:<br><span class="hljs-keyword">return</span> r.Val.(<span class="hljs-keyword">string</span>), r.Err<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, ctx.Err()<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨çš„æ—¶å€™ä¼ å…¥ä¸€ä¸ªå« è¶…æ—¶çš„ context å³å¯ï¼Œæ‰§è¡Œæ—¶å°±ä¼šè¿”å›è¶…æ—¶é”™è¯¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">â¯ <span class="hljs-keyword">go</span> run ./<span class="hljs-number">1.</span><span class="hljs-keyword">go</span><br><span class="hljs-built_in">panic</span>: context deadline exceeded<br></code></pre></td></tr></table></figure><h3 id="2-ä¸€ä¸ªå‡ºé”™ï¼Œå…¨éƒ¨å‡ºé”™"><a href="#2-ä¸€ä¸ªå‡ºé”™ï¼Œå…¨éƒ¨å‡ºé”™" class="headerlink" title="2. ä¸€ä¸ªå‡ºé”™ï¼Œå…¨éƒ¨å‡ºé”™"></a>2. ä¸€ä¸ªå‡ºé”™ï¼Œå…¨éƒ¨å‡ºé”™</h3><p>è¿™ä¸ªæœ¬èº«ä¸æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Œå› ä¸º singleflight å°±æ˜¯è¿™ä¹ˆè®¾è®¡çš„ï¼Œä½†æ˜¯å®é™…ä½¿ç”¨çš„æ—¶å€™ å¦‚æœæˆ‘ä»¬ä¸€æ¬¡è°ƒç”¨è¦ 1sï¼Œæˆ‘ä»¬çš„æ•°æ®åº“è¯·æ±‚æˆ–è€…æ˜¯ ä¸‹æ¸¸æœåŠ¡å¯ä»¥æ”¯æ’‘ 10rps çš„è¯·æ±‚çš„æ—¶å€™è¿™ä¼šå¯¼è‡´æˆ‘ä»¬çš„é”™è¯¯é˜ˆæé«˜ï¼Œå› ä¸ºå®é™…ä¸Šæˆ‘ä»¬å¯ä»¥ä¸€ç§’å†…å°è¯• 10 æ¬¡ï¼Œä½†æ˜¯ç”¨äº† singleflight ä¹‹ååªèƒ½å°è¯•ä¸€æ¬¡ï¼Œåªè¦å‡ºé”™è¿™æ®µæ—¶é—´å†…çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šå—å½±å“</p><p>è¿™ç§æƒ…å†µæˆ‘ä»¬å¯ä»¥å¯åŠ¨ä¸€ä¸ª Goroutine å®šæ—¶ forget ä¸€ä¸‹ï¼Œç›¸å½“äºå°† rps ä» 1rps æé«˜åˆ°äº† 10rps</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>       time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)<br>       <span class="hljs-comment">// logging</span><br>       g.Forget(key)<br>   &#125;()<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ç¯‡æ–‡ç« ä»ä½¿ç”¨åœºæ™¯ï¼Œåˆ°ä½¿ç”¨æ–¹æ³•ï¼Œå†åˆ°æºç åˆ†æå’Œå¯èƒ½å­˜åœ¨çš„å‘ç»™å¤§å®¶ä»‹ç»äº† singleflightï¼Œå¸Œæœ›ä½ èƒ½æœ‰æ‰€æ”¶è·ï¼Œæ²¡äº‹çœ‹çœ‹å®˜æ–¹çš„ä»£ç è¿˜æ˜¯å¾ˆæœ‰æ”¶è·çš„ï¼Œè¿™æ¬¡åˆå­¦åˆ°äº†ä¸€ä¸ªéªšæ“ä½œï¼Œç”¨åŒé‡ defer æ¥é¿å…æ­»é”ï¼Œä½ å­¦åºŸäº†ä¹ˆï¼Ÿ</p><p>æˆ‘ä»¬ä¸‹ä¸€ç¯‡ä¼šå¼€å¯ä¸€ä¸ªæ–°çš„ç³»åˆ—ï¼ŒGo å¯ç”¨æ€§ï¼Œæ•¬è¯·æœŸå¾…ï¼</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://pkg.go.dev/golang.org/x/sync/singleflight">golang.org/x/sync/singleflight</a></li><li><a href="https://www.cyningsun.com/01-11-2021/golang-concurrency-singleflight.html">sync.singleflight åˆ°åº•æ€ä¹ˆç”¨æ‰å¯¹ï¼Ÿ</a></li><li><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-sync-primitives/#singleflight">Go è¯­è¨€å¹¶å‘ç¼–ç¨‹ã€åŒæ­¥åŸè¯­ä¸é” | Go è¯­è¨€è®¾è®¡ä¸å®ç°</a></li><li><a href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go è¿›é˜¶è®­ç»ƒè¥-æå®¢æ—¶é—´</a></li><li><a href="https://github.com/golang/go/issues/33519">x/sync/singleflight: panic in Do fn results in deadlock Â· Issue #33519 Â· golang/go Â· GitHub</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week03: Go å¹¶å‘ç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¹¶å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è¯„è®ºç³»ç»Ÿæ¶æ„è®¾è®¡</title>
    <link href="/post/go-training-week5-comment-design-1.html"/>
    <url>/post/go-training-week5-comment-design-1.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p><strong>3 æœˆè¿›åº¦: 07/15</strong> 3 æœˆå¼€å§‹ä¼šå°è¯•çˆ†æ›´æ¨¡å¼ï¼Œäº‰å–åšåˆ°ä¸¤å¤©æ›´æ–°ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœæ„Ÿå…´è¶£å¯ä»¥æ‹‰åˆ°æ–‡ç« æœ€ä¸‹æ–¹è·å–å…³æ³¨æ–¹å¼ã€‚</p><p>æ—¶é—´å…œå…œè½¬è½¬ç»ˆäºå¤ä¹ åˆ° Week05 äº†ï¼Œè®­ç»ƒè¥ç¬¬ 0 æœŸä¹Ÿç»“æŸäº†ï¼Œç¬¬ä¸€æœŸä¹Ÿé©¬ä¸Šå¼€å§‹äº†ï¼Œä¸ªäººæ„Ÿè§‰æ•´ä½“æ¥çœ‹è¿˜æ˜¯æ¯”è¾ƒå€¼çš„ï¼Œå› ä¸ºåœ¨è¿™é‡Œæˆ‘ä»¬ä¸ä»…èƒ½å­¦åˆ° Go çš„çŸ¥è¯†å…¶å®ä¹Ÿæœ‰å¾ˆå¤šæ¶æ„è®¾è®¡ï¼Œå­¦ä¹ æ–¹æ³•è®ºï¼Œä»¥åŠä¸€äº›èŒåœºçš„è¯é¢˜ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥åˆ°æœ¬æ¬¡è¯¾ç¨‹çš„ç¬¬ä¸€ä¸ªå®Œæ•´æ¡ˆä¾‹ï¼Œè¯„è®ºç³»ç»Ÿæ¶æ„è®¾è®¡ï¼Œæ® â€œæŸå…¬å¸â€ æŠ€æœ¯æ€»ç›‘æ¯›è€å¸ˆè¯´è¿™å¥—æ¶æ„è®¾è®¡æ”¯æ’‘äº† â€œæŸå…¬å¸â€ ä¸Šäº¿ DAU çš„è¯„è®ºç³»ç»Ÿã€‚</p><div class="note note-warning">            <p>æœ¬æ–‡æ¶‰åŠéƒ¨åˆ†ä¸ºæ”¶è´¹å†…å®¹ï¼Œä¸ºä¿æŠ¤æ¯›è€å¸ˆçš„æˆæœï¼Œè¯¦ç»†å†…å®¹ç»æ²Ÿé€šååˆ é™¤ï¼Œå¼ºçƒˆæ¨èå¤§å®¶è´­ä¹°ä¸“æ ï¼Œå¹¶ä¸”ä¸ºå¤§å®¶ç”³è¯·åˆ°äº†è¯»è€…ä¸“å±ç¦åˆ©ï¼Œè´­ä¹°å‰åŠ æˆ‘å¾®ä¿¡ï¼ˆlailin306755605ï¼‰è¿˜å¯è·å¾—æ›´å¤šä¼˜æƒ (è¯»è€…ä¸“å±ç¦åˆ©ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´å¤§å“¦)</p>          </div><p>ä»¥ä¸‹ä¸ºå¤§çº²ï¼š</p><ul><li>åŠŸèƒ½æ¨¡å—è®¾è®¡</li><li>æ¶æ„è®¾è®¡</li><li>å­˜å‚¨è®¾è®¡</li><li>å¯ç”¨æ€§è®¾è®¡</li></ul><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week05: è¯„è®ºç³»ç»Ÿæ¶æ„è®¾è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>æ¶æ„è®¾è®¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå·¥ç¨‹åŒ–(ä¹) é¡¹ç›®é‡æ„å®è·µ</title>
    <link href="/post/go-training-week4-practice.html"/>
    <url>/post/go-training-week4-practice.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p><strong>3 æœˆè¿›åº¦: 06/15</strong> 3 æœˆå¼€å§‹ä¼šå°è¯•çˆ†æ›´æ¨¡å¼ï¼Œäº‰å–åšåˆ°ä¸¤å¤©æ›´æ–°ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœæ„Ÿå…´è¶£å¯ä»¥æ‹‰åˆ°æ–‡ç« æœ€ä¸‹æ–¹è·å–å…³æ³¨æ–¹å¼ã€‚</p><p>è¿™æ˜¯ã€ŠGo å·¥ç¨‹åŒ–ã€‹ç³»åˆ—çš„æœ€åä¸€ç¯‡æ–‡ç« äº†ï¼Œå…¶å®åœ¨ Go å¹¶å‘ç¼–ç¨‹å®Œç»“çš„æ—¶å€™æˆ‘æƒ³çš„å·¥ç¨‹åŒ–è¿™ä¸€ç« èŠ‚ä¸è¦å†™è¿™ä¹ˆå¤šï¼Œä»¥å¬è¯¾ç¬”è®°ä¸ºä¸»å°±å¯ä»¥äº†ï¼Œä½†æ˜¯æœ€åè¿˜æ˜¯å±•å¼€è®²äº†å¾ˆå¤šå†…å®¹ï¼Œä¸å…¶è¯´æ˜¯ä¸ºäº†åšç¬”è®°æˆ–è€…æ˜¯å†™æ–‡ç« ï¼Œä¸å¦‚è¯´æ˜¯ä¸ºäº†æ•´ç†ä¸€ä¸‹è¿‡å»å‡ å¹´æˆ‘çš„ä¸€äº›å¾®ä¸è¶³é“çš„ç»éªŒï¼Œç»“åˆæ¯›è€å¸ˆè¯¾ä¸Šè®²çš„å†…å®¹ä¸è‡ªå·±çš„æƒ…å†µé‡æ–°å¯¹å·²æœ‰çš„çŸ¥è¯†è¿›è¡Œäº†ä¸€éæ¢³ç†ã€‚</p><p>åœ¨å‰é¢çš„å…«ç¯‡æ–‡ç« å½“ä¸­æˆ‘ä»¬è®²åˆ°äº†ï¼Œé¡¹ç›®ç»“æ„ã€ä¾èµ–æ³¨å…¥ï¼ŒAPI è®¾è®¡ã€é…ç½®ç®¡ç†ã€åŒ…ç®¡ç†ã€å•å…ƒæµ‹è¯•ï¼ŒåŸºæœ¬ä¸Šè¿˜æ˜¯å°†å·¥ç¨‹åŒ–å½“ä¸­çš„å¤§éƒ¨åˆ†ä¸œè¥¿éƒ½è®²åˆ°äº†ï¼Œä¸æ±‚å°½å–„å°½ç¾ï¼Œä½†æ±‚å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œæˆ‘ä»¬ä»Šå¤©å°±æ¥ç»“åˆå‰é¢æ–‡ç« ä¸­æåˆ°çš„å„ç§çŸ¥è¯†æ¥çœ‹ä¸€ä¸‹å¦‚ä½•å°†ä¸€ä¸ªè€çš„é¡¹ç›®è¿ç§»åˆ°æ–°çš„é¡¹ç›®ç»“æ„å½“ä¸­æ¥ï¼Œè¿™é‡Œé¢çš„å‘ä¹Ÿéå¸¸çš„å¤šã€‚</p><p>è¿™ç¯‡æ–‡ç« æ˜¯ä»ä¹‹å‰é‡æ„çš„ä¸€ä¸ªçœŸå®é¡¹ç›®æ˜ å°„è€Œæ¥ï¼Œé‡Œé¢è®²åˆ°çš„å‘åŸºæœ¬ä¸Šåœ¨è¿ç§»é‡æ„çš„è¿‡ç¨‹ä¸­éƒ½è¶Ÿäº†ä¸æ­¢ä¸€æ¬¡ã€‚</p><h2 id="è¿ç§»å‰"><a href="#è¿ç§»å‰" class="headerlink" title="è¿ç§»å‰"></a>è¿ç§»å‰</h2><h3 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">.<br>â”œâ”€â”€ app<br>â”‚   â”œâ”€â”€ controller<br>â”‚   â”œâ”€â”€ lib<br>â”‚   â”œâ”€â”€ middleware<br>â”‚   â”œâ”€â”€ model<br>â”‚   â””â”€â”€ router<br>â”œâ”€â”€ cmd<br>â”‚   â”œâ”€â”€ cron<br>â”‚   â””â”€â”€ server<br>â”œâ”€â”€ config<br>â”‚   â””â”€â”€ initializer<br>â”œâ”€â”€ db<br>â”‚   â””â”€â”€ migrate<br>â”‚   â””â”€â”€ migrate.go<br>â”œâ”€â”€ go.mod<br>â”œâ”€â”€ mock<br>â”œâ”€â”€ <span class="hljs-built_in">test</span><br>â””â”€â”€ third_party<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯æˆ‘ä»¬æœ€å¼€å§‹çš„ç›®å½•ç»“æ„ï¼Œè¿™ä¸ªç»“æ„æ˜¯ä»¿ç…§ rails æ¡†æ¶è®¾è®¡è€Œæ¥çš„ï¼Œè¿™ä¸ªç»“æ„åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´éƒ½æ˜¯æŒºå¥½ç”¨çš„ï¼Œæˆ‘å…ˆå¤§æ¦‚è§£é‡Šä¸€ä¸‹æ¯ä¸ªç›®å½•çš„å«ä¹‰</p><ul><li>app: åº”ç”¨é€»è¾‘ç›¸å…³çš„ä»£ç éƒ½åœ¨è¿™é‡Œ<ul><li>controller: æ§åˆ¶å™¨å±‚ï¼Œä¸»è¦è´Ÿè´£è·¯ç”±</li><li>lib: ä¸€äº›å·¥å…·åº“å‡½æ•°</li><li>middleware: è·¯ç”±ä¸­é—´ä»¶</li><li>router: è·¯ç”±æ³¨å†Œ</li><li>model: ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å……è¡€æ¨¡å‹ï¼Œæ‰€ä»¥è¿™ä¸€å±‚çš„å†…å®¹æ¯”è¾ƒå¤šï¼ŒåŒ…å«äº†é¢†åŸŸå¯¹è±¡ï¼Œä¸šåŠ¡é€»è¾‘ï¼Œæ•°æ®å­˜å‚¨ç­‰éƒ½åœ¨è¿™é‡Œ</li></ul></li><li>cmd: äºŒè¿›åˆ¶æ–‡ä»¶ç›®å½•<ul><li>cron: å®šæ—¶ä»»åŠ¡</li><li>server: http server æœåŠ¡</li></ul></li><li>db: migration ç›®å½•</li><li>mock: gomock ç”Ÿæˆçš„æ–‡ä»¶</li><li>test: æµ‹è¯•å·¥å…·åº“</li><li>third_party: ç¬¬ä¸‰æ–¹æ–‡ä»¶</li></ul><p>è°ƒç”¨å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1615219210365-000fcd85-392a-41da-b7e4-8b4fc583123f.jpeg" alt="Frame 1 (4).jpg"></p><h3 id="å­˜åœ¨çš„é—®é¢˜"><a href="#å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="å­˜åœ¨çš„é—®é¢˜"></a>å­˜åœ¨çš„é—®é¢˜</h3><p>å…¶å®åœ¨æŠ¥åå‚åŠ  Go è¿›é˜¶è®­ç»ƒè¥ ä¹‹å‰æˆ‘å°±å› ä¸ºåœ¨æé«˜è¿™ä¸ªé¡¹ç›®çš„å•å…ƒæµ‹è¯•è¦†ç›–ç‡çš„æ—¶å€™å‘ç°äº†å¾ˆå¤šé—®é¢˜ï¼Œå½“æ—¶æˆ‘ç”¨äº†å„ç§æ“ä½œï¼Œéå¸¸éš¾å—çš„å°†å•å…ƒæµ‹è¯•è¦†ç›–ç‡å†™åˆ° 85% å·¦å³çš„æ—¶å€™å°±å†™ä¸ä¸Šå»äº†ï¼Œå› ä¸ºæˆ‘ä»¬çš„é¡¹ç›®çš„å†å²åŒ…è¢±å¤ªä¸¥é‡äº†ï¼Œå¾ˆå¤šä»£ç å†™çš„åŸºæœ¬å°±ä¸å¯æµ‹è¯•ï¼Œæƒ³è¦æé«˜æµ‹è¯•è¦†ç›–ç‡ä¹Ÿå°±æ— ä»è°ˆèµ·äº†ã€‚</p><ul><li>cmd<ul><li>æˆ‘ä»¬ä¹‹å‰åœ¨è¿™ä¸€å±‚å½“ä¸­æœ€å¤§çš„é—®é¢˜å°±æ˜¯æˆ‘ä»¬æ‰‹å†™äº†å¤§é‡å¯åŠ¨ä»£ç ï¼Œå…¨æ‰‹åŠ¨ä¾èµ–æ³¨å…¥ï¼Œè¿˜æœ‰ä¸€äº›éšå¼çš„ä¾èµ–ï¼Œè¿™å°±å¯¼è‡´åœ¨é¡¹ç›®åæœŸçš„æ—¶å€™å¯åŠ¨çš„ä»£ç å·²ç»éå¸¸é•¿äº†ï¼Œè€Œä¸”å¾ˆå®¹æ˜“é—æ¼ä¾èµ–å…³ç³»çš„å¤„ç†ï¼Œå»ºè®®å¦‚æœä¸æ˜¯ç‰¹åˆ«å°çš„é¡¹ç›®è¿˜æ˜¯ä½¿ç”¨ wire æ¯”è¾ƒé¦™ã€‚</li></ul></li><li>initializer<ul><li>æˆ‘ä»¬ä¹‹å‰æ‰€æœ‰çš„åˆå§‹åŒ–éƒ½åœ¨è¿™ä¸ªåŒ…å†…å®Œæˆï¼Œè¿™ä¸ªä¸æ˜¯å¤ªå¤§çš„é—®é¢˜ï¼Œä½†æ˜¯è¦å‘½çš„æ˜¯è¿™é‡Œé¢æœ‰å¤§é‡çš„å…¨å±€å˜é‡ï¼Œå„ç§å„æ ·ï¼Œè¿‡å¤šçš„å…¨å±€å˜é‡å¯¼è‡´æˆ‘ä»¬çš„å•å…ƒæµ‹è¯•éå¸¸éš¾å†™ã€‚</li></ul></li><li>model<ul><li>è¿™ä¸€å±‚çš„äº‹æƒ…ç‰¹åˆ«å¤šï¼Œä¸šåŠ¡é€»è¾‘ï¼Œé¢†åŸŸå¯¹è±¡ï¼ŒæŒä¹…åŒ–å­˜å‚¨ç­‰éƒ½åœ¨è¿™ä¸€å±‚å®Œæˆï¼Œè¿™å°±å¯¼è‡´äº†åé¢æˆ‘ä»¬ model å±‚çš„ä»£ç ç‰¹åˆ«å¤šï¼Œå˜æˆäº†ä¸€å›¢ä¹±éº»ï¼ŒçœŸçš„æ˜¯å‰ªä¸æ–­ç†è¿˜ä¹±ï¼Œæ…¢æ…¢çš„è¿™ä¸€å±‚çš„é€»è¾‘æˆ‘è‡ªå·±éƒ½ç†ä¸æ¸…äº†ã€‚</li><li>è¿™ä¸€å±‚çš„ä»£ç è€¦åˆä¹Ÿå¾ˆä¸¥é‡ï¼Œæ— è®ºæ˜¯ä»€ä¹ˆå®šæ—¶ä»»åŠ¡è¿˜æ˜¯æ¶ˆæ¯é˜Ÿåˆ—è¿˜æ˜¯ server çš„ä»£ç éƒ½æ”¾åˆ°äº†è¿™é‡Œï¼Œå¯¼è‡´å‡ºç°äº†å¾ˆå¤šå‘ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå¯èƒ½æˆ‘æœ‰ä¸€ä¸ªå‡½æ•°æ˜¯ <code>GetArticles</code>  è¿™ä¸ªå‡½æ•°æœ€å¼€å§‹æ˜¯ä¸ºäº† api æ¥å£è¿”å›ä¸€äº›ç®€è¦çš„åˆ—è¡¨æ•°æ®ï¼Œåªéœ€è¦æŸ¥è¯¢ä¸€å¼ è¡¨ï¼Œè¿”å›é€Ÿåº¦éå¸¸å¿«ï¼Œä½†æ˜¯æˆ‘å®šæ—¶ä»»åŠ¡æœ‰ä¸€ä¸ªåœ°æ–¹ä¹Ÿéœ€è¦è¿™ä¸ªå‡½æ•°ï¼Œç„¶åæˆ‘ä¸€çœ‹ï¼ŒçœŸå¥½è¿™é‡Œå·²ç»æœ‰è¿™ä¸ªå‡½æ•°äº†æˆ‘ä»¬å°±ç›´æ¥å¤ç”¨ï¼Œä½†æ˜¯æ•°æ®å†…å®¹ä¸æ»¡è¶³éœ€æ±‚ï¼Œæˆ‘ä»¬å°±ç›´æ¥åœ¨è¿™ä¸ªå‡½æ•°å½“ä¸­åŠ é€»è¾‘ï¼Œç„¶åéœ€æ±‚æ»¡è¶³äº†ï¼Œè¿‡ä¸€æ®µæ—¶é—´æˆ‘ä»¬çªç„¶è¦æ±‚æ‰€æœ‰çš„æ¥å£å¿…é¡»è¦åœ¨ 500ms ä»¥å†…ï¼Œç»“æœå‘ç°å‘æ¥äº†ï¼Œå¾ˆå¤šåœ°æ–¹ä¾èµ–è¿™ä¸ªå‡½æ•°ï¼Œçœ‹ APMï¼Œå°±è¿™ä¸€ä¸ªå‡½æ•°çš„æŸ¥è¯¢å°±éœ€è¦è€—è´¹è¶…è¿‡ 500ms ğŸ¤£</li></ul></li><li>controller<ul><li>è¿™ä¸€å±‚ä¸»è¦åšå‚æ•°çš„å¤„ç†è¿˜æœ‰éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘ï¼Œæˆ‘ä»¬çš„ Controller å±‚å’Œ model å±‚çš„ç•Œå®šæ¯”è¾ƒæ¨¡ç³Šï¼Œæœ‰çš„ä¸»è¦ä¸šåŠ¡é€»è¾‘æ”¾åˆ°äº† model æœ‰çš„æœ‰éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘åˆæ”¾åˆ°äº† Controller äº†ï¼Œåˆ°åé¢å°±æ˜¯ä¸€ç‚¹ä¸€ç‚¹çš„æ‰¾é—®é¢˜</li></ul></li><li>é”™è¯¯å¤„ç†<ul><li>æˆ‘ä»¬ä¹‹å‰åœ¨é¡¹ç›®å†…ç»Ÿä¸€äº†é”™è¯¯ç ï¼Œä½†æ˜¯å­˜åœ¨ä¸¤ä¸ªé—®é¢˜</li><li>ä¸€ä¸ªæ˜¯è¦ä¹ˆå¤„å¤„ wrapï¼Œè¦ä¹ˆå¿˜è®° wrap æ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€å‡†åˆ™ï¼Œè¿™å°±å¯¼è‡´è¦ä¹ˆé”™è¯¯å †æ ˆé•¿çš„æ²¡æ³•çœ‹ï¼Œè¦ä¹ˆå°±æ²¡æœ‰å¤ªå¤šçš„é”™è¯¯ä¿¡æ¯æ²¡æ³•æ’æŸ¥</li><li>å¦ä¸€ä¸ªæ˜¯æˆ‘ä»¬ä¹‹å‰åœ¨ Controller å±‚è·‘ä¸šåŠ¡é”™è¯¯ä»£ç ï¼Œè¿™å°±å¯¼è‡´äº†å¾ˆå¤šæ—¶å€™æƒ³è¦è¿”å›ä¸€äº›ç»†èŠ‚çš„é”™è¯¯ä¿¡æ¯å°±æ— èƒ½ä¸ºåŠ›ï¼Œå³ä½¿åœ¨ model å±‚æŠ›äº†ä¹Ÿä¼šè¢« Controller å±‚åæ‰</li></ul></li><li>æ¥å£æ–‡æ¡£<ul><li>è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ç—›ç‚¹ï¼Œä¹‹å‰æƒ³äº†å¾ˆå¤šæ–¹å¼éƒ½ä¸èƒ½å¾ˆå¥½çš„è§£å†³ï¼Œæ¯›è€å¸ˆç»™å‡ºè¿™ä¸ªæ–¹æ¡ˆåï¼Œæˆ‘æ²¡å¤šä¹…å°±ç”¨ä¸Šäº†éå¸¸çˆ½ã€‚</li><li>ä¹‹å‰æˆ‘ä»¬çš„æ–‡æ¡£åˆ†å¸ƒäº”èŠ±å…«é—¨ï¼Œæœ€å¼€å§‹ä½¿ç”¨ gin swagger é€šè¿‡å†™æ³¨é‡Šçš„æ–¹å¼æ¥ç”Ÿæˆç›¸å…³æ¥å£æ–‡æ¡£ï¼Œè¯´å®è¯å¯ä»¥ç”¨ä½†æ˜¯æ¯”è¾ƒéš¾ç”¨ï¼Œå› ä¸ºè¿™ä¸ªæ³¨é‡Šå…¶å®å’Œä»£ç é€»è¾‘æ˜¯ä¸¤å¥—ä¸œè¥¿ï¼Œç›¸å½“äºå†™ä¸€éä»£ç å†å†™ä¸€éæ³¨é‡Šï¼Œæ…¢æ…¢çš„å°±æ²¡æœ‰äººå†™äº†ï¼Œæˆ–è€…è¿˜æœ‰å†™çš„æ˜¯é”™è¯¯çš„ã€‚æœ€éº»çƒ¦çš„æ˜¯åœ¨æ–¹æ¡ˆè®¾è®¡é˜¶æ®µæˆ‘ä»¬ä¸ä¼šç›´æ¥å†™ä»£ç æ³¨é‡Šï¼Œæ‰€ä»¥æµ‹è¯•åŒå­¦åœ¨å†™æµ‹è¯•æ–¹æ¡ˆçš„æ—¶å€™ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œä¹Ÿä¸ç¬¦åˆæˆ‘ä»¬åç»­æŠ€æœ¯æ–¹æ¡ˆè¯„å®¡çš„è¦æ±‚æ‰€ä»¥åé¢ä¹Ÿå°±åºŸå¼ƒäº†</li><li>åé¢æˆ‘ä»¬å†™åˆ°å†…éƒ¨çš„æ–‡æ¡£å¹³å°ä¸Šï¼Œè¿˜ä¸å¦‚ä¹‹å‰çš„ swaggerï¼Œè™½ç„¶è§£å†³äº†æ–¹æ¡ˆé˜¶æ®µæ²¡æ¥å£æ–‡æ¡£çš„é—®é¢˜ï¼Œä½†æ˜¯æ¥å£æ–‡æ¡£æ€»æ˜¯åœ¨å˜åŒ–å½“ä¸­çš„ï¼Œç‰¹åˆ«æ˜¯åœ¨å¼€å‘çš„æ—¶å€™ï¼Œè¿™å°±è®©å‰åç«¯å¯¹æ¥è”è°ƒï¼Œä»¥åŠæµ‹è¯•åŒå­¦æµ‹è¯•çš„éå¸¸éš¾å—ï¼Œç‰¹åˆ«æ˜¯ç»å¸¸ä¼šå‡ºç°å’Œå‰ç«¯åŒå­¦æ²Ÿé€šå¥½äº†ä½†æ˜¯å¿˜è®°å’Œæµ‹è¯•è¯´çš„æƒ…å†µã€‚</li></ul></li></ul><h2 id="è¿ç§»"><a href="#è¿ç§»" class="headerlink" title="è¿ç§»"></a>è¿ç§»</h2><p><em>è¿ç§»è¦ä¸‰æ€ï¼Œå¤„å¤„éƒ½æ˜¯å‘, é‡æ„è¦å°å¿ƒï¼ŒTDD å¤§æ³•å¥½</em></p><h3 id="è¿ç§»åç›®å½•ç»“æ„"><a href="#è¿ç§»åç›®å½•ç»“æ„" class="headerlink" title="è¿ç§»åç›®å½•ç»“æ„"></a>è¿ç§»åç›®å½•ç»“æ„</h3><p>ä¸ºäº†èƒ½å¤Ÿæ›´åŠ ç›´è§‚ï¼Œæˆ‘ä»¬å…ˆæ¥å¤ä¹ ä¸€ä¸‹ä¹‹å‰æåˆ°è¿‡çš„é¡¹ç›®ç›®å½•ç»“æ„çœ‹ä¸€ä¸‹è¿ç§»å‰åæœ‰å“ªäº›ä¸åŒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">.<br>â”œâ”€â”€ api<br>â”‚   â””â”€â”€ product<br>â”‚       â””â”€â”€ app<br>â”‚           â”œâ”€â”€ errcode<br>â”‚           â””â”€â”€ v1<br>â”‚               â””â”€â”€ v1.proto<br>â”œâ”€â”€ cmd<br>â”‚   â”œâ”€â”€ cron<br>â”‚   â”‚   â”œâ”€â”€ main.go<br>â”‚   â”‚   â””â”€â”€ wire.go<br>â”‚   â”œâ”€â”€ migrate<br>â”‚   â””â”€â”€ server<br>â”œâ”€â”€ config<br>â”œâ”€â”€ go.mod<br>â”œâ”€â”€ internal<br>â”‚   â”œâ”€â”€ cron<br>â”‚   â”‚   â”œâ”€â”€ repo<br>â”‚   â”‚   â”œâ”€â”€ service<br>â”‚   â”‚   â”œâ”€â”€ usecase<br>â”‚   â”‚   â””â”€â”€ wire_set.go<br>â”‚   â”œâ”€â”€ domain<br>â”‚   â”œâ”€â”€ pkg<br>â”‚   â”‚   â”œâ”€â”€ copier<br>â”‚   â”‚   â”œâ”€â”€ mock<br>â”‚   â”‚   â””â”€â”€ <span class="hljs-built_in">test</span><br>â”‚   â””â”€â”€ server<br>â”‚       â”œâ”€â”€ repo<br>â”‚       â”œâ”€â”€ service<br>â”‚       â”œâ”€â”€ usecase<br>â”‚       â””â”€â”€ wire_set.go<br>â””â”€â”€ third_party<br></code></pre></td></tr></table></figure><p>å…·ä½“æ¯ä¸ªæ–‡ä»¶å¤¹çš„å«ä¹‰å°±ä¸å†èµ˜è¿°ï¼Œå¦‚æœä¸å¤ªæ¸…æ¥šå¯ä»¥æŸ¥çœ‹ <a href="https://lailin.xyz/post/go-training-week4-project-layout.html">Go å·¥ç¨‹åŒ–(äºŒ) é¡¹ç›®ç›®å½•ç»“æ„</a><br>æˆ‘ä»¬çœ‹ä¸€ä¸‹æ–°çš„ç›®å½•ç»“æ„çš„è°ƒç”¨é“¾è·¯<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1615268889054-251a4e39-c8d9-410f-950c-5262b368ae34.jpeg" alt="Frame 2 (1).jpg"><br>æ³¨æ„ï¼Œåœ¨è¿™é‡Œ service å’Œ usecase å®é™…è°ƒç”¨çš„éƒ½æ˜¯ domain ä¸­çš„æ¥å£ï¼Œåªæ˜¯ usecase å’Œ repo å®ç°è¿™äº›æ¥å£è€Œå·²ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œç”¨è™šçº¿ç”»å‡ºæ¥</p><h3 id="è¿ç§»é‡æ„åŸåˆ™"><a href="#è¿ç§»é‡æ„åŸåˆ™" class="headerlink" title="è¿ç§»é‡æ„åŸåˆ™"></a>è¿ç§»é‡æ„åŸåˆ™</h3><p>æ¥ä¸‹æ¥æˆ‘ä¼šä»å„ä¸ªæ¨¡å—æ¥é˜è¿°æˆ‘åœ¨é‡æ„è¿™ä¸ªé¡¹ç›®çš„æ—¶å€™æ˜¯æ€ä¹ˆåšçš„ï¼Œæ¯ä¸ªæ¨¡å—éƒ½æœ‰æ¯ä¸ªæ¨¡å—è‡ªå·±çš„å‘ã€‚å¼€å§‹ä¹‹å‰å‘¢æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹å‡ ä¸ªæ€»çš„åŸåˆ™:</p><ul><li>ç»“æ„ç®€å•çš„åº”ç”¨ä¼˜å…ˆ</li><li>æœ‰å……åˆ†çš„å•å…ƒæµ‹è¯•çš„åº”ç”¨ä¼˜å…ˆ</li><li>å…ˆå†™æµ‹è¯•ï¼Œæµ‹è¯•éœ€è¦åœ¨æ–°è€ä»£ç åŒæ—¶é€šè¿‡</li></ul><h3 id="api"><a href="#api" class="headerlink" title="api"></a>api</h3><p>api å½“ä¸­ä¸»è¦å†™çš„å°±æ˜¯ proto æ–‡ä»¶ï¼Œè¿™ä¸ª proto æ–‡ä»¶æ›¿ä»£äº†æˆ‘ä»¬åœ¨ä¹‹å‰çš„ <code>router</code>  ä»¥åŠéƒ¨åˆ† <code>controller</code>  ä¸­çš„é€»è¾‘ï¼Œå®šä¹‰äº† proto æ–‡ä»¶ä¹‹åï¼Œç”Ÿæˆçš„ä»£ç å½“ä¸­ä¸»è¦è¦å®Œæˆçš„å°±æ˜¯ï¼Œè·¯ç”±çš„æ³¨å†Œï¼Œå‚æ•°ç»‘å®šï¼Œè¿”å›å€¼ç»“æ„å¡«å……ã€‚</p><h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><p>å…ˆè¡¥å……ä¸€ä¸‹èƒŒæ™¯ï¼Œæˆ‘ä»¬ä¹‹å‰çš„é¡¹ç›®é‡‡ç”¨çš„æ˜¯ gin ä½œä¸ºè·¯ç”±æ¡†æ¶ï¼Œè¿”å›å€¼é‡‡ç”¨ä¸‹é¢è¿™ç§ç»Ÿä¸€çš„ç»“æ„</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;code&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-attr">&quot;msg&quot;</span>: <span class="hljs-string">&quot;æˆåŠŸ&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ api å±‚çš„è·¯ç”±æ³¨å†Œï¼Œå‚æ•°ç»‘å®šï¼Œè¿”å›å€¼ç»“æ„å¡«å……æˆ‘ä»¬éƒ½ä½¿ç”¨å·¥å…·è¿›è¡Œç»Ÿä¸€å¤„ç†ï¼Œè¯¦ç»†ä»‹ç»å¯ä»¥çœ‹ä¹‹å‰çš„æ–‡ç« : <a href="https://lailin.xyz/post/go-training-week4-protoc-gen-go-gin.html">Go å·¥ç¨‹åŒ–(äº”) API è®¾è®¡ä¸‹: åŸºäº protobuf è‡ªåŠ¨ç”Ÿæˆ gin ä»£ç </a></p><h4 id="ç®€å•æ¡ˆä¾‹"><a href="#ç®€å•æ¡ˆä¾‹" class="headerlink" title="ç®€å•æ¡ˆä¾‹"></a>ç®€å•æ¡ˆä¾‹</h4><p>å…ˆæ¥çœ‹ä¸€ä¸ªåŸºæœ¬çš„ä¾‹å­</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs protobuf"><span class="hljs-comment">// è¿™é‡ŒæŒ‡å®šäº† proto æ–‡ä»¶çš„ç‰ˆæœ¬</span><br>syntax = <span class="hljs-string">&quot;proto3&quot;</span>;<br><br><span class="hljs-comment">// package å‘½åè§„åˆ™: product.application.version</span><br><span class="hljs-keyword">package</span> product.app.v1;<br><br><span class="hljs-comment">// go_package ç”Ÿæˆ go æ–‡ä»¶å½“ä¸­çš„åŒ…å</span><br><span class="hljs-keyword">option</span> go_package = <span class="hljs-string">&quot;github.com/mohuishou/new-project/api/product/app/v1&quot;</span>;<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;google/api/annotations.proto&quot;</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">service</span> <span class="hljs-title">BlogService</span> </span>&#123;<br><br>  <span class="hljs-comment">// åˆ›å»ºæ–‡ç« </span><br>  <span class="hljs-function"><span class="hljs-keyword">rpc</span> CreateArticle(CreateArticleReq) <span class="hljs-keyword">returns</span> (CreateArticleResp) </span>&#123;<br>  <span class="hljs-comment">// option è¿˜æ˜¯éƒ½åŠ ä¸Šï¼Œå¯ä»¥åˆ©ç”¨æ’ä»¶è‡ªåŠ¨ç”Ÿæˆ swagger æ–‡æ¡£</span><br>    <span class="hljs-keyword">option</span> (google.api.http) = &#123;<br>      post: <span class="hljs-string">&quot;/article&quot;</span><br>      body: <span class="hljs-string">&quot;*&quot;</span><br>    &#125;;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// å‚æ•°å’Œè¿”å›å€¼å®šä¹‰ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†åˆ—äº†</span><br><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">CreateArticleReq</span> </span>&#123;&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">CreateArticleResp</span> </span>&#123;&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸçš„ä¾‹å­åƒç¯‡ä¸€å¾‹ï¼Œè·¯ä¸Šçš„å‘å„ä¸ç›¸åŒï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å‡ ä¸ªå…¸å‹çš„å‘(é—®é¢˜)ï¼Œä»¥åŠè¯¥å¦‚ä½•è§£å†³</p><h4 id="Q1-Get-è¯·æ±‚å‚æ•°å¦‚ä½•è¿›è¡Œç»‘å®šï¼Œé»˜è®¤æ— æ³•ä¿®æ”¹-struct-tag"><a href="#Q1-Get-è¯·æ±‚å‚æ•°å¦‚ä½•è¿›è¡Œç»‘å®šï¼Œé»˜è®¤æ— æ³•ä¿®æ”¹-struct-tag" class="headerlink" title="Q1: Get è¯·æ±‚å‚æ•°å¦‚ä½•è¿›è¡Œç»‘å®šï¼Œé»˜è®¤æ— æ³•ä¿®æ”¹ struct tag"></a>Q1: Get è¯·æ±‚å‚æ•°å¦‚ä½•è¿›è¡Œç»‘å®šï¼Œé»˜è®¤æ— æ³•ä¿®æ”¹ struct tag</h4><p>è¿™ä¸ªç¨³å®šåŒæ ·é€‚ç”¨äºå‚æ•°æ ¡éªŒï¼ŒåŸæ¥ gin å‚æ•°æ ¡éªŒå¯ä»¥åœ¨ struct ä¸ŠåŠ  tag è§£å†³ï¼Œè¿™ä¸ªæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œä¸€ç§æ˜¯ä½¿ç”¨ <a href="https://github.com/favadi/protoc-go-inject-tag">protoc-go-inject-tag</a> åŠ æ³¨é‡Šè§£å†³ï¼Œå¦å¤–ä¸€ç§æ˜¯ä½¿ç”¨ <a href="https://github.com/gogo/protobuf">gogo/protobuf</a> æ”¯æŒæ·»åŠ  option çš„æ–¹å¼æ¥æ·»åŠ  tagï¼Œç›®å‰æˆ‘é‡‡ç”¨çš„æ˜¯ç¬¬ä¸€ç§</p><p>åªéœ€è¦åœ¨å®šä¹‰ message çš„æ—¶å€™æ·»åŠ æ³¨é‡Š <code>// @inject_tag:</code>  åé¢æ˜¯å…·ä½“çš„ tag</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs protobuf"><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">GetArticleReq</span> </span>&#123;<br>  <span class="hljs-comment">// @inject_tag: form:&quot;id&quot; binding:&quot;required&quot;</span><br>  <span class="hljs-built_in">int32</span> id = <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬åœ¨ç”Ÿæˆå¥½å¯¹åº”çš„ go æ–‡ä»¶ä¹‹åæ‰§è¡Œä¸€ä¸‹ <code>protoc-go-inject-tag -input=filepath</code>  å°±å¯ä»¥äº†</p><h4 id="Q2-è¿”å›å€¼æ˜¯ä¸€ä¸ªæ•°ç»„"><a href="#Q2-è¿”å›å€¼æ˜¯ä¸€ä¸ªæ•°ç»„" class="headerlink" title="Q2: è¿”å›å€¼æ˜¯ä¸€ä¸ªæ•°ç»„"></a>Q2: è¿”å›å€¼æ˜¯ä¸€ä¸ªæ•°ç»„</h4><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä¹‹å‰å¯èƒ½æœ‰ä¸€ä¸ª <code>get: /article/tags</code>  çš„æ¥å£ï¼Œç”±äºä¸€ç¯‡æ–‡ç« å½“ä¸­çš„æ ‡ç­¾ä¸ä¼šå¾ˆå¤šï¼Œæ‰€ä»¥æˆ‘ä»¬æ²¡æœ‰åšåˆ†é¡µï¼Œè¿”å›æ•°æ®çš„æ—¶å€™ç›´æ¥åœ¨ data é‡Œé¢å¡äº†ä¸€ä¸ªæ•°ç»„ï¼Œç„¶åæˆ‘ä»¬è¿ç§»çš„æ—¶å€™å°±éº»çƒ¦äº† o(â•¥ï¹â•¥)o</p><p>å› ä¸ºåœ¨ protobuf çš„ rpc æ–¹æ³•å®šä¹‰å½“ä¸­ï¼Œåªèƒ½è¿”å›ä¸€ä¸ªç»“æ„ä½“ï¼Œæ— æ³•è¿”å›ä¸€ä¸ªæ•°ç»„ç»“æ„ï¼Œä½†æ˜¯æˆ‘ä»¬åšé‡æ„çš„æ—¶å€™åˆä¸æƒ³æœ‰ api çš„ç ´åæ€§å˜æ›´ï¼Œå› ä¸ºè¿™é¡¹æ‰€æœ‰çš„ä¾èµ–æ–¹éƒ½éœ€è¦è¿›è¡Œä¿®æ”¹æˆæœ¬å¤ªå¤§äº†ï¼Œé‚£æˆ‘ä»¬å¦‚ä½•å…¼å®¹å‘¢ï¼Ÿ</p><p>æˆ‘çš„è§£å†³æ–¹æ¡ˆæ˜¯å…ˆç”Ÿæˆå¯¹åº”çš„ go ç»“æ„ä½“ï¼Œç„¶ååœ¨åŒä¸€ä¸ªåŒ…å†…åˆ›å»ºä¸€ä¸ª <code>xx_type.pb.go</code>  é‡Œé¢å®ç° json çš„è§£ææ¥å£ï¼Œè®©æˆ‘ä»¬è™½ç„¶å®šä¹‰çš„æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œä½†æ˜¯è¿”å›æ¥å£æ•°æ®çš„æ—¶å€™è¿”å›çš„æ˜¯ä¸€ä¸ªæ•°ç»„</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹é¢æ˜¯æˆ‘å®šä¹‰çš„ pb</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs protobuf"><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">ListArticleTagsResp</span> </span>&#123;<br>  <span class="hljs-keyword">repeated</span> Tag tags = <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">Tag</span> </span>&#123;<br>  <span class="hljs-built_in">string</span> key = <span class="hljs-number">1</span>;<br>  <span class="hljs-built_in">string</span> value = <span class="hljs-number">2</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åç”Ÿæˆäº† <code>v1.pb.go</code> ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ª <code>v1_type.pb.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// UnmarshalJSON sets *m to a copy of data.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *ListArticleTagsResp)</span> <span class="hljs-title">UnmarshalJSON</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">if</span> m == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;json.RawMessage: UnmarshalJSON on nil pointer&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">return</span> json.Unmarshal(data, &amp;m.Tags)<br>&#125;<br><br><span class="hljs-comment">// MarshalJSON returns m as the JSON encoding of m.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *ListArticleTagsResp)</span> <span class="hljs-title">MarshalJSON</span><span class="hljs-params">()</span> <span class="hljs-params">([]<span class="hljs-keyword">byte</span>, error)</span></span> &#123;<br><span class="hljs-keyword">if</span> m == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> []<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;null&quot;</span>), <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-keyword">return</span> json.Marshal(m.Tags)<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ç„¶åç»­æœ€å¥½è¿˜æ˜¯ä¿®æ”¹ä¸€ä¸‹ï¼Œä½†æ˜¯é‡æ„çš„æ—¶å€™è¿˜æ˜¯å»ºè®®ä¸è¦åšç ´åæ€§çš„å˜åŠ¨</p><h4 id="Q3-è¿”å›å€¼å½“ä¸­åŒ…å«æ—¶é—´"><a href="#Q3-è¿”å›å€¼å½“ä¸­åŒ…å«æ—¶é—´" class="headerlink" title="Q3: è¿”å›å€¼å½“ä¸­åŒ…å«æ—¶é—´"></a>Q3: è¿”å›å€¼å½“ä¸­åŒ…å«æ—¶é—´</h4><p>é™¤äº†æ•°ç»„ä¹‹å¤–ï¼Œè¿”å›å€¼å½“ä¸­åŒ…å«æ—¶é—´ä¹Ÿæ˜¯æŒºéº»çƒ¦çš„ä¸€ä»¶äº‹æƒ…ï¼Œé¦–å…ˆ pb çš„åŸºç¡€ç±»å‹é‡Œé¢æ²¡æœ‰æ—¶é—´ç±»å‹ï¼Œç„¶å google å®˜æ–¹çš„åº“å½“ä¸­æœ‰ä¸€ä¸ª timestamp åŒ…ï¼Œå¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ—¶å€™å°±ä¼šå‘ç°ï¼Œåœ¨ json åºåˆ—è¯çš„æ—¶å€™ä¸æ˜¯ä¸€ä¸ªæ—¶é—´å­—æ®µï¼Œè€Œæ˜¯ä¸€ä¸ªå¯¹è±¡å€¼ï¼Œå’Œæˆ‘ä»¬ä¹‹å‰ç›´æ¥ä½¿ç”¨ <code>time.Time</code>  çš„è¡Œä¸ºä¸ä¸€è‡´ã€‚</p><p>æˆ‘çš„åšæ³•æ˜¯ä»¿ç…§ google çš„åŒ…è‡ªå·±æä¸€ä¸ªç„¶åå®ç° json çš„ç›¸å…³æ–¹æ³•ï¼Œè®© json åºåˆ—åŒ–çš„æ—¶å€™çš„è¡Œä¸ºå’Œ <code>time.Time</code>  ä¿æŒä¸€è‡´</p><p>é¦–å…ˆå®šä¹‰ <code>timestamp.proto</code></p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs protobuf"><span class="hljs-comment">// è¿™é‡ŒæŒ‡å®šäº† proto æ–‡ä»¶çš„ç‰ˆæœ¬</span><br>syntax = <span class="hljs-string">&quot;proto3&quot;</span>;<br><br><span class="hljs-comment">// package å‘½åè§„åˆ™: product.application.version</span><br><span class="hljs-keyword">package</span> product.app.v1;<br><br><span class="hljs-comment">// go_package ç”Ÿæˆ go æ–‡ä»¶å½“ä¸­çš„åŒ…å</span><br><span class="hljs-keyword">option</span> go_package = <span class="hljs-string">&quot;github.com/mohuishou/new-project/api/product/app/v1&quot;</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">Timestamp</span> </span>&#123;<br><br>    <span class="hljs-comment">// Represents seconds of UTC time since Unix epoch</span><br>    <span class="hljs-comment">// 1970-01-01T00:00:00Z. Must be from 0001-01-01T00:00:00Z to</span><br>    <span class="hljs-comment">// 9999-12-31T23:59:59Z inclusive.</span><br>    <span class="hljs-built_in">int64</span> seconds = <span class="hljs-number">1</span>;<br><br>    <span class="hljs-comment">// Non-negative fractions of a second at nanosecond resolution. Negative</span><br>    <span class="hljs-comment">// second values with fractions must still have non-negative nanos values</span><br>    <span class="hljs-comment">// that count forward in time. Must be from 0 to 999,999,999</span><br>    <span class="hljs-comment">// inclusive.</span><br>    <span class="hljs-built_in">int32</span> nanos = <span class="hljs-number">2</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å’Œä¸Šé¢ä¸€æ ·ï¼Œåˆ›å»ºä¸€ä¸ª <code>timestamp_type.pb.go</code> ï¼Œé™¤äº†å®ç° json çš„æ¥å£ä»¥å¤–è¿˜å®ç°äº†ä¸¤ä¸ªè½¬æ¢æ–¹æ³•ï¼Œç”¨äº service å±‚è°ƒç”¨</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// NewTimestamp NewTimestamp</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewTimestamp</span><span class="hljs-params">(t time.Time)</span> *<span class="hljs-title">Timestamp</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;Timestamp&#123;<br>Seconds: t.Unix(),<br>Nanos:   <span class="hljs-keyword">int32</span>(t.Nanosecond()),<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Time ç±»å‹è½¬æ¢</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Timestamp)</span> <span class="hljs-title">Time</span><span class="hljs-params">()</span> <span class="hljs-title">time</span>.<span class="hljs-title">Time</span></span> &#123;<br><span class="hljs-comment">// Don&#x27;t return the zero value on error, because corresponds to a valid</span><br><span class="hljs-comment">// timestamp. Instead return whatever time.Unix gives us.</span><br><span class="hljs-keyword">if</span> m == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> time.Unix(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>).UTC() <span class="hljs-comment">// treat nil like the empty Timestamp</span><br>&#125;<br><br><span class="hljs-keyword">return</span> time.Unix(m.Seconds, <span class="hljs-keyword">int64</span>(m.Nanos)).UTC()<br>&#125;<br><br><span class="hljs-comment">// UnmarshalJSON sets *m to a copy of data.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Timestamp)</span> <span class="hljs-title">UnmarshalJSON</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">if</span> m == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;json.RawMessage: UnmarshalJSON on nil pointer&quot;</span>)<br>&#125;<br><span class="hljs-keyword">var</span> t time.Time<br><span class="hljs-keyword">if</span> err := json.Unmarshal(data, &amp;t); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br>*m = *NewTimestamp(t)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// MarshalJSON returns m as the JSON encoding of m.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Timestamp)</span> <span class="hljs-title">MarshalJSON</span><span class="hljs-params">()</span> <span class="hljs-params">([]<span class="hljs-keyword">byte</span>, error)</span></span> &#123;<br><span class="hljs-keyword">if</span> m == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> []<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;null&quot;</span>), <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-keyword">return</span> json.Marshal(m.Time())<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="domain"><a href="#domain" class="headerlink" title="domain"></a>domain</h3><p>domain è¿™ä¸€å±‚ä¸»è¦æ˜¯åŒ…å« do å¯¹è±¡çš„å®šä¹‰ï¼Œä»¥åŠ usecase å’Œ repo å±‚çš„æ¥å£å®šä¹‰ï¼Œç”±äºæˆ‘ä»¬ç°åœ¨ä½¿ç”¨çš„ gorm æ‰€ä»¥ï¼Œä¹Ÿä¼šåœ¨è¿™é‡Œç»™ do å¯¹è±¡åŠ ä¸Šä¸€äº› tag ç”¨äºæ ‡å¿—ç´¢å¼•ï¼Œå…³è”å…³ç³»ç­‰ã€‚</p><h4 id="domain-example"><a href="#domain-example" class="headerlink" title="domain example"></a>domain example</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// article.go</span><br><br><span class="hljs-comment">// Article æ–‡ç« </span><br><span class="hljs-keyword">type</span> Article <span class="hljs-keyword">struct</span> &#123;<br>Model <span class="hljs-comment">// åŸºç¡€ç»“æ„ä½“ï¼ŒåŒ…å« id, created_at, deleted_at, updated_at</span><br><br>Title   <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;title&quot;`</span><br>Content <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;content&quot;`</span><br>Tags    []Tag  <span class="hljs-string">`json:&quot;tags&quot; gorm:&quot;many2many:article_tags&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// IArticleUsecase IArticleUsecase</span><br><span class="hljs-keyword">type</span> IArticleUsecase <span class="hljs-keyword">interface</span> &#123;<br>    <span class="hljs-comment">// è·å–æ–‡ç« è¯¦æƒ…</span><br>GetArticle(ctx context.Context, id <span class="hljs-keyword">int</span>) (*Article, error)<br><span class="hljs-comment">// åˆ›å»ºä¸€ç¯‡æ–‡ç« </span><br>    CreateArticle(ctx context.Context, article *Article) error<br>&#125;<br><br><span class="hljs-comment">// IArticleRepo IArticleRepo</span><br><span class="hljs-keyword">type</span> IArticleRepo <span class="hljs-keyword">interface</span> &#123;<br>GetArticle(ctx context.Context, id <span class="hljs-keyword">int</span>) (*Article, error)<br>CreateArticle(ctx context.Context, article *Article) error<br>&#125;<br><br><span class="hljs-comment">// tag.go</span><br><br><span class="hljs-comment">// Tag æ ‡ç­¾æ•°æ®</span><br><span class="hljs-keyword">type</span> Tag <span class="hljs-keyword">struct</span> &#123;<br>Model<br><br>Key   <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;key&quot;`</span><br>Value <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;value&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸€å±‚çš„å‘ç¨å¾®å°‘ä¸€äº›ï¼Œä¸»è¦æ˜¯æ¥å£å®šä¹‰çš„ç›¸å…³äº‹æƒ…</p><h4 id="å°æŠ€å·§-æ‰¹é‡-mock-æ¥å£"><a href="#å°æŠ€å·§-æ‰¹é‡-mock-æ¥å£" class="headerlink" title="å°æŠ€å·§: æ‰¹é‡ mock æ¥å£"></a>å°æŠ€å·§: æ‰¹é‡ mock æ¥å£</h4><p>ä½¿ç”¨æœ€æ–°çš„é¡¹ç›®ç»“æ„æˆ‘ä»¬ä¼šåœ¨ domain ä¸­åˆ›å»ºå¤§é‡æ¥å£ï¼Œä¹‹å‰åœ¨ <a href="https://lailin.xyz/post/go-training-week4-unit-test.html">Go å·¥ç¨‹åŒ–(å…«) å•å…ƒæµ‹è¯•</a> ä¸­æˆ‘ä»¬æåˆ°äº†ï¼Œåœ¨æ¯ä¸€å±‚çš„å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½ä¼šæŠŠä¾èµ–çš„æ¥å£ç”¨ gomock ç»™ mock æ‰ï¼Œè®©æµ‹è¯•å°½é‡è½»é‡çº§ä¸€äº›ï¼Œä¸ºäº†ç®€åŒ– gomock çš„åˆ›å»ºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>makefile</code>  å½“ä¸­å†™ä¸€ä¸ª <code>shell</code>  è„šæœ¬ï¼Œæ‰¾å‡ºå«æœ‰ <code>interface</code>  å®šä¹‰çš„æ–‡ä»¶ï¼Œç„¶åæˆ‘ä»¬ç”¨ gomock ç”Ÿæˆå¯¹åº”çš„ mock æ–‡ä»¶</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">mockgen:</span><br>cd ./internal &amp;&amp; for file in `egrep -rnl <span class="hljs-string">&quot;type.*?interface&quot;</span> ./domain | grep -v <span class="hljs-string">&quot;_test&quot;</span> `; do \<br>echo $$file ; \<br>cd .. &amp;&amp; mockgen -destination=<span class="hljs-string">&quot;./internal/pkg/mock/$$file&quot;</span> -source=<span class="hljs-string">&quot;./internal/$$file&quot;</span> &amp;&amp; cd ./internal ; \<br>done<br></code></pre></td></tr></table></figure><h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><p>æ–°çš„ service å±‚çš„ä¸»è¦å·¦å³å°±æ˜¯ dto æ•°æ®å’Œ do æ•°æ®çš„ç›¸äº’è½¬æ¢ï¼Œå®ƒå®ç°äº† <code>v1</code>  åŒ…ä¸­çš„ç›¸å…³æ¥å£ï¼Œservice çš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä¸€ä¸ªä¾‹å­</p><h4 id="service-example"><a href="#service-example" class="headerlink" title="service example"></a>service example</h4><p>æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨è¿ç§» serviceã€usecaseã€repo çš„æ—¶å€™ï¼Œéƒ½åº”è¯¥å…ˆå†™å¯¹åº”çš„å•å…ƒæµ‹è¯•ï¼Œæœ¬æ–‡å½“ä¸­ç”±äºç¯‡å¹…åŸå› æˆ‘å°±æ²¡æœ‰å†åˆ—äº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥æŸ¥çœ‹ä¸Šä¸€ç¯‡æ–‡ç«  <a href="https://lailin.xyz/post/go-training-week4-unit-test.html">Go å·¥ç¨‹åŒ–(å…«) å•å…ƒæµ‹è¯•</a> å¯¹åº”ç« èŠ‚çš„å†…å®¹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ç¡®ä¿å®ç°äº†å¯¹åº”çš„æ¥å£</span><br><span class="hljs-keyword">var</span> _ v1.BlogServiceHTTPServer = &amp;Artcile&#123;&#125;<br><br><span class="hljs-comment">// Artcile Artcile</span><br><span class="hljs-keyword">type</span> Artcile <span class="hljs-keyword">struct</span> &#123;<br>usecase domain.IArticleUsecase<br>&#125;<br><br><span class="hljs-comment">// NewArticleService åˆå§‹åŒ–æ–¹æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewArticleService</span><span class="hljs-params">(usecase domain.IArticleUsecase)</span> *<span class="hljs-title">Artcile</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;Artcile&#123;usecase: usecase&#125;<br>&#125;<br><br><span class="hljs-comment">// CreateArticle åˆ›å»ºä¸€ç¯‡æ–‡ç« </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *Artcile)</span> <span class="hljs-title">CreateArticle</span><span class="hljs-params">(ctx context.Context, req *v1.CreateArticleReq)</span> <span class="hljs-params">(*v1.CreateArticleResp, error)</span></span> &#123;<br>article := &amp;domain.Article&#123;<br>Title:   req.Title,<br>Content: req.Content,<br>&#125;<br>err := a.usecase.CreateArticle(ctx, article)<br><span class="hljs-keyword">return</span> &amp;v1.CreateArticleResp&#123;&#125;, err<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å°æŠ€å·§-copier-å‡å°‘é‡å¤çš„å¤åˆ¶ç²˜è´´æ“ä½œ"><a href="#å°æŠ€å·§-copier-å‡å°‘é‡å¤çš„å¤åˆ¶ç²˜è´´æ“ä½œ" class="headerlink" title="å°æŠ€å·§: copier å‡å°‘é‡å¤çš„å¤åˆ¶ç²˜è´´æ“ä½œ"></a>å°æŠ€å·§: copier å‡å°‘é‡å¤çš„å¤åˆ¶ç²˜è´´æ“ä½œ</h4><p>åœ¨ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„æ•°æ®è½¬æ¢æ˜¯æ‰‹åŠ¨å†™çš„ï¼Œè¿™ç§æ–¹æ³•ä¸æ˜¯ä¸è¡Œï¼Œä½†æ˜¯ç¤ºä¾‹å½“ä¸­çš„å­—æ®µæ¯”è¾ƒå°‘ï¼Œå¦‚æœå­—æ®µå¤šäº†èµ·æ¥ï¼Œå¹¶ä¸”è¿˜æœ‰å„ç§æ•°ç»„ç±»å‹çš„å­˜åœ¨çš„æ—¶å€™ï¼Œæ•°æ®è½¬æ¢çš„è¿™éƒ¨åˆ†ä»£ç å†™çš„å°±ä¼šæ¯”è¾ƒéš¾å—äº†ï¼Œå¦‚æœä½ çš„åº”ç”¨å’Œæˆ‘çš„ä¸€æ ·å¯¹æ€§èƒ½çš„è¦æ±‚ä¸æ˜¯å¾ˆé«˜çš„è¯å¯ä»¥è¯•è¯•ä¸‹é¢è¿™ç§æ–¹å¼ã€‚</p><p>æˆ‘æœ€å¼€å§‹æ˜¯ç”¨äº† jinzhu å¤§ä½¬çš„ <a href="https://pkg.go.dev/github.com/jinzhu/copier">copier</a> åŒ…æ¥åšçš„æ•°æ®è½¬æ¢ï¼Œä½†æ˜¯è¿™ä¸ªåŒ…æ¯”è¾ƒå±€é™ï¼Œå®ƒä¸»è¦æ˜¯åœ¨ä¸¤ä¸ªç»“æ„çš„ä¹‹é—´çš„å­—æ®µåä»¥åŠç±»å‹ç›¸åŒçš„æ—¶å€™æœ‰ç”¨ï¼Œå‘å‡ºç°æˆ‘ä»¬ä¸Šé¢åœ¨ api éƒ¨åˆ†è®²çš„é‚£ç§éªšæ“ä½œå°±ä¸é€‚ç”¨äº†ï¼Œå¹¶ä¸”æˆ‘è¿˜å‡ºç°è¿‡ç”±äºä¸¤è¾¹å­—æ®µçš„å¤§å°å†™ä¸ä¸€è‡´å¯¼è‡´æœ€åæœ‰ä¸€ä¸ªå­—æ®µæ²¡æœ‰å¤åˆ¶æˆåŠŸå¯¼è‡´çš„é—®é¢˜ï¼ˆæ‰€ä»¥ç”¨è¿™ä¸ªä¸€å®šè¦å†™å¯¹åº”çš„å•å…ƒæµ‹è¯•ï¼‰ã€‚</p><p>æ‰€ä»¥ç»“åˆæˆ‘ä»¬ä¹‹å‰çš„æ“ä½œï¼Œæˆ‘è‡ªå·±æ‰‹åŠ¨å†™äº†ä¸€ä¸ª copier å‡½æ•°ç­¾åä¸€æ ·ï¼Œå®ç°éå¸¸ç®€å•ï¼Œå½“ç„¶æ€§èƒ½ä¸å¤ªå¥½ï¼Œä½†æ˜¯å¦‚æœå¯¹æ€§èƒ½è¦æ±‚ä¸é«˜çš„è¯ä¹Ÿèƒ½ç”¨.</p><p>å¦‚ä¸‹æ‰€ç¤ºï¼Œå°±æ˜¯ç”¨ json æ¥å›å€’è…¾ä¸¤æ¬¡å°±è¡Œäº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Copy ä»ä¸€ä¸ªç»“æ„ä½“å¤åˆ¶åˆ°å¦ä¸€ä¸ªç»“æ„ä½“</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Copy</span><span class="hljs-params">(to, from <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;<br>b, err := json.Marshal(from)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> errors.Wrap(err, <span class="hljs-string">&quot;marshal from data err&quot;</span>)<br>&#125;<br><br>err = json.Unmarshal(b, to)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> errors.Wrap(err, <span class="hljs-string">&quot;unmarshal to data err&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœä½¿ç”¨è¿™ä¸ªå‡½æ•°çš„è¯ï¼Œæˆ‘ä»¬ä¸Šé¢çš„ä»£ç å°±å¯ä»¥æ”¹æˆ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// CreateArticle åˆ›å»ºä¸€ç¯‡æ–‡ç« </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *Artcile)</span> <span class="hljs-title">CreateArticle</span><span class="hljs-params">(ctx context.Context, req *v1.CreateArticleReq)</span> <span class="hljs-params">(*v1.CreateArticleResp, error)</span></span> &#123;<br><span class="hljs-keyword">var</span> article domain.Article<br>err := copier.Copy(&amp;article, req)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br>err = a.usecase.CreateArticle(ctx, &amp;article)<br><span class="hljs-keyword">return</span> &amp;v1.CreateArticleResp&#123;&#125;, err<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="usecase"><a href="#usecase" class="headerlink" title="usecase"></a>usecase</h3><p>è¿™ä¸€å±‚ä¸»è¦æ˜¯ä¸šåŠ¡é€»è¾‘ï¼Œä¸šåŠ¡é€»è¾‘ç›¸å…³ä»£ç éƒ½åº”è¯¥åœ¨è¿™ä¸€å±‚å†™ï¼Œå½“ç„¶æœ‰æ—¶å€™æˆ‘ä»¬çš„ä»£ç å¯èƒ½å°±åªæ˜¯ä¿å­˜ä¸€ä¸‹æ•°æ®æ²¡å•¥ä¸šåŠ¡é€»è¾‘ï¼Œå¯èƒ½æ˜¯ç›´æ¥è°ƒç”¨ä¸€ä¸‹ repo çš„æ–¹å¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> article <span class="hljs-keyword">struct</span> &#123;<br>repo domain.IArticleRepo<br>&#125;<br><br><span class="hljs-comment">// NewArticleUsecase init</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewArticleUsecase</span><span class="hljs-params">(repo domain.IArticleRepo)</span> <span class="hljs-title">domain</span>.<span class="hljs-title">IArticleUsecase</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;article&#123;repo: repo&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *article)</span> <span class="hljs-title">GetArticle</span><span class="hljs-params">(ctx context.Context, id <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(*domain.Article, error)</span></span> &#123;<br><span class="hljs-comment">// è¿™é‡Œå¯èƒ½æœ‰å…¶ä»–ä¸šåŠ¡é€»è¾‘...</span><br><span class="hljs-keyword">return</span> u.repo.GetArticle(ctx, id)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *article)</span> <span class="hljs-title">CreateArticle</span><span class="hljs-params">(ctx context.Context, article *domain.Article)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> u.repo.CreateArticle(ctx, article)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="repo"><a href="#repo" class="headerlink" title="repo"></a>repo</h3><p>è¿™ä¸€å±‚æ˜¯æ•°æ®æŒä¹…å±‚ï¼Œåƒæ•°æ®åº“å­˜å–ï¼Œç¼“å­˜çš„å¤„ç†åº”è¯¥éƒ½åœ¨è¿™ä¸€å±‚åšæ‰ï¼Œè¿˜æœ‰å¯èƒ½åç»­æˆ‘ä»¬å˜æˆè°ƒç”¨ä¸€ä¸ªå¾®æœåŠ¡æ¥å®ç°ï¼Œé‚£ä¹ˆè¿™ä¸ªè¢«è°ƒç”¨çš„å¾®æœåŠ¡ä¹Ÿåº”è¯¥åœ¨è¿™é‡Œåšã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> article <span class="hljs-keyword">struct</span> &#123;<br>db *gorm.DB<br>&#125;<br><br><span class="hljs-comment">// NewArticleRepo init</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewArticleRepo</span><span class="hljs-params">(db *gorm.DB)</span> <span class="hljs-title">domain</span>.<span class="hljs-title">IArticleRepo</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;article&#123;db: db&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *article)</span> <span class="hljs-title">GetArticle</span><span class="hljs-params">(ctx context.Context, id <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(*domain.Article, error)</span></span> &#123;<br><span class="hljs-keyword">var</span> a domain.Article<br><span class="hljs-keyword">if</span> err := r.db.WithContext(ctx).Find(&amp;a, id); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// è¿™é‡Œè¿”å›ä¸šåŠ¡é”™è¯¯ç </span><br>&#125;<br><span class="hljs-keyword">return</span> &amp;a, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *article)</span> <span class="hljs-title">CreateArticle</span><span class="hljs-params">(ctx context.Context, article *domain.Article)</span> <span class="hljs-title">error</span></span> &#123;<br><br><span class="hljs-keyword">if</span> err := r.db.WithContext(ctx).Create(article); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// è¿™é‡Œè¿”å›ä¸šåŠ¡é”™è¯¯ç </span><br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="wire-set-go"><a href="#wire-set-go" class="headerlink" title="wire_set.go"></a>wire_set.go</h3><p>ä¹‹å‰åœ¨ <a href="https://lailin.xyz/post/go-training-week4-wire.html">Go å·¥ç¨‹åŒ–(ä¸‰) ä¾èµ–æ³¨å…¥æ¡†æ¶ wire</a> è¿™ä¸€èŠ‚è®²åˆ°è¿‡ï¼Œæˆ‘ä»¬ä½¿ç”¨ wire ä½œä¸ºæˆ‘ä»¬çš„ä¾èµ–æ³¨å…¥æ¡†æ¶ï¼Œç”±äº wire ä¸èƒ½å‡ºç°ç›¸åŒçš„ Provider æ‰€ä»¥æˆ‘ä»¬ä¼šåœ¨ internal çš„æ¯ä¸ªå­ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸‹ wire_set.go ç”¨äºæ„å»º wire.Set ç»“æ„ï¼Œåˆ°æ—¶æˆ‘ä»¬åœ¨ cmd ä¸‹ç›´æ¥åº”ç”¨è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹å°±å¯ä»¥äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> server<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;github.com/google/wire&quot;</span><br><span class="hljs-string">&quot;github.com/mohuishou/new-project/internal/server/repo&quot;</span><br><span class="hljs-string">&quot;github.com/mohuishou/new-project/internal/server/service&quot;</span><br><span class="hljs-string">&quot;github.com/mohuishou/new-project/internal/server/usecase&quot;</span><br>)<br><br><span class="hljs-comment">// Set for di</span><br><span class="hljs-keyword">var</span> Set = wire.NewSet(<br>service.NewArticleService,<br>usecase.NewArticleUsecase,<br>repo.NewArticleRepo,<br>)<br></code></pre></td></tr></table></figure><h3 id="cmd"><a href="#cmd" class="headerlink" title="cmd"></a>cmd</h3><p>cmd ä¸‹çš„äºŒè¿›åˆ¶ç›®å½•ï¼Œæˆ‘ä¸€èˆ¬ä¼šåŒ…å«å››ä¸ªæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">.<br>â”œâ”€â”€ main.go <span class="hljs-comment"># åŒ…å« main å‡½æ•°</span><br>â”œâ”€â”€ server.go <span class="hljs-comment"># åŒ…å« wire set ç­‰</span><br>â”œâ”€â”€ wire.go <span class="hljs-comment"># for wire build</span><br>â””â”€â”€ wire_gen.go <span class="hljs-comment"># wire è‡ªåŠ¨ç”Ÿæˆçš„</span><br></code></pre></td></tr></table></figure><p><strong>server.go</strong> åœ¨çœŸå®çš„é¡¹ç›®å½“ä¸­æˆ‘ä»¬ service åŒ…ä¸‹é¢ä¸€èˆ¬ä¼šæœ‰å¤šä¸ª service æ–‡ä»¶ï¼Œå¯¹åº”ä¸åŒçš„ç»“æ„ä½“ï¼Œå¹¶ä¸”é™¤äº† internal ä¸­çš„ä¾èµ–å¤–æˆ‘ä»¬å¯èƒ½è¿˜ä¼šæœ‰å¾ˆå¤šå…¬å…±çš„ä¾èµ–ï¼Œä¾‹å¦‚é…ç½®ä¸­å¿ƒï¼Œæ—¥å¿—ï¼Œæ•°æ®åº“ç­‰ï¼Œæˆ‘çš„ä¹ æƒ¯æ˜¯æ„å»ºä¸€ä¸ªæ–°çš„ç»“æ„ï¼Œåœ¨è¿™ä¸ªç»“æ„å½“ä¸­æˆ‘ä»¬æŠŠæ‰€æœ‰çš„æ³¨å†Œè¿˜è¿˜æœ‰ wire.set æå¥½ï¼Œè¿™æ · main å‡½æ•°å°±ä¼šå¾ˆæ¸…çˆ½ï¼Œæ•´ä½“ä¸Šä¹Ÿä¼šæ¯”è¾ƒæ•´æ´</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> set = wire.NewSet(<br><span class="hljs-comment">// domains</span><br>server.Set,<br><br><span class="hljs-comment">// common</span><br>initializer.Set,<br>)<br><br><span class="hljs-keyword">type</span> services <span class="hljs-keyword">struct</span> &#123;<br>article *service.Artcile<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *services)</span> <span class="hljs-title">register</span><span class="hljs-params">(r gin.IRouter)</span></span> &#123;<br>v1.RegisterBlogServiceHTTPServer(r, s.article)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>wire.go</strong> ç»è¿‡ server.go å°è£…ä¹‹åï¼Œwire.go çš„ä»£ç å°±éå¸¸ç®€å•äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// NewServices NewServices</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServices</span><span class="hljs-params">()</span> <span class="hljs-params">(*services, error)</span></span> &#123;<br><span class="hljs-built_in">panic</span>(wire.Build(<br>wire.Struct(<span class="hljs-built_in">new</span>(services), <span class="hljs-string">&quot;*&quot;</span>),<br>set,<br>))<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>main.go</strong> æˆ‘è¿™é‡Œè¿˜æ²¡æœ‰åƒ <a href="https://github.com/go-kratos/kratos/blob/main/app.go">kratos</a> æŠŠç¨‹åºçš„å¯åŠ¨å’Œé€€å‡ºå°è£…èµ·æ¥ï¼Œå¦‚æœå°è£…äº†ä¼šæ›´åŠ ä¼˜é›…ä¸€ç‚¹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>s, err := NewServices()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br><br>e := gin.Default()<br>s.register(e)<br><br><span class="hljs-comment">// è¿™é‡Œè¿˜æœ‰ä¼˜é›…ä¸­æ­¢çš„ä¸€äº›ä»£ç ï¼Œå°±ä¸è´´äº†</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1615219210365-000fcd85-392a-41da-b7e4-8b4fc583123f.jpeg" alt="Frame 1 (4).jpg"><br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1615268889054-251a4e39-c8d9-410f-950c-5262b368ae34.jpeg" alt="Frame 2 (1).jpg"><br>æˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹ä¸Šé¢è¿™ä¸¤ç§ç»“æ„ï¼Œå¯ä»¥å‘ç°ï¼Œç¬¬ä¸€ç§ç»“æ„æ•´ä½“ä¸ŠèŒè´£ç›¸å¯¹æ²¡æœ‰é‚£ä¹ˆæ¸…æ™°ï¼Œå°±å¯¼è‡´äº†åœ¨å›¢é˜Ÿåä½œçš„è¿‡ç¨‹ä¸­ä¼šå‡ºç°å¾ˆå¤šäºŒä¹‰æ€§ï¼Œå¯¼è‡´æœ€åè¶Šæ¥è¶Šæ··ä¹±ï¼Œå¹¶ä¸”ç”±äº model å±‚å°±æ˜¯ä¸€ä¸ªå¤§é”…é¥­ï¼Œä»€ä¹ˆéƒ½å¾€é‡Œé¢æ‰”æ‰€ä»¥ä¹Ÿå°±ä¹±çš„ä¸è¡Œäº†ã€‚</p><p>æ–°çš„ç»“æ„ä¸ä»…ä»…è¿›è¡Œäº†æ°´å¹³æ‹†åˆ†è¿˜æŒ‰ç…§åŠŸèƒ½è¿›è¡Œäº†å‚ç›´æ‹†åˆ†ï¼Œå°†å®šæ—¶ä»»åŠ¡å’Œ http æœåŠ¡çš„ä»£ç æ‹†åˆ†å¼€æ¥ï¼Œæ•´ä½“çš„ç»“æ„éƒ½æ¸…æ™°äº†å¾ˆå¤šï¼Œå¹¶ä¸”ç”±äºæˆ‘ä»¬å¤§é‡ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œæ‰€ä»¥ä»£ç çš„å¯æµ‹æ€§éå¸¸çš„å¥½ï¼Œå†™å•å…ƒæµ‹è¯•éå¸¸å®¹æ˜“ã€‚<br>ä½†æ˜¯è¿™é‡Œä¹Ÿæœ‰ä¸€ä¸ªå‘ï¼Œæ‹†åˆ†çš„æ—¶å€™è¦æ³¨æ„ï¼Œæˆ‘ç¬¬ä¸€æ¬¡æ‹†åˆ†æƒ³æŒ‰ç…§é¢†åŸŸè¿›è¡Œæ‹†åˆ†ï¼Œå¹¶ä¸”æ‹†åˆ†çš„éå¸¸ç»†ï¼Œå¯¼è‡´å‡ºç°äº†å¾ˆå¤šæœåŠ¡ï¼Œåé¢å¬è¿‡æ¯›è€å¸ˆè¯¾ä¸Šçš„è®²è§£åé‡æ–° review äº†ä¸€ä¸‹å‘ç°å…¶å®è¿™äº›æœåŠ¡è¾¹ç•Œæ²¡æœ‰é‚£ä¹ˆæ¸…æ™°ï¼Œå³ä½¿æˆ‘ä»¬ä»¥åæ‹†å¾®æœåŠ¡ï¼Œä¹Ÿä¸ä¼šæŠŠè¿™äº›æ‹†æˆä¸¤ä¸ªä¸åŒçš„å¾®æœåŠ¡ï¼Œæ‰€ä»¥åé¢å†æ”¹äº†ä¸€æ¬¡æ‰æ„æˆäº†ç°åœ¨çš„ç»“æ„ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨è¿›è¡Œå‚ç›´æ‹†åˆ†çš„æ—¶å€™ä¸€å®šè¦å¤šé—®é—®è‡ªå·±ï¼Œæˆ–è€…å¤šå’Œå›¢é˜Ÿçš„åŒå­¦è®¨è®ºä¸€ä¸‹ã€‚</p><p>æœ€åæƒ³è¦ä¸šåŠ¡å¼€å‘çš„æ¯”è¾ƒå¼€å¿ƒæ„‰å¿«ï¼Œé‚£åŸºç¡€è®¾æ–½çš„å»ºè®¾éå¸¸é‡è¦ï¼Œåƒæœ¬æ–‡æåˆ°çš„å¾ˆå¤šä»£ç åªè¦æˆ‘ä»¬ç»Ÿä¸€äº†è§„èŒƒå’Œç»“æ„éƒ½å¯ä»¥é€šè¿‡å·¥å…·æ¥è‡ªåŠ¨ç”Ÿæˆã€‚</p><p><strong>æˆ‘ä»¬ä¸‹ä¸€ç¯‡æ–‡ç« è§ï¼ŒåŠ æ²¹æ‰“å·¥äºº ğŸ’ªï¼ˆçœ‹å®Œåˆ«å¿˜äº†è½¬å‘ï¼Œè®¢é˜…ï¼Œç‚¹èµå“¦ï¼‰</strong></p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go è¿›é˜¶è®­ç»ƒè¥-æå®¢æ—¶é—´</a></li><li><a href="https://lailin.xyz/post/go-training-week4-clean-arch.html">Go å·¥ç¨‹åŒ–(ä¸€) æ¶æ„æ•´æ´ä¹‹é“é˜…è¯»ç¬”è®° - Mohuishou</a></li><li><a href="https://lailin.xyz/post/go-training-week4-project-layout.html">Go å·¥ç¨‹åŒ–(äºŒ) é¡¹ç›®ç›®å½•ç»“æ„ - Mohuishou</a></li><li><a href="https://lailin.xyz/post/go-training-week4-wire.html">Go å·¥ç¨‹åŒ–(ä¸‰) ä¾èµ–æ³¨å…¥æ¡†æ¶ wire - Mohuishou</a></li><li><a href="https://lailin.xyz/post/go-training-week4-api-design.html">Go å·¥ç¨‹åŒ–(å››) API è®¾è®¡ä¸Š: é¡¹ç›®ç»“æ„ &amp; è®¾è®¡ - Mohuishou</a></li><li><a href="https://lailin.xyz/post/go-training-week4-protoc-gen-go-gin.html">Go å·¥ç¨‹åŒ–(äº”) API è®¾è®¡ä¸‹: åŸºäº protobuf è‡ªåŠ¨ç”Ÿæˆ gin ä»£ç  - Mohuishou</a></li><li><a href="https://lailin.xyz/post/go-training-week4-config.html">Go å·¥ç¨‹åŒ–(å…­) é…ç½®ç®¡ç† - Mohuishou</a></li><li><a href="https://lailin.xyz/post/go-training-week4-go-module.html">Go å·¥ç¨‹åŒ–(ä¸ƒ) Go Module - Mohuishou</a></li><li><a href="https://lailin.xyz/post/go-training-week4-unit-test.html">Go å·¥ç¨‹åŒ–(å…«) å•å…ƒæµ‹è¯• - Mohuishou</a></li><li><a href="https://github.com/favadi/protoc-go-inject-tag">https://github.com/favadi/protoc-go-inject-tag</a></li><li><a href="https://pkg.go.dev/github.com/jinzhu/copier">https://pkg.go.dev/github.com/jinzhu/copier</a></li><li><a href="https://github.com/go-kratos/kratos/blob/main/app.go">https://github.com/go-kratos/kratos/blob/main/app.go</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week04: Go å·¥ç¨‹åŒ–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å·¥ç¨‹åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå·¥ç¨‹åŒ–(å…«) å•å…ƒæµ‹è¯•</title>
    <link href="/post/go-training-week4-unit-test.html"/>
    <url>/post/go-training-week4-unit-test.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p><strong>3 æœˆè¿›åº¦: 05/15</strong> 3 æœˆå¼€å§‹ä¼šå°è¯•çˆ†æ›´æ¨¡å¼ï¼Œäº‰å–åšåˆ°ä¸¤å¤©æ›´æ–°ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœæ„Ÿå…´è¶£å¯ä»¥æ‹‰åˆ°æ–‡ç« æœ€ä¸‹æ–¹è·å–å…³æ³¨æ–¹å¼ã€‚</p><p>ä»æˆ‘ä»¬å¼€å§‹å¼€å‘ä»¥æ¥ï¼Œåº”è¯¥å¾ˆå¤šäººéƒ½æåˆ°è¿‡æµ‹è¯•çš„é‡è¦æ€§ï¼Œè€Œåœ¨æ‰€æœ‰çš„æµ‹è¯•ç±»å‹å½“ä¸­ï¼Œä»¥å•å…ƒæµ‹è¯•ä¸ºä»£è¡¨çš„å•å…ƒæµ‹è¯•æ— ç–‘æ˜¯æˆæœ¬æœ€å°ï¼Œæ€§ä»·æ¯”æœ€é«˜çš„ä¸€ç§ï¼Œè€Œä¸”æœ‰çš„å…¬å¸ä¸ºäº†ä¿è¯è´¨é‡ä¼šè¦æ±‚å•å…ƒæµ‹è¯•è¦†ç›–ç‡çš„æŒ‡æ ‡ï¼ˆåŒ…æ‹¬æˆ‘ä»¬ï¼‰</p><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1614514088908-363f1894-098c-47e5-8289-0e223adda8a6.png" alt="image.png"><br>æ‰€ä»¥å¸Œæœ›çœ‹å®Œè¿™ç¯‡æ–‡ç« ï¼Œå¸Œæœ›å¤§å®¶å¯ä»¥å¾ˆå¿«çš„åœ¨æˆ‘ä»¬ä¹‹å‰æå‡ºçš„é¡¹ç›®ç»“æ„ä¸Šè¿›è¡Œå•å…ƒæµ‹è¯•çš„ç¼–å†™ï¼Œå¯ä»¥åšåˆ°åˆå¿«åˆå¥½ã€‚<br>æœ¬æ–‡åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå‰åŠæ®µä¼šç®€å•ä»‹ç»ä¸€ä¸‹ go çš„å•å…ƒæµ‹è¯•æ€ä¹ˆå†™ï¼Œä¸ä¼šæœ‰å¾ˆå¤æ‚çš„æŠ€å·§ï¼Œå¦‚æœå·²ç»æ¯”è¾ƒäº†è§£å¯ä»¥è·³è¿‡ï¼ŒååŠæ®µä¼šä»‹ç»ä¸€ä¸‹æˆ‘ä»¬åœ¨é¡¹ç›®å½“ä¸­è¯¥å¦‚ä½•å†™ â€œå•å…ƒæµ‹è¯•â€</p><h2 id="å•å…ƒæµ‹è¯•ç®€æ˜æ•™ç¨‹"><a href="#å•å…ƒæµ‹è¯•ç®€æ˜æ•™ç¨‹" class="headerlink" title="å•å…ƒæµ‹è¯•ç®€æ˜æ•™ç¨‹"></a>å•å…ƒæµ‹è¯•ç®€æ˜æ•™ç¨‹</h2><h3 id="go-test"><a href="#go-test" class="headerlink" title="go test"></a>go test</h3><h4 id="ä¸€ä¸ªç®€å•çš„-ğŸŒ°"><a href="#ä¸€ä¸ªç®€å•çš„-ğŸŒ°" class="headerlink" title="ä¸€ä¸ªç®€å•çš„ ğŸŒ°"></a>ä¸€ä¸ªç®€å•çš„ ğŸŒ°</h4><p>é¡¹ç›®ç»“æ„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">.<br>â”œâ”€â”€ max.go<br>â””â”€â”€ max_test.go<br></code></pre></td></tr></table></figure><p>max.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> max<br><br><span class="hljs-comment">// Int get the max</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Int</span><span class="hljs-params">(a, b <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;<br><span class="hljs-keyword">if</span> a &gt; b &#123;<br><span class="hljs-keyword">return</span> a<br>&#125;<br><span class="hljs-keyword">return</span> b<br>&#125;<br></code></pre></td></tr></table></figure><p>max_test.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> max<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestInt</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">if</span> got := Int(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>); got != <span class="hljs-number">2</span> &#123;<br>t.Errorf(<span class="hljs-string">&quot;exp: %d, got: %d&quot;</span>, <span class="hljs-number">2</span>, got)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">â–¶ go <span class="hljs-built_in">test</span><br>PASS<br>ok      code/max        0.006s<br></code></pre></td></tr></table></figure><p><strong>å•å…ƒæµ‹è¯•æ–‡ä»¶è¯´æ˜</strong></p><ul><li>æ–‡ä»¶åå¿…é¡»æ˜¯<code>_test.go</code>ç»“å°¾çš„ï¼Œè¿™æ ·åœ¨æ‰§è¡Œ<code>go test</code>çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œåˆ°ç›¸åº”çš„ä»£ç ã€‚</li><li>ä½ å¿…é¡»<code>import testing</code>è¿™ä¸ªåŒ…ã€‚</li><li>æ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹å‡½æ•°å¿…é¡»æ˜¯<code>Test</code>å¼€å¤´ã€‚</li><li>æµ‹è¯•ç”¨ä¾‹ä¼šæŒ‰ç…§æºä»£ç ä¸­å†™çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚</li><li>æµ‹è¯•å‡½æ•°<code>TestX()</code>çš„å‚æ•°æ˜¯<code>testing.T</code>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥ç±»å‹æ¥è®°å½•é”™è¯¯æˆ–è€…æ˜¯æµ‹è¯•çŠ¶æ€ã€‚</li><li>æµ‹è¯•æ ¼å¼ï¼š<code>func TestXxx (t *testing.T)</code>,<code>Xxx</code>éƒ¨åˆ†å¯ä»¥ä¸ºä»»æ„çš„å­—æ¯æ•°å­—çš„ç»„åˆï¼Œä½†æ˜¯é¦–å­—æ¯ä¸èƒ½æ˜¯å°å†™å­—æ¯[a-z]ï¼Œä¾‹å¦‚<code>Testintdiv</code>æ˜¯é”™è¯¯çš„å‡½æ•°åã€‚</li><li>å‡½æ•°ä¸­é€šè¿‡è°ƒç”¨<code>testing.T</code>çš„<code>Error</code>, <code>Errorf</code>, <code>FailNow</code>, <code>Fatal</code>, <code>FatalIf</code>æ–¹æ³•ï¼Œè¯´æ˜æµ‹è¯•ä¸é€šè¿‡ï¼Œè°ƒç”¨<code>Log</code>æ–¹æ³•ç”¨æ¥è®°å½•æµ‹è¯•çš„ä¿¡æ¯ã€‚</li></ul><h4 id="è¡¨é©±åŠ¨æµ‹è¯•"><a href="#è¡¨é©±åŠ¨æµ‹è¯•" class="headerlink" title="è¡¨é©±åŠ¨æµ‹è¯•"></a>è¡¨é©±åŠ¨æµ‹è¯•</h4><p>åœ¨å®é™…ç¼–å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦æ‰§è¡Œå¤šä¸ªæµ‹è¯•ç”¨ä¾‹ï¼ŒæœŸæœ›è¾¾åˆ°æ›´å…¨é¢çš„è¦†ç›–æ•ˆæœï¼Œè¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨è¡¨é©±åŠ¨æµ‹è¯•äº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestInt_Table</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>tests := []<span class="hljs-keyword">struct</span> &#123;<br>name <span class="hljs-keyword">string</span><br>a    <span class="hljs-keyword">int</span><br>b    <span class="hljs-keyword">int</span><br>want <span class="hljs-keyword">int</span><br>&#125;&#123;<br>&#123;name: <span class="hljs-string">&quot;a&gt;b&quot;</span>, a: <span class="hljs-number">10</span>, b: <span class="hljs-number">2</span>, want: <span class="hljs-number">10</span>&#125;,<br>&#123;name: <span class="hljs-string">&quot;a&lt;b&quot;</span>, a: <span class="hljs-number">1</span>, b: <span class="hljs-number">2</span>, want: <span class="hljs-number">2</span>&#125;,<br>&#125;<br><br><span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;<br>t.Run(tt.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">if</span> got := Int(tt.a, tt.b); got != tt.want &#123;<br>t.Errorf(<span class="hljs-string">&quot;exp: %d, got: %d&quot;</span>, tt.want, got)<br>&#125;<br>&#125;)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go">â–¶ <span class="hljs-keyword">go</span> test -v<br>=== RUN   TestInt<br>--- PASS: TestInt (<span class="hljs-number">0.00</span>s)<br>=== RUN   TestInt_Table<br>=== RUN   TestInt_Table/a&gt;b<br>=== RUN   TestInt_Table/a&lt;b<br>--- PASS: TestInt_Table (<span class="hljs-number">0.00</span>s)<br>    --- PASS: TestInt_Table/a&gt;b (<span class="hljs-number">0.00</span>s)<br>    --- PASS: TestInt_Table/a&lt;b (<span class="hljs-number">0.00</span>s)<br>PASS<br></code></pre></td></tr></table></figure><p><strong>éšæœºæ‰§è¡Œ</strong><br>ä¸Šé¢çš„ä¾‹å­æ˜¯æŒ‰ç…§é¡ºåºæ‰§è¡Œçš„ï¼Œå•å…ƒæµ‹è¯•å¤§å¤šéšæœºæ‰§è¡Œæ›´èƒ½å¤Ÿå‘ç°ä¸€äº›æ²¡æœ‰æ³¨æ„åˆ°çš„é”™è¯¯, å¦‚ä¸‹é¢çš„è¿™ä¸ªä¾‹å­ï¼Œåˆ©ç”¨ <code>map</code> çš„ç‰¹æ€§æˆ‘ä»¬å¾ˆå®¹æ˜“å°†ä¸Šé¢è¿™ä¸ªä¾‹å­æ”¹é€ ä¸ºéšæœºæ‰§è¡Œçš„å•å…ƒæµ‹è¯•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestInt_RandTable</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>tests := <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">struct</span> &#123;<br>a    <span class="hljs-keyword">int</span><br>b    <span class="hljs-keyword">int</span><br>want <span class="hljs-keyword">int</span><br>&#125;&#123;<br><span class="hljs-string">&quot;a&gt;b&quot;</span>: &#123;a: <span class="hljs-number">10</span>, b: <span class="hljs-number">2</span>, want: <span class="hljs-number">10</span>&#125;,<br><span class="hljs-string">&quot;a&lt;b&quot;</span>: &#123;a: <span class="hljs-number">1</span>, b: <span class="hljs-number">2</span>, want: <span class="hljs-number">2</span>&#125;,<br>&#125;<br><br><span class="hljs-keyword">for</span> name, tt := <span class="hljs-keyword">range</span> tests &#123;<br>t.Run(name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">if</span> got := Int(tt.a, tt.b); got != tt.want &#123;<br>t.Errorf(<span class="hljs-string">&quot;exp: %d, got: %d&quot;</span>, tt.want, got)<br>&#125;<br>&#125;)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="testfiy"><a href="#testfiy" class="headerlink" title="testfiy"></a>testfiy</h3><p>æ ‡å‡†åº“ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªè¿˜ä¸é”™çš„æµ‹è¯•æ¡†æ¶ï¼Œä½†æ˜¯æ²¡æœ‰æä¾›æ–­è¨€çš„åŠŸèƒ½ï¼Œ<code>testify</code> åŒ…å«äº† æ–­è¨€ã€mockã€suite ä¸‰ä¸ªåŠŸèƒ½ï¼Œmock æ¨èä½¿ç”¨å®˜æ–¹çš„ <code>gomock</code></p><p><code>testify/assert</code> æä¾›äº†éå¸¸å¤šçš„æ–¹æ³•ï¼Œè¿™é‡Œä¸ºå¤§å®¶ä»‹ç»æœ€ä¸ºå¸¸ç”¨çš„ä¸€äº›ï¼Œæ‰€æœ‰çš„æ–¹æ³•å¯ä»¥è®¿é—® <a href="https://godoc.org/github.com/stretchr/testify/assert">https://godoc.org/github.com/stretchr/testify/assert</a> æŸ¥çœ‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åˆ¤æ–­ä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Equal</span><span class="hljs-params">(t TestingT, expected, actual <span class="hljs-keyword">interface</span>&#123;&#125;, msgAndArgs ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span><br><span class="hljs-comment">// åˆ¤æ–­ä¸¤ä¸ªå€¼ä¸ç›¸ç­‰</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NotEqual</span><span class="hljs-params">(t TestingT, expected, actual <span class="hljs-keyword">interface</span>&#123;&#125;, msgAndArgs ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span><br><span class="hljs-comment">// æµ‹è¯•å¤±è´¥ï¼Œæµ‹è¯•ä¸­æ–­</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">FailNow</span><span class="hljs-params">(t TestingT, failureMessage <span class="hljs-keyword">string</span>, msgAndArgs ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span><br><span class="hljs-comment">// åˆ¤æ–­å€¼æ˜¯å¦ä¸ºnilï¼Œå¸¸ç”¨äº error çš„åˆ¤æ–­</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Nil</span><span class="hljs-params">(t TestingT, object <span class="hljs-keyword">interface</span>&#123;&#125;, msgAndArgs ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span><br><span class="hljs-comment">// åˆ¤æ–­å€¼æ˜¯å¦ä¸ä¸ºnilï¼Œå¸¸ç”¨äº error çš„åˆ¤æ–­</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NotNil</span><span class="hljs-params">(t TestingT, object <span class="hljs-keyword">interface</span>&#123;&#125;, msgAndArgs ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ–­è¨€æ–¹æ³•éƒ½ä¼šè¿”å›ä¸€ä¸ª <code>bool</code> å€¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªè¿”å›å€¼åˆ¤æ–­æ–­è¨€æˆåŠŸ/å¤±è´¥ï¼Œä»è€Œåšä¸€äº›å¤„ç†</p><p>ä¸€ä¸ªä¾‹å­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestInt_assert_fail</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>got := Int(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<br>assert.Equal(t, <span class="hljs-number">1</span>, got)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœ, å¯ä»¥çœ‹åˆ°è¾“å‡ºååˆ†çš„æ¸…æ™°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">=== RUN   TestInt_assert_fail<br>--- FAIL: TestInt_assert_fail (0.00s)<br>    max_test.go:62:<br>                Error Trace:    max_test.go:62<br>                Error:          Not equal:<br>                                expected: 1<br>                                actual  : 2<br>                Test:           TestInt_assert_fail<br>FAIL<br>FAIL    code/max        0.017s<br></code></pre></td></tr></table></figure><h3 id="gomock"><a href="#gomock" class="headerlink" title="gomock"></a>gomock</h3><h4 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h4><p><strong>æ³¨æ„: è¯·åœ¨éé¡¹ç›®æ–‡ä»¶å¤¹æ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">GO111MODULE=on GOPROXY=https://goproxy.cn go get github.com/golang/mock/mockgen<br></code></pre></td></tr></table></figure><p><code>mockgen</code> æ˜¯ä¸€ä¸ªä»£ç ç”Ÿæˆå·¥å…·ï¼Œå¯ä»¥å¯¹åŒ…æˆ–è€…æºä»£ç æ–‡ä»¶ç”ŸæˆæŒ‡å®š<strong>æ¥å£</strong>çš„ Mock ä»£ç </p><h4 id="ç”Ÿæˆ-Mock-ä»£ç "><a href="#ç”Ÿæˆ-Mock-ä»£ç " class="headerlink" title="ç”Ÿæˆ Mock ä»£ç "></a>ç”Ÿæˆ Mock ä»£ç </h4><p>æŒ‡å®šæºæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">mockgen -<span class="hljs-built_in">source</span>=./.go  -destination=./a_mock.go  INeedMockInterface<br><br>mockgen -<span class="hljs-built_in">source</span>=æºæ–‡ä»¶è·¯å¾„  -destination=å†™å…¥æ–‡ä»¶çš„è·¯å¾„(æ²¡æœ‰è¿™ä¸ªå‚æ•°è¾“å‡ºåˆ°ç»ˆç«¯) éœ€è¦mockçš„æ¥å£å(å¤šä¸ªæ¥å£é€—å·é—´éš”)<br></code></pre></td></tr></table></figure><p>æŒ‡å®šåŒ…è·¯å¾„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mockgen  -destination=å†™å…¥æ–‡ä»¶çš„è·¯å¾„(æ²¡æœ‰è¿™ä¸ªå‚æ•°è¾“å‡ºåˆ°ç»ˆç«¯) åŒ…è·¯å¾„ éœ€è¦mockçš„æ¥å£å(å¤šä¸ªæ¥å£é€—å·é—´éš”)<br></code></pre></td></tr></table></figure><h4 id="ä¸€ä¸ªç®€å•çš„-gomock-ğŸŒ°"><a href="#ä¸€ä¸ªç®€å•çš„-gomock-ğŸŒ°" class="headerlink" title="ä¸€ä¸ªç®€å•çš„ gomock ğŸŒ°"></a>ä¸€ä¸ªç®€å•çš„ gomock ğŸŒ°</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// UserAge è·å–ç”¨æˆ·å¹´é¾„</span><br><span class="hljs-keyword">type</span> UserAge <span class="hljs-keyword">interface</span> &#123;<br>GetAge(user <span class="hljs-keyword">string</span>) <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-comment">// Simple ä¸€ä¸ªç®€å•çš„ä¾‹å­</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Simple</span><span class="hljs-params">(user <span class="hljs-keyword">string</span>, age UserAge)</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;%s age is: %d&quot;</span>, user, age.GetAge(user))<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSimple</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-comment">// æ–°å»ºä¸€ä¸ªmockå¯¹è±¡</span><br>ctrl := gomock.NewController(t)<br>age := mock_mock.NewMockUserAge(ctrl)<br><br>  <span class="hljs-comment">// mock è¿”å›å€¼</span><br>age.EXPECT().GetAge(gomock.Any()).Return(<span class="hljs-number">1</span>).AnyTimes()<br><br>assert.Equal(t, <span class="hljs-string">&quot;a age is: 1&quot;</span>, Simple(<span class="hljs-string">&quot;a&quot;</span>, age))<br>&#125;<br></code></pre></td></tr></table></figure><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">æœ¬æ–‡åªæ˜¯ç®€å•ä»‹ç»ç”¨æ³•ï¼Œè¯¦ç»†ä½¿ç”¨åŠ API è¯´æ˜å¯ä»¥æŸ¥çœ‹å®˜æ–¹ä»“åº“ï¼Œ<a href="https://github.com/golang/mock">https://github.com/golang/mock</a></div><h2 id="é¡¹ç›®-â€œå•å…ƒæµ‹è¯•â€"><a href="#é¡¹ç›®-â€œå•å…ƒæµ‹è¯•â€" class="headerlink" title="é¡¹ç›® â€œå•å…ƒæµ‹è¯•â€"></a>é¡¹ç›® â€œå•å…ƒæµ‹è¯•â€</h2><p>æ¥ä¸‹æ¥å°±æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œåœ¨æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ <a href="https://lailin.xyz/post/go-training-week4-project-layout.html">Go å·¥ç¨‹åŒ–(äºŒ) é¡¹ç›®ç›®å½•ç»“æ„</a> å½“ä¸­ï¼Œå¦‚ä½•ç¼–å†™å•å…ƒæµ‹è¯•ã€‚è™½ç„¶è¿™é‡Œè¯´çš„æ˜¯å•å…ƒæµ‹è¯•ï¼Œå…¶å®åé¢è®²çš„å…¶å®å¾ˆå¤šä¸æ˜¯å•å…ƒæµ‹è¯•ï¼Œåƒ repo å±‚ï¼Œå¦‚æœæ¶‰åŠåˆ°æ•°æ®åº“åé¢å°±ä¼šè®²åˆ°æˆ‘ä»¬ä¸€èˆ¬ä¼šå¯åŠ¨ä¸€ä¸ªçœŸå®çš„æ•°æ®åº“æ¥æµ‹è¯•ï¼Œè¿™å…¶å®å·²ç»ç®—æ˜¯é›†æˆæµ‹è¯•äº†ï¼Œä½†æ˜¯å®ƒä»ç„¶æ˜¯è½»é‡çº§çš„ã€‚</p><h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><p>è¿™ä¸€å±‚ä¸»è¦å¤„ç†çš„ dto å’Œ do æ•°æ®ä¹‹é—´çš„ç›¸äº’è½¬æ¢ï¼Œæœ¬èº«æ˜¯ä¸å«ä»€ä¹ˆä¸šåŠ¡é€»è¾‘çš„ï¼Œç›®å‰æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ httpï¼Œæ‰€ä»¥åœ¨è¿™ä¸€å±‚çš„æµ‹è¯•ä¸€èˆ¬ä¼šä½¿ç”¨ httptest æ¥æ¨¡æ‹Ÿå®é™…è¯·æ±‚çš„æµ‹è¯•ã€‚ç„¶ååœ¨å¯¹ usecase å±‚çš„è°ƒç”¨ä¸Šï¼Œæˆ‘ä»¬ä½¿ç”¨ gomock mock æ‰ç›¸å…³çš„æ¥å£ï¼Œç®€åŒ–æˆ‘ä»¬çš„æµ‹è¯•ã€‚å¦‚æœä½ ä¸æƒ³å†™çš„é‚£ä¹ˆéº»çƒ¦ï¼Œä¹Ÿå¯ä»¥ä¸ç”¨å¯ç”¨ httptest æ¥æµ‹è¯•ï¼Œç›´æ¥æµ‹è¯• service å±‚çš„ä»£ç ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸è¿‡è¿™æ ·çš„è¯ï¼Œservice å±‚çš„ä»£ç æµ‹è¯•çš„å†…å®¹å°±æ²¡æœ‰å¤šå°‘äº†ï¼Œä¹Ÿå°±æ˜¯çœ‹è½¬æ¢æ•°æ®çš„æ—¶å€™ç¬¦ä¸ç¬¦åˆé¢„æœŸã€‚</p><p>è¿™ä¸€å±‚ä¸»è¦å®Œæˆçš„æµ‹è¯•æ˜¯</p><ul><li>å‚æ•°çš„æ ¡éªŒæ˜¯å¦ç¬¦åˆé¢„æœŸ</li><li>æ•°æ®çš„è½¬æ¢æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œå¦‚æœä½ åƒæˆ‘ä¸€æ ·å·æ‡’ä½¿ç”¨äº†ç±»ä¼¼ <a href="https://pkg.go.dev/github.com/jinzhu/copier">copier</a> çš„å·¥å…·çš„è¯ä¸€å®šè¦å†™è¿™éƒ¨åˆ†çš„å•å…ƒæµ‹è¯•ï¼Œä¸ç„¶è¿˜æ˜¯å¾ˆå®¹æ˜“å‡ºé”™ï¼Œå®¹æ˜“å­—æ®µåä¸ä¸€è‡´å¯¼è‡´ copier çš„å·¥ä½œä¸æ­£å¸¸</li></ul><p>å½“ç„¶å¦‚æœæ—¶é—´æœ‰é™çš„è¯ï¼Œè¿™ä¸€å±‚çš„æµ‹è¯•ä¹Ÿä¸æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºæ¥å…¥å±‚ç›¸å¯¹æ¥è¯´å˜åŒ–ä¹Ÿæ¯”è¾ƒå¿«ä¸€ç‚¹ï¼Œè¿™æ˜¯è¯´å†™äº†å•å…ƒæµ‹è¯•ï¼ŒåŸºæœ¬ä¸Šåœ¨æµ‹è¯•é˜¶æ®µå¾ˆå°‘ä¼šå‡ºç°ç”±äºå‚æ•°çš„é—®é¢˜æäº¤è¿‡æ¥çš„ bug</p><p>åŒæ ·æˆ‘ä»¬ç›´æ¥çœ‹ä¸€ä¸ªä¾‹å­, é¦–å…ˆæ˜¯ service å±‚çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯è°ƒç”¨äº†ä¸€ä¸‹ï¼Œusecase å±‚çš„æ¥å£</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> _ v1.BlogServiceHTTPServer = &amp;PostService&#123;&#125;<br><br><span class="hljs-comment">// PostService PostService</span><br><span class="hljs-keyword">type</span> PostService <span class="hljs-keyword">struct</span> &#123;<br>Usecase domain.IPostUsecase<br>&#125;<br><br><span class="hljs-comment">// CreateArticle åˆ›å»ºæ–‡ç« </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *PostService)</span> <span class="hljs-title">CreateArticle</span><span class="hljs-params">(ctx context.Context, req *v1.Article)</span> <span class="hljs-params">(*v1.Article, error)</span></span> &#123;<br>article, err := p.Usecase.CreateArticle(ctx, domain.Article&#123;<br>Title:    req.Title,<br>Content:  req.Content,<br>AuthorID: req.AuthorId,<br>&#125;)<br><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br><span class="hljs-keyword">var</span> resp v1.Article<br>err = copier.Copy(&amp;resp, &amp;article)<br><span class="hljs-keyword">return</span> &amp;resp, err<br>&#125;<br></code></pre></td></tr></table></figure><p>å†çœ‹çœ‹å•å…ƒæµ‹è¯•<br>é¦–å…ˆæ˜¯åˆå§‹åŒ–ï¼Œä¹‹å‰æˆ‘ä»¬è®²åˆ°åˆå§‹åŒ–çš„æ—¶å€™æˆ‘ä»¬ä¸€èˆ¬åœ¨ cmd å½“ä¸­ä½¿ç”¨ wire è‡ªåŠ¨ç”Ÿæˆï¼Œä½†æ˜¯åœ¨å•å…ƒæµ‹è¯•ä¸­ wire å¹¶ä¸å¥½ç”¨ï¼Œå¹¶ä¸”ç”±äºå•å…ƒæµ‹è¯•çš„æ—¶å€™æˆ‘ä»¬çš„ä¾èµ–é¡¹å…¶å®æ²¡æœ‰çœŸå®çš„ä¾èµ–é¡¹é‚£ä¹ˆå¤æ‚æˆ‘ä»¬åªéœ€è¦å…³å¿ƒå½“å‰è¿™ä¸€å±‚çš„ä¾èµ–å³å¯ï¼Œæ‰€ä»¥ä¸€èˆ¬åœ¨å•å…ƒæµ‹è¯•çš„æ—¶å€™æˆ‘éƒ½æ˜¯æ‰‹å†™åˆå§‹åŒ–<br>ä¸€èˆ¬ä¼šå‘ä¸‹é¢è¿™æ ·ï¼Œä½¿ç”¨ä¸€ä¸ª struct åŒ…è£…èµ·æ¥ï¼Œå› ä¸ºåœ¨åé¢åƒæ˜¯ mock çš„ usecase è¿˜éœ€è¦è°ƒç”¨</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> testPostService <span class="hljs-keyword">struct</span> &#123;<br>post    *PostService<br>usecase *mock_domain.MockIPostUsecase<br>handler *gin.Engine<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initPostService</span><span class="hljs-params">(t *testing.T)</span> *<span class="hljs-title">testPostService</span></span> &#123;<br>ctrl := gomock.NewController(t)<br>usecase := mock_domain.NewMockIPostUsecase(ctrl)<br>service := &amp;PostService&#123;Usecase: usecase&#125;<br><br>handler := gin.New()<br>v1.RegisterBlogServiceHTTPServer(handler, service)<br><br><span class="hljs-keyword">return</span> &amp;testPostService&#123;<br>post:    service,<br>usecase: usecase,<br>handler: handler,<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®é™…çš„æµ‹è¯•ï¼Œè¿™ä¸€å—ä¸»è¦æ˜¯ä¸ºäº†å±•ç¤ºä¸€ä¸ªå®Œæ•´çš„å•å…ƒæµ‹è¯•æ‰€ä»¥è´´çš„ä»£ç ç¨å¾®é•¿äº†ä¸€äº›ï¼Œåé¢çš„ä¸¤å±‚å…·ä½“çš„å•å…ƒæµ‹è¯•ä»£ç éƒ½å¤§åŒå°å¼‚ï¼Œæˆ‘å°±ä¸å†è´´äº†ï¼Œä¸»è¦çš„æ€è·¯å°±æ˜¯æŠŠä¾èµ–çš„æ¥å£éƒ½ç”¨ gomock mock æ‰ï¼Œè¿™æ ·å®é™…å†™å•å…ƒæµ‹è¯•ä»£ç çš„æ—¶å€™å°±ä¼šæ¯”è¾ƒç®€å•ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestPostService_CreateArticle</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>s := initPostService(t)<br>s.usecase.EXPECT().<br>CreateArticle(gomock.Any(), gomock.Eq(domain.Article&#123;Title: <span class="hljs-string">&quot;err&quot;</span>, AuthorID: <span class="hljs-number">1</span>&#125;)).<br>Return(domain.Article&#123;&#125;, fmt.Errorf(<span class="hljs-string">&quot;err&quot;</span>))<br>s.usecase.EXPECT().<br>CreateArticle(gomock.Any(), gomock.Eq(domain.Article&#123;Title: <span class="hljs-string">&quot;success&quot;</span>, AuthorID: <span class="hljs-number">2</span>&#125;)).<br>Return(domain.Article&#123;Title: <span class="hljs-string">&quot;success&quot;</span>&#125;, <span class="hljs-literal">nil</span>)<br><br>tests := []<span class="hljs-keyword">struct</span> &#123;<br>name       <span class="hljs-keyword">string</span><br>params     *v1.Article<br>want       *v1.Article<br>wantStatus <span class="hljs-keyword">int</span><br>wantCode   <span class="hljs-keyword">int</span><br>wantErr    <span class="hljs-keyword">string</span><br>&#125;&#123;<br>&#123;<br>name: <span class="hljs-string">&quot;å‚æ•°é”™è¯¯ author_id å¿…é¡»&quot;</span>,<br>params: &amp;v1.Article&#123;<br>Title:    <span class="hljs-string">&quot;1&quot;</span>,<br>Content:  <span class="hljs-string">&quot;2&quot;</span>,<br>AuthorId: <span class="hljs-number">0</span>,<br>&#125;,<br>want:       <span class="hljs-literal">nil</span>,<br>wantStatus: <span class="hljs-number">400</span>,<br>wantCode:   <span class="hljs-number">400</span>,<br>&#125;,<br>&#123;<br>name: <span class="hljs-string">&quot;å¤±è´¥&quot;</span>,<br>params: &amp;v1.Article&#123;<br>Title:    <span class="hljs-string">&quot;err&quot;</span>,<br>AuthorId: <span class="hljs-number">1</span>,<br>&#125;,<br>want:       <span class="hljs-literal">nil</span>,<br>wantStatus: <span class="hljs-number">500</span>,<br>wantCode:   <span class="hljs-number">-1</span>,<br>&#125;,<br>&#123;<br>name: <span class="hljs-string">&quot;æˆåŠŸ&quot;</span>,<br>params: &amp;v1.Article&#123;<br>Title:    <span class="hljs-string">&quot;success&quot;</span>,<br>AuthorId: <span class="hljs-number">2</span>,<br>&#125;,<br>want: &amp;v1.Article&#123;<br>Title: <span class="hljs-string">&quot;success&quot;</span>,<br>&#125;,<br>wantStatus: <span class="hljs-number">200</span>,<br>wantCode:   <span class="hljs-number">0</span>,<br>&#125;,<br>&#125;<br><span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;<br>t.Run(tt.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-comment">// ä¸‹é¢è¿™äº›ä¸€èˆ¬éƒ½ä¼šå°è£…åœ¨ä¸€èµ·ï¼Œè¿™é‡Œæ˜¯ä¸ºäº†æ¼”ç¤º</span><br><br><span class="hljs-comment">// åˆå§‹åŒ–è¯·æ±‚</span><br>b, err := json.Marshal(tt.params)<br>require.NoError(t, err)<br>uri := fmt.Sprintf(<span class="hljs-string">&quot;/v1/author/%d/articles&quot;</span>, tt.params.AuthorId)<br>req := httptest.NewRequest(http.MethodPost, uri, bytes.NewReader(b))<br><br><span class="hljs-comment">// åˆå§‹åŒ–å“åº”</span><br>w := httptest.NewRecorder()<br><br><span class="hljs-comment">// è°ƒç”¨ç›¸åº”çš„handleræ¥å£</span><br>s.handler.ServeHTTP(w, req)<br><br><span class="hljs-comment">// æå–å“åº”</span><br>resp := w.Result()<br><span class="hljs-keyword">defer</span> resp.Body.Close()<br>require.Equal(t, tt.wantStatus, resp.StatusCode)<br><br><span class="hljs-comment">// è¯»å–å“åº”body</span><br>respBody, _ := ioutil.ReadAll(resp.Body)<br>r := <span class="hljs-keyword">struct</span> &#123;<br>Code <span class="hljs-keyword">int</span>         <span class="hljs-string">`json:&quot;code&quot;`</span><br>Msg  <span class="hljs-keyword">string</span>      <span class="hljs-string">`json:&quot;msg&quot;`</span><br>Data *v1.Article <span class="hljs-string">`json:&quot;data&quot;`</span><br>&#125;&#123;&#125;<br>require.NoError(t, json.Unmarshal(respBody, &amp;r))<br><br>assert.Equal(t, tt.wantCode, r.Code)<br>assert.Equal(t, tt.want, r.Data)<br>&#125;)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="usecase"><a href="#usecase" class="headerlink" title="usecase"></a>usecase</h3><p>usecase æ˜¯ä¸»è¦çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ‰€ä»¥ä¸€èˆ¬å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™éƒ½åº”è¯¥å…ˆå†™è¿™ä¸€å±‚çš„å•è¿œæµ‹è¯•ï¼Œè€Œä¸”è¿™ä¸€å±‚æˆ‘ä»¬æ²¡æœ‰ä»»ä½•ä¾èµ–ï¼Œåªéœ€è¦æŠŠ repo å±‚çš„æ¥å£ç›´æ¥ mock æ‰å°±å¯ä»¥äº†ï¼Œæ˜¯éå¸¸çº¯å‡€çš„ä¸€å±‚ï¼Œå…¶å®ä¹Ÿå°±è¿™ä¸€å±‚çš„å•å…ƒæµ‹è¯•æ‰æ˜¯çœŸæ­£çš„å•å…ƒæµ‹è¯•</p><h3 id="repo"><a href="#repo" class="headerlink" title="repo"></a>repo</h3><p>repo å±‚æˆ‘ä»¬ä¸€èˆ¬ä¾èµ– mysql æˆ–è€…æ˜¯ redis ç­‰æ•°æ®åº“ï¼Œåœ¨æµ‹è¯•çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥ç›´æ¥å¯åŠ¨ä¸€ä¸ªå…¨æ–°çš„æ•°æ®åº“ç”¨äºæµ‹è¯•å³å¯ã€‚</p><h4 id="æœ¬åœ°"><a href="#æœ¬åœ°" class="headerlink" title="æœ¬åœ°"></a>æœ¬åœ°</h4><p>ç›´æ¥ä½¿ç”¨ docker run å¯¹åº”çš„æ•°æ®åº“å°±å¯ä»¥äº†</p><h4 id="ci-cd"><a href="#ci-cd" class="headerlink" title="ci/cd"></a>ci/cd</h4><p>æˆ‘ä»¬çš„ ci cd æ˜¯ä½¿ç”¨çš„ gitlabï¼Œgitlab æœ‰ä¸€ä¸ªæ¯”è¾ƒå¥½ç”¨çš„åŠŸèƒ½æ˜¯æŒ‡å®š serviceï¼Œåªéœ€è¦æŒ‡å®šå¯¹åº”çš„æ•°æ®åº“é•œåƒæˆ‘ä»¬å°±å¯ä»¥åœ¨æµ‹è¯•å®¹å™¨å¯åŠ¨çš„æ—¶å€™è‡ªåŠ¨å¯åŠ¨å¯¹åº”çš„æµ‹è¯•æ•°æ®åº“å®¹å™¨ï¼Œå¹¶ä¸”æ¯ä¸€æ¬¡éƒ½æ˜¯å…¨æ–°çš„ç©ºæ•°æ®åº“ã€‚æˆ‘ä»¬åªéœ€è¦æ¯æ¬¡è·‘å•å…ƒæµ‹è¯•çš„æ—¶å€™å…ˆè·‘ä¸€ä¸‹æ•°æ®åº“çš„ migration å°±å¯ä»¥äº†ã€‚</p><p>ä¸‹é¢ç»™å‡ºä¸€ä¸ªé…ç½®ç¤ºä¾‹</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">test:</span><br>  <span class="hljs-attr">stage:</span> <span class="hljs-string">test</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">golang:1.15-alpine-test</span><br>  <span class="hljs-attr">services:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">redis:v4.0.11</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">postgres:10-alpine</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">docker:19-dind</span><br>  <span class="hljs-attr">variables:</span><br>    <span class="hljs-attr">POSTGRES_DB:</span> <span class="hljs-string">test_db</span><br>    <span class="hljs-attr">POSTGRES_USER:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">POSTGRES_PASSWORD:</span> <span class="hljs-number">1234567</span><br>    <span class="hljs-attr">GOPROXY:</span> <span class="hljs-string">&quot;è¿™é‡Œè®¾ç½® proxy åœ°å€&quot;</span><br>    <span class="hljs-attr">CGO_ENABLED:</span> <span class="hljs-number">0</span><br>  <span class="hljs-attr">script:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">go</span> <span class="hljs-string">mod</span> <span class="hljs-string">download</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">go</span> <span class="hljs-string">run</span> <span class="hljs-string">db/*.go</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">mkdir</span> <span class="hljs-string">artifacts</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">gotestsum</span> <span class="hljs-string">--</span> <span class="hljs-string">-p</span> <span class="hljs-number">1</span> <span class="hljs-string">-v</span> <span class="hljs-string">-coverprofile=./artifacts/coverage.out</span> <span class="hljs-string">-coverpkg=./...</span> <span class="hljs-string">./...</span><br>    <span class="hljs-comment"># å•å…ƒæµ‹è¯•ç»Ÿè®¡å»é™¤ä¸€äº›ä¸éœ€è¦æµ‹è¯•çš„ä»£ç </span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">|</span><br>      <span class="hljs-string">cat</span> <span class="hljs-string">./artifacts/coverage.out</span> <span class="hljs-string">|</span> <span class="hljs-string">\</span><br>      <span class="hljs-string">grep</span> <span class="hljs-string">-v</span> <span class="hljs-string">&quot;/mock/&quot;</span> <span class="hljs-string">|</span> <span class="hljs-string">grep</span> <span class="hljs-string">-v</span> <span class="hljs-string">&quot;/db/&quot;</span> <span class="hljs-string">|</span>  <span class="hljs-string">grep</span> <span class="hljs-string">-v</span> <span class="hljs-string">&quot;pb.go&quot;</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">./artifacts/coverage.out2</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">go</span> <span class="hljs-string">tool</span> <span class="hljs-string">cover</span> <span class="hljs-string">-func=./artifacts/coverage.out2</span><br>  <span class="hljs-comment"># æ•è·å•å…ƒæµ‹è¯•è¦†ç›–ç‡åœ¨ gitlab job ä¸Šæ˜¾ç¤º</span><br>  <span class="hljs-attr">coverage:</span> <span class="hljs-string">&#x27;/total:\s+.*\s+\d+\.\d+%/&#x27;</span><br>  <span class="hljs-attr">artifacts:</span><br>    <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">artifacts/coverage.out</span><br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å•å…ƒæµ‹è¯•çš„ä»‹ç»å°±åˆ°è¿™é‡Œäº†ï¼Œè¿™ç¯‡æ–‡ç« ä»å•å…ƒæµ‹è¯•çš„åŸºæœ¬å†™æ³•ï¼Œå†åˆ°æˆ‘ä»¬åœ¨é¡¹ç›®å½“ä¸­å¦‚ä½•å†™å•å…ƒæµ‹è¯•éƒ½ç®€å•ä»‹ç»äº†ä¸€ä¸‹ï¼Œå¸Œæœ›ä½ çœ‹äº†è¿™ç¯‡æ–‡ç« èƒ½æœ‰æ‰€æ”¶è·ã€‚</p><p>åŒæ—¶æˆ‘ä»¬ Go å·¥ç¨‹åŒ– è¿™ä¸€ç« èŠ‚çš„å†…å®¹ä¹Ÿæ¥è¿‘å°¾å£°äº†ï¼Œæ•´ç†çš„ææ–™ä¹ŸæŒºå¤šçš„ï¼Œä¸‹ä¸€ç¯‡å°±æ˜¯è¿™ä¸€èŠ‚çš„æœ€åä¸€ç¯‡æ–‡ç« ï¼Œè®²ä¸€è®²æˆ‘åœ¨çœŸå®æ”¹é€ ä¸€ä¸ªé¡¹ç›®çš„æ—¶å€™é‡åˆ°çš„ä¸€äº›é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆã€‚</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go è¿›é˜¶è®­ç»ƒè¥-æå®¢æ—¶é—´</a></li><li><a href="https://github.com/stretchr/testify">https://github.com/stretchr/testify</a></li><li><a href="https://github.com/golang/mock">https://github.com/golang/mock</a></li><li><a href="https://pkg.go.dev/github.com/jinzhu/copier">https://pkg.go.dev/github.com/jinzhu/copier</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week04: Go å·¥ç¨‹åŒ–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å·¥ç¨‹åŒ–</tag>
      
      <tag>å•å…ƒæµ‹è¯•</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå·¥ç¨‹åŒ–(ä¸ƒ) Go Module</title>
    <link href="/post/go-training-week4-go-module.html"/>
    <url>/post/go-training-week4-go-module.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p><strong>3 æœˆè¿›åº¦: 04/15</strong> 3 æœˆå¼€å§‹ä¼šå°è¯•çˆ†æ›´æ¨¡å¼ï¼Œäº‰å–åšåˆ°ä¸¤å¤©æ›´æ–°ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœæ„Ÿå…´è¶£å¯ä»¥æ‹‰åˆ°æ–‡ç« æœ€ä¸‹æ–¹è·å–å…³æ³¨æ–¹å¼ã€‚</p><p>æœ¬æ–‡å°†ä¼šåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†ä¼šç®€å•ä»‹ç»ä¸€ä¸‹ go module çš„ä½¿ç”¨ï¼Œç®—æ˜¯ä¸€ä¸ªç®€æ˜æ•™ç¨‹ï¼Œç¬¬äºŒéƒ¨åˆ†ä¼šé‡ç‚¹ä»‹ç»ä¸€ä¸‹ä½¿ç”¨ go module ä½¿ç”¨è¿‡ç¨‹å½“ä¸­ä¼šé‡åˆ°çš„ä¸€äº›å‘çš„è§£å†³åŠæ³•ã€‚</p><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">PS: Go çš„ç‰ˆæœ¬ç®¡ç†ä¸€ç›´æ˜¯ä¸€ä¸ªæ§½ç‚¹ï¼Œè™½ç„¶ go module å·²ç»è§£å†³äº†å¾ˆå¤šé—®é¢˜ï¼Œä½†æ˜¯æ§½ç‚¹è¿˜æ˜¯æ¯”è¾ƒå¤šï¼Œæœ¬æ–‡ä¼šä»‹ç»ä¸€äº›å¸¸è§çš„å‘ï¼Œå¦‚æœé‡åˆ°äº†å…¶ä»–çš„å‘ä¹Ÿä¸è¦æ…Œï¼ŒGoogle å¯ä»¥å¸®åŠ©ä½ </div><h2 id="Go-Module-ç®€æ˜æ•™ç¨‹"><a href="#Go-Module-ç®€æ˜æ•™ç¨‹" class="headerlink" title="Go Module ç®€æ˜æ•™ç¨‹"></a>Go Module ç®€æ˜æ•™ç¨‹</h2><p>ä» go 1.11 çš„åˆæ­¥æ”¯æŒï¼Œåˆ° 1.16 åçš„é»˜è®¤å¼€å¯ï¼Œgo module å·²ç»ç»å†äº† 5 ä¸ªç‰ˆæœ¬ï¼Œå·²ç„¶æˆä¸ºäº†åˆ›å»º go é¡¹ç›®çš„é¦–é€‰åŒ…ç®¡ç†æ–¹å¼ï¼Œè¿™ä¸€è¶´æˆ‘ä»¬å°±å…ˆçœ‹ä¸€ä¸‹ go module çš„åŸºæœ¬ä½¿ç”¨ã€‚</p><h3 id="ä½¿ç”¨-Go-Module"><a href="#ä½¿ç”¨-Go-Module" class="headerlink" title="ä½¿ç”¨ Go Module"></a>ä½¿ç”¨ Go Module</h3><h4 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># go mod init [åŒ…è·¯å¾„]</span><br>go mod init github.com/mohuishou/go-mod-example<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä¸Šè¿°å‘½ä»¤ä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª <code>go.mod</code>  æ–‡ä»¶</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">module github.com/mohuishou/<span class="hljs-keyword">go</span>-mod-example<br><br><span class="hljs-keyword">go</span> <span class="hljs-number">1.16</span><br></code></pre></td></tr></table></figure><h4 id="æ·»åŠ ä¾èµ–"><a href="#æ·»åŠ ä¾èµ–" class="headerlink" title="æ·»åŠ ä¾èµ–"></a>æ·»åŠ ä¾èµ–</h4><p>æ‰§è¡Œ go get åŒ… æ·»åŠ æ·»åŠ å¯¹åº”åº“åˆ° go mod ä¸­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> get github.com/sirupsen/logrus<br></code></pre></td></tr></table></figure><p>è¿™æ—¶å€™ä¼šåœ¨ go mod ä¸­æ·»åŠ å¦‚ä¸‹ä¿¡æ¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">module github.com/mohuishou/<span class="hljs-keyword">go</span>-mod-example<br><br><span class="hljs-keyword">go</span> <span class="hljs-number">1.16</span><br><br>require github.com/sirupsen/logrus v1<span class="hljs-number">.8</span><span class="hljs-number">.0</span> <span class="hljs-comment">// indirect</span><br></code></pre></td></tr></table></figure><ul><li>åœ¨ go get çš„æ—¶å€™å¦‚æœä¸æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬ä¿¡æ¯ï¼Œä¼šè‡ªåŠ¨æ‹‰å–æœ€æ–°çš„ç‰ˆæœ¬çš„åŒ…</li><li>å¦‚æœæƒ³è¦æ‹‰å–æŒ‡å®šç‰ˆæœ¬å¯ä»¥é€šè¿‡ <code>go get github.com/sirupsen/logrus@v1.7.0</code>  çš„æ–¹å¼ï¼Œæ”¯æŒ<ul><li><code>@ç‰ˆæœ¬å·</code> ä¾‹å¦‚ <a href="mailto:`@v1.7.0">`@v1.7.0</a>`</li><li><code>@åˆ†æ”¯å</code>  ä¾‹å¦‚ <code>@master</code></li><li><code>@commit tag</code>  ä¾‹å¦‚ <code>@6cff360233dc4457f1536e4f3df4e4e740fd3410</code></li></ul></li><li><code>// indirect</code>  è¡¨ç¤ºï¼Œæˆ‘ä»¬åœ¨ä»£ç ä¸­æ²¡æœ‰ç›´æ¥åº”ç”¨è¿™ä¸ªåŒ…</li></ul><p>æ‰§è¡Œå®Œ go get å‘½ä»¤ä¹‹åè¿˜ä¼šåœ¨ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª <code>go.sum</code>  æ–‡ä»¶</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">......<br><br>github.com/pmezard/<span class="hljs-keyword">go</span>-difflib v1<span class="hljs-number">.0</span><span class="hljs-number">.0</span> h1:<span class="hljs-number">4</span>DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk/f1lZbAQM=<br>github.com/pmezard/<span class="hljs-keyword">go</span>-difflib v1<span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-keyword">go</span>.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/<span class="hljs-number">4</span>=<br>github.com/sirupsen/logrus v1<span class="hljs-number">.8</span><span class="hljs-number">.0</span> h1:nfhvjKcUMhBMVqbKHJlk5RPrrfYr/NMo3692g0dwfWU=<br>github.com/sirupsen/logrus v1<span class="hljs-number">.8</span><span class="hljs-number">.0</span>/<span class="hljs-keyword">go</span>.mod h1:<span class="hljs-number">4</span>GuYW9TZmE769R5STWrRakJc4UqQ3+QQ95fyz7ENv1A=<br><br>......<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ–‡ä»¶ä¸»è¦åŒ…å«å½“å‰ä¾èµ–çš„æ‰€æœ‰çš„åŒ…ï¼Œåƒ <code>go-difflib</code>  æˆ‘ä»¬æ²¡æœ‰ç›´æ¥ä¾èµ–ï¼Œä½†æ˜¯æˆ‘ä»¬ä¾èµ–çš„ <code>logrus</code>  æœ‰ä¾èµ–å®ƒï¼Œæ‰€ä»¥ä¼šåˆ—åœ¨è¿™é‡Œ</p><p><code>h1:4DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk/f1lZbAQM=</code>  è¿™ä¸€ä¸²æ˜¯ä¸€ä¸ªåŠ å¯†çš„å“ˆå¸Œæ•°æ®ï¼Œç”¨æ¥ä¿è¯è¿™ä¸ªç‰ˆæœ¬ä¸€å®šæ˜¯ä¸€è‡´çš„ï¼Œé¿å…åŒ…çš„å‘å¸ƒè€…åˆ é™¤äº†è¿™ä¸ªç‰ˆæœ¬ä¹‹åï¼Œä¿®æ”¹ä»£ç é‡å¤å‘å¸ƒ</p><p>ç°åœ¨æˆ‘ä»¬åœ¨ä»£ç ä¸­ä½¿ç”¨è¿™ä¸ªåŒ…è¯•è¯•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/sirupsen/logrus&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>logrus.Info(<span class="hljs-string">&quot;hello&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ¸…ç†ä¾èµ–"><a href="#æ¸…ç†ä¾èµ–" class="headerlink" title="æ¸…ç†ä¾èµ–"></a>æ¸…ç†ä¾èµ–</h4><p>éšç€æˆ‘ä»¬å¼€å‘ï¼Œå¯èƒ½ä¼šæœ‰ä¸€äº›åŒ…ï¼Œä¹‹å‰ä¾èµ–ä½†æ˜¯åé¢å°±ä¸å†ä¾èµ–äº†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¦‚æœè¦æ¸…ç†å“ªäº›ä¸å†éœ€è¦çš„ä¾èµ–å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥è¿›è¡Œæ¸…ç†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> mod tidy<br></code></pre></td></tr></table></figure><h3 id="å‘å¸ƒ-Go-Module"><a href="#å‘å¸ƒ-Go-Module" class="headerlink" title="å‘å¸ƒ Go Module"></a>å‘å¸ƒ Go Module</h3><h4 id="Go-ç‰ˆæœ¬å·"><a href="#Go-ç‰ˆæœ¬å·" class="headerlink" title="Go ç‰ˆæœ¬å·"></a>Go ç‰ˆæœ¬å·</h4><p>go é»˜è®¤ä½¿ç”¨è¯­ä¹‰åŒ–çš„ç‰ˆæœ¬æ¥è¡¨ç¤ºç‰ˆæœ¬å·ï¼ŒåŸºæœ¬çš„æ–¹å¼</p><ul><li><code>vMAJOR.MINOR.PATCH</code><ul><li>æœ‰ç ´åæ€§å˜æ›´çš„æ—¶å€™éœ€è¦å¢åŠ ä¸»ç‰ˆæœ¬å·ï¼Œä¹Ÿå°±æ˜¯ <code>MAJOR</code> ï¼Œä¾‹å¦‚ <code>v1.0.0</code> -&gt; <code>v2.0.0</code></li><li>å½“æœ‰æ–°å¢çš„å‡½æ•°æˆ–è€…æ˜¯ API æ—¶ï¼Œæˆ‘ä»¬å¢åŠ  <code>MINOR</code>  ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ <code>v1.1.0</code> -&gt; <code>v1.2.0</code></li><li>å½“æ²¡æœ‰æ–°çš„ feature çš„æ—¶å€™ï¼Œä¾‹å¦‚ bug ä¿®å¤æ—¶ï¼Œæˆ‘ä»¬å¢åŠ  <code>PATCH</code>  ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ <code>v1.1.1</code> -&gt; <code>v1.1.2</code></li></ul></li><li>é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜å¯ä»¥åœ¨ç‰ˆæœ¬å·åé¢ä½¿ç”¨ <code>-</code>  è¡¨ç¤ºä¸€äº›ç‰¹æ®Šçš„é¢„å‘å¸ƒç‰ˆæœ¬ä¾‹å¦‚ alpha beta ç‰ˆæœ¬ç­‰<ul><li><code>v1.1.1-alpha</code></li><li><code>v1.1.1-beta.2</code></li><li>ä¸Šé¢è¿™ç§ç‰¹æ®Šçš„ç‰ˆæœ¬åªä¼šåœ¨æ‰‹åŠ¨æŒ‡å®šçš„ç‰ˆæœ¬å·çš„æ—¶å€™æ‰ä¼šå»è·å–å®ƒï¼Œé»˜è®¤æƒ…å†µæˆ–è€…æ˜¯åœ¨æ›´æ–°ç‰ˆæœ¬çš„æ—¶å€™ä¸ä¼šè·å–è¿™äº›ç‰ˆæœ¬</li></ul></li><li>ä¸ºäº†å…¼å®¹åœ¨ Go Module å‡ºç°ä¹‹å‰çš„ä¸€äº›ç‰ˆæœ¬ï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ°è¿˜æœ‰ä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„ç‰ˆæœ¬å·<ul><li><code>v0.0.0-20170915032832-14c0d48ead0c</code></li><li>å¦‚æœä¾èµ–çš„ä»“åº“ä»æ¥æ²¡æœ‰å‘å¸ƒè¿‡ç‰ˆæœ¬ï¼Œå°±ä¼šä»¥è¿™ç§æ–¹å¼å­˜åœ¨</li></ul></li></ul><h4 id="v1-åŠä¹‹å‰ç‰ˆæœ¬çš„å‘å¸ƒ"><a href="#v1-åŠä¹‹å‰ç‰ˆæœ¬çš„å‘å¸ƒ" class="headerlink" title="v1 åŠä¹‹å‰ç‰ˆæœ¬çš„å‘å¸ƒ"></a>v1 åŠä¹‹å‰ç‰ˆæœ¬çš„å‘å¸ƒ</h4><p>1.0 ä¹‹å‰çš„ç‰ˆæœ¬å‘å¸ƒéå¸¸ç®€å•ï¼Œåªéœ€è¦åšä¸¤ä»¶äº‹æƒ…</p><ul><li>æ·»åŠ ä¸€ä¸ª LICENSE æ–‡ä»¶ï¼ˆéå¿…é¡»ï¼‰</li><li>ä½¿ç”¨ <code>git tag v1.0.0</code>  åŠ ä¸€ä¸ªç‰ˆæœ¬ tag å³å¯</li></ul><h4 id="v2-åŠä¹‹åç‰ˆæœ¬çš„å‘å¸ƒ"><a href="#v2-åŠä¹‹åç‰ˆæœ¬çš„å‘å¸ƒ" class="headerlink" title="v2 åŠä¹‹åç‰ˆæœ¬çš„å‘å¸ƒ"></a>v2 åŠä¹‹åç‰ˆæœ¬çš„å‘å¸ƒ</h4><p>2.0 ä¹‹åçš„ç‰ˆæœ¬å‘å¸ƒå°±éº»çƒ¦ä¸€äº›äº†ï¼Œå› ä¸º Go Module çš„é™åˆ¶ï¼Œv2 ä¹‹åçš„ç‰ˆæœ¬éœ€è¦åœ¨ <code>go.mod</code>  ä¸­æ˜¾ç¤ºçš„æŒ‡å®š <code>/v2</code>  ä¸»ç‰ˆæœ¬å¥½æ ‡è¯†ï¼Œç”¨æˆ·åœ¨ä½¿ç”¨å¯¼å…¥åŒ…çš„æ—¶å€™ä¹Ÿå¿…é¡»åŠ ä¸Šè¿™ä¸ªç‰ˆæœ¬æ ‡å¿—ï¼Œè¿™ä¸ªå¥½å¤„å°±æ˜¯å¯ä»¥åŒæ—¶åŒæ—¶å¯¼å…¥ä¸åŒç‰ˆæœ¬çš„åŒ…ï¼Œä½†æ˜¯åœ¨å‡çº§çš„æ—¶å€™å°±æ¯”è¾ƒè›‹ç–¼äº†ï¼Œå¿…é¡»è¦å°†æ‰€æœ‰æ–‡ä»¶çš„å¯¼å…¥è·¯å¾„éƒ½ä¿®æ”¹ä¸€ä¸‹</p><p>é‚£ä¹ˆè¯¥å¦‚ä½•å‘å¸ƒæ–°ç‰ˆæœ¬çš„åŒ…å‘¢ï¼Ÿå®˜æ–¹æ¨èçš„æ“ä½œæ˜¯</p><ul><li>æˆ‘ä»¬å…ˆåœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª <code>v2</code>  æ–‡ä»¶å¤¹ï¼Œåº”ä¸ºè¿™æ ·å¯ä»¥å…¼å®¹é‚£äº›è¿˜åœ¨ä½¿ç”¨ <code>GOPATH</code>  çš„ç”¨æˆ·ï¼Œå½“ç„¶è¿™ä¸æ˜¯å¿…é¡»çš„</li><li>ç„¶åæˆ‘ä»¬å†ä¿®æ”¹ä¸€ä¸‹ <code>go.mod</code>  æ–‡ä»¶, åœ¨åŒ…åååŠ ä¸Šä¸»ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚<ul><li><code>module github.com/mohuishou/go-mod-example/v2</code></li></ul></li><li>æœ€åæˆ‘ä»¬å†ä½¿ç”¨ <code>git tag v2.0.0</code>  æ‰“ä¸€ä¸ªç‰ˆæœ¬å¹¶å‘å¸ƒå³å¯</li></ul><h2 id="Go-Module-é¿å‘æŒ‡å—"><a href="#Go-Module-é¿å‘æŒ‡å—" class="headerlink" title="Go Module é¿å‘æŒ‡å—"></a>Go Module é¿å‘æŒ‡å—</h2><h3 id="1-æ‹‰å–ä¾èµ–å¾ˆæ…¢ï¼Œæœ‰çš„åŒ…è¿˜æ‹‰å–ä¸åˆ°"><a href="#1-æ‹‰å–ä¾èµ–å¾ˆæ…¢ï¼Œæœ‰çš„åŒ…è¿˜æ‹‰å–ä¸åˆ°" class="headerlink" title="1. æ‹‰å–ä¾èµ–å¾ˆæ…¢ï¼Œæœ‰çš„åŒ…è¿˜æ‹‰å–ä¸åˆ°"></a>1. æ‹‰å–ä¾èµ–å¾ˆæ…¢ï¼Œæœ‰çš„åŒ…è¿˜æ‹‰å–ä¸åˆ°</h3><p>Go é»˜è®¤çš„ GOPROXY é…ç½®æ˜¯ <code>proxy.golang.org</code> , é»˜è®¤å›½å†…æ— æ³•è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®å›½å†…é•œåƒï¼Œæ¨è <code>goproxy.cn</code>  æˆ–è€… <code>goproxy.io</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> env -w GOPROXY=https:<span class="hljs-comment">//goproxy.cn,direct</span><br></code></pre></td></tr></table></figure><p>1.16 ä¹‹å‰ Go Module å¹¶æœªé»˜è®¤å¼€å¯è¿˜éœ€è¦é…ç½®</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> env -w GO111MODULE=on<br></code></pre></td></tr></table></figure><h3 id="2-å…¬å¸ç§æœ‰ä»“åº“åŒ…å¦‚ä½•è·å–"><a href="#2-å…¬å¸ç§æœ‰ä»“åº“åŒ…å¦‚ä½•è·å–" class="headerlink" title="2. å…¬å¸ç§æœ‰ä»“åº“åŒ…å¦‚ä½•è·å–"></a>2. å…¬å¸ç§æœ‰ä»“åº“åŒ…å¦‚ä½•è·å–</h3><p>Go è·å–åŒ…çš„æ—¶å€™é»˜è®¤ä¼šèµ° PROXYï¼Œè¿™ä¸ªåªè¦ä½ ä»¬çš„åº“æ²¡æœ‰å¯¹å…¬ç½‘å‘å¸ƒï¼Œé‚£å°±è·å–ä¸åˆ°ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡è§£å†³</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> env -w GOPRIVATE=gitlab.com/xxx<br></code></pre></td></tr></table></figure><h3 id="3-ä¾èµ–çš„åŒ…è¢«è‡ªåŠ¨å‡çº§"><a href="#3-ä¾èµ–çš„åŒ…è¢«è‡ªåŠ¨å‡çº§" class="headerlink" title="3. ä¾èµ–çš„åŒ…è¢«è‡ªåŠ¨å‡çº§"></a>3. ä¾èµ–çš„åŒ…è¢«è‡ªåŠ¨å‡çº§</h3><p>åœ¨ 1.16 å, go build, go test, go get ç­‰å‘½ä»¤å·²ç»ä¸ä¼šè‡ªåŠ¨å‡çº§æˆ‘ä»¬ä¾èµ–çš„åŒ…äº†ï¼Œä½†æ˜¯åœ¨ 1.16 ä¹‹å‰ï¼Œè¿™ä¸ªæ“ä½œå¾ˆéš¾å—ã€‚</p><p>é¦–å…ˆï¼Œè¿™ä¸ªæ“ä½œéå¸¸çš„åç›´è§‰ï¼Œå…¶æ¬¡è¿˜æœ‰å¯èƒ½ä¼šå¯¼è‡´éé¢„æœŸçš„ bugï¼Œè™½ç„¶åœ¨ Go Module çš„è®¾è®¡å½“ä¸­ï¼Œä¸»ç‰ˆæœ¬ä¸å˜çš„æƒ…å†µä¸‹éƒ½åº”è¯¥ä¿æŒå‘å‰å…¼å®¹ï¼Œä½†æ˜¯å¾ˆå¤šçŸ¥åçš„ç¬¬ä¸‰åº“éƒ½åšä¸åˆ°è¿™ä¸ªï¼ŒåŒ…æ‹¬ Google è‡ªå·±å¼€å‘çš„ grpcï¼Œæˆ‘ä»¬ä¹‹å‰å°±å‡ºç°è¿‡ç”±äº grpc ç‰ˆæœ¬è‡ªåŠ¨å‡çº§å¯¼è‡´çš„ç¨‹åºè¿æ¥é”™è¯¯ï¼Œå¿…é¡»è¦å›é€€ç‰ˆæœ¬æ‰è¡Œã€‚</p><p>ä¸‰ä¸ªè§£å†³åŠæ³•éƒ½å¯ä»¥è§£å†³ï¼š</p><ul><li>å‡çº§ Go ç‰ˆæœ¬åˆ° 1.16</li><li>ä½¿ç”¨ <code>-mod=readonly</code> ï¼Œä¾‹å¦‚ <code>go build -mod=readonly</code></li><li>åœ¨ <code>go.mod</code>  æ–‡ä»¶ä¸­ä½¿ç”¨ <code>replace</code>  æŒ‡ä»¤æŒ‡å®šç‰ˆæœ¬</li></ul><h3 id="4-åŒ…çš„æºä»£ç ä»“åº“åˆ åº“äº†æ€ä¹ˆåŠï¼Ÿ"><a href="#4-åŒ…çš„æºä»£ç ä»“åº“åˆ åº“äº†æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="4. åŒ…çš„æºä»£ç ä»“åº“åˆ åº“äº†æ€ä¹ˆåŠï¼Ÿ"></a>4. åŒ…çš„æºä»£ç ä»“åº“åˆ åº“äº†æ€ä¹ˆåŠï¼Ÿ</h3><p>è¿™ä¸ªå…¶å®åœ¨ Go Module ä¸Šè¿˜å¥½ä¸€äº›ï¼Œå› ä¸º Go Module é»˜è®¤ä½¿ç”¨ Go Proxy åªè¦ä½ ä½¿ç”¨çš„åº“çš„ LICENSE å’Œ GOPROXY æ²¡æœ‰é—®é¢˜ï¼Œä¸€èˆ¬éƒ½ä¼šæœ‰ç¼“å­˜</p><ul><li>å»ºè®®å…¬å¸éœ€è¦æ­å»ºä¸€å¥—è‡ªå·±çš„ GOPROXY</li><li>å»ºè®®ä½¿ç”¨å®˜æ–¹çš„ GOPROXY æˆ–è€…æ˜¯ goproxy.cn</li></ul><h3 id="5-logrus-åŒ…åé—®é¢˜"><a href="#5-logrus-åŒ…åé—®é¢˜" class="headerlink" title="5. logrus åŒ…åé—®é¢˜"></a>5. logrus åŒ…åé—®é¢˜</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span>: downloading github.com/Sirupsen/logrus v1<span class="hljs-number">.4</span><span class="hljs-number">.1</span><br><span class="hljs-keyword">go</span> get: github.com/Sirupsen/logrus@v1<span class="hljs-number">.0</span><span class="hljs-number">.6</span> updating to<br>        github.com/Sirupsen/logrus@v1<span class="hljs-number">.4</span><span class="hljs-number">.1</span>: parsing <span class="hljs-keyword">go</span>.mod:<br>        module declares its path as: github.com/sirupsen/logrus<br>                but was required as: github.com/Sirupsen/logrus<br></code></pre></td></tr></table></figure><p>ç°åœ¨è¿™ä¸ªé”™è¯¯åº”è¯¥æ¯”è¾ƒå°‘äº†ï¼Œä½†æ˜¯æˆ‘ä»¬ç¢°åˆ°è¿‡å¾ˆå¤šæ¬¡äº†ï¼Œä¸»è¦çš„åŸå› å°±æ˜¯ logrus çš„ä½œè€…æ”¹äº† github åå­—ï¼Œä» <code>Sirupsen</code>  -&gt; <code>sirupsen</code>  å°±å¯¼è‡´äº†å¤§é‡ä¾èµ– logrus åº“çš„ç¬¬ä¸‰æ–¹åº“æŠ¥é”™å†²çªï¼Œè¿™ä¸ªçš„è§£å†³æ–¹æ¡ˆä¹Ÿæ˜¯ä½¿ç”¨ replace</p><p>åœ¨ <code>go.mod</code>  çš„æœ€ååŠ ä¸Šè¿™ä¹ˆä¸€å¥å°±å¯ä»¥äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">replace (<br>    github.com/Sirupsen/logrus v1<span class="hljs-number">.4</span><span class="hljs-number">.1</span> =&gt; github.com/sirupsen/logrus v1<span class="hljs-number">.4</span><span class="hljs-number">.1</span><br>)<br></code></pre></td></tr></table></figure><h3 id="6-go-sum-git-merge-å†²çª"><a href="#6-go-sum-git-merge-å†²çª" class="headerlink" title="6. go.sum git merge å†²çª"></a>6. go.sum git merge å†²çª</h3><p>å…¶å®å¾ˆå¤šåŒ…ç®¡ç†éƒ½æœ‰ç±»ä¼¼çš„é—®é¢˜ï¼Œè§£å†³æ–¹æ³•ä¸€èˆ¬æƒ…å†µä¸‹ git merge åˆå¹¶åå†é‡æ–°æ‰§è¡Œ go mod tidy æ¸…ç†ä¸€ä¸‹å³å¯</p><h3 id="7-Go-ç‰ˆæœ¬å‡çº§æ— æ³•ä½¿ç”¨æ–°ç‰¹æ€§"><a href="#7-Go-ç‰ˆæœ¬å‡çº§æ— æ³•ä½¿ç”¨æ–°ç‰¹æ€§" class="headerlink" title="7. Go ç‰ˆæœ¬å‡çº§æ— æ³•ä½¿ç”¨æ–°ç‰¹æ€§"></a>7. Go ç‰ˆæœ¬å‡çº§æ— æ³•ä½¿ç”¨æ–°ç‰¹æ€§</h3><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä» go 1.15 å‡çº§åˆ° 1.16 æƒ³ä½¿ç”¨ embedï¼Œä¹Ÿå°±æ˜¯é™æ€æ–‡ä»¶æ‰“åŒ…çš„ç‰¹æ€§ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°å‡çº§ Go ä¹‹åæ‰§è¡Œè¿˜æ˜¯ä¼šæŠ¥é”™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ go run ./main.go<br><span class="hljs-comment"># command-line-arguments</span><br>./main.go:9:3: go:embed requires go1.16 or later (-lang was <span class="hljs-built_in">set</span> to go1.15; check go.mod)<br></code></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µä¿®æ”¹ä¸€ä¸‹ <code>go.mod</code>  æ–‡ä»¶ä¸­ <code>go 1.15</code>  åˆ° <code>go 1.16</code>  å³å¯</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å…³äº Go Module çš„ä»‹ç»å°±åˆ°è¿™é‡Œäº†ï¼Œè¯´å®è¯ Go çš„åŒ…ç®¡ç†ä¸€ç›´ä»¥æ¥éƒ½æ˜¯ç¤¾åŒºçš„ç—›ç‚¹ï¼Œä» GOPATH åˆ° Go Vendor å†åˆ° <code>dep</code> ã€ <code>glide</code>  ç­‰ç¤¾åŒºå·¥å…·å†åˆ°ç°åœ¨çš„ go mod æ•´ä½“æ¥è¯´è¿˜æ˜¯å˜å¾—è¶Šæ¥è¶Šå¥½ï¼Œç‰¹åˆ«æ˜¯æœ€æ–°çš„ go 1.16 ç‰ˆæœ¬ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–é—®é¢˜çš„è¯è¿˜æ˜¯å»ºè®®å‡çº§çš„ï¼Œä»…é»˜è®¤ <code>readonly</code>  æ¨¡å¼è¿™ä¸€é¡¹å°±å¯ä»¥å°‘å¾ˆå¤šäº‹æƒ…</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go è¿›é˜¶è®­ç»ƒè¥-æå®¢æ—¶é—´</a></li><li><a href="https://blog.golang.org/modules2019">https://blog.golang.org/modules2019</a></li><li><a href="https://blog.golang.org/using-go-modules">https://blog.golang.org/using-go-modules</a></li><li><a href="https://blog.golang.org/migrating-to-go-modules">https://blog.golang.org/migrating-to-go-modules</a></li><li><a href="https://blog.golang.org/module-mirror-launch">https://blog.golang.org/module-mirror-launch</a></li><li><a href="https://blog.golang.org/publishing-go-modules">https://blog.golang.org/publishing-go-modules</a></li><li><a href="https://blog.golang.org/v2-go-modules">https://blog.golang.org/v2-go-modules</a></li><li><a href="https://blog.golang.org/module-compatibility">https://blog.golang.org/module-compatibility</a></li><li><a href="https://mp.weixin.qq.com/s/CBiebXjBcik2pHQnbnB51A">Go mod ä¸ƒå®—ç½ª</a></li><li><a href="https://jaycechant.info/2019/golang-1-13-from-dep-to-mod/">golang 1.13 - ä¾èµ–ç®¡ç†ä» dep åˆ° mod è¸©å‘ | å­˜æ¡£ Save&amp;Load</a></li><li><a href="https://sulin.me/2019/1Z78YAK.html">Go å¡«å‘ä¹‹å°† Private ä»“åº“ç”¨ä½œ module ä¾èµ– | å°æœ¨å±‹</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week04: Go å·¥ç¨‹åŒ–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å·¥ç¨‹åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå·¥ç¨‹åŒ–(å…­) é…ç½®ç®¡ç†</title>
    <link href="/post/go-training-week4-config.html"/>
    <url>/post/go-training-week4-config.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p><strong>3 æœˆè¿›åº¦: 03/15</strong> 3 æœˆå¼€å§‹ä¼šå°è¯•çˆ†æ›´æ¨¡å¼ï¼Œäº‰å–åšåˆ°ä¸¤å¤©æ›´æ–°ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœæ„Ÿå…´è¶£å¯ä»¥æ‹‰åˆ°æ–‡ç« æœ€ä¸‹æ–¹è·å–å…³æ³¨æ–¹å¼ã€‚</p><p>åº”ç”¨çš„é…ç½®å¤§æ¦‚å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§</p><ul><li>ç¯å¢ƒé…ç½®<ul><li>ç¯å¢ƒé…ç½®ï¼Œåº”è¯¥æ˜¯åº”ç”¨éƒ¨ç½²æ—¶å°±å·²ç»ç¡®å®šå¥½çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ä¸åº”è¯¥å†™åœ¨æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶æˆ–è€…æ˜¯æ”¾åˆ°é…ç½®ä¸­å¿ƒï¼Œè€Œæ˜¯åº”è¯¥ç”±æˆ‘ä»¬çš„éƒ¨ç½²å¹³å°ï¼Œä¾‹å¦‚ K8s ç›´æ¥åœ¨å®¹å™¨å¯åŠ¨æ—¶å€™å°±æ³¨å…¥å¥½</li><li>region: åŒºåŸŸä¿¡æ¯</li><li>env: ç¯å¢ƒä¿¡æ¯ï¼Œä¾‹å¦‚ prod, test</li><li>zone: å¯ç”¨åŒº</li><li>host: æœºå™¨å</li><li>appid: åº”ç”¨ id</li><li>color: æµé‡æŸ“è‰²ä¿¡æ¯ï¼Œç”¨æ¥åšæµé‡åˆ†å‘çš„</li></ul></li><li>é™æ€é…ç½®<ul><li>èµ„æºéœ€è¦åˆå§‹åŒ–çš„é…ç½®ä¿¡æ¯ï¼Œæ¯”å¦‚ http/gRPC serverã€redisã€mysql ç­‰</li><li>è¿™ç±»èµ„æºåœ¨çº¿å˜æ›´é…ç½®çš„é£é™©éå¸¸å¤§ï¼Œå°½é‡ä¸è¦åœ¨çº¿åŠ¨æ€å˜æ›´ï¼Œå¾ˆå¯èƒ½ä¼šå¯¼è‡´ä¸šåŠ¡å‡ºç°ä¸å¯é¢„æœŸçš„äº‹æ•…</li><li>å˜æ›´é™æ€é…ç½®å’Œå‘å¸ƒ bianry app æ²¡æœ‰åŒºåˆ«ï¼Œåº”è¯¥èµ°ä¸€æ¬¡è¿­ä»£å‘å¸ƒçš„æµç¨‹ã€‚</li></ul></li><li>åŠ¨æ€é…ç½®<ul><li>åº”ç”¨ç¨‹åºå¯èƒ½éœ€è¦ä¸€äº›åœ¨çº¿çš„å¼€å…³ï¼Œæ¥æ§åˆ¶ä¸šåŠ¡çš„ä¸€äº›ç®€å•ç­–ç•¥ï¼Œä¼šé¢‘ç¹çš„è°ƒæ•´å’Œä½¿ç”¨ï¼Œæˆ‘ä»¬æŠŠè¿™ç±»æ˜¯åŸºç¡€ç±»å‹(int, bool)ç­‰é…ç½®ï¼Œç”¨äºå¯ä»¥åŠ¨æ€å˜æ›´ä¸šåŠ¡æµçš„æ”¶å½’ä¸€èµ·ï¼Œ</li><li>ä¸è¿‡ä¸šåŠ¡é…ç½®æœ€å¥½åšåˆ°ç®¡ç†åå°ï¼Œå› ä¸ºé…ç½®ä¸­å¿ƒè¿è¥åŒå­¦ä¸€èˆ¬æ²¡æœ‰æƒé™ï¼Œå¹¶ä¸”å¾ˆå¤šé…ç½®ä¸­å¿ƒçš„æ ¡éªŒåšçš„ä¸å¤Ÿå¥½ï¼Œä¸ç†Ÿæ‚‰çš„äººè¿›è¡Œå˜æ›´å¾ˆå®¹æ˜“å‡ºé—®é¢˜</li></ul></li><li>å…¨å±€é…ç½®<ul><li>æˆ‘ä»¬ä¾èµ–çš„å„ç±»ç»„ä»¶ã€ä¸­é—´ä»¶éƒ½æœ‰å¤§é‡çš„é»˜è®¤é…ç½®æˆ–è€…æŒ‡å®šé…ç½®ï¼Œåœ¨å„ä¸ªé¡¹ç›®é‡Œå¤§é‡æ‹·è´å¤åˆ¶ï¼Œå®¹æ˜“å‡ºç°æ„å¤–ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨å…¨å±€é…ç½®æ¨¡æ¿æ¥å®šåˆ¶åŒ–å¸¸ç”¨çš„ç»„ä»¶ï¼Œç„¶åå†ç‰¹åŒ–çš„åº”ç”¨é‡Œè¿›è¡Œå±€éƒ¨æ›¿æ¢ã€‚</li></ul></li></ul><h2 id="å‡½æ•°å‚æ•°é…ç½®"><a href="#å‡½æ•°å‚æ•°é…ç½®" class="headerlink" title="å‡½æ•°å‚æ•°é…ç½®"></a>å‡½æ•°å‚æ•°é…ç½®</h2><p>ä¸‹é¢è¿™ä¸ªæ˜¯ redis åˆå§‹åŒ–çš„ä¾‹å­ï¼Œä¸€èˆ¬åœ¨æˆ‘ä»¬åˆšåˆšå¼€å§‹å†™ä»£ç çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½ä¼šå‘ä¸‹é¢è¿™ä¹ˆå†™ï¼ŒæŠŠéœ€è¦çš„å‚æ•°æ”¾åˆ°å‡½æ•°çš„å…¥å‚å°±è¡Œäº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Dial</span><span class="hljs-params">(network, address <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(Conn, error)</span></span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå¦‚æœè¿™ä¸ªå‡½æ•°åªæ˜¯ä½ è‡ªå·±ç”¨ä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ¯›ç—…ï¼Œä½†æ˜¯å¦‚æœæ˜¯ä¸€ä¸ªå…¬å…±çš„åº“æˆ–è€…æ˜¯ä¸­é—´ä»¶å°±ä¼šå‘ç°ï¼Œç”¨æˆ·çš„è¯‰æ±‚æ˜¯å¤šç§å¤šæ ·ï¼Œçµæ´»å¤šå˜çš„ã€‚å°±ä¼šå¬è§</p><ul><li>æˆ‘è¦è‡ªå®šä¹‰è¶…æ—¶æ—¶é—´</li><li>æˆ‘è¦è‡ªå®šä¹‰ database</li></ul><p>ç­‰ç­‰ä¸€ç³»åˆ—çš„éœ€æ±‚å’Œå„ç§å„æ ·çš„å£°éŸ³ã€‚<br>è¿™æ—¶å€™ä¸ºäº†æ»¡è¶³å¤§å®¶çš„éœ€æ±‚ï¼Œæœ€ç®€å•ï¼Œæœ€ç›´æ¥çš„åšæ³•å°±æ˜¯ï¼Œä¸ºä¸åŒçš„éœ€æ±‚æ·»åŠ ä¸åŒçš„åˆå§‹åŒ–å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DialTimeout</span><span class="hljs-params">(network, address <span class="hljs-keyword">string</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">                 connectTimeout, readTimeout, writeTimeout time.Duration)</span> <span class="hljs-params">(Conn, error)</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DialDatabase</span><span class="hljs-params">(network, address <span class="hljs-keyword">string</span>, database <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(Conn, error)</span></span><br></code></pre></td></tr></table></figure><p>ä½†è¿™æ ·æ¯•ç«Ÿä¸æ˜¯ä¸€ä¸ªåŠæ³•ï¼Œå› ä¸ºç”¨æˆ·çš„éœ€æ±‚æ˜¯æ»¡è¶³ä¸å®Œçš„ï¼Œä½œä¸ºå…¬å…±åº“ï¼Œä¸å¯èƒ½ä¸ºæ¯ä¸ªç”¨æˆ·çš„éœ€æ±‚éƒ½å•ç‹¬æ¥æä¸ªå‡½æ•°ç­¾åï¼Œé‚£è¿™æ ·å‡½æ•°ç­¾åä¹Ÿå¤ªå¤šäº†ã€‚è€Œä¸”è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯å‚æ•°åˆ—è¡¨ä¼šå¾ˆé•¿ï¼Œä¾‹å¦‚ä¸Šé¢çš„ <code>DialTimeout</code> , å¯è¯»æ€§ä¹Ÿä¸å¥½ã€‚<br>å½“ç„¶è¿™ä¹Ÿå’Œ Go çš„å‡½æ•°ä¸èƒ½é‡è½½æœ‰å…³ç³»ï¼Œå¦‚æœå¯ä»¥é‡è½½çš„è¯ï¼Œæ¯ç§éœ€æ±‚æ¥ä¸€ä¸ªå¯èƒ½ä¹Ÿè¿˜è¡Œï¼Œä½†æ˜¯å…¶å®ä¹Ÿä¸å¤Ÿä¼˜é›…ã€‚</p><p>è¿™æ—¶å€™æˆ‘ä»¬æ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„åŠæ³•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ—¢ç„¶å‚æ•°æ¯”è¾ƒé•¿ï¼Œé…ç½®å˜åŒ–åˆæƒ³è¦çµæ´»ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç›´æ¥ä¼ å…¥ä¸€ä¸ªå¯¹è±¡å°±å¥½äº†ï¼Œè®©æ¯ä¸ªç”¨æˆ·è‡ªå·±æ„é€ å»ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;<br>  *pool.Config<br>  Addr <span class="hljs-keyword">string</span><br>  Auth <span class="hljs-keyword">string</span><br>  DialTimeout time.Duration<br>  ReadTimeout time.Duration<br>  WriteTimeout time.Duration<br>&#125;<br><br><span class="hljs-comment">// NewConn new a redis conn.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConn</span><span class="hljs-params">(c *Config)</span> <span class="hljs-params">(cn Conn, err error)</span></span><br></code></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p><ul><li>å¯ä»¥çœ‹åˆ° <code>NewConn</code>  ä¼ é€’çš„æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œé‚£ä¹ˆè¿™ä¸ªåªèƒ½å°±èƒ½å¤Ÿè¢«å¤–é¢ä¿®æ”¹ï¼Œåªè¦å¤–é¢ä¿®æ”¹é‚£å°±éº»çƒ¦äº†ï¼Œå› ä¸ºä¸çŸ¥é“ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œè¿™æ˜¯ä¸€ä¸ªæœªå®šä¹‰çš„è¡Œä¸ºã€‚</li><li>è¿˜æœ‰å°±æ˜¯æˆ‘ä»¬æ²¡æœ‰åŠæ³•æŒ‡å®šå¿…å¡«å‚æ•°ï¼Œè¿™æ ·ä¼ é€’ç›¸å½“äºæ¯ä¸€é¡¹éƒ½æ˜¯å¯é€‰çš„</li></ul><p>æ—¢ç„¶æŒ‡é’ˆå¯èƒ½ä¼šå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºï¼Œé‚£æˆ‘ä»¬å°±æ¢ä¸ªæ–¹å¼, ä¸ä¼ æŒ‡é’ˆä¼ ç»“æ„ä½“ä¸å°±è¡Œäº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConn</span><span class="hljs-params">(c Config)</span> <span class="hljs-params">(cn Conn, err error)</span></span><br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™åˆå¸¦æ¥äº†ä¸€äº›æ–°çš„é—®é¢˜</p><ul><li>é¦–å…ˆï¼Œå¿…å¡«å‚æ•°çš„é—®é¢˜è¿˜æ˜¯æ²¡æœ‰è§£å†³çš„</li><li>å…¶æ¬¡ï¼Œè¿™ä¹ˆä¼ å‚æˆ‘ä»¬æ˜¯æ²¡æœ‰åŠæ³•åŒºåˆ†é»˜è®¤å€¼çš„ï¼Œé€šè¿‡æŒ‡é’ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ¤æ–­æ˜¯å¦ç­‰äº nil æ¥åŒºåˆ†ï¼Œå› ä¸ºå¤§éƒ¨åˆ†çš„åœºæ™¯ä¸‹å…¶å®ç”¨é»˜è®¤å€¼å°±å¯ä»¥äº†ï¼Œè¿™æ ·åšåè€Œé™ä½äº†ä½¿ç”¨ä½“éªŒ</li></ul><p>æ‰€ä»¥ï¼Œæœ‰ä¸€æ®µæ—¶é—´æ¯›è€å¸ˆä»–ä»¬éƒ½æ˜¯ä½¿ç”¨ä¸Šé¢ä¼ æŒ‡é’ˆçš„è¿™ç§æ–¹å¼ï¼Œå½“ç„¶è¿™ç§æ–¹å¼æˆ‘ä»¬ä¹Ÿç”¨è¿‡ï¼Œè™½ç„¶å¯ä»¥ç”¨ï¼Œä½†æ˜¯å°±æ˜¯æœ‰ç‚¹ä¸çˆ½</p><blockquote><p>â€œI believe that we, as Go programmers, should work hard to ensure that nil is never a parameter that needs to be passed to any public function.â€ â€“ Dave Cheney</p></blockquote><p>dava å¤§ç¥ä¹Ÿæåˆ°è¿‡ï¼Œæˆ‘ä»¬åº”è¯¥å°† nil ä½œä¸ºä¸€ä¸ªå‡½æ•°çš„å‚æ•°å€¼è¿›è¡Œä¼ é€’ï¼Œé‚£æˆ‘ä»¬è¯¥å¦‚ä½•ä¿®æ”¹å‘¢ï¼Ÿ<br>å¦‚æœå»çœ‹ä¸€äº›çŸ¥åçš„å¼€æºåº“æˆ–è€…æ˜¯æ ‡å‡†åº“çš„ä¸€äº›åˆå§‹åŒ–ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ç§å§¿åŠ¿</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> DialOption <span class="hljs-keyword">struct</span> &#123;<br>  f <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*dialOptions)</span></span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Dial</span><span class="hljs-params">(network, address <span class="hljs-keyword">string</span>, options ...DialOption)</span> <span class="hljs-params">(Conn, error)</span></span> &#123;<br>  do := dialOptions&#123;<br>    dial: net.Dial,<br>  &#125;<br>  <span class="hljs-keyword">for</span> _, option := <span class="hljs-keyword">range</span> options &#123;<br>    option.f(&amp;do)<br>  &#125; <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-comment">// DialReadTimeout specifies the timeout for reading a single command reply.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DialReadTimeout</span><span class="hljs-params">(d time.Duration)</span> <span class="hljs-title">DialOption</span></span> &#123;<br><span class="hljs-keyword">return</span> DialOption&#123;<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(do *dialOptions)</span></span> &#123;<br>do.readTimeout = d<br>&#125;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§æ“ä½œçš„æ ¸å¿ƒåœ¨äºï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæœªå¯¼å‡ºçš„ option struct ç”¨äºå­˜æ”¾é…ç½®ï¼Œç„¶ååˆ°å¤„ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œç„¶åæˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä½¿ç”¨å¯å˜å‚æ•°è¿›è¡Œä¼ é€’ï¼Œç„¶åå†åˆå§‹åŒ–å‡½æ•°å†…éƒ¨é€šè¿‡ for å¾ªç¯è°ƒç”¨ä¿®æ”¹ç›¸å…³çš„é…ç½®ã€‚</p><ul><li>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æŠŠå¿…å¡«å‚æ•°æ”¾åœ¨å‰é¢å‡ ä½ï¼Œä¿è¯å‚æ•°å¿…å¡«ï¼Œä¸€çœ¼å°±èƒ½çœ‹å‡ºæ¥ï¼Œå‡å°‘æ²Ÿé€šæˆæœ¬</li><li>ç„¶åé»˜è®¤å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å‡½æ•°å†…éƒ¨å…ˆåˆå§‹åŒ–ä¸€ä¸ª defaultOption ç„¶åç”¨åé¢é…ç½®çš„å‡½æ•°è¿›è¡Œä¿®æ”¹å³å¯</li></ul><p>æˆ‘ä»¬å¯ä»¥åœ¨åŒ…é‡Œé¢ç›´æ¥å®šä¹‰ä¸€äº›å‡½æ•°ä¾‹å¦‚ä¸Šé¢çš„ <code>DialReadTimeout</code>  æ¥è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œç„¶åè¿›è¡Œé…ç½®ä¿®æ”¹</p><p>ä½†æ˜¯è¿™æ ·å°±å¯ä»¥äº†ä¹ˆï¼Ÿè¿™ç§ä½¿ç”¨æ–¹å¼</p><ul><li>é¦–å…ˆï¼Œå‡½æ•°æŒ‡é’ˆæ²¡æœ‰å¿…è¦æé‚£ä¹ˆéº»çƒ¦ï¼Œå…¶å®ç›´æ¥é¡¶ä¸€ä¸ªå‡½æ•°ç±»å‹å°±å¯ä»¥äº† <code>type DialOption func(*dialOptions)</code></li><li>å…¶æ¬¡ï¼Œè¿™ç§åšæ³•è¿˜æ˜¯åªèƒ½åœ¨åŒ…å†…éƒ¨è¿›è¡Œå®šä¹‰ï¼Œç”¨æˆ·æ˜¯æ²¡æœ‰åŠæ³•è‡ªå®šä¹‰ä¸€äº›é…ç½®çš„ï¼Œä½†æ˜¯å…¶å®ä¹Ÿå¤Ÿç”¨äº†</li></ul><p>å¦‚æœæƒ³è¦ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰ä¸€äº›é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹ grpc çš„é…ç½®å®šä¹‰ï¼Œä¸»è¦çš„æ€è·¯å°±æ˜¯æŠŠ option ä»å‡½æ•°ä¿®æ”¹æ¥å£ï¼Œç„¶åå®šä¹‰äº†ä¸€ä¸ª <code>EmptyCallOption</code>  å®ç°è¿™ä¸ªæ¥å£ï¼Œå› ä¸ºè¿™ä¸ªæ¥å£åŒ…å«çš„å‡½æ•°æ˜¯æœªå¯¼å‡ºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦åœ¨éœ€è¦åšé…ç½®çš„ struct å½“ä¸­åŒ…å«è¿™ä¸ª <code>EmptyCallOption</code>  å°±å¯ä»¥äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> GreeterClient <span class="hljs-keyword">interface</span> &#123;<br>  SayHello(ctx context.Context, in *HelloRequest, opts ...grpc.CallOption)     (*HelloReply, error)<br>&#125;<br><br><span class="hljs-keyword">type</span> CallOption <span class="hljs-keyword">interface</span> &#123;<br>  before(*callInfo) error<br>  after(*callInfo)<br>&#125;<br><span class="hljs-comment">// EmptyCallOption does not alter the Call configuration.</span><br><span class="hljs-keyword">type</span> EmptyCallOption <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// TimeoutCallOption timeout option.</span><br><span class="hljs-keyword">type</span> TimeoutCallOption <span class="hljs-keyword">struct</span> &#123;<br>  grpc.EmptyCallOption<br>  Timeout time.Duration<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h2><p>åˆ°è¿™é‡Œå‡½æ•°çš„é…ç½®å°±è§£å†³äº†ï¼Œä½†æ˜¯æˆ‘ä»¬æ€ä¹ˆå’Œé…ç½®æ–‡ä»¶è¿›è¡Œç»“åˆå‘¢ï¼Ÿç°åœ¨çš„è¿™ç§åšæ³•éšè—äº†ç»“æ„ï¼Œæ²¡æœ‰åŠæ³•ç›´æ¥ä½¿ç”¨ <code>json.Unmarshal</code> è¿™ç§æ–¹æ³•ç›´æ¥ååºåˆ—åŒ–å›æ¥ã€‚</p><p>æ¯”è¾ƒå¸¸è§çš„åŠæ³•å°±æ˜¯æˆ‘ä»¬è®¾å®šä¸¤ä¸ªå‡½æ•°å¦‚æœéœ€è¦é…ç½®æ–‡ä»¶ååºåˆ—åŒ–çš„å°±ç”¨ä¸å¸¦ Option çš„ï¼Œåä¹‹ç”¨å¸¦ Option çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Dial</span><span class="hljs-params">(network, address <span class="hljs-keyword">string</span>, options ...DialOption)</span> <span class="hljs-params">(Conn, error)</span></span><br><br><span class="hljs-comment">// NewConn new a redis conn.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewConn</span><span class="hljs-params">(c *Config)</span> <span class="hljs-params">(cn Conn, err error)</span></span><br></code></pre></td></tr></table></figure><p>è¿™ä¹ˆåšæ¯”è¾ƒå¤§çš„é—®é¢˜å°±æ˜¯ï¼ŒæŠŠ config ç»™æš´éœ²äº†å‡ºæ¥ï¼Œå¹¶ä¸”æœ‰ä¸¤ç§åˆå§‹åŒ–æ–¹å¼ï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶å°±æ²¡æœ‰åŠæ³•å¾—åˆ°ä½¿ç”¨ Option çš„å¥½å¤„äº†</p><p>è¯¾ä¸Šæä¾›äº†ä¸€ç§è§£å†³æ€è·¯å°±æ˜¯æŠŠè¿™ä¸¤æ­¥è¿›è¡Œåˆ†ç¦»ï¼Œé¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ protobuf æ–‡ä»¶å®šä¹‰å¥½é…ç½®çš„ç»“æ„ï¼Œè¿™æ ·å¯ä»¥åŠ ä¸Šä¸€äº›éªŒè¯æ¡ä»¶</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs protobuf">syntax = <span class="hljs-string">&quot;proto3&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;google/protobuf/duration.proto&quot;</span>;<br><span class="hljs-keyword">package</span> config.redis.v1;<br><span class="hljs-comment">// redis config.</span><br><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">redis</span> </span>&#123;<br>  <span class="hljs-built_in">string</span> network = <span class="hljs-number">1</span>;<br>  <span class="hljs-built_in">string</span> address = <span class="hljs-number">2</span>;<br>  <span class="hljs-built_in">int32</span> database = <span class="hljs-number">3</span>;<br>  <span class="hljs-built_in">string</span> password = <span class="hljs-number">4</span>;<br>  google.protobuf.Duration read_timeout = <span class="hljs-number">5</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®šä¹‰å¥½ä¹‹åä½¿ç”¨ yaml æ¥ä¿®æ”¹é…ç½®ï¼Œç„¶åä½¿ç”¨ <code>Options</code>  æ–¹æ³•ï¼Œå°† protobuf ç”Ÿæˆçš„ <code>Config</code>  æ›¿æ¢ä¸º redis.Options</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ApplyYAML</span><span class="hljs-params">(s *redis.Config, yml <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;<br>  js, err := yaml.YAMLToJSON([]<span class="hljs-keyword">byte</span>(yml))<br>  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-keyword">return</span> err<br>  &#125;<br>  <span class="hljs-keyword">return</span> ApplyJSON(s, <span class="hljs-keyword">string</span>(js))<br>&#125;<br><span class="hljs-comment">// Options apply config to options.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Options</span><span class="hljs-params">(c *redis.Config)</span> []<span class="hljs-title">redis</span>.<span class="hljs-title">Options</span></span> &#123;<br>  <span class="hljs-keyword">return</span> []redis.Options&#123;<br>    redis.DialDatabase(c.Database),<br>    redis.DialPassword(c.Password),<br>    redis.DialReadTimeout(c.ReadTimeout),<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼é™¤äº†å®šä¹‰èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œä½¿ç”¨ä¸Šè¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œä½¿ç”¨åªéœ€è¦åƒä¸‹é¢è¿™æ ·å°±å¯ä»¥äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-comment">// load config file from yaml.</span><br>  c := <span class="hljs-built_in">new</span>(redis.Config)<br>  _ = ApplyYAML(c, loadConfig())<br>  r, _ := redis.Dial(c.Network, c.Address, Options(c)...)<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬ç°åœ¨ä½¿ç”¨çš„æ²¡æœ‰é‚£ä¹ˆå¤æ‚ï¼Œç»Ÿä¸€æ¥å…¥äº†é…ç½®ä¸­å¿ƒï¼Œæ‰€ä»¥æˆ‘ç°åœ¨çš„åšæ³•æ˜¯å®šä¹‰ä¸€ä¸ª <code>WithConfigCenter</code>  çš„æ–¹æ³•å°±è¡Œäº†ï¼Œè°ƒç”¨çš„æ—¶å€™å…¶å®è¿˜è¦ç®€å•ä¸€ç‚¹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithConfigCenter</span><span class="hljs-params">(config ConfigCenter, key <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">Option</span></span><br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¿®æ”¹é…ç½®å…¶å®æ˜¯ä¸€ä»¶æ¯”è¾ƒå±é™©çš„äº‹æƒ…ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬ç¼ºä¹è¶³å¤Ÿçš„æ•¬ç•ï¼Œå› ä¸ºç°åœ¨åœ¨çº¿çš„é…ç½®ä¸­å¿ƒè¶Šæ¥æ–¹ä¾¿ï¼Œæ‰€ä»¥ä¿®æ”¹çš„æˆæœ¬è¶Šæ¥è¶Šä½ï¼Œå¤§å®¶å°±è¶Šæ¥è¶Šéšæ„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹é…ç½®çš„ä¿®æ”¹æ…é‡ä¸€äº›ã€‚é…ç½®çš„ç›®æ ‡ï¼š</p><ul><li>é¿å…å¤æ‚</li><li>å¤šæ ·çš„é…ç½®</li><li>ç®€å•åŒ–åŠªåŠ›</li><li>ä»¥åŸºç¡€è®¾æ–½ -&gt; é¢å‘ç”¨æˆ·è¿›è¡Œè½¬å˜</li><li>é…ç½®çš„å¿…é€‰é¡¹å’Œå¯é€‰é¡¹</li><li>é…ç½®çš„é˜²å¾¡ç¼–ç¨‹</li><li>æƒé™å’Œå˜æ›´è·Ÿè¸ª</li><li>é…ç½®çš„ç‰ˆæœ¬å’Œåº”ç”¨å¯¹é½ï¼Œè¿™ä¸ªå¾ˆå¤šéƒ½æ²¡åšåˆ°ï¼Œç»å¸¸åº”ç”¨å›æ»šäº†é…ç½®æ²¡å›æ»šï¼Œå°±å‡ºäº‹æ•…äº†</li><li>å®‰å…¨çš„é…ç½®å˜æ›´ï¼šé€æ­¥éƒ¨ç½²ã€å›æ»šæ›´æ”¹ã€è‡ªåŠ¨å›æ»š</li></ul><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go è¿›é˜¶è®­ç»ƒè¥-æå®¢æ—¶é—´</a></li><li><a href="https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html">command center: Self-referential functions and the design of options</a></li><li><a href="https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis">Functional options for friendly APIs â€“ The acme of foolishness</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week04: Go å·¥ç¨‹åŒ–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å·¥ç¨‹åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå·¥ç¨‹åŒ–(äº”) API è®¾è®¡ä¸‹: åŸºäº protobuf è‡ªåŠ¨ç”Ÿæˆ gin ä»£ç </title>
    <link href="/post/go-training-week4-protoc-gen-go-gin.html"/>
    <url>/post/go-training-week4-protoc-gen-go-gin.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p><strong>3 æœˆè¿›åº¦: 02/15</strong> 3 æœˆå¼€å§‹ä¼šå°è¯•çˆ†æ›´æ¨¡å¼ï¼Œäº‰å–åšåˆ°ä¸¤å¤©æ›´æ–°ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœæ„Ÿå…´è¶£å¯ä»¥æ‹‰åˆ°æ–‡ç« æœ€ä¸‹æ–¹è·å–å…³æ³¨æ–¹å¼ã€‚</p><p>åœ¨å®˜æ–¹çš„æä¾›çš„ protobuf ä»£ç ç”Ÿæˆå™¨å½“ä¸­ä»…æ”¯æŒç”Ÿæˆ grpc çš„ä»£ç ï¼Œä½†æ˜¯æˆ‘ä»¬å›¢é˜Ÿç°çŠ¶æ˜¯å¤§éƒ¨åˆ†çš„é¡¹ç›®éƒ½æ˜¯ä½¿ç”¨ http1 ç±»ä¼¼ restful çš„æ–¹å¼è¿›è¡Œé€šä¿¡çš„ï¼Œç›®å‰å…¬å¸å†…éƒ¨ gRPC ç›¸å…³åŸºç¡€è®¾æ–½å»ºè®¾çš„è¿˜ä¸å®Œå…¨ï¼Œä¾‹å¦‚è·¨åŒºåŸŸè·¯ç”±ï¼ŒæœåŠ¡æ³¨å†Œç­‰ç­‰åŸå› å¯¼è‡´æˆ‘ä»¬æ²¡æœ‰åŠæ³•å‘ gRPC è¿›è¡Œè¿ç§»ï¼Œä½†æ˜¯æˆ‘ä»¬åˆæƒ³è¦æœ‰å‰é¢æåˆ°çš„å„ç§å¥½å¤„ï¼Œè€ƒè™‘åˆ°åé¢è¿˜æ˜¯ä¼šè¿›è¡Œ RPC çš„è¿ç§»ï¼Œåˆä¸æƒ³åœ¨ä»£ç é‡Œé¢å†™ä¸¤å¥—ç›¸åŒé€»è¾‘ service å±‚ä»£ç é‚£è¯¥æ€ä¹ˆåŠï¼Ÿ</p><p>æ¯›è€å¸ˆåœ¨è¯¾ç¨‹ä¸Šä»‹ç»äº† kratos v2 çš„æ–¹æ³•ï¼Œè‡ªå·±å†™ä¸€ä¸ª protoc æ’ä»¶ï¼Œåœ¨ä»£ç ç”Ÿæˆçš„æ—¶å€™ç”Ÿæˆç›¸å…³ä»£ç ï¼Œåªè¦æˆ‘ä»¬ç”Ÿæˆçš„ server æ¥å£å’Œ gRPC ä¿æŒä¸€è‡´ï¼Œæˆ–è€…æ¥å…¥å…¶ä»–çš„ RPC æœåŠ¡ï¼Œåªéœ€è¦æ¥å£ä¿æŒä¸€è‡´é‚£ä¹ˆæˆ‘ä»¬çš„ service å±‚ä»£ç æ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç ï¼Œå°±å¯ä»¥æ”¯æŒå¤šç§åè®®ï¼Œåšåˆ°äº†â€œæ¡†æ¶åªæ˜¯ç»†èŠ‚â€ã€‚</p><p>è™½ç„¶æ¡†æ¶åªæ˜¯ç»†èŠ‚ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹‹å‰ä¸€ç›´ä½¿ç”¨çš„ gin ä½œä¸º web æ¡†æ¶ï¼Œkratos ä½¿ç”¨çš„æ˜¯ mux ä½œä¸ºè·¯ç”±æ¡†æ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¦‚æœç›´æ¥ä½¿ç”¨ kratos çš„æ’ä»¶ä¼šå¯¼è‡´å¾ˆå¤šä¸­é—´ä»¶éƒ½éœ€è¦åšé‡æ„ï¼Œè¿™æ ·å½±å“æ¯”è¾ƒå¤§ï¼Œå¹¶ä¸”ä¹Ÿç®—æ˜¯ä¸ºäº†ç§¯ç´¯ä¸€äº›ç»éªŒï¼Œå› ä¸ºé™¤äº†ç”Ÿæˆ server çš„ä»£ç ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åŒæ—¶é…åˆå…¬å¸å†…éƒ¨çš„ç½‘å…³ç”Ÿæˆ client ç«¯çš„ä»£ç ï¼Œè§£å†³ä¹‹å‰æ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦è‡ªå·±æ‰‹å†™ sdk çš„é—®é¢˜ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¸€èµ·æ¥ä»å€Ÿé‰´å¼€å§‹å®ç°ä¸€ä¸ªç”Ÿæˆ gin çš„ http server ä»£ç ã€‚</p><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">æ³¨: æœ¬æ–‡ä»£ç å¯ä»¥åœ¨ <a href="https://github.com/mohuishou/protoc-gen-go-gin">mohuishou/protoc-gen-go-gin</a> ä¸­æ‰¾åˆ°ï¼Œå¦‚æœä½ æœ‰ç±»ä¼¼çš„éœ€æ±‚å¯ä»¥ç›´æ¥ä½¿ç”¨</div><h3 id="æ–¹æ¡ˆè®¾è®¡"><a href="#æ–¹æ¡ˆè®¾è®¡" class="headerlink" title="æ–¹æ¡ˆè®¾è®¡"></a>æ–¹æ¡ˆè®¾è®¡</h3><p>å¼€å§‹å¼€å‘ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ gin çš„è·¯ç”±æ˜¯æ€ä¹ˆæ³¨å†Œçš„ï¼Œä»¥åŠ grpc ç”Ÿæˆçš„æ¥å£æ ¼å¼æ˜¯ä»€ä¹ˆæ ·çš„</p><h4 id="gin-example"><a href="#gin-example" class="headerlink" title="gin example"></a>gin example</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handler</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br><span class="hljs-comment">// get params</span><br>params := <span class="hljs-keyword">struct</span> &#123;<br>Msg <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;msg&quot;`</span><br>&#125;&#123;&#125;<br>ctx.BindQuery(&amp;params)<br><br><span class="hljs-comment">// ä¸šåŠ¡é€»è¾‘</span><br><br><span class="hljs-comment">// è¿”å›æ•°æ®</span><br>ctx.JSON(<span class="hljs-number">200</span>, gin.H&#123;<br><span class="hljs-string">&quot;message&quot;</span>: params.Msg,<br>&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>r := gin.Default()<br>r.GET(<span class="hljs-string">&quot;/ping&quot;</span>, handler)<br>r.Run() <span class="hljs-comment">// ç›‘å¬å¹¶åœ¨ 0.0.0.0:8080 ä¸Šå¯åŠ¨æœåŠ¡</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå¯ä»¥å‘ç° gin æ³¨å†Œè·¯ç”±éœ€è¦ä¸€ä¸ª <code>func (ctx *gin.Context)</code> ç­¾åçš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸€èˆ¬åšä¸‰ä»¶äº‹ï¼Œè·å–å‚æ•°ï¼Œè°ƒç”¨ä¸šåŠ¡é€»è¾‘ï¼Œè°ƒç”¨ gin çš„æ–¹æ³•è¿”å› http response</p><h4 id="grpc-server-interface"><a href="#grpc-server-interface" class="headerlink" title="grpc server interface"></a>grpc server interface</h4><p>å…ˆçœ‹ä¸€ä¸‹ proto æ–‡ä»¶ä¸­çš„ rpc å®šä¹‰ï¼Œä¸€èˆ¬å°±æ˜¯åŒ…å«ä¸€ä¸ªå‚æ•°å’Œä¸€ä¸ªè¿”å›å€¼çš„å‡½æ•°</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs protobuf"><span class="hljs-comment">// The greeting service definition.</span><br><span class="hljs-class"><span class="hljs-keyword">service</span> <span class="hljs-title">Greeter</span> </span>&#123;<br>  <span class="hljs-comment">// Sends a greeting</span><br>  <span class="hljs-function"><span class="hljs-keyword">rpc</span> SayHello (HelloRequest) <span class="hljs-keyword">returns</span> (HelloReply) </span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åçœ‹ grpc ç”Ÿæˆçš„æ¥å£ï¼Œå…¶å®å’Œ proto æ–‡ä»¶ä¸€ä¸€å¯¹åº”ï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ª context å’Œ error</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> GreeterServer <span class="hljs-keyword">interface</span> &#123;<br><span class="hljs-comment">// Sends a greeting</span><br>SayHello(context.Context, *HelloRequest) (*HelloReply, error)<br>mustEmbedUnimplementedGreeterServer()<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥é—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬è®© service å±‚å®ç°ç±»ä¼¼ <code>GreeterServer</code> æ¥å£å°±è¡Œäº†ï¼Œé‚£æˆ‘ä»¬ä»£ç ç”Ÿæˆå™¨è¦æ€ä¹ˆå†™æ‰èƒ½å¤Ÿåº”ç”¨åˆ° http ä¸Šå‘¢ï¼Ÿ</p><h4 id="æ¦‚è¦æ–¹æ¡ˆ"><a href="#æ¦‚è¦æ–¹æ¡ˆ" class="headerlink" title="æ¦‚è¦æ–¹æ¡ˆ"></a>æ¦‚è¦æ–¹æ¡ˆ</h4><ol><li>æˆ‘ä»¬éœ€è¦ä» proto æ–‡ä»¶ä¸­å¾—çŸ¥ http methodï¼Œhttp path çš„ä¿¡æ¯ï¼Œè¿™æ ·æˆ‘ä»¬æ‰çŸ¥é“è¦æ³¨å†Œåˆ°å“ªä¸ªè·¯ç”±ä¸Š<ol><li>è¿™ä¸ªå¯ä»¥é€šè¿‡ <code>google/api/annotations.proto</code> ä¸º rpc æ–¹æ³•æ·»åŠ  Option å®ç°</li><li>æˆ–è€…æ˜¯é€šè¿‡å‡½æ•°ç­¾åæ¥çº¦å®šï¼Œæˆ‘ä»¬çº¦å®šæ–¹æ³•åä½¿ç”¨é©¼å³°æ–¹å¼å‘½åï¼Œé¦–ä¸ªå•è¯æ˜¯ http method æˆ–è€…æ˜¯ http method çš„æ˜ å°„ï¼Œå¦‚æœéƒ½ä¸æ˜¯é»˜è®¤é‡‡ç”¨ post<ol><li><code>&quot;GET&quot;, &quot;FIND&quot;, &quot;QUERY&quot;, &quot;LIST&quot;, &quot;SEARCH&quot;</code>  â€“&gt; <code>GET</code></li><li><code>&quot;POST&quot;, &quot;CREATE&quot;</code>  â€“&gt; <code>POST</code></li><li><code>&quot;PUT&quot;, &quot;UPDATE&quot;</code>  â€“&gt; <code>PUT</code></li><li><code>&quot;DELETE&quot;</code>  â€“&gt; <code>DELETE</code></li></ol></li></ol></li><li>æˆ‘ä»¬éœ€è¦æ„å»º <code>func handler(ctx *gin.Context)</code> å‡½æ•°ç”¨äºæ³¨å†Œè·¯ç”±<ol><li>å‡½æ•°å†…éœ€è¦å¤„ç†å‚æ•°ï¼Œç”¨äºè°ƒç”¨ service å±‚çš„ä»£ç </li><li>è°ƒç”¨ service å±‚çš„ä»£ç ç»“æŸä¹‹åï¼Œå°†è¿”å›å€¼è°ƒç”¨ gin ç›¸å…³æ–¹æ³•è¿”å›</li></ol></li></ol><p>æ‰€ä»¥æˆ‘ä»¬æœ€åç”Ÿæˆçš„ä»£ç å¤§æ¦‚åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> GreeterService <span class="hljs-keyword">struct</span> &#123;<br>server GreeterHTTPServer<br>router gin.IRouter<br>&#125;<br><br><span class="hljs-comment">// ç”Ÿæˆçš„ gin.HandlerFunc</span><br><span class="hljs-comment">// ç”±äº HandlerFunc ç­¾åçš„é™åˆ¶ï¼Œä¸èƒ½ä»å‚æ•°ä¼ é€’ service æ¥å£è¿›æ¥</span><br><span class="hljs-comment">// æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª Struct æ‰˜ç®¡ service æ•°æ®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *GreeterService)</span> <span class="hljs-title">SayHello</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br><span class="hljs-keyword">var</span> in HelloRequest<br><br><span class="hljs-keyword">if</span> err := ctx.ShouldBindJSON(âˆˆ); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// è¿”å›å‚æ•°é”™è¯¯</span><br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// è°ƒç”¨ä¸šåŠ¡é€»è¾‘</span><br>out, err := s.server.(GreeterHTTPServer).SayHello(ctx, âˆˆ)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// è¿”å›é”™è¯¯ç»“æœ</span><br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// è¿”å›æˆåŠŸç»“æœ</span><br>ctx.JSON(<span class="hljs-number">200</span>, out)<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// è·¯ç”±æ³¨å†Œï¼Œé¦–å…ˆéœ€è¦ gin.IRouter æ¥å£ç”¨äºæ³¨å†Œ</span><br><span class="hljs-comment">// å…¶æ¬¡éœ€è¦è·å–åˆ° SayHello æ–¹æ³•å¯¹åº”çš„ http method å’Œ path</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *GreeterService)</span> <span class="hljs-title">RegisterService</span><span class="hljs-params">()</span></span> &#123;<br>s.router.Handle(<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;/hello&quot;</span>, s.SayHello)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>ç†è®ºå¯è¡Œï¼Œå¼€å§‹å¹²æ´»ï¼Œä»£ç ä» kratos v2 ç›¸å…³ä»£ç ä¿®æ”¹è€Œæ¥ï¼Œæ–‡ç« ç¯‡å¹…æœ‰é™ï¼Œè¿™é‡Œåªè´´å…³é”®ä»£ç ï¼Œå®Œæ•´å¯æ‰§è¡Œä»£ç è¯·è®¿é—® <a href="https://github.com/mohuishou/protoc-gen-go-gin">mohuishou/protoc-gen-go-gin</a></p><p><strong><em>å¦‚æœå¯¹å®ç°ä¸æ„Ÿå…´è¶£å¯ä»¥ç›´æ¥è·³åˆ°æœ€åä¸€ä¸ªéƒ¨åˆ†æŸ¥çœ‹ä½¿ç”¨ç¤ºä¾‹ï¼Œçœ‹æœ€ç»ˆçš„æ•ˆæœ</em></strong></p><p>å¤§è‡´æµç¨‹: è·å–æ‰€æœ‰çš„ proto æ–‡ä»¶ â€“&gt; è·å– proto æ–‡ä»¶ä¸­çš„æ‰€æœ‰ service ä¿¡æ¯ â€“&gt; è·å– service ä¸­çš„æ‰€æœ‰ method ä¿¡æ¯</p><h3 id="proto-æ–‡ä»¶"><a href="#proto-æ–‡ä»¶" class="headerlink" title="proto æ–‡ä»¶"></a>proto æ–‡ä»¶</h3><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs protobuf">syntax = <span class="hljs-string">&quot;proto3&quot;</span>;<br><br><span class="hljs-keyword">option</span> go_package = <span class="hljs-string">&quot;github.com/mohuishou/protoc-gen-go-gin/example/testproto;testproto&quot;</span>;<br><br><span class="hljs-keyword">package</span> testproto;<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;google/api/annotations.proto&quot;</span>;<br><br><span class="hljs-comment">// blog service is a blog demo</span><br><span class="hljs-class"><span class="hljs-keyword">service</span> <span class="hljs-title">BlogService</span> </span>&#123;<br><span class="hljs-comment">// æ–¹æ³•å action+resource</span><br><span class="hljs-function"><span class="hljs-keyword">rpc</span> GetArticles(GetArticlesReq) <span class="hljs-keyword">returns</span> (GetArticlesResp) </span>&#123;<br>  <span class="hljs-comment">// æ·»åŠ  option ç”¨äºæŒ‡å®š http çš„è·¯ç”±å’Œæ–¹æ³•</span><br><span class="hljs-keyword">option</span> (google.api.http) = &#123;<br>get: <span class="hljs-string">&quot;/v1/articles&quot;</span><br><br>      <span class="hljs-comment">// å¯ä»¥é€šè¿‡æ·»åŠ  additional_bindings ä¸€ä¸ª rpc method å¯¹åº”å¤šä¸ª http è·¯ç”±</span><br>additional_bindings &#123;<br>get: <span class="hljs-string">&quot;/v1/author/&#123;author_id&#125;/articles&quot;</span><br>&#125;<br>&#125;;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="éœ€è¦è·å–çš„ä¿¡æ¯"><a href="#éœ€è¦è·å–çš„ä¿¡æ¯" class="headerlink" title="éœ€è¦è·å–çš„ä¿¡æ¯"></a>éœ€è¦è·å–çš„ä¿¡æ¯</h4><p><strong>service info</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> service <span class="hljs-keyword">struct</span> &#123;<br>Name     <span class="hljs-keyword">string</span> <span class="hljs-comment">// Greeter</span><br>FullName <span class="hljs-keyword">string</span> <span class="hljs-comment">// helloworld.Greeter</span><br>FilePath <span class="hljs-keyword">string</span> <span class="hljs-comment">// api/helloworld/helloworld.proto</span><br><br>Methods   []*method<br>MethodSet <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*method<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆéœ€è¦ Methods å’Œ MethodSetï¼Œå› ä¸ºå¯èƒ½å­˜åœ¨å¤šä¸ª HTTP è¯·æ±‚å¯¹åº”ä¸€ä¸ª RPC Methodï¼Œè¿™ä¹Ÿæ˜¯ä¸‹é¢çš„ method ç»“æ„ä¸­åŒ…å«äº†ä¸€ä¸ª num å­—æ®µçš„åŸå› </p><p><strong>method info</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> method <span class="hljs-keyword">struct</span> &#123;<br>Name    <span class="hljs-keyword">string</span> <span class="hljs-comment">// SayHello</span><br>Num     <span class="hljs-keyword">int</span>    <span class="hljs-comment">// ä¸€ä¸ª rpc æ–¹æ³•å¯ä»¥å¯¹åº”å¤šä¸ª http è¯·æ±‚</span><br>Request <span class="hljs-keyword">string</span> <span class="hljs-comment">// SayHelloReq</span><br>Reply   <span class="hljs-keyword">string</span> <span class="hljs-comment">// SayHelloResp</span><br><span class="hljs-comment">// http_rule</span><br>Path         <span class="hljs-keyword">string</span> <span class="hljs-comment">// è·¯ç”±</span><br>Method       <span class="hljs-keyword">string</span> <span class="hljs-comment">// HTTP Method</span><br>Body         <span class="hljs-keyword">string</span><br>ResponseBody <span class="hljs-keyword">string</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="è·å–æ‰€æœ‰çš„-proto-æ–‡ä»¶"><a href="#è·å–æ‰€æœ‰çš„-proto-æ–‡ä»¶" class="headerlink" title="è·å–æ‰€æœ‰çš„ proto æ–‡ä»¶"></a>è·å–æ‰€æœ‰çš„ proto æ–‡ä»¶</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// main.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// ...</span><br><br>options := protogen.Options&#123;<br>ParamFunc: flags.Set,<br>&#125;<br><br>options.Run(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(gen *protogen.Plugin)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">for</span> _, f := <span class="hljs-keyword">range</span> gen.Files &#123;<br><span class="hljs-keyword">if</span> !f.Generate &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br>generateFile(gen, f)<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ç”Ÿæˆå•ä¸ª-proto-æ–‡ä»¶ä¸­çš„å†…å®¹"><a href="#ç”Ÿæˆå•ä¸ª-proto-æ–‡ä»¶ä¸­çš„å†…å®¹" class="headerlink" title="ç”Ÿæˆå•ä¸ª proto æ–‡ä»¶ä¸­çš„å†…å®¹"></a>ç”Ÿæˆå•ä¸ª proto æ–‡ä»¶ä¸­çš„å†…å®¹</h4><p>è¿™ä¸€éƒ¨åˆ†çš„é€»è¾‘ä¸»è¦æ˜¯ç”Ÿæˆæ–‡ä»¶çš„åŒ…åï¼Œä»¥åŠå°†éœ€è¦å¯¼å…¥çš„ç¬¬ä¸‰æ–¹åº“ï¼Œä¾‹å¦‚ gin ä¹‹ç±»çš„å¯¼å…¥åˆ°å…¶ä¸­<br>ç„¶åå¾ªç¯è°ƒç”¨ genService æ–¹æ³•ç”Ÿæˆç›¸å…³ä»£ç </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åé¢éƒ½æ˜¯ gin.go çš„å†…å®¹</span><br><br><span class="hljs-comment">// generateFile generates a _gin.pb.go file.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generateFile</span><span class="hljs-params">(gen *protogen.Plugin, file *protogen.File)</span> *<span class="hljs-title">protogen</span>.<span class="hljs-title">GeneratedFile</span></span> &#123;<br><span class="hljs-comment">// å¦‚æœä¸å­˜åœ¨ service å°±ç›´æ¥è·³è¿‡äº†ï¼Œæˆ‘ä»¬ä¸»è¦ç”Ÿæˆ service çš„æ¥å£</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(file.Services) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br>filename := file.GeneratedFilenamePrefix + <span class="hljs-string">&quot;_gin.pb.go&quot;</span><br>g := gen.NewGeneratedFile(filename, file.GoImportPath)<br>g.P(<span class="hljs-string">&quot;// Code generated by github.com/mohuishou/protoc-gen-go-gin. DO NOT EDIT.&quot;</span>)<br>g.P()<br>g.P(<span class="hljs-string">&quot;package &quot;</span>, file.GoPackageName)<br>g.P()<br>g.P(<span class="hljs-string">&quot;// This is a compile-time assertion to ensure that this generated file&quot;</span>)<br>g.P(<span class="hljs-string">&quot;// is compatible with the mohuishou/protoc-gen-go-gin package it is being compiled against.&quot;</span>)<br>g.P(<span class="hljs-string">&quot;// &quot;</span>, contextPkg.Ident(<span class="hljs-string">&quot;&quot;</span>), metadataPkg.Ident(<span class="hljs-string">&quot;&quot;</span>))<br>g.P(<span class="hljs-string">&quot;//&quot;</span>, ginPkg.Ident(<span class="hljs-string">&quot;&quot;</span>), errPkg.Ident(<span class="hljs-string">&quot;&quot;</span>))<br>g.P()<br><br><span class="hljs-keyword">for</span> _, service := <span class="hljs-keyword">range</span> file.Services &#123;<br>genService(gen, file, g, service)<br>&#125;<br><span class="hljs-keyword">return</span> g<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="è·å–-service-ç›¸å…³ä¿¡æ¯"><a href="#è·å–-service-ç›¸å…³ä¿¡æ¯" class="headerlink" title="è·å– service ç›¸å…³ä¿¡æ¯"></a>è·å– service ç›¸å…³ä¿¡æ¯</h4><p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯åˆ©ç”¨ protogen.Service çš„ä¿¡æ¯æ„å»º service ç»“æ„ï¼Œç„¶åå¾ªç¯è°ƒç”¨ genMethod æ–¹æ³•ç”Ÿæˆ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">genService</span><span class="hljs-params">(gen *protogen.Plugin, file *protogen.File, g *protogen.GeneratedFile, s *protogen.Service)</span></span> &#123;<br><span class="hljs-keyword">if</span> s.Desc.Options().(*descriptorpb.ServiceOptions).GetDeprecated() &#123;<br>g.P(<span class="hljs-string">&quot;//&quot;</span>)<br>g.P(deprecationComment)<br>&#125;<br><span class="hljs-comment">// HTTP Server.</span><br>sd := &amp;service&#123;<br>Name:     s.GoName,<br>FullName: <span class="hljs-keyword">string</span>(s.Desc.FullName()),<br>FilePath: file.Desc.Path(),<br>&#125;<br><br><span class="hljs-keyword">for</span> _, method := <span class="hljs-keyword">range</span> s.Methods &#123;<br>sd.Methods = <span class="hljs-built_in">append</span>(sd.Methods, genMethod(method)...)<br>&#125;<br>g.P(sd.execute())<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="è·å–-rpc-æ–¹æ³•çš„ç›¸å…³ä¿¡æ¯"><a href="#è·å–-rpc-æ–¹æ³•çš„ç›¸å…³ä¿¡æ¯" class="headerlink" title="è·å– rpc æ–¹æ³•çš„ç›¸å…³ä¿¡æ¯"></a>è·å– rpc æ–¹æ³•çš„ç›¸å…³ä¿¡æ¯</h4><p>æˆ‘ä»¬é€šè¿‡ proto.GetExtension è·å–ä¹‹å‰åœ¨ rpc method è®¾ç½®çš„ option ä¿¡æ¯ï¼Œå¦‚æœå­˜åœ¨é‚£ä¹ˆå°±ä» option è·å–è·¯ç”±å’Œ method çš„ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰å°±æ ¹æ®æ–¹æ³•åç”Ÿæˆé»˜è®¤çš„è·¯ç”±</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">genMethod</span><span class="hljs-params">(m *protogen.Method)</span> []*<span class="hljs-title">method</span></span> &#123;<br><span class="hljs-keyword">var</span> methods []*method<br><br><span class="hljs-comment">// å­˜åœ¨ http rule é…ç½®</span><br>rule, ok := proto.GetExtension(m.Desc.Options(), annotations.E_Http).(*annotations.HttpRule)<br><span class="hljs-keyword">if</span> rule != <span class="hljs-literal">nil</span> &amp;&amp; ok &#123;<br><span class="hljs-keyword">for</span> _, bind := <span class="hljs-keyword">range</span> rule.AdditionalBindings &#123;<br>methods = <span class="hljs-built_in">append</span>(methods, buildHTTPRule(m, bind))<br>&#125;<br>methods = <span class="hljs-built_in">append</span>(methods, buildHTTPRule(m, rule))<br><span class="hljs-keyword">return</span> methods<br>&#125;<br><br><span class="hljs-comment">// ä¸å­˜åœ¨èµ°é»˜è®¤æµç¨‹</span><br>methods = <span class="hljs-built_in">append</span>(methods, defaultMethod(m))<br><span class="hljs-keyword">return</span> methods<br>&#125;<br></code></pre></td></tr></table></figure><p>ä» option ä¸­ç”Ÿæˆè·¯ç”±</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">buildHTTPRule</span><span class="hljs-params">(m *protogen.Method, rule *annotations.HttpRule)</span> *<span class="hljs-title">method</span></span> &#123;<br><span class="hljs-comment">// ....</span><br><br><span class="hljs-keyword">switch</span> pattern := rule.Pattern.(<span class="hljs-keyword">type</span>) &#123;<br><span class="hljs-keyword">case</span> *annotations.HttpRule_Get:<br>path = pattern.Get<br>method = <span class="hljs-string">&quot;GET&quot;</span><br><span class="hljs-comment">// ... å…¶ä»–æ˜ å°„</span><br>&#125;<br>md := buildMethodDesc(m, method, path)<br><span class="hljs-keyword">return</span> md<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆé»˜è®¤çš„è·¯ç”±</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">defaultMethod</span><span class="hljs-params">(m *protogen.Method)</span> *<span class="hljs-title">method</span></span> &#123;<br>    <span class="hljs-comment">// åˆ†å‰²æ–¹æ³•å</span><br>names := strings.Split(toSnakeCase(m.GoName), <span class="hljs-string">&quot;_&quot;</span>)<br><br>    <span class="hljs-comment">// ...</span><br><br>    <span class="hljs-comment">// å¦‚æœ http method æ˜ å°„æˆåŠŸï¼Œé‚£ä¹ˆè·¯ç”±å°±æ˜¯ names[1:]</span><br>    <span class="hljs-comment">// å¦‚æœæ²¡æœ‰æ˜ å°„æˆåŠŸè·¯ç”±å°±æ˜¯ names</span><br><span class="hljs-keyword">switch</span> strings.ToUpper(names[<span class="hljs-number">0</span>]) &#123;<br><span class="hljs-keyword">case</span> http.MethodGet, <span class="hljs-string">&quot;FIND&quot;</span>, <span class="hljs-string">&quot;QUERY&quot;</span>, <span class="hljs-string">&quot;LIST&quot;</span>, <span class="hljs-string">&quot;SEARCH&quot;</span>:<br>httpMethod = http.MethodGet<br><span class="hljs-comment">// ...  å…¶ä»–æ–¹æ³•æ˜ å°„</span><br><span class="hljs-keyword">default</span>:<br>httpMethod = <span class="hljs-string">&quot;POST&quot;</span><br>paths = names<br>&#125;<br><br><span class="hljs-comment">// ...</span><br><br>md := buildMethodDesc(m, httpMethod, path)<br><span class="hljs-keyword">return</span> md<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åæˆ‘ä»¬åœ¨ä½¿ç”¨ go template ç”Ÿæˆæœ€å¼€å§‹æ–¹æ¡ˆä¸­æ–‡ä»¶å³å¯ï¼Œä»£ç æœ‰ç‚¹å¤šäº†è¿™é‡Œå°±ä¸è´´äº†ï¼Œå¯ä»¥åœ¨ <a href="https://github.com/mohuishou/protoc-gen-go-gin">https://github.com/mohuishou/protoc-gen-go-gin</a> ä¸­æ‰¾åˆ°</p><h2 id="ä½¿ç”¨æ¡ˆä¾‹"><a href="#ä½¿ç”¨æ¡ˆä¾‹" class="headerlink" title="ä½¿ç”¨æ¡ˆä¾‹"></a>ä½¿ç”¨æ¡ˆä¾‹</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">æ¡ˆä¾‹å®Œæ•´æºä»£ç å¯ä»¥åœ¨ <a href="https://github.com/mohuishou/protoc-gen-go-gin">https://github.com/mohuishou/protoc-gen-go-gin</a> ä¸­æ‰¾åˆ°</div><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs protobuf">syntax = <span class="hljs-string">&quot;proto3&quot;</span>;<br><br><span class="hljs-keyword">option</span> go_package = <span class="hljs-string">&quot;github.com/mohuishou/protoc-gen-go-gin/example/api/product/app/v1&quot;</span>;<br><br><span class="hljs-keyword">package</span> product.app.v1;<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;google/api/annotations.proto&quot;</span>;<br><br><span class="hljs-comment">// blog service is a blog demo</span><br><span class="hljs-class"><span class="hljs-keyword">service</span> <span class="hljs-title">BlogService</span> </span>&#123;<br><span class="hljs-function"><span class="hljs-keyword">rpc</span> GetArticles(GetArticlesReq) <span class="hljs-keyword">returns</span> (GetArticlesResp) </span>&#123;<br><span class="hljs-keyword">option</span> (google.api.http) = &#123;<br>get: <span class="hljs-string">&quot;/v1/articles&quot;</span><br>additional_bindings &#123;<br>get: <span class="hljs-string">&quot;/v1/author/&#123;author_id&#125;/articles&quot;</span><br>&#125;<br>&#125;;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">rpc</span> CreateArticle(Article) <span class="hljs-keyword">returns</span> (Article) </span>&#123;<br><span class="hljs-keyword">option</span> (google.api.http) = &#123;<br>post: <span class="hljs-string">&quot;/v1/author/&#123;author_id&#125;/articles&quot;</span><br>&#125;;<br>&#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">GetArticlesReq</span> </span>&#123;<br><span class="hljs-comment">// @inject_tag: form:&quot;title&quot;</span><br><span class="hljs-built_in">string</span> title = <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">// @inject_tag: form:&quot;page&quot;</span><br><span class="hljs-built_in">int32</span> page = <span class="hljs-number">2</span>;<br><br><span class="hljs-comment">// @inject_tag: form:&quot;page_size&quot;</span><br><span class="hljs-built_in">int32</span> page_size = <span class="hljs-number">3</span>;<br><br><span class="hljs-comment">// @inject_tag: form:&quot;author_id&quot; uri:&quot;author_id&quot;</span><br><span class="hljs-built_in">int32</span> author_id = <span class="hljs-number">4</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">GetArticlesResp</span> </span>&#123;<br><span class="hljs-built_in">int64</span> total = <span class="hljs-number">1</span>;<br><span class="hljs-keyword">repeated</span> Article articles = <span class="hljs-number">2</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">Article</span> </span>&#123;<br><span class="hljs-built_in">string</span> title  = <span class="hljs-number">1</span>;<br><span class="hljs-built_in">string</span> content = <span class="hljs-number">2</span>;<br><span class="hljs-comment">// @inject_tag: form:&quot;author_id&quot; uri:&quot;author_id&quot;</span><br><span class="hljs-built_in">int32</span> author_id = <span class="hljs-number">3</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ @inject_tag: çš„æ³¨é‡Šæ˜¯ä½¿ç”¨äº† protoc-go-inject-tag æ’ä»¶ç”¨æ¥é™„åŠ é¢å¤–çš„ Struct tagsï¼Œprotoc-gen-go ç›®å‰æš‚æ—¶ä¸æ”¯æŒæ·»åŠ  tag</p><p>å®šä¹‰å¥½ proto æ–‡ä»¶ä¹‹åæˆ‘ä»¬åªéœ€è¦æ‰§è¡Œå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">protoc -I ./example/api \<br> <span class="hljs-comment"># è¿™ä¸ªæ˜¯ç”¨æ¥ç”Ÿæˆ swagger json æ–‡ä»¶çš„ï¼Œæˆ‘ä»¬å¾ˆå¤šç³»ç»Ÿæ”¯æŒå¯¼å…¥ swagger çš„å®šä¹‰ï¼Œç”Ÿæˆè¿™ä¸ªæ–¹ä¾¿å¯¼å…¥</span><br>--openapiv2_out ./example/api --openapiv2_opt logtostderr=<span class="hljs-literal">true</span> --openapiv2_opt json_names_for_fields=<span class="hljs-literal">false</span> \<br> <span class="hljs-comment"># ç”Ÿæˆå¯¹åº”çš„ go æ–‡ä»¶</span><br>--go_out ./example/api --go_opt=paths=source_relative \<br> <span class="hljs-comment"># ç”Ÿæˆæœ¬æ–‡æ’ä»¶ä¸­çš„ gin æ–‡ä»¶</span><br>--go-gin_out ./example/api --go-gin_opt=paths=source_relative \<br>example/api/product/app/v1/v1.proto<br>protoc-go-inject-tag -input=./example/api/product/app/v1/v1.pb.go<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>api è®¾è®¡è¿™éƒ¨åˆ†å°±å…ˆåˆ°è¿™é‡Œäº†ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹é…ç½®ç®¡ç†</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go è¿›é˜¶è®­ç»ƒè¥-æå®¢æ—¶é—´</a></li><li><a href="https://lailin.xyz/post/go-training-week4-project-layout.html">Go å·¥ç¨‹åŒ–(äºŒ) é¡¹ç›®ç›®å½•ç»“æ„</a></li><li><a href="https://github.com/go-kratos/kratos">https://github.com/go-kratos/kratos</a></li><li><a href="https://github.com/golang/protobuf/blob/master/protoc-gen-go/main.go">https://github.com/golang/protobuf/blob/master/protoc-gen-go/main.go</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week04: Go å·¥ç¨‹åŒ–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å·¥ç¨‹åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå·¥ç¨‹åŒ–(å››) API è®¾è®¡ä¸Š: é¡¹ç›®ç»“æ„ &amp; è®¾è®¡</title>
    <link href="/post/go-training-week4-api-design.html"/>
    <url>/post/go-training-week4-api-design.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p>3 æœˆå¼€å§‹ä¼šå°è¯•çˆ†æ›´æ¨¡å¼ï¼Œäº‰å–åšåˆ°ä¸¤å¤©æ›´æ–°ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœæ„Ÿå…´è¶£å¯ä»¥æ‹‰åˆ°æ–‡ç« æœ€ä¸‹æ–¹è·å–å…³æ³¨æ–¹å¼ã€‚<strong>3 æœˆè¿›åº¦: 01/15</strong></p><p>åœ¨ <a href="https://lailin.xyz/post/go-training-week4-project-layout.html">Go å·¥ç¨‹åŒ–(äºŒ) é¡¹ç›®ç›®å½•ç»“æ„</a> ä¸­æˆ‘ä»¬å¤§æ¦‚è®²äº†ä¸€ä¸‹ api ç›®å½•ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è¯¦ç»†çš„è¯´æ˜ï¼Œç•™åœ¨è¿™è¿™ç¯‡æ–‡ç« ä¸€èµ·è®²ã€‚</p><p>API è®¾è®¡å°†åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†:</p><ul><li>é¦–å…ˆä¼šè®²ä¸€ä¸‹ API çš„é¡¹ç›®ç›®å½•ç»“æ„ï¼Œåœ¨é¡¹ç›®ä¸­ api è¯¥å¦‚ä½•ç»„ç»‡ï¼Œä»¥åŠ api ä¾èµ–è¯¥å¦‚ä½•å¤„ç†</li><li>ç¬¬äºŒä¸ªéƒ¨åˆ†ä¼šè®²ä¸€ä¸‹ API è¯¥å¦‚ä½•è®¾è®¡ï¼ŒåŒ…æ‹¬é”™è¯¯ç çš„è®¾è®¡</li><li>ç¬¬ä¸‰ä¸ªéƒ¨åˆ†ä¼šè®²ä¸€ä¸‹å¦‚ä½•æ„é€ ä¸€ä¸ª protobuf çš„ä»£ç ç”Ÿæˆå™¨ï¼Œè‡ªåŠ¨ç”Ÿæˆ gin ç›¸å…³ä»£ç ï¼Œè¿™ä¸ªæ˜¯å› ä¸ºæˆ‘ä»¬ç›®å‰ä¸»è¦æ˜¯ http çš„æœåŠ¡ï¼Œgrpc ç›¸å…³åŸºç¡€è®¾æ–½å»ºè®¾ä¸å®Œå…¨ï¼Œæ‰€ä»¥ä¾èµ–ç°æœ‰çš„åŸºç¡€è®¾æ–½å¾—åˆ°æ›´å¥½çš„ä½“éªŒã€‚å¹¶ä¸”åšåˆ°åœ¨ service å±‚çš„ä»£ç æ”¯æŒ grpc å’Œ http å¤šç§æ–¹å¼ï¼Œä½¿åç»­æ¶æ„å˜åŒ–æ›´åŠ çµæ´»ã€‚</li><li>ç¬¬å››ä¸ªéƒ¨åˆ†ä¼šç»™å‡ºä¸€ä¸ª demoï¼Œè¾…åŠ©å¤§å®¶æ›´å¥½çš„ç†è§£</li></ul><p>ç”±äºç¯‡å¹…åŸå› æ‹†åˆ†æˆäº†ä¸¤ç¯‡æ–‡ç« ï¼Œæœ¬æ–‡æ¶‰åŠåˆ°ä¸€äºŒéƒ¨åˆ†ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« ä¸ºè®²è§£ä¸‰å››éƒ¨åˆ†</p><h2 id="API-é¡¹ç›®ç»“æ„ä¸ç®¡ç†"><a href="#API-é¡¹ç›®ç»“æ„ä¸ç®¡ç†" class="headerlink" title="API é¡¹ç›®ç»“æ„ä¸ç®¡ç†"></a>API é¡¹ç›®ç»“æ„ä¸ç®¡ç†</h2><h3 id="API-å®šä¹‰æ–¹å¼"><a href="#API-å®šä¹‰æ–¹å¼" class="headerlink" title="API å®šä¹‰æ–¹å¼"></a>API å®šä¹‰æ–¹å¼</h3><p>b ç«™å†…éƒ¨ä¸»è¦ä½¿ç”¨ grpc ä½œä¸ºå†…éƒ¨é€šä¿¡çš„æ–¹å¼ï¼Œå› ä¸ºä»–ä½¿ç”¨ protobuf æ–‡ä»¶å®šä¹‰å¯ä»¥æ”¯æŒå¯¹è¯­è¨€ä»£ç ç”Ÿæˆï¼ŒåŒæ—¶è¿˜é¿å…äº†æ‰‹å†™æ–‡æ¡£å¯¼è‡´çš„æ–‡æ¡£é”™è¯¯è¿‡æ—¶ç­‰æƒ…å†µï¼Œå…·ä½“çš„åŸå› å…¶å®åœ¨ç¬¬ä¸€è¯¾çš„ç¬”è®°å½“ä¸­å°±æœ‰æåˆ°ï¼Œå¦‚æœæ„Ÿå…´è¶£å¯ä»¥æŸ¥çœ‹ <a href="https://lailin.xyz/post/go-training-02.html#%E6%9C%8D%E5%8A%A1%E9%97%B4%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F-gRPC">å¾®æœåŠ¡(äºŒ) æœåŠ¡å‘ç°&amp;å¤šç§Ÿæˆ·#gRPC</a></p><p>æˆ‘ä»¬ç›®å‰ä½¿ç”¨ç±»ä¼¼ http restful çš„æ–¹å¼è¿›è¡Œå¯¹å¤–å¯¹å†…æä¾›æœåŠ¡ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹‹å‰çš„ API ç®¡ç†å…¶å®æ˜¯æ¯”è¾ƒæ··ä¹±çš„ï¼Œåˆ†ä¸ºä»¥ä¸‹å‡ ç§æƒ…å†µ:</p><ol><li>æš´éœ²ç»™ web çš„ apiï¼šæœ‰ä½¿ç”¨ swagger çš„ï¼Œæœ‰åœ¨æ–‡æ¡£å¹³å°ä¸Šå†™æ–‡æ¡£çš„ï¼Œè¿˜æœ‰æ²¡æœ‰å†™æ–‡æ¡£çš„</li><li>æš´éœ²ç»™å…¶ä»–æœåŠ¡è°ƒç”¨çš„ api: æœ‰æ³¨å†Œåˆ°å†…éƒ¨çš„æ¥å£ç½‘å…³çš„ï¼Œä½†æ˜¯å†…éƒ¨çš„æ¥å£ç½‘å…³ä¸Šæœ‰çš„æœ‰å‚æ•°ï¼Œæœ‰çš„æ²¡æœ‰ï¼Œæ²¡æœ‰è¿”å›å€¼å®šä¹‰</li></ol><p>æ‰€ä»¥å°±å­˜åœ¨å¾ˆå¤šé—®é¢˜:</p><ol><li>æƒ³è¦æ¥å£ä¸çŸ¥é“ä»å“ªå„¿æ‰¾ï¼Œåªèƒ½åˆ°å¤„é—®äºº</li><li>æœ‰æ—¶å€™ä»å†…éƒ¨ç½‘å…³å¹³å°ä¸Šæ‰¾åˆ°æ¥å£ä½†æ˜¯ä¸çŸ¥é“æ€ä¹ˆè°ƒç”¨ï¼Œæ²¡æœ‰å†™ä»»ä½•å‚æ•°ï¼Œæœ‰çš„å†™äº†è¿˜æœ‰å¯èƒ½æ˜¯é”™çš„</li><li>æœ‰çš„å‹æ ¹æ²¡æœ‰æ¥å£æ–‡æ¡£ï¼Œå¯¹æ¥çš„åŒå­¦ä¹Ÿæ²¡æœ‰æ—¶é—´å†™ï¼Œç„¶åè®©ä½ ç›´æ¥çœ‹ä»£ç </li><li>æœ‰çš„å¯¹æ¥åŒå­¦æ‰”ç»™ä½ ä¸€ä¸ªæ¥å£æ–‡æ¡£ï¼Œç„¶åè¯•äº†åŠå¤©å‘ç°ï¼Œæœ‰é—®é¢˜ï¼Œæ²Ÿé€šæ’æŸ¥ä¹‹åå‘ç°æ–‡æ¡£å¾ˆä¹…æ²¡æœ‰æ›´æ–°äº† o(â•¥ï¹â•¥)o</li></ol><p>æ‰€ä»¥è¯¾ç¨‹ä¸Šæ¯›è€å¸ˆæåˆ°çš„åˆ©ç”¨ protobuf æ¥å®šä¹‰æ¥å£çš„æ–¹å¼éå¸¸ä»¤äººå¿ƒåŠ¨ï¼Œå› ä¸º protobuf å½“ä¸­åŒ…å«äº†æ¥å£çš„å‡½æ•°ç­¾åï¼Œå…¥å‚å’Œè¿”å›å€¼åŒæ—¶è¿˜æ”¯æŒæ³¨é‡Šï¼Œå°±æ˜¯ä¸€ä»½å¤©ç„¶çš„æ–‡æ¡£ï¼ŒåŒæ—¶ä¹Ÿä¸ç”¨æ‹…å¿ƒå‡ºç°ä»£ç æ›´æ–°äº†ä½†æ˜¯æ–‡æ¡£æ²¡æœ‰æ›´æ–°çš„æƒ…å†µï¼Œå› ä¸ºå®ƒæ—¢æ˜¯æ–‡æ¡£ä¹Ÿæ˜¯ä»£ç ï¼ŒæœåŠ¡ç«¯ä¹Ÿéœ€è¦ä½¿ç”¨ï¼Œæ‰€ä»¥ä»£ç æ›´æ–°ä¹‹åæ–‡æ¡£ä¹Ÿä¸€å®šä¼šæ›´æ–°ã€‚è‡ªç„¶è€Œç„¶çš„å°±å°‘äº†å¾ˆå¤šæ²Ÿé€šçš„æˆæœ¬ã€‚<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1614415342256-f3677521-4990-4a9b-9136-ea2b1f4b75d8.jpeg" alt="api å®šä¹‰æ–¹å¼ (1).jpg"><br>å¦‚ä¸Šå›¾æ‰€ç¤ºäºæ­¤åŒæ—¶æˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨ protobuf æ–‡ä»¶ç”Ÿæˆå¯¹åº”è¯­è¨€çš„å®¢æˆ·ç«¯ä»£ç ï¼Œå°±ä¸ç”¨æ¯ä¸ªé¡¹ç›®éƒ½å»ç»´æŠ¤ä¸€å¥— sdk äº†ï¼ŒåŒæ—¶æˆ‘ä»¬ä½¿ç”¨æ¥å£ç”Ÿæˆä»£ç ï¼Œåœ¨ go å½“ä¸­å¯ä»¥ä½¿ç”¨ gomock éå¸¸æ–¹ä¾¿çš„å¯¹ä»£ç è¿›è¡Œ mockã€‚</p><h3 id="API-Project"><a href="#API-Project" class="headerlink" title="API Project"></a>API Project</h3><p>ä½¿ç”¨ protobuf å®šä¹‰æ¥å£å¯ä»¥è§£å†³æˆ‘ä»¬æ‰¾åˆ° api æ–‡æ¡£ä¹‹åï¼Œæ–‡æ¡£ä¸å‡†ç¡®ï¼Œç¼ºå¤±çš„é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬åº”è¯¥å¦‚ä½•æ‰¾åˆ°æˆ‘ä»¬çš„ api å‘¢ï¼Ÿæˆ‘ä»¬ç”Ÿæˆå‡ºçš„ api æ–‡ä»¶è°ƒç”¨æ–¹åº”è¯¥å¦‚ä½•å¼•ç”¨å‘¢ï¼Ÿéš¾é“æˆ‘ä»¬ç»™æ¯ä¸ªè°ƒç”¨æ–¹éƒ½å»å¼€ä¸€ä¸ªé¡¹ç›®çš„æƒé™ä¹ˆï¼Ÿé‚£æ˜æ˜¾æ˜¯ä¸å¤ªè¡Œçš„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹çœ‹æˆ‘ä»¬ api è¯¥å¦‚ä½•ç®¡ç†å’Œç»„ç»‡ã€‚</p><p>æ¯›è€å¸ˆä»–ä»¬ä»¿ç…§ <a href="https://github.com/googleapis/googleapis">googleapis/googleapis</a>ï¼Œ<a href="https://github.com/istio/api">istio/api</a> ç­‰çŸ¥åé¡¹ç›®åœ¨ b ç«™å†…éƒ¨æäº†ä¸€ä¸ª bapis çš„ä»“åº“ç”¨äºåŒä¸€å­˜æ”¾ api å®šä¹‰æ–‡æ¡£ï¼Œç„¶åé€šè¿‡ ci/cd ç”Ÿæˆå¯¹åº”çš„å®¢æˆ·ç«¯ä»£ç æ”¾åˆ°å„ä¸ªè¯­è¨€çš„å­ä»“åº“å½“ä¸­<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1614414445467-d7fb88d2-732d-4ef7-8535-cc645a5b9184.jpeg" alt="Frame 1 (1).jpg"><br>å·¥ä½œæµç¨‹å¦‚ä¸Šå›¾æ‰€ç¤º</p><ul><li>å¼€å‘åŒå­¦ä¿®æ”¹äº† proto æ–‡ä»¶å®šä¹‰ä¹‹å push åˆ°å¯¹åº”çš„ä¸šåŠ¡åº”ç”¨ä»“åº“å½“ä¸­</li><li>ç„¶åè§¦å‘ cicd æµç¨‹å°† proto æ–‡ä»¶å¤åˆ¶åˆ° api project å½“ä¸­<ul><li>é¦–å…ˆä¼šå¯¹ proto æ–‡ä»¶è¿›è¡Œé™æ€ä»£ç åˆ†æï¼ŒæŸ¥çœ‹æ˜¯å¦ç¬¦åˆè§„èŒƒ</li><li>ç„¶å clone api project åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æ”¯</li><li>ç„¶å push ä»£ç ï¼Œåˆ›å»ºä¸€ä¸ª merge request è¯·æ±‚</li></ul></li><li>ç„¶åæˆ‘ä»¬å¯¹åº”è´Ÿè´£çš„åŒå­¦æ”¶åˆ° code review çš„é€šçŸ¥ä¹‹åè¿›è¡Œ code reviewï¼Œæ²¡æœ‰é—®é¢˜å°±ä¼šåˆå¹¶åˆ° api project çš„ä¸»åˆ†æ”¯å½“ä¸­äº†</li><li>ç„¶åå°±ä¼šè§¦å‘ cicd ç”Ÿæˆå¯¹åº”è¯­è¨€çš„å®¢æˆ·ç«¯ä»£ç ï¼Œpush åˆ°å¯¹åº”çš„å„ä¸ªå­ä»“åº“å½“ä¸­äº†</li></ul><h3 id="API-Project-Layout"><a href="#API-Project-Layout" class="headerlink" title="API Project Layout"></a>API Project Layout</h3><p>æˆ‘ä»¬çš„ api é¡¹ç›®æ˜¯å¦‚ä½•å®šä¹‰çš„å‘¢ï¼Ÿçœ‹ä¸‹å›¾<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1614417503897-60326cce-3788-4727-a182-659252fdd231.jpeg" alt="Frame 1 (2).jpg"></p><ul><li>é¦–å…ˆæ˜¯åœ¨ä¸šåŠ¡é¡¹ç›®å½“ä¸­ï¼Œæˆ‘ä»¬é¡¶å±‚ä¼šæœ‰ä¸€ä¸ª api ç›®å½•<ul><li>åœ¨ api ç›®å½•å½“ä¸­æˆ‘ä»¬ä¼šæŒ‰ç…§ product name/app name/ç‰ˆæœ¬å·/app.proto çš„æ–¹å¼è¿›è¡Œç»„ç»‡</li><li>å…·ä½“æ€ä¹ˆç»„ç»‡å¯èƒ½æ¯ä¸ªå…¬å¸éƒ½ä¸å¤ªä¸€æ ·ï¼Œä½†æ˜¯æ€»çš„æ¥è¯´å°±æ˜¯åº”ç”¨çš„ å”¯ä¸€åç§°+ç‰ˆæœ¬å· æ¥è¿›è¡Œä¸€ä¸ªåŒºåˆ†</li></ul></li><li>åœ¨ api project å½“ä¸­å’Œä¸šåŠ¡åº”ç”¨ç±»ä¼¼ï¼Œä¹Ÿæœ‰ä¸€ä¸ª api ç›®å½•ï¼Œé€šè¿‡ä¸Šå›¾çš„ä¸¤ä¸ªæ¡†å°±å¯ä»¥å‘ç°è¿™æ˜¯ä¸€æ¨¡ä¸€æ ·çš„<ul><li>é™¤æ­¤ä¹‹å¤– api project è¿˜æœ‰ç”¨äºæ³¨è§£çš„ annotations æ–‡ä»¶å¤¹</li><li>æœ‰ä¸€äº›ç¬¬ä¸‰æ–¹çš„å¼•ç”¨ï¼Œä¾‹å¦‚ googleapis å½“ä¸­çš„ä¸€äº› proto æ–‡ä»¶</li></ul></li></ul><h2 id="API-è®¾è®¡"><a href="#API-è®¾è®¡" class="headerlink" title="API è®¾è®¡"></a>API è®¾è®¡</h2><h3 id="API-å…¼å®¹æ€§è®¾è®¡"><a href="#API-å…¼å®¹æ€§è®¾è®¡" class="headerlink" title="API å…¼å®¹æ€§è®¾è®¡"></a>API å…¼å®¹æ€§è®¾è®¡</h3><p>éšç€åº”ç”¨çš„ä¸æ–­å¼€å‘ï¼Œä¸šåŠ¡çš„ä¸æ–­å‘å±•æˆ‘ä»¬çš„ api è‚¯å®šä¼šä¸æ–­çš„è¿›è¡Œä¿®æ”¹ï¼Œåœ¨ä¿®æ”¹ api çš„æ—¶å€™è€ƒè™‘ api çš„å…¼å®¹æ€§å°±ä¼šå¾ˆé‡è¦äº†ï¼Œå¦‚æœæˆ‘ä»¬åšäº†ä¸€äº›ç ´åæ€§çš„å˜æ›´å°±æœ‰å¯èƒ½ä¼šå¯¼è‡´ä¾èµ–æˆ‘ä»¬çš„æœåŠ¡æˆ–è€…æ˜¯å®¢æˆ·ç«¯æŠ¥é”™ï¼Œè¿™æ ·å°±ä¼šå¸¦æ¥äº‹æ•…ã€‚</p><h4 id="å‘ä¸‹å…¼å®¹çš„å˜æ›´"><a href="#å‘ä¸‹å…¼å®¹çš„å˜æ›´" class="headerlink" title="å‘ä¸‹å…¼å®¹çš„å˜æ›´"></a>å‘ä¸‹å…¼å®¹çš„å˜æ›´</h4><ul><li>æ–°å¢æ¥å£</li><li>æ–°å¢å‚æ•°å­—æ®µ</li><li>æ–°å¢è¿”å›å­—æ®µ<ul><li>åœ¨ä¸æ”¹å˜å…¶ä»–å“åº”å­—æ®µçš„è¡Œä¸ºçš„å‰æä¸‹ï¼Œéèµ„æºï¼ˆä¾‹å¦‚ï¼ŒListBooksResponseï¼‰çš„å“åº”æ¶ˆæ¯å¯ä»¥æ‰©å±•è€Œä¸å¿…ç ´åå®¢æˆ·ç«¯çš„å…¼å®¹æ€§ã€‚å³ä½¿ä¼šå¼•å…¥å†—ä½™ï¼Œå…ˆå‰åœ¨å“åº”ä¸­å¡«å……çš„ä»»ä½•å­—æ®µåº”ç»§ç»­ä½¿ç”¨ç›¸åŒçš„è¯­ä¹‰å¡«å……ã€‚</li></ul></li></ul><p>ä¸€èˆ¬è€Œè¨€æ–°å¢éƒ½æ˜¯ç›¸å¯¹å®‰å…¨çš„ï¼Œä½†æ˜¯æˆ‘ä»¬è¦æ³¨æ„çš„æ˜¯æ–°å¢å­—æ®µä¸èƒ½æ”¹å˜æˆ‘ä»¬åŸæœ¬çš„é€»è¾‘ï¼Œå¦‚æœæ”¹å˜äº† api çš„é€»è¾‘ï¼Œé‚£å°±ä¸ä¸€å®šå®‰å…¨äº†</p><h4 id="å‘ä¸‹ä¸å…¼å®¹çš„å˜æ›´ï¼ˆç ´åæ€§å˜æ›´ï¼‰"><a href="#å‘ä¸‹ä¸å…¼å®¹çš„å˜æ›´ï¼ˆç ´åæ€§å˜æ›´ï¼‰" class="headerlink" title="å‘ä¸‹ä¸å…¼å®¹çš„å˜æ›´ï¼ˆç ´åæ€§å˜æ›´ï¼‰"></a>å‘ä¸‹ä¸å…¼å®¹çš„å˜æ›´ï¼ˆç ´åæ€§å˜æ›´ï¼‰</h4><ul><li>åˆ é™¤æˆ–é‡å‘½åæœåŠ¡ï¼Œå­—æ®µï¼Œæ–¹æ³•æˆ–æšä¸¾å€¼<ul><li>åœ¨åšè¿™ç§ä¿®æ”¹çš„æ—¶å€™éœ€è¦ä¿®æ”¹æˆ‘ä»¬ api çš„ç‰ˆæœ¬å·ï¼Œå¸¸è§æœ‰ä¸¤ç§æ–¹å¼</li><li>å¦‚æœåªæœ‰å¾ˆå°‘çš„ api å˜åŠ¨å¯ä»¥åˆ›å»ºä¸€ä¸ª XXXV2 çš„æ–¹æ³•</li><li>å¦‚æœå˜åŠ¨çš„ api æ¯”è¾ƒå¤šï¼Œå¯ä»¥ç›´æ¥æ–°å¯ä¸€ä¸ª v2 çš„åŒ…</li></ul></li><li>ä¿®æ”¹å­—æ®µçš„ç±»å‹<ul><li>ä¸¥ç¦ä¿®æ”¹å­—æ®µçš„ç±»å‹ï¼Œä¿®æ”¹å­—æ®µçš„ç±»å‹å¯èƒ½ä¼šå¯¼è‡´å®¢æˆ·ç«¯å´©æºƒ</li></ul></li><li>ä¿®æ”¹ç°æœ‰è¯·æ±‚çš„å¯è§è¡Œä¸º</li><li>ç»™èµ„æºæ¶ˆæ¯æ·»åŠ  è¯»å–/å†™å…¥ å­—æ®µ</li></ul><h3 id="API-å‘½åè§„èŒƒ"><a href="#API-å‘½åè§„èŒƒ" class="headerlink" title="API å‘½åè§„èŒƒ"></a>API å‘½åè§„èŒƒ</h3><h4 id="åŒ…å"><a href="#åŒ…å" class="headerlink" title="åŒ…å"></a>åŒ…å</h4><table><thead><tr><th>äº§å“å</th><th>product</th></tr></thead><tbody><tr><td>åº”ç”¨å</td><td>app</td></tr><tr><td>ç‰ˆæœ¬å·</td><td>v1</td></tr><tr><td>åŒ…å</td><td>product.app.v1</td></tr><tr><td>ç›®å½•ç»“æ„</td><td>api/product/app/v1/xx.proto</td></tr></tbody></table><h4 id="API-å®šä¹‰"><a href="#API-å®šä¹‰" class="headerlink" title="API å®šä¹‰"></a>API å®šä¹‰</h4><ul><li>å‘½åè§„åˆ™ï¼šæ–¹æ³• + èµ„æº</li><li>æ ‡å‡†æ–¹æ³•ï¼šå‚è€ƒ Google API è®¾è®¡æŒ‡å—</li></ul><table><thead><tr><th><strong>æ ‡å‡†æ–¹æ³•</strong></th><th><strong>HTTP æ˜ å°„</strong></th></tr></thead><tbody><tr><td>List</td><td>GET</td></tr><tr><td>Get</td><td>GET</td></tr><tr><td>Update</td><td>PUT æˆ–è€… PATCH</td></tr><tr><td>Create</td><td>POST</td></tr><tr><td>Delete</td><td>DELETE</td></tr></tbody></table><p>é™¤äº†æ ‡å‡†çš„ä¹Ÿæœ‰ä¸€äº›éæ ‡å‡†çš„ï¼Œä¾‹å¦‚åŒæ­¥æ•°æ®å¯èƒ½ä¼šç”¨ <code>Sync</code>  ç­‰ï¼Œä¸è¿‡å¤§éƒ¨åˆ†çš„ api åº”è¯¥éƒ½æ˜¯æ ‡å‡†çš„</p><h4 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs protobuf"><span class="hljs-comment">// api/product/app/v1/blog.proto</span><br><br>syntax = <span class="hljs-string">&quot;proto3&quot;</span>;<br><br><span class="hljs-keyword">package</span> product.app.v1;<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;google/api/annotations.proto&quot;</span>;<br><br><span class="hljs-comment">// blog service is a blog demo</span><br><span class="hljs-class"><span class="hljs-keyword">service</span> <span class="hljs-title">BlogService</span> </span>&#123;<br><br><span class="hljs-function"><span class="hljs-keyword">rpc</span> GetArticles(GetArticlesReq) <span class="hljs-keyword">returns</span> (GetArticlesResp) </span>&#123;<br><span class="hljs-keyword">option</span> (google.api.http) = &#123;<br>get: <span class="hljs-string">&quot;/v1/articles&quot;</span><br>additional_bindings &#123;<br>get: <span class="hljs-string">&quot;/v1/author/&#123;author_id&#125;/articles&quot;</span><br>&#125;<br>&#125;;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œä¸€èˆ¬è€Œè¨€æˆ‘ä»¬åº”è¯¥ä¸ºæ¯ä¸ªæ¥å£éƒ½åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ messageï¼Œä¸ºäº†åé¢æ‰©å±•ï¼Œå¦‚æœæˆ‘ä»¬ç”¨ Empty çš„è¯åç»­å°±æ²¡æœ‰åŠæ³•æ–°å¢å­—æ®µäº†</p><h3 id="API-Error"><a href="#API-Error" class="headerlink" title="API Error"></a>API Error</h3><h3 id="é”™è¯¯å®šä¹‰"><a href="#é”™è¯¯å®šä¹‰" class="headerlink" title="é”™è¯¯å®šä¹‰"></a>é”™è¯¯å®šä¹‰</h3><p>å…ˆè¯´æˆ‘ä»¬å½“å‰çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¸€ç›´ç”¨çš„ http ç„¶åæˆ‘ä»¬è¿”å›æ˜¯ä½¿ç”¨çš„ä¸‹é¢è¿™ç§æ ¼å¼ï¼Œç„¶å http code ç»Ÿä¸€è¿”å› 200</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;code&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-attr">&quot;msg&quot;</span>: <span class="hljs-string">&quot;xxx&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§åšæ³•å°±å­˜åœ¨ä¸€ä¸ªæ¯”è¾ƒå¤§çš„é—®é¢˜ï¼Œåšç›‘æ§çš„æ—¶å€™ä¸å¤ªå¥½åšï¼Œå¾ˆå¤šç°æˆçš„ä¸œè¥¿æ²¡æœ‰åŠæ³•ç›´æ¥ä½¿ç”¨ï¼Œå› ä¸ºæˆ‘ä»¬éƒ½è¿”å›çš„æˆåŠŸã€‚<br>å‚ç…§ google çš„é”™è¯¯å®šä¹‰ï¼Œå°† http code å’Œ grpc é”™è¯¯ç è¿›è¡Œæ˜ å°„ï¼Œè¿”å›å¯¹åº”çš„é”™è¯¯ä¿¡æ¯<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1614421247833-c0467849-823e-4a22-b53f-95b2705f8c39.png" alt="image.png"><br>ä½†æ˜¯è¿™æ ·è¿˜æ˜¯ä¸è¡Œï¼Œå› ä¸ºè¿™æ ·å¾ˆå¤šä¸šåŠ¡é”™è¯¯ä¿¡æ¯æ— æ³•åŒºåˆ†ï¼Œæ¯›è€å¸ˆä»–ä»¬çš„ kratos v2 çš„åšæ³•æ˜¯åšäº†ä¸¤å±‚ï¼Œä½¿ç”¨ä¸‹é¢çš„æ–¹å¼è¿›è¡Œå®šä¹‰</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs protobuf"><span class="hljs-class"><span class="hljs-keyword">message</span> <span class="hljs-title">Status</span> </span>&#123;<br>  <span class="hljs-comment">// é”™è¯¯ç ï¼Œè·Ÿ grpc-status ä¸€è‡´ï¼Œå¹¶ä¸”åœ¨HTTPä¸­å¯æ˜ å°„æˆ http-status</span><br>  <span class="hljs-built_in">int32</span> code = <span class="hljs-number">1</span>;<br>  <span class="hljs-comment">// é”™è¯¯åŸå› ï¼Œå®šä¹‰ä¸ºä¸šåŠ¡åˆ¤å®šé”™è¯¯ç </span><br>  <span class="hljs-built_in">string</span> reason = <span class="hljs-number">2</span>;<br>  <span class="hljs-comment">// é”™è¯¯ä¿¡æ¯ï¼Œä¸ºç”¨æˆ·å¯è¯»çš„ä¿¡æ¯ï¼Œå¯ä½œä¸ºç”¨æˆ·æç¤ºå†…å®¹</span><br>  <span class="hljs-built_in">string</span> <span class="hljs-class"><span class="hljs-keyword">message</span> = 3;</span><br><span class="hljs-class">  // é”™è¯¯è¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥é™„åŠ è‡ªå®šä¹‰çš„ä¿¡æ¯åˆ—è¡¨</span><br><span class="hljs-class">  <span class="hljs-title">repeated</span> google.protobuf.Any details = 4;</span><br><span class="hljs-class">&#125;</span><br></code></pre></td></tr></table></figure><p>å’Œæˆ‘ä»¬å½“å‰çš„æ–¹å¼å·®ä¸å¤ªå¤šï¼Œä½†æ˜¯æˆ‘ä»¬æ˜¯åœ¨åŸæ¥çš„åŸºç¡€ä¸Šè¿”å›äº† http codeï¼Œå‰©ä¸‹çš„å­—æ®µè¿˜æ˜¯å’ŒåŸæ¥ä¿æŒä¸€è‡´</p><h3 id="é”™è¯¯ä¼ æ’­"><a href="#é”™è¯¯ä¼ æ’­" class="headerlink" title="é”™è¯¯ä¼ æ’­"></a>é”™è¯¯ä¼ æ’­</h3><p>è¿™ä¸€ç‚¹æˆ‘ä»¬ä¹‹å‰åšçš„è¿˜è¡Œï¼Œé”™è¯¯ä¼ æ’­è¿™ä¸€éƒ¨åˆ†å¾ˆå®¹æ˜“å‡ºçš„é—®é¢˜å°±æ˜¯ï¼Œå½“å‰æœåŠ¡ç›´æ¥æŠŠä¸Šæ¸¸æœåŠ¡çš„é”™è¯¯ç»™è¿”å›äº†ï¼Œè¿™æ ·ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ï¼š</p><ul><li>å¦‚æœæˆ‘è°ƒç”¨äº†å¤šä¸ªä¸Šæ¸¸æœåŠ¡éƒ½æŠ¥é”™äº†ï¼Œæˆ‘åº”è¯¥è¿”å›å“ªä¸€ä¸ªé”™è¯¯</li><li>ç›´æ¥è¿”å›å¯¼è‡´å¿…é¡»è¦æœ‰ä¸€ä¸ªå…¨å±€é”™è¯¯ç ï¼Œä¸ç„¶çš„è¯å°±ä¼šå†²çªï¼Œä½†æ˜¯å…¨å±€é”™è¯¯ç æ˜¯å¾ˆéš¾å®šä¹‰çš„</li></ul><p>æ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯æŠŠä¸Šæ¸¸é”™è¯¯ä¿¡æ¯åæ‰ï¼Œè¿”å›å½“å‰æœåŠ¡è‡ªå·±å®šä¹‰çš„é”™è¯¯ä¿¡æ¯å°±å¯ä»¥äº†ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ¯›è€å¸ˆè¯¾ä¸Šè®²çš„ api è®¾è®¡æ€è·¯ç”¨èµ·æ¥è¿˜æ˜¯æŒºçˆ½çš„ï¼Œæˆ‘ä»¬å·²ç»åœ¨ä¸€ä¸ªé¡¹ç›®å½“ä¸­è¿›è¡Œäº†è¯•ç‚¹ï¼Œcicd çš„æµç¨‹ä¹Ÿè·‘äº†èµ·æ¥ï¼Œæœ€çˆ½çš„ä¸€ç‚¹å°±æ˜¯ç»ˆäºä¸ç”¨æ‰¾æ¥å£æ–‡æ¡£äº†ï¼Œç„¶åè¿˜èŠ‚çœäº†ä¸€äº›ä»£ç é‡ï¼Œæˆ‘ä»¬ä¹‹å‰çš„æ¥å£è°ƒç”¨æ–¹å¼éƒ½æ˜¯ååˆ†åŸå§‹çš„ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½è‡ªå·±å»å°è£…ç›¸å…³çš„ sdk ç„¶åæˆ‘ä»¬å¯¹å•å…ƒæµ‹è¯•è¿˜æœ‰è¦æ±‚ï¼Œhttp æ¥å£çš„ mock æ˜¯æŒºéº»çƒ¦çš„äº‹æƒ…ï¼Œé€šè¿‡ protobuf å®šä¹‰æ¥å£ä¹‹åæˆ‘å†™äº†ä¸€ä¸ªç»“åˆå†…éƒ¨ç½‘å…³çš„ sdk ä»£ç ç”Ÿæˆå™¨ï¼Œç›´æ¥ç”Ÿæˆç›¸å…³æ¥å£ä»£ç ï¼Œgo interface çš„ mock å®ç°ä¹Ÿåœ¨ ci æµç¨‹ä¸­ç”Ÿäº§å¥½äº†ï¼Œè°ƒç”¨æ–¹åªéœ€è¦è°ƒç”¨ä¸åŒçš„å®ç°å°±è¡Œäº†ã€‚<br>ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°±é€šè¿‡å†™ä¸€ä¸ª ä» proto ç”Ÿæˆ gin ä»£ç çš„ç”Ÿæˆå™¨æ¥çœ‹çœ‹è¿™ä¸ªä»£ç ç”Ÿæˆå™¨æ”¹å¦‚ä½•å®ç°ã€‚</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go è¿›é˜¶è®­ç»ƒè¥-æå®¢æ—¶é—´</a></li><li><a href="https://github.com/istio/api">GitHub - istio/api: API definitions for the Istio project</a></li><li><a href="https://github.com/envoyproxy/data-plane-api">GitHub - envoyproxy/data-plane-api: [READ ONLY MIRROR] Envoy REST/proto API definitions and documentation.</a></li><li><a href="https://github.com/googleapis/googleapis">GitHub - googleapis/googleapis: Public interface definitions of Google APIs.</a></li><li><a href="https://cloud.google.com/apis/design?hl=zh-cn">API è®¾è®¡æŒ‡å—  |  Google Cloud</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week04: Go å·¥ç¨‹åŒ–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å·¥ç¨‹åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå·¥ç¨‹åŒ–(ä¸‰) ä¾èµ–æ³¨å…¥æ¡†æ¶ wire</title>
    <link href="/post/go-training-week4-wire.html"/>
    <url>/post/go-training-week4-wire.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« å½“ä¸­æˆ‘ä»¬è®²åˆ°äº†é¡¹ç›®çš„ç›®å½•ç»“æ„ï¼Œå¤§ä½“ä¸Šæ°´å¹³åˆ‡åˆ†ä¸ºäº†å››å±‚ï¼Œç„¶åå†æ ¹æ®éœ€è¦è¿›è¡Œå‚ç›´åˆ‡åˆ†ï¼Œç„¶åç”±äºæˆ‘ä»¬å¤§é‡çš„ä½¿ç”¨åˆ°äº†æ¥å£å’Œä¾èµ–æ³¨å…¥çš„æ‰‹æ®µï¼Œæ‰€ä»¥åœ¨é¡¹ç›®åˆå§‹åŒ–çš„æ—¶å€™å¦‚æœæ‰‹åŠ¨è¿›è¡Œä¾èµ–å…³ç³»çš„åˆå§‹åŒ–ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ°ä¾èµ–æ³¨å…¥çš„æ¡†æ¶äº†ã€‚</p><p>åœ¨åˆšå¼€å§‹æ¥è§¦ go çš„é‚£ä¸€æ®µæ—¶é—´ï¼Œæˆ‘æ˜¯æ¯”è¾ƒæ’æ–¥ä½¿ç”¨å¤ªå¤šæ¡†æ¶çš„ï¼Œè§‰å¾—ä¿æŒç®€å•æ›´åŠ é‡è¦ï¼Œè¿™ç§æƒ³æ³•åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼ˆå¤§æ¦‚ä¸¤å¹´å·¦å³ï¼‰éƒ½æ²¡æœ‰é—®é¢˜ï¼Œç›´åˆ°æ­£å¼å·¥ä½œä¸€æ®µæ—¶é—´ä¹‹åå‘ç°ï¼Œéšç€å¼€å‘åˆä½œçš„åŒå­¦çš„å¢å¤šä»¥åŠéƒ¨é—¨çš„è¦æ±‚å¢åŠ ï¼Œé¡¹ç›®å¯åŠ¨æ—¶çš„ä¾èµ–è¶Šæ¥è¶Šå¤šï¼Œä¾èµ–ä¹‹é—´è¿˜æœ‰å…ˆåé¡ºåºï¼Œæœ‰ä¸€äº›ç”šè‡³æ˜¯éšå¼çš„é¡ºåºï¼Œåˆ°æ—¶ main å‡½æ•°çš„ä»£ç è†¨èƒ€çš„éå¸¸è¿…é€Ÿå¹¶ä¸”æ…¢æ…¢çš„å˜çš„ä¸å¯ç»´æŠ¤äº†ï¼Œè¿™ç§æƒ…å†µä¸‹å¼•å…¥ä¾èµ–æ³¨å…¥æ¡†æ¶å…¶å®å¯ä»¥çœå¿ƒå¾ˆå¤šã€‚</p><p>Golang çš„ä¾èµ–æ³¨å…¥æ¡†æ¶æœ‰ä¸¤ç±»ï¼Œä¸€ç±»æ˜¯é€šè¿‡åå°„åœ¨è¿è¡Œæ—¶è¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œå…¸å‹ä»£è¡¨æ˜¯ uber å¼€æºçš„ digï¼Œå¦å¤–ä¸€ç±»æ˜¯é€šè¿‡ generate è¿›è¡Œä»£ç ç”Ÿæˆï¼Œå…¸å‹ä»£è¡¨æ˜¯ Google å¼€æºçš„ wireã€‚ä½¿ç”¨ dig åŠŸèƒ½ä¼šå¼ºå¤§ä¸€äº›ï¼Œä½†æ˜¯ç¼ºç‚¹å°±æ˜¯é”™è¯¯åªèƒ½åœ¨è¿è¡Œæ—¶æ‰èƒ½å‘ç°ï¼Œè¿™æ ·å¦‚æœä¸å°å¿ƒçš„è¯å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›éšè—çš„ bug å‡ºç°ã€‚ä½¿ç”¨ wire çš„ç¼ºç‚¹å°±æ˜¯åŠŸèƒ½é™åˆ¶å¤šä¸€äº›ï¼Œä½†æ˜¯å¥½å¤„å°±æ˜¯ç¼–è¯‘çš„æ—¶å€™å°±å¯ä»¥å‘ç°é—®é¢˜ï¼Œå¹¶ä¸”ç”Ÿæˆçš„ä»£ç å…¶å®å’Œæˆ‘ä»¬è‡ªå·±æ‰‹å†™ç›¸å…³ä»£ç å·®ä¸å¤ªå¤šï¼Œæ›´ç¬¦åˆç›´è§‰ï¼Œå¿ƒæ™ºè´Ÿæ‹…æ›´å°ï¼Œæ‰€ä»¥æˆ‘æ›´åŠ æ¨è wireï¼Œå¦‚æœå¯¹ dig æ„Ÿå…´è¶£å¯ä»¥è·³è½¬åˆ°æ–‡ç« å‚è€ƒæ–‡çŒ®å¤„è·³è½¬æŸ¥é˜…ã€‚</p><p>æœ¬æ–‡åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œé¦–å…ˆä»‹ç» wire çš„ä½¿ç”¨æ–¹æ³•ï¼Œç„¶åæ˜¯ç»“åˆä¸Šä¸€ç¯‡æ–‡ç« ä¸­çš„å·¥ç¨‹ç›®å½•ï¼Œæˆ‘åœ¨ä½¿ç”¨ wire è¿‡ç¨‹ä¸­çš„ä¸€äº› â€œæœ€ä½³å®è·µâ€ é¿å…å¤§å®¶é‡å¤è¸©å‘ã€‚</p><h2 id="wire-ä½¿ç”¨æ•™ç¨‹"><a href="#wire-ä½¿ç”¨æ•™ç¨‹" class="headerlink" title="wire ä½¿ç”¨æ•™ç¨‹"></a>wire ä½¿ç”¨æ•™ç¨‹</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">å¦‚æœä½ å¯¹ wire å·²ç»æ¯”è¾ƒç†Ÿæ‚‰å¯ä»¥ç›´æ¥è·³è¿‡è¿™ä¸€éƒ¨åˆ†ï¼Œé˜…è¯»å®Œæœ¬æ–‡ä¹‹åå»ºè®®å¯¹ç…§çœ‹ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£å†è¿›è¡Œæ“ä½œã€‚<br>æ³¨ï¼šæœ¬æ–‡åŸºäº wire 0.5.0 è¿›è¡Œç¼–å†™</div><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>å®‰è£…å¾ˆç®€å•ï¼Œåªè¦å®‰è£…äº† Go å¹¶ä¸”å·²ç»æŠŠ <code>$GOPATH/bin</code>  åŠ å…¥åˆ°äº† <code>PATH</code>  å½“ä¸­ï¼Œç»ˆç«¯æ‰§è¡Œä¸‹é¢çš„è¯­å¥å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go get github.com/google/wire/cmd/wire<br></code></pre></td></tr></table></figure><h3 id="Provider"><a href="#Provider" class="headerlink" title="Provider"></a>Provider</h3><p>æ­£å¼å¼€å§‹å‰éœ€è¦å…ˆäº†è§£ä¸€ä¸‹ wire å½“ä¸­çš„ä¸¤ä¸ªæ¦‚å¿µï¼šprovider å’Œ injector</p><p>Provider æ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¿”å›æ„å»ºä¾èµ–å…³ç³»æ‰€éœ€çš„ç»„ä»¶ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œå°±æ˜¯ä¸€ä¸ª provider å‡½æ•°ï¼Œåœ¨å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œå¾€å¾€æ˜¯ä¸€äº›ç®€å•çš„å·¥å‚å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸ä¼šå¤ªå¤æ‚ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// NewPostRepo åˆ›å»ºæ–‡ç«  Repo</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPostRepo</span><span class="hljs-params">()</span> <span class="hljs-title">IPostRepo</span></span> &#123;&#125;<br></code></pre></td></tr></table></figure><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯<strong>åœ¨ wire ä¸­ä¸èƒ½å­˜åœ¨ä¸¤ä¸ª provider è¿”å›ç›¸åŒçš„ç»„ä»¶ç±»å‹</strong></p><h3 id="Injector"><a href="#Injector" class="headerlink" title="Injector"></a>Injector</h3><p>injector ä¹Ÿæ˜¯ä¸€ä¸ªæ™®é€šå‡½æ•°ï¼Œæˆ‘ä»¬å¸¸å¸¸åœ¨ <code>wire.go</code>  æ–‡ä»¶ä¸­å®šä¹‰ injector å‡½æ•°ç­¾åï¼Œç„¶åé€šè¿‡ <code>wire</code>  å‘½ä»¤è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//+build wireinject</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetBlogService</span><span class="hljs-params">()</span> *<span class="hljs-title">Blog</span></span> &#123;<br>    <span class="hljs-built_in">panic</span>(wire.Build(NewBlogService, NewPostUsecase, NewPostRepo))<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œçš„ <code>//+build wireinject</code>  æ³¨é‡Šç¡®ä¿äº†è¿™ä¸ªæ–‡ä»¶åœ¨æˆ‘ä»¬æ­£å¸¸ç¼–è¯‘çš„æ—¶å€™ä¸ä¼šè¢«å¼•ç”¨ï¼Œè€Œ <code>wire .</code>  ç”Ÿæˆçš„æ–‡ä»¶ <code>wire_gen.go</code>  ä¼šåŒ…å« <code>//+build !wireinject</code>  æ³¨é‡Šï¼Œæ­£å¸¸ç¼–è¯‘çš„æ—¶å€™ï¼Œä¸æŒ‡å®š tag çš„æƒ…å†µä¸‹ä¼šå¼•ç”¨è¿™ä¸ªæ–‡ä»¶</p><p><code>wire.Build</code>  åœ¨ <code>injector</code>  å‡½æ•°ä¸­ä½¿ç”¨ï¼Œç”¨äºè¡¨åè¿™ä¸ª <code>injector</code>  ç”±å“ªäº› <code>provider</code>  æä¾›ä¾èµ–ï¼Œ <code>injector</code>  å‡½æ•°æœ¬èº«åªæ˜¯ä¸€ä¸ªå‡½æ•°ç­¾åï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥åœ¨å‡½æ•°ä¸­ <code>panic</code>  å®é™…ç”Ÿæˆä»£ç çš„æ—¶å€™å¹¶ä¸ä¼šç›´æ¥è°ƒç”¨ panic</p><h3 id="ä¸€ä¸ªå®Œæ•´çš„-ğŸŒ°"><a href="#ä¸€ä¸ªå®Œæ•´çš„-ğŸŒ°" class="headerlink" title="ä¸€ä¸ªå®Œæ•´çš„ ğŸŒ°"></a>ä¸€ä¸ªå®Œæ•´çš„ ğŸŒ°</h3><h4 id="åŸºæœ¬ç¤ºä¾‹"><a href="#åŸºæœ¬ç¤ºä¾‹" class="headerlink" title="åŸºæœ¬ç¤ºä¾‹"></a>åŸºæœ¬ç¤ºä¾‹</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> example<br><br><span class="hljs-comment">// repo</span><br><br><span class="hljs-comment">// IPostRepo IPostRepo</span><br><span class="hljs-keyword">type</span> IPostRepo <span class="hljs-keyword">interface</span>&#123;&#125;<br><br><span class="hljs-comment">// NewPostRepo NewPostRepo</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPostRepo</span><span class="hljs-params">()</span> <span class="hljs-title">IPostRepo</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(IPostRepo)<br>&#125;<br><br><span class="hljs-comment">// usecase</span><br><br><span class="hljs-comment">// IPostUsecase IPostUsecase</span><br><span class="hljs-keyword">type</span> IPostUsecase <span class="hljs-keyword">interface</span>&#123;&#125;<br><span class="hljs-keyword">type</span> postUsecase <span class="hljs-keyword">struct</span> &#123;<br>repo IPostRepo<br>&#125;<br><br><span class="hljs-comment">// NewPostUsecase NewPostUsecase</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPostUsecase</span><span class="hljs-params">(repo IPostRepo)</span> <span class="hljs-title">IPostUsecase</span></span> &#123;<br><span class="hljs-keyword">return</span> postUsecase&#123;repo: repo&#125;<br>&#125;<br><br><span class="hljs-comment">// service service</span><br><br><span class="hljs-comment">// PostService PostService</span><br><span class="hljs-keyword">type</span> PostService <span class="hljs-keyword">struct</span> &#123;<br>usecase IPostUsecase<br>&#125;<br><br><span class="hljs-comment">// NewPostService NewPostService</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPostService</span><span class="hljs-params">(u IPostUsecase)</span> *<span class="hljs-title">PostService</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;PostService&#123;usecase: u&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œ <code>NewPostService</code> <code>NewPostUsecase</code>  è¿™äº›éƒ½æ˜¯ <code>Provider</code>  å‡½æ•°ï¼Œä¸‹é¢æˆ‘ä»¬åœ¨ <code>wire.go</code>  å½“ä¸­æ„å»º <code>Injector</code>  å‡½æ•°ç­¾å</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//+build wireinject</span><br><br><span class="hljs-keyword">package</span> example<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/google/wire&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPostService</span><span class="hljs-params">()</span> *<span class="hljs-title">PostService</span></span> &#123;<br><span class="hljs-built_in">panic</span>(wire.Build(<br>NewPostService,<br>NewPostUsecase,<br>NewPostRepo,<br>))<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨ç›®å½•ä¸‹æ‰§è¡Œ <code>wire .</code>  ç”Ÿæˆå¦‚ä¸‹æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„å‡½æ•°å’Œæˆ‘ä»¬è‡ªå·±æ‰‹å†™å…¶å®å·®ä¸å¤š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Code generated by Wire. DO NOT EDIT.</span><br><br><span class="hljs-comment">//go:generate wire</span><br><span class="hljs-comment">//+build !wireinject</span><br><br><span class="hljs-keyword">package</span> example<br><br><span class="hljs-comment">// Injectors from wire.go:</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPostService</span><span class="hljs-params">()</span> *<span class="hljs-title">PostService</span></span> &#123;<br>iPostRepo := NewPostRepo()<br>iPostUsecase := NewPostUsecase(iPostRepo)<br>postService := NewPostService(iPostUsecase)<br><span class="hljs-keyword">return</span> postService<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ç¼ºå°‘-provider"><a href="#ç¼ºå°‘-provider" class="headerlink" title="ç¼ºå°‘ provider"></a>ç¼ºå°‘ provider</h4><p>åœ¨æ‰§è¡Œ <code>wire .</code>  çš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬çš„ç¼ºå°‘æŸä¸ª <code>Provider</code>  æä¾›ä¾èµ–ï¼Œwire ä¼šè¿›è¡Œæç¤ºï¼Œå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿæ‰¾åˆ°é—®é¢˜å¹¶ä¸”ä¿®æ”¹<br>è¿˜æ˜¯ä¸Šé¢çš„è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬åˆ é™¤æ‰ä¸€ä¸ª Provider å‡½æ•°è¯•è¯•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPostService</span><span class="hljs-params">()</span> *<span class="hljs-title">PostService</span></span> &#123;<br><span class="hljs-built_in">panic</span>(wire.Build(<br>NewPostService,<br>NewPostUsecase,<br>))<br>&#125;<br></code></pre></td></tr></table></figure><p>å†æ¬¡æ‰§è¡Œ <code>wire</code>  å‘½ä»¤ï¼Œå¯ä»¥å‘ç°æŠ¥é”™</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">â–¶ wire .<br>wire: /Go<span class="hljs-number">-000</span>/Week04/blog/<span class="hljs-number">03</span>_wire/<span class="hljs-number">01</span>_example/wire.<span class="hljs-keyword">go</span>:<span class="hljs-number">7</span>:<span class="hljs-number">1</span>: inject GetPostService: no provider found <span class="hljs-keyword">for</span> github.com/mohuishou/<span class="hljs-keyword">go</span>-training/Week04/blog/<span class="hljs-number">03</span>_wire/<span class="hljs-number">01</span>_example.IPostRepo<br>        needed by github.com/mohuishou/<span class="hljs-keyword">go</span>-training/Week04/blog/<span class="hljs-number">03</span>_wire/<span class="hljs-number">01</span>_example.IPostUsecase in provider <span class="hljs-string">&quot;NewPostUsecase&quot;</span> (/Go<span class="hljs-number">-000</span>/Week04/blog/<span class="hljs-number">03</span>_wire/<span class="hljs-number">01</span>_example/example.<span class="hljs-keyword">go</span>:<span class="hljs-number">22</span>:<span class="hljs-number">6</span>)<br>        needed by *github.com/mohuishou/<span class="hljs-keyword">go</span>-training/Week04/blog/<span class="hljs-number">03</span>_wire/<span class="hljs-number">01</span>_example.PostService in provider <span class="hljs-string">&quot;NewPostService&quot;</span> (/Go<span class="hljs-number">-000</span>/Week04/blog/<span class="hljs-number">03</span>_wire/<span class="hljs-number">01</span>_example/example.<span class="hljs-keyword">go</span>:<span class="hljs-number">34</span>:<span class="hljs-number">6</span>)<br>wire: github.com/mohuishou/<span class="hljs-keyword">go</span>-training/Week04/blog/<span class="hljs-number">03</span>_wire/<span class="hljs-number">01</span>_example: generate failed<br>wire: at least one generate failure<br></code></pre></td></tr></table></figure><h4 id="è¿”å›é”™è¯¯"><a href="#è¿”å›é”™è¯¯" class="headerlink" title="è¿”å›é”™è¯¯"></a>è¿”å›é”™è¯¯</h4><p>åœ¨ go ä¸­å¦‚æœé‡åˆ°é”™è¯¯ï¼Œæˆ‘ä»¬ä¼šåœ¨æœ€åä¸€ä¸ªè¿”å›å€¼è¿”å› errorï¼Œwire åŒæ ·ä¹Ÿæ”¯æŒè¿”å›é”™è¯¯çš„æƒ…å†µï¼Œåªéœ€è¦åœ¨ injector çš„å‡½æ•°ç­¾åä¸­åŠ ä¸Š error è¿”å›å€¼å³å¯ï¼Œè¿˜æ˜¯å‰é¢çš„é‚£ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬è®© <code>NewPostService</code>  è¿”å› errorï¼Œå¹¶ä¸”ä¿®æ”¹ <code>GetPostService</code>  è¿™ä¸ª <code>Injector</code>  å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// example.go</span><br><span class="hljs-comment">// NewPostService NewPostService</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPostService</span><span class="hljs-params">(u IPostUsecase)</span> <span class="hljs-params">(*PostService, error)</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;PostService&#123;usecase: u&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// wire.go</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPostService</span><span class="hljs-params">()</span> <span class="hljs-params">(*PostService, error)</span></span> &#123;<br><span class="hljs-built_in">panic</span>(wire.Build(<br>NewPostService,<br>NewPostUsecase,<br>NewPostRepo,<br>))<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥å‘ç°ä¼šåƒæˆ‘ä»¬è‡ªå·±å†™ä»£ç ä¸€æ ·åˆ¤æ–­ä¸€ä¸‹ <code>if err</code>  ç„¶åè¿”å›</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// wire_gen.go</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPostService</span><span class="hljs-params">()</span> <span class="hljs-params">(*PostService, error)</span></span> &#123;<br>iPostRepo := NewPostRepo()<br>iPostUsecase := NewPostUsecase(iPostRepo)<br>postService, err := NewPostService(iPostUsecase)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">return</span> postService, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ¸…ç†å‡½æ•°"><a href="#æ¸…ç†å‡½æ•°" class="headerlink" title="æ¸…ç†å‡½æ•°"></a>æ¸…ç†å‡½æ•°</h4><p>æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æ‰“å¼€æ–‡ä»¶ï¼Œæˆ–è€…æ˜¯é“¾æ¥è¿™ç§éœ€è¦å…³é—­çš„èµ„æºï¼Œè¿™æ—¶å€™ provider å¯ä»¥è¿”å›ä¸€ä¸ªé—­åŒ…å‡½æ•° <code>func()</code> ï¼Œwire åœ¨è¿›è¡Œæ„å»ºçš„æ—¶å€™ï¼Œä¼šåœ¨æŠ¥é”™çš„æ—¶å€™è°ƒç”¨ï¼Œå¹¶ä¸”ä¼šå°†æ‰€æœ‰çš„é—­åŒ…å‡½æ•°èšåˆè¿”å›ã€‚<br>è¿™ä¸ªç‰¹æ€§ä¸€èˆ¬ç”¨çš„ä¸å¤šï¼Œä½†æ˜¯æœ‰éœ€æ±‚çš„æ—¶å€™ä¼šååˆ†æœ‰ç”¨ã€‚</p><p>è¿˜æ˜¯ä¹‹å‰çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ <code>NewPostRepo</code> <code>NewPostUsecase</code>  è®©ä»–ä»¬è¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// example.go</span><br><br><span class="hljs-comment">// NewPostRepo NewPostRepo</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPostRepo</span><span class="hljs-params">()</span> <span class="hljs-params">(IPostRepo, <span class="hljs-keyword">func</span>()</span>, <span class="hljs-title">error</span>)</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span>(IPostRepo), <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// NewPostUsecase NewPostUsecase</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPostUsecase</span><span class="hljs-params">(repo IPostRepo)</span> <span class="hljs-params">(IPostUsecase, <span class="hljs-keyword">func</span>()</span>, <span class="hljs-title">error</span>)</span> &#123;<br><span class="hljs-keyword">return</span> postUsecase&#123;repo: repo&#125;, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// wire.go</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPostService</span><span class="hljs-params">()</span> <span class="hljs-params">(*PostService, <span class="hljs-keyword">func</span>()</span>, <span class="hljs-title">error</span>)</span> &#123;<br><span class="hljs-built_in">panic</span>(wire.Build(<br>NewPostService,<br>NewPostUsecase,<br>NewPostRepo,<br>))<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>wire .</code>  ä¹‹åæˆ‘ä»¬å¯ä»¥å‘ç°ç”Ÿæˆçš„å‡½æ•°å½“ä¸­ï¼Œå½“ <code>NewPostUsecase</code>  å‡ºç°é”™è¯¯çš„æ—¶å€™ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬è°ƒç”¨ <code>NewPostRepo</code>  è¿”å›çš„ <code>cleanup</code>  å‡½æ•°ï¼Œè€Œ <code>NewPostService</code>  è¿”å›é”™è¯¯ï¼Œä¼šè°ƒç”¨å®ƒä¾èµ–çš„æ‰€æœ‰ provider çš„ cleanup å‡½æ•°ï¼Œå¦‚æœéƒ½æ²¡æœ‰é—®é¢˜ï¼Œå°±ä¼šæŠŠæ‰€æœ‰ cleanup å‡½æ•°èšåˆä¸ºä¸€ä¸ªå‡½æ•°è¿”å›</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPostService</span><span class="hljs-params">()</span> <span class="hljs-params">(*PostService, <span class="hljs-keyword">func</span>()</span>, <span class="hljs-title">error</span>)</span> &#123;<br>iPostRepo, cleanup, err := NewPostRepo()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, err<br>&#125;<br>iPostUsecase, cleanup2, err := NewPostUsecase(iPostRepo)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>cleanup()<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, err<br>&#125;<br>postService, err := NewPostService(iPostUsecase)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>cleanup2()<br>cleanup()<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">return</span> postService, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>cleanup2()<br>cleanup()<br>&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é«˜çº§æ–¹æ³•"><a href="#é«˜çº§æ–¹æ³•" class="headerlink" title="é«˜çº§æ–¹æ³•"></a>é«˜çº§æ–¹æ³•</h3><h4 id="æ¥å£æ³¨å…¥"><a href="#æ¥å£æ³¨å…¥" class="headerlink" title="æ¥å£æ³¨å…¥"></a>æ¥å£æ³¨å…¥</h4><p>æˆ‘ä»¬åº”è¯¥ä¾èµ–æ¥å£ï¼Œè€Œä¸æ˜¯å®ç°ã€‚è¿”å›æ•°æ®çš„æ—¶å€™è¿”å›å®ç°è€Œä¸æ˜¯æ¥å£ï¼Œè¿™æ˜¯åœ¨ Golang ä¸­çš„æœ€ä½³å®è·µï¼ˆå½“ç„¶ä¹Ÿä¸æ˜¯æ‰€æœ‰çš„éƒ½æ˜¯è¿™æ ·ï¼‰ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬çš„ provider è¿”å›äº†å®ç°ï¼Œä½†æ˜¯æˆ‘ä»¬çš„ä¾èµ–çš„æ˜¯æ¥å£ï¼Œè¿™æ—¶å€™å°±ä¼šæŠ¥é”™äº†ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚</p><p>æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ <code>NewPostUsecase</code>  æ–¹æ³•ï¼Œè®©ä»–è¿”å› <code>*PostUsecase</code>  è€Œä¸æ˜¯æ¥å£</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// NewPostUsecase NewPostUsecase</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPostUsecase</span><span class="hljs-params">(repo IPostRepo)</span> <span class="hljs-params">(*PostUsecase, <span class="hljs-keyword">func</span>()</span>, <span class="hljs-title">error</span>)</span> &#123;<br><span class="hljs-keyword">return</span> &amp;PostUsecase&#123;repo: repo&#125;, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ—¶å€™æ‰§è¡Œ <code>wire .</code>  ç”Ÿæˆä»£ç ä¼šå‘ç°æŠ¥é”™ï¼Œæ‰¾ä¸åˆ° <code>IPostUsecase</code>  çš„ provider</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">â–¶ wire .<br>wire: /Go<span class="hljs-number">-000</span>/Week04/blog/<span class="hljs-number">03</span>_wire/<span class="hljs-number">01</span>_example/wire.<span class="hljs-keyword">go</span>:<span class="hljs-number">7</span>:<span class="hljs-number">1</span>: inject GetPostService: no provider found <span class="hljs-keyword">for</span> github.com/mohuishou/<span class="hljs-keyword">go</span>-training/Week04/blog/<span class="hljs-number">03</span>_wire/<span class="hljs-number">01</span>_example.IPostUsecase<br>        needed by *github.com/mohuishou/<span class="hljs-keyword">go</span>-training/Week04/blog/<span class="hljs-number">03</span>_wire/<span class="hljs-number">01</span>_example.PostService in provider <span class="hljs-string">&quot;NewPostService&quot;</span> (/Go<span class="hljs-number">-000</span>/Week04/blog/<span class="hljs-number">03</span>_wire/<span class="hljs-number">01</span>_example/example.<span class="hljs-keyword">go</span>:<span class="hljs-number">36</span>:<span class="hljs-number">6</span>)<br>wire: github.com/mohuishou/<span class="hljs-keyword">go</span>-training/Week04/blog/<span class="hljs-number">03</span>_wire/<span class="hljs-number">01</span>_example: generate failed<br>wire: at least one generate failure<br></code></pre></td></tr></table></figure><p>è¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨ <code>wire.Bind</code>  å°† <code>Struct</code>  å’Œæ¥å£è¿›è¡Œç»‘å®šäº†ï¼Œè¡¨ç¤ºè¿™ä¸ªç»“æ„ä½“å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ <code>injector</code>  å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPostService</span><span class="hljs-params">()</span> <span class="hljs-params">(*PostService, <span class="hljs-keyword">func</span>()</span>, <span class="hljs-title">error</span>)</span> &#123;<br><span class="hljs-built_in">panic</span>(wire.Build(<br>NewPostService,<br>wire.Bind(<span class="hljs-built_in">new</span>(IPostUsecase), <span class="hljs-built_in">new</span>(*PostUsecase)),<br>NewPostUsecase,<br>NewPostRepo,<br>))<br>&#125;<br></code></pre></td></tr></table></figure><p><code>wire.Bind</code>  çš„ä½¿ç”¨æ–¹æ³•å°±æ˜¯ <code>wire.Bind(new(æ¥å£), new(å®ç°))</code></p><h4 id="Struct-å±æ€§æ³¨å…¥"><a href="#Struct-å±æ€§æ³¨å…¥" class="headerlink" title="Struct å±æ€§æ³¨å…¥"></a>Struct å±æ€§æ³¨å…¥</h4><p>åœ¨ä¸Šé¢ <code>NewPostService</code>  ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°æœ‰å¾ˆå¤š <code>Struct</code>  çš„åˆå§‹åŒ–å…¶å®å°±æ˜¯å¡«å……é‡Œé¢çš„å±æ€§ï¼Œæ²¡æœ‰å…¶ä»–çš„é€»è¾‘ï¼Œè¿™ç§æƒ…å†µæˆ‘ä»¬å¯ä»¥å·ç‚¹æ‡’ç›´æ¥ä½¿ç”¨ <code>wire.Struct</code>  æ–¹æ³•ç›´æ¥ç”Ÿæˆ provider</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// structType: ç»“æ„ä½“ç±»å‹</span><br><span class="hljs-comment">// fieldNames: éœ€è¦å¡«å……çš„å­—æ®µï¼Œä½¿ç”¨ &quot;*&quot; è¡¨ç¤ºæ‰€æœ‰å­—æ®µéƒ½éœ€è¦å¡«å……</span><br>Struct(structType <span class="hljs-keyword">interface</span>&#123;&#125;, fieldNames ...<span class="hljs-keyword">string</span>)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ <code>Injector</code>  å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPostService</span><span class="hljs-params">()</span> <span class="hljs-params">(*PostService, <span class="hljs-keyword">func</span>()</span>, <span class="hljs-title">error</span>)</span> &#123;<br><span class="hljs-built_in">panic</span>(wire.Build(<br><span class="hljs-comment">// è¿™é‡Œç”±äºåªæœ‰ä¸€ä¸ªå­—æ®µï¼Œæ‰€ä»¥è¿™ä¸¤ç§æ˜¯ç­‰ä»·çš„ wire.Struct(new(PostService), &quot;*&quot;),</span><br>wire.Struct(<span class="hljs-built_in">new</span>(PostService), <span class="hljs-string">&quot;usecase&quot;</span>),<br>wire.Bind(<span class="hljs-built_in">new</span>(IPostUsecase), <span class="hljs-built_in">new</span>(*PostUsecase)),<br>NewPostUsecase,<br>NewPostRepo,<br>))<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„ä»£ç å½“ä¸­è‡ªåŠ¨å°±ç”Ÿæˆäº†ä¸€ä¸ªç»“æ„ä½“å¹¶ä¸”å¡«å……æ•°æ®äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPostService</span><span class="hljs-params">()</span> <span class="hljs-params">(*PostService, <span class="hljs-keyword">func</span>()</span>, <span class="hljs-title">error</span>)</span> &#123;<br>iPostRepo, cleanup, err := NewPostRepo()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, err<br>&#125;<br>postUsecase, cleanup2, err := NewPostUsecase(iPostRepo)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>cleanup()<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, err<br>&#125;<br>    <span class="hljs-comment">// æ³¨æ„è¿™é‡Œ</span><br>postService := &amp;PostService&#123;<br>usecase: postUsecase,<br>&#125;<br><span class="hljs-keyword">return</span> postService, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>cleanup2()<br>cleanup()<br>&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å€¼ç»‘å®š"><a href="#å€¼ç»‘å®š" class="headerlink" title="å€¼ç»‘å®š"></a>å€¼ç»‘å®š</h4><p>é™¤äº†ä¾èµ–æŸä¸€ä¸ªç±»å‹ä¹‹å¤–ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬è¿˜ä¼šä¾èµ–ä¸€äº›å…·ä½“çš„å€¼ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ <code>wire.Value</code>  æˆ–è€…æ˜¯ <code>wire.InterfaceValue</code> ï¼Œä¸ºæŸä¸ªç±»å‹ç»‘å®šå…·ä½“çš„å€¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// wire.Value ä¸ºæŸä¸ªç±»å‹ç»‘å®šå€¼ï¼Œä½†æ˜¯ä¸èƒ½ä¸ºæ¥å£ç»‘å®šå€¼</span><br>Value(<span class="hljs-keyword">interface</span>&#123;&#125;) ProvidedValue<br><span class="hljs-comment">// wire.InterfaceValue ä¸ºæ¥å£ç»‘å®šå€¼</span><br>InterfaceValue(typ <span class="hljs-keyword">interface</span>&#123;&#125;, x <span class="hljs-keyword">interface</span>&#123;&#125;) ProvidedValue<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ <code>PostService</code>  ä½¿ä»–ä¾èµ–ä¸€ä¸ª int å’Œ io.Reader ç„¶åä¸ºå®ƒç›´æ¥ç»‘å®š <code>a=99</code> <code>io.Reader = os.Stdin</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// example.go</span><br><br><span class="hljs-keyword">type</span> PostService <span class="hljs-keyword">struct</span> &#123;<br>usecase IPostUsecase<br>a       <span class="hljs-keyword">int</span><br>r       io.Reader<br>&#125;<br><br><span class="hljs-comment">// wire.go</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPostService</span><span class="hljs-params">()</span> <span class="hljs-params">(*PostService, <span class="hljs-keyword">func</span>()</span>, <span class="hljs-title">error</span>)</span> &#123;<br><span class="hljs-built_in">panic</span>(wire.Build(<br>wire.Struct(<span class="hljs-built_in">new</span>(PostService), <span class="hljs-string">&quot;*&quot;</span>),<br>wire.Value(<span class="hljs-number">10</span>),<br>wire.InterfaceValue(<span class="hljs-built_in">new</span>(io.Reader), os.Stdin),<br>wire.Bind(<span class="hljs-built_in">new</span>(IPostUsecase), <span class="hljs-built_in">new</span>(*PostUsecase)),<br>NewPostUsecase,<br>NewPostRepo,<br>))<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„ä»£ç å½“ä¸­ç›´æ¥ç”Ÿæˆäº†ä¸¤ä¸ªå…¨å±€å˜é‡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPostService</span><span class="hljs-params">()</span> <span class="hljs-params">(*PostService, <span class="hljs-keyword">func</span>()</span>, <span class="hljs-title">error</span>)</span> &#123;<br>iPostRepo, cleanup, err := NewPostRepo()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, err<br>&#125;<br>postUsecase, cleanup2, err := NewPostUsecase(iPostRepo)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>cleanup()<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, err<br>&#125;<br>int2 := _wireIntValue<br>reader := _wireFileValue<br>postService := &amp;PostService&#123;<br>usecase: postUsecase,<br>a:       int2,<br>r:       reader,<br>&#125;<br><span class="hljs-keyword">return</span> postService, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>cleanup2()<br>cleanup()<br>&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// æ³¨æ„è¿™é‡Œ</span><br><span class="hljs-keyword">var</span> (<br>_wireIntValue  = <span class="hljs-number">10</span><br>_wireFileValue = os.Stdin<br>)<br></code></pre></td></tr></table></figure><h4 id="ProviderSet-Provider-é›†åˆ"><a href="#ProviderSet-Provider-é›†åˆ" class="headerlink" title="ProviderSet(Provider é›†åˆ)"></a>ProviderSet(Provider é›†åˆ)</h4><p>åœ¨çœŸå®çš„é¡¹ç›®å½“ä¸­ä¾èµ–å¾€å¾€æ˜¯ä¸€ç»„ä¸€ç»„çš„ï¼Œå°±åƒæˆ‘ä»¬çš„ç¤ºä¾‹ä¸€æ ·ï¼Œåªè¦ä¾èµ– <code>PostService</code>  é‚£ä¹ˆ <code>NewPostUsecase</code> <code>NewPostRepo</code>  è¿™ä¸¤ä¸ªå°±å¿…ä¸å¯å°‘ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾€å¾€ä¼šåˆ›å»ºä¸€äº› <code>ProviderSet</code>  åœ¨ <code>Injector</code>  å‡½æ•°ä¸­ç›´æ¥ä¾èµ– <code>ProviderSet</code>  å°±å¯ä»¥äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å‚æ•°æ˜¯ä¸€äº› provider</span><br>NewSet(...<span class="hljs-keyword">interface</span>&#123;&#125;) ProviderSet<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼Œç”Ÿæˆä»£ç å’Œä¹‹å‰ä¸€æ ·å°±ä¸å¦å¤–è´´äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// example.go</span><br><br><span class="hljs-comment">// PostServiceSet PostServiceSet</span><br><span class="hljs-keyword">var</span> PostServiceSet = wire.NewSet(<br>wire.Struct(<span class="hljs-built_in">new</span>(PostService), <span class="hljs-string">&quot;*&quot;</span>),<br>wire.Value(<span class="hljs-number">10</span>),<br>wire.InterfaceValue(<span class="hljs-built_in">new</span>(io.Reader), os.Stdin),<br>wire.Bind(<span class="hljs-built_in">new</span>(IPostUsecase), <span class="hljs-built_in">new</span>(*PostUsecase)),<br>NewPostUsecase,<br>NewPostRepo,<br>)<br><br><span class="hljs-comment">// wire.go</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPostService</span><span class="hljs-params">()</span> <span class="hljs-params">(*PostService, <span class="hljs-keyword">func</span>()</span>, <span class="hljs-title">error</span>)</span> &#123;<br><span class="hljs-built_in">panic</span>(wire.Build(<br>PostServiceSet,<br>))<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="wire-ä½¿ç”¨æœ€ä½³å®è·µ"><a href="#wire-ä½¿ç”¨æœ€ä½³å®è·µ" class="headerlink" title="wire ä½¿ç”¨æœ€ä½³å®è·µ"></a>wire ä½¿ç”¨æœ€ä½³å®è·µ</h2><h3 id="ä¸è¦ä½¿ç”¨é»˜è®¤ç±»å‹"><a href="#ä¸è¦ä½¿ç”¨é»˜è®¤ç±»å‹" class="headerlink" title="ä¸è¦ä½¿ç”¨é»˜è®¤ç±»å‹"></a>ä¸è¦ä½¿ç”¨é»˜è®¤ç±»å‹</h3><p>ä¹‹å‰æœ‰æåˆ°è¿‡ï¼Œwire ä¸æ”¯æŒä¸¤ä¸ªæä¾›ä¸¤ä¸ªç›¸åŒç±»å‹çš„ providerï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬ä½¿ç”¨é»˜è®¤ç±»å‹å¦‚ <code>int</code> <code>string</code>  ç­‰ï¼Œåªè¦æœ‰ä¸¤ä¸ªä¾èµ–å°±ä¼šå¯¼è‡´æŠ¥é”™ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ç±»å‹åˆ«åã€‚<br>å…ˆæ¥çœ‹ä¸€ä¸ªæŠ¥é”™çš„ç¤ºä¾‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> PostService <span class="hljs-keyword">struct</span> &#123;<br>usecase IPostUsecase<br>a       <span class="hljs-keyword">int</span><br>b       <span class="hljs-keyword">int</span><br>r       io.Reader<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œwire åœ¨æ„å»ºä¾èµ–å…³ç³»çš„æ—¶å€™ï¼Œå¹¶ä¸çŸ¥é“ int çš„å€¼è¯¥åˆ†é…ç»™ a è¿˜æ˜¯ b æ‰€ä»¥å°±ä¼šæŠ¥é”™</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">â–¶ wire .<br>wire: /Go<span class="hljs-number">-000</span>/Week04/blog/<span class="hljs-number">03</span>_wire/<span class="hljs-number">01</span>_example/example.<span class="hljs-keyword">go</span>:<span class="hljs-number">40</span>:<span class="hljs-number">2</span>: provider <span class="hljs-keyword">struct</span> has multiple fields of <span class="hljs-keyword">type</span> <span class="hljs-keyword">int</span><br>wire: github.com/mohuishou/<span class="hljs-keyword">go</span>-training/Week04/blog/<span class="hljs-number">03</span>_wire/<span class="hljs-number">01</span>_example: generate failed<br>wire: at least one generate failure<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è‡ªå®šä¹‰ä¸¤ä¸ªç±»å‹å°±å¥½äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> A <span class="hljs-keyword">int</span><br><span class="hljs-keyword">type</span> B <span class="hljs-keyword">int</span><br><br><span class="hljs-comment">// PostService PostService</span><br><span class="hljs-keyword">type</span> PostService <span class="hljs-keyword">struct</span> &#123;<br>usecase IPostUsecase<br>a       A<br>b       B<br>r       io.Reader<br>&#125;<br><br><span class="hljs-comment">// PostServiceSet PostServiceSet</span><br><span class="hljs-keyword">var</span> PostServiceSet = wire.NewSet(<br>wire.Struct(<span class="hljs-built_in">new</span>(PostService), <span class="hljs-string">&quot;*&quot;</span>),<br>wire.Value(A(<span class="hljs-number">10</span>)),<br>wire.Value(B(<span class="hljs-number">10</span>)),<br>wire.InterfaceValue(<span class="hljs-built_in">new</span>(io.Reader), os.Stdin),<br>wire.Bind(<span class="hljs-built_in">new</span>(IPostUsecase), <span class="hljs-built_in">new</span>(*PostUsecase)),<br>NewPostUsecase,<br>NewPostRepo,<br>)<br></code></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼åœ¨ä½¿ç”¨ä¸Šä¼šæ„Ÿè§‰æœ‰ç‚¹ç³Ÿå¿ƒï¼Œä½†æ˜¯å°±æˆ‘ç›®å‰çš„ä½¿ç”¨æ¥çœ‹ï¼Œç”¨åˆ°åŸºç¡€ç±»å‹çš„æƒ…å†µè¿˜æ˜¯æ¯”ä»·å°‘ï¼Œæ‰€ä»¥ä¹Ÿè¿˜å¥½</p><h3 id="Option-Struct"><a href="#Option-Struct" class="headerlink" title="Option Struct"></a>Option Struct</h3><p>åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯å½“ä¸­æˆ‘ä»¬çš„ <code>NewXXX</code>  å‡½æ•°çš„å‚æ•°åˆ—è¡¨å¯èƒ½ä¼šå¾ˆé•¿ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç›´æ¥å®šä¹‰ä¸€ä¸ª Option Struct ç„¶åä½¿ç”¨ <code>wire.Strcut</code>  æ¥æ„å»º Option Strcut çš„ä¾èµ–</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// PostUsecaseOption PostUsecaseOption</span><br><span class="hljs-keyword">type</span> PostUsecaseOption <span class="hljs-keyword">struct</span> &#123;<br>a    A<br>b    B<br>repo IPostRepo<br>&#125;<br><br><span class="hljs-comment">// NewPostUsecase NewPostUsecase</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPostUsecase</span><span class="hljs-params">(opt *PostUsecaseOption)</span> <span class="hljs-params">(*PostUsecase, <span class="hljs-keyword">func</span>()</span>, <span class="hljs-title">error</span>)</span> &#123;<br><span class="hljs-keyword">return</span> &amp;PostUsecase&#123;repo: opt.repo&#125;, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// PostServiceSet PostServiceSet</span><br><span class="hljs-keyword">var</span> PostServiceSet = wire.NewSet(<br>wire.Struct(<span class="hljs-built_in">new</span>(PostService), <span class="hljs-string">&quot;*&quot;</span>),<br>wire.Value(A(<span class="hljs-number">10</span>)),<br>wire.Value(B(<span class="hljs-number">10</span>)),<br>wire.InterfaceValue(<span class="hljs-built_in">new</span>(io.Reader), os.Stdin),<br><br>    <span class="hljs-comment">// for usecase</span><br>    wire.Bind(<span class="hljs-built_in">new</span>(IPostUsecase), <span class="hljs-built_in">new</span>(*PostUsecase)),<br>wire.Struct(<span class="hljs-built_in">new</span>(PostUsecaseOption), <span class="hljs-string">&quot;*&quot;</span>),<br>NewPostUsecase,<br><br>    NewPostRepo,<br>)<br><br></code></pre></td></tr></table></figure><h3 id="é¡¹ç›®ç›®å½•ç»“æ„"><a href="#é¡¹ç›®ç›®å½•ç»“æ„" class="headerlink" title="é¡¹ç›®ç›®å½•ç»“æ„"></a>é¡¹ç›®ç›®å½•ç»“æ„</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">.<br>â”œâ”€â”€ api<br>â”œâ”€â”€ cmd<br>â”‚   â””â”€â”€ app<br>â”‚       â”œâ”€â”€ main.go<br>â”‚       â”œâ”€â”€ wire.go<br>â”‚       â””â”€â”€ wire_gen.go<br>â””â”€â”€ internal<br>    â”œâ”€â”€ domain<br>    â”‚   â””â”€â”€ post.go<br>    â”œâ”€â”€ repo<br>    â”‚   â””â”€â”€ repo.go<br>    â”œâ”€â”€ service<br>    â”‚   â””â”€â”€ service.go<br>    â”œâ”€â”€ usecase<br>    â”‚   â””â”€â”€ usecase.go<br>    â””â”€â”€ wire_set.go<br></code></pre></td></tr></table></figure><ul><li>ä¸€èˆ¬åœ¨ cmd/xxx ç›®å½•ä¸‹åˆ›å»º <code>wire.go</code>  ç”¨äºæ„å»º <code>injector</code>  å‡½æ•°ç­¾åï¼Œå› ä¸ºæˆ‘ä»¬ä¸€èˆ¬ä¼šåœ¨ <code>main</code>  å½“ä¸­æ„å»ºä¾èµ–å…³ç³»å®ŒæˆæœåŠ¡å¯åŠ¨</li><li>åœ¨ internal æˆ–è€…æ˜¯ internal/app ç›®å½•ä¸‹åˆ›å»º <code>wire_set.go</code>  æ„å»º <code>ProviderSet</code> ï¼Œè¿™é‡Œè¦æ³¨æ„<ul><li>è¿™é‡Œçš„ <code>ProviderSet</code>  ä¸­çš„ <code>Provider</code>  å‡½æ•°åªèƒ½æ˜¯å½“å‰ç›®å½•ä¸‹åˆ›å»ºçš„ Provider å‡½æ•°</li><li>ä¾‹å¦‚å¯èƒ½å­˜åœ¨ usecase å’Œ repo éƒ½ä¾èµ– config å¦‚æœ repo åˆ›å»ºä¸€ä¸ª ProviderSet åŒ…å« <code>NewConfig</code> ï¼Œusecase ä¹Ÿæ¥ä¸€ä¸ªï¼Œå°±ä¼šå¯¼è‡´åœ¨ <code>wire .</code>  ç”Ÿæˆä»£ç çš„æ—¶å€™æŠ¥é”™ï¼Œå› ä¸ºæœ‰å†²çªï¼ŒåŒä¸€ä¸ªç»„ä»¶æœ‰ä¸¤ä¸ª Provider</li></ul></li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡è¯¦ç»†çš„ä»‹ç»äº† wire çš„ä½¿ç”¨æ–¹æ³•å’Œä¸€äº›å­˜åœ¨çš„å‘ï¼Œé¿å…å¤§å®¶é‡å¤è¸©å‘ï¼ŒåŒæ—¶ç»“åˆä¸Šä¸€ç¯‡æ–‡ç« å½“ä¸­çš„é¡¹ç›®ç»“æ„ç»™å‡ºäº†ä¸€ç§å®è·µæ–¹å¼ã€‚ä¾èµ–æ³¨å…¥è¿™ä¸ªä¸œè¥¿å¦‚æœåªæ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„åº”ç”¨å¹¶ä¸”è¿™ä¸ªåº”ç”¨çš„å¼€å‘åŒå­¦æ¯”è¾ƒå°‘ï¼Œå¯ä»¥ä¸ç”¨å¼•å…¥ï¼Œå¼•å…¥ä¾èµ–æ³¨å…¥çš„æ¡†æ¶è¿˜æ˜¯ä¼šå¸¦æ¥ä¸€äº›å¤æ‚æ€§å’Œå­¦ä¹ æˆæœ¬ï¼Œä½†æ˜¯å¦‚æœè¿™ä¸ªé¡¹ç›®æœ‰å¾ˆå¤šåŒå­¦åœ¨åä½œå¼€å‘ï¼Œå¹¶ä¸”éƒ¨é—¨è¦æ±‚çš„ä¾èµ–ç»„ä»¶æ¯”è¾ƒå¤šçš„æ—¶å€™è¿˜æ˜¯éœ€è¦å¼•å…¥çš„ï¼Œéšç€é¡¹ç›®ä»£ç çš„è†¨èƒ€ä¼šå¯¼è‡´åé¢ä¾èµ–ç®¡ç†çš„ç®¡ç†è¶Šæ¥è¶Šå¤æ‚ï¼Œå¦‚æœæƒ³è¦åšä¸€ç‚¹ç‚¹é‡æ„ä¼šå¸¦æ¥å¾ˆå¤šéº»çƒ¦ã€‚</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go è¿›é˜¶è®­ç»ƒè¥-æå®¢æ—¶é—´</a></li><li><a href="https://github.com/uber-go/dig">GitHub - uber-go/dig: A reflection based dependency injection toolkit for Go.</a></li><li><a href="https://github.com/google/wire">GitHub - google/wire: Compile-time Dependency Injection for Go</a></li><li><a href="https://medium.com/@dche423/master-wire-cn-d57de86caa1b">https://medium.com/@dche423/master-wire-cn-d57de86caa1b</a></li><li><a href="https://juejin.cn/post/6844903901469097998#heading-7">Golang ä¾èµ–æ³¨å…¥æ¡†æ¶ wire å…¨æ”»ç•¥</a></li><li><a href="https://blog.golang.org/wire">Compile-time Dependency Injection With Go Cloudâ€™s Wire - The Go Blog</a></li><li><a href="https://github.com/golang/go/wiki/CodeReviewComments#interfaces">https://github.com/golang/go/wiki/CodeReviewComments#interfaces</a></li></ol><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°"><a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°</h2><p>çœ‹åˆ°è¿™é‡Œäº†è¿˜ä¸å…³æ³¨ç‚¹èµèµ°ä¸€æ³¢</p><ul><li><a href="https://lailin.xyz">åšå®¢</a> å¯ä»¥è®¢é˜… RSSï¼Œä¹Ÿå¯ä»¥ç‚¹å‡»é¦–é¡µé€šè¿‡ webpush è®¢é˜…æµè§ˆå™¨æ¶ˆæ¯é€šçŸ¥</li><li><a href="https://github.com/mohuishou">Github</a> Follow me</li><li><a href="https://www.zhihu.com/people/mo-hui-shou-76">çŸ¥ä¹</a> å…³æ³¨è´¦å·ï¼Œé¡ºä¾¿ç‚¹ä¸ª ğŸ‘</li><li><a href="https://toutiao.io/subjects/387401?f=new">å¼€å‘è€…å¤´æ¡</a> è®¢é˜…è®¢é˜…å·ï¼Œé¡ºä¾¿ç‚¹ä¸ª ğŸ‘</li></ul><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week04: Go å·¥ç¨‹åŒ–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å·¥ç¨‹åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå·¥ç¨‹åŒ–(äºŒ) é¡¹ç›®ç›®å½•ç»“æ„</title>
    <link href="/post/go-training-week4-project-layout.html"/>
    <url>/post/go-training-week4-project-layout.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p>å·¥ç¨‹åŒ–è¿™ä¸€èŠ‚è¯´ç®€å•çœ‹ä¼¼ç®€å•ï¼Œæ— éå°±æ˜¯ç›®å½•ç»“æ„ï¼Œä»£ç åˆ†å±‚ï¼Œä¾èµ–æ³¨å…¥ç­‰ç­‰ã€‚ä½†æ˜¯å…¶ä¸­å¾ˆå¤šå‘å¦‚æœæ²¡è¸©è¿‡æ˜¯ä¸çŸ¥é“è¿™é‡Œé¢çš„ç—›ç‚¹çš„ã€‚é™¤æ­¤ä¹‹å¤–è¿™é‡Œé¢ä¹Ÿä¼šæœ‰å¾ˆå¤šæ¶æ„çš„æ€æƒ³åœ¨é‡Œé¢ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä¼šæŠŠæ¶æ„æ•´æ´ä¹‹é“çš„é˜…è¯»ç¬”è®°æ”¾åœ¨ç¬¬ä¸€å°èŠ‚çš„åŸå› ã€‚</p><p>æ¥æ¥ä¸‹åŒ…å«è¿™ä¸€ç¯‡æ–‡ç« åœ¨å†…ï¼Œæˆ‘ä¼šå…ˆç”¨å‡ ç¯‡æ–‡ç« ç»“åˆå‚è€ƒææ–™ä»¥åŠä¸ªäººçš„ç†è§£æ•´ç†ä¸€ä¸‹æ¯›è€å¸ˆè¯¾ä¸Šè®²çš„å†…å®¹ã€‚ç„¶åæ°å¥½åœ¨è¿™ä¸ªè¯¾ç¨‹å‰ï¼Œæˆ‘ä¹Ÿåœ¨å¯¹æˆ‘ä»¬ä¹‹å‰çš„ä¸€äº›é¡¹ç›®åšé‡æ„ï¼Œæ‰€ä»¥ä¼šå†ç”¨ä¸€åˆ°ä¸¤ç¯‡æ–‡ç« å¤§æ¦‚è¯´ä¸€äº›æˆ‘æœ€åé€‰æ‹©çš„æ–¹å¼ï¼Œå·²ç»åœ¨å®è·µè¿‡ç¨‹ä¸­çš„ä¸€äº›å–èˆï¼Œå°±å·¥ç¨‹åŒ–è¿™ä¸ªäº‹æƒ…æ¥è¯´å¤§æ¦‚åŸç†ä¸ŠåŸºæœ¬éƒ½æ˜¯ç›¸é€šçš„ï¼Œä½†æ˜¯æ¯ä¸ªå›¢é˜Ÿç”šè‡³æ¯ä¸ªäººæ‰€é¢ä¸´çš„ä¸€äº›é—®é¢˜éƒ½å„ä¸ç›¸åŒï¼Œæ‰€ä»¥æœ€åå‡ºæ¥çš„ä¸œè¥¿è‚¯å®šä¸æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚</p><div style="background: #FFFBE6;padding:10px;border: 1px solid #C3C3C3;border-radius:5px;margin-bottom:5px;">æ³¨æ„ï¼Œä½ å¦‚æœæ˜¯åªæ˜¯éœ€è¦å†™ä¸€ä¸ªè„šæœ¬ï¼Œæˆ–è€…æ˜¯åšä¸€äº›ç®€å•çš„ demo å¤§å¯ä¸å¿…åƒæ–‡ç« æ¥ä¸‹æ¥ä»‹ç»çš„è¿™æ ·æçš„è¿™ä¹ˆéº»çƒ¦ï¼Œç›´æ¥ä¸€ä¸ª main.go ç®€å•å¿«æ·æ–¹ä¾¿å³å¯ï¼Œä½†æ˜¯å¦‚æœä½ è¿™æ˜¯ä¸€ä¸ªé•¿æœŸç»´æŠ¤çš„é¡¹ç›®ï¼Œç”šè‡³æ¶‰åŠåˆ°çš„å¤šä¸ªäººä¹‹é—´çš„åˆä½œï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„å‡ ç¯‡æ–‡ç« å°±ä¸èƒ½é”™è¿‡äº†ï¼Œå¯ä»¥ä»”ç»†é˜…è¯»ï¼Œå¸Œæœ›å¯ä»¥å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚</div><h2 id="Standard-Go-Project-Layout"><a href="#Standard-Go-Project-Layout" class="headerlink" title="Standard Go Project Layout"></a>Standard Go Project Layout</h2><p>è¿™ä¸€éƒ¨åˆ†çš„å†…å®¹ä¸»è¦æ¥è‡ªäº github çš„é«˜æ˜Ÿé¡¹ç›®ï¼š<a href="https://github.com/golang-standards/project-layout/blob/master/README_zh.md">golang-standards/project-layout</a> é€šè¿‡è¿™ä¸ªæˆ‘ä»¬å¯ä»¥å¤§æ¦‚çš„äº†è§£åˆ°åœ¨ Go ä¸­ä¸€äº›çº¦å®šä¿—æˆçš„ç›®å½•å«ä¹‰ï¼Œè™½ç„¶è¿™äº›ä¸æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œä½†æ˜¯å¦‚æœæœ‰å»çœ‹å®˜æ–¹çš„æºç æˆ–è€…æ˜¯ä¸€äº›çŸ¥åçš„é¡¹ç›®å¯ä»¥å‘ç°å¤§å¤šéƒ½æ˜¯è¿™ä¹ˆå‘½åçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€å¥½å’Œç¤¾åŒºä¿æŒä¸€è‡´ï¼Œå¤§å®¶ä¿æŒåŒæ ·çš„è¯­è¨€ã€‚</p><h3 id="cmd"><a href="#cmd" class="headerlink" title="/cmd"></a>/cmd</h3><p>æˆ‘ä»¬ä¸€èˆ¬é‡‡ç”¨ <code>/cmd/[appname]/main.go</code>  çš„å½¢å¼è¿›è¡Œç»„ç»‡</p><ul><li>é¦–å…ˆ cmd ç›®å½•ä¸‹ä¸€èˆ¬æ˜¯é¡¹ç›®çš„ä¸»å¹²ç›®å½•</li><li>è¿™ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶<strong>ä¸åº”è¯¥æœ‰å¤ªå¤šçš„ä»£ç ï¼Œä¸åº”è¯¥åŒ…å«ä¸šåŠ¡é€»è¾‘</strong></li><li>main.go å½“ä¸­ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯è´Ÿè´£ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸï¼ŒæœåŠ¡æ‰€éœ€èµ„æºçš„ä¾èµ–æ³¨å…¥ç­‰ï¼Œå…¶ä¸­ä¾èµ–æ³¨å…¥ä¸€èˆ¬è€Œè¨€æˆ‘ä»¬ä¼šä½¿ç”¨ä¸€ä¸ªä¾èµ–æ³¨å…¥æ¡†æ¶ï¼Œè¿™ä¸ªä¸»è¦çœ‹å¤æ‚ç¨‹åº¦ï¼Œåç»­ä¼šæœ‰ä¸€ç¯‡æ–‡ç« å•ç‹¬ä»‹ç»è¿™ä¸ª</li></ul><h3 id="internal"><a href="#internal" class="headerlink" title="/internal"></a>/internal</h3><p>internal ç›®å½•ä¸‹çš„åŒ…ï¼Œä¸å…è®¸è¢«å…¶ä»–é¡¹ç›®ä¸­è¿›è¡Œå¯¼å…¥ï¼Œè¿™æ˜¯åœ¨ Go 1.4 å½“ä¸­å¼•å…¥çš„ featureï¼Œä¼šåœ¨ç¼–è¯‘æ—¶æ‰§è¡Œ</p><ul><li>æ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ä¼šæŠŠé¡¹ç›®æ–‡ä»¶å¤¹æ”¾ç½®åˆ° internal å½“ä¸­ï¼Œä¾‹å¦‚ <code>/internal/app</code></li><li>å¦‚æœæ˜¯å¯ä»¥è¢«å…¶ä»–é¡¹ç›®å¯¼å…¥çš„åŒ…æˆ‘ä»¬ä¸€èˆ¬ä¼šæ”¾åˆ° pkg ç›®å½•ä¸‹</li><li>å¦‚æœæ˜¯æˆ‘ä»¬é¡¹ç›®å†…éƒ¨è¿›è¡Œå…±äº«çš„åŒ…ï¼Œè€Œä¸æœŸæœ›å¤–éƒ¨å…±äº«ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾åˆ° <code>/internal/pkg</code>  å½“ä¸­</li><li>æ³¨æ„ internal ç›®å½•çš„é™åˆ¶å¹¶ä¸å±€é™äºé¡¶çº§ç›®å½•ï¼Œåœ¨ä»»ä½•ç›®å½•å½“ä¸­éƒ½æ˜¯ç”Ÿæ•ˆçš„</li></ul><p>ä¸¾ä¸ª ğŸŒ° ä¸‹é¢çš„æ˜¯æˆ‘ä»¬å½“å‰çš„ç›®å½•ç»“æ„ï¼Œå…¶ä¸­çš„ä»£ç å¾ˆç®€å•ï¼Œåœ¨ <code>t.go</code>  å½“ä¸­å¯¼å‡ºäº†ä¸€ä¸ªå˜é‡ <code>I</code>  ç„¶ååœ¨ <code>a/cmd/a/main.go</code>  å’Œ <code>b/cmd/b/main.go</code>  å½“ä¸­åˆ†åˆ«å¯¼å…¥è¾“å‡ºè¿™ä¸ªå˜é‡çš„å€¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go">â¯ tree<br>.<br>â”œâ”€â”€ a<br>â”‚   â”œâ”€â”€ cmd<br>â”‚   â”‚   â””â”€â”€ a<br>â”‚   â”‚       â””â”€â”€ main.<span class="hljs-keyword">go</span><br>â”‚   â””â”€â”€ internal<br>â”‚       â””â”€â”€ pkg<br>â”‚           â””â”€â”€ t<br>â”‚               â””â”€â”€ t.<span class="hljs-keyword">go</span><br>â””â”€â”€ b<br>    â””â”€â”€ cmd<br>        â””â”€â”€ b<br>            â””â”€â”€ main.<span class="hljs-keyword">go</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ <code>a</code>  ç›®å½•ä¸‹å¯ä»¥ç›´æ¥è¾“å‡º <code>I</code>  çš„å€¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">â¯ <span class="hljs-keyword">go</span> run ./a/cmd/a/main.<span class="hljs-keyword">go</span><br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨ <code>b</code>  ç›®å½•ä¸‹ï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥æŠ¥é”™è¯´å¯¼å…¥äº† <code>a</code>  çš„ç§æœ‰åŒ…</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">â¯ <span class="hljs-keyword">go</span> run ./b/cmd/b/main.<span class="hljs-keyword">go</span><br><span class="hljs-keyword">package</span> command-line-arguments<br>        b/cmd/b/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">3</span>:<span class="hljs-number">8</span>: use of internal <span class="hljs-keyword">package</span> github.com/mohuishou/<span class="hljs-keyword">go</span>-training/Week04/blog/<span class="hljs-number">02</span>_project_layout/<span class="hljs-number">01</span>_internal_example/a/internal/pkg/t not allowed<br></code></pre></td></tr></table></figure><h3 id="pkg"><a href="#pkg" class="headerlink" title="/pkg"></a>/pkg</h3><p>ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬åœ¨ pkg ç›®å½•ä¸‹æ”¾ç½®å¯ä»¥è¢«å¤–éƒ¨ç¨‹åºå®‰å…¨å¯¼å…¥çš„åŒ…ï¼Œå¯¹äºä¸åº”è¯¥è¢«å¤–éƒ¨ç¨‹åºä¾èµ–çš„åŒ…æˆ‘ä»¬åº”è¯¥æ”¾ç½®åˆ° <code>internal</code>  ç›®å½•ä¸‹ï¼Œ <code>internal</code>  ç›®å½•ä¼šæœ‰ç¼–è¯‘å™¨è¿›è¡Œå¼ºåˆ¶éªŒè¯</p><ul><li>pkg ç›®å½•ä¸‹çš„åŒ…ä¸€èˆ¬ä¼šæŒ‰ç…§åŠŸèƒ½è¿›è¡ŒåŒºåˆ†ï¼Œä¾‹å¦‚ <code>/pkg/cache</code> ã€ <code>/pkg/conf</code>  ç­‰</li><li>å¦‚æœä½ çš„ç›®å½•ç»“æ„æ¯”è¾ƒç®€å•ï¼Œå†…å®¹ä¹Ÿæ¯”è¾ƒå°‘ï¼Œå…¶å®ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨ <code>pkg</code>  ç›®å½•ï¼Œç›´æ¥æŠŠä¸Šé¢çš„è¿™äº›åŒ…æ”¾åœ¨æœ€ä¸Šå±‚å³å¯</li><li>ä¸€èˆ¬è€Œè¨€æˆ‘ä»¬åº”ç”¨ç¨‹åº app åœ¨æœ€å¤–å±‚ä¼šåŒ…å«å¾ˆå¤šæ–‡ä»¶ï¼Œä¾‹å¦‚ <code>.gitlab-ci.yml</code>  <code>makefile</code>  <code>.gitignore</code>  ç­‰ç­‰ï¼Œè¿™ç§æ—¶å€™é¡¶å±‚ç›®å½•ä¼šå¾ˆå¤šå¹¶ä¸”ä¼šæœ‰ç‚¹æ‚ä¹±ï¼Œå»ºè®®è¿˜æ˜¯æ”¾åˆ° <code>/pkg</code>  ç›®å½•æ¯”è¾ƒå¥½</li></ul><h2 id="Kit-Project-Layout"><a href="#Kit-Project-Layout" class="headerlink" title="Kit Project Layout"></a>Kit Project Layout</h2><p>kit åº“å…¶å®ä¹Ÿå°±æ˜¯ä¸€äº›åŸºç¡€åº“</p><ul><li>æ¯ä¸€ä¸ªå…¬å¸æ­£å¸¸æ¥è¯´åº”è¯¥<strong>æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªåŸºç¡€åº“é¡¹ç›®</strong></li><li>kit åº“ä¸€èˆ¬ä¼šåŒ…å«ä¸€äº›å¸¸ç”¨çš„å…¬å…±çš„æ–¹æ³•ï¼Œä¾‹å¦‚ç¼“å­˜ï¼Œé…ç½®ç­‰ç­‰ï¼Œæ¯”è¾ƒå…¸å‹çš„ä¾‹å­å°±æ˜¯ <a href="https://github.com/go-kit/kit">go-kit</a></li><li>kit åº“å¿…é¡»å…·æœ‰çš„ç‰¹ç‚¹ï¼š<ul><li>ç»Ÿä¸€</li><li>æ ‡å‡†åº“æ–¹å¼å¸ƒå±€</li><li>é«˜åº¦æŠ½è±¡</li><li>æ”¯æŒæ’ä»¶</li><li>å°½é‡å‡å°‘ä¾èµ–</li><li>æŒç»­ç»´æŠ¤</li></ul></li></ul><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">å‡å°‘ä¾èµ–å’ŒæŒç»­ç»´æŠ¤æ˜¯æˆ‘åé¢è¡¥å……çš„ï¼Œè¿™ä¸€ç‚¹å…¶å®å¾ˆé—æ†¾ï¼Œæˆ‘ä»¬éƒ¨é—¨åˆšè¿›æ¥çš„æ—¶å€™æ–¹å‘æ˜¯å¯¹çš„ä¹Ÿå»ºç«‹äº†ä¸€å¥—åŸºç¡€åº“ï¼Œç„¶åå¤§å®¶éƒ½ä½¿ç”¨è¿™åŒä¸€å¥—åº“ï¼Œä½†æ˜¯å¾ˆé—æ†¾ï¼Œæˆ‘ä»¬è¿™ä¸€å¥—åº“ä¸€æ˜¯æ²¡äººç»´æŠ¤ï¼ŒäºŒæ˜¯æ²¡æœ‰ä¸€å¥—æœºåˆ¶æ¥è¿›è¡Œè¿­ä»£ï¼Œåˆ°ç°åœ¨å¾ˆå¤šå›¢é˜Ÿå’Œé¡¹ç›®å·²ç»å„æå„çš„äº†ã€‚<br>è¿™æ ·å…¶å®ä¼šå¯¼è‡´åšå¾ˆå¤šé‡å¤å·¥ä½œä»¥åŠåç»­çš„ä¸€äº›æ”¹åŠ¨å¾ˆéš¾æ¨è¿›ï¼Œå‰è½¦ä¹‹é‰´ï¼Œå¦‚æœæœ‰ç±»ä¼¼çš„æƒ…å†µä¸€å®šè¦åœ¨å°ç«è‹—å‡ºæ¥çš„æ—¶å€™å…ˆæ‘ä½ï¼Œä»å¤§çš„è§’åº¦æ¥è®²ç»Ÿä¸€æœ‰æ—¶å€™æ¯”å¥½ç”¨é‡è¦ï¼Œä¸å¥½ç”¨åº”è¯¥å‚ä¸è´¡çŒ®è€Œä¸æ˜¯å¦èµ·ç‚‰ç¶ã€‚</div><h2 id="Service-Application-Project-Layout"><a href="#Service-Application-Project-Layout" class="headerlink" title="Service Application Project Layout"></a>Service Application Project Layout</h2><p>åœ¨è¿™ä¸€å°èŠ‚æˆ‘ä»¬ä¼šå…ˆçœ‹åˆ°æ¯›è€å¸ˆåœ¨è¯¾ä¸Šè®²è§£çš„ä»–ä»¬çš„åº”ç”¨ç¨‹åºç›®å½•çš„è¿­ä»£å˜åŒ–ï¼Œç„¶åè¯´ä¸€äº›æˆ‘æœ€åçš„é‡‡ç”¨çš„ç›®å½•ç»“æ„ä»¥åŠé‡Œé¢çš„å–èˆï¼Œå…³äºå…·ä½“æ€ä¹ˆæ¼”è¿›æ¥çš„å½“ä¸­é‡åˆ°äº†ä»€ä¹ˆé—®é¢˜ï¼Œæˆ‘ä»¬ä¼šåœ¨ Go å·¥ç¨‹åŒ–è¿™ä¸ªç³»åˆ—çš„æœ€åä¸€ç¯‡æ–‡ç« è¯¦ç»†è¯´æ˜ã€‚</p><h3 id="api"><a href="#api" class="headerlink" title="/api"></a>/api</h3><p>API å®šä¹‰çš„ç›®å½•ï¼Œå¦‚æœæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯ grpc é‚£è¿™é‡Œé¢ä¸€èˆ¬æ”¾çš„å°±æ˜¯ proto æ–‡ä»¶ï¼Œé™¤æ­¤ä¹‹å¤–ä¹Ÿæœ‰å¯èƒ½æ˜¯ openapi/swagger å®šä¹‰æ–‡ä»¶ï¼Œä»¥åŠä»–ä»¬ç”Ÿæˆçš„æ–‡ä»¶ã€‚</p><p>ä¸‹é¢ç»™å‡ºä¸€ä¸ªæˆ‘ç°åœ¨ä½¿ç”¨çš„ api ç›®å½•çš„å®šä¹‰ï¼Œå…¶å®å’Œæ¯›è€å¸ˆè¯¾ä¸Šè®²çš„ç±»ä¼¼ï¼Œåé¢è¿˜æœ‰ä¸€ç¯‡æ–‡ç« ä¼šä¸“é—¨è®² api çš„è®¾è®¡ä¼šè®²åˆ°è¿™é‡Œå°±ä¸è¯¦ç»†è®²äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">.<br>â””â”€â”€ api<br>    â””â”€â”€ product_name <span class="hljs-comment">// äº§å“åç§°</span><br>        â””â”€â”€ app_name <span class="hljs-comment">// åº”ç”¨åç§°</span><br>            â””â”€â”€ v1   <span class="hljs-comment">// ç‰ˆæœ¬å·</span><br>                â””â”€â”€ v1.proto<br></code></pre></td></tr></table></figure><h3 id="config-s"><a href="#config-s" class="headerlink" title="/config(s)"></a>/config(s)</h3><p>ä¸ºä»€ä¹ˆåŠ ä¸ª(s) æ˜¯è¯¾ä¸Šè®²çš„è¿˜æœ‰å‚è€ƒææ–™ä¸­å¾ˆå¤šéƒ½å« configs ä½†æ˜¯æˆ‘ä»¬ä¹ æƒ¯ä½¿ç”¨ config ä½†æ˜¯å«ä¹‰ä¸Šéƒ½æ˜¯ä¸€æ ·çš„<br>è¿™é‡Œé¢ä¸€èˆ¬æ”¾ç½®é…ç½®æ–‡ä»¶æ–‡ä»¶å’Œé»˜è®¤æ¨¡æ¿</p><h3 id="test"><a href="#test" class="headerlink" title="/test"></a>/test</h3><p>é¢å¤–çš„å¤–éƒ¨æµ‹è¯•åº”ç”¨ç¨‹åºå’Œæµ‹è¯•æ•°æ®ã€‚ä¸€èˆ¬ä¼šæ”¾æµ‹è¯•ä¸€äº›è¾…åŠ©æ–¹æ³•å’Œæµ‹è¯•æ•°æ®</p><h3 id="æœåŠ¡ç±»å‹"><a href="#æœåŠ¡ç±»å‹" class="headerlink" title="æœåŠ¡ç±»å‹"></a>æœåŠ¡ç±»å‹</h3><p>å¾®æœåŠ¡ä¸­çš„ app æœåŠ¡ç±»å‹åˆ†ä¸º 4 ç±»ï¼šinterfaceã€serviceã€jobã€adminã€‚</p><ul><li>interface: å¯¹å¤–çš„ BFF æœåŠ¡ï¼Œæ¥å—æ¥è‡ªç”¨æˆ·çš„è¯·æ±‚ï¼Œæ¯”å¦‚æš´éœ²äº† HTTP/gRPC æ¥å£ã€‚</li><li>service: å¯¹å†…çš„å¾®æœåŠ¡ï¼Œä»…æ¥å—æ¥è‡ªå†…éƒ¨å…¶ä»–æœåŠ¡æˆ–è€…ç½‘å…³çš„è¯·æ±‚ï¼Œæ¯”å¦‚æš´éœ²äº† gRPC æ¥å£åªå¯¹å†…æœåŠ¡ã€‚</li><li>adminï¼šåŒºåˆ«äº serviceï¼Œæ›´å¤šæ˜¯é¢å‘è¿è¥æµ‹çš„æœåŠ¡ï¼Œé€šå¸¸æ•°æ®æƒé™æ›´é«˜ï¼Œéš”ç¦»å¸¦æ¥æ›´å¥½çš„ä»£ç çº§åˆ«å®‰å…¨ã€‚</li><li>job: æµå¼ä»»åŠ¡å¤„ç†çš„æœåŠ¡ï¼Œä¸Šæ¸¸ä¸€èˆ¬ä¾èµ– message brokerã€‚</li><li>task: å®šæ—¶ä»»åŠ¡ï¼Œç±»ä¼¼ cronjobï¼Œéƒ¨ç½²åˆ° task æ‰˜ç®¡å¹³å°ä¸­ã€‚</li></ul><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612614638378-d00b94ac-f743-414e-bca2-b9d941da7902.png" alt="image.png"><br>è¿™ä¸Šé¢æ˜¯æ¯›è€å¸ˆè¯¾ä¸Šè®²è§£çš„ç±»å‹ï¼Œå’Œæˆ‘ä»¬å¸¸ç”¨çš„åšæ³•ç±»ä¼¼ï¼Œä½†æ˜¯æœ‰ç‚¹åŒºåˆ«ï¼ŒåŒæ ·å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåº”ç”¨å« <code>myapp</code></p><ul><li>myapp-api: è¿™ä¸ªæ˜¯å¯¹å¤–æš´éœ²çš„ api çš„æœåŠ¡ï¼Œå¯ä»¥æ˜¯ http, ä¹Ÿå¯ä»¥æ˜¯ grpc</li><li>myapp-cron: è¿™ä¸ªæ˜¯å®šæ—¶ä»»åŠ¡</li><li>myapp-job: è¿™ä¸ªç”¨äºå¤„ç†æ¥è‡ª message çš„æµå¼ä»»åŠ¡</li><li>myapp-migration: æ•°æ®åº“è¿ç§»ä»»åŠ¡ï¼Œç”¨äºåˆå§‹åŒ–æ•°æ®åº“</li><li>scripts/xxx: ä¸€æ¬¡æ€§æ‰§è¡Œçš„è„šæœ¬ï¼Œæœ‰æ—¶å€™ä¼šæœ‰ä¸€äº›è„šæœ¬ä»»åŠ¡</li></ul><p>å¤§å¤šå¤§åŒå°å¼‚ï¼Œä¸»è¦æ˜¯ BFF å±‚æˆ‘ä»¬ä¸€èˆ¬æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åº”ç”¨ï¼Œä¸ä¼šæ”¾åœ¨åŒä¸€ä¸ªä»“åº“é‡Œé¢ï¼Œ</p><h3 id="é¡¹ç›®å¸ƒå±€-v1"><a href="#é¡¹ç›®å¸ƒå±€-v1" class="headerlink" title="é¡¹ç›®å¸ƒå±€ v1"></a>é¡¹ç›®å¸ƒå±€ v1</h3><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612615089844-dfc6a101-710e-42e4-983f-ea340676b5f4.png" alt="image.png"><br>é¡¹ç›®çš„ä¾èµ–è·¯å¾„ä¸º: model -&gt; dao -&gt; service -&gt; apiï¼Œmodel struct ä¸²è”å„ä¸ªå±‚ï¼Œç›´åˆ° api éœ€è¦åš DTO å¯¹è±¡è½¬æ¢ã€‚</p><ul><li>model: æ”¾å¯¹åº”â€œå­˜å‚¨å±‚â€çš„ç»“æ„ä½“ï¼Œæ˜¯å¯¹å­˜å‚¨çš„ä¸€ä¸€éšå°„ã€‚</li><li>dao: æ•°æ®è¯»å†™å±‚ï¼Œæ•°æ®åº“å’Œç¼“å­˜å…¨éƒ¨åœ¨è¿™å±‚ç»Ÿä¸€å¤„ç†ï¼ŒåŒ…æ‹¬ cache miss å¤„ç†ã€‚</li><li>service: ç»„åˆå„ç§æ•°æ®è®¿é—®æ¥æ„å»ºä¸šåŠ¡é€»è¾‘ã€‚</li><li>server: ä¾èµ– proto å®šä¹‰çš„æœåŠ¡ä½œä¸ºå…¥å‚ï¼Œæä¾›å¿«æ·çš„å¯åŠ¨æœåŠ¡å…¨å±€æ–¹æ³•ã€‚</li><li>api: å®šä¹‰äº† API proto æ–‡ä»¶ï¼Œå’Œç”Ÿæˆçš„ stub ä»£ç ï¼Œå®ƒç”Ÿæˆçš„ interfaceï¼Œå…¶å®ç°è€…åœ¨ service ä¸­ã€‚</li><li>service çš„æ–¹æ³•ç­¾åå› ä¸ºå®ç°äº† API çš„ æ¥å£å®šä¹‰ï¼ŒDTO ç›´æ¥åœ¨ä¸šåŠ¡é€»è¾‘å±‚ç›´æ¥ä½¿ç”¨äº†ï¼Œæ›´æœ‰ dao ç›´æ¥ä½¿ç”¨ï¼Œæœ€ç®€åŒ–ä»£ç ã€‚</li><li>DO(Domain Object): é¢†åŸŸå¯¹è±¡ï¼Œå°±æ˜¯ä»ç°å®ä¸–ç•Œä¸­æŠ½è±¡å‡ºæ¥çš„æœ‰å½¢æˆ–æ— å½¢çš„ä¸šåŠ¡å®ä½“ã€‚ç¼ºä¹ DTO -&gt; DO çš„å¯¹è±¡è½¬æ¢ã€‚</li></ul><h4 id="v1-å­˜åœ¨çš„é—®é¢˜"><a href="#v1-å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="v1 å­˜åœ¨çš„é—®é¢˜"></a>v1 å­˜åœ¨çš„é—®é¢˜</h4><ul><li>æ²¡æœ‰ DTO å¯¹è±¡ï¼Œmodel ä¸­çš„å¯¹è±¡è´¯ç©¿å…¨å±€ï¼Œæ‰€æœ‰å±‚éƒ½æœ‰<ul><li>model å±‚çš„æ•°æ®ä¸æ˜¯æ¯ä¸ªæ¥å£éƒ½éœ€è¦çš„ï¼Œè¿™ä¸ªæ—¶å€™ä¼šæœ‰ä¸€äº›é—®é¢˜</li><li>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­å…¶å®ä¹Ÿåå¤æåˆ°äº† â€œå¦‚æœä¸¤æ®µçœ‹ä¼¼é‡å¤çš„ä»£ç ï¼Œå¦‚æœæœ‰ä¸åŒçš„å˜æ›´é€Ÿç‡å’ŒåŸå› ï¼Œé‚£ä¹ˆè¿™ä¸¤æ®µä»£ç å°±ä¸ç®—æ˜¯çœŸæ­£çš„é‡å¤â€</li></ul></li><li>server å±‚çš„ä»£ç å¯ä»¥é€šè¿‡åŸºç¡€åº“å¹²æ‰ï¼Œæä¾›ç»Ÿä¸€æœåŠ¡æš´éœ²æ–¹å¼</li></ul><h3 id="é¡¹ç›®å¸ƒå±€-v2"><a href="#é¡¹ç›®å¸ƒå±€-v2" class="headerlink" title="é¡¹ç›®å¸ƒå±€ v2"></a>é¡¹ç›®å¸ƒå±€ v2</h3><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612615164024-9156a848-53f7-4324-963a-e7e4ae110424.png" alt="image.png"></p><ul><li>app ç›®å½•ä¸‹æœ‰ apiã€cmdã€configsã€internal ç›®å½•ï¼Œç›®å½•é‡Œä¸€èˆ¬è¿˜ä¼šæ”¾ç½® READMEã€CHANGELOGã€OWNERSã€‚</li><li><strong>internal:</strong> æ˜¯ä¸ºäº†é¿å…æœ‰åŒä¸šåŠ¡ä¸‹æœ‰äººè·¨ç›®å½•å¼•ç”¨äº†å†…éƒ¨çš„ bizã€dataã€service ç­‰å†…éƒ¨ structã€‚<ul><li>å¦‚æœå­˜åœ¨ä¸€ä¸ªä»“åº“å¤šä¸ªåº”ç”¨ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨ internal é‡Œé¢è¿›è¡Œåˆ†å±‚ï¼Œä¾‹å¦‚ <code>/internal/app</code> , <code>/internal/job</code></li><li><strong>biz</strong>: ä¸šåŠ¡é€»è¾‘çš„ç»„è£…å±‚ï¼Œç±»ä¼¼ DDD çš„ domain å±‚ï¼Œdata ç±»ä¼¼ DDD çš„ repoï¼Œrepo æ¥å£åœ¨è¿™é‡Œå®šä¹‰ï¼Œä½¿ç”¨ä¾èµ–å€’ç½®çš„åŸåˆ™ã€‚</li><li><strong>data</strong>: ä¸šåŠ¡æ•°æ®è®¿é—®ï¼ŒåŒ…å« cacheã€db ç­‰å°è£…ï¼Œå®ç°äº† biz çš„ repo æ¥å£ã€‚æˆ‘ä»¬å¯èƒ½ä¼šæŠŠ data ä¸ dao æ··æ·†åœ¨ä¸€èµ·ï¼Œdata åé‡ä¸šåŠ¡çš„å«ä¹‰ï¼Œå®ƒæ‰€è¦åšçš„æ˜¯å°†é¢†åŸŸå¯¹è±¡é‡æ–°æ‹¿å‡ºæ¥ï¼Œæˆ‘ä»¬å»æ‰äº† DDD çš„ infra å±‚ã€‚</li><li><strong>service</strong>: å®ç°äº† api å®šä¹‰çš„æœåŠ¡å±‚ï¼Œç±»ä¼¼ DDD çš„ application å±‚ï¼Œå¤„ç† DTO åˆ° biz é¢†åŸŸå®ä½“çš„è½¬æ¢(DTO -&gt; DO)ï¼ŒåŒæ—¶ååŒå„ç±» biz äº¤äº’ï¼Œä½†æ˜¯ä¸åº”å¤„ç†å¤æ‚é€»è¾‘ã€‚</li></ul></li><li>PO(Persistent Object): æŒä¹…åŒ–å¯¹è±¡ï¼Œå®ƒè·ŸæŒä¹…å±‚ï¼ˆé€šå¸¸æ˜¯å…³ç³»å‹æ•°æ®åº“ï¼‰çš„æ•°æ®ç»“æ„å½¢æˆä¸€ä¸€å¯¹åº”çš„æ˜ å°„å…³ç³»ï¼Œå¦‚æœæŒä¹…å±‚æ˜¯å…³ç³»å‹æ•°æ®åº“ï¼Œé‚£ä¹ˆæ•°æ®è¡¨ä¸­çš„æ¯ä¸ªå­—æ®µï¼ˆæˆ–è‹¥å¹²ä¸ªï¼‰å°±å¯¹åº” PO çš„ä¸€ä¸ªï¼ˆæˆ–è‹¥å¹²ä¸ªï¼‰å±æ€§ã€‚</li></ul><p>ç¤ºä¾‹å¯ä»¥å‚è€ƒ <a href="https://github.com/go-kratos/examples/tree/main/blog">kratos v2 çš„ example</a></p><h3 id="æˆ‘çš„é¡¹ç›®å¸ƒå±€"><a href="#æˆ‘çš„é¡¹ç›®å¸ƒå±€" class="headerlink" title="æˆ‘çš„é¡¹ç›®å¸ƒå±€"></a>æˆ‘çš„é¡¹ç›®å¸ƒå±€</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go">.<br>â”œâ”€â”€ api<br>â”œâ”€â”€ cmd<br>â”‚   â””â”€â”€ app<br>â”œâ”€â”€ config<br>â”œâ”€â”€ internal<br>â”‚   â”œâ”€â”€ domain<br>â”‚   â”œâ”€â”€ repo<br>â”‚   â”œâ”€â”€ service<br>â”‚   â””â”€â”€ usecase<br>â””â”€â”€ pkg<br></code></pre></td></tr></table></figure><p><strong>internal:</strong> æ˜¯ä¸ºäº†é¿å…æœ‰åŒä¸šåŠ¡ä¸‹æœ‰äººè·¨ç›®å½•å¼•ç”¨äº†å†…éƒ¨çš„å¯¹è±¡</p><ul><li>domain: ç±»ä¼¼ä¹‹å‰çš„ model å±‚ï¼Œè¿™é‡Œé¢åŒ…å«äº† DO å¯¹è±¡ï¼Œusecase interface, repo interface çš„å®šä¹‰</li><li>repo: å®šäºæ•°æ®è®¿é—®ï¼ŒåŒ…å« cache, db çš„å°è£…</li><li>usecase: è¿™é‡Œæ˜¯ä¸šåŠ¡é€»è¾‘çš„ç»„è£…å±‚ï¼Œç±»ä¼¼ä¸Šé¢çš„ biz å±‚ï¼Œä½†æ˜¯åŒºåˆ«æ˜¯æˆ‘ä»¬è¿™é‡Œä¸åŒ…å« DO å¯¹è±¡å’Œ repo å¯¹è±¡çš„å®šä¹‰</li><li>service: å®ç° api çš„æœåŠ¡å±‚ï¼Œä¸»è¦å®ç° DTO å’Œ DO å¯¹è±¡çš„è½¬åŒ–ï¼Œå‚æ•°çš„æ ¡éªŒç­‰ç­‰<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">æˆ‘ä»¬è¿™é‡Œçš„å®šä¹‰å’Œä¸Šé¢ v2 æœ€å¤§çš„åŒºåˆ«æ˜¯å¤šäº†ä¸€ä¸ª domain å±‚ï¼Œè¿™é‡Œé¢æœ‰ä¸€ä¸ªåŸå› æ˜¯æˆ‘ä»¬å¯¹äºå•å…ƒæµ‹è¯•çš„è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¦‚æœæŒ‰ç…§ä¸Šé¢ v2 çš„ä»£ç è¿›è¡Œç»„ç»‡ï¼Œservice å±‚ç›´æ¥ä¾èµ– usecase çš„å®ç°ï¼Œservice çš„ä»£ç ä¸å¤ªå¥½è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚å¦‚æœä¾èµ– interface ä¼šå¯¼è‡´å¾ªç¯ä¾èµ–ï¼Œæ‰€ä»¥é‡‡ç”¨ç±»ä¼¼ go-clean-arch çš„ç»„ç»‡ï¼Œå•ç‹¬æŠ½è±¡ä¸€å±‚ domain å±‚</div></li></ul><h2 id="åº”è¯¥é¿å…çš„åä¹ æƒ¯"><a href="#åº”è¯¥é¿å…çš„åä¹ æƒ¯" class="headerlink" title="åº”è¯¥é¿å…çš„åä¹ æƒ¯"></a>åº”è¯¥é¿å…çš„åä¹ æƒ¯</h2><h3 id="src"><a href="#src" class="headerlink" title="/src"></a>/src</h3><p>ä¸€èˆ¬è€Œè¨€ï¼Œåœ¨ Go é¡¹ç›®å½“ä¸­ä¸åº”è¯¥å‡ºç° src ç›®å½•ï¼ŒGo å’Œ Java ä¸åŒï¼Œåœ¨ Go ä¸­æ¯ä¸€ä¸ªç›®å½•éƒ½æ˜¯ä¸€ä¸ªåŒ…ï¼Œæ¯ä¸€ä¸ªåŒ…éƒ½æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œæˆ‘ä»¬ä¸éœ€è¦å°†é¡¹ç›®ä»£ç æ”¾åˆ° src å½“ä¸­ï¼Œä¸è¦ç”¨å†™å…¶ä»–è¯­è¨€çš„æ–¹å¼æ¥å†™ Go</p><h3 id="utilsï¼Œcommon"><a href="#utilsï¼Œcommon" class="headerlink" title="utilsï¼Œcommon"></a>utilsï¼Œcommon</h3><p>ä¸è¦åœ¨é¡¹ç›®ä¸­å‡ºç° utils å’Œ common è¿™ç§åŒ…ï¼Œå¦‚æœå‡ºç°è¿™ç§åŒ…ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶ä¸èƒ½ä»åŒ…ä¸­çŸ¥é“ä½ è¿™ä¸ªåŒ…çš„ä½œç”¨ï¼Œé•¿ä¹…ä¹‹åè¿™ä¸ªåŒ…å°±ä¼šå˜æˆä¸€ä¸ªå¤§æ‚çƒ©ï¼Œæ‰€æœ‰ä¸œè¥¿éƒ½å¾€è¿™é‡Œé¢æ‰”ã€‚<br>æœ‰çš„åŒå­¦è¿™ä¸ªæ—¶å€™ä¼šé—®è¯´ï¼Œé‚£æˆ‘ä»¬çš„å·¥å…·å‡½æ•°åº”è¯¥æ”¾åˆ°å“ªé‡Œï¼Ÿæ€ä¹ˆæ”¾ï¼Ÿ<br>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å½“å‰ä½¿ç”¨ <code>gin</code>  ä½œä¸ºè·¯ç”±æ¡†æ¶ï¼Œä½†æ˜¯ <code>gin</code>  çš„ handler æ³¨å†Œå…¶å®ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œæ‰€ä»¥æˆ‘ä»¬åšäº†ä¸€å±‚å°è£…ï¼Œè¿™ä¸ªæ—¶å€™è¿™ä¸ªå·¥å…·æ–¹æ³•æˆ‘ä»¬ä¸€èˆ¬æ”¾åœ¨ <code>/pkg/ginx</code>  ç›®å½•ä¸‹ï¼Œè¡¨ç¤ºè¿™ä¸ªæ˜¯å¯¹ <code>gin</code>  å¢å¼ºçš„åŒ…ï¼Œä¸ç›´æ¥ä½¿ç”¨ <code>gin</code>  ä½œä¸ºåŒ…åçš„åŸå› æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä¹Ÿä¼šå¼•ç”¨ <code>gin</code>  ç›¸åŒçš„å‘½åä¸€ä¸ªæ˜¯ä¼šå¯¼è‡´è¯¯è§£ï¼Œå¦ä¸€ä¸ªæ˜¯åœ¨åŒæ—¶å¯¼å…¥çš„æ—¶å€™ä¹Ÿä¼šéœ€è¦å»è¿›è¡Œé‡å‘½åä¼šæ¯”è¾ƒéº»çƒ¦</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å…³äºé¡¹ç›®ç›®å½•ç»“æ„è¿™ç§çœŸçš„ç®—æ˜¯è§ä»è§æ™ºï¼Œä¸åŒçš„ç†è®ºæœ‰ä¸åŒçš„æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘è§‰å¾—æœ‰ä¸¤ä»¶äº‹æ¯”è¾ƒé‡è¦ï¼Œå°±æœåŠ¡åº”ç”¨è€Œè¨€éœ€è¦çµæ´»åº”ç”¨ï¼Œå°±åŸºç¡€åº“è€Œè¨€ä¸€å®šè¦ç»Ÿä¸€ï¼Œåšçš„å¥½ä¸å¥½å’Œè¦ä¸è¦åšæ˜¯ä¸¤ä»¶äº‹æƒ…ï¼Œå¦‚æœå› ä¸ºå½“å‰åšçš„ä¸å¤Ÿå¥½è€Œä¸åšï¼Œé‚£ä¹ˆè¶Šåˆ°åé¢å°±è¶Šåšä¸äº†ã€‚<br>ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šè®²ä¸€è®²ä¾èµ–æ³¨å…¥æ¡†æ¶ wire çš„ä½¿ç”¨ä¸æœ€ä½³(?)å®è·µ</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://u.geekbang.org/subject/go?utm_source=lailin.xyz&amp;utm_medium=lailin.xyz">Go è¿›é˜¶è®­ç»ƒè¥-æå®¢æ—¶é—´</a></li><li><a href="https://github.com/golang-standards/project-layout/blob/master/README_zh.md">golang-standards/project-layout Â· GitHub</a></li><li><a href="https://www.ardanlabs.com/blog/2017/02/package-oriented-design.html">Package Oriented Design</a></li><li><a href="https://golang.org/doc/go1.4#internalpackages">Go 1.4 Release Notes - The Go Programming Language</a></li><li><a href="https://travisjeffery.com/b/2019/11/i-ll-take-pkg-over-internal/">Iâ€™ll take pkg over internal</a></li><li><a href="https://medium.com/@benbjohnson/standard-package-layout-7cdbc8391fc1">https://medium.com/@benbjohnson/standard-package-layout-7cdbc8391fc1</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week04: Go å·¥ç¨‹åŒ–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å·¥ç¨‹åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå·¥ç¨‹åŒ–(ä¸€) æ¶æ„æ•´æ´ä¹‹é“é˜…è¯»ç¬”è®°</title>
    <link href="/post/go-training-week4-clean-arch.html"/>
    <url>/post/go-training-week4-clean-arch.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><p>å…¶å®è¿™ä¸€ç¯‡æ–‡ç« ä¸åº”è¯¥ç®—åœ¨è¿™é‡Œé¢ï¼Œï¼ˆPS: æ¯›è€å¸ˆè¯¾ç¨‹ä¸Šæ²¡è®²è¿™æœ¬ä¹¦ï¼‰ä½†æ˜¯æ°å¥½æœ€è¿‘æŠŠè¿™æœ¬ä¹¦è¯»å®Œäº†ï¼Œå¹¶ä¸”éƒ¨é—¨å†…æ¨èå¤§å®¶è¯»è¿™æœ¬ä¹¦ï¼Œæ¯›è€å¸ˆåœ¨è¯¾ä¸Šä¹Ÿæ¨èè¿™æœ¬ä¹¦ï¼Œä¹Ÿå’Œæˆ‘ä»¬è¿™æ¬¡çš„ä¸»é¢˜æœ‰ä¸€äº›å…³ç³»ï¼Œä¸€åˆ‡éƒ½æ˜¯æœ€å¥½çš„å®‰æ’ï¼Œé‚£å°±æ”¾è¿™ç³»åˆ—å§ã€‚</p><div style="background: #FFFBE6;padding:10px;border: 1px solid #C3C3C3;border-radius:5px;margin-bottom:5px;">é˜…è¯»å»ºè®®: å…¨æ–‡æ¥è¿‘ 2W å­—ï¼Œç¯‡å¹…è¾ƒé•¿ï¼Œé‡‡ç”¨ä¹¦ä¸­é‡ç‚¹æ‘˜å½•+ä¸æˆç†Ÿçš„ä¸ªäººå°ç»“ç»„æˆï¼Œæ¡Œé¢ç«¯å¯ä»¥ç‚¹å‡»å³ä¾§ç›®å½•å¿«é€Ÿå®šä½åˆ°ä½ æ„Ÿå…´è¶£çš„ç« èŠ‚</div><h2 id="è¯»ä¹¦ç¬”è®°"><a href="#è¯»ä¹¦ç¬”è®°" class="headerlink" title="è¯»ä¹¦ç¬”è®°"></a>è¯»ä¹¦ç¬”è®°</h2><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><ul><li>ä»Šå¤©çš„è½¯ä»¶ä¸è¿‡å»çš„è½¯ä»¶æœ¬è´¨ä¸Šä»ç„¶æ˜¯ä¸€æ ·çš„ã€‚éƒ½æ˜¯ç”± if è¯­å¥ã€èµ‹å€¼è¯­å¥ä»¥åŠ while å¾ªç¯ç»„æˆçš„</li><li>è½¯ä»¶æ¶æ„çš„è§„åˆ™å…¶å®å°±æ˜¯æ’åˆ—ç»„åˆä»£ç å—çš„è§„åˆ™<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">è¿™è¯´æ˜ä»€ä¹ˆå‘¢ï¼Œè¯´æ˜äº†å¯èƒ½æˆ‘ä»¬ä»¥ä¸ºè¿‡æ—¶çš„ï¼Œå¤è€çš„æŠ€æœ¯æˆ–è€…è§£å†³æ–¹æ¡ˆä¹Ÿæ˜¯æœ‰ç”¨çš„</div></li></ul><h3 id="ç¬¬ä¸€éƒ¨åˆ†-æ¦‚è¿°"><a href="#ç¬¬ä¸€éƒ¨åˆ†-æ¦‚è¿°" class="headerlink" title="ç¬¬ä¸€éƒ¨åˆ† æ¦‚è¿°"></a>ç¬¬ä¸€éƒ¨åˆ† æ¦‚è¿°</h3><h4 id="ç¬¬-1-ç« -è®¾è®¡ä¸æ¶æ„ç©¶ç«Ÿæ˜¯ä»€ä¹ˆ"><a href="#ç¬¬-1-ç« -è®¾è®¡ä¸æ¶æ„ç©¶ç«Ÿæ˜¯ä»€ä¹ˆ" class="headerlink" title="ç¬¬ 1 ç«  è®¾è®¡ä¸æ¶æ„ç©¶ç«Ÿæ˜¯ä»€ä¹ˆ"></a>ç¬¬ 1 ç«  è®¾è®¡ä¸æ¶æ„ç©¶ç«Ÿæ˜¯ä»€ä¹ˆ</h4><ul><li>æ¶æ„å›¾é‡Œå®é™…ä¸ŠåŒ…å«äº†æ‰€æœ‰çš„<strong>åº•å±‚è®¾è®¡ç»†èŠ‚</strong>ï¼Œè¿™äº›ç»†èŠ‚ä¿¡æ¯å…±åŒæ”¯æ’‘äº†é¡¶å±‚çš„æ¶æ„è®¾è®¡ï¼Œ<strong>åº•å±‚è®¾è®¡ä¿¡æ¯å’Œé¡¶å±‚æ¶æ„è®¾è®¡</strong>å…±åŒç»„æˆäº†æ•´ä¸ªæˆ¿å±‹çš„æ¶æ„æ–‡æ¡£ã€‚</li><li><strong>è½¯ä»¶æ¶æ„çš„ç»ˆæç›®æ ‡æ˜¯ï¼Œç”¨æœ€å°çš„äººåŠ›æˆæœ¬æ¥æ»¡è¶³æ„å»ºå’Œç»´æŠ¤è¯¥ç³»ç»Ÿçš„éœ€æ±‚ã€‚</strong></li><li>ä¸€ä¸ªè½¯ä»¶æ¶æ„çš„ä¼˜åŠ£ï¼Œ<strong>å¯ä»¥ç”¨å®ƒæ»¡è¶³ç”¨æˆ·éœ€æ±‚æ‰€éœ€è¦çš„æˆæœ¬æ¥è¡¡é‡ã€‚</strong></li><li>ä¹±éº»ç³»ç»Ÿï¼šè¿™ç§ç³»ç»Ÿä¸€èˆ¬éƒ½æ˜¯æ²¡æœ‰ç»è¿‡è®¾è®¡ï¼ŒåŒ†åŒ†å¿™å¿™è¢«æ„å»ºèµ·æ¥çš„<ul><li>æˆ‘ä»¬ç»å¸¸ä½¿ç”¨ä¸€å¥è¯æ¥æ¬ºéª—è‡ªå·±<strong>â€œæˆ‘ä»¬å¯ä»¥æœªæ¥å†é‡æ„ä»£ç ï¼Œäº§å“ä¸Šçº¿æœ€é‡è¦ï¼â€</strong></li><li>å¦å¤–ä¸€ä¸ªé”™è¯¯çš„è§‚ç‚¹ï¼š<strong>â€œåœ¨å·¥ç¨‹ä¸­å®¹å¿ç³Ÿç³•çš„ä»£ç å­˜åœ¨å¯ä»¥åœ¨çŸ­æœŸå†…åŠ å¿«è¯¥å·¥ç¨‹ä¸Šçº¿çš„é€Ÿåº¦ï¼Œæœªæ¥è¿™äº›ä»£ç ä¼šé€ æˆä¸€äº›é¢å¤–çš„å·¥ä½œé‡ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä»€ä¹ˆå¤§ä¸äº†â€</strong></li></ul></li><li>ç ”å‘å›¢é˜Ÿæœ€å¥½çš„é€‰æ‹©æ˜¯æ¸…æ™°åœ°è®¤è¯†å¹¶é¿å¼€å·¥ç¨‹å¸ˆä»¬è¿‡åº¦è‡ªä¿¡çš„ç‰¹ç‚¹ï¼Œå¼€å§‹è®¤çœŸåœ°å¯¹å¾…è‡ªå·±çš„ä»£ç æ¶æ„ï¼Œå¯¹å…¶è´¨é‡è´Ÿè´£<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">è½¯ä»¶çš„æ¶æ„çš„ç»ˆæç›®æ ‡ï¼Œä»¥åŠå¦‚ä½•è¡¡é‡ä¸€ä¸ªæ¶æ„çš„ä¼˜åŠ£ï¼Œå°¤å…¶æ˜¯ä¸¤ä¸ªé”™è¯¯çš„è§‚ç‚¹éå¸¸æ„ŸåŒèº«å—ï¼Œæˆ‘ä¹Ÿè¯´è¿‡ç±»ä¼¼çš„è¯è¯­ï¼Œè¿˜æœ‰ä¸€å¥è¯æ˜¯â€œå½“å‰çš„éœ€æ±‚éå¸¸ç´§æ€¥ï¼Œè¿™åªæ˜¯ä¸€ä¸ªä¸´æ—¶çš„ç³»ç»Ÿå¾ˆå¿«å°±ä¼šè¢«æ›¿æ¢æ‰ï¼Œæˆ‘ä»¬å…ˆå®Œæˆå®ƒâ€ã€‚ä½œä¸ºä¸€ä¸ªä¸“ä¸šçš„æŠ€æœ¯äººå‘˜æˆ‘ä»¬éœ€è¦æœ‰ä¸€äº›åº•çº¿æ¥ä¿è¯æˆ‘ä»¬çš„ä»£ç æ¶æ„å’Œè´¨é‡ï¼Œä¸èƒ½è½»æ˜“å¦¥åï¼Œè¿™åœ¨ Bob å¤§å”æ•´æ´ç³»åˆ—çš„å¦å¤–ä¸€æœ¬ä¹¦ä¸­ä¹Ÿæœ‰æåˆ°ã€‚</div></li></ul><h4 id="ç¬¬-2-ç« -ä¸¤ä¸ªä»·å€¼çº¬åº¦"><a href="#ç¬¬-2-ç« -ä¸¤ä¸ªä»·å€¼çº¬åº¦" class="headerlink" title="ç¬¬ 2 ç«  ä¸¤ä¸ªä»·å€¼çº¬åº¦"></a>ç¬¬ 2 ç«  ä¸¤ä¸ªä»·å€¼çº¬åº¦</h4><ul><li><p>è¡Œä¸ºä»·å€¼</p><ul><li>è½¯ä»¶ç³»ç»Ÿçš„è¡Œä¸ºæ˜¯å…¶æœ€ç›´è§‚çš„ä»·å€¼ç»´åº¦ã€‚ç¨‹åºå‘˜çš„å·¥ä½œå°±æ˜¯è®©æœºå™¨æŒ‰ç…§æŸç§æŒ‡å®šæ–¹å¼è¿è½¬ï¼Œç»™ç³»ç»Ÿçš„ä½¿ç”¨è€…åˆ›é€ æˆ–è€…æé«˜åˆ©æ¶¦ã€‚</li><li>æŒ‰ç…§éœ€æ±‚æ–‡æ¡£ç¼–å†™ä»£ç ï¼Œå¹¶ä¸”ä¿®å¤ä»»ä½• Bugã€‚è¿™çœŸæ˜¯å¤§é”™ç‰¹é”™ã€‚</li><li><strong>ç³»ç»Ÿè¡Œä¸ºï¼Œæ˜¯ç´§æ€¥çš„ï¼Œä½†æ˜¯å¹¶ä¸æ€»æ˜¯ç‰¹åˆ«é‡è¦ã€‚</strong><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">åªæœ‰å¯ä»¥äº§ç”Ÿæ”¶å…¥çš„ä»£ç æ‰æ˜¯æœ‰ç”¨çš„ä»£ç ï¼ŒæŠ€æœ¯æ˜¯éœ€è¦ä¸ºä¸šåŠ¡æœåŠ¡çš„ï¼Œä½†æ˜¯æˆ‘ä»¬çš„å·¥ä½œå¹¶ä¸æ˜¯è¯´å°±æŒ‰ç…§éœ€æ±‚æ–‡æ¡£å†™ä»£ç ï¼Œä¿®bugå°±è¡Œäº†</div></li></ul></li><li><p>æ¶æ„ä»·å€¼</p><ul><li>ä¸ºäº†è¾¾åˆ°è½¯ä»¶çš„æœ¬æ¥ç›®çš„ï¼Œè½¯ä»¶ç³»ç»Ÿå¿…é¡»å¤Ÿâ€œè½¯â€â€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œè½¯ä»¶åº”è¯¥å®¹æ˜“è¢«ä¿®æ”¹ã€‚</li><li>å½“éœ€æ±‚æ–¹æ”¹å˜éœ€æ±‚çš„æ—¶å€™ï¼Œéšä¹‹æ‰€éœ€çš„è½¯ä»¶å˜æ›´å¿…é¡»å¯ä»¥ç®€å•è€Œæ–¹ä¾¿åœ°å®ç°ã€‚</li><li>å˜æ›´å®æ–½çš„éš¾åº¦åº”è¯¥å’Œå˜æ›´çš„èŒƒç•´ï¼ˆscopeï¼‰æˆç­‰æ¯”å…³ç³»ï¼Œè€Œä¸å˜æ›´çš„å…·ä½“å½¢çŠ¶ï¼ˆshapeï¼‰æ— å…³ã€‚</li><li><strong>ç³»ç»Ÿæ¶æ„ï¼Œæ˜¯é‡è¦çš„ï¼Œä½†æ˜¯å¹¶ä¸æ€»æ˜¯ç‰¹åˆ«ç´§æ€¥ã€‚</strong><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">æ¶æ„ä»·å€¼ä¸»è¦å°±æ˜¯ä¸ºäº†èƒ½å¤Ÿåº”å¯¹å˜åŒ–ï¼Œå…¶å®ä¸¾ä¸ªåé¢ä¾‹å­ï¼Œæˆ‘ä»¬ä¹‹å‰æœ‰ä¸€ä¸ªç³»ç»Ÿ A æ˜¯ç›´æ¥åœ¨ A ä¸­è°ƒç”¨æ¥å£è·å–æ•°æ®ï¼Œéšç€ä¸šåŠ¡çš„å‘å±•æˆ‘ä»¬æ‹†åˆ†äº†ä¸€ä¸ªåº”ç”¨ B éœ€è¦ä» B ä¸­è·å–å¯¹åº”çš„æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å‘ç°ä»£ç å˜æ›´éå¸¸ä¸¥é‡ï¼Œä»é‡Œåˆ°å¤–éƒ½éœ€è¦è¿›è¡Œé‡æ„ä¿®æ”¹ï¼Œè¿™å°±æ˜¯å…¸å‹äº†ä¾èµ–äº†â€œå…·ä½“çš„å½¢çŠ¶â€å¯¼è‡´çš„é¢å¤–æˆæœ¬</div></li></ul></li><li><p>é‡è¦ç´§æ€¥çš„æ’åº</p><ul><li>é‡è¦ä¸”ç´§æ€¥</li><li>é‡è¦ä¸ç´§æ€¥</li><li>ä¸é‡è¦ä½†ç´§æ€¥</li><li>ä¸é‡è¦ä¸”ä¸ç´§æ€¥</li></ul></li><li><p>ä¸šåŠ¡/å¸‚åœºçš„åŒäº‹å¾€å¾€æ˜¯æ— æ³•è¯„ä¼°æ¶æ„çš„é‡è¦æ€§çš„ï¼Œæ‰€ä»¥ï¼Œ<strong>å¹³è¡¡ç³»ç»Ÿæ¶æ„çš„é‡è¦æ€§ä¸åŠŸèƒ½çš„ç´§æ€¥ç¨‹åº¦è¿™ä»¶äº‹ï¼Œæ˜¯è½¯ä»¶ç ”å‘äººå‘˜è‡ªå·±çš„èŒè´£ã€‚</strong></p><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">æˆ‘ä»¬å½“å‰å¤„åœ¨å…¬å…±æŠ€æœ¯çš„éƒ¨é—¨ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªç»å¸¸å›°æ‰°çš„ä¸€ä¸ªä¾‹å­ï¼Œæ‰€æœ‰çš„ä¸šåŠ¡æ–¹åœ¨æéœ€æ±‚çš„æ—¶å€™éƒ½ä¼šè¡¨ç¤ºéœ€æ±‚éå¸¸ç´§æ€¥ï¼Œä½†æ˜¯è¿™ä¸ªåŠŸèƒ½çš„å®ç°å¯¹æˆ‘ä»¬æ¥è¯´é‡è¦å—ï¼Ÿè¿™ä¸ªéœ€è¦æ‰“ä¸Šä¸€ä¸ªå¤§å¤§çš„é—®å·ï¼Œå…¶ä»–éƒ¨é—¨çš„åŒå­¦å…¶å®æ˜¯æ— æ³•å¯¹è¯„ä¼°éœ€æ±‚å¯¹äºæˆ‘ä»¬çš„é‡è¦æ€§çš„ï¼Œè¿™ä¸ªéœ€è¦æˆ‘ä»¬è‡ªå·±æ¥æƒè¡¡ã€‚</div></li><li><p>ä¸ºå¥½çš„è½¯ä»¶æ¶æ„è€ŒæŒç»­æ–—äº‰</p><ul><li>è½¯ä»¶æ¶æ„å¸ˆè¿™ä¸€èŒè´£æœ¬èº«å°±åº”æ›´å…³æ³¨ç³»ç»Ÿçš„æ•´ä½“ç»“æ„ï¼Œè€Œä¸æ˜¯å…·ä½“çš„åŠŸèƒ½å’Œç³»ç»Ÿè¡Œä¸ºçš„å®ç°ã€‚</li><li><strong>è½¯ä»¶æ¶æ„å¸ˆå¿…é¡»åˆ›å»ºå‡ºä¸€ä¸ªå¯ä»¥è®©åŠŸèƒ½å®ç°èµ·æ¥æ›´å®¹æ˜“ã€ä¿®æ”¹èµ·æ¥æ›´ç®€å•ã€æ‰©å±•èµ·æ¥æ›´è½»æ¾çš„è½¯ä»¶æ¶æ„ã€‚</strong></li><li>å¦‚æœå¿½è§†è½¯ä»¶æ¶æ„çš„ä»·å€¼ï¼Œç³»ç»Ÿå°†ä¼šå˜å¾—è¶Šæ¥è¶Šéš¾ä»¥ç»´æŠ¤ï¼Œç»ˆä¼šæœ‰ä¸€å¤©ï¼Œç³»ç»Ÿå°†ä¼šå˜å¾—å†ä¹Ÿæ— æ³•ä¿®æ”¹ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">è¿™ä¸ä»…ä»…æ˜¯æ¶æ„å¸ˆçš„èŒè´£ï¼Œè¿™æ˜¯æ¯ä¸€ä½å¼€å‘åŒå­¦çš„èŒè´£ï¼Œå¿½ç•¥æ¶æ„çš„ä»·å€¼ä¼šå¯¼è‡´æˆ‘ä»¬å¸¦æ¥æ— ä¼‘æ­¢çš„åŠ ç­ï¼Œé¢†å¯¼çš„è´¨ç–‘ï¼Œäº§å“çš„argue</div></li></ul></li></ul><h3 id="ç¬¬äºŒéƒ¨åˆ†-ä»åŸºç¡€æ„ä»¶å¼€å§‹ï¼šç¼–ç¨‹èŒƒå¼"><a href="#ç¬¬äºŒéƒ¨åˆ†-ä»åŸºç¡€æ„ä»¶å¼€å§‹ï¼šç¼–ç¨‹èŒƒå¼" class="headerlink" title="ç¬¬äºŒéƒ¨åˆ† ä»åŸºç¡€æ„ä»¶å¼€å§‹ï¼šç¼–ç¨‹èŒƒå¼"></a>ç¬¬äºŒéƒ¨åˆ† ä»åŸºç¡€æ„ä»¶å¼€å§‹ï¼šç¼–ç¨‹èŒƒå¼</h3><p>ç¼–ç¨‹èŒƒå¼æŒ‡çš„æ˜¯ç¨‹åºçš„ç¼–å†™æ¨¡å¼ï¼Œä¸å…·ä½“çš„ç¼–ç¨‹è¯­è¨€å…³ç³»ç›¸å¯¹è¾ƒå°ã€‚è¿™äº›èŒƒå¼ä¼šå‘Šè¯‰ä½ åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™é‡‡ç”¨ä»€ä¹ˆæ ·çš„ä»£ç ç»“æ„<br>å½“å‰çš„ä¸‰ç§ç¼–ç¨‹èŒƒå¼ï¼Œç»“æ„åŒ–ç¼–ç¨‹ï¼Œé¢å‘å¯¹è±¡ï¼Œå‡½æ•°å¼ç¼–ç¨‹</p><h4 id="ç¬¬-3-ç« -ç¼–ç¨‹èŒƒå¼æ€»è§ˆ"><a href="#ç¬¬-3-ç« -ç¼–ç¨‹èŒƒå¼æ€»è§ˆ" class="headerlink" title="ç¬¬ 3 ç«  ç¼–ç¨‹èŒƒå¼æ€»è§ˆ"></a>ç¬¬ 3 ç«  ç¼–ç¨‹èŒƒå¼æ€»è§ˆ</h4><ul><li>ç»“æ„åŒ–ç¼–ç¨‹ï¼ˆé¢å‘è¿‡ç¨‹ï¼‰<ul><li>ç»“æ„åŒ–ç¼–ç¨‹å¯¹ç¨‹åºæ§åˆ¶æƒçš„ç›´æ¥è½¬ç§»è¿›è¡Œäº†é™åˆ¶å’Œè§„èŒƒã€‚</li><li>é™åˆ¶äº† goto è¯­å¥çš„ä½¿ç”¨</li></ul></li><li>é¢å‘å¯¹è±¡<ul><li>é¢å‘å¯¹è±¡ç¼–ç¨‹å¯¹ç¨‹åºæ§åˆ¶æƒçš„é—´æ¥è½¬ç§»è¿›è¡Œäº†é™åˆ¶å’Œè§„èŒƒã€‚</li><li>é™åˆ¶äº†å‡½æ•°æŒ‡é’ˆçš„ä½¿ç”¨</li></ul></li><li>å‡½æ•°å¼ç¼–ç¨‹<ul><li>å‡½æ•°å¼ç¼–ç¨‹å¯¹ç¨‹åºä¸­çš„èµ‹å€¼è¿›è¡Œäº†é™åˆ¶å’Œè§„èŒƒã€‚</li><li>é™åˆ¶äº†èµ‹å€¼è¯­å¥çš„ä½¿ç”¨<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">è¿™ä¸ªè§’åº¦ä¹‹å‰è¿˜æ²¡æœ‰çœ‹åˆ°è¿‡ï¼Œå¯¹æˆ‘è€Œè¨€è¿˜æ˜¯æ¯”è¾ƒæ–°å¥‡ï¼Œä»é™åˆ¶çš„è§’åº¦æ¥çœ‹ä¸åŒçš„ç¼–ç¨‹èŒƒå¼æœ‰ç€ä¸åŒé™åˆ¶ï¼Œå¯ä»¥å‡å°‘åœ¨ç¼–ç¨‹å½“ä¸­å‡ºé”™çš„å¯èƒ½</div></li></ul></li></ul><h4 id="ç¬¬-4-ç« -ç»“æ„åŒ–ç¼–ç¨‹"><a href="#ç¬¬-4-ç« -ç»“æ„åŒ–ç¼–ç¨‹" class="headerlink" title="ç¬¬ 4 ç«  ç»“æ„åŒ–ç¼–ç¨‹"></a>ç¬¬ 4 ç«  ç»“æ„åŒ–ç¼–ç¨‹</h4><ul><li>Bohm å’Œ Jocopini åˆšåˆšè¯æ˜äº†äººä»¬å¯ä»¥ç”¨é¡ºåºç»“æ„ã€åˆ†æ”¯ç»“æ„ã€å¾ªç¯ç»“æ„è¿™ä¸‰ç§ç»“æ„æ„é€ å‡ºä»»ä½•ç¨‹åºã€‚</li><li>è¯æ˜äº†æˆ‘ä»¬æ„å»ºå¯æ¨å¯¼æ¨¡å—æ‰€éœ€è¦çš„æ§åˆ¶ç»“æ„é›†ä¸æ„å»ºæ‰€æœ‰ç¨‹åºæ‰€éœ€çš„æ§åˆ¶ç»“æ„é›†çš„æœ€å°é›†æ˜¯ç­‰åŒçš„ã€‚</li><li>ç»“æ„åŒ–ç¼–ç¨‹èŒƒå¼å¯å°†æ¨¡å—é€’å½’é™è§£æ‹†åˆ†ä¸ºå¯æ¨å¯¼çš„å•å…ƒï¼Œè¿™å°±æ„å‘³ç€æ¨¡å—ä¹Ÿå¯ä»¥æŒ‰åŠŸèƒ½è¿›è¡Œé™è§£æ‹†åˆ†ã€‚</li><li>æµ‹è¯•åªèƒ½å±•ç¤º Bug çš„å­˜åœ¨ï¼Œå¹¶ä¸èƒ½è¯æ˜ä¸å­˜åœ¨ Bugã€‚<ul><li>æ¢å¥è¯è¯´ï¼Œä¸€æ®µç¨‹åºå¯ä»¥ç”±ä¸€ä¸ªæµ‹è¯•æ¥è¯æ˜å…¶é”™è¯¯æ€§ï¼Œä½†æ˜¯å´ä¸èƒ½è¢«è¯æ˜æ˜¯æ­£ç¡®çš„ã€‚æµ‹è¯•çš„ä½œç”¨æ˜¯è®©æˆ‘ä»¬å¾—å‡ºæŸæ®µç¨‹åºå·²ç»è¶³å¤Ÿå®ç°å½“å‰ç›®æ ‡è¿™ä¸€ç»“è®ºã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">ç»“æ„åŒ–ç¼–ç¨‹å¯ä»¥è®©æˆ‘ä»¬å°†ä¸€ä¸ªå¤§çš„æ¨¡å—æŒ‰ç…§åŠŸèƒ½è¿›è¡Œæ‹†åˆ†ï¼Œå˜æˆå°çš„åŠŸèƒ½æ¨¡å—ï¼ŒåŒæ—¶é€šè¿‡æµ‹è¯•æˆ‘ä»¬å¯ä»¥è¯æ˜å…¶é”™è¯¯æ€§ï¼Œæ— è®ºæ˜¯æ¶æ„ä¸Šè¿˜æ˜¯å®é™…çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¤§æ¨¡å—æ‹†å°æ¨¡å—çš„æ€è·¯çš„æ•°ä¸èƒœæ•°ï¼Œå…¶å®å•ä½“åº”ç”¨æ‹†åˆ†ä¸ºå¾®æœåŠ¡åº”ç”¨ä¹Ÿæ˜¯è¿™ä¸ªèŒƒç•´å†…çš„ã€‚</div></li></ul></li></ul><h4 id="ç¬¬-5-ç« -é¢å‘å¯¹è±¡ç¼–ç¨‹"><a href="#ç¬¬-5-ç« -é¢å‘å¯¹è±¡ç¼–ç¨‹" class="headerlink" title="ç¬¬ 5 ç«  é¢å‘å¯¹è±¡ç¼–ç¨‹"></a>ç¬¬ 5 ç«  é¢å‘å¯¹è±¡ç¼–ç¨‹</h4><ul><li>ä»€ä¹ˆæ˜¯é¢å‘å¯¹è±¡ï¼Ÿ<ul><li>ä¸€ç§å¸¸è§çš„å›ç­”æ˜¯â€œæ•°æ®ä¸å‡½æ•°çš„ç»„åˆâ€ï¼Œè¿™ç§ä¸å¤ªè´´åˆ‡</li><li>å¦ä¸€ç§å¸¸è§çš„å›ç­”æ˜¯â€œé¢å‘å¯¹è±¡ç¼–ç¨‹æ˜¯ä¸€ç§å¯¹çœŸå®ä¸–ç•Œè¿›è¡Œå»ºæ¨¡çš„æ–¹å¼â€ï¼Œè¿™æœ‰ç‚¹é¿é‡å°±è½»<ul><li>é¢å‘å¯¹è±¡ç†è®ºæ˜¯åœ¨ 1966 å¹´æå‡ºçš„ï¼Œå½“æ—¶ Dahl å’Œ Nygaard ä¸»è¦æ˜¯å°†å‡½æ•°è°ƒç”¨æ ˆè¿ç§»åˆ°äº†å †åŒºåŸŸä¸­</li></ul></li><li>é¢å‘å¯¹è±¡ç¼–ç¨‹æ˜¯å°è£…ï¼ˆencapsulationï¼‰ã€ç»§æ‰¿ï¼ˆinheritanceï¼‰ã€å¤šæ€ï¼ˆpolymorphismï¼‰è¿™ä¸‰é¡¹çš„æœ‰æœºç»„åˆ</li></ul></li><li>å°è£…<ul><li>é€šè¿‡é‡‡ç”¨å°è£…ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸€ç»„ç›¸å…³è”çš„æ•°æ®å’Œå‡½æ•°åœˆèµ·æ¥ï¼Œä½¿åœˆå¤–é¢çš„ä»£ç åªèƒ½çœ‹è§éƒ¨åˆ†å‡½æ•°ï¼Œæ•°æ®åˆ™å®Œå…¨ä¸å¯è§</li><li>C è¯­è¨€ä¹Ÿæ”¯æŒå®Œæ•´çš„å°è£…ç‰¹æ€§ï¼Œä½¿ç”¨ C è¯­è¨€çš„æ—¶å€™åº”ç”¨å¤´æ–‡ä»¶ <code>.h</code>  çš„æ¨¡å—æ˜¯æ— æ³•çŸ¥é“ç»“æ„ä½“ä¸­çš„æˆå‘˜å˜é‡çš„ï¼Œä½†æ˜¯ C++ çš„å¤´æ–‡ä»¶ä¸­åŒ…å«äº†æˆå‘˜ä¿¡æ¯ã€‚</li><li>ä¸æ˜¯é¢å‘å¯¹è±¡è¯­è¨€çš„ C è¯­è¨€ç›¸å¯¹äºé¢å‘å¯¹è±¡è¯­è¨€ C++ åè€Œæ‹¥æœ‰æ›´å¥½çš„å°è£…ç‰¹æ€§ï¼Œæ‰€ä»¥<strong>æˆ‘ä»¬å¾ˆéš¾è¯´å¼ºå°è£…æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹çš„å¿…è¦æ¡ä»¶</strong></li></ul></li><li>ç»§æ‰¿<ul><li>ç»§æ‰¿çš„ä¸»è¦ä½œç”¨æ˜¯è®©æˆ‘ä»¬å¯ä»¥åœ¨æŸä¸ªä½œç”¨åŸŸå†…å¯¹å¤–éƒ¨å®šä¹‰çš„æŸä¸€ç»„å˜é‡ä¸å‡½æ•°è¿›è¡Œè¦†ç›–</li><li>C å…¶å®ä¹Ÿå¯ä»¥å®ç°ç»§æ‰¿ï¼Œåªæ˜¯ç›¸å¯¹é¢å‘å¯¹è±¡è¯­è¨€è€Œè¨€ä¼šæ›´åŠ å›°éš¾ã€‚</li></ul></li><li>å¤šæ€<ul><li>å½’æ ¹ç»“åº•ï¼Œå¤šæ€å…¶å®ä¸è¿‡å°±æ˜¯å‡½æ•°æŒ‡é’ˆçš„ä¸€ç§åº”ç”¨ã€‚ä½†æ˜¯å‡½æ•°æŒ‡é’ˆéå¸¸å±é™©ï¼Œéœ€è¦äººä¸ºçš„éµå®ˆå¾ˆå¤šçº¦å®šï¼Œå®¹æ˜“å‡º bugã€‚</li><li>é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€è™½ç„¶åœ¨å¤šæ€ä¸Šå¹¶æ²¡æœ‰ç†è®ºåˆ›æ–°ï¼Œä½†å®ƒä»¬ä¹Ÿç¡®å®è®©å¤šæ€å˜å¾—æ›´å®‰å…¨ã€æ›´ä¾¿äºä½¿ç”¨äº†ã€‚</li></ul></li><li>ä¾èµ–åè½¬<ul><li>ä¾èµ–å…³ç³»ï¼ˆæˆ–è€…å«ç»§æ‰¿å…³ç³»ï¼‰çš„æ–¹å‘å’Œæ§åˆ¶æµæ­£å¥½æ˜¯ç›¸åçš„ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºä¾èµ–åè½¬</li><li>ä¾èµ–å…³ç³»éƒ½å¯ä»¥é€šè¿‡å¼•å…¥æ¥å£çš„æ–¹å¼æ¥è¿›è¡Œåè½¬ã€‚</li><li>é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œè½¯ä»¶æ¶æ„å¸ˆå¯ä»¥å®Œå…¨æ§åˆ¶é‡‡ç”¨äº†é¢å‘å¯¹è±¡è¿™ç§ç¼–ç¨‹æ–¹å¼çš„ç³»ç»Ÿä¸­æ‰€æœ‰çš„æºä»£ç ä¾èµ–å…³ç³»ï¼Œ</li><li>è€Œä¸å†å—åˆ°ç³»ç»Ÿæ§åˆ¶æµçš„é™åˆ¶ã€‚ä¸ç®¡å“ªä¸ªæ¨¡å—è°ƒç”¨æˆ–è€…è¢«è°ƒç”¨ï¼Œè½¯ä»¶æ¶æ„å¸ˆéƒ½å¯ä»¥éšæ„æ›´æ”¹æºä»£ç ä¾èµ–å…³ç³»ã€‚</li><li>å½“æŸä¸ªç»„ä»¶çš„æºä»£ç éœ€è¦ä¿®æ”¹æ—¶ï¼Œä»…ä»…éœ€è¦é‡æ–°éƒ¨ç½²è¯¥ç»„ä»¶ï¼Œä¸éœ€è¦æ›´æ”¹å…¶ä»–ç»„ä»¶ï¼Œè¿™å°±æ˜¯ç‹¬ç«‹éƒ¨ç½²èƒ½åŠ›ã€‚</li></ul></li><li><strong>é¢å‘å¯¹è±¡ç¼–ç¨‹å°±æ˜¯ä»¥å¤šæ€ä¸ºæ‰‹æ®µæ¥å¯¹æºä»£ç ä¸­çš„ä¾èµ–å…³ç³»è¿›è¡Œæ§åˆ¶çš„èƒ½åŠ›ï¼Œ</strong>è¿™ç§èƒ½åŠ›è®©è½¯ä»¶æ¶æ„å¸ˆå¯ä»¥æ„å»ºå‡ºæŸç§æ’ä»¶å¼æ¶æ„ï¼Œè®©é«˜å±‚ç­–ç•¥æ€§ç»„ä»¶ä¸åº•å±‚å®ç°æ€§ç»„ä»¶ç›¸åˆ†ç¦»ï¼Œåº•å±‚ç»„ä»¶å¯ä»¥è¢«ç¼–è¯‘æˆæ’ä»¶ï¼Œå®ç°ç‹¬ç«‹äºé«˜å±‚ç»„ä»¶çš„å¼€å‘å’Œéƒ¨ç½²ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">åœ¨åˆšå­¦ä¹ ç¼–ç¨‹çš„æ—¶å€™ï¼Œå­¦åˆ°é¢å‘å¯¹è±¡ä¸€å®šä¼šè¯´åˆ°ï¼Œå°è£…ã€ç»§æ‰¿ã€å’Œå¤šæ€ï¼Œä½†æ˜¯é€šè¿‡è¿™ä¸€ç« æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œé¢å‘å¯¹è±¡è¯­è¨€çš„å°è£…ä¸ä¸€å®šæ¯”é¢å‘è¿‡ç¨‹çš„ C è¯­è¨€åšçš„æ›´å¥½ï¼Œè¿™é‡Œå¼ºè°ƒçš„æ›´é‡è¦çš„æ˜¯ä½¿ç”¨å¤šæ€çš„æ‰‹æ®µå¯¹æºç çš„ä¾èµ–å…³ç³»è¿›è¡Œæ§åˆ¶ï¼Œä¸»è¦æ˜¯æŒ‡é€šè¿‡æ¥å£æ¥å®ç°ä¾èµ–åè½¬ï¼Œè¿™æ ·å°±å¯ä»¥å°†ç»„ä»¶è¿›è¡Œåˆ†ç¦»ï¼Œå¯ä»¥è¿›è¡Œç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²ã€‚<br>æˆ‘ç°åœ¨ä¸»è¦ä½¿ç”¨çš„è¯­è¨€æ˜¯ Goï¼Œæœ‰ä¸€ä¸ªå¸¸è§çš„é—®é¢˜å°±æ˜¯ Go æ˜¯ä¸æ˜¯ä¸€ä¸ªé¢å‘å¯¹è±¡è¯­è¨€ï¼Œå›ç­”ä¹Ÿæ˜¯ Yes or noï¼Œæ˜¯ä¹Ÿä¸æ˜¯ï¼ŒGo ä¸æ”¯æŒç»§æ‰¿ï¼Œä¹Ÿä¸æ”¯æŒå‡½æ•°é‡è½½ï¼Œè¿ç®—ç¬¦é‡è½½ç­‰åœ¨é¢å‘å¯¹è±¡è¯­è¨€éå¸¸å¸¸è§çš„ç‰¹æ€§ï¼Œä½†æ˜¯ Go çš„æ¥å£éå¸¸å¼ºå¤§ï¼Œä¸éœ€è¦æ˜¾ç¤ºä¾èµ–æ¥å£çš„è®¾è®¡è®©æˆ‘ä»¬åœ¨ä¾èµ–åè½¬çš„ä½¿ç”¨ä¸Šæ›´åŠ æ¸¸åˆƒæœ‰ä½™ã€‚</div></li></ul><h4 id="ç¬¬-6-ç« -å‡½æ•°å¼ç¼–ç¨‹"><a href="#ç¬¬-6-ç« -å‡½æ•°å¼ç¼–ç¨‹" class="headerlink" title="ç¬¬ 6 ç«  å‡½æ•°å¼ç¼–ç¨‹"></a>ç¬¬ 6 ç«  å‡½æ•°å¼ç¼–ç¨‹</h4><ul><li>å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­çš„å˜é‡ï¼ˆVariableï¼‰æ˜¯ä¸å¯å˜ï¼ˆVaryï¼‰çš„ã€‚</li><li>ä¸ºä»€ä¹ˆè½¯ä»¶æ¶æ„å¸ˆè¦æ“å¿ƒå˜é‡çš„å¯å˜æ€§å‘¢ï¼Ÿç­”æ¡ˆæ˜¾è€Œæ˜“è§ï¼šæ‰€æœ‰çš„ç«äº‰é—®é¢˜ã€æ­»é”é—®é¢˜ã€å¹¶å‘æ›´æ–°é—®é¢˜éƒ½æ˜¯ç”±å¯å˜å˜é‡å¯¼è‡´çš„ã€‚</li><li>ä¸€ä¸ªæ¶æ„è®¾è®¡è‰¯å¥½çš„åº”ç”¨ç¨‹åºåº”è¯¥å°†çŠ¶æ€ä¿®æ”¹çš„éƒ¨åˆ†å’Œä¸éœ€è¦ä¿®æ”¹çŠ¶æ€çš„éƒ¨åˆ†éš”ç¦»æˆå•ç‹¬çš„ç»„ä»¶ï¼Œç„¶åç”¨åˆé€‚çš„æœºåˆ¶æ¥ä¿æŠ¤å¯å˜é‡ã€‚</li><li>äº‹ä»¶æº¯æºä½“ç³»ä¸‹ï¼Œæˆ‘ä»¬åªå­˜å‚¨äº‹åŠ¡è®°å½•ï¼Œä¸å­˜å‚¨å…·ä½“çŠ¶æ€ã€‚å½“éœ€è¦å…·ä½“çŠ¶æ€æ—¶ï¼Œæˆ‘ä»¬åªè¦ä»å¤´å¼€å§‹è®¡ç®—æ‰€æœ‰çš„äº‹åŠ¡å³å¯ã€‚</li><li>è¿™ç§æ•°æ®å­˜å‚¨æ¨¡å¼ä¸­ä¸å­˜åœ¨åˆ é™¤å’Œæ›´æ–°çš„æƒ…å†µï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸æ˜¯ CRUDï¼Œè€Œæ˜¯ CRã€‚å› ä¸ºæ›´æ–°å’Œåˆ é™¤è¿™ä¸¤ç§æ“ä½œéƒ½ä¸å­˜åœ¨äº†ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸å­˜åœ¨å¹¶å‘é—®é¢˜ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">åœ¨æˆ‘ä»¬åˆšåˆšç»“æŸçš„ä¸Šä¸€ä¸ªç³»åˆ—ï¼Œ<a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Goå¹¶å‘ç¼–ç¨‹</a>ä¸­ï¼Œæˆ‘ä»¬è®²åˆ°çš„å¤§é‡æ‰‹æ®µæ¥é¿å…æ•°æ®ç«äº‰ï¼Œè¿™äº›éƒ½æ˜¯ç”±äºåœ¨å¹¶å‘æ—¶å†™å…¥å¯¼è‡´çš„ï¼Œè€Œå‡½æ•°å¼ç¼–ç¨‹æœ€é‡è¦çš„ä¸€ä¸ªç‰¹æ€§å°±æ˜¯å˜é‡ä¸å¯å˜ï¼Œç”±äºå˜é‡æ— æ³•è¢«ä¿®æ”¹æ‰€ä»¥è‡ªç„¶è€Œç„¶å°±ä¸å­˜åœ¨æ•°æ®ç«äº‰ï¼Œä¹Ÿå°±ä¸éœ€è¦åŠ é”ï¼Œè¿™æ ·å¯ä»¥è·å¾—å¾ˆé«˜çš„æ€§èƒ½ã€‚</div></li></ul><h3 id="ç¬¬ä¸‰éƒ¨åˆ†-è®¾è®¡åŸåˆ™"><a href="#ç¬¬ä¸‰éƒ¨åˆ†-è®¾è®¡åŸåˆ™" class="headerlink" title="ç¬¬ä¸‰éƒ¨åˆ† è®¾è®¡åŸåˆ™"></a>ç¬¬ä¸‰éƒ¨åˆ† è®¾è®¡åŸåˆ™</h3><p>è½¯ä»¶æ„å»ºä¸­å±‚ç»“æ„çš„ä¸»è¦ç›®æ ‡:</p><ul><li>ä½¿è½¯ä»¶å¯å®¹å¿è¢«æ”¹åŠ¨ã€‚</li><li>ä½¿è½¯ä»¶æ›´å®¹æ˜“è¢«ç†è§£ã€‚</li><li>æ„å»ºå¯åœ¨å¤šä¸ªè½¯ä»¶ç³»ç»Ÿä¸­å¤ç”¨çš„ç»„ä»¶ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">åœ¨ä¹‹å‰çš„<a href="https://lailin.xyz/post/go-design-pattern.html">ã€ŠGoè®¾è®¡æ¨¡å¼ã€‹</a>ç³»åˆ—æ–‡ç« å½“ä¸­ä¹Ÿæœ‰æåˆ° SOLID åŸåˆ™ï¼Œæ¢ä¸ªè§’åº¦å¯ä»¥å‘ç°è¿™äº›å…¶å®éƒ½æ˜¯æ®Šé€”åŒå½’çš„ä¸€äº›ä¸œè¥¿ï¼ŒSOLID åŸåˆ™çš„å†å²å·²ç»éå¸¸æ‚ ä¹…äº†ï¼Œä½†æ˜¯ç›´åˆ°ç°åœ¨å®ƒä»ç„¶éå¸¸å…·æœ‰æŒ‡å¯¼æ„ä¹‰ã€‚</div></li></ul><h4 id="ç¬¬-7-ç« -SRPï¼šå•ä¸€èŒè´£åŸåˆ™"><a href="#ç¬¬-7-ç« -SRPï¼šå•ä¸€èŒè´£åŸåˆ™" class="headerlink" title="ç¬¬ 7 ç«  SRPï¼šå•ä¸€èŒè´£åŸåˆ™"></a>ç¬¬ 7 ç«  SRPï¼šå•ä¸€èŒè´£åŸåˆ™</h4><ul><li><strong>ä»»ä½•ä¸€ä¸ªè½¯ä»¶æ¨¡å—éƒ½åº”è¯¥æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªè¢«ä¿®æ”¹çš„åŸå› ã€‚</strong></li><li>ä»»ä½•ä¸€ä¸ªè½¯ä»¶æ¨¡å—éƒ½åº”è¯¥åªå¯¹ä¸€ä¸ªç”¨æˆ·ï¼ˆUserï¼‰æˆ–ç³»ç»Ÿåˆ©ç›Šç›¸å…³è€…ï¼ˆStakeholderï¼‰è´Ÿè´£ã€‚</li><li><strong>ä»»ä½•ä¸€ä¸ªè½¯ä»¶æ¨¡å—éƒ½åº”è¯¥åªå¯¹æŸä¸€ç±»è¡Œä¸ºè€…è´Ÿè´£ã€‚</strong></li><li><strong>åä¾‹: ä»£ç åˆå¹¶å†²çª</strong><ul><li>å¤šäººä¸ºäº†ä¸åŒçš„ç›®çš„ä¿®æ”¹äº†åŒä¸€ä»½æºä»£ç ï¼Œè¿™å¾ˆå®¹æ˜“é€ æˆé—®é¢˜çš„äº§ç”Ÿã€‚</li><li>é¿å…è¿™ç§é—®é¢˜äº§ç”Ÿçš„æ–¹æ³•å°±æ˜¯å°†æœåŠ¡ä¸åŒè¡Œä¸ºè€…çš„ä»£ç è¿›è¡Œåˆ‡åˆ†ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">å•ä¸€èŒè´£åŸåˆ™éå¸¸å®¹æ˜“è¢«è¯¯è®¤ä¸ºâ€œæ¯ä¸ªæ¨¡å—åº”è¯¥åªåšä¸€ä»¶äº‹â€ï¼Œæ²¡é”™ä¹‹å‰æˆ‘ä¹Ÿæ˜¯è¿™ä¹ˆç†è§£çš„ï¼Œè™½ç„¶è¿™ä¸ªæè¿°æ²¡é”™ï¼Œä½†æ˜¯è¿™å¹¶ä¸æ˜¯ SRP çš„å…¨éƒ¨ã€‚</div></li></ul></li></ul><h4 id="ç¬¬-8-ç« -OCPï¼šå¼€é—­åŸåˆ™"><a href="#ç¬¬-8-ç« -OCPï¼šå¼€é—­åŸåˆ™" class="headerlink" title="ç¬¬ 8 ç«  OCPï¼šå¼€é—­åŸåˆ™"></a>ç¬¬ 8 ç«  OCPï¼šå¼€é—­åŸåˆ™</h4><ul><li>è®¾è®¡è‰¯å¥½çš„è®¡ç®—æœºè½¯ä»¶åº”è¯¥æ˜“äºæ‰©å±•ï¼ŒåŒæ—¶æŠ—æ‹’ä¿®æ”¹ã€‚<ul><li>æ¢å¥è¯è¯´ï¼Œ<strong>ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„è®¡ç®—æœºç³»ç»Ÿåº”è¯¥åœ¨ä¸éœ€è¦ä¿®æ”¹çš„å‰æä¸‹å°±å¯ä»¥è½»æ˜“è¢«æ‰©å±•ã€‚</strong></li></ul></li><li>ä¸€ä¸ªå¥½çš„è½¯ä»¶æ¶æ„è®¾è®¡å¸ˆä¼šåŠªåŠ›å°†æ—§ä»£ç çš„ä¿®æ”¹éœ€æ±‚é‡é™è‡³æœ€å°ï¼Œç”šè‡³ä¸º 0ã€‚<ul><li>å¯ä»¥å…ˆå°†æ»¡è¶³ä¸åŒéœ€æ±‚çš„ä»£ç åˆ†ç»„ï¼ˆå³ SRPï¼‰ï¼Œç„¶åå†æ¥è°ƒæ•´è¿™äº›åˆ†ç»„ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼ˆå³ DIPï¼‰</li></ul></li><li>å¦‚æœ A ç»„ä»¶ä¸æƒ³è¢« B ç»„ä»¶ä¸Šå‘ç”Ÿçš„ä¿®æ”¹æ‰€å½±å“ï¼Œé‚£ä¹ˆå°±åº”è¯¥è®© B ç»„ä»¶ä¾èµ–äº A ç»„ä»¶ã€‚</li><li>è½¯ä»¶æ¶æ„å¸ˆå¯ä»¥æ ¹æ®ç›¸å…³å‡½æ•°è¢«ä¿®æ”¹çš„åŸå› ã€ä¿®æ”¹çš„æ–¹å¼åŠä¿®æ”¹çš„æ—¶é—´æ¥å¯¹å…¶è¿›è¡Œåˆ†ç»„éš”ç¦»ï¼Œå¹¶å°†è¿™äº›äº’ç›¸éš”ç¦»çš„å‡½æ•°åˆ†ç»„æ•´ç†æˆç»„ä»¶ç»“æ„ï¼Œä½¿å¾—é«˜é˜¶ç»„ä»¶ä¸ä¼šå› ä½é˜¶ç»„ä»¶è¢«ä¿®æ”¹è€Œå—åˆ°å½±å“ã€‚</li><li>OCP æ˜¯æˆ‘ä»¬è¿›è¡Œç³»ç»Ÿæ¶æ„è®¾è®¡çš„ä¸»å¯¼åŸåˆ™ï¼Œå…¶ä¸»è¦ç›®æ ‡æ˜¯è®©ç³»ç»Ÿæ˜“äºæ‰©å±•ï¼ŒåŒæ—¶é™åˆ¶å…¶æ¯æ¬¡è¢«ä¿®æ”¹æ‰€å½±å“çš„èŒƒå›´ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">å¼€é—­åŸåˆ™åœ¨æ¶æ„è®¾è®¡ä¸Šéå¸¸å¸¸è§ï¼Œå…¶ä¸­æœ€å¸¸è§çš„åšæ³•å°±æ˜¯ä½¿ç”¨æ¥å£å®ç°ä¾èµ–åè½¬ï¼Œå¦‚æœå¼€é—­åŸåˆ™å®ç°çš„ä¸å¥½å°±æœ‰å¯èƒ½å¯¼è‡´æˆ‘ä»¬åœ¨è¿›è¡Œåç»­åŠŸèƒ½æ‰©å±•çš„æ—¶å€™ç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ï¼Œæˆæœ¬éå¸¸çš„é«˜ã€‚</div></li></ul><h4 id="ç¬¬-9-ç« -LSPï¼šé‡Œæ°æ›¿æ¢åŸåˆ™"><a href="#ç¬¬-9-ç« -LSPï¼šé‡Œæ°æ›¿æ¢åŸåˆ™" class="headerlink" title="ç¬¬ 9 ç«  LSPï¼šé‡Œæ°æ›¿æ¢åŸåˆ™"></a>ç¬¬ 9 ç«  LSPï¼šé‡Œæ°æ›¿æ¢åŸåˆ™</h4><ul><li>å¦‚æœå¯¹äºæ¯ä¸ªç±»å‹æ˜¯ S çš„å¯¹è±¡ o1 éƒ½å­˜åœ¨ä¸€ä¸ªç±»å‹ä¸º T çš„å¯¹è±¡ o2ï¼Œèƒ½ä½¿æ“ä½œ T ç±»å‹çš„ç¨‹åº P åœ¨ç”¨ o2 æ›¿æ¢ o1 æ—¶è¡Œä¸ºä¿æŒä¸å˜ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°† S ç§°ä¸º T çš„å­ç±»å‹ã€‚</li><li>æ¯”è¾ƒå¸¸è§çš„ä¸€ä¸ªè¿å LSP åŸåˆ™çš„ä¾‹å­ï¼Œé•¿æ–¹å½¢ä¸æ­£æ–¹å½¢<ul><li>Square ç±»å¹¶ä¸æ˜¯ Rectangle ç±»çš„å­ç±»å‹ï¼Œå› ä¸º Rectangle ç±»çš„é«˜å’Œå®½å¯ä»¥åˆ†åˆ«ä¿®æ”¹ï¼Œè€Œ Square ç±»çš„é«˜å’Œå®½åˆ™å¿…é¡»ä¸€åŒä¿®æ”¹ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">è¿™ä¸ªåé¢ä¾‹å­å¯¹æˆ‘çš„éœ‡æ’¼æ¯”è¾ƒå¤§ï¼Œä¾ç¨€è®°å¾—æœ€å¼€å§‹åœ¨å­¦ä¹ ç¼–ç¨‹è¯­è¨€ç»§æ‰¿çš„ä¾‹å­çš„æ—¶å€™å°±å¸¸å¸¸ç”¨é•¿æ–¹å½¢æ­£æ–¹å½¢æ¥ä¸¾ä¾‹ï¼Œä½†æ˜¯è¿™ä¸ªå…¶å®æ˜¯è¿åäº†é‡Œå¼æ›¿æ¢åŸåˆ™çš„ã€‚<br>åœ¨æ¶æ„è®¾è®¡ä¸Šè¿™ä¸ªåŸåˆ™ä¹Ÿååˆ†çš„é‡è¦ï¼Œå› ä¸ºæˆ‘ä»¬åªæœ‰åšåˆ°äº† LSP æˆ‘ä»¬æ‰å¯ä»¥åœ¨ä¾‹å¦‚æ•°æ®åº“ç±»å‹åˆ‡æ¢ï¼Œå¾®æœåŠ¡æ‹†åˆ†è¿™ç§åœºæ™¯ä¸‹åšçš„æ¸¸åˆƒæœ‰ä½™ã€‚</div></li></ul></li></ul><h4 id="ç¬¬-10-ç« -ISPï¼šæ¥å£éš”ç¦»åŸåˆ™"><a href="#ç¬¬-10-ç« -ISPï¼šæ¥å£éš”ç¦»åŸåˆ™" class="headerlink" title="ç¬¬ 10 ç«  ISPï¼šæ¥å£éš”ç¦»åŸåˆ™"></a>ç¬¬ 10 ç«  ISPï¼šæ¥å£éš”ç¦»åŸåˆ™</h4><ul><li>ISP æœ€åˆçš„æˆå› ï¼šåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä»»ä½•å±‚æ¬¡çš„è½¯ä»¶è®¾è®¡å¦‚æœä¾èµ–äºä¸éœ€è¦çš„ä¸œè¥¿ï¼Œéƒ½ä¼šæ˜¯æœ‰å®³çš„ã€‚</li><li>ä»»ä½•å±‚æ¬¡çš„è½¯ä»¶è®¾è®¡å¦‚æœä¾èµ–äº†å®ƒå¹¶ä¸éœ€è¦çš„ä¸œè¥¿ï¼Œå°±ä¼šå¸¦æ¥æ„æ–™ä¹‹å¤–çš„éº»çƒ¦ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">ç”±äº Go æ¥å£çš„éšå¼ä¾èµ–çš„ç‰¹æ€§ï¼Œè®© ISP åœ¨ Go ä¸­å¤„å¤„å¯è§ï¼Œæˆ‘ä»¬å¸¸å¸¸é‡‡ç”¨çš„æ–¹å¼å°±æ˜¯åœ¨è°ƒç”¨è€…å¤„ä¾èµ–æ¥å£ï¼Œè€Œä¸ç®¡å®ç°ï¼Œè¿™æ ·å°±å¯ä»¥åšåˆ°ï¼Œæ¨¡å—åˆ†ç¦»ä»¥åŠæœ€å°åŒ–ä¾èµ–ã€‚</div></li></ul><h4 id="ç¬¬-11-ç« -DIPï¼šä¾èµ–åè½¬åŸåˆ™"><a href="#ç¬¬-11-ç« -DIPï¼šä¾èµ–åè½¬åŸåˆ™" class="headerlink" title="ç¬¬ 11 ç«  DIPï¼šä¾èµ–åè½¬åŸåˆ™"></a>ç¬¬ 11 ç«  DIPï¼šä¾èµ–åè½¬åŸåˆ™</h4><ul><li>å¦‚æœæƒ³è¦è®¾è®¡ä¸€ä¸ªçµæ´»çš„ç³»ç»Ÿï¼Œåœ¨æºä»£ç å±‚æ¬¡çš„ä¾èµ–å…³ç³»ä¸­å°±åº”è¯¥å¤šå¼•ç”¨æŠ½è±¡ç±»å‹ï¼Œè€Œéå…·ä½“å®ç°ã€‚</li><li>åœ¨åº”ç”¨ DIP æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¿…è€ƒè™‘ç¨³å®šçš„æ“ä½œç³»ç»Ÿæˆ–è€…å¹³å°è®¾æ–½ï¼Œå› ä¸ºè¿™äº›ç³»ç»Ÿæ¥å£å¾ˆå°‘ä¼šæœ‰å˜åŠ¨ã€‚</li><li>ä¸»è¦åº”è¯¥å…³æ³¨çš„æ˜¯è½¯ä»¶ç³»ç»Ÿå†…éƒ¨é‚£äº›ä¼šç»å¸¸å˜åŠ¨çš„ï¼ˆvolatileï¼‰å…·ä½“å®ç°æ¨¡å—ï¼Œè¿™äº›æ¨¡å—æ˜¯ä¸åœå¼€å‘çš„ï¼Œä¹Ÿå°±ä¼šç»å¸¸å‡ºç°å˜æ›´ã€‚</li><li>ç¼–ç è§„èŒƒ<ul><li>åº”åœ¨ä»£ç ä¸­å¤šä½¿ç”¨æŠ½è±¡æ¥å£ï¼Œå°½é‡é¿å…ä½¿ç”¨é‚£äº›å¤šå˜çš„å…·ä½“å®ç°ç±»ã€‚</li><li>ä¸è¦åœ¨å…·ä½“å®ç°ç±»ä¸Šåˆ›å»ºè¡ç”Ÿç±»ã€‚æˆ‘ä»¬å¯¹ç»§æ‰¿çš„ä½¿ç”¨åº”è¯¥æ ¼å¤–å°å¿ƒã€‚å³ä½¿æ˜¯åœ¨ç¨å¾®ä¾¿äºä¿®æ”¹çš„åŠ¨æ€ç±»å‹è¯­è¨€ä¸­ï¼Œè¿™æ¡å®ˆåˆ™ä¹Ÿåº”è¯¥è¢«è®¤çœŸè€ƒè™‘</li><li>ä¸è¦è¦†ç›–ï¼ˆoverrideï¼‰åŒ…å«å…·ä½“å®ç°çš„å‡½æ•°</li><li>åº”é¿å…åœ¨ä»£ç ä¸­å†™å…¥ä¸ä»»ä½•å…·ä½“å®ç°ç›¸å…³çš„åå­—ï¼Œæˆ–è€…æ˜¯å…¶ä»–å®¹æ˜“å˜åŠ¨çš„äº‹ç‰©çš„åå­—ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">é€šå¸¸æ¥è¯´ï¼Œæ¥å£ä¼šæ¯”å®ç°æ›´åŠ ç¨³å®šï¼Œä¸¾ä¸ªåä¾‹ï¼Œå¦‚æœæ¥å£å˜åŠ¨å®ç°æ˜¯å¿…é¡»è¦è·Ÿç€ä¿®æ”¹çš„ï¼Œå› ä¸ºå®ç°æ˜¯ä¾èµ–æ¥å£çš„ï¼Œä½†æ˜¯åè¿‡æ¥ç¡®æœªå¿…ã€‚DIP åŸåˆ™æŒ‡å¯¼æˆ‘ä»¬æ— è®ºæ˜¯åœ¨æ¶æ„è®¾è®¡è¿˜æ˜¯åœ¨ç¼–ç å®ç°å½“ä¸­éƒ½åº”è¯¥å°½é‡çš„ä¾èµ–æŠ½è±¡è€Œä¸æ˜¯å®ç°ç»†èŠ‚ã€‚</div></li></ul></li></ul><h3 id="ç¬¬å››éƒ¨åˆ†-ç»„ä»¶æ„å»ºåŸåˆ™"><a href="#ç¬¬å››éƒ¨åˆ†-ç»„ä»¶æ„å»ºåŸåˆ™" class="headerlink" title="ç¬¬å››éƒ¨åˆ† ç»„ä»¶æ„å»ºåŸåˆ™"></a>ç¬¬å››éƒ¨åˆ† ç»„ä»¶æ„å»ºåŸåˆ™</h3><h4 id="ç¬¬-12-ç« -ç»„ä»¶"><a href="#ç¬¬-12-ç« -ç»„ä»¶" class="headerlink" title="ç¬¬ 12 ç«  ç»„ä»¶"></a>ç¬¬ 12 ç«  ç»„ä»¶</h4><ul><li>ç»„ä»¶æ˜¯è½¯ä»¶çš„éƒ¨ç½²å•å…ƒï¼Œæ˜¯æ•´ä¸ªè½¯ä»¶ç³»ç»Ÿåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­å¯ä»¥ç‹¬ç«‹å®Œæˆéƒ¨ç½²çš„æœ€å°å®ä½“<ul><li>ä¾‹å¦‚ï¼š.jar, .gem, .dll æ–‡ä»¶</li></ul></li><li>é“¾æ¥åŠ è½½å™¨è®©ç¨‹åºå‘˜ä»¬å¯ä»¥å°†ç¨‹åºåˆ‡åˆ†æˆå¤šä¸ªå¯è¢«åˆ†åˆ«ç¼–è¯‘ã€åŠ è½½çš„ç¨‹åºæ®µ</li><li>ç»„ä»¶åŒ–çš„æ’ä»¶å¼æ¶æ„å·²ç»æˆä¸ºæˆ‘ä»¬ä¹ ä»¥ä¸ºå¸¸çš„è½¯ä»¶æ„å»ºå½¢å¼äº†ã€‚</li></ul><h4 id="ç¬¬-13-ç« -ç»„ä»¶èšåˆ"><a href="#ç¬¬-13-ç« -ç»„ä»¶èšåˆ" class="headerlink" title="ç¬¬ 13 ç«  ç»„ä»¶èšåˆ"></a>ç¬¬ 13 ç«  ç»„ä»¶èšåˆ</h4><ul><li>æ„å»ºç»„ä»¶ç›¸å…³çš„åŸºæœ¬åŸåˆ™<ul><li>REPï¼šå¤ç”¨/å‘å¸ƒç­‰åŒåŸåˆ™</li><li>CCPï¼šå…±åŒé—­åŒ…åŸåˆ™</li><li>CRPï¼šå…±åŒå¤ç”¨åŸåˆ™</li></ul></li><li>REPï¼šå¤ç”¨/å‘å¸ƒç­‰åŒåŸåˆ™<ul><li>è½¯ä»¶å¤ç”¨çš„æœ€å°ç²’åº¦åº”ç­‰åŒäºå…¶å‘å¸ƒçš„æœ€å°ç²’åº¦ã€‚</li><li>REP åŸåˆ™å°±æ˜¯æŒ‡ç»„ä»¶ä¸­çš„ç±»ä¸æ¨¡å—å¿…é¡»æ˜¯å½¼æ­¤ç´§å¯†ç›¸å…³çš„</li><li>ä¸€ä¸ªç»„ä»¶ä¸èƒ½ç”±ä¸€ç»„æ¯«æ— å…³è”çš„ç±»å’Œæ¨¡å—ç»„æˆï¼Œå®ƒä»¬ä¹‹é—´åº”è¯¥æœ‰ä¸€ä¸ªå…±åŒçš„ä¸»é¢˜æˆ–è€…å¤§æ–¹å‘ã€‚</li></ul></li><li>CCPï¼šå…±åŒé—­åŒ…åŸåˆ™<ul><li>æˆ‘ä»¬åº”è¯¥å°†é‚£äº›ä¼šåŒæ—¶ä¿®æ”¹ï¼Œå¹¶ä¸”ä¸ºç›¸åŒç›®çš„è€Œä¿®æ”¹çš„ç±»æ”¾åˆ°åŒä¸€ä¸ªç»„ä»¶ä¸­ï¼Œè€Œå°†ä¸ä¼šåŒæ—¶ä¿®æ”¹ï¼Œå¹¶ä¸”ä¸ä¼šä¸ºäº†ç›¸åŒç›®çš„è€Œä¿®æ”¹çš„é‚£äº›ç±»æ”¾åˆ°ä¸åŒçš„ç»„ä»¶ä¸­ã€‚</li></ul></li><li>CRPï¼šå…±åŒå¤ç”¨åŸåˆ™<ul><li>ä¸è¦å¼ºè¿«ä¸€ä¸ªç»„ä»¶çš„ç”¨æˆ·ä¾èµ–ä»–ä»¬ä¸éœ€è¦çš„ä¸œè¥¿ã€‚</li><li>ä¸è¦ä¾èµ–ä¸éœ€è¦ç”¨åˆ°çš„ä¸œè¥¿ã€‚</li></ul></li><li>ç»„ä»¶å¼ åŠ›å›¾</li></ul><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1611759265457-d9a543c3-8c0c-45e2-9f4f-071352f100a1.png" alt="image.png"></p><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">çœ‹åˆ°è¿™ä¸‰ä¸ªåŸåˆ™ä¼šæ„Ÿåˆ°æœ‰ç‚¹ç†Ÿæ‚‰ï¼Œåƒå…±åŒé—­åŒ…åŸåˆ™å°±å’Œ SOLID ä¸­çš„å•ä¸€èŒè´£åŸåˆ™ç±»ä¼¼ï¼Œå…±åŒå¤ç”¨åŸåˆ™å’Œæ¥å£éš”ç¦»åŸåˆ™çœ‹ä¸Šå»ä¹Ÿæœ‰é‚£ä¹ˆå‡ åˆ†ç›¸ä¼¼ï¼Œè¿™äº›çŸ¥è¯†ä»ä¸åŒçš„è§’åº¦çœ‹å¾…æ€»ç»“é—®é¢˜çš„ä¸åŒæœ¯è¯­ã€‚<br>æœ€åè¿™ä¸ªç»„ä»¶å¼ åŠ›å›¾å¾ˆæœ‰æ„æ€ï¼Œè¿™è¯´æ˜æˆ‘ä»¬åœ¨è¿›è¡Œæ¶æ„è®¾è®¡çš„æ—¶å€™æ˜¯ä¸å¯èƒ½åšåˆ°æ¯ä¸€é¡¹éƒ½å¾ˆå®Œç¾çš„ï¼Œè¿™å½“ä¸­ä¼šæœ‰ä¸€ä¸ªå–èˆçš„è¿‡ç¨‹ï¼Œä¹¦ä¸­è®²åˆ°ï¼Œä¸€èˆ¬è€Œè¨€ä¼šé¡¹ç›®åˆæœŸä¼šä»ä¸‰è§’å³ä¾§å¼€å§‹ï¼Œè¿›è¡Œä¸€æ®µæ—¶é—´åä¼šæ»‘åŠ¨åˆ°å·¦è¾¹ï¼Œæ˜¯å› ä¸ºåœ¨åˆæœŸä¸ºäº†æ•ˆç‡æˆ‘ä»¬å¯ä»¥ç‰ºç‰²ä¸€å®šçš„å¤ç”¨æ€§ï¼Œä½†æ˜¯éšç€ä¾èµ–å…³ç³»è¶Šæ¥è¶Šå¤æ‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦è€ƒè™‘å¤ç”¨å’Œæ‰©å±•äº†ã€‚</div><h4 id="ç¬¬-14-ç« -ç»„ä»¶è€¦åˆ"><a href="#ç¬¬-14-ç« -ç»„ä»¶è€¦åˆ" class="headerlink" title="ç¬¬ 14 ç«  ç»„ä»¶è€¦åˆ"></a>ç¬¬ 14 ç«  ç»„ä»¶è€¦åˆ</h4><ul><li>ç»„ä»¶ä¾èµ–å…³ç³»å›¾ä¸­ä¸åº”è¯¥å‡ºç°ç¯ã€‚</li><li>å½“ç»„ä»¶ç»“æ„ä¾èµ–å›¾ä¸­å­˜åœ¨å¾ªç¯ä¾èµ–æ—¶ï¼Œæƒ³è¦æŒ‰æ­£ç¡®çš„é¡ºåºæ„å»ºç»„ä»¶å‡ ä¹æ˜¯ä¸å¯èƒ½çš„ã€‚</li><li>æ‰“ç ´å¾ªç¯ä¾èµ–<ul><li>åº”ç”¨ä¾èµ–åè½¬åŸåˆ™ï¼ˆDIPï¼‰</li><li>åˆ›å»ºä¸€ä¸ªæ–°çš„ç»„ä»¶ï¼Œå¹¶è®© Entities ä¸ Authorize è¿™ä¸¤ä¸ªç»„ä»¶éƒ½ä¾èµ–äºå®ƒã€‚å°†ç°æœ‰çš„è¿™ä¸¤ä¸ªç»„ä»¶ä¸­äº’ç›¸ä¾èµ–çš„ç±»å…¨éƒ¨æ”¾å…¥æ–°ç»„ä»¶</li></ul></li><li>ç»„ä»¶ç»“æ„å›¾æ˜¯ä¸å¯èƒ½è‡ªä¸Šè€Œä¸‹è¢«è®¾è®¡å‡ºæ¥çš„ã€‚å®ƒå¿…é¡»éšç€è½¯ä»¶ç³»ç»Ÿçš„å˜åŒ–è€Œå˜åŒ–å’Œæ‰©å¼ ï¼Œè€Œä¸å¯èƒ½åœ¨ç³»ç»Ÿæ„å»ºçš„æœ€åˆå°±è¢«å®Œç¾è®¾è®¡å‡ºæ¥ã€‚</li><li>ç»„ä»¶ä¾èµ–ç»“æ„å›¾å¹¶ä¸æ˜¯ç”¨æ¥æè¿°åº”ç”¨ç¨‹åºåŠŸèƒ½çš„ï¼Œå®ƒæ›´åƒæ˜¯åº”ç”¨ç¨‹åºåœ¨æ„å»ºæ€§ä¸ç»´æŠ¤æ€§æ–¹é¢çš„ä¸€å¼ åœ°å›¾</li><li>ç»„ä»¶ç»“æ„å›¾ä¸­çš„ä¸€ä¸ªé‡è¦ç›®æ ‡æ˜¯æŒ‡å¯¼å¦‚ä½•éš”ç¦»é¢‘ç¹çš„å˜æ›´</li><li><p>å¦‚æœæˆ‘ä»¬åœ¨è®¾è®¡å…·ä½“ç±»ä¹‹å‰å°±æ¥è®¾è®¡ç»„ä»¶ä¾èµ–å…³ç³»ï¼Œé‚£ä¹ˆå‡ ä¹æ˜¯å¿…ç„¶è¦å¤±è´¥çš„ã€‚å› ä¸ºåœ¨å½“ä¸‹ï¼Œæˆ‘ä»¬å¯¹é¡¹ç›®ä¸­çš„å…±åŒé—­åŒ…ä¸€æ— æ‰€çŸ¥ï¼Œä¹Ÿä¸å¯èƒ½çŸ¥é“å“ªäº›ç»„ä»¶å¯ä»¥å¤ç”¨ï¼Œè¿™æ ·å‡ ä¹ä¸€å®šä¼šåˆ›é€ å‡ºå¾ªç¯ä¾èµ–çš„ç»„ä»¶ã€‚</p><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">åœ¨ Go ä¸­åœ¨ç¼–è¯‘å™¨ä¸Šå°±é™åˆ¶äº†æˆ‘ä»¬ä¸èƒ½å‡ºç°å¾ªç¯ä¾èµ–ï¼Œæ‰€ä»¥æˆ‘ä»¬å¤§é‡çš„ä½¿ç”¨äº† DIP çš„æ–¹å¼ï¼Œä½†æ˜¯è®²å±‚æ¬¡æ‹”é«˜ä¸€ç‚¹ï¼Œä»å¾®æœåŠ¡çš„è§’åº¦æ¥è®²ä»ç„¶ä¸åº”è¯¥å‡ºç°å¾ªç¯ä¾èµ–ï¼Œå¦‚æœå‡ºç°é‚£ä¹ˆåœ¨ç‰ˆæœ¬å‘å¸ƒçš„æ—¶å€™å¯èƒ½ä¼šå¯¼è‡´ç¾éš¾æ€§çš„åæœï¼Œæ¶æ„çš„åŸåˆ™éƒ½æ˜¯æƒ³é€šçš„ï¼Œæˆ‘ä»¬è¦æ—¶åˆ»è­¦æƒ•å¾ªç¯ä¾èµ–çš„å‡ºç°ï¼Œå¯¹äºå¾®æœåŠ¡æ¥è¯´å¯ä»¥åœ¨ api ç½‘å…³è¿›è¡Œåˆ¤å®šæ˜¯å¦æˆç¯</div></li><li><p>ç¨³å®šä¾èµ–åŸåˆ™</p><ul><li>ä¾èµ–å…³ç³»å¿…é¡»è¦æŒ‡å‘æ›´ç¨³å®šçš„æ–¹å‘</li><li>ä»»ä½•ä¸€ä¸ªæˆ‘ä»¬é¢„æœŸä¼šç»å¸¸å˜æ›´çš„ç»„ä»¶éƒ½ä¸åº”è¯¥è¢«ä¸€ä¸ªéš¾äºä¿®æ”¹çš„ç»„ä»¶æ‰€ä¾èµ–ï¼Œå¦åˆ™è¿™ä¸ªå¤šå˜çš„ç»„ä»¶ä¹Ÿå°†ä¼šå˜å¾—éå¸¸éš¾ä»¥è¢«ä¿®æ”¹</li><li>è®©è½¯ä»¶ç»„ä»¶éš¾äºä¿®æ”¹çš„ä¸€ä¸ªæœ€ç›´æ¥çš„åŠæ³•å°±æ˜¯è®©å¾ˆå¤šå…¶ä»–ç»„ä»¶ä¾èµ–äºå®ƒã€‚</li></ul></li><li><p>ç¨³å®šæ€§æŒ‡æ ‡</p><ul><li>å…¶ä¸­ä¸€ç§æ–¹æ³•æ˜¯è®¡ç®—æ‰€æœ‰å…¥å’Œå‡ºçš„ä¾èµ–å…³ç³»ã€‚é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¡ç®—å‡ºä¸€ä¸ªç»„ä»¶çš„ä½ç½®ç¨³å®šæ€§ï¼ˆpositionalstabilityï¼‰ã€‚<ul><li>Fan-inï¼šå…¥å‘ä¾èµ–ï¼Œè¿™ä¸ªæŒ‡æ ‡æŒ‡ä»£äº†ç»„ä»¶å¤–éƒ¨ç±»ä¾èµ–äºç»„ä»¶å†…éƒ¨ç±»çš„æ•°é‡ã€‚</li><li>Fan-outï¼šå‡ºå‘ä¾èµ–ï¼Œè¿™ä¸ªæŒ‡æ ‡æŒ‡ä»£äº†ç»„ä»¶å†…éƒ¨ç±»ä¾èµ–äºç»„ä»¶å¤–éƒ¨ç±»çš„æ•°é‡ã€‚</li><li>Iï¼šä¸ç¨³å®šæ€§ï¼ŒI=Fan-out/ï¼ˆFan-in+Fan-outï¼‰ã€‚è¯¥æŒ‡æ ‡çš„èŒƒå›´æ˜¯[0,1],I=0 æ„å‘³ç€ç»„ä»¶æ˜¯æœ€ç¨³å®šçš„ï¼ŒI=1 æ„å‘³ç€ç»„ä»¶æ˜¯æœ€ä¸ç¨³å®šçš„ã€‚</li></ul></li><li>ç¨³å®šä¾èµ–åŸåˆ™ï¼ˆSDPï¼‰çš„è¦æ±‚æ˜¯è®©æ¯ä¸ªç»„ä»¶çš„ I æŒ‡æ ‡éƒ½å¿…é¡»å¤§äºå…¶æ‰€ä¾èµ–ç»„ä»¶çš„ I æŒ‡æ ‡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç»„ä»¶ç»“æ„ä¾èµ–å›¾ä¸­å„ç»„ä»¶çš„ I æŒ‡æ ‡å¿…é¡»è¦æŒ‰å…¶ä¾èµ–å…³ç³»æ–¹å‘é€’å‡ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">è¿™ä¸€éƒ¨åˆ†æå‡ºäº†ä¸€ä¸ªå¯¹æˆ‘ç°é˜¶æ®µéå¸¸æœ‰ç”¨çš„ä¸€ä¸ªåŸåˆ™ï¼Œè¢«å¤§é‡ä¾èµ–çš„ç»„ä»¶åº”è¯¥æ˜¯ç¨³å®šçš„ï¼Œä¾èµ–å…³ç³»å¿…é¡»è¦æŒ‡å‘æ›´ç¨³å®šçš„æ–¹å‘ï¼Œæˆ‘å½“å‰å¤„åœ¨å…¬å…±æŠ€æœ¯å›¢é˜Ÿï¼Œæˆ‘ä»¬çš„æœåŠ¡è¢«å¤–éƒ¨å¤§é‡çš„ä¾èµ–ï¼Œæ‰€ä»¥åœ¨å˜æ›´çš„æ—¶å€™ä¼šéå¸¸çš„éº»çƒ¦ï¼Œæˆ‘ä»¬ I å€¼éå¸¸çš„å°ï¼Œå‡ ä¹å¯ä»¥è¯´æ¥è¿‘äº 0ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„æœåŠ¡åœ¨è®¾è®¡æ—¶ä¸€å®šè¦æ»¡è¶³å¼€é—­åŸåˆ™ï¼Œä¿è¯è¶³å¤Ÿçš„æ‰©å±•æ€§ã€‚</div></li></ul></li><li><p>ç¨³å®šæŠ½è±¡åŸåˆ™</p><ul><li>ä¸€ä¸ªç»„ä»¶çš„æŠ½è±¡åŒ–ç¨‹åº¦åº”è¯¥ä¸å…¶ç¨³å®šæ€§ä¿æŒä¸€è‡´ã€‚</li><li>å¦‚ä½•æ‰èƒ½è®©ä¸€ä¸ªæ— é™ç¨³å®šçš„ç»„ä»¶ï¼ˆI=0ï¼‰æ¥å—å˜æ›´å‘¢ï¼Ÿå¼€é—­åŸåˆ™ï¼ˆOCPï¼‰ä¸ºæˆ‘ä»¬æä¾›äº†ç­”æ¡ˆã€‚è¿™ä¸ªåŸåˆ™å‘Šè¯‰æˆ‘ä»¬ï¼šåˆ›é€ ä¸€ä¸ªè¶³å¤Ÿçµæ´»ã€èƒ½å¤Ÿè¢«æ‰©å±•ï¼Œè€Œä¸”ä¸éœ€è¦ä¿®æ”¹çš„ç±»æ˜¯å¯èƒ½çš„ï¼Œè€Œè¿™æ­£æ˜¯æˆ‘ä»¬æ‰€éœ€</li><li>å‡è®¾ A æŒ‡æ ‡æ˜¯å¯¹ç»„ä»¶æŠ½è±¡åŒ–ç¨‹åº¦çš„ä¸€ä¸ªè¡¡é‡ï¼Œå®ƒçš„å€¼æ˜¯ç»„ä»¶ä¸­æŠ½è±¡ç±»ä¸æ¥å£æ‰€å çš„æ¯”ä¾‹ã€‚é‚£ä¹ˆï¼š<ul><li>Ncï¼šç»„ä»¶ä¸­ç±»çš„æ•°é‡ã€‚</li><li>Naï¼šç»„ä»¶ä¸­æŠ½è±¡ç±»å’Œæ¥å£çš„æ•°é‡ã€‚</li><li>Aï¼šæŠ½è±¡ç¨‹åº¦ï¼ŒA=NaÃ·Nc</li><li>A æŒ‡æ ‡çš„å–å€¼èŒƒå›´æ˜¯ä» 0 åˆ° 1ï¼Œå€¼ä¸º 0 ä»£è¡¨ç»„ä»¶ä¸­æ²¡æœ‰ä»»ä½•æŠ½è±¡ç±»ï¼Œå€¼ä¸º 1 å°±æ„å‘³ç€ç»„ä»¶ä¸­åªæœ‰æŠ½è±¡ç±»ã€‚</li></ul></li><li><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1611759933727-6f8124f5-4d50-4c18-8b73-4d79c88e6f1b.png" alt="image.png"><ul><li>åªæœ‰å¤šå˜çš„è½¯ä»¶ç»„ä»¶è½åœ¨ç—›è‹¦åŒºä¸­æ‰ä¼šé€ æˆéº»çƒ¦</li><li>ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹é è¿‘ï¼ˆ1,1ï¼‰è¿™ä¸€ä½ç½®ç‚¹çš„ç»„ä»¶ã€‚è¯¥ä½ç½®ä¸Šçš„ç»„ä»¶ä¸ä¼šæ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œå› ä¸ºè¿™äº›ç»„ä»¶é€šå¸¸æ˜¯æ— é™æŠ½è±¡çš„ï¼Œä½†æ˜¯æ²¡æœ‰è¢«å…¶ä»–ç»„ä»¶ä¾èµ–ï¼Œè¿™æ ·çš„ç»„ä»¶å¾€å¾€æ— æ³•ä½¿ç”¨ã€‚</li><li>è¿½æ±‚è®©è¿™äº›ç»„ä»¶ä½äºä¸»åºåˆ—çº¿ä¸Šï¼Œæˆ–è€…è´´è¿‘è¿™æ¡çº¿å³å¯ã€‚</li></ul></li><li>D æŒ‡æ ‡[8]ï¼šè·ç¦» D=|A+I-1|ï¼Œè¯¥æŒ‡æ ‡çš„å–å€¼èŒƒå›´æ˜¯[0,1]ã€‚å€¼ä¸º 0 æ„å‘³ç€ç»„ä»¶æ˜¯ç›´æ¥ä½äºä¸»åºåˆ—çº¿ä¸Šçš„ï¼Œå€¼ä¸º 1 åˆ™æ„å‘³ç€ç»„ä»¶åœ¨è·ç¦»ä¸»åºåˆ—æœ€è¿œçš„ä½ç½®ã€‚</li><li>å¯¹äºä¸€ä¸ªè‰¯å¥½çš„ç³»ç»Ÿè®¾è®¡æ¥è¯´ï¼ŒD æŒ‡æ ‡çš„å¹³å‡å€¼å’Œæ–¹å·®éƒ½åº”è¯¥æ¥è¿‘äº 0<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">ç¨³å®šæŠ½è±¡åŸåˆ™è¯´æ˜äº†è¶Šç¨³å®šçš„ç»„ä»¶åº”è¯¥è¶ŠæŠ½è±¡ï¼Œä»ä»£ç çš„è§’åº¦æ¥è®²ï¼Œæ¥å£æ˜¯æœ€æŠ½è±¡çš„ç»„ä»¶ä¹‹ä¸€ï¼Œå› ä¸ºæ¥å£ä¸€èˆ¬ä¸ä¼šæœ‰å…¶ä»–å¤–éƒ¨çš„ä¾èµ–ï¼Œè€Œè¢«å¤§é‡ä¾èµ–ï¼ŒåŒæ—¶è¿˜ç»™å‡ºä¸€ä¸ªç»Ÿè®¡æŠ½è±¡ç¨‹åº¦çš„æ–¹æ³•ï¼Œè¿™ä¸ªå¯ä»¥ç”¨æ¥ç»Ÿè®¡ä¸€ä¸‹æˆ‘ä»¬ç°åœ¨çš„ç°çŠ¶ã€‚</div></li></ul></li></ul><h3 id="ç¬¬äº”éƒ¨åˆ†-è½¯ä»¶æ¶æ„"><a href="#ç¬¬äº”éƒ¨åˆ†-è½¯ä»¶æ¶æ„" class="headerlink" title="ç¬¬äº”éƒ¨åˆ† è½¯ä»¶æ¶æ„"></a>ç¬¬äº”éƒ¨åˆ† è½¯ä»¶æ¶æ„</h3><h4 id="ç¬¬-15-ç« -ä»€ä¹ˆæ˜¯è½¯ä»¶æ¶æ„"><a href="#ç¬¬-15-ç« -ä»€ä¹ˆæ˜¯è½¯ä»¶æ¶æ„" class="headerlink" title="ç¬¬ 15 ç«  ä»€ä¹ˆæ˜¯è½¯ä»¶æ¶æ„"></a>ç¬¬ 15 ç«  ä»€ä¹ˆæ˜¯è½¯ä»¶æ¶æ„</h4><ul><li>è½¯ä»¶æ¶æ„å¸ˆè‡ªèº«éœ€è¦æ˜¯ç¨‹åºå‘˜ï¼Œå¹¶ä¸”å¿…é¡»ä¸€ç›´åšæŒåšä¸€çº¿ç¨‹åºå‘˜ï¼Œç»å¯¹ä¸è¦å¬ä»é‚£äº›è¯´åº”è¯¥è®©è½¯ä»¶æ¶æ„å¸ˆä»ä»£ç ä¸­è§£æ”¾å‡ºæ¥ä»¥ä¸“å¿ƒè§£å†³é«˜é˜¶é—®é¢˜çš„ä¼ªå»ºè®®</li><li><p>å¦‚æœä¸äº²èº«æ‰¿å—å› ç³»ç»Ÿè®¾è®¡è€Œå¸¦æ¥çš„éº»çƒ¦ï¼Œå°±ä½“ä¼šä¸åˆ°è®¾è®¡ä¸ä½³æ‰€å¸¦æ¥çš„ç—›è‹¦ï¼Œæ¥ç€å°±ä¼šé€æ¸è¿·å¤±æ­£ç¡®çš„è®¾è®¡æ–¹å‘ã€‚</p><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">è¿™ä¸ªä¹Ÿæ˜¯å¸¸å¸¸ä¼šé‡åˆ°çš„é—®é¢˜ï¼Œå°±ç°åœ¨æˆ‘èƒ½è§‚å¯Ÿåˆ°çš„ä¸ºä¾‹ï¼Œæ¶æ„å¸ˆçº§åˆ«çš„åŸºæœ¬ä¸Šæ²¡æœ‰çœ‹åˆ°è¿‡å†åšä¸€çº¿çš„ç¨‹åºå¼€å‘å·¥ä½œï¼Œä»…ä»…æ˜¯å¹³æ—¶çš„å„ç§ç®¡ç†ï¼Œè§„åˆ’ä¸Šçš„äº‹åŠ¡å°±å·²ç»å¿™çš„ä¸å¯å¼€äº¤ï¼Œè¿™å…¶å®ä¸ä»…ä»…å¯¼è‡´äº†æ¶æ„å¸ˆæœ¬èº«ä¼šè„±èŠ‚ï¼ŒåŒæ—¶ä¹Ÿä¼šå¯¼è‡´ä¸‹é¢çš„åŒå­¦å¾ˆå°‘æœ‰æœºä¼šå­¦ä¹ åˆ°æ¶æ„å¸ˆä»¬è¿‡å¾€çš„ç»éªŒã€‚</div></li><li><p>è½¯ä»¶æ¶æ„è¿™é¡¹å·¥ä½œçš„å®è´¨å°±æ˜¯è§„åˆ’å¦‚ä½•å°†ç³»ç»Ÿåˆ‡åˆ†æˆç»„ä»¶ï¼Œå¹¶å®‰æ’å¥½ç»„ä»¶ä¹‹é—´çš„æ’åˆ—å…³ç³»ï¼Œä»¥åŠç»„ä»¶ä¹‹é—´äº’ç›¸é€šä¿¡çš„æ–¹å¼ã€‚</p></li><li>è®¾è®¡è½¯ä»¶æ¶æ„çš„ç›®çš„ï¼Œå°±æ˜¯ä¸ºäº†åœ¨å·¥ä½œä¸­æ›´å¥½åœ°å¯¹è¿™äº›ç»„ä»¶è¿›è¡Œç ”å‘ã€éƒ¨ç½²ã€è¿è¡Œä»¥åŠç»´æŠ¤ã€‚</li><li>å¦‚æœæƒ³è®¾è®¡ä¸€ä¸ªä¾¿äºæ¨è¿›å„é¡¹å·¥ä½œçš„ç³»ç»Ÿï¼Œå…¶ç­–ç•¥å°±æ˜¯è¦åœ¨è®¾è®¡ä¸­å°½å¯èƒ½é•¿æ—¶é—´åœ°ä¿ç•™å°½å¯èƒ½å¤šçš„å¯é€‰é¡¹ã€‚</li><li>è®¾è®¡è‰¯å¥½çš„æ¶æ„å¯ä»¥è®©ç³»ç»Ÿä¾¿äºç†è§£ã€æ˜“äºä¿®æ”¹ã€æ–¹ä¾¿ç»´æŠ¤ï¼Œå¹¶ä¸”èƒ½è½»æ¾éƒ¨ç½²ã€‚<strong>è½¯ä»¶æ¶æ„çš„ç»ˆæç›®æ ‡å°±æ˜¯æœ€å¤§åŒ–ç¨‹åºå‘˜çš„ç”Ÿäº§åŠ›ï¼ŒåŒæ—¶æœ€å°åŒ–ç³»ç»Ÿçš„æ€»è¿è¥æˆæœ¬ã€‚</strong></li><li>å¼€å‘<ul><li>å®ç°ä¸€é”®å¼çš„è½»æ¾éƒ¨ç½²åº”è¯¥æ˜¯æˆ‘ä»¬è®¾è®¡è½¯ä»¶æ¶æ„çš„ä¸€ä¸ªç›®æ ‡</li></ul></li><li><p>è¿è¡Œ</p><ul><li>å‡ ä¹ä»»ä½•è¿è¡Œé—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ç¡¬ä»¶çš„æ–¹å¼æ¥è§£å†³ï¼Œè¿™é¿å…äº†è½¯ä»¶æ¶æ„çš„é‡æ–°è®¾è®¡</li><li>åŸºäºæŠ•å…¥/äº§å‡ºæ¯”çš„è€ƒè™‘ï¼Œæˆ‘ä»¬çš„ä¼˜åŒ–é‡å¿ƒåº”è¯¥æ›´å€¾å‘äºç³»ç»Ÿçš„å¼€å‘ã€éƒ¨ç½²ä»¥åŠç»´æŠ¤</li><li>ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„è½¯ä»¶æ¶æ„åº”è¯¥èƒ½æ˜ç¡®åœ°åæ˜ è¯¥ç³»ç»Ÿåœ¨è¿è¡Œæ—¶çš„éœ€æ±‚ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">äººåŠ›æˆæœ¬å¾€å¾€ä¼šæ¯”æœºå™¨çš„æˆæœ¬æ›´é«˜ï¼Œæ‰€ä»¥è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ä»£ç ç¼–å†™çš„è¿‡ç¨‹å½“ä¸­å¯¹å¯è¯»æ€§å’Œæ€§èƒ½éœ€è¦æœ‰ä¸€ä¸ªæƒè¡¡ï¼Œå¦‚æœä¸æ˜¯å·®å¼‚è¿‡å¤§å¾€å¾€ä»£ç çš„å¯è¯»æ€§éœ€è¦æ›´ä¸ºé‡è¦</div></li></ul></li><li><p>ç»´æŠ¤</p><ul><li>åœ¨è½¯ä»¶ç³»ç»Ÿçš„æ‰€æœ‰æ–¹é¢ä¸­ï¼Œç»´æŠ¤æ‰€éœ€çš„æˆæœ¬æ˜¯æœ€é«˜çš„</li></ul></li><li>ä¿æŒå¯é€‰é¡¹<ul><li>è½¯ä»¶æœ‰è¡Œä¸ºä»·å€¼ä¸æ¶æ„ä»·å€¼ä¸¤ç§ä»·å€¼ã€‚è¿™å…¶ä¸­çš„ç¬¬äºŒç§ä»·å€¼åˆæ¯”ç¬¬ä¸€ç§æ›´é‡è¦</li><li>è½¯ä»¶çš„çµæ´»æ€§åˆ™å–å†³äºç³»ç»Ÿçš„æ•´ä½“çŠ¶å†µã€ç»„ä»¶çš„å¸ƒç½®ä»¥åŠç»„ä»¶ä¹‹é—´çš„è¿æ¥æ–¹å¼ã€‚<ul><li>è½¯ä»¶çš„é«˜å±‚ç­–ç•¥ä¸åº”è¯¥å…³å¿ƒå…¶åº•å±‚åˆ°åº•ä½¿ç”¨å“ªä¸€ç§æ•°æ®åº“</li><li>å¼€å‘çš„æ—©æœŸé˜¶æ®µä¹Ÿä¸åº”è¯¥é€‰å®šä½¿ç”¨çš„ Web æœåŠ¡</li><li>è½¯ä»¶çš„é«˜å±‚ç­–ç•¥å‹æ ¹ä¸åº”è¯¥è·Ÿè¿™äº›æœ‰å…³ã€‚</li><li>åœ¨å¼€å‘çš„æ—©æœŸé˜¶æ®µä¸åº”è¿‡æ—©åœ°é‡‡ç”¨ä¾èµ–æ³¨å…¥æ¡†æ¶</li></ul></li><li>å¦‚æœåœ¨å¼€å‘é«˜å±‚ç­–ç•¥æ—¶æœ‰æ„åœ°è®©è‡ªå·±æ‘†è„±å…·ä½“ç»†èŠ‚çš„çº ç¼ ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†ä¸å…·ä½“å®ç°ç›¸å…³çš„ç»†èŠ‚å†³ç­–æ¨è¿Ÿæˆ–å»¶åï¼Œå› ä¸ºè¶Šåˆ°é¡¹ç›®çš„åæœŸï¼Œæˆ‘ä»¬å°±æ‹¥æœ‰è¶Šå¤šçš„ä¿¡æ¯æ¥åšå‡ºåˆç†çš„å†³ç­–ã€‚</li><li>ä¸€ä¸ªä¼˜ç§€çš„è½¯ä»¶æ¶æ„å¸ˆåº”è¯¥è‡´åŠ›äºæœ€å¤§åŒ–å¯é€‰é¡¹æ•°é‡</li></ul></li><li><strong>ä¼˜ç§€çš„æ¶æ„å¸ˆä¼šå°å¿ƒåœ°å°†è½¯ä»¶çš„é«˜å±‚ç­–ç•¥ä¸å…¶åº•å±‚å®ç°éš”ç¦»å¼€ï¼Œè®©é«˜å±‚ç­–ç•¥ä¸å®ç°ç»†èŠ‚è„±é’©ï¼Œä½¿å…¶ç­–ç•¥éƒ¨åˆ†å®Œå…¨ä¸éœ€è¦å…³å¿ƒåº•å±‚ç»†èŠ‚ï¼Œå½“ç„¶ä¹Ÿä¸ä¼šå¯¹è¿™äº›ç»†èŠ‚æœ‰ä»»ä½•å½¢å¼çš„ä¾èµ–ã€‚</strong>å¦å¤–ï¼Œ<strong>ä¼˜ç§€çš„æ¶æ„å¸ˆæ‰€è®¾è®¡çš„ç­–ç•¥åº”è¯¥å…è®¸ç³»ç»Ÿå°½å¯èƒ½åœ°æ¨è¿Ÿä¸å®ç°ç»†èŠ‚ç›¸å…³çš„å†³ç­–ï¼Œè¶Šæ™šåšå†³ç­–è¶Šå¥½</strong><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">è¿™ä¸€ç‚¹å…¶å®å¾ˆå®¹æ˜“è¢«å¿½ç•¥æ‰ï¼Œå› ä¸ºæˆ‘ä»¬ç»å¸¸åšçš„å·¥ä½œå°±æ˜¯ç»†èŠ‚æ€§çš„å·¥ä½œï¼Œåœ¨è¿›è¡Œè®¾è®¡çš„æ—¶å€™å¾ˆå®¹æ˜“å°±ä¸è‡ªè§‰çš„å‡å®š Web UIï¼ŒMySQL æ•°æ®åº“è¿™äº›æŠ€æœ¯é€‰å‹ï¼Œåœ¨è¿™æœ¬ä¹¦çš„æœ€åä¸€ä¸ªç« èŠ‚è¿˜ä¼šè®²åˆ°ï¼Œè¿™äº›ç»†èŠ‚ã€‚</div></li></ul><h4 id="ç¬¬-16-ç« -ç‹¬ç«‹æ€§"><a href="#ç¬¬-16-ç« -ç‹¬ç«‹æ€§" class="headerlink" title="ç¬¬ 16 ç«  ç‹¬ç«‹æ€§"></a>ç¬¬ 16 ç«  ç‹¬ç«‹æ€§</h4><ul><li>ç”¨ä¾‹<ul><li>è½¯ä»¶çš„æ¶æ„å¿…é¡»ä¸ºå…¶ç”¨ä¾‹æä¾›æ”¯æŒã€‚</li></ul></li><li>ä»»ä½•ä¸€ä¸ªç»„ç»‡åœ¨è®¾è®¡ç³»ç»Ÿæ—¶ï¼Œå¾€å¾€éƒ½ä¼šå¤åˆ¶å‡ºä¸€ä¸ªä¸è¯¥ç»„ç»‡å†…æ²Ÿé€šç»“æ„ç›¸åŒçš„ç³»ç»Ÿã€‚</li><li>ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„æ¶æ„é€šå¸¸ä¸ä¼šä¾èµ–äºæˆå †çš„è„šæœ¬ä¸é…ç½®æ–‡ä»¶ï¼Œä¹Ÿä¸éœ€è¦ç”¨æˆ·æ‰‹åŠ¨åˆ›å»ºä¸€å †â€œæœ‰ä¸¥æ ¼è¦æ±‚â€çš„ç›®å½•ä¸æ–‡ä»¶</li><li>å¦‚æœæˆ‘ä»¬æŒ‰ç…§å˜æ›´åŸå› çš„ä¸åŒå¯¹ç³»ç»Ÿè¿›è¡Œè§£è€¦ï¼Œå°±å¯ä»¥æŒç»­åœ°å‘ç³»ç»Ÿå†…æ·»åŠ æ–°çš„ç”¨ä¾‹ï¼Œè€Œä¸ä¼šå½±å“æ—§æœ‰çš„ç”¨ä¾‹ã€‚å¦‚æœæˆ‘ä»¬åŒæ—¶å¯¹æ”¯æŒè¿™äº›ç”¨ä¾‹çš„ UI å’Œæ•°æ®åº“ä¹Ÿè¿›è¡Œäº†åˆ†ç»„ï¼Œé‚£ä¹ˆæ¯ä¸ªç”¨ä¾‹ä½¿ç”¨çš„å°±æ˜¯ä¸åŒé¢å‘çš„ UI ä¸æ•°æ®åº“ï¼Œå› æ­¤å¢åŠ æ–°ç”¨ä¾‹å°±æ›´ä¸å¤ªå¯èƒ½ä¼šå½±å“æ—§æœ‰çš„ç”¨ä¾‹äº†ã€‚</li><li>å¦‚æœæœ‰ä¸¤æ®µçœ‹èµ·æ¥é‡å¤çš„ä»£ç ï¼Œå®ƒä»¬èµ°çš„æ˜¯ä¸åŒçš„æ¼”è¿›è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬æœ‰ç€ä¸åŒçš„å˜æ›´é€Ÿç‡å’Œå˜æ›´ç¼˜ç”±ï¼Œé‚£ä¹ˆè¿™ä¸¤æ®µä»£ç å°±ä¸æ˜¯çœŸæ­£çš„é‡å¤</li><li>è§£è€¦æ¨¡å¼<ul><li>æºç å±‚æ¬¡ï¼šæˆ‘ä»¬å¯ä»¥æ§åˆ¶æºä»£ç æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œä»¥æ­¤æ¥å®ç°ä¸€ä¸ªæ¨¡å—çš„å˜æ›´ä¸ä¼šå¯¼è‡´å…¶ä»–æ¨¡å—ä¹Ÿéœ€è¦å˜æ›´æˆ–é‡æ–°ç¼–è¯‘</li><li>éƒ¨ç½²å±‚æ¬¡ï¼šæˆ‘ä»¬å¯ä»¥æ§åˆ¶éƒ¨ç½²å•å…ƒï¼ˆè­¬å¦‚ jar æ–‡ä»¶ã€DLLã€å…±äº«åº“ç­‰ï¼‰ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œä»¥æ­¤æ¥å®ç°ä¸€ä¸ªæ¨¡å—çš„å˜æ›´ä¸ä¼šå¯¼è‡´å…¶ä»–æ¨¡å—çš„é‡æ–°æ„å»ºå’Œéƒ¨ç½²ã€‚</li><li>æœåŠ¡å±‚æ¬¡ï¼šæˆ‘ä»¬å¯ä»¥å°†ç»„ä»¶é—´çš„ä¾èµ–å…³ç³»é™ä½åˆ°æ•°æ®ç»“æ„çº§åˆ«ï¼Œç„¶åä»…é€šè¿‡ç½‘ç»œæ•°æ®åŒ…æ¥è¿›è¡Œé€šä¿¡ã€‚</li><li>ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„æ¶æ„åº”è¯¥èƒ½å…è®¸ä¸€ä¸ªç³»ç»Ÿä»å•ä½“ç»“æ„å¼€å§‹ï¼Œä»¥å•ä¸€æ–‡ä»¶çš„å½¢å¼éƒ¨ç½²ï¼Œç„¶åé€æ¸æˆé•¿ä¸ºä¸€ç»„ç›¸äº’ç‹¬ç«‹çš„å¯éƒ¨ç½²å•å…ƒï¼Œç”šè‡³æ˜¯ç‹¬ç«‹çš„æœåŠ¡æˆ–è€…å¾®æœåŠ¡ã€‚æœ€åè¿˜èƒ½éšç€æƒ…å†µçš„å˜åŒ–ï¼Œå…è®¸ç³»ç»Ÿé€æ¸å›é€€åˆ°å•ä½“ç»“æ„<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">â€œå¦‚æœä¸¤æ®µçœ‹ä¼¼é‡å¤çš„ä»£ç ï¼Œå¦‚æœæœ‰ä¸åŒçš„å˜æ›´é€Ÿç‡å’ŒåŸå› ï¼Œé‚£ä¹ˆè¿™ä¸¤æ®µä»£ç å°±ä¸ç®—æ˜¯çœŸæ­£çš„é‡å¤â€è¿™æœ‰ä¸ªéå¸¸å…¸å‹çš„ä¾‹å­å°±æ˜¯ API æ¥å£çš„å‚æ•°å’Œæœ€åæˆ‘ä»¬æ¨¡å‹æ•°æ®è™½ç„¶å¾ˆå¤šæ—¶å€™å¤§éƒ¨åˆ†å­—æ®µæ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯å®ƒä»¬çš„å˜æ›´é€Ÿç‡å’ŒåŸå› å…¶å®éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¦‚æœæŠŠä»–ä»¬è€¦åˆåœ¨ä¸€èµ·è™½ç„¶å‰æœŸå¯èƒ½å¯ä»¥å‡å°‘ä¸€äº›ä»£ç çš„ç¼–å†™ï¼Œä½†æ˜¯åˆ°æœ€åéœ€è¦æ‰©å±•æ—¶ä¼šå‘ç°å˜æ›´ä¼šå¾ˆå›°éš¾ã€‚ä¹‹å‰æˆ‘è¿˜å†™äº†ä¸€ç¯‡æ–‡ç«  ã€Š<a href="https://lailin.xyz/post/11996.html#2-%E7%94%A8-model-%E5%B1%82%E7%9A%84-struct-%E7%BB%91%E5%AE%9A%E5%8F%82%E6%95%B0">Go Web å°æŠ€å·§ï¼ˆä¸‰ï¼‰Gin å‚æ•°ç»‘å®š </a>ã€‹æ€»ç»“è¿™ç§åŸ‹å‘çš„æŠ€å·§ ğŸ˜‚</div></li></ul></li></ul><h4 id="ç¬¬-17-ç« -åˆ’åˆ†è¾¹ç•Œ"><a href="#ç¬¬-17-ç« -åˆ’åˆ†è¾¹ç•Œ" class="headerlink" title="ç¬¬ 17 ç«  åˆ’åˆ†è¾¹ç•Œ"></a>ç¬¬ 17 ç«  åˆ’åˆ†è¾¹ç•Œ</h4><ul><li>è½¯ä»¶æ¶æ„è®¾è®¡æœ¬èº«å°±æ˜¯ä¸€é—¨åˆ’åˆ†è¾¹ç•Œçš„è‰ºæœ¯ã€‚</li><li>é€šè¿‡åˆ’æ¸…è¾¹ç•Œï¼Œæˆ‘ä»¬å¯ä»¥æ¨è¿Ÿå’Œå»¶åä¸€äº›ç»†èŠ‚æ€§çš„å†³ç­–ï¼Œè¿™æœ€ç»ˆä¼šä¸ºæˆ‘ä»¬èŠ‚çœå¤§é‡çš„æ—¶é—´ã€é¿å…å¤§é‡çš„é—®é¢˜ã€‚</li><li>I/O æ˜¯æ— å…³ç´§è¦çš„</li><li>GUI å’Œ BusinessRules è¿™ä¸¤ä¸ªç»„ä»¶ä¹‹é—´ä¹Ÿåº”è¯¥æœ‰ä¸€æ¡è¾¹ç•Œçº¿</li><li>æ’ä»¶å¼æ¶æ„çš„å¥½å¤„<ul><li><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1611763160147-6a16b0e6-d3de-43d2-8bf3-b1bf597dd0ed.png" alt="image.png"></li><li>å°†ç³»ç»Ÿè®¾è®¡ä¸ºæ’ä»¶å¼æ¶æ„ï¼Œå°±ç­‰äºæ„å»ºèµ·äº†ä¸€é¢å˜æ›´æ— æ³•é€¾è¶Šçš„é˜²ç«å¢™ã€‚æ¢å¥è¯è¯´ï¼Œåªè¦ GUI æ˜¯ä»¥æ’ä»¶å½¢å¼æ’å…¥ç³»ç»Ÿçš„ä¸šåŠ¡é€»è¾‘ä¸­çš„ï¼Œé‚£ä¹ˆ GUI è¿™è¾¹æ‰€å‘ç”Ÿçš„å˜æ›´å°±ä¸ä¼šå½±å“ç³»ç»Ÿçš„ä¸šåŠ¡é€»è¾‘ã€‚</li><li>è¾¹ç•Œçº¿ä¹Ÿåº”è¯¥æ²¿ç€ç³»ç»Ÿçš„å˜æ›´è½´æ¥ç”»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½äºè¾¹ç•Œçº¿ä¸¤ä¾§çš„ç»„ä»¶åº”è¯¥ä»¥ä¸åŒåŸå› ã€ä¸åŒé€Ÿç‡å˜åŒ–ç€ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">çœŸæ­£æ ¸å¿ƒçš„æ˜¯æˆ‘ä»¬ä¸šåŠ¡é€»è¾‘ï¼Œè€Œè¾“å…¥è¾“å‡ºæ˜¯ç»†èŠ‚</div></li></ul></li></ul><h4 id="ç¬¬-18-ç« -è¾¹ç•Œå‰–æ"><a href="#ç¬¬-18-ç« -è¾¹ç•Œå‰–æ" class="headerlink" title="ç¬¬ 18 ç«  è¾¹ç•Œå‰–æ"></a>ç¬¬ 18 ç«  è¾¹ç•Œå‰–æ</h4><ul><li>è·¨è¾¹ç•Œè°ƒç”¨æŒ‡çš„æ˜¯è¾¹ç•Œçº¿ä¸€ä¾§çš„å‡½æ•°è°ƒç”¨å¦ä¸€ä¾§çš„å‡½æ•°ï¼Œå¹¶åŒæ—¶ä¼ é€’æ•°æ®çš„è¡Œä¸º</li><li>æœ€ç®€å•çš„è·¨è¾¹ç•Œè°ƒç”¨å½¢å¼ï¼Œæ˜¯ç”±ä½å±‚å®¢æˆ·ç«¯æ¥è°ƒç”¨é«˜å±‚æœåŠ¡å‡½æ•°ï¼Œè¿™ç§ä¾èµ–å…³ç³»åœ¨è¿è¡Œæ—¶å’Œç¼–è¯‘æ—¶ä¼šä¿æŒæŒ‡å‘ä¸€è‡´ï¼Œéƒ½æ˜¯ä»ä½å±‚ç»„ä»¶æŒ‡å‘é«˜å±‚ç»„ä»¶</li><li>åœ¨å•ä½“ç»“æ„ä¸­ï¼Œç»„ä»¶ä¹‹é—´çš„äº¤äº’ä¸€èˆ¬æƒ…å†µä¸‹éƒ½åªæ˜¯æ™®é€šçš„å‡½æ•°è°ƒç”¨ï¼Œè¿…é€Ÿè€Œå»‰ä»·ï¼Œè¿™å°±æ„å‘³ç€è¿™ç§è·¨æºç å±‚æ¬¡è§£è€¦è¾¹ç•Œçš„é€šä¿¡ä¼šå¾ˆé¢‘ç¹</li><li>æœåŠ¡ä¹‹é—´çš„è·¨è¾¹ç•Œé€šä¿¡ç›¸å¯¹äºå‡½æ•°è°ƒç”¨æ¥è¯´ï¼Œé€Ÿåº¦æ˜¯éå¸¸ç¼“æ…¢çš„ï¼Œå…¶å¾€è¿”æ—¶é—´å¯ä»¥ä»å‡ åæ¯«ç§’åˆ°å‡ ç§’ä¸ç­‰ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">ä¸åŒçš„è¾¹ç•Œçš„è·¨è¾¹ç•Œè°ƒç”¨çš„æˆæœ¬æ˜¯ä¸åŒçš„ï¼Œå¯¹äºæœåŠ¡è€Œè¨€è·¨æœåŠ¡è°ƒç”¨çš„æˆæœ¬éå¸¸é«˜ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨è¿›è¡ŒæœåŠ¡åˆ’åˆ†çš„æ—¶å€™ä¸€å®šè¦å°½é‡çš„å†…èšå‡å°‘é¢‘ç¹è°ƒç”¨çš„æƒ…å†µã€‚</div></li></ul><h4 id="ç¬¬-19-ç« -ç­–ç•¥ä¸å±‚æ¬¡"><a href="#ç¬¬-19-ç« -ç­–ç•¥ä¸å±‚æ¬¡" class="headerlink" title="ç¬¬ 19 ç«  ç­–ç•¥ä¸å±‚æ¬¡"></a>ç¬¬ 19 ç«  ç­–ç•¥ä¸å±‚æ¬¡</h4><ul><li>ç­–ç•¥<ul><li>æœ¬è´¨ä¸Šï¼Œæ‰€æœ‰çš„è½¯ä»¶ç³»ç»Ÿéƒ½æ˜¯ä¸€ç»„ç­–ç•¥è¯­å¥çš„é›†åˆ</li><li>å˜æ›´åŸå› ã€æ—¶é—´å’Œå±‚æ¬¡ç›¸åŒçš„ç­–ç•¥åº”è¯¥è¢«åˆ†åˆ°åŒä¸€ä¸ªç»„ä»¶ä¸­ã€‚åä¹‹ï¼Œå˜æ›´åŸå› ã€æ—¶é—´å’Œå±‚æ¬¡ä¸åŒçš„ç­–ç•¥åˆ™åº”è¯¥åˆ†å±äºä¸åŒçš„ç»„ä»¶</li><li>ä¾èµ–å…³ç³»çš„æ–¹å‘é€šå¸¸å–å†³äºå®ƒä»¬æ‰€å…³è”çš„ç»„ä»¶å±‚æ¬¡ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä½å±‚ç»„ä»¶è¢«è®¾è®¡ä¸ºä¾èµ–äºé«˜å±‚ç»„ä»¶</li></ul></li><li>å±‚æ¬¡<ul><li>ä¸€æ¡ç­–ç•¥è·ç¦»ç³»ç»Ÿçš„è¾“å…¥/è¾“å‡ºè¶Šè¿œï¼Œå®ƒæ‰€å±çš„å±‚æ¬¡å°±è¶Šé«˜ã€‚è€Œç›´æ¥ç®¡ç†è¾“å…¥/è¾“å‡ºçš„ç­–ç•¥åœ¨ç³»ç»Ÿä¸­çš„å±‚æ¬¡æ˜¯æœ€ä½çš„ã€‚</li><li>æ•°æ®æµå‘å’Œæºç ä¸­çš„ä¾èµ–å…³ç³»å¹¶ä¸æ€»å¤„äºåŒä¸€æ–¹å‘ä¸Š</li><li>æˆ‘ä»¬å¸Œæœ›æºç ä¸­çš„ä¾èµ–å…³ç³»ä¸å…¶æ•°æ®æµå‘è„±é’©ï¼Œè€Œä¸ç»„ä»¶æ‰€åœ¨çš„å±‚æ¬¡æŒ‚é’©ã€‚</li><li>ä½å±‚ç»„ä»¶åº”è¯¥æˆä¸ºé«˜å±‚ç»„ä»¶çš„æ’ä»¶<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">è·ç¦» I/O è¶Šè¿œçš„ç­–ç•¥å±‚æ¬¡è¶Šé«˜ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¸¸è§çš„ Web UI åº”è¯¥å±äºæœ€ä½å±‚æ¬¡ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ä¾èµ– Web UI è¿™ç§è¾“å…¥è¾“å‡ºè®¾å¤‡ã€‚åŒæ—¶ç»™å‡ºäº†ç»„ä»¶çš„åˆ’åˆ†åŸåˆ™ï¼Œå˜æ›´çš„æ—¶é—´åŸå› å’Œå±‚æ¬¡ç›¸åŒçš„å±äºåŒä¸€ä¸ªç»„ä»¶ã€‚</div></li></ul></li></ul><h4 id="ç¬¬-20-ç« -ä¸šåŠ¡é€»è¾‘"><a href="#ç¬¬-20-ç« -ä¸šåŠ¡é€»è¾‘" class="headerlink" title="ç¬¬ 20 ç«  ä¸šåŠ¡é€»è¾‘"></a>ç¬¬ 20 ç«  ä¸šåŠ¡é€»è¾‘</h4><ul><li>ä¸šåŠ¡é€»è¾‘å°±æ˜¯ç¨‹åºä¸­é‚£äº›çœŸæ­£ç”¨äºèµšé’±æˆ–çœé’±çš„ä¸šåŠ¡é€»è¾‘ä¸è¿‡ç¨‹</li><li>â€œå…³é”®ä¸šåŠ¡é€»è¾‘â€æ˜¯ä¸€é¡¹ä¸šåŠ¡çš„å…³é”®éƒ¨åˆ†ï¼Œä¸ç®¡æœ‰æ²¡æœ‰è‡ªåŠ¨åŒ–ç³»ç»Ÿæ¥æ‰§è¡Œè¿™é¡¹ä¸šåŠ¡ï¼Œè¿™ä¸€ç‚¹æ˜¯ä¸ä¼šæ”¹å˜çš„ã€‚</li><li>ä¸šåŠ¡å®ä½“<ul><li>ä¸šåŠ¡å®ä½“è¿™ä¸ªæ¦‚å¿µä¸­åº”è¯¥åªæœ‰ä¸šåŠ¡é€»è¾‘ï¼Œæ²¡æœ‰åˆ«çš„ã€‚</li><li>ä¸šåŠ¡å®ä½“è¿™ä¸ªæ¦‚å¿µåªè¦æ±‚æˆ‘ä»¬å°†å…³é”®ä¸šåŠ¡æ•°æ®å’Œå…³é”®ä¸šåŠ¡é€»è¾‘ç»‘å®šåœ¨ä¸€ä¸ªç‹¬ç«‹çš„è½¯ä»¶æ¨¡å—å†…ã€‚</li><li>ä¸šåŠ¡å®ä½“ä¸ä¸€å®šæ˜¯ç±»</li></ul></li><li><p>ç”¨ä¾‹ï¼ˆusecaseï¼‰</p><ul><li>ç”¨ä¾‹æœ¬è´¨ä¸Šå°±æ˜¯å…³äºå¦‚ä½•æ“ä½œä¸€ä¸ªè‡ªåŠ¨åŒ–ç³»ç»Ÿçš„æè¿°ï¼Œå®ƒå®šä¹‰äº†ç”¨æˆ·éœ€è¦æä¾›çš„è¾“å…¥æ•°æ®ã€ç”¨æˆ·åº”è¯¥å¾—åˆ°çš„è¾“å‡ºä¿¡æ¯ä»¥åŠäº§ç”Ÿè¾“å‡ºæ‰€åº”è¯¥é‡‡å–çš„å¤„ç†æ­¥éª¤ã€‚</li><li>ç”¨ä¾‹ä¸­åŒ…å«äº†å¯¹å¦‚ä½•è°ƒç”¨ä¸šåŠ¡å®ä½“ä¸­çš„å…³é”®ä¸šåŠ¡é€»è¾‘çš„å®šä¹‰ã€‚ç®€è€Œè¨€ä¹‹ï¼Œç”¨ä¾‹æ§åˆ¶ç€ä¸šåŠ¡å®ä½“ä¹‹é—´çš„äº¤äº’æ–¹å¼ã€‚</li><li>ç”¨ä¾‹é™¤éæ­£å¼åœ°æè¿°äº†æ•°æ®æµå…¥/æµå‡ºæ¥å£ä»¥å¤–ï¼Œå¹¶ä¸è¯¦ç»†æè¿°ç”¨æˆ·ç•Œé¢ã€‚</li><li>ç”¨ä¾‹å¹¶ä¸æè¿°ç³»ç»Ÿä¸ç”¨æˆ·ä¹‹é—´çš„æ¥å£ï¼Œå®ƒåªæè¿°è¯¥åº”ç”¨åœ¨æŸäº›ç‰¹å®šæƒ…æ™¯ä¸‹çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿™äº›ä¸šåŠ¡é€»è¾‘æ‰€è§„èŒƒçš„æ˜¯ç”¨æˆ·ä¸ä¸šåŠ¡å®ä½“ä¹‹é—´çš„äº¤äº’æ–¹å¼ï¼Œå®ƒä¸æ•°æ®æµå…¥/æµå‡ºç³»ç»Ÿçš„æ–¹å¼æ— å…³ã€‚</li><li>ä¸šåŠ¡å®ä½“å¹¶ä¸ä¼šçŸ¥é“æ˜¯å“ªä¸ªä¸šåŠ¡ç”¨ä¾‹åœ¨æ§åˆ¶å®ƒä»¬ï¼Œè¿™ä¹Ÿæ˜¯ä¾èµ–åè½¬åŸåˆ™ï¼ˆDIPï¼‰çš„å¦ä¸€ä¸ªåº”ç”¨æƒ…æ™¯</li><li>ä¸ºä»€ä¹ˆä¸šåŠ¡å®ä½“å±äºé«˜å±‚æ¦‚å¿µï¼Œè€Œç”¨ä¾‹å±äºä½å±‚æ¦‚å¿µå‘¢ï¼Ÿå› ä¸ºç”¨ä¾‹æè¿°çš„æ˜¯ä¸€ä¸ªç‰¹å®šçš„åº”ç”¨æƒ…æ™¯ï¼Œè¿™æ ·ä¸€æ¥ï¼Œç”¨ä¾‹å¿…ç„¶ä¼šæ›´é è¿‘ç³»ç»Ÿçš„è¾“å…¥å’Œè¾“å‡ºã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">ç”¨ä¾‹å’Œä¸šåŠ¡å®ä½“åº”è¯¥æ˜¯åº”ç”¨å½“ä¸­æœ€é‡è¦çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„å•å…ƒæµ‹è¯•æœ€ä½çš„è¦æ±‚å°±æ˜¯è¦è¦†ç›–æ‰€æœ‰çš„ usecase é€»è¾‘ï¼Œè¿™ä¸€éƒ¨åˆ†åº”è¯¥ä¿æŒçº¯å‡€ä¸ä¾èµ–æ•°æ®åº“ï¼ŒWeb ç­‰ I/O æ–¹å¼</div></li></ul></li><li><p>é€‰æ‹©ç›´æ¥åœ¨æ•°æ®ç»“æ„ä¸­ä½¿ç”¨å¯¹ä¸šåŠ¡å®ä½“å¯¹è±¡çš„å¼•ç”¨ã€‚æ¯•ç«Ÿï¼Œä¸šåŠ¡å®ä½“ä¸è¯·æ±‚/å“åº”æ¨¡å‹ä¹‹é—´æœ‰å¾ˆå¤šç›¸åŒçš„æ•°æ®ã€‚ä½†è¯·ä¸€å®šä¸è¦è¿™æ ·åšï¼è¿™ä¸¤ä¸ªå¯¹è±¡å­˜åœ¨çš„æ„ä¹‰æ˜¯éå¸¸ã€éå¸¸ä¸ä¸€æ ·çš„ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡ä¼šä»¥ä¸åŒçš„åŸå› ã€ä¸åŒçš„é€Ÿç‡å‘ç”Ÿå˜æ›´ã€‚</p></li><li>è¿™äº›ä¸šåŠ¡é€»è¾‘åº”è¯¥ä¿æŒçº¯å‡€ï¼Œä¸è¦æºæ‚ç”¨æˆ·ç•Œé¢æˆ–è€…æ‰€ä½¿ç”¨çš„æ•°æ®åº“ç›¸å…³çš„ä¸œè¥¿ã€‚åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œè¿™éƒ¨åˆ†ä»£è¡¨ä¸šåŠ¡é€»è¾‘çš„ä»£ç åº”è¯¥æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒï¼Œå…¶ä»–ä½å±‚æ¦‚å¿µçš„å®ç°åº”è¯¥ä»¥æ’ä»¶å½¢å¼æ¥å…¥ç³»ç»Ÿä¸­ã€‚ä¸šåŠ¡é€»è¾‘åº”è¯¥æ˜¯ç³»ç»Ÿä¸­æœ€ç‹¬ç«‹ã€å¤ç”¨æ€§æœ€é«˜çš„ä»£ç ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">å†æ¬¡å¼ºè°ƒäº†ä¸è¦å·æ‡’ï¼Œä»Šå¤©åˆšå¥½çœ‹åˆ°ä¹‹å‰å†™çš„ä¸€ä¸ªåé¢ä¾‹å­çš„ä»£ç ï¼Œä»£ç é‡Œé¢æœ‰ä¸€ä¸ª GetA å‡½æ•°ï¼Œä»æ•°æ®åº“å½“ä¸­è·å–Aå¯¹è±¡æ•°æ®å’Œä¸€äº›ç»Ÿè®¡æ•°æ®ï¼Œè¿™ä¸ªå‡½æ•°ä¸­çš„ç»Ÿè®¡æ•°æ®éƒ¨åˆ†å…¶å®åªæœ‰åœ¨ä¸€ä¸ª Web é¡µé¢çš„æ¥å£ä¸­ä½¿ç”¨åˆ°ï¼Œä½†æ˜¯ä¸ºäº†å·æ‡’ï¼Œåœ¨å…¶ä»–åœ°æ–¹æŸ¥è¯¢çš„æ—¶å€™ä¹Ÿè°ƒç”¨äº†è¿™ä¸ªå‡½æ•°ï¼Œå¯¼è‡´æœ€åå¾ˆå¤šåœ°æ–¹çš„æ¥å£æ€§èƒ½éƒ½ç”±äºè¿™ä¸ªæ²¡ç”¨çš„ç»Ÿè®¡æ•°æ®å¤šè€—è´¹äº†å°†è¿‘ 1s çš„æ—¶é—´ã€‚</div></li></ul><h4 id="ç¬¬-21-ç« -å°–å«çš„è½¯ä»¶æ¶æ„"><a href="#ç¬¬-21-ç« -å°–å«çš„è½¯ä»¶æ¶æ„" class="headerlink" title="ç¬¬ 21 ç«  å°–å«çš„è½¯ä»¶æ¶æ„"></a>ç¬¬ 21 ç«  å°–å«çš„è½¯ä»¶æ¶æ„</h4><ul><li>æ¶æ„è®¾è®¡çš„ä¸»é¢˜<ul><li>è½¯ä»¶çš„ç³»ç»Ÿæ¶æ„åº”è¯¥ä¸ºè¯¥ç³»ç»Ÿçš„ç”¨ä¾‹æä¾›æ”¯æŒã€‚è¿™å°±åƒä½å®…å’Œå›¾ä¹¦é¦†çš„å»ºç­‘è®¡åˆ’æ»¡ç¯‡éƒ½åœ¨éå¸¸æ˜æ˜¾åœ°å‡¸æ˜¾è¿™äº›å»ºç­‘çš„ç”¨ä¾‹ä¸€æ ·ï¼Œè½¯ä»¶ç³»ç»Ÿçš„æ¶æ„è®¾è®¡å›¾ä¹Ÿåº”è¯¥éå¸¸æ˜ç¡®åœ°å‡¸æ˜¾è¯¥åº”ç”¨ç¨‹åºä¼šæœ‰å“ªäº›ç”¨ä¾‹</li></ul></li><li>æ¶æ„è®¾è®¡çš„æ ¸å¿ƒç›®æ ‡<ul><li>ä¸€ä¸ªè‰¯å¥½çš„æ¶æ„è®¾è®¡åº”è¯¥å›´ç»•ç€ç”¨ä¾‹æ¥å±•å¼€ï¼Œè¿™æ ·çš„æ¶æ„è®¾è®¡å¯ä»¥åœ¨è„±ç¦»æ¡†æ¶ã€å·¥å…·ä»¥åŠä½¿ç”¨ç¯å¢ƒçš„æƒ…å†µä¸‹å®Œæ•´åœ°æè¿°ç”¨ä¾‹</li><li>è‰¯å¥½çš„æ¶æ„è®¾è®¡åº”è¯¥å°½å¯èƒ½åœ°å…è®¸ç”¨æˆ·æ¨è¿Ÿå’Œå»¶åå†³å®šé‡‡ç”¨ä»€ä¹ˆæ¡†æ¶ã€æ•°æ®åº“ã€Web æœåŠ¡ä»¥åŠå…¶ä»–ä¸ç¯å¢ƒç›¸å…³çš„å·¥å…·</li><li>è‰¯å¥½çš„æ¶æ„è®¾è®¡åº”è¯¥åªå…³æ³¨ç”¨ä¾‹ï¼Œå¹¶èƒ½å°†å®ƒä»¬ä¸å…¶ä»–çš„å‘¨è¾¹å› ç´ éš”ç¦»ã€‚</li></ul></li><li>å¯æµ‹è¯•çš„æ¶æ„è®¾è®¡<ul><li>æˆ‘ä»¬åœ¨è¿è¡Œæµ‹è¯•çš„æ—¶å€™ä¸åº”è¯¥è¿è¡Œ Web æœåŠ¡ï¼Œä¹Ÿä¸åº”è¯¥éœ€è¦è¿æ¥æ•°æ®åº“ã€‚æˆ‘ä»¬æµ‹è¯•çš„åº”è¯¥åªæ˜¯ä¸€ä¸ªç®€å•çš„ä¸šåŠ¡å®ä½“å¯¹è±¡ï¼Œæ²¡æœ‰ä»»ä½•ä¸æ¡†æ¶ã€æ•°æ®åº“ç›¸å…³çš„ä¾èµ–å…³ç³»ã€‚</li></ul></li><li>ä¸€ä¸ªç³»ç»Ÿçš„æ¶æ„åº”è¯¥ç€é‡äºå±•ç¤ºç³»ç»Ÿæœ¬èº«çš„è®¾è®¡ï¼Œè€Œå¹¶éè¯¥ç³»ç»Ÿæ‰€ä½¿ç”¨çš„æ¡†æ¶<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">ç”¨ä¾‹æ˜¯æ¶æ„è®¾è®¡å½“ä¸­æœ€åº”è¯¥å…³æ³¨çš„éƒ¨åˆ†ï¼Œæ¡†æ¶æ•°æ®åº“WebæœåŠ¡çš„é€‰æ‹©éƒ½æ˜¯ç»†èŠ‚ï¼Œè¿™äº›ç»†èŠ‚åº”è¯¥å»¶åé€‰æ‹©ï¼Œæˆ‘ä»¬çš„ç”¨ä¾‹ä¸åº”è¯¥ä¾èµ–è¿™äº›ç»†èŠ‚ï¼Œè¿™æ ·æ‰èƒ½å¾ˆå¥½çš„æµ‹è¯•</div></li></ul><h4 id="ç¬¬-22-ç« -æ•´æ´æ¶æ„"><a href="#ç¬¬-22-ç« -æ•´æ´æ¶æ„" class="headerlink" title="ç¬¬ 22 ç«  æ•´æ´æ¶æ„"></a>ç¬¬ 22 ç«  æ•´æ´æ¶æ„</h4><ul><li>æŒ‰ç…§ä¸åŒå…³æ³¨ç‚¹å¯¹è½¯ä»¶è¿›è¡Œåˆ‡å‰²ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™äº›æ¶æ„éƒ½ä¼šå°†è½¯ä»¶åˆ‡å‰²æˆä¸åŒçš„å±‚ï¼Œè‡³å°‘æœ‰ä¸€å±‚æ˜¯åªåŒ…å«è¯¥è½¯ä»¶çš„ä¸šåŠ¡é€»è¾‘çš„ï¼Œè€Œç”¨æˆ·æ¥å£ã€ç³»ç»Ÿæ¥å£åˆ™å±äºå…¶ä»–å±‚ã€‚</li><li>ç‰¹ç‚¹<ul><li>ç‹¬ç«‹äºæ¡†æ¶ï¼šè¿™äº›ç³»ç»Ÿçš„æ¶æ„å¹¶ä¸ä¾èµ–æŸä¸ªåŠŸèƒ½ä¸°å¯Œçš„æ¡†æ¶ä¹‹ä¸­çš„æŸä¸ªå‡½æ•°ã€‚</li><li>å¯è¢«æµ‹è¯•ï¼šè¿™äº›ç³»ç»Ÿçš„ä¸šåŠ¡é€»è¾‘å¯ä»¥è„±ç¦» UIã€æ•°æ®åº“ã€Web æœåŠ¡ä»¥åŠå…¶ä»–çš„å¤–éƒ¨å…ƒç´ æ¥è¿›è¡Œæµ‹è¯•ã€‚</li><li>ç‹¬ç«‹äº UIï¼šè¿™äº›ç³»ç»Ÿçš„ UI å˜æ›´èµ·æ¥å¾ˆå®¹æ˜“ï¼Œä¸éœ€è¦ä¿®æ”¹å…¶ä»–çš„ç³»ç»Ÿéƒ¨åˆ†ã€‚</li><li>ç‹¬ç«‹äºæ•°æ®åº“ï¼šæˆ‘ä»¬å¯ä»¥è½»æ˜“å°†è¿™äº›ç³»ç»Ÿä½¿ç”¨çš„</li><li>ç‹¬ç«‹äºä»»ä½•å¤–éƒ¨æœºæ„ï¼šè¿™äº›ç³»ç»Ÿçš„ä¸šåŠ¡é€»è¾‘å¹¶ä¸éœ€è¦çŸ¥é“ä»»ä½•å…¶ä»–å¤–éƒ¨æ¥å£çš„å­˜åœ¨ã€‚</li></ul></li></ul><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1611803924995-df9764d2-32c6-407b-b1e3-224c0feef3b1.png" alt="image.png"></p><ul><li>ä¾èµ–å…³ç³»è§„åˆ™<ul><li>å¤–å±‚åœ†ä»£è¡¨çš„æ˜¯æœºåˆ¶ï¼Œå†…å±‚åœ†ä»£è¡¨çš„æ˜¯ç­–ç•¥ã€‚</li><li>æºç ä¸­çš„ä¾èµ–å…³ç³»å¿…é¡»åªæŒ‡å‘åŒå¿ƒåœ†çš„å†…å±‚ï¼Œå³ç”±ä½å±‚æœºåˆ¶æŒ‡å‘é«˜å±‚ç­–ç•¥ã€‚</li><li>å¤–å±‚åœ†ä¸­ä½¿ç”¨çš„æ•°æ®æ ¼å¼ä¹Ÿä¸åº”è¯¥è¢«å†…å±‚åœ†ä¸­çš„ä»£ç æ‰€ä½¿ç”¨ï¼Œå°¤å…¶æ˜¯å½“æ•°æ®æ ¼å¼æ˜¯ç”±å¤–å±‚åœ†çš„æ¡†æ¶æ‰€ç”Ÿæˆæ—¶ã€‚</li></ul></li><li>ä¸šåŠ¡å®ä½“<ul><li>ä¸šåŠ¡å®ä½“è¿™ä¸€å±‚ä¸­å°è£…çš„æ˜¯æ•´ä¸ªç³»ç»Ÿçš„å…³é”®ä¸šåŠ¡é€»è¾‘ï¼Œä¸€ä¸ªä¸šåŠ¡å®ä½“æ—¢å¯ä»¥æ˜¯ä¸€ä¸ªå¸¦æœ‰æ–¹æ³•çš„å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ç»„æ•°æ®ç»“æ„å’Œå‡½æ•°çš„é›†åˆã€‚</li></ul></li><li>ç”¨ä¾‹<ul><li>è½¯ä»¶çš„ç”¨ä¾‹å±‚ä¸­é€šå¸¸åŒ…å«çš„æ˜¯ç‰¹å®šåº”ç”¨åœºæ™¯ä¸‹çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿™é‡Œé¢å°è£…å¹¶å®ç°äº†æ•´ä¸ªç³»ç»Ÿçš„æ‰€æœ‰ç”¨ä¾‹ã€‚è¿™äº›ç”¨ä¾‹å¼•å¯¼äº†æ•°æ®åœ¨ä¸šåŠ¡å®ä½“ä¹‹é—´çš„æµå…¥/æµå‡ºï¼Œå¹¶æŒ‡æŒ¥ç€ä¸šåŠ¡å®ä½“åˆ©ç”¨å…¶ä¸­çš„å…³é”®ä¸šåŠ¡é€»è¾‘æ¥å®ç°ç”¨ä¾‹çš„è®¾è®¡ç›®æ ‡ã€‚</li></ul></li><li>æ¥å£é€‚é…å™¨<ul><li>è½¯ä»¶çš„æ¥å£é€‚é…å™¨å±‚ä¸­é€šå¸¸æ˜¯ä¸€ç»„æ•°æ®è½¬æ¢å™¨ï¼Œå®ƒä»¬è´Ÿè´£å°†æ•°æ®ä»å¯¹ç”¨ä¾‹å’Œä¸šåŠ¡å®ä½“è€Œè¨€æœ€æ–¹ä¾¿æ“ä½œçš„æ ¼å¼ï¼Œè½¬åŒ–æˆå¤–éƒ¨ç³»ç»Ÿï¼ˆè­¬å¦‚æ•°æ®åº“ä»¥åŠ Webï¼‰æœ€æ–¹ä¾¿æ“ä½œçš„æ ¼å¼ã€‚</li></ul></li><li>å±‚æ¬¡è¶Šå¾€å†…ï¼Œå…¶æŠ½è±¡å’Œç­–ç•¥çš„å±‚æ¬¡è¶Šé«˜ï¼ŒåŒæ—¶è½¯ä»¶çš„æŠ½è±¡ç¨‹åº¦å°±è¶Šé«˜ï¼Œå…¶åŒ…å«çš„é«˜å±‚ç­–ç•¥å°±è¶Šå¤šã€‚æœ€å†…å±‚çš„åœ†ä¸­åŒ…å«çš„æ˜¯æœ€é€šç”¨ã€æœ€é«˜å±‚çš„ç­–ç•¥ï¼Œæœ€å¤–å±‚çš„åœ†åŒ…å«çš„æ˜¯æœ€å…·ä½“çš„å®ç°ç»†èŠ‚ã€‚</li><li>è¿™é‡Œæœ€é‡è¦çš„æ˜¯è¿™ä¸ªè·¨è¾¹ç•Œä¼ è¾“çš„å¯¹è±¡åº”è¯¥æœ‰ä¸€ä¸ªç‹¬ç«‹ã€ç®€å•çš„æ•°æ®ç»“æ„ã€‚</li><li><strong>ä¸è¦æŠ•æœºå–å·§åœ°ç›´æ¥ä¼ é€’ä¸šåŠ¡å®ä½“æˆ–æ•°æ®åº“è®°å½•å¯¹è±¡ã€‚</strong><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">çœ‹è¿‡å‰é¢çš„éƒ¨åˆ†å†æ¥çœ‹æ•´æ´æ¶æ„è¿™ä¸€ç« èŠ‚ä¼šå‘ç°éå¸¸çš„è‡ªç„¶</div></li></ul><h4 id="ç¬¬-23-ç« -å±•ç¤ºå™¨å’Œè°¦å‘å¯¹è±¡"><a href="#ç¬¬-23-ç« -å±•ç¤ºå™¨å’Œè°¦å‘å¯¹è±¡" class="headerlink" title="ç¬¬ 23 ç«  å±•ç¤ºå™¨å’Œè°¦å‘å¯¹è±¡"></a>ç¬¬ 23 ç«  å±•ç¤ºå™¨å’Œè°¦å‘å¯¹è±¡</h4><ul><li>è°¦å‘å¯¹è±¡æ¨¡å¼<ul><li>è°¦å‘å¯¹è±¡æ¨¡å¼æœ€åˆçš„è®¾è®¡ç›®çš„æ˜¯å¸®åŠ©å•å…ƒæµ‹è¯•çš„ç¼–å†™è€…åŒºåˆ†å®¹æ˜“æµ‹è¯•çš„è¡Œä¸ºä¸éš¾ä»¥æµ‹è¯•çš„è¡Œä¸ºï¼Œå¹¶å°†å®ƒä»¬éš”ç¦»ã€‚</li></ul></li><li>å±•ç¤ºå™¨ä¸è§†å›¾<ul><li>è§†å›¾éƒ¨åˆ†å±äºéš¾ä»¥æµ‹è¯•çš„è°¦å‘å¯¹è±¡ã€‚è¿™ç§å¯¹è±¡çš„ä»£ç é€šå¸¸åº”è¯¥è¶Šç®€å•è¶Šå¥½ï¼Œå®ƒåªåº”è´Ÿè´£å°†æ•°æ®å¡«å……åˆ° GUI ä¸Šï¼Œè€Œä¸åº”è¯¥å¯¹æ•°æ®è¿›è¡Œä»»ä½•å¤„ç†ã€‚</li><li>å±•ç¤ºå™¨åˆ™æ˜¯å¯æµ‹è¯•çš„å¯¹è±¡ã€‚å±•ç¤ºå™¨çš„å·¥ä½œæ˜¯è´Ÿè´£ä»åº”ç”¨ç¨‹åºä¸­æ¥æ”¶æ•°æ®ï¼Œç„¶åæŒ‰è§†å›¾çš„éœ€è¦å°†è¿™äº›æ•°æ®æ ¼å¼åŒ–ï¼Œä»¥ä¾¿è§†å›¾å°†å…¶å‘ˆç°åœ¨å±å¹•ä¸Šã€‚</li><li>å±•ç¤ºå™¨åˆ™æ˜¯å¯æµ‹è¯•çš„å¯¹è±¡ã€‚å±•ç¤ºå™¨çš„å·¥ä½œæ˜¯è´Ÿè´£ä»åº”ç”¨ç¨‹åºä¸­æ¥æ”¶æ•°æ®ï¼Œç„¶åæŒ‰è§†å›¾çš„éœ€è¦å°†è¿™äº›æ•°æ®æ ¼å¼åŒ–ï¼Œä»¥ä¾¿è§†å›¾å°†å…¶å‘ˆç°åœ¨å±å¹•ä¸Šã€‚</li><li>è§†å›¾éƒ¨åˆ†é™¤äº†åŠ è½½è§†å›¾æ¨¡å‹æ‰€éœ€è¦çš„å€¼ï¼Œä¸åº”è¯¥å†åšä»»ä½•å…¶ä»–äº‹æƒ…ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æ‰èƒ½è¯´è§†å›¾æ˜¯è°¦å‘å¯¹è±¡</li></ul></li><li>æ•°æ®åº“ç½‘å…³<ul><li>è¿™äº›å®ç°ä¹Ÿåº”è¯¥éƒ½å±äºè°¦å‘å¯¹è±¡ï¼Œå®ƒä»¬åº”è¯¥åªåˆ©ç”¨ SQL æˆ–å…¶ä»–æ•°æ®åº“æä¾›çš„æ¥å£æ¥è®¿é—®æ‰€éœ€è¦çš„æ•°æ®ã€‚</li><li>äº¤äº’å™¨å°½ç®¡ä¸å±äºè°¦å‘å¯¹è±¡ï¼Œå´æ˜¯å¯æµ‹è¯•çš„ï¼Œ</li></ul></li><li>æ•°æ®æ˜ å°„å™¨ï¼ˆORMï¼‰<ul><li>è¿™æ ·çš„ ORM ç³»ç»Ÿåº”è¯¥å±äºç³»ç»Ÿæ¶æ„ä¸­çš„å“ªä¸€å±‚å‘¢ï¼Ÿå½“ç„¶æ˜¯æ•°æ®åº“å±‚ã€‚ORM å…¶å®å°±æ˜¯åœ¨æ•°æ®åº“å’Œæ•°æ®åº“ç½‘å…³æ¥å£ä¹‹é—´æ„å»ºäº†å¦ä¸€ç§è°¦å‘å¯¹è±¡çš„è¾¹ç•Œã€‚</li></ul></li><li>å› ä¸ºè·¨è¾¹ç•Œçš„é€šä¿¡è‚¯å®šéœ€è¦ç”¨åˆ°æŸç§ç®€å•çš„æ•°æ®ç»“æ„ï¼Œè€Œè¾¹ç•Œä¼šè‡ªç„¶è€Œç„¶åœ°å°†ç³»ç»Ÿåˆ†å‰²æˆéš¾ä»¥æµ‹è¯•çš„éƒ¨åˆ†ä¸å®¹æ˜“æµ‹è¯•çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥é€šè¿‡åœ¨ç³»ç»Ÿçš„è¾¹ç•Œå¤„è¿ç”¨è°¦å‘å¯¹è±¡æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥å¤§å¹…åœ°æé«˜æ•´ä¸ªç³»ç»Ÿçš„å¯æµ‹è¯•æ€§ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">è¿™é‡Œä¸»è¦æ˜¯å°†å¾ˆéš¾è¿›è¡Œå•å…ƒæµ‹è¯•çš„è¡Œä¸ºå’Œå®¹æ˜“æµ‹è¯•çš„è¡Œä¸ºè¿›è¡Œåˆ†ç¦»ï¼Œå¾ˆéš¾è¢«æµ‹è¯•çš„è¡Œä¸ºå¸¸å¸¸ä¼šè¢«åˆ†ç¦»æˆä¸ºä¸€ä¸ªè°¦å‘å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡éå¸¸çš„ç®€å•ï¼Œä¸ä¼šåŒ…å«å¾ˆå¤šé€»è¾‘</div></li></ul><h4 id="ç¬¬-24-ç« -ä¸å®Œå…¨è¾¹ç•Œ"><a href="#ç¬¬-24-ç« -ä¸å®Œå…¨è¾¹ç•Œ" class="headerlink" title="ç¬¬ 24 ç«  ä¸å®Œå…¨è¾¹ç•Œ"></a>ç¬¬ 24 ç«  ä¸å®Œå…¨è¾¹ç•Œ</h4><ul><li>æ„å»ºä¸å®Œå…¨è¾¹ç•Œçš„æ–¹å¼<ul><li>æ„å»ºä¸å®Œå…¨è¾¹ç•Œçš„ä¸€ç§æ–¹å¼å°±æ˜¯åœ¨å°†ç³»ç»Ÿåˆ†å‰²æˆä¸€ç³»åˆ—å¯ä»¥ç‹¬ç«‹ç¼–è¯‘ã€ç‹¬ç«‹éƒ¨ç½²çš„ç»„ä»¶ä¹‹åï¼Œå†æŠŠå®ƒä»¬æ„å»ºæˆä¸€ä¸ªç»„ä»¶ã€‚</li><li>å•å‘è¾¹ç•Œ</li><li>é—¨æˆ·æ¨¡å¼<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">æ¶æ„æ˜¯éœ€è¦å–èˆçš„ï¼Œæˆ‘ä»¬ä¸å¯èƒ½æ¯ä¸€é¡¹éƒ½åšçš„å¾ˆå®Œç¾ï¼Œè¾¹ç•Œçš„åˆ’åˆ†ä¹Ÿæ˜¯è¿™æ ·ï¼Œæ‰€ä»¥å°±æœ‰äº†ä¸å®Œå…¨çš„è¾¹ç•Œ</div></li></ul></li></ul><h4 id="ç¬¬-25-ç« -å±‚æ¬¡ä¸è¾¹ç•Œ"><a href="#ç¬¬-25-ç« -å±‚æ¬¡ä¸è¾¹ç•Œ" class="headerlink" title="ç¬¬ 25 ç«  å±‚æ¬¡ä¸è¾¹ç•Œ"></a>ç¬¬ 25 ç«  å±‚æ¬¡ä¸è¾¹ç•Œ</h4><ul><li><strong>è¿‡åº¦çš„å·¥ç¨‹è®¾è®¡å¾€å¾€æ¯”å·¥ç¨‹è®¾è®¡ä¸è¶³è¿˜è¦ç³Ÿç³•</strong></li><li>ç°å®å°±æ˜¯è¿™æ ·ã€‚ä½œä¸ºè½¯ä»¶æ¶æ„å¸ˆï¼Œæˆ‘ä»¬å¿…é¡»æœ‰ä¸€ç‚¹æœªåœå…ˆçŸ¥çš„èƒ½åŠ›ã€‚æœ‰æ—¶å€™è¦ä¾é çŒœæµ‹â€”â€”å½“ç„¶è¿˜è¦ç”¨ç‚¹è„‘å­ã€‚è½¯ä»¶æ¶æ„å¸ˆå¿…é¡»ä»”ç»†æƒè¡¡æˆæœ¬ï¼Œå†³å®šå“ªé‡Œéœ€è¦è®¾è®¡æ¶æ„è¾¹ç•Œï¼Œä»¥åŠè¿™äº›åœ°æ–¹éœ€è¦çš„æ˜¯å®Œæ•´çš„è¾¹ç•Œï¼Œè¿˜æ˜¯ä¸å®Œå…¨çš„è¾¹ç•Œï¼Œè¿˜æ˜¯å¯ä»¥å¿½ç•¥çš„è¾¹ç•Œ</li><li>æ¶æ„å¸ˆå¿…é¡»æŒç»­è§‚å¯Ÿç³»ç»Ÿçš„æ¼”è¿›ï¼Œæ—¶åˆ»æ³¨æ„å“ªé‡Œå¯èƒ½éœ€è¦è®¾è®¡è¾¹ç•Œï¼Œç„¶åä»”ç»†è§‚å¯Ÿè¿™äº›åœ°æ–¹ä¼šç”±äºä¸å­˜åœ¨è¾¹ç•Œè€Œå‡ºç°å“ªäº›é—®é¢˜ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">ä¸è¦è¿‡åº¦ä¼˜åŒ–ï¼Œä½†æ˜¯ä¹Ÿä¸è¦ä»€ä¹ˆéƒ½ä¸ç®¡çš„ä¸€æŠŠæ¢­ï¼Œæ¶æ„å¸ˆéœ€è¦æ¼”è¿›å’Œå–èˆçš„ï¼Œæ²¡æœ‰å®Œç¾çš„æ¶æ„åªæœ‰ä¸æ–­æŒç»­æ¼”è¿›ä¼˜åŒ–çš„æ¶æ„ã€‚</div></li></ul><h4 id="ç¬¬-26-ç« -Main-ç»„ä»¶"><a href="#ç¬¬-26-ç« -Main-ç»„ä»¶" class="headerlink" title="ç¬¬ 26 ç«  Main ç»„ä»¶"></a>ç¬¬ 26 ç«  Main ç»„ä»¶</h4><ul><li>Main æ˜¯æœ€ç»†èŠ‚åŒ–çš„éƒ¨åˆ†</li><li>Main ç»„ä»¶çš„ä»»åŠ¡æ˜¯åˆ›å»ºæ‰€æœ‰çš„å·¥å‚ç±»ã€ç­–ç•¥ç±»ä»¥åŠå…¶ä»–çš„å…¨å±€è®¾æ–½ï¼Œå¹¶æœ€ç»ˆå°†ç³»ç»Ÿçš„æ§åˆ¶æƒè½¬äº¤ç»™æœ€é«˜æŠ½è±¡å±‚çš„ä»£ç æ¥å¤„ç†ã€‚</li><li>Main ç»„ä»¶ä¸­çš„ä¾èµ–å…³ç³»é€šå¸¸åº”è¯¥ç”±ä¾èµ–æ³¨å…¥æ¡†æ¶æ¥æ³¨å…¥ã€‚</li><li>æˆ‘ä»¬åœ¨è¿™é‡Œçš„é‡ç‚¹æ˜¯è¦è¯´æ˜ Main ç»„ä»¶æ˜¯æ•´ä¸ªç³»ç»Ÿä¸­çš„ä¸€ä¸ªåº•å±‚æ¨¡å—ï¼Œå®ƒå¤„äºæ•´æ´æ¶æ„çš„æœ€å¤–åœˆï¼Œä¸»è¦è´Ÿè´£ä¸ºç³»ç»ŸåŠ è½½æ‰€æœ‰å¿…è¦çš„ä¿¡æ¯ï¼Œç„¶åå†å°†æ§åˆ¶æƒè½¬äº¤å›ç³»ç»Ÿçš„é«˜å±‚ç»„ä»¶ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">main æ˜¯ä¸€ä¸ªç¨‹åºçš„å…¥å£ï¼Œè¿™æ˜¯æœ€ç»†èŠ‚çš„éƒ¨åˆ†ï¼Œå› ä¸ºä¹‹å‰ä¸ºäº†å¾ˆå¤šä¸œè¥¿ä¸è¢«ä¾èµ–ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé‡‡ç”¨æ¥å£æ¥å®ç°ä¾èµ–åè½¬ï¼Œè¿™æ—¶å€™å°±ä¼šå¯¼è‡´æˆ‘ä»¬æ‰€æœ‰çš„ä¾èµ–å…³ç³»çš„æ„å»ºéƒ½éœ€è¦åœ¨ main ä¸­è¿›è¡Œå®Œæˆï¼Œæ‰€ä»¥ä¸€èˆ¬è€Œè¨€æˆ‘ä»¬ä¼šåœ¨ main ä¸­å¼•å…¥ä¾èµ–æ³¨å…¥æ¡†æ¶ã€‚</div></li></ul><h4 id="ç¬¬-27-ç« -æœåŠ¡ï¼šå®è§‚ä¸å¾®è§‚"><a href="#ç¬¬-27-ç« -æœåŠ¡ï¼šå®è§‚ä¸å¾®è§‚" class="headerlink" title="ç¬¬ 27 ç«  æœåŠ¡ï¼šå®è§‚ä¸å¾®è§‚"></a>ç¬¬ 27 ç«  æœåŠ¡ï¼šå®è§‚ä¸å¾®è§‚</h4><ul><li>æ‰€è°“çš„æœåŠ¡æœ¬èº«åªæ˜¯ä¸€ç§æ¯”å‡½æ•°è°ƒç”¨æ–¹å¼æˆæœ¬ç¨é«˜çš„ï¼Œåˆ†å‰²åº”ç”¨ç¨‹åºè¡Œä¸ºçš„ä¸€ç§å½¢å¼ï¼Œä¸ç³»ç»Ÿæ¶æ„æ— å…³ã€‚</li><li>æœåŠ¡æ‰€å¸¦æ¥çš„å¥½å¤„ï¼Ÿ<ul><li>è§£è€¦åˆçš„è°¬è®º</li><li>ç‹¬ç«‹å¼€å‘éƒ¨ç½²çš„è°¬è®º</li><li>è¿™ç§ç†å¿µæœ‰ä¸€äº›é“ç†â€”â€”ä½†ä¹Ÿä»…ä»…æ˜¯ä¸€äº›è€Œå·²ã€‚é¦–å…ˆï¼Œ<strong>æ— æ•°å†å²äº‹å®è¯æ˜ï¼Œå¤§å‹ç³»ç»Ÿä¸€æ ·å¯ä»¥é‡‡ç”¨å•ä½“æ¨¡å¼ï¼Œæˆ–è€…ç»„ä»¶æ¨¡å¼æ¥æ„å»ºï¼Œä¸ä¸€å®šéå¾—æœåŠ¡åŒ–ã€‚</strong>å› æ­¤æœåŠ¡åŒ–å¹¶ä¸æ˜¯æ„å»ºå¤§å‹ç³»ç»Ÿçš„å”¯ä¸€é€‰æ‹©ã€‚</li></ul></li><li>æ¨ªè·¨å‹å˜æ›´ï¼ˆcross-cutting concernï¼‰é—®é¢˜ï¼Œå®ƒæ˜¯æ‰€æœ‰çš„è½¯ä»¶ç³»ç»Ÿéƒ½è¦é¢å¯¹çš„é—®é¢˜ï¼Œæ— è®ºæœåŠ¡åŒ–è¿˜æ˜¯éæœåŠ¡åŒ–çš„ã€‚</li><li>æœåŠ¡ä¹Ÿå¯ä»¥æŒ‰ç…§ SOLID åŸåˆ™æ¥è®¾è®¡ï¼ŒæŒ‰ç…§ç»„ä»¶ç»“æ„æ¥éƒ¨ç½²ï¼Œè¿™æ ·å°±å¯ä»¥åšåˆ°åœ¨æ·»åŠ /åˆ é™¤ç»„ä»¶æ—¶ä¸å½±å“æœåŠ¡ä¸­çš„å…¶ä»–ç»„ä»¶ã€‚</li><li>ç³»ç»Ÿçš„æ¶æ„è¾¹ç•Œäº‹å®ä¸Šå¹¶ä¸è½åœ¨æœåŠ¡ä¹‹é—´ï¼Œè€Œæ˜¯ç©¿é€æ‰€æœ‰æœåŠ¡ï¼Œåœ¨æœåŠ¡å†…éƒ¨ä»¥ç»„ä»¶çš„å½¢å¼å­˜åœ¨</li><li><strong>æœåŠ¡è¾¹ç•Œå¹¶ä¸èƒ½ä»£è¡¨ç³»ç»Ÿçš„æ¶æ„è¾¹ç•Œï¼ŒæœåŠ¡å†…éƒ¨çš„ç»„ä»¶è¾¹ç•Œæ‰æ˜¯ã€‚</strong></li><li>ç³»ç»Ÿçš„æ¶æ„æ˜¯ç”±ç³»ç»Ÿå†…éƒ¨çš„æ¶æ„è¾¹ç•Œï¼Œä»¥åŠè¾¹ç•Œä¹‹é—´çš„ä¾èµ–å…³ç³»æ‰€å®šä¹‰çš„ï¼Œä¸ç³»ç»Ÿä¸­å„ç»„ä»¶ä¹‹é—´çš„è°ƒç”¨å’Œé€šä¿¡æ–¹å¼æ— å…³ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">è™½ç„¶ç°åœ¨å¾®æœåŠ¡æ¶æ„éå¸¸ç«çƒ­ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰çš„æœåŠ¡éƒ½æ˜¯æ‹†åˆ†äº†æœåŠ¡ï¼Œä½†æ˜¯æ‹†åˆ†äº†æœåŠ¡å¹¶ä¸ä¸€å®šè¡¨ç¤ºå°±è§£è€¦åˆäº†ï¼Œä¹Ÿå¹¶ä¸ä¸€å®šå°±çœŸçš„èƒ½ç‹¬ç«‹éƒ¨ç½²ï¼Œæƒ³ä¸€æƒ³è¿™æ˜¯ç°åœ¨å¾ˆå¸¸è§çš„ï¼Œä¸€ä¸ªåº”ç”¨å¿…é¡»è¦å’Œå¦å¤–ä¸€ä¸ªåº”ç”¨ä¸€åŒä¸Šçº¿ï¼Œæ ¹æœ¬åšä¸äº†ç‹¬ç«‹éƒ¨ç½²ã€‚</div></li></ul><h4 id="ç¬¬-28-ç« -æµ‹è¯•è¾¹ç•Œ"><a href="#ç¬¬-28-ç« -æµ‹è¯•è¾¹ç•Œ" class="headerlink" title="ç¬¬ 28 ç«  æµ‹è¯•è¾¹ç•Œ"></a>ç¬¬ 28 ç«  æµ‹è¯•è¾¹ç•Œ</h4><ul><li>å¯æµ‹è¯•æ€§è®¾è®¡</li><li>å¦‚æœæµ‹è¯•ä»£ç ä¸ç³»ç»Ÿæ˜¯å¼ºè€¦åˆçš„ï¼Œå®ƒå°±å¾—éšç€ç³»ç»Ÿå˜æ›´è€Œå˜æ›´ã€‚å“ªæ€•åªæ˜¯ç³»ç»Ÿä¸­ç»„ä»¶çš„ä¸€ç‚¹å°å˜åŒ–ï¼Œéƒ½å¯èƒ½ä¼šå¯¼è‡´è®¸å¤šä¸ä¹‹ç›¸è€¦åˆçš„æµ‹è¯•å‡ºç°é—®é¢˜ï¼Œéœ€è¦åšå‡ºç›¸åº”çš„å˜æ›´ã€‚</li><li>è½¯ä»¶è®¾è®¡çš„ç¬¬ä¸€æ¡åŸåˆ™â€”â€”ä¸ç®¡æ˜¯ä¸ºäº†å¯æµ‹è¯•æ€§è¿˜æ˜¯å…¶ä»–ä»€ä¹ˆä¸œè¥¿â€”â€”æ˜¯ä¸å˜çš„ï¼Œå°±æ˜¯ä¸è¦ä¾èµ–äºå¤šå˜çš„ä¸œè¥¿ã€‚</li><li>æ²¡æœ‰æŒ‰ç³»ç»Ÿç»„æˆéƒ¨åˆ†æ¥è®¾è®¡çš„æµ‹è¯•ä»£ç ï¼Œå¾€å¾€æ˜¯éå¸¸è„†å¼±ä¸”éš¾ä»¥ç»´æŠ¤çš„ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">ä¸å˜çš„ç»„ä»¶ä¸è¦ä¾èµ–å¤šå˜çš„ä¸œè¥¿ï¼Œè¿™æ ·ä¼šå¯¼è‡´éå¸¸éš¾ä»¥æµ‹è¯•</div></li></ul><h4 id="ç¬¬-29-ç« -æ•´æ´çš„åµŒå…¥å¼æ¶æ„"><a href="#ç¬¬-29-ç« -æ•´æ´çš„åµŒå…¥å¼æ¶æ„" class="headerlink" title="ç¬¬ 29 ç«  æ•´æ´çš„åµŒå…¥å¼æ¶æ„"></a>ç¬¬ 29 ç«  æ•´æ´çš„åµŒå…¥å¼æ¶æ„</h4><ul><li>è™½ç„¶è½¯ä»¶æœ¬èº«å¹¶ä¸ä¼šéšæ—¶é—´æ¨ç§»è€Œç£¨æŸï¼Œä½†ç¡¬ä»¶åŠå…¶å›ºä»¶å´ä¼šéšæ—¶é—´æ¨ç§»è€Œè¿‡æ—¶ï¼Œéšå³ä¹Ÿéœ€è¦å¯¹è½¯ä»¶åšç›¸åº”æ”¹åŠ¨</li><li>è™½ç„¶è½¯ä»¶è´¨é‡æœ¬èº«å¹¶ä¸ä¼šéšæ—¶é—´æ¨ç§»è€ŒæŸè€—ï¼Œä½†æ˜¯æœªå¦¥å–„ç®¡ç†çš„ç¡¬ä»¶ä¾èµ–å’Œå›ºä»¶ä¾èµ–å´æ˜¯è½¯ä»¶çš„å¤´å·æ€æ‰‹ã€‚</li><li>ä½†å¦‚æœä½ åœ¨ä»£ç ä¸­åµŒå…¥äº† SQL æˆ–è€…æ˜¯ä»£ç ä¸­å¼•å…¥äº†å¯¹æŸä¸ªå¹³å°çš„ä¾èµ–çš„è¯ï¼Œå…¶å®å°±æ˜¯åœ¨å†™å›ºä»¶ä»£ç ã€‚</li><li>è½¯ä»¶æ„å»ºè¿‡ç¨‹ä¸­çš„ä¸‰ä¸ªé˜¶æ®µ<ul><li>â€œå…ˆè®©ä»£ç å·¥ä½œèµ·æ¥â€â€”â€”å¦‚æœä»£ç ä¸èƒ½å·¥ä½œï¼Œå°±ä¸èƒ½äº§ç”Ÿä»·å€¼ã€‚</li><li>â€œç„¶åå†è¯•å›¾å°†å®ƒå˜å¥½â€â€”â€”é€šè¿‡å¯¹ä»£ç è¿›è¡Œé‡æ„ï¼Œè®©æˆ‘ä»¬è‡ªå·±å’Œå…¶ä»–äººæ›´å¥½åœ°ç†è§£ä»£ç ï¼Œå¹¶èƒ½æŒ‰ç…§éœ€æ±‚ä¸æ–­åœ°ä¿®æ”¹ä»£ç </li><li>â€œæœ€åå†è¯•ç€è®©å®ƒè¿è¡Œå¾—æ›´å¿«â€â€”â€”æŒ‰ç…§æ€§èƒ½æå‡çš„â€œéœ€æ±‚â€æ¥é‡æ„ä»£ç ã€‚</li></ul></li><li>æ•´æ´çš„åµŒå…¥å¼æ¶æ„å°±æ˜¯å¯æµ‹è¯•çš„åµŒå…¥å¼æ¶æ„</li><li>è½¯ä»¶ä¸å›ºä»¶é›†æˆåœ¨ä¸€èµ·ä¹Ÿå±äºè®¾è®¡ä¸Šçš„åæ¨¡å¼ï¼ˆanti-patternï¼‰<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">è½¯ä»¶å¹¶ä¸ä¼šéšç€æ—¶é—´ç£¨æŸä½†æ˜¯ç¡¬ä»¶æ˜¯ä¼šè¿‡æ—¶çš„ï¼Œè€Œä¸”æ¢çš„è¿˜éå¸¸é¢‘ç¹ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±å¿…é¡»è¦æŠŠç¡¬ä»¶ä»¥åŠå›ºä»¶ä»£ç ç»™éš”ç¦»èµ·æ¥ï¼Œå¯¹äº†ä¸è¦è®¤ä¸ºæˆ‘ä»¬ä¸åšåµŒå…¥å¼å¼€å‘å¹³æ—¶å°±å¾ˆå°‘æ¥è§¦åˆ°è¿™ä¸ªï¼ŒSQL è¯­å¥å…¶å®ä¹Ÿæ˜¯ä¸€ç§å›ºä»¶ä»£ç </div></li></ul><h3 id="ç¬¬å…­éƒ¨é—¨-å®ç°ç»†èŠ‚"><a href="#ç¬¬å…­éƒ¨é—¨-å®ç°ç»†èŠ‚" class="headerlink" title="ç¬¬å…­éƒ¨é—¨ å®ç°ç»†èŠ‚"></a>ç¬¬å…­éƒ¨é—¨ å®ç°ç»†èŠ‚</h3><h4 id="ç¬¬-30-ç« -æ•°æ®åº“åªæ˜¯å®ç°ç»†èŠ‚"><a href="#ç¬¬-30-ç« -æ•°æ®åº“åªæ˜¯å®ç°ç»†èŠ‚" class="headerlink" title="ç¬¬ 30 ç«  æ•°æ®åº“åªæ˜¯å®ç°ç»†èŠ‚"></a>ç¬¬ 30 ç«  æ•°æ®åº“åªæ˜¯å®ç°ç»†èŠ‚</h4><ul><li>å°±æ•°æ®åº“ä¸æ•´ä¸ªç³»ç»Ÿæ¶æ„çš„å…³ç³»æ‰“ä¸ªæ¯”æ–¹ï¼Œå®ƒä»¬ä¹‹é—´å°±å¥½æ¯”æ˜¯é—¨æŠŠæ‰‹å’Œæ•´ä¸ªæˆ¿å±‹æ¶æ„çš„å…³ç³»</li><li>ä½†å½“é—®é¢˜æ¶‰åŠæ•°æ®å­˜å‚¨æ—¶ï¼Œè¿™æ–¹é¢çš„æ“ä½œé€šå¸¸æ˜¯è¢«å°è£…èµ·æ¥ï¼Œéš”ç¦»åœ¨ä¸šåŠ¡é€»è¾‘ä¹‹å¤–çš„</li><li>æ•°æ®æœ¬èº«å¾ˆé‡è¦ï¼Œä½†æ•°æ®åº“ç³»ç»Ÿä»…ä»…æ˜¯ä¸€ä¸ªå®ç°ç»†èŠ‚ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">æ•°æ®å¾ˆé‡è¦ï¼Œä½†æ˜¯æ•°æ®åº“ç³»ç»Ÿæ˜¯ä¸€ä¸ªç»†èŠ‚ï¼Œä¹¦ä¸Šè¿™ä¸€ç« ç”¨äº†ä¸€ä¸ªä¾‹å­è¯´æ˜æœ‰æ—¶å€™å¯èƒ½çœŸçš„ç”¨ä¸åˆ°æ•°æ®åº“ã€‚æ¢ä¸ªå¸¸è§çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯èƒ½ç³»ç»Ÿåˆšå¼€å§‹çš„æ—¶å€™ä½¿ç”¨ SQlite å°±å¯ä»¥ï¼Œéšç€ä¸šåŠ¡å‘å±•ç”¨ä¸Šäº† MySQLï¼Œç„¶åéšç€å¹¶å‘çš„æé«˜åˆä¼šå¼•å…¥ç¼“å­˜ç»„ä»¶ï¼Œè¿™äº›å˜åŒ–å…¶å®å’Œä¸šåŠ¡é€»è¾‘éƒ½æ²¡æœ‰å…³ç³»ï¼Œæ•°æ®åº“çš„å˜åŒ–æ˜¯ä¸åº”è¯¥å½±å“åˆ°ä¸šåŠ¡é€»è¾‘çš„</div></li></ul><h4 id="ç¬¬-31-ç« -Web-æ˜¯å®ç°ç»†èŠ‚"><a href="#ç¬¬-31-ç« -Web-æ˜¯å®ç°ç»†èŠ‚" class="headerlink" title="ç¬¬ 31 ç«  Web æ˜¯å®ç°ç»†èŠ‚"></a>ç¬¬ 31 ç«  Web æ˜¯å®ç°ç»†èŠ‚</h4><ul><li>GUI åªæ˜¯ä¸€ä¸ªå®ç°ç»†èŠ‚ã€‚è€Œ Web åˆ™æ˜¯ GUI çš„ä¸€ç§ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ä¸€ä¸ªå®ç°ç»†èŠ‚ã€‚ä½œä¸ºä¸€åè½¯ä»¶æ¶æ„å¸ˆï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™ç±»ç»†èŠ‚ä¸æ ¸å¿ƒä¸šåŠ¡é€»è¾‘éš”ç¦»å¼€æ¥ã€‚</li></ul><h4 id="ç¬¬-32-ç« -åº”ç”¨ç¨‹åºæ¡†æ¶æ˜¯å®ç°ç»†èŠ‚"><a href="#ç¬¬-32-ç« -åº”ç”¨ç¨‹åºæ¡†æ¶æ˜¯å®ç°ç»†èŠ‚" class="headerlink" title="ç¬¬ 32 ç«  åº”ç”¨ç¨‹åºæ¡†æ¶æ˜¯å®ç°ç»†èŠ‚"></a>ç¬¬ 32 ç«  åº”ç”¨ç¨‹åºæ¡†æ¶æ˜¯å®ç°ç»†èŠ‚</h4><ul><li>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¡†æ¶â€”â€”ä½†è¦æ—¶åˆ»è­¦æƒ•ï¼Œåˆ«è¢«å®ƒæ‹–ä½</li><li>æ¯•ç«Ÿ Main ç»„ä»¶ä½œä¸ºç³»ç»Ÿæ¶æ„ä¸­æœ€ä½å±‚ã€ä¾èµ–æœ€å¤šçš„ç»„ä»¶ï¼Œå®ƒä¾èµ–äº Spring å¹¶ä¸æ˜¯é—®é¢˜ã€‚<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">æ¡†æ¶çš„é€‰æ‹©è¦æ…é‡ï¼Œæˆ‘ä»¬ä¸šåŠ¡é€»è¾‘æœ¬èº«ä¸èƒ½ä¾èµ–æ¡†æ¶</div></li></ul><h4 id="ç¬¬-33-ç« -æ¡ˆä¾‹åˆ†æï¼šè§†é¢‘é”€å”®ç½‘ç«™"><a href="#ç¬¬-33-ç« -æ¡ˆä¾‹åˆ†æï¼šè§†é¢‘é”€å”®ç½‘ç«™" class="headerlink" title="ç¬¬ 33 ç«  æ¡ˆä¾‹åˆ†æï¼šè§†é¢‘é”€å”®ç½‘ç«™"></a>ç¬¬ 33 ç«  æ¡ˆä¾‹åˆ†æï¼šè§†é¢‘é”€å”®ç½‘ç«™</h4><ul><li>ç³»ç»Ÿæ¶æ„è®¾è®¡ä¸­çš„ç¬¬ä¸€æ­¥ï¼Œæ˜¯è¯†åˆ«ç³»ç»Ÿä¸­çš„å„ç§è§’è‰²å’Œç”¨ä¾‹<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">è¿™ä¸€æ­¥çœ‹èµ·æ¥ç®€å•ï¼Œä½†æ˜¯éå¸¸è€ƒéªŒä¸€ä¸ªäººçš„åŠŸåŠ›</div></li></ul><h4 id="ç¬¬-34-ç« -æ‹¾é—"><a href="#ç¬¬-34-ç« -æ‹¾é—" class="headerlink" title="ç¬¬ 34 ç«  æ‹¾é—"></a>ç¬¬ 34 ç«  æ‹¾é—</h4><ul><li>åˆ†å±‚æ¶æ„æ— æ³•å±•ç°å…·ä½“çš„ä¸šåŠ¡é¢†åŸŸä¿¡æ¯ã€‚æŠŠä¸¤ä¸ªä¸åŒä¸šåŠ¡é¢†åŸŸçš„ã€ä½†æ˜¯éƒ½é‡‡ç”¨äº†åˆ†å±‚æ¶æ„çš„ä»£ç è¿›è¡Œå¯¹æ¯”ï¼Œä½ ä¼šå‘ç°å®ƒä»¬çš„ç›¸ä¼¼ç¨‹åº¦æé«˜</li><li>å®½æ¾çš„åˆ†å±‚æ¶æ„ï¼Œå…è®¸æŸäº›å±‚è·³è¿‡ç›´æ¥ç›¸é‚»çš„é‚»å±…ã€‚</li><li>ä¸€ä¸ªæ¶æ„è®¾è®¡åŸåˆ™â€”â€”å†…å®¹æ˜¯â€œWeb æ§åˆ¶å™¨æ°¸è¿œä¸åº”è¯¥ç›´æ¥è®¿é—®æ•°æ®å±‚â€ã€‚</li><li>ç³»ç»Ÿç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ç»„æˆï¼ˆä¾‹å¦‚ Web åº”ç”¨ã€ç§»åŠ¨ Appã€ç‹¬ç«‹åº”ç”¨ã€æ•°æ®åº“ã€æ–‡ä»¶ç³»ç»Ÿï¼‰ï¼Œæ¯ä¸ªå®¹å™¨åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç»„ä»¶ï¼Œæ¯ä¸ªç»„ä»¶ç”±ä¸€ä¸ªæˆ–å¤šä¸ªç±»ç»„æˆã€‚</li><li>å¦‚æœä¸è€ƒè™‘å…·ä½“å®ç°ç»†èŠ‚ï¼Œå†å¥½çš„è®¾è®¡ä¹Ÿæ— æ³•é•¿ä¹…ã€‚å¿…é¡»è¦å°†è®¾è®¡æ˜ å°„åˆ°å¯¹åº”çš„ä»£ç ç»“æ„ä¸Šï¼Œè€ƒè™‘å¦‚ä½•ç»„ç»‡ä»£ç æ ‘ï¼Œä»¥åŠåœ¨ç¼–è¯‘æœŸå’Œè¿è¡ŒæœŸé‡‡ç”¨å“ªç§è§£è€¦åˆçš„æ¨¡å¼ã€‚</li><li>æœ€å¥½èƒ½åˆ©ç”¨ç¼–è¯‘å™¨æ¥ç»´æŠ¤æ‰€é€‰çš„ç³»ç»Ÿæ¶æ„è®¾è®¡é£æ ¼ï¼Œå°å¿ƒé˜²èŒƒæ¥è‡ªå…¶ä»–åœ°æ–¹çš„è€¦åˆæ¨¡å¼ï¼Œä¾‹å¦‚æ•°æ®ç»“æ„</li></ul><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1611842328934-ca4190d2-94c9-415a-befe-bcaebcd1aa4f.png" alt="image.png"></p><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">è¿™ä¸€ç« å¯¹æ¯”äº†å››ç§æ¶æ„é£æ ¼ï¼ŒåŒæ—¶æå‡ºäº†ï¼Œæ¶æ„è®¾è®¡æ˜¯éœ€è¦è€ƒè™‘å®ç°ç»†èŠ‚çš„ï¼Œè®¾è®¡éœ€è¦æ˜ å°„åˆ°ä»£ç ç»“æ„å’Œä»£ç æ ‘ä¸Šï¼Œè¿™ä¸ªå…¶å®å’Œæœ€å¼€å§‹çš„â€œè½¯ä»¶æ¶æ„å¸ˆè‡ªèº«éœ€è¦æ˜¯ç¨‹åºå‘˜ï¼Œå¹¶ä¸”å¿…é¡»ä¸€ç›´åšæŒåšä¸€çº¿ç¨‹åºå‘˜â€äº¤ç›¸å‘¼åº”ã€‚<br>å¦‚æœå¯ä»¥åœ¨ç¼–è¯‘æ—¶è§£å†³çš„é—®é¢˜ï¼Œå°±ä¸è¦æ”¾åˆ°è¿è¡Œæ—¶ï¼Œç¼–è¯‘çš„é—®é¢˜å¾€å¾€è¦æ¯”è¿è¡Œæ—¶çš„é—®é¢˜å¥½è§£å†³ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Go çš„ä¾èµ–æ³¨å…¥æ¡†æ¶æˆ‘æ›´åŠ æ¨è wire çš„åŸå› ï¼ŒåŒç†ä½œè€…æå‡ºäº† å¦‚æœè¦é˜²æ­¢ç›´æ¥ä¸­ webæ§åˆ¶å™¨è°ƒç”¨æ•°æ®å±‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸åº”è¯¥å°†æ•°æ®å±‚ï¼ˆrepoï¼‰æš´éœ²å‡ºæ¥ï¼Œåªéœ€è¦æš´éœ² usecase å°±å¥½äº†ã€‚</div><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¹‹å‰å…¶å®ä¹Ÿå¤§æ¦‚äº†è§£è¿‡æ•´æ´æ¶æ„ï¼Œä»æœ€å¼€å§‹è§‰å¾—å®ƒåˆè‡­åˆé•¿ï¼Œåˆ°ç°åœ¨å·¥ä½œä¸¤ä¸‰å¹´åè§‰å¾—â€œä¸å¬è€äººè¨€ï¼Œåƒäºåœ¨çœ¼å‰â€ï¼Œå½“æˆ‘ä»¬åœ¨å¯¹ä¸€ä¸ªæ¶æ„æˆ–è€…æ˜¯äº‹åŠ¡è¿›è¡Œæ‰¹åˆ¤çš„æ—¶å€™ä¸€å®šè¦äº†è§£å®ƒé¢å¯¹çš„åœºæ™¯ä»¥åŠå®ƒçš„ç†å¿µï¼Œè¿™æ˜¯æœ€é‡è¦çš„ã€‚å½“ç„¶è½¯ä»¶é¢†åŸŸæ˜¯æ²¡æœ‰é“¶å¼¹çš„ï¼Œæˆ‘ä»¬éœ€è¦åšçš„æ˜¯å¸æ”¶æ¯ä¸€ç§æ€æƒ³ï¼Œåœ¨ä¸åŒçš„åœºæ™¯ä¸‹åšä¸åŒçš„å–èˆï¼Œæ¥ä¸‹æ¥ä¼šæœ‰å‡ ç¯‡æ–‡ç« ç»“åˆæ¯›è€å¸ˆè¯¾ä¸Šè®²çš„ Go å·¥ç¨‹åŒ–ç›¸å…³çš„å†…å®¹ï¼Œä»¥åŠæˆ‘åœ¨å·¥ä½œå½“ä¸­è¿›è¡Œçš„ä¸€äº›æ€»ç»“æœ€åæå‡ºä¸€ç§å½“ä¸‹æˆ‘è§‰å¾—çš„ Go é¡¹ç›®çš„ç»„ç»‡æ–¹å¼ï¼Œè¿™ç§æ–¹å¼ä¸æ˜¯æœ€å¥½çš„ï¼Œä½†æ˜¯æˆ‘è§‰å¾—æ˜¯ç°é˜¶æ®µæœ€é€‚åˆçš„ã€‚<br>æ¨èå¤§å®¶åœ¨ä»”ç»†çš„é˜…è¯»ä¸€ä¸‹æœ¬ä¹¦ï¼ŒæœŸæœ›ä½ èƒ½æœ‰æ›´å¤šçš„æ”¶è·ã€‚</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://weread.qq.com/web/reader/480322f072021a3248038c8kc81322c012c81e728d9d180">æ¶æ„æ•´æ´ä¹‹é“-ç½—ä¼¯ç‰¹Â·CÂ·é©¬ä¸-å¾®ä¿¡è¯»ä¹¦</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week04: Go å·¥ç¨‹åŒ–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å·¥ç¨‹åŒ–</tag>
      
      <tag>è¯»ä¹¦ç¬”è®°</tag>
      
      <tag>æ¶æ„</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¹¶å‘ç¼–ç¨‹(åä¸€) æ€»ç»“</title>
    <link href="/post/go-training-week3-sum.html"/>
    <url>/post/go-training-week3-sum.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ€å¼€å§‹æ‰“ç®—ä¸€å‘¨æ›´æ–° 1 - 2 ç¯‡å­¦ä¹ ç¬”è®°ï¼Œè¿™æ ·æ—¢å¯ä»¥è·Ÿä¸Šè¯¾ç¨‹çš„è¿›åº¦åˆèƒ½è¾“å‡ºä¸€äº›æ–‡ç« ï¼Œåˆ†äº«ä¸€ç‚¹çŸ¥è¯†ï¼Œä½†æ˜¯åœ¨å†™åˆ° week03 Go å¹¶å‘ç¼–ç¨‹è¿™ä¸ªç³»åˆ—çš„æ—¶å€™å‘ç°ï¼Œæ‰è¿›å‘é‡Œé¢äº†ï¼Œæ¯›è€å¸ˆè™½ç„¶åªè®²äº†ä¸¤èŠ‚è¯¾ï¼Œå¤§æ¦‚ 7 å°æ—¶å·¦å³ï¼Œä½†æ˜¯å®é™…ä¸Šæ¯ä¸€ä¸ªç‚¹å¦‚æœè¦æ·±å…¥ç†è§£å­¦ä¹ é€è¿˜æ˜¯è¦èŠ±è´¹å¤§é‡æ—¶é—´çš„ã€‚è¿™ä¹Ÿå°±å¯¼è‡´äº†è¿™ä¸€å‘¨çš„è¯¾ç¨‹åŠ ä¸Šæœ¬æ–‡ä¸€å…±è¾“å‡ºäº†åä¸€ç¯‡æ–‡ç« ï¼Œè¶…è¿‡äº† 4W å­—ï¼Œä½†æ˜¯è¿™è¿˜æ²¡ç»“æŸï¼Œè¿˜æœ‰å‡ ä¸ªå¸¸ç”¨çš„æ•°æ®æ•°æ®ç»“æ„æ²¡æœ‰è®²åˆ°ï¼Œä¾‹å¦‚ <code>sync.Map</code>  <code>sync.Pool</code>  ç­‰ï¼Œè¿™äº›ä¼šå†æ¥ä¸‹æ¥ä¸å®šæœŸçš„å»æ›´æ–°ã€‚<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1610684635316-6d61e196-4450-40f7-99d1-0a3b5317b1bb.png" alt="image.png"><br>å†™å®Œè¿™ä¸€ç¯‡æ–‡ç« ä¹‹åèƒ½å¤Ÿå‘ç°ä¹‹å‰å†™çš„ä»£ç å¾ˆå¤šä¸å¤ªåˆç†çš„åœ°æ–¹ï¼Œçœ‹äº†ä¸€åœˆæºç ä¹‹åç°åœ¨ä¹Ÿå¯ä»¥è¯´åœ¨ Go å¹¶å‘ç¼–ç¨‹ä¸Šé¢ç®—æ˜¯å…¥é—¨äº†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¸€èµ·å›é¡¾ä¸€ä¸‹æˆ‘ä»¬ä¹‹å‰æ‰€è®²çš„å†…å®¹ã€‚æˆ‘æŠŠæ–‡ç« ç›®å½•æ”¾åœ¨äº†æœ€åï¼Œå¯åˆ†åˆ«ç‚¹å‡»æŸ¥çœ‹ã€‚</p><h3 id="Goroutine"><a href="#Goroutine" class="headerlink" title="Goroutine"></a>Goroutine</h3><blockquote><p>ç¬¬ä¸€ç¯‡æ–‡ç« ä¸»è¦è®²è§£äº† Goroutine ä½¿ç”¨çš„ç›¸å…³æ³¨æ„äº‹é¡¹ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥è¯´æ˜¯æœ€ä½³å®è·µ</p></blockquote><ol><li><strong>è¯·å°†æ˜¯å¦å¼‚æ­¥è°ƒç”¨çš„é€‰æ‹©æƒäº¤ç»™è°ƒç”¨è€…</strong>ï¼Œä¸ç„¶å¾ˆæœ‰å¯èƒ½å¤§å®¶å¹¶ä¸çŸ¥é“ä½ åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ä½¿ç”¨äº† goroutine</li><li>å¦‚æœä½ è¦å¯åŠ¨ä¸€ä¸ª goroutine è¯·å¯¹å®ƒè´Ÿè´£<ol><li><strong>æ°¸è¿œä¸è¦å¯åŠ¨ä¸€ä¸ªä½ æ— æ³•æ§åˆ¶å®ƒé€€å‡ºï¼Œæˆ–è€…ä½ æ— æ³•çŸ¥é“å®ƒä½•æ—¶æ¨å‡ºçš„ goroutine</strong></li><li>è¿˜æœ‰ä¸Šä¸€ç¯‡æåˆ°çš„ï¼Œå¯åŠ¨ goroutine æ—¶è¯·åŠ ä¸Š panic recovery æœºåˆ¶ï¼Œé¿å…æœåŠ¡ç›´æ¥ä¸å¯ç”¨</li><li>é€ æˆ goroutine æ³„æ¼çš„ä¸»è¦åŸå› å°±æ˜¯ goroutine ä¸­é€ æˆäº†é˜»å¡ï¼Œå¹¶ä¸”æ²¡æœ‰å¤–éƒ¨æ‰‹æ®µæ§åˆ¶å®ƒé€€å‡º</li></ol></li><li><strong>å°½é‡é¿å…åœ¨è¯·æ±‚ä¸­ç›´æ¥å¯åŠ¨ goroutine æ¥å¤„ç†é—®é¢˜</strong>ï¼Œè€Œåº”è¯¥é€šè¿‡å¯åŠ¨ worker æ¥è¿›è¡Œæ¶ˆè´¹ï¼Œè¿™æ ·å¯ä»¥é¿å…ç”±äºè¯·æ±‚é‡è¿‡å¤§ï¼Œè€Œå¯¼è‡´å¤§é‡åˆ›å»º goroutine ä»è€Œå¯¼è‡´ oomï¼Œå½“ç„¶å¦‚æœè¯·æ±‚é‡æœ¬èº«éå¸¸å°ï¼Œé‚£å½“æˆ‘æ²¡è¯´</li></ol><h3 id="Go-å†…å­˜æ¨¡å‹"><a href="#Go-å†…å­˜æ¨¡å‹" class="headerlink" title="Go å†…å­˜æ¨¡å‹"></a>Go å†…å­˜æ¨¡å‹</h3><blockquote><p>ç¬¬äºŒç¯‡æ–‡ç« ä¸»è¦æ˜¯æ ¹æ® Go å®˜æ–¹æ–‡æ¡£ä¸­çš„å†…å­˜æ¨¡å‹è¿›è¡Œé˜è¿°ï¼Œåé¢ä¹Ÿæåˆ°äº†ä¸€äº› CPU å†…å­˜é‡æ’çš„ç›¸å…³çŸ¥è¯†, ä¸»è¦ç›®çš„æ˜¯è®©å¤§å®¶çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ä½¿ç”¨åŒæ­¥åŸè¯­æ¥è¿›è¡Œæ˜¾ç¤ºçš„åŒæ­¥æ§åˆ¶</p></blockquote><ol><li>ç¼–è¯‘å™¨é‡æ’ï¼Œç°ä»£ç¼–è¯‘å™¨ä¸ºäº†èƒ½å¤Ÿè·å–åˆ°æè‡´çš„æ€§èƒ½ï¼Œå¯èƒ½ä¼šåœ¨ç¼–è¯‘æ—¶åšä¸€äº›æŒ‡ä»¤é‡æ’ï¼Œè¿™å°±ä¼šå¯¼è‡´æœ‰ä¸€äº›åœ¨å•çº¿ç¨‹è·‘çš„ç¨‹åºåœ¨å¹¶å‘æ‰§è¡Œæ—¶å‡ºç°ä¸€äº›ä¸å¯é¢„æœŸçš„æ„å¤–æƒ…å†µã€‚</li><li>å†…å­˜é‡æ’ï¼Œç°ä»£ CPU å¤§å¤šéƒ½æ˜¯å¤šæ ¸ CPUï¼ŒCPU ä¸ºäº†æé«˜æ€§èƒ½ä¼šåœ¨æ¯ä¸ªæ ¸å¿ƒä¸‹è®¾æœ‰ç¼“å­˜ï¼Œç°åœ¨ä¸€èˆ¬æ˜¯æœ‰ä¸‰çº§ç¼“å­˜ï¼Œå…¶ä¸­ä¸€äºŒçº§æ˜¯ CPU ç‹¬æœ‰çš„ï¼Œè¿™å°±å¯èƒ½ä¼šå­˜åœ¨åœ¨å¹¶å‘æ‰§è¡Œæ—¶ï¼Œå¤šä¸ª Goroutine åœ¨ä¸åŒçš„ CPU ä¸Šæ‰§è¡Œçœ‹åˆ°çš„å˜é‡æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µå‘ç”Ÿã€‚</li><li>hanppens beforeï¼Œå¦‚æœ <code>e1</code> å‘ç”Ÿåœ¨ <code>e2</code> ä¹‹å‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯´ <code>e2</code> å‘ç”Ÿåœ¨ <code>e1</code> ä¹‹åï¼Œå¦‚æœ <code>e1</code> æ—¢ä¸åœ¨ <code>e2</code> å‰ï¼Œä¹Ÿä¸åœ¨ <code>e2</code> ä¹‹åï¼Œé‚£æˆ‘ä»¬å°±è¯´è¿™ä¿©æ˜¯å¹¶å‘çš„</li><li>æœºå™¨å­—ï¼Œå¯¹å¤§äºå•ä¸ªæœºå™¨å­—çš„å€¼è¿›è¡Œè¯»å–å’Œå†™å…¥ï¼Œå…¶è¡¨ç°å¦‚åŒä»¥ä¸ç¡®å®šçš„é¡ºåºå¯¹å¤šä¸ªæœºå™¨å­—å¤§å°çš„å€¼è¿›è¡Œæ“ä½œ<ol><li>æˆ‘ä»¬ç°åœ¨å¸¸è§çš„è¿˜æœ‰ 32 ä½ç³»ç»Ÿå’Œ 64 ä½çš„ç³»ç»Ÿï¼Œcpu åœ¨æ‰§è¡Œä¸€æ¡æŒ‡ä»¤çš„æ—¶å€™å¯¹äºå•ä¸ªæœºå™¨å­—é•¿çš„çš„æ•°æ®çš„å†™å…¥å¯ä»¥ä¿è¯æ˜¯åŸå­çš„ï¼Œå¯¹äº 32 ä½çš„å°±æ˜¯ 4 ä¸ªå­—èŠ‚ï¼Œå¯¹äº 64 ä½çš„å°±æ˜¯ 8 ä¸ªå­—èŠ‚ï¼Œå¯¹äºåœ¨ 32 ä½æƒ…å†µä¸‹å»å†™å…¥ä¸€ä¸ª 8 å­—èŠ‚çš„æ•°æ®æ—¶å°±éœ€è¦æ‰§è¡Œä¸¤æ¬¡å†™å…¥æ“ä½œï¼Œè¿™ä¸¤æ¬¡æ“ä½œä¹‹é—´å°±æ²¡æœ‰åŸå­æ€§ï¼Œé‚£å°±å¯èƒ½å‡ºç°å…ˆå†™å…¥ååŠéƒ¨åˆ†çš„æ•°æ®å†å†™å…¥å‰åŠéƒ¨åˆ†ï¼Œæˆ–è€…æ˜¯å†™å…¥äº†ä¸€åŠæ•°æ®ç„¶åå†™å…¥å¤±è´¥çš„æƒ…å†µã€‚</li><li>è¿™ä¹Ÿæ˜¯åé¢æˆ‘ä»¬å»çœ‹æºç çš„æ—¶å€™å¾ˆå¤šæƒ…å†µä¸‹ä¼šå»åš 8 å­—èŠ‚çš„å¯¹é½çš„åŸå› </li></ol></li><li>initï¼Œè‹¥åŒ… p å¯¼å…¥äº†åŒ… qï¼Œåˆ™ q çš„ init å‡½æ•°ä¼šåœ¨ p çš„ä»»ä½•å‡½æ•°å¯åŠ¨å‰å®Œæˆï¼Œå‡½æ•° main.main ä¼šåœ¨æ‰€æœ‰çš„ init å‡½æ•°ç»“æŸåå¯åŠ¨ã€‚<ol><li>ä¸å»ºè®®åœ¨ç”Ÿäº§åº”ç”¨ä¾èµ–è¿™ä¸ªéšå¼çš„é¡ºåº</li></ol></li><li><code>go</code> è¯­å¥ä¼šåœ¨å½“å‰ goroutine å¼€å§‹æ‰§è¡Œå‰å¯åŠ¨æ–°çš„ goroutine</li><li>goroutine æ— æ³•ç¡®ä¿åœ¨ç¨‹åºä¸­çš„ä»»ä½•äº‹ä»¶å‘ç”Ÿä¹‹å‰é€€å‡º</li><li>è§£å†³è¿™äº›é—®é¢˜çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨æ˜¾ç¤ºçš„åŒæ­¥</li></ol><h3 id="data-race"><a href="#data-race" class="headerlink" title="data race"></a>data race</h3><blockquote><p>åœ¨äº†è§£äº†å¹¶å‘ç¼–ç¨‹çš„æ—¶å€™ä¸ºä»€ä¹ˆéœ€è¦æ˜¾ç¤ºçš„åŒæ­¥åï¼Œè¿™ä¸€ç¯‡æ–‡ç« è®²è¿°äº†æˆ‘ä»¬å¦‚ä½•å»å‘ç°å­˜åœ¨å¹¶å‘é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æ•°æ®ç«äº‰çš„æƒ…å†µ</p></blockquote><ol><li>åœ¨ç¼–è¯‘å’Œè¿è¡Œå•å…ƒæµ‹è¯•æ—¶åŠ ä¸Š <code>-race</code> flag å°±å¯ä»¥å¼€å¯ data race çš„æ£€æµ‹<ol><li>ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒ build çš„æ—¶å€™å¼€å¯æ•°æ®ç«äº‰æ£€æµ‹ï¼Œå› ä¸ºè¿™ä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½æŸå¤±(ä¸€èˆ¬å†…å­˜ 5-10 å€ï¼Œæ‰§è¡Œæ—¶é—´ 2-20 å€)ï¼Œå½“ç„¶   å¿…é¡»è¦ debug çš„æ—¶å€™é™¤å¤–ã€‚</li><li>å»ºè®®åœ¨æ‰§è¡Œå•å…ƒæµ‹è¯•æ—¶å§‹ç»ˆå¼€å¯æ•°æ®ç«äº‰çš„æ£€æµ‹ã€‚</li></ol></li><li>æ€»å…±è®²è§£å…­ä¸ªæ¡ˆä¾‹æ¥è¯´æ˜å“ªäº›åœºæ™¯ä¸‹å¯èƒ½ä¼šå‡ºç°æ•°æ®ç«äº‰ï¼Œå¯ä»¥æŸ¥çœ‹åŸæ–‡äº†è§£</li></ol><h3 id="mutex-äº’æ–¥é”"><a href="#mutex-äº’æ–¥é”" class="headerlink" title="mutex äº’æ–¥é”"></a>mutex äº’æ–¥é”</h3><blockquote><p>åœ¨äº†è§£äº†ä¸ºä»€ä¹ˆè¦ç”¨åŒæ­¥åŸè¯­ï¼Œä»¥åŠçŸ¥é“å¦‚ä½•å‘ç°å¹¶å‘é—®é¢˜ä¹‹åï¼Œæˆ‘ä»¬å°±å¼€å§‹ä¾æ¬¡è®²è§£ç›¸å…³çš„åŒæ­¥åŸè¯­ï¼Œç¬¬ä¸€ç¯‡å°±æ˜¯ mutex</p></blockquote><ol><li>é¦–å…ˆé€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹å¼•å…¥è¯´æ˜äº†é”çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œå¹¶ä¸”äº†è§£äº†äº’æ–¥é”çš„ä½¿ç”¨åŸåˆ™ï¼ŒèŒƒå›´å°½é‡å°ï¼Œä¸€å®šè¦è§£é”å¹¶ä¸”æ³¨æ„é¡ºåºï¼Œå°å¿ƒæ­»é”ã€‚</li><li>ç„¶åè®²äº†äº’æ–¥é”çš„å®ç°åŸç†ï¼Œä¸‰ç§æ¨¡å¼<ol><li>Barging: è¿™ç§æ¨¡å¼æ˜¯ä¸ºäº†æé«˜ååé‡ï¼Œå½“é”è¢«é‡Šæ”¾æ—¶ï¼Œå®ƒä¼šå”¤é†’ç¬¬ä¸€ä¸ªç­‰å¾…è€…ï¼Œç„¶åæŠŠé”ç»™ç¬¬ä¸€ä¸ªç­‰å¾…è€…æˆ–è€…ç»™ç¬¬ä¸€ä¸ªè¯·æ±‚é”çš„äºº</li><li>Handoff: å½“é”é‡Šæ”¾æ—¶å€™ï¼Œé”ä¼šä¸€ç›´æŒæœ‰ç›´åˆ°ç¬¬ä¸€ä¸ªç­‰å¾…è€…å‡†å¤‡å¥½è·å–é”ã€‚å®ƒé™ä½äº†ååé‡ï¼Œå› ä¸ºé”è¢«æŒæœ‰ï¼Œå³ä½¿å¦ä¸€ä¸ª goroutine å‡†å¤‡è·å–å®ƒã€‚</li><li>Spiningï¼šè‡ªæ—‹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…åº”ç”¨ç¨‹åºé‡åº¦ä½¿ç”¨é”æ—¶æ•ˆæœä¸é”™ã€‚Parking å’Œ Unparking goroutines æœ‰ä¸ä½çš„æ€§èƒ½æˆæœ¬å¼€é”€ï¼Œç›¸æ¯”è‡ªæ—‹æ¥è¯´è¦æ…¢å¾—å¤šã€‚</li></ol></li><li>ç„¶åæˆ‘ä»¬æŸ¥çœ‹åˆ†ææºç äº†è§£äº†äº’æ–¥é”å’Œè¯»å†™é”çš„å…·ä½“å®ç°ã€‚åœ¨ 1.9 ä¹‹åç»“åˆä¸Šé¢çš„ä¸‰ç§æ–¹å¼ï¼Œè¿™ä¸€éƒ¨åˆ†çš„å†…å®¹æ¯”è¾ƒå¤šå»ºè®®ä»”ç»†é˜…è¯»åŸæ–‡</li></ol><h3 id="sync-atomic"><a href="#sync-atomic" class="headerlink" title="sync/atomic"></a>sync/atomic</h3><blockquote><p>äº’æ–¥é”å…¶å®å°±æ˜¯å¤§é‡ä½¿ç”¨äº† atomic æ¥å®ç°çš„ï¼Œæ‰€ä»¥ç´§æ¥ç€æˆ‘ä»¬å°±æ¥çœ‹äº† atomic åŒ…çš„ç›¸å…³å®ç°</p></blockquote><ol><li>é¦–å…ˆé€šè¿‡é…ç½®çƒ­æ›´æ–°çš„æ¡ˆä¾‹å¼•å…¥ï¼Œæåˆ°äº† atomic.Value çš„ç›¸å…³ä½¿ç”¨æ–¹æ³•</li><li>ç„¶ååˆ†åˆ«ä»‹ç»äº† atomic åŒ…ä¸­çš„å„ç±»æ–¹æ³•çš„ç”¨é€”ï¼Œ <code>AddXXX</code>  ç­‰</li><li>è¯¦ç»†è®²è§£äº† CAS çš„çš„å®ç°åŸç†ï¼Œä¸»è¦æ˜¯åœ¨è½¬æ¢ä¸ºæ±‡ç¼–çš„æ—¶å€™ä½¿ç”¨çœ‹ <code>LOCK</code>  æŒ‡ä»¤ï¼Œç„¶åé€šè¿‡æŸ¥é˜… Intel æ‰‹å†Œæˆ‘ä»¬çŸ¥é“äº†<ol><li>å¯¹äº P6 ä¹‹å‰çš„å¤„ç†å™¨ï¼ŒLOCK æŒ‡ä»¤ä¼šæ€»æ˜¯é”æ€»çº¿ï¼Œä½†æ˜¯ P6 ä¹‹åå¯èƒ½ä¼šæ‰§è¡Œâ€œç¼“å­˜é”å®šâ€ï¼Œå¦‚æœè¢«é”å®šçš„å†…å­˜åŒºåŸŸè¢«ç¼“å­˜åœ¨äº†å¤„ç†å™¨ä¸­ï¼Œè¿™ä¸ªæ—¶å€™ä¼šé€šè¿‡ç¼“å­˜ä¸€è‡´æ€§æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§</li></ol></li><li>ç„¶åè¯¦ç»†åˆ†æäº† atomic.Value çš„å®ç°æºç ï¼Œå¹¶ä¸”åˆ©ç”¨ atomic å®ç°äº†ä¸€ä¸ªæ— é”æ ˆ</li></ol><h3 id="sync-WaitGroup"><a href="#sync-WaitGroup" class="headerlink" title="sync.WaitGroup"></a>sync.WaitGroup</h3><blockquote><p>åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­ä¸æ­¢ä¸€æ¬¡å‡ºç°äº† waitgroup çš„èº«å½±ï¼Œè¿™ç¯‡æ–‡ç« æ·±å…¥åˆ†æäº† waitgroup çš„å®ç°</p></blockquote><ul><li><code>WaitGroup</code> å¯ä»¥ç”¨äºä¸€ä¸ª goroutine ç­‰å¾…å¤šä¸ª goroutine å¹²æ´»å®Œæˆï¼Œä¹Ÿå¯ä»¥å¤šä¸ª goroutine ç­‰å¾…ä¸€ä¸ª goroutine å¹²æ´»å®Œæˆï¼Œæ˜¯ä¸€ä¸ªå¤šå¯¹å¤šçš„å…³ç³»<ul><li>å¤šä¸ªç­‰å¾…ä¸€ä¸ªçš„å…¸å‹æ¡ˆä¾‹æ˜¯ <a href="https://pkg.go.dev/golang.org/x/sync/singleflight">singleflight</a>ï¼Œè¿™ä¸ªåœ¨åé¢å°†å¾®æœåŠ¡å¯ç”¨æ€§çš„æ—¶å€™è¿˜ä¼šå†è®²åˆ°ï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹çœ‹æºç </li></ul></li><li><code>Add(n&gt;0)</code> æ–¹æ³•åº”è¯¥åœ¨å¯åŠ¨ goroutine ä¹‹å‰è°ƒç”¨ï¼Œç„¶ååœ¨ goroution å†…éƒ¨è°ƒç”¨ <code>Done</code> æ–¹æ³•</li><li><code>WaitGroup</code> å¿…é¡»åœ¨ <code>Wait</code> æ–¹æ³•è¿”å›ä¹‹åæ‰èƒ½å†æ¬¡ä½¿ç”¨</li><li><code>Done</code> åªæ˜¯ <code>Add</code> çš„ç®€å•å°è£…ï¼Œæ‰€ä»¥å®é™…ä¸Šæ˜¯å¯ä»¥é€šè¿‡ä¸€æ¬¡åŠ ä¸€ä¸ªæ¯”è¾ƒå¤§çš„å€¼å‡å°‘è°ƒç”¨ï¼Œæˆ–è€…è¾¾åˆ°å¿«é€Ÿå”¤é†’çš„ç›®çš„ã€‚</li><li><code>WaitGroup</code>  ä¸­å…³äº 32 ä½å’Œ 64 ä½æœºå™¨çš„å¤„ç†éå¸¸å·§å¦™ï¼Œå€¼å¾—å­¦ä¹ </li></ul><h3 id="errgroup"><a href="#errgroup" class="headerlink" title="errgroup"></a>errgroup</h3><blockquote><p>WaitGroup å­¦ä¹ å®Œäº†æˆ‘ä»¬ç´§æ¥ç€å°±å­¦ä¹ äº† errgroupï¼Œå› ä¸ºç›¸å¯¹äº WaitGroup errgroup åœ¨æŸäº›åœºæ™¯ä¸‹æ›´åŠ å®ç”¨</p></blockquote><ul><li>é¦–å…ˆè¯´æ˜äº† errgroup å¸¸ç”¨çš„ä½¿ç”¨åœºæ™¯<ul><li>è™½ç„¶ WaitGroup å·²ç»å¸®æˆ‘ä»¬åšäº†å¾ˆå¥½çš„å°è£…ï¼Œä½†æ˜¯ä»ç„¶å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚å¦‚æœéœ€è¦è¿”å›é”™è¯¯ï¼Œæˆ–è€…åªè¦ä¸€ä¸ª goroutine å‡ºé”™æˆ‘ä»¬å°±ä¸å†ç­‰å…¶ä»– goroutine äº†ï¼Œå‡å°‘èµ„æºæµªè´¹ï¼Œ</li></ul></li><li>ç„¶ååˆ†æäº† errgroup çš„æºç ï¼Œæºç éå¸¸ç®€ç­”ä½†æ˜¯åŠŸèƒ½å´å¾ˆå®ç”¨<ul><li>æ³¨æ„æœ‰ä¸€ä¸ªå‘ï¼Œåœ¨åé¢çš„ä»£ç ä¸­ä¸è¦æŠŠè¿™ä¸ª ctx å½“åšçˆ¶ context åˆä¼ ç»™ä¸‹æ¸¸ï¼Œå› ä¸º errgroup å–æ¶ˆäº†ï¼Œè¿™ä¸ª context å°±æ²¡ç”¨äº†ï¼Œä¼šå¯¼è‡´ä¸‹æ¸¸å¤ç”¨çš„æ—¶å€™å‡ºé”™</li></ul></li><li>ç„¶åç”¨ week3 çš„ä½œä¸šä½œä¸ºæ¡ˆä¾‹<ul><li>åŸºäº errgroup å®ç°ä¸€ä¸ª http server çš„å¯åŠ¨å’Œå…³é—­ ï¼Œä»¥åŠ linux signal ä¿¡å·çš„æ³¨å†Œå’Œå¤„ç†ï¼Œè¦ä¿è¯èƒ½å¤Ÿ ä¸€ä¸ªé€€å‡ºï¼Œå…¨éƒ¨æ³¨é”€é€€å‡ºã€‚</li></ul></li></ul><h3 id="sync-Once"><a href="#sync-Once" class="headerlink" title="sync.Once"></a>sync.Once</h3><blockquote><p>è¿™ç¯‡æ–‡ç« ä¸»è¦è®²è§£äº† sync.once çš„ä½¿ç”¨å’Œå®ç°</p></blockquote><ul><li>Once ä¿è¯äº†ä¼ å…¥çš„å‡½æ•°åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œè¿™å¸¸ç”¨åœ¨å•ä¾‹æ¨¡å¼ï¼Œé…ç½®æ–‡ä»¶åŠ è½½ï¼Œåˆå§‹åŒ–è¿™äº›åœºæ™¯ä¸‹</li><li>ä½†æ˜¯éœ€è¦æ³¨æ„ã€‚Once æ˜¯ä¸èƒ½å¤ç”¨çš„ï¼Œåªè¦æ‰§è¡Œè¿‡äº†ï¼Œå†ä¼ å…¥å…¶ä»–çš„æ–¹æ³•ä¹Ÿä¸ä¼šå†æ‰§è¡Œäº†</li><li>å¹¶ä¸” Once.Do åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å¦‚æœ f å‡ºç° panicï¼Œåé¢ä¹Ÿä¸ä¼šå†æ‰§è¡Œäº†</li></ul><h3 id="context"><a href="#context" class="headerlink" title="context"></a>context</h3><blockquote><p>è¿™ç¯‡æ–‡ç« è®²è§£çš„æ¯”è¾ƒç»†è‡´ï¼Œä»æºç åˆ†æï¼Œåˆ°ä½¿ç”¨å‡†åˆ™å’Œåœºæ™¯ä»¥åŠå­˜åœ¨çš„ç¼ºç‚¹éƒ½è®²åˆ°äº†</p></blockquote><h4 id="ä½¿ç”¨å‡†åˆ™"><a href="#ä½¿ç”¨å‡†åˆ™" class="headerlink" title="ä½¿ç”¨å‡†åˆ™"></a>ä½¿ç”¨å‡†åˆ™</h4><p>context åŒ…ä¸€å¼€å§‹å°±å‘Šè¯‰äº†æˆ‘ä»¬åº”è¯¥æ€ä¹ˆç”¨ï¼Œä¸åº”è¯¥æ€ä¹ˆç”¨ï¼Œè¿™æ˜¯åº”è¯¥è¢«å…±åŒéµå®ˆçš„çº¦å®šã€‚</p><ul><li>å¯¹ server åº”ç”¨è€Œè¨€ï¼Œä¼ å…¥çš„è¯·æ±‚åº”è¯¥åˆ›å»ºä¸€ä¸ª contextï¼Œæ¥å—</li><li>é€šè¿‡ <code>WithCancel</code> , <code>WithDeadline</code> , <code>WithTimeout</code> åˆ›å»ºçš„ Context ä¼šåŒæ—¶è¿”å›ä¸€ä¸ª cancel æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¿…é¡»è¦è¢«æ‰§è¡Œï¼Œä¸ç„¶ä¼šå¯¼è‡´ context æ³„æ¼ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡æ‰§è¡Œ <code>go vet</code> å‘½ä»¤è¿›è¡Œæ£€æŸ¥</li><li>åº”è¯¥å°† <code>context.Context</code> ä½œä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œä¼ é€’ï¼Œå‚æ•°å‘½åä¸€èˆ¬ä¸º <code>ctx</code> ä¸åº”è¯¥å°† Context ä½œä¸ºå­—æ®µæ”¾åœ¨ç»“æ„ä½“ä¸­ã€‚</li><li>ä¸è¦ç»™ context ä¼ é€’ nilï¼Œå¦‚æœä½ ä¸çŸ¥é“åº”è¯¥ä¼ ä»€ä¹ˆçš„æ—¶å€™å°±ä¼ é€’ <code>context.TODO()</code></li><li>ä¸è¦å°†å‡½æ•°çš„å¯é€‰å‚æ•°æ”¾åœ¨ context å½“ä¸­ï¼Œcontext ä¸­ä¸€èˆ¬åªæ”¾ä¸€äº›å…¨å±€é€šç”¨çš„ metadata æ•°æ®ï¼Œä¾‹å¦‚ tracing id ç­‰ç­‰</li><li>context æ˜¯å¹¶å‘å®‰å…¨çš„å¯ä»¥åœ¨å¤šä¸ª goroutine ä¸­å¹¶å‘è°ƒç”¨</li></ul><h4 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h4><ul><li>è¶…æ—¶æ§åˆ¶</li><li>é”™è¯¯å–æ¶ˆ</li><li>è·¨ goroutine æ•°æ®åŒæ­¥</li><li>é˜²æ­¢ goroutine æ³„æ¼</li></ul><h4 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><ul><li>æœ€æ˜¾è‘—çš„ä¸€ä¸ªå°±æ˜¯ context å¼•å…¥éœ€è¦ä¿®æ”¹å‡½æ•°ç­¾åï¼Œå¹¶ä¸”ä¼šç—…æ¯’çš„å¼çš„æ‰©æ•£åˆ°æ¯ä¸ªå‡½æ•°ä¸Šé¢ï¼Œä¸è¿‡è¿™ä¸ªè§ä»è§æ™ºï¼Œæˆ‘çœ‹ç€å…¶å®è¿˜å¥½</li><li>æŸäº›æƒ…å†µä¸‹è™½ç„¶æ˜¯å¯ä»¥åšåˆ°è¶…æ—¶è¿”å›æé«˜ç”¨æˆ·ä½“éªŒï¼Œä½†æ˜¯å®é™…ä¸Šæ˜¯ä¸ä¼šé€€å‡ºç›¸å…³ goroutine çš„ï¼Œè¿™æ—¶å€™å¯èƒ½ä¼šå¯¼è‡´ goroutine çš„æ³„æ¼ï¼Œé’ˆå¯¹è¿™ä¸ªæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­</li></ul><h3 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h3><blockquote><p>è¿™ç¯‡æ–‡ç« ä»èµ„æ–™æ”¶é›†ï¼Œåˆ°æºç é˜…è¯»å†åˆ°æœ€ç»ˆæˆæ–‡èŠ±äº†å¿«åŠä¸ªæœˆçš„æ—¶é—´ï¼Œä¸è¿‡å†™å®Œä¹‹åå°±æˆ‘ä¸ªäººè€Œè¨€æ˜¯æ”¶è·æ»¡æ»¡çš„ï¼Œä¸çŸ¥åˆ°èƒ½ä¸èƒ½ä¸ºå±å¹•å‰çš„ä½ å¸¦æ¥ä¸€ç‚¹ç‚¹å¯å‘ï¼Œå¦‚æœå¯ä»¥é‚£å°±å¤ªèµäº†ã€‚è¿™ç¯‡æ–‡ç« ä»æœ€å¼€å§‹çš„ç†è®º csp/actor åˆ° hanpens before å†åˆ° channel çš„åŸºæœ¬ç”¨æ³•ï¼Œæºç å®ç°ï¼Œæœ€åè®²åˆ°äº†ä¸€äº›ä½¿ç”¨åœºæ™¯ï¼Œä½†æ˜¯ç”±äºé•¿åº¦ç²¾åŠ›è¿˜æ˜¯ä¸ªäººæ°´å¹³ç­‰å¤šç§é™åˆ¶æœ‰çš„åœ°æ–¹è®²è§£è¿˜æ˜¯ä¸å¤Ÿç»†è‡´ï¼Œå…·ä½“å¼ºçƒˆå»ºè®®é˜…è¯»ä¸€äº›å‚è€ƒæ–‡çŒ®é‡Œé¢çš„åå‡ ç¯‡æ–‡ç« ï¼Œæ¯ä¸€ä¸ªéƒ½å€¼å¾—ç»†ç»†å“å‘³ã€‚</p></blockquote><ul><li>ä» <strong>â€œä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨é€šä¿¡æ¥å…±äº«å†…å­˜â€</strong> å‡ºå‘å…ˆæ¢è®¨äº†ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦è¿™ä¹ˆåš</li><li>åœ¨å›åˆ°äº†æœ€å¼€å§‹çš„ Go å†…å­˜æ¨¡å‹ç« èŠ‚æ•…æ„æ²¡æœ‰è®²è§£çš„éƒ¨åˆ†</li><li>ä»åŸç†åˆ°ä½¿ç”¨ï¼Œè¯´æ˜äº† channel çš„åŸºæœ¬ç”¨æ³•</li><li>ç„¶åè¯¦ç»†åˆ†æäº†ç›¸å…³æºä»£ç ï¼šå®è´¨ä¸Šåº•å±‚æ˜¯ä¸€ä¸ªå¾ªç¯é˜Ÿåˆ—<ul><li>æ•°æ®ç»“æ„</li><li>å¦‚ä½•åˆ›å»º</li><li>å‘é€æ•°æ®</li><li>æ¥æ”¶æ•°æ®</li></ul></li><li>ç„¶åè®²åˆ°äº†å‡ ä¸ªå¸¸ç”¨çš„åœºæ™¯<ul><li>é€šè¿‡å…³é—­ channel å®ç°ä¸€å¯¹å¤šçš„é€šçŸ¥</li><li>ä½¿ç”¨ channel åšå¼‚æ­¥ç¼–ç¨‹(future/promise)</li><li>è¶…æ—¶æ§åˆ¶</li></ul></li></ul><h2 id="Go-å¹¶å‘ç¼–ç¨‹æ–‡ç« ç´¢å¼•"><a href="#Go-å¹¶å‘ç¼–ç¨‹æ–‡ç« ç´¢å¼•" class="headerlink" title="Go å¹¶å‘ç¼–ç¨‹æ–‡ç« ç´¢å¼•"></a>Go å¹¶å‘ç¼–ç¨‹æ–‡ç« ç´¢å¼•</h2><p>æˆ‘å°†æœ¬ç³»åˆ—çš„æ‰€æœ‰æ–‡ç« åœ°å€éƒ½æ”¾åœ¨è¿™é‡Œï¼Œæ„Ÿå…´è¶£å¯ä»¥ç‚¹å‡»é“¾æ¥æŸ¥çœ‹æ–‡ç« è¯¦æƒ…</p><ol><li><a href="https://lailin.xyz/post/go-training-week3-sum.html">Week03: Go å¹¶å‘ç¼–ç¨‹(åä¸€) æ€»ç»“</a></li><li><a href="https://lailin.xyz/post/go-training-week3-channel.html">Week03: Go å¹¶å‘ç¼–ç¨‹(å) æ·±å…¥ç†è§£ Channel - Mohuishou</a></li><li><a href="https://lailin.xyz/post/go-training-week3-context.html">Week03: Go å¹¶å‘ç¼–ç¨‹(ä¹) æ·±å…¥ç†è§£ Context - Mohuishou</a></li><li><a href="https://lailin.xyz/post/go-training-week3-once.html">Week03: Go å¹¶å‘ç¼–ç¨‹(å…«) æ·±å…¥ç†è§£ sync.Once - Mohuishou</a></li><li><a href="https://lailin.xyz/post/go-training-week3-errgroup.html">Week03: Go å¹¶å‘ç¼–ç¨‹(ä¸ƒ) æ·±å…¥ç†è§£ errgroup - Mohuishou</a></li><li><a href="https://lailin.xyz/post/go-training-week3-waitgroup.html">Week03: Go å¹¶å‘ç¼–ç¨‹(å…­) æ·±å…¥ç†è§£ WaitGroup - Mohuishou</a></li><li><a href="https://lailin.xyz/post/go-training-week3-atomic.html">Week03: Go å¹¶å‘ç¼–ç¨‹(äº”) æ·±å…¥ç†è§£ sync/atomic - Mohuishou</a></li><li><a href="https://lailin.xyz/post/go-training-week3-sync.html">Week03: Go å¹¶å‘ç¼–ç¨‹(å››) æ·±å…¥ç†è§£ Mutex - Mohuishou</a></li><li><a href="https://lailin.xyz/post/go-training-week3-data-race.html">Week03: Go å¹¶å‘ç¼–ç¨‹(ä¸‰) data race - Mohuishou</a></li><li><a href="https://lailin.xyz/post/go-training-week3-go-memory-model.html">Week03: Go å¹¶å‘ç¼–ç¨‹(äºŒ) Go å†…å­˜æ¨¡å‹ - Mohuishou</a></li><li><a href="https://lailin.xyz/post/go-training-week3-goroutine.html">Week03: Go å¹¶å‘ç¼–ç¨‹(ä¸€) goroutine - Mohuishou</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week03: Go å¹¶å‘ç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¹¶å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¹¶å‘ç¼–ç¨‹(å) æ·±å…¥ç†è§£ Channel</title>
    <link href="/post/go-training-week3-channel.html"/>
    <url>/post/go-training-week3-channel.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h2><h3 id="ä½¿ç”¨é€šä¿¡å…±äº«å†…å­˜"><a href="#ä½¿ç”¨é€šä¿¡å…±äº«å†…å­˜" class="headerlink" title="ä½¿ç”¨é€šä¿¡å…±äº«å†…å­˜"></a>ä½¿ç”¨é€šä¿¡å…±äº«å†…å­˜</h3><p><strong>â€œä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨é€šä¿¡æ¥å…±äº«å†…å­˜â€</strong> è¿™å¥è¯æƒ³å¿…å¤§å®¶å·²ç»éå¸¸ç†Ÿæ‚‰äº†ï¼Œåœ¨å®˜æ–¹çš„åšå®¢ï¼Œåˆå­¦æ—¶çš„æ•™ç¨‹ï¼Œç”šè‡³æ˜¯åœ¨ Go çš„æºç ä¸­éƒ½èƒ½çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¹‹å‰è®² sync åŒ…çš„æ—¶å€™ä¹Ÿæœ‰æåˆ°è¿‡ã€‚</p><p>æ— è®ºæ˜¯é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡è¿˜æ˜¯é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ï¼Œæœ€ç»ˆæˆ‘ä»¬åº”ç”¨ç¨‹åºéƒ½æ˜¯è¯»å–çš„å†…å­˜å½“ä¸­çš„æ•°æ®ï¼Œåªæ˜¯å‰è€…æ˜¯ç›´æ¥è¯»å–å†…å­˜çš„æ•°æ®ï¼Œè€Œåè€…æ˜¯é€šè¿‡å‘é€æ¶ˆæ¯çš„æ–¹å¼æ¥è¿›è¡ŒåŒæ­¥ã€‚è€Œé€šè¿‡å‘é€æ¶ˆæ¯æ¥åŒæ­¥çš„è¿™ç§æ–¹å¼å¸¸è§çš„å°±æ˜¯ Go é‡‡ç”¨çš„ CSP(Communication Sequential Process) æ¨¡å‹ä»¥åŠ Erlang é‡‡ç”¨çš„ Actor æ¨¡å‹ï¼Œè¿™ä¸¤ç§æ–¹å¼éƒ½æ˜¯é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ã€‚<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1610460699237-f6400aaa-34d5-4c8d-b323-27683704abd2.png" alt="02_Goè¿›é˜¶03_blog_channel.png"><br>å¤§éƒ¨åˆ†çš„è¯­è¨€é‡‡ç”¨çš„éƒ½æ˜¯ç¬¬ä¸€ç§æ–¹å¼ç›´æ¥å»æ“ä½œå†…å­˜ï¼Œç„¶åé€šè¿‡äº’æ–¥é”ï¼ŒCAS ç­‰æ“ä½œæ¥ä¿è¯å¹¶å‘å®‰å…¨ã€‚Go å¼•å…¥äº† Channel å’Œ Goroutine å®ç° CSP æ¨¡å‹æ¥è§£è€¦è¿™ä¸ªæ“ä½œï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯åœ¨ Goroutine å½“ä¸­æˆ‘ä»¬å°±ä¸ç”¨æ‰‹åŠ¨å»åšèµ„æºçš„é”å®šä¸é‡Šæ”¾ï¼ŒåŒæ—¶å°†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è¿›è¡Œäº†è§£è€¦ï¼ŒChannel å…¶å®å’Œæ¶ˆæ¯é˜Ÿåˆ—å¾ˆç›¸ä¼¼ã€‚è€Œ Actor æ¨¡å‹å’Œ CSP æ¨¡å‹éƒ½æ˜¯é€šè¿‡å‘é€æ¶ˆæ¯æ¥å…±äº«å†…å­˜ï¼Œä½†æ˜¯å®ƒä»¬ä¹‹é—´æœ€å¤§çš„åŒºåˆ«å°±æ˜¯ Actor æ¨¡å‹å½“ä¸­å¹¶æ²¡æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ Channel ç»„ä»¶ï¼Œè€Œæ˜¯ Actor ä¸ Actor ä¹‹é—´ç›´æ¥è¿›è¡Œæ¶ˆæ¯çš„å‘é€ä¸æ¥æ”¶ï¼Œæ¯ä¸ª Actor éƒ½æœ‰ä¸€ä¸ªæœ¬åœ°çš„â€œä¿¡ç®±â€æ¶ˆæ¯éƒ½ä¼šå…ˆå‘é€åˆ°è¿™ä¸ªâ€œä¿¡ç®±å½“ä¸­â€ã€‚</p><p><strong>å°ç»“</strong></p><ul><li>ç›¸å¯¹äºäº’æ–¥é”ï¼ŒåŸå­æ“ä½œè€Œè¨€ channel æ˜¯ä¸€ä¸ªæ›´é«˜å±‚çº§çš„æŠ½è±¡ï¼Œä½¿ç”¨ channel ä¼šæ›´åŠ æ–¹ä¾¿ï¼Œå¿ƒæ™ºæˆæœ¬ä¹Ÿæ›´ä½ï¼ŒåŒæ—¶ä¹Ÿæ›´ä¸å®¹æ˜“å‡ºé”™ï¼ˆchannel ä¿è¯äº†å¹¶å‘å®‰å…¨ï¼‰ï¼Œåé¢å°±ä¼šè®²åˆ°ï¼Œç”±äº Channel åº•å±‚ä¹Ÿæ˜¯é€šè¿‡è¿™äº›ä½çº§çš„åŒæ­¥åŸè¯­å®ç°çš„ï¼Œæ‰€ä»¥æ€§èƒ½ä¸Šä¼šå·®ä¸€äº›ï¼Œå¦‚æœæœ‰æé«˜çš„æ€§èƒ½è¦æ±‚æ—¶ä¹Ÿå¯ä»¥ç”¨ sync åŒ…ä¸­æä¾›çš„ä½çº§åŒæ­¥åŸè¯­</li><li>ä½¿ç”¨ channel å¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œå¯ä»¥é™ä½å¹¶å‘å½“ä¸­çš„è€¦åˆ</li></ul><h3 id="happens-before"><a href="#happens-before" class="headerlink" title="happens before"></a>happens before</h3><p>åœ¨ <a href="https://lailin.xyz/post/go-training-week3-go-memory-model.html">Week03: Go å¹¶å‘ç¼–ç¨‹(äºŒ) Go å†…å­˜æ¨¡å‹</a> è¿™ç¯‡æ–‡ç« å½“ä¸­è®²åˆ°åŒæ­¥çš„æ—¶å€™ï¼ŒChannel ç›¸å…³éƒ¨åˆ†æˆ‘ä»¬ç‰¹æ„ç•¥è¿‡äº†ï¼Œåœ¨åé¢ channel éƒ¨åˆ†æˆ‘ä»¬å°±ä¼šè¯¦ç»†çš„è®²åˆ° channel çš„ä½¿ç”¨ä»¥åŠæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œè¿™é‡Œå…ˆå›é¡¾ä¸€ä¸‹ happens before ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œè¯¦ç»†å¯ä»¥çœ‹ä¹‹å‰çš„é‚£ç¯‡æ–‡ç« ã€‚</p><p><strong>happens before å®šä¹‰: </strong>å¦‚æœ <code>e1</code> å‘ç”Ÿåœ¨ <code>e2</code> ä¹‹å‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯´ <code>e2</code> å‘ç”Ÿåœ¨ <code>e1</code> ä¹‹åï¼Œå¦‚æœ <code>e1</code> æ—¢ä¸åœ¨ <code>e2</code> å‰ï¼Œä¹Ÿä¸åœ¨ <code>e2</code> ä¹‹åï¼Œé‚£æˆ‘ä»¬å°±è¯´è¿™ä¿©æ˜¯å¹¶å‘çš„</p><p>ä½†æ˜¯åœ¨æˆ‘ä»¬è¿›è¡Œå¹¶å‘ç¼–ç¨‹çš„è¿‡ç¨‹ä¸­ç”±äºç¼–è¯‘å™¨å’Œ CPU çš„å„ç§ä¼˜åŒ–ï¼Œæ‰€ä»¥åœ¨å¹¶å‘æ‰§è¡Œçš„æ—¶å€™å¹¶ä¸ä¸€å®šæŒ‰ç…§ä»£ç ä¹¦å†™çš„é¡ºåºè¿›è¡Œæ‰§è¡Œï¼ˆåœ¨å•ä¸ª Goroutine æ˜¯å¯ä»¥ä¿è¯çš„ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±è¦é‡‡ç”¨å„ç§åŒæ­¥åŸè¯­æ¥ä¿è¯æœ‰åºï¼Œåœ¨ Go ä¸­æœ€å¸¸ç”¨çš„å°±æ˜¯ Channelï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¿›å…¥æ­£é¢˜å§ã€‚</p><p><strong>channel:</strong></p><ul><li>channel ä¸Šçš„å‘é€æ“ä½œæ€»åœ¨å¯¹åº”çš„æ¥æ”¶æ“ä½œå®Œæˆå‰å‘ç”Ÿ</li><li>å¦‚æœ channel å…³é—­åä»ä¸­æ¥æ”¶æ•°æ®ï¼Œæ¥å—è€…å°±ä¼šæ”¶åˆ°è¯¥ channel è¿”å›çš„é›¶å€¼</li><li>ä»æ— ç¼“å†²çš„ channel ä¸­è¿›è¡Œçš„æ¥æ”¶ï¼Œè¦å‘ç”Ÿåœ¨å¯¹è¯¥ channel è¿›è¡Œçš„å‘é€å®Œæˆå‰</li></ul><p>è¿™äº›çœ‹èµ·æ¥ä¼šæ¯”è¾ƒç»•ï¼Œè®°ä½è¿™å‡ æ¡è§„åˆ™ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹èµ°ï¼Œå¸Œæœ›å¯ä»¥è§£å†³ä½ çš„å›°æƒ‘</p><h2 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h2><h3 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h3><p>channel çš„å…³é”®å­—ä¸º <code>chan</code> ï¼Œä½¿ç”¨æ—¶è¿˜éœ€è¦ç»™ channel æŒ‡å®šä¸€ä¸ªç±»å‹ï¼Œæ‰€ä»¥å®Œæ•´çš„å°±æ˜¯ <code>chan T</code> ï¼Œä½¿ç”¨ <code>&lt;-</code>  è¡¨ç¤º channel çš„æ•°æ®æµå‘ï¼Œåœ¨å®šä¹‰å˜é‡æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>&lt;- chan T</code> ã€ <code>chan&lt;- T</code>  æ¥åˆ†åˆ«è¡¨ç¤ºåªè¯»å’Œåªå†™çš„ channelã€‚<br>channel çš„åˆå§‹åŒ–é‡‡ç”¨ <code>make(chan T, cap)</code>  è¡¨ç¤ºï¼Œ <code>cap</code>  ä¸ºå¯é€‰å‚æ•°ï¼Œå¦‚æœä¸å¡«é»˜è®¤å€¼ä¸º 0 è¡¨ç¤ºåˆ›å»ºäº†ä¸€ä¸ªæ— ç¼“å†²çš„ channelã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¥äº†è§£ channel çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-comment">// è¿™é‡Œåªèƒ½è¯»</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">read</span><span class="hljs-params">(c &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;read:&quot;</span>, &lt;-c)<br>&#125;<br><br><span class="hljs-comment">// è¿™é‡Œåªèƒ½å†™</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">write</span><span class="hljs-params">(c <span class="hljs-keyword">chan</span>&lt;- <span class="hljs-keyword">int</span>)</span></span> &#123;<br>c &lt;- <span class="hljs-number">0</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)<br><span class="hljs-keyword">go</span> read(c)<br>write(c)<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åä¼šè¾“å‡º <code>read: 0</code> , æ³¨æ„æˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯æ— ç¼“å†²çš„ channelï¼Œå¦‚æœæ¢æˆæœ‰ç¼“å­˜çš„ï¼Œè¿™é‡Œæœ‰å¯èƒ½å°±ä¸ä¼šè¾“å‡ºäº†ï¼Œå› ä¸º</p><ol><li><strong>channel ä¸Šçš„å‘é€æ“ä½œæ€»åœ¨å¯¹åº”çš„æ¥æ”¶æ“ä½œå®Œæˆå‰å‘ç”Ÿï¼Œ</strong>æ‰€ä»¥åœ¨ read è¿˜æ²¡æœ‰å®Œæˆæ—¶å€™ï¼Œwrite å°±å·²ç»å¼€å§‹å†™å…¥äº†</li><li><strong>ä»æ— ç¼“å†²çš„ channel ä¸­è¿›è¡Œçš„æ¥æ”¶ï¼Œè¦å‘ç”Ÿåœ¨å¯¹è¯¥ channel è¿›è¡Œçš„å‘é€å®Œæˆå‰ï¼Œ</strong>å¦‚æœæ˜¯æ— ç¼“å†²çš„ channelï¼Œ write è¿˜æ²¡å†™å…¥ç»“æŸï¼Œread å°±å·²ç»å¼€å§‹æ¥æ”¶äº†ï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯ read æ‰§è¡Œï¼Œä½†æ˜¯åè¿‡æ¥å¦‚æœæœ‰ç¼“å†²ï¼Œé‚£ä¹ˆ read å¯èƒ½è¿˜æ²¡å¼€å§‹ write å°±ç»“æŸäº†ï¼Œæ‰€ä»¥å°±æœ‰å¯èƒ½ä»€ä¹ˆéƒ½ä¸è¾“å‡ºå°±ç»“æŸäº†</li></ol><p>å…³äºæœ‰æ— ç¼“å†²çš„ channel æœ‰ä¸¤å¼ å›¾éå¸¸ç»å…¸ï¼ŒåŸºæœ¬ä¸Šçœ‹å®Œå°±æ˜ç™½äº†ï¼Œå»ºè®®é˜…è¯»ä¸€ä¸‹åŸæ–‡ï¼Œåœ¨å‚è€ƒæ–‡çŒ® [14] ä¸­</p><h4 id="æ— ç¼“å†²-channel"><a href="#æ— ç¼“å†²-channel" class="headerlink" title="æ— ç¼“å†² channel"></a>æ— ç¼“å†² channel</h4><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ— ç¼“å†²çš„ channel ä¼šé˜»å¡ç›´åˆ°æ•°æ®æ¥æ”¶å®Œæˆï¼Œå¸¸ç”¨äºä¸¤ä¸ª goroutine äº’ç›¸ç­‰å¾…åŒæ­¥<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1610518966242-7cf0d17a-8c64-4eb0-9459-615d10bdf56d.png" alt="image.png"></p><h4 id="æœ‰ç¼“å†²-channel"><a href="#æœ‰ç¼“å†²-channel" class="headerlink" title="æœ‰ç¼“å†² channel"></a>æœ‰ç¼“å†² channel</h4><p>æœ‰ç¼“å†²çš„ channel å¦‚æœåœ¨ç¼“å†²åŒºæœªæ»¡çš„æƒ…å†µä¸‹å‘é€æ˜¯ä¸é˜»å¡çš„ï¼Œåœ¨ç¼“å†²åŒºä¸ä¸ºç©ºæ—¶ï¼Œæ¥æ”¶æ˜¯ä¸é˜»å¡çš„<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1610518977443-794150b4-3b89-4279-b18c-50ae8e334945.png" alt="image.png"></p><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>å¤§æ¦‚äº†è§£äº† channel çš„ä½¿ç”¨æ–¹æ³•å’ŒåŸç†ä¹‹åæˆ‘ä»¬æ¥ä¸‹æ¥å°±è¿›å…¥ç¨å¾®ç¡¬æ ¸ä¸€äº›çš„æºç æ¨¡å¼</p><h4 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> hchan <span class="hljs-keyword">struct</span> &#123;<br>qcount   <span class="hljs-keyword">uint</span>           <span class="hljs-comment">// é˜Ÿåˆ—ä¸­å…ƒç´ æ€»æ•°é‡</span><br>dataqsiz <span class="hljs-keyword">uint</span>           <span class="hljs-comment">// å¾ªç¯é˜Ÿåˆ—çš„é•¿åº¦</span><br>buf      unsafe.Pointer <span class="hljs-comment">// æŒ‡å‘é•¿åº¦ä¸º dataqsiz çš„åº•å±‚æ•°ç»„ï¼Œåªæœ‰åœ¨æœ‰ç¼“å†²æ—¶è¿™ä¸ªæ‰æœ‰æ„ä¹‰</span><br>elemsize <span class="hljs-keyword">uint16</span>         <span class="hljs-comment">// èƒ½å¤Ÿå‘é€å’Œæ¥å—çš„å…ƒç´ å¤§å°</span><br>closed   <span class="hljs-keyword">uint32</span>         <span class="hljs-comment">// æ˜¯å¦å…³é—­</span><br>elemtype *_type <span class="hljs-comment">// å…ƒç´ çš„ç±»å‹</span><br>sendx    <span class="hljs-keyword">uint</span>   <span class="hljs-comment">// å½“å‰å·²å‘é€çš„å…ƒç´ åœ¨é˜Ÿåˆ—å½“ä¸­çš„ç´¢å¼•ä½ç½®</span><br>recvx    <span class="hljs-keyword">uint</span>   <span class="hljs-comment">// å½“å‰å·²æ¥æ”¶çš„å…ƒç´ åœ¨é˜Ÿåˆ—å½“ä¸­çš„ç´¢å¼•ä½ç½®</span><br>recvq    waitq  <span class="hljs-comment">// æ¥æ”¶ Goroutine é“¾è¡¨</span><br>sendq    waitq  <span class="hljs-comment">// å‘é€ Goroutine é“¾è¡¨</span><br><br>lock mutex <span class="hljs-comment">// äº’æ–¥é”</span><br>&#125;<br><br><span class="hljs-comment">// waitq æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œé‡Œé¢ä¿å­˜äº† goroutine</span><br><span class="hljs-keyword">type</span> waitq <span class="hljs-keyword">struct</span> &#123;<br>first *sudog<br>last  *sudog<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œchannel åº•å±‚å…¶å®æ˜¯ä¸€ä¸ªå¾ªç¯é˜Ÿåˆ—<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1610547861474-f3573434-0261-4255-91dd-6e6a4a532030.png" alt="image.png"></p><h4 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h4><p>åœ¨ Go ä¸­æˆ‘ä»¬ä½¿ç”¨ <code>make(chan T, cap)</code>  æ¥åˆ›å»º channelï¼Œmake è¯­æ³•ä¼šåœ¨ç¼–è¯‘æ—¶ï¼Œè½¬æ¢ä¸º <code>makechan64</code>  å’Œ <code>makechan</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">makechan64</span><span class="hljs-params">(t *chantype, size <span class="hljs-keyword">int64</span>)</span> *<span class="hljs-title">hchan</span></span> &#123;<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">int64</span>(<span class="hljs-keyword">int</span>(size)) != size &#123;<br><span class="hljs-built_in">panic</span>(plainError(<span class="hljs-string">&quot;makechan: size out of range&quot;</span>))<br>&#125;<br><br><span class="hljs-keyword">return</span> makechan(t, <span class="hljs-keyword">int</span>(size))<br>&#125;<br></code></pre></td></tr></table></figure><p><code>makechan64</code>  ä¸»è¦æ˜¯åšäº†ä¸€ä¸‹æ£€æŸ¥ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šè°ƒç”¨ <code>makechan</code> ï¼Œåœ¨çœ‹ <code>makechan</code>  æºç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸¤ä¸ªå…¨å±€å¸¸é‡ï¼Œæ¥ä¸‹æ¥ä¼šç”¨åˆ°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> (<br>maxAlign  = <span class="hljs-number">8</span><br>hchanSize = unsafe.Sizeof(hchan&#123;&#125;) + <span class="hljs-keyword">uintptr</span>(-<span class="hljs-keyword">int</span>(unsafe.Sizeof(hchan&#123;&#125;))&amp;(maxAlign<span class="hljs-number">-1</span>))<br>)<br></code></pre></td></tr></table></figure><ul><li><code>maxAlign</code>  æ˜¯å†…å­˜å¯¹é½çš„æœ€å¤§å€¼ï¼Œè¿™ä¸ªç­‰äº 64 ä½ CPU ä¸‹çš„ cacheline çš„å¤§å°</li><li><code>hchanSize</code>  è®¡ç®— <code>unsafe.Sizeof(hchan&#123;&#125;)</code>  æœ€è¿‘çš„ 8 çš„å€æ•°</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">makechan</span><span class="hljs-params">(t *chantype, size <span class="hljs-keyword">int</span>)</span> *<span class="hljs-title">hchan</span></span> &#123;<br>elem := t.elem<br><br><span class="hljs-comment">// å…ˆåšä¸€äº›æ£€æŸ¥</span><br>    <span class="hljs-comment">// å…ƒç´ å¤§å°ä¸èƒ½å¤§äºç­‰äº 64k</span><br><span class="hljs-keyword">if</span> elem.size &gt;= <span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">16</span> &#123;<br>throw(<span class="hljs-string">&quot;makechan: invalid channel element type&quot;</span>)<br>&#125;<br>    <span class="hljs-comment">// åˆ¤æ–­å½“å‰çš„ hchanSize æ˜¯å¦æ˜¯ maxAlign æ•´æ•°å€ï¼Œå¹¶ä¸”å…ƒç´ çš„å¯¹é½å¤§å°ä¸èƒ½å¤§äºæœ€å¤§å¯¹é½çš„å¤§å°</span><br><span class="hljs-keyword">if</span> hchanSize%maxAlign != <span class="hljs-number">0</span> || elem.align &gt; maxAlign &#123;<br>throw(<span class="hljs-string">&quot;makechan: bad alignment&quot;</span>)<br>&#125;<br><br>    <span class="hljs-comment">// è¿™é‡Œè®¡ç®—å†…å­˜æ˜¯å¦è¶…è¿‡é™åˆ¶</span><br>mem, overflow := math.MulUintptr(elem.size, <span class="hljs-keyword">uintptr</span>(size))<br><span class="hljs-keyword">if</span> overflow || mem &gt; maxAlloc-hchanSize || size &lt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-built_in">panic</span>(plainError(<span class="hljs-string">&quot;makechan: size out of range&quot;</span>))<br>&#125;<br><br><span class="hljs-keyword">var</span> c *hchan<br><span class="hljs-keyword">switch</span> &#123;<br><span class="hljs-keyword">case</span> mem == <span class="hljs-number">0</span>: <span class="hljs-comment">// å¦‚æœæ˜¯æ— ç¼“å†²é€šé“</span><br>c = (*hchan)(mallocgc(hchanSize, <span class="hljs-literal">nil</span>, <span class="hljs-literal">true</span>)) <span class="hljs-comment">// ä¸º hchan åˆ†é…å†…å­˜</span><br>c.buf = c.raceaddr() <span class="hljs-comment">// è¿™ä¸ªæ˜¯ for data race æ£€æµ‹çš„</span><br><span class="hljs-keyword">case</span> elem.ptrdata == <span class="hljs-number">0</span>: <span class="hljs-comment">// å…ƒç´ ä¸åŒ…å«æŒ‡é’ˆ</span><br>c = (*hchan)(mallocgc(hchanSize+mem, <span class="hljs-literal">nil</span>, <span class="hljs-literal">true</span>)) <span class="hljs-comment">// ä¸º hchan å’Œåº•å±‚æ•°ç»„åˆ†é…ä¸€æ®µè¿ç»­çš„å†…å­˜åœ°å€</span><br>c.buf = add(unsafe.Pointer(c), hchanSize)<br><span class="hljs-keyword">default</span>: <span class="hljs-comment">// å¦‚æœå…ƒç´ åŒ…å«æŒ‡é’ˆï¼Œåˆ†åˆ«ä¸º hchan å’Œ åº•å±‚æ•°ç»„åˆ†é…å†…å­˜åœ°å€</span><br>c = <span class="hljs-built_in">new</span>(hchan)<br>c.buf = mallocgc(mem, elem, <span class="hljs-literal">true</span>)<br>&#125;<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–ä¸€äº›å€¼</span><br>c.elemsize = <span class="hljs-keyword">uint16</span>(elem.size)<br>c.elemtype = elem<br>c.dataqsiz = <span class="hljs-keyword">uint</span>(size)<br>lockInit(&amp;c.lock, lockRankHchan)<br><br><span class="hljs-keyword">return</span> c<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨é‡Šå·²ç»å†™å¾—å¾ˆå…¨äº†ï¼Œç®€å•åšä¸ªå°ç»“ï¼š</p><ul><li>åˆ›å»ºæ—¶ä¼šåšä¸€äº›æ£€æŸ¥<ul><li>å…ƒç´ å¤§å°ä¸èƒ½è¶…è¿‡ 64K</li><li>å…ƒç´ çš„å¯¹é½å¤§å°ä¸èƒ½è¶…è¿‡ maxAlign ä¹Ÿå°±æ˜¯ 8 å­—èŠ‚</li><li>è®¡ç®—å‡ºæ¥çš„å†…å­˜æ˜¯å¦è¶…è¿‡é™åˆ¶</li></ul></li><li>åˆ›å»ºæ—¶çš„ç­–ç•¥<ul><li>å¦‚æœæ˜¯æ— ç¼“å†²çš„ channelï¼Œä¼šç›´æ¥ç»™ hchan åˆ†é…å†…å­˜</li><li>å¦‚æœæ˜¯æœ‰ç¼“å†²çš„ channelï¼Œå¹¶ä¸”å…ƒç´ ä¸åŒ…å«æŒ‡é’ˆï¼Œé‚£ä¹ˆä¼šä¸º hchan å’Œåº•å±‚æ•°ç»„åˆ†é…ä¸€æ®µè¿ç»­çš„åœ°å€</li><li>å¦‚æœæ˜¯æœ‰ç¼“å†²çš„ channelï¼Œå¹¶ä¸”å…ƒç´ åŒ…å«æŒ‡é’ˆï¼Œé‚£ä¹ˆä¼šä¸º hchan å’Œåº•å±‚æ•°ç»„åˆ†åˆ«åˆ†é…åœ°å€</li></ul></li></ul><h4 id="å‘é€æ•°æ®"><a href="#å‘é€æ•°æ®" class="headerlink" title="å‘é€æ•°æ®"></a>å‘é€æ•°æ®</h4><p>æˆ‘ä»¬åœ¨ <code>x &lt;- chan T</code>  è¿›è¡Œå‘é€æ•°æ®çš„æ—¶å€™æœ€ç»ˆä¼šè¢«ç¼–è¯‘æˆ <code>chansend1</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chansend1</span><span class="hljs-params">(c *hchan, elem unsafe.Pointer)</span></span> &#123;<br>chansend(c, elem, <span class="hljs-literal">true</span>, getcallerpc())<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œ <code>chansend1</code>  æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨äº† <code>chansend</code>  ä¸»è¦çš„é€»è¾‘éƒ½åœ¨ <code>chansend</code>  ä¸Šé¢ï¼Œæ³¨æ„çœ‹ä¸‹æ–¹æºç å’Œæ³¨é‡Š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ä»£ç ä¸­åˆ é™¤äº†è°ƒè¯•ç›¸å…³çš„ä»£ç </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chansend</span><span class="hljs-params">(c *hchan, ep unsafe.Pointer, block <span class="hljs-keyword">bool</span>, callerpc <span class="hljs-keyword">uintptr</span>)</span> <span class="hljs-title">bool</span></span> &#123;<br>    <span class="hljs-comment">// å¦‚æœæ˜¯ä¸€ä¸ª nil å€¼çš„ channel</span><br>    <span class="hljs-comment">// å¦‚æœæ˜¯éé˜»å¡çš„è¯å°±ç›´æ¥è¿”å›</span><br>    <span class="hljs-comment">// å¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆåˆ™è°ƒç”¨ gopark ä¼‘çœ å½“å‰ goroutine å¹¶ä¸”æŠ›å‡º panic é”™è¯¯</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> !block &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>gopark(<span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, waitReasonChanSendNilChan, traceEvGoStop, <span class="hljs-number">2</span>)<br>throw(<span class="hljs-string">&quot;unreachable&quot;</span>)<br>&#125;<br><br>    <span class="hljs-comment">// fast path å¦‚æœå½“å‰æ˜¯éé˜»å¡çš„</span><br>    <span class="hljs-comment">// å¹¶ä¸”é€šé“å°šæœªå…³é—­</span><br>    <span class="hljs-comment">// å¹¶ä¸”ç¼“å†²åŒºå·²æ»¡æ—¶ï¼Œç›´æ¥è¿”å›</span><br><span class="hljs-keyword">if</span> !block &amp;&amp; c.closed == <span class="hljs-number">0</span> &amp;&amp; full(c) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><br>    <span class="hljs-comment">// åŠ é”</span><br>lock(&amp;c.lock)<br><br>    <span class="hljs-comment">// å¦‚æœé€šé“å·²ç»å…³é—­äº†ï¼Œç›´æ¥ panicï¼Œä¸å…è®¸å‘ä¸€ä¸ªå·²ç»å…³é—­çš„ channel å†™å…¥æ•°æ®</span><br><span class="hljs-keyword">if</span> c.closed != <span class="hljs-number">0</span> &#123;<br>unlock(&amp;c.lock)<br><span class="hljs-built_in">panic</span>(plainError(<span class="hljs-string">&quot;send on closed channel&quot;</span>))<br>&#125;<br><br>    <span class="hljs-comment">// å¦‚æœå½“å‰å­˜åœ¨ç­‰å¾…æ¥æ”¶æ•°æ®çš„ goroutine ç›´æ¥å–å‡ºç¬¬ä¸€ä¸ªï¼Œå°†æ•°æ®ä¼ é€’ç»™ç¬¬ä¸€ä¸ªç­‰å¾…çš„ goroutine</span><br><span class="hljs-keyword">if</span> sg := c.recvq.dequeue(); sg != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// send ç”¨äºå‘é€æ•°æ®ï¼Œæˆ‘ä»¬åé¢å†çœ‹</span><br>send(c, sg, ep, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="hljs-number">3</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-comment">// å¦‚æœå½“å‰ channel åŒ…å«ç¼“å†²åŒºï¼Œå¹¶ä¸”ç¼“å†²åŒºæ²¡æœ‰æ»¡</span><br><span class="hljs-keyword">if</span> c.qcount &lt; c.dataqsiz &#123;<br><span class="hljs-comment">// è®¡ç®—æ•°ç»„ä¸­ä¸‹ä¸€ä¸ªå¯ä»¥å­˜æ”¾æ•°æ®çš„åœ°å€</span><br>qp := chanbuf(c, c.sendx)<br><br>        <span class="hljs-comment">// å°†å½“å‰çš„æ•°æ®æ”¾åˆ°ç¼“å†²åŒºä¸­</span><br>typedmemmove(c.elemtype, qp, ep)<br><br>        <span class="hljs-comment">// ç´¢å¼•åŠ ä¸€</span><br>        c.sendx++<br><br>        <span class="hljs-comment">// ç”±äºæ˜¯å¾ªç¯é˜Ÿåˆ—ï¼Œå¦‚æœç´¢å¼•åœ°å€ç­‰äºæ•°ç»„é•¿åº¦ï¼Œå°±éœ€è¦å°†ç´¢å¼•ç§»åŠ¨åˆ° 0</span><br><span class="hljs-keyword">if</span> c.sendx == c.dataqsiz &#123;<br>c.sendx = <span class="hljs-number">0</span><br>&#125;<br><br>        <span class="hljs-comment">// å½“å‰ç¼“å­˜æ•°æ®é‡åŠ ä¸€</span><br>c.qcount++<br>unlock(&amp;c.lock)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br>    <span class="hljs-comment">// å¦‚æœæ˜¯éé˜»å¡çš„å°±ç›´æ¥è¿”å›äº†ï¼Œå› ä¸ºéé˜»å¡å‘é€çš„æƒ…å†µå·²ç»èµ°å®Œäº†ï¼Œä¸‹é¢æ˜¯é˜»å¡å‘é€çš„é€»è¾‘</span><br><span class="hljs-keyword">if</span> !block &#123;<br>unlock(&amp;c.lock)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-comment">// è·å–å‘é€æ•°æ®çš„ goroutine</span><br>gp := getg()<br>    <span class="hljs-comment">// è·å– sudog ç»“æ„ä½“ï¼Œå¹¶ä¸”è®¾ç½®ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬å½“å‰çš„ channelï¼Œæ˜¯å¦æ˜¯ select ç­‰</span><br>mysg := acquireSudog()<br>mysg.releasetime = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> t0 != <span class="hljs-number">0</span> &#123;<br>mysg.releasetime = <span class="hljs-number">-1</span><br>&#125;<br>mysg.elem = ep<br>mysg.waitlink = <span class="hljs-literal">nil</span><br>mysg.g = gp<br>mysg.isSelect = <span class="hljs-literal">false</span><br>mysg.c = c<br>gp.waiting = mysg<br>gp.param = <span class="hljs-literal">nil</span><br><br>    <span class="hljs-comment">// å°† sudog ç»“æ„åŠ å…¥åˆ°å‘é€çš„é˜Ÿåˆ—ä¸­</span><br>c.sendq.enqueue(mysg)<br><br>    <span class="hljs-comment">// æŒ‚èµ·å½“å‰ goroutine ç­‰å¾…æ¥æ”¶ channelæ•°æ®</span><br>gopark(chanparkcommit, unsafe.Pointer(&amp;c.lock), waitReasonChanSend, traceEvGoBlockSend, <span class="hljs-number">2</span>)<br><br>    <span class="hljs-comment">// ä¿è¯å½“å‰æ•°æ®å¤„äºæ´»è·ƒçŠ¶æ€é¿å…è¢«å›æ”¶</span><br>KeepAlive(ep)<br><br><span class="hljs-comment">// å‘é€è€… goroutine è¢«å”¤é†’ï¼Œæ£€æŸ¥å½“å‰ sg çš„çŠ¶æ€</span><br><span class="hljs-keyword">if</span> mysg != gp.waiting &#123;<br>throw(<span class="hljs-string">&quot;G waiting list is corrupted&quot;</span>)<br>&#125;<br>gp.waiting = <span class="hljs-literal">nil</span><br>gp.activeStackChans = <span class="hljs-literal">false</span><br><span class="hljs-keyword">if</span> gp.param == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> c.closed == <span class="hljs-number">0</span> &#123;<br>throw(<span class="hljs-string">&quot;chansend: spurious wakeup&quot;</span>)<br>&#125;<br><span class="hljs-built_in">panic</span>(plainError(<span class="hljs-string">&quot;send on closed channel&quot;</span>))<br>&#125;<br>gp.param = <span class="hljs-literal">nil</span><br><span class="hljs-keyword">if</span> mysg.releasetime &gt; <span class="hljs-number">0</span> &#123;<br>blockevent(mysg.releasetime-t0, <span class="hljs-number">2</span>)<br>&#125;<br><br>    <span class="hljs-comment">// å–æ¶ˆ channel ç»‘å®š</span><br>mysg.c = <span class="hljs-literal">nil</span><br>    <span class="hljs-comment">// é‡Šæ”¾ sudog</span><br>releaseSudog(mysg)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><p>send</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">send</span><span class="hljs-params">(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf <span class="hljs-keyword">func</span>()</span>, <span class="hljs-title">skip</span> <span class="hljs-title">int</span>)</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœ sudog ä¸Šå­˜åœ¨æ•°æ®å…ƒç´ ï¼Œå°±è°ƒç”¨ sendDirect ç›´æ¥æŠŠæ•°æ®æ‹·è´åˆ°æ¥æ”¶å˜é‡çš„åœ°å€ä¸Š</span><br><span class="hljs-keyword">if</span> sg.elem != <span class="hljs-literal">nil</span> &#123;<br>sendDirect(c.elemtype, sg, ep)<br>sg.elem = <span class="hljs-literal">nil</span><br>&#125;<br>gp := sg.g<br>unlockf()<br>gp.param = unsafe.Pointer(sg)<br><span class="hljs-keyword">if</span> sg.releasetime != <span class="hljs-number">0</span> &#123;<br>sg.releasetime = cputicks()<br>&#125;<br><br>    <span class="hljs-comment">// è°ƒç”¨ goready å°†æ¥å—è€…çš„ Goroutine æ ‡è®°ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œå¹¶æŠŠå®ƒæ”¾åˆ°å‘é€æ–¹çš„æ‰€åœ¨å¤„ç†å™¨çš„ runnext ç­‰å¾…æ‰§è¡Œï¼Œä¸‹æ¬¡è°ƒåº¦æ—¶å°±ä¼šæ‰§è¡Œåˆ°å®ƒã€‚</span><br>    <span class="hljs-comment">// æ³¨æ„è¿™é‡Œä¸æ˜¯ç«‹å³æ‰§è¡Œ</span><br>goready(gp, skip+<span class="hljs-number">1</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å°ç»“</strong><br>å‘ channel ä¸­å‘é€æ•°æ®æ—¶å¤§æ¦‚åˆ†ä¸ºä¸¤å¤§å—ï¼Œæ£€æŸ¥å’Œæ•°æ®å‘é€ï¼Œè€Œæ•°æ®å‘é€åˆåˆ†ä¸ºä¸‰ç§æƒ…å†µ</p><ul><li>å¦‚æœ channel çš„ <code>recvq</code>  å­˜åœ¨é˜»å¡ç­‰å¾…çš„æ¥æ”¶æ•°æ®çš„ goroutine é‚£ä¹ˆå°†ä¼šç›´æ¥å°†æ•°æ®å‘é€ç»™ç¬¬ä¸€ä¸ªç­‰å¾…çš„ goroutine<ul><li>è¿™é‡Œä¼šç›´æ¥å°†æ•°æ®æ‹·è´åˆ° <code>x &lt;-ch</code>  æ¥æ”¶è€…çš„å˜é‡ <code>x</code>  ä¸Š</li><li>ç„¶åå°†æ¥æ”¶è€…çš„ Goroutine ä¿®æ”¹ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œå¹¶æŠŠå®ƒæ”¾åˆ°å‘é€æ–¹æ‰€åœ¨å¤„ç†å™¨çš„ runnext ä¸Šç­‰å¾…ä¸‹ä¸€æ¬¡è°ƒåº¦æ—¶æ‰§è¡Œã€‚</li></ul></li><li>å¦‚æœ channel æ˜¯æœ‰ç¼“å†²çš„ï¼Œå¹¶ä¸”ç¼“å†²åŒºæ²¡æœ‰æ»¡ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šæŠŠæ•°æ®æ”¾åˆ°ç¼“å†²åŒºä¸­</li><li>å¦‚æœ channel çš„ç¼“å†²åŒºæ»¡äº†ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šèµ°é˜»å¡å‘é€çš„æµç¨‹ï¼Œè·å–åˆ° sudog ä¹‹åå°†å½“å‰ Goroutine æŒ‚èµ·ç­‰å¾…å”¤é†’ï¼Œå”¤é†’åå°†ç›¸å…³çš„æ•°æ®è§£ç»‘ï¼Œå›æ”¶æ‰ sudog</li></ul><h4 id="æ¥æ”¶æ•°æ®"><a href="#æ¥æ”¶æ•°æ®" class="headerlink" title="æ¥æ”¶æ•°æ®"></a>æ¥æ”¶æ•°æ®</h4><p>åœ¨ Go ä¸­æ¥æ”¶ channel æ•°æ®æœ‰ä¸¤ç§æ–¹å¼</p><ul><li><code>x &lt;- ch</code>  ç¼–è¯‘æ—¶ä¼šè¢«è½¬æ¢ä¸º <code>chanrecv1</code></li><li><code>x, ok &lt;- ch</code>   ç¼–è¯‘æ—¶ä¼šè¢«è½¬æ¢ä¸º <code>chanrecv2</code></li></ul><p><code>chanrecv1</code> å’Œ <code>chanrecv2</code> æ²¡æœ‰å¤šå¤§åŒºåˆ«ï¼Œåªæ˜¯ <code>chanrecv2</code> æ¯” <code>chanrecv1</code> å¤šäº†ä¸€ä¸ªè¿”å›å€¼ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨çš„ <code>chanrecv</code> æ¥å®ç°çš„æ¥æ”¶æ•°æ®</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// selected ç”¨äº select&#123;&#125; è¯­æ³•ä¸­æ˜¯å¦ä¼šé€‰ä¸­è¯¥åˆ†æ”¯</span><br><span class="hljs-comment">// received è¡¨ç¤ºå½“å‰æ˜¯å¦çœŸæ­£çš„æ¥æ”¶åˆ°æ•°æ®ï¼Œç”¨æ¥åˆ¤æ–­ channel æ˜¯å¦ closed æ‰äº†</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chanrecv</span><span class="hljs-params">(c *hchan, ep unsafe.Pointer, block <span class="hljs-keyword">bool</span>)</span> <span class="hljs-params">(selected, received <span class="hljs-keyword">bool</span>)</span></span> &#123;<br><span class="hljs-comment">// å’Œå‘é€æ•°æ®ç±»ä¼¼ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦ä¸ºnilï¼Œå¦‚æœæ˜¯ nil å¹¶ä¸”é˜»å¡æ¥æ”¶å°±ä¼š panic</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> !block &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>gopark(<span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, waitReasonChanReceiveNilChan, traceEvGoStop, <span class="hljs-number">2</span>)<br>throw(<span class="hljs-string">&quot;unreachable&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// Fast path: æ£€æŸ¥éé˜»å¡çš„æ“ä½œ</span><br>    <span class="hljs-comment">// empty ä¸»è¦æ˜¯æœ‰ä¸¤ç§æƒ…å†µè¿”å› true:</span><br>    <span class="hljs-comment">// 1. æ— ç¼“å†²channelï¼Œå¹¶ä¸”æ²¡æœ‰é˜»å¡ä½å‘é€è€…</span><br>    <span class="hljs-comment">// 2. æœ‰ç¼“å†² channelï¼Œä½†æ˜¯ç¼“å†²åŒºæ²¡æœ‰æ•°æ®</span><br><span class="hljs-keyword">if</span> !block &amp;&amp; empty(c) &#123;<br><span class="hljs-comment">// è¿™é‡Œåˆ¤æ–­é€šé“æ˜¯å¦å…³é—­ï¼Œå¦‚æœæ˜¯æœªå…³é—­çš„é€šé“è¯´æ˜å½“å‰è¿˜æ²¡å‡†å¤‡å¥½æ•°æ®ï¼Œç›´æ¥è¿”å›</span><br><span class="hljs-keyword">if</span> atomic.Load(&amp;c.closed) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-comment">// å¦‚æœé€šé“å·²ç»å…³é—­äº†ï¼Œå†æ£€æŸ¥ä¸€ä¸‹é€šé“è¿˜æœ‰æ²¡æœ‰æ•°æ®ï¼Œå¦‚æœå·²ç»æ²¡æ•°æ®äº†ï¼Œæˆ‘ä»¬æ¸…ç†åˆ° ep æŒ‡é’ˆä¸­çš„æ•°æ®å¹¶ä¸”è¿”å›</span><br><span class="hljs-keyword">if</span> empty(c) &#123;<br><span class="hljs-keyword">if</span> ep != <span class="hljs-literal">nil</span> &#123;<br>typedmemclr(c.elemtype, ep)<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br><br><span class="hljs-comment">// ä¸Šé”</span><br>lock(&amp;c.lock)<br><br>    <span class="hljs-comment">// å’Œä¸Šé¢ç±»ä¼¼ï¼Œå¦‚æœé€šé“å·²ç»å…³é—­äº†ï¼Œå¹¶ä¸”å·²ç»æ²¡æ•°æ®äº†ï¼Œæˆ‘ä»¬æ¸…ç†åˆ° ep æŒ‡é’ˆä¸­çš„æ•°æ®å¹¶ä¸”è¿”å›</span><br><span class="hljs-keyword">if</span> c.closed != <span class="hljs-number">0</span> &amp;&amp; c.qcount == <span class="hljs-number">0</span> &#123;<br>unlock(&amp;c.lock)<br><span class="hljs-keyword">if</span> ep != <span class="hljs-literal">nil</span> &#123;<br>typedmemclr(c.elemtype, ep)<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span><br>&#125;<br><br>    <span class="hljs-comment">// å’Œå‘é€ç±»ä¼¼ï¼Œæ¥æ”¶æ•°æ®æ—¶ä¹Ÿæ˜¯å…ˆçœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰æ­£åœ¨é˜»å¡çš„ç­‰å¾…å‘é€æ•°æ®çš„ Goroutine</span><br>    <span class="hljs-comment">// å¦‚æœæœ‰çš„è¯ ç›´æ¥è°ƒç”¨ recv æ–¹æ³•ä»å‘é€è€…æˆ–è€…æ˜¯ç¼“å†²åŒºä¸­æ¥æ”¶æ•°æ®ï¼Œrecv æ–¹æ³•åé¢ä¼šè®²åˆ°</span><br><span class="hljs-keyword">if</span> sg := c.sendq.dequeue(); sg != <span class="hljs-literal">nil</span> &#123;<br>recv(c, sg, ep, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="hljs-number">3</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span><br>&#125;<br><br>    <span class="hljs-comment">// å¦‚æœ channel çš„ç¼“å†²åŒºè¿˜æœ‰æ•°æ®</span><br><span class="hljs-keyword">if</span> c.qcount &gt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// è·å–å½“å‰ channel æ¥æ”¶çš„åœ°å€</span><br>qp := chanbuf(c, c.recvx)<br><br>        <span class="hljs-comment">// å¦‚æœä¼ å…¥çš„æŒ‡é’ˆä¸æ˜¯ nil ç›´æ¥æŠŠæ•°æ®å¤åˆ¶åˆ°å¯¹åº”çš„å˜é‡ä¸Š</span><br><span class="hljs-keyword">if</span> ep != <span class="hljs-literal">nil</span> &#123;<br>typedmemmove(c.elemtype, ep, qp)<br>&#125;<br>        <span class="hljs-comment">// æ¸…é™¤é˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼Œè®¾ç½®æ¥å—è€…ç´¢å¼•å¹¶ä¸”è¿”å›</span><br>typedmemclr(c.elemtype, qp)<br>c.recvx++<br><span class="hljs-keyword">if</span> c.recvx == c.dataqsiz &#123;<br>c.recvx = <span class="hljs-number">0</span><br>&#125;<br>c.qcount--<br>unlock(&amp;c.lock)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span><br>&#125;<br><br>    <span class="hljs-comment">// å’Œå‘é€ä¸€æ ·å‰©ä¸‹çš„å°±æ˜¯é˜»å¡æ“ä½œäº†ï¼Œå¦‚æœæ˜¯éé˜»å¡çš„æƒ…å†µï¼Œç›´æ¥è¿”å›</span><br><span class="hljs-keyword">if</span> !block &#123;<br>unlock(&amp;c.lock)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-comment">// é˜»å¡æ¥å—ï¼Œå’Œå‘é€ç±»ä¼¼ï¼Œæ‹¿åˆ°å½“å‰ Goroutine å’Œ sudog å¹¶ä¸”åšä¸€äº›æ•°æ®å¡«å……</span><br>gp := getg()<br>mysg := acquireSudog()<br>mysg.releasetime = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> t0 != <span class="hljs-number">0</span> &#123;<br>mysg.releasetime = <span class="hljs-number">-1</span><br>&#125;<br>mysg.elem = ep<br>mysg.waitlink = <span class="hljs-literal">nil</span><br>gp.waiting = mysg<br>mysg.g = gp<br>mysg.isSelect = <span class="hljs-literal">false</span><br>mysg.c = c<br>gp.param = <span class="hljs-literal">nil</span><br><br>    <span class="hljs-comment">// æŠŠ sudog æ”¾å…¥åˆ°æ¥æ”¶è€…é˜Ÿåˆ—å½“ä¸­</span><br>c.recvq.enqueue(mysg)<br>    <span class="hljs-comment">// ç„¶åä¼‘çœ å½“å‰ Goroutine ç­‰å¾…å”¤é†’</span><br>gopark(chanparkcommit, unsafe.Pointer(&amp;c.lock), waitReasonChanReceive, traceEvGoBlockRecv, <span class="hljs-number">2</span>)<br><br><span class="hljs-comment">// Goroutine è¢«å”¤é†’ï¼Œæ¥æ”¶å®Œæ•°æ®ï¼Œåšä¸€äº›æ•°æ®æ¸…ç†çš„æ“ä½œï¼Œé‡Šæ”¾æ‰ sudog ç„¶åè¿”å›</span><br><span class="hljs-keyword">if</span> mysg != gp.waiting &#123;<br>throw(<span class="hljs-string">&quot;G waiting list is corrupted&quot;</span>)<br>&#125;<br>gp.waiting = <span class="hljs-literal">nil</span><br>gp.activeStackChans = <span class="hljs-literal">false</span><br><span class="hljs-keyword">if</span> mysg.releasetime &gt; <span class="hljs-number">0</span> &#123;<br>blockevent(mysg.releasetime-t0, <span class="hljs-number">2</span>)<br>&#125;<br>closed := gp.param == <span class="hljs-literal">nil</span><br>gp.param = <span class="hljs-literal">nil</span><br>mysg.c = <span class="hljs-literal">nil</span><br>releaseSudog(mysg)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, !closed<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>recv</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">recv</span><span class="hljs-params">(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf <span class="hljs-keyword">func</span>()</span>, <span class="hljs-title">skip</span> <span class="hljs-title">int</span>)</span> &#123;<br><span class="hljs-comment">// å¦‚æœæ— ç¼“å†²çš„ channel ç›´æ¥è°ƒç”¨ recvDirect å°†æ•°æ®ä»å‘é€è€… Goroutine æ‹·è´åˆ°å˜é‡</span><br>    <span class="hljs-keyword">if</span> c.dataqsiz == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> ep != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// copy data from sender</span><br>recvDirect(c.elemtype, sg, ep)<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// å¦åˆ™çš„è¯è¯´æ˜è¿™æ˜¯ä¸€ä¸ªæœ‰ç¼“å†²çš„ channel å¹¶ä¸”ç¼“å†²å·²ç»æ»¡äº†</span><br><br>        <span class="hljs-comment">// å…ˆä»åº•å±‚æ•°ç»„ä¸­æ‹¿åˆ°æ•°æ®åœ°å€</span><br>qp := chanbuf(c, c.recvx)<br><br><span class="hljs-comment">// ç„¶åæŠŠæ•°æ®å¤åˆ¶åˆ°æ¥æ”¶å˜é‡ä¸Š</span><br><span class="hljs-keyword">if</span> ep != <span class="hljs-literal">nil</span> &#123;<br>typedmemmove(c.elemtype, ep, qp)<br>&#125;<br><br><span class="hljs-comment">// ç„¶åå°†å‘é€è€… Goroutine ä¸­çš„æ•°æ®æ‹·è´åˆ°åº•å±‚æ•°ç»„ä¸Š</span><br>typedmemmove(c.elemtype, qp, sg.elem)<br>c.recvx++<br><span class="hljs-keyword">if</span> c.recvx == c.dataqsiz &#123;<br>c.recvx = <span class="hljs-number">0</span><br>&#125;<br>c.sendx = c.recvx <span class="hljs-comment">// c.sendx = (c.sendx+1) % c.dataqsiz</span><br>&#125;<br>    <span class="hljs-comment">// æœ€ååšä¸€äº›æ¸…ç†æ“ä½œ</span><br>sg.elem = <span class="hljs-literal">nil</span><br>gp := sg.g<br>unlockf()<br>gp.param = unsafe.Pointer(sg)<br><span class="hljs-keyword">if</span> sg.releasetime != <span class="hljs-number">0</span> &#123;<br>sg.releasetime = cputicks()<br>&#125;<br>goready(gp, skip+<span class="hljs-number">1</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å°ç»“: </strong>æ•°æ®æ¥æ”¶å’Œå‘é€å…¶å®å¤§åŒå°å¼‚ï¼Œä¹Ÿæ˜¯åˆ†ä¸ºæ£€æŸ¥å’Œæ•°æ®æ¥æ”¶ï¼Œæ•°æ®æ¥æ”¶åˆåˆ†ä¸‰ç§æƒ…å†µ</p><ul><li>ç›´æ¥è·å–æ•°æ®ï¼Œå¦‚æœå½“å‰æœ‰é˜»å¡çš„å‘é€è€… Goroutine èµ°è¿™æ¡è·¯<ul><li>å¦‚æœæ˜¯æ— ç¼“å†² channelï¼Œç›´æ¥ä»å‘é€è€…é‚£é‡ŒæŠŠæ•°æ®æ‹·è´ç»™æ¥æ”¶å˜é‡</li><li>å¦‚æœæ˜¯æœ‰ç¼“å†² channelï¼Œå¹¶ä¸” channel å·²ç»æ»¡äº†ï¼Œå°±å…ˆä» channel çš„åº•å±‚æ•°ç»„æ‹·è´æ•°æ®ï¼Œå†æŠŠé˜»å¡çš„å‘é€è€… Goroutine çš„æ•°æ®æ‹·è´åˆ° channel çš„å¾ªç¯é˜Ÿåˆ—ä¸­</li></ul></li><li>ä» channel çš„ç¼“å†²ä¸­è·å–æ•°æ®ï¼Œæœ‰ç¼“å†² channel å¹¶ä¸”ç¼“å­˜é˜Ÿåˆ—æœ‰æ•°æ®æ—¶èµ°è¿™æ¡è·¯<ul><li>ç›´æ¥ä»ç¼“å­˜é˜Ÿåˆ—ä¸­å¤åˆ¶æ•°æ®ç»™æ¥æ”¶å˜é‡</li></ul></li><li>é˜»å¡æ¥æ”¶ï¼Œå‰©ä½™æƒ…å†µèµ°è¿™é‡Œ<ul><li>å’Œå‘é€ç±»ä¼¼ï¼Œå…ˆè·å–å½“å‰ Goroutine ä¿¡æ¯ï¼Œæ„é€  sudog åŠ å…¥åˆ° channel çš„ recvq ä¸Š</li><li>ç„¶åä¼‘çœ å½“å‰ Goroutine ç­‰å¾…å”¤é†’</li><li>å”¤é†’ååšä¸€äº›æ¸…ç†å·¥ä½œï¼Œé‡Šæ”¾ sudog è¿”å›</li></ul></li></ul><h4 id="å…³é—­-channel"><a href="#å…³é—­-channel" class="headerlink" title="å…³é—­ channel"></a>å…³é—­ channel</h4><p>æˆ‘ä»¬ä½¿ç”¨ <code>close(ch)</code>  æ¥å…³é—­ channel æœ€åä¼šè°ƒç”¨ runtime ä¸­çš„ <code>closechan</code>  æ–¹æ³•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">closechan</span><span class="hljs-params">(c *hchan)</span></span> &#123;<br>    <span class="hljs-comment">// å…³é—­ nil çš„ channel ä¼šå¯¼è‡´ panic</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(plainError(<span class="hljs-string">&quot;close of nil channel&quot;</span>))<br>&#125;<br><br>    <span class="hljs-comment">// åŠ é”</span><br>lock(&amp;c.lock)<br><br>    <span class="hljs-comment">// å…³é—­å·²å…³é—­çš„ channel ä¼šå¯¼è‡´ panic</span><br><span class="hljs-keyword">if</span> c.closed != <span class="hljs-number">0</span> &#123;<br>unlock(&amp;c.lock)<br><span class="hljs-built_in">panic</span>(plainError(<span class="hljs-string">&quot;close of closed channel&quot;</span>))<br>&#125;<br><br><span class="hljs-comment">// è®¾ç½® channel çŠ¶æ€</span><br>c.closed = <span class="hljs-number">1</span><br><br><span class="hljs-keyword">var</span> glist gList<br><br><span class="hljs-comment">// é‡Šæ”¾æ‰€æœ‰çš„æ¥æ”¶è€… Goroutine</span><br><span class="hljs-keyword">for</span> &#123;<br>sg := c.recvq.dequeue()<br><span class="hljs-keyword">if</span> sg == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">if</span> sg.elem != <span class="hljs-literal">nil</span> &#123;<br>typedmemclr(c.elemtype, sg.elem)<br>sg.elem = <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-keyword">if</span> sg.releasetime != <span class="hljs-number">0</span> &#123;<br>sg.releasetime = cputicks()<br>&#125;<br>gp := sg.g<br>gp.param = <span class="hljs-literal">nil</span><br><br>glist.push(gp)<br>&#125;<br><br><span class="hljs-comment">// é‡Šæ”¾æ‰€æœ‰çš„å‘é€è€…channelï¼Œä¼š panic å› ä¸ºä¸å…è®¸å‘å·²å…³é—­çš„ channel å‘é€æ•°æ®</span><br><span class="hljs-keyword">for</span> &#123;<br>sg := c.sendq.dequeue()<br><span class="hljs-keyword">if</span> sg == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>sg.elem = <span class="hljs-literal">nil</span><br><span class="hljs-keyword">if</span> sg.releasetime != <span class="hljs-number">0</span> &#123;<br>sg.releasetime = cputicks()<br>&#125;<br>gp := sg.g<br>gp.param = <span class="hljs-literal">nil</span><br><span class="hljs-keyword">if</span> raceenabled &#123;<br>raceacquireg(gp, c.raceaddr())<br>&#125;<br>glist.push(gp)<br>&#125;<br>unlock(&amp;c.lock)<br><br><span class="hljs-comment">// å°†æ‰€æœ‰çš„ Goroutine è®¾ç½®ä¸ºå¯è¿è¡ŒçŠ¶æ€</span><br><span class="hljs-keyword">for</span> !glist.empty() &#123;<br>gp := glist.pop()<br>gp.schedlink = <span class="hljs-number">0</span><br>goready(gp, <span class="hljs-number">3</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å°ç»“:</strong></p><ul><li>å…³é—­ä¸€ä¸ª nil çš„ channel å’Œå·²å…³é—­äº†çš„ channel éƒ½ä¼šå¯¼è‡´ panic</li><li>å…³é—­ channel åä¼šé‡Šæ”¾æ‰€æœ‰å› ä¸º channel è€Œé˜»å¡çš„ Goroutine</li></ul><h3 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h3><p>å…³äº channel çš„ä½¿ç”¨åœºæ™¯åœ¨ Go è¯­è¨€ 101 å½“ä¸­å·²ç»å¾ˆå®Œå–„äº†ï¼Œå¦‚æœæ„Ÿå…´è¶£å¯ä»¥çœ‹ä¸€ä¸‹å‚è€ƒæ–‡çŒ®[5]ï¼Œæˆ‘è¿™é‡Œåªè®²ä¸€äº›å¸¸è§æˆ–æ˜¯æˆ‘è§‰å¾—æœ‰è¶£çš„ä¾‹å­</p><h4 id="1-é€šè¿‡å…³é—­-channel-å®ç°ä¸€å¯¹å¤šçš„é€šçŸ¥"><a href="#1-é€šè¿‡å…³é—­-channel-å®ç°ä¸€å¯¹å¤šçš„é€šçŸ¥" class="headerlink" title="1. é€šè¿‡å…³é—­ channel å®ç°ä¸€å¯¹å¤šçš„é€šçŸ¥"></a>1. é€šè¿‡å…³é—­ channel å®ç°ä¸€å¯¹å¤šçš„é€šçŸ¥</h4><p>åˆšåˆšè®²åˆ°äº†å…³é—­ channel æ—¶ä¼šé‡Šæ”¾æ‰€æœ‰é˜»å¡çš„ Goroutineï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§æ¥åšä¸€å¯¹å¤šçš„é€šçŸ¥ï¼Œé™¤äº†ä¸€å¯¹å¤šä¹‹å¤–æˆ‘ä»¬è¿˜ç”¨äº† <code>done</code>  åšäº†å¤šå¯¹ä¸€çš„é€šçŸ¥ï¼Œå½“ç„¶å¤šå¯¹ä¸€è¿™ç§æƒ…å†µè¿˜æ˜¯å»ºè®®ç›´æ¥ä½¿ç”¨ WaitGroup å³å¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">run</span><span class="hljs-params">(stop &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, done <span class="hljs-keyword">chan</span>&lt;- <span class="hljs-keyword">struct</span>&#123;&#125;)</span></span> &#123;<br><span class="hljs-comment">// æ¯ä¸€ç§’æ‰“å°ä¸€æ¬¡ hello</span><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-stop:<br>fmt.Println(<span class="hljs-string">&quot;stop...&quot;</span>)<br>done &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br><span class="hljs-keyword">return</span><br><span class="hljs-keyword">case</span> &lt;-time.After(time.Second):<br>fmt.Println(<span class="hljs-string">&quot;hello&quot;</span>)<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// ä¸€å¯¹å¤š</span><br>stop := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br><span class="hljs-comment">// å¤šå¯¹ä¸€</span><br>done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, <span class="hljs-number">10</span>)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br><span class="hljs-keyword">go</span> run(stop, done)<br>&#125;<br><br><span class="hljs-comment">// 5s åé€€å‡º</span><br>time.Sleep(<span class="hljs-number">5</span> * time.Second)<br><span class="hljs-built_in">close</span>(stop)<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>&lt;-done<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-ä½¿ç”¨-channel-åšå¼‚æ­¥ç¼–ç¨‹-future-promise"><a href="#2-ä½¿ç”¨-channel-åšå¼‚æ­¥ç¼–ç¨‹-future-promise" class="headerlink" title="2. ä½¿ç”¨ channel åšå¼‚æ­¥ç¼–ç¨‹(future/promise)"></a>2. ä½¿ç”¨ channel åšå¼‚æ­¥ç¼–ç¨‹(future/promise)</h4><p>å…¶å®æœ€å¼€å§‹çš„ä¾‹å­å°±æ˜¯è¿™ç§æƒ…å†µ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-comment">// è¿™é‡Œåªèƒ½è¯»</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">read</span><span class="hljs-params">(c &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;read:&quot;</span>, &lt;-c)<br>&#125;<br><br><span class="hljs-comment">// è¿™é‡Œåªèƒ½å†™</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">write</span><span class="hljs-params">(c <span class="hljs-keyword">chan</span>&lt;- <span class="hljs-keyword">int</span>)</span></span> &#123;<br>c &lt;- <span class="hljs-number">0</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)<br><span class="hljs-keyword">go</span> read(c)<br>write(c)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-è¶…æ—¶æ§åˆ¶"><a href="#3-è¶…æ—¶æ§åˆ¶" class="headerlink" title="3. è¶…æ—¶æ§åˆ¶"></a>3. è¶…æ—¶æ§åˆ¶</h4><p>å…·ä½“å¯ä»¥çœ‹æ¡ˆä¾‹ä¸€é‡Œé¢çš„ run æ–¹æ³•, ä¸è¿‡è¶…æ—¶æ§åˆ¶è¿˜æ˜¯å»ºè®®ä½¿ç”¨ context</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">run</span><span class="hljs-params">(stop &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, done <span class="hljs-keyword">chan</span>&lt;- <span class="hljs-keyword">struct</span>&#123;&#125;)</span></span> &#123;<br><span class="hljs-comment">// æ¯ä¸€ç§’æ‰“å°ä¸€æ¬¡ hello</span><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-stop:<br>fmt.Println(<span class="hljs-string">&quot;stop...&quot;</span>)<br>done &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br><span class="hljs-keyword">return</span><br><span class="hljs-keyword">case</span> &lt;-time.After(time.Second):<br>fmt.Println(<span class="hljs-string">&quot;hello&quot;</span>)<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ç¯‡æ–‡ç« ä»èµ„æ–™æ”¶é›†ï¼Œåˆ°æºç é˜…è¯»å†åˆ°æœ€ç»ˆæˆæ–‡èŠ±äº†å¿«åŠä¸ªæœˆçš„æ—¶é—´äº†ï¼Œä¸è¿‡å†™å®Œä¹‹åå°±æˆ‘ä¸ªäººè€Œè¨€æ˜¯æ”¶è·æ»¡æ»¡çš„ï¼Œä¸çŸ¥åˆ°èƒ½ä¸èƒ½ä¸ºå±å¹•å‰çš„ä½ å¸¦æ¥ä¸€ç‚¹ç‚¹å¯å‘ï¼Œå¦‚æœå¯ä»¥é‚£å°±å¤ªèµäº†ã€‚è¿™ç¯‡æ–‡ç« ä»æœ€å¼€å§‹çš„ç†è®º csp/actor åˆ° hanpens before å†åˆ° channel çš„åŸºæœ¬ç”¨æ³•ï¼Œæºç å®ç°ï¼Œæœ€åè®²åˆ°äº†ä¸€äº›ä½¿ç”¨åœºæ™¯ï¼Œä½†æ˜¯ç”±äºé•¿åº¦ç²¾åŠ›è¿˜æ˜¯ä¸ªäººæ°´å¹³ç­‰å¤šç§é™åˆ¶æœ‰çš„åœ°æ–¹è®²è§£è¿˜æ˜¯ä¸å¤Ÿç»†è‡´ï¼Œå…·ä½“å¼ºçƒˆå»ºè®®é˜…è¯»ä¸€äº›å‚è€ƒæ–‡çŒ®é‡Œé¢çš„åå‡ ç¯‡æ–‡ç« ï¼Œæ¯ä¸€ä¸ªéƒ½å€¼å¾—ç»†ç»†å“å‘³ã€‚<br>æˆ‘ä»¬ä¸‹ä¸€ç¯‡æ–‡ç« è§ ğŸ‘€</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://golang.org/ref/spec#Channel_types">The Go Programming Language Specification - The Go Programming Language</a></li><li><a href="https://blogtitle.github.io/go-advanced-concurrency-patterns-part-3-channels/">Go advanced concurrency patterns: part 3 (channels) - Blog Title</a></li><li><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-channel/">Go è¯­è¨€ Channel å®ç°åŸç†ç²¾è¦ | Go è¯­è¨€è®¾è®¡ä¸å®ç°</a></li><li><a href="https://colobu.com/2016/04/14/Golang-Channels/">Go Channel è¯¦è§£ | é¸Ÿçª</a></li><li><a href="https://gfw.go101.org/article/channel.html">é€šé“ - Go è¯­è¨€ 101ï¼ˆé€šä¿—ç‰ˆ Go ç™½çš®ä¹¦ï¼‰</a></li><li><a href="https://gfw.go101.org/article/channel-use-cases.html">é€šé“ç”¨ä¾‹å¤§å…¨ - Go è¯­è¨€ 101ï¼ˆé€šä¿—ç‰ˆ Go ç™½çš®ä¹¦ï¼‰</a></li><li><a href="https://gfw.go101.org/article/channel-closing.html">å¦‚ä½•ä¼˜é›…åœ°å…³é—­é€šé“ - Go è¯­è¨€ 101ï¼ˆé€šä¿—ç‰ˆ Go ç™½çš®ä¹¦ï¼‰</a></li><li><a href="https://qcrao.com/2019/07/22/dive-into-go-channel/">æ·±åº¦è§£å¯† Go è¯­è¨€ä¹‹ channel | qcrao</a></li><li><a href="https://draveness.me/whys-the-design-communication-shared-memory/">ä¸ºä»€ä¹ˆä½¿ç”¨é€šä¿¡æ¥å…±äº«å†…å­˜ - é¢å‘ä¿¡ä»°ç¼–ç¨‹</a></li><li><a href="http://www.usingcsp.com/cspbook.pdf">http://www.usingcsp.com/cspbook.pdf</a></li><li><a href="https://mp.weixin.qq.com/s/ZXYpfLNGyej0df2zXqfnHQ">ä¸€æ–‡å¸¦ä½ è§£å¯† Go è¯­è¨€ä¹‹é€šé“ channel</a></li><li><a href="https://www.cyub.vip/2020/11/04/Golang%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97%E4%B9%8BChannel%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/">Golang æºç åˆ†æç³»åˆ—ä¹‹ Channel åº•å±‚å®ç° | Tinkâ€™s Blog</a></li><li><a href="https://www.ardanlabs.com/blog/2017/10/the-behavior-of-channels.html">The Behavior Of Channels</a></li><li><a href="https://www.ardanlabs.com/blog/2014/02/the-nature-of-channels-in-go.html">The Nature Of Channels In Go</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week03: Go å¹¶å‘ç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¹¶å‘</tag>
      
      <tag>channel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¹¶å‘ç¼–ç¨‹(ä¹) æ·±å…¥ç†è§£ Context</title>
    <link href="/post/go-training-week3-context.html"/>
    <url>/post/go-training-week3-context.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="æ¥”å­"><a href="#æ¥”å­" class="headerlink" title="æ¥”å­"></a>æ¥”å­</h2><p>åœ¨ <a href="https://lailin.xyz/post/go-training-week3-waitgroup.html">Week03: Go å¹¶å‘ç¼–ç¨‹(å…­) æ·±å…¥ç†è§£ WaitGroup</a> ã€ <a href="https://lailin.xyz/post/go-training-week3-errgroup.html">Week03: Go å¹¶å‘ç¼–ç¨‹(ä¸ƒ) æ·±å…¥ç†è§£ errgroup</a> ä¸­æˆ‘ä»¬æåˆ°äº†ç­‰å¾…å¤šä¸ª goroutine åä½œçš„æ–¹å¼ï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨æƒ³ä¸€ä¸‹è¿™ä¹ˆä¸€ä¸ªå¸¸è§çš„åœºæ™¯ã€‚ç°åœ¨æœ‰ä¸€ä¸ª Server æœåŠ¡åœ¨æ‰§è¡Œï¼Œå½“è¯·æ±‚æ¥çš„æ—¶å€™æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ª goroutine å»å¤„ç†ï¼Œç„¶ååœ¨è¿™ä¸ª goroutine å½“ä¸­æœ‰å¯¹ä¸‹æ¸¸æœåŠ¡çš„ rpc è°ƒç”¨ï¼Œä¹Ÿä¼šå»è¯·æ±‚æ•°æ®åº“è·å–ä¸€äº›æ•°æ®ï¼Œè¿™æ—¶å€™å¦‚æœä¸‹æ¸¸ä¾èµ–çš„æœåŠ¡æ¯”è¾ƒæ…¢ï¼Œä½†æ˜¯åˆæ²¡æŒ‚ï¼Œåªæ˜¯å¾ˆæ…¢ï¼Œå¯èƒ½ä¸€æ¬¡è°ƒç”¨è¦ 1min æ‰èƒ½è¿”å›ç»“æœï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œé¦–å…ˆå‡è®¾æˆ‘ä»¬ä½¿ç”¨ WaitGroup è¿›è¡Œæ§åˆ¶ï¼Œç­‰å¾…æ‰€æœ‰çš„ goroutine å¤„ç†å®Œæˆä¹‹åè¿”å›ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å®é™…çš„è€—æ—¶è¿œè¿œå¤§äºäº†ç”¨æˆ·å¯ä»¥å®¹å¿çš„æ—¶é—´ã€‚<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1610027116078-2e1368bf-015e-4459-8517-73dc858ed083.svg" alt="02_Goè¿›é˜¶03_blog_context.drawio.svg"><br>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå†è€ƒè™‘ä¸€ä¸ªå¸¸è§çš„åœºæ™¯ï¼Œä¸‡ä¸€ä¸Šé¢çš„ rpc goroutine å¾ˆæ—©å°±æŠ¥é”™äº†ï¼Œä½†æ˜¯ ä¸‹é¢çš„ db goroutine åˆæ‰§è¡Œäº†å¾ˆä¹…ï¼Œæˆ‘ä»¬æœ€åè¦è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œå¾ˆæ˜æ˜¾åé¢ db goroutine æ‰§è¡Œçš„è¿™æ®µæ—¶é—´éƒ½æ˜¯åœ¨ç™½ç™½çš„æµªè´¹ç”¨æˆ·çš„æ—¶é—´ã€‚<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1610027303842-4272e9a1-af9c-4804-a779-f72c1f82a1a0.svg" alt="02_Goè¿›é˜¶03_blog_context.drawio.svg"></p><p>è¿™æ—¶å€™å°±åº”è¯¥è¯·å‡º context åŒ…äº†ï¼Œ<strong>context ä¸»è¦å°±æ˜¯ç”¨æ¥åœ¨å¤šä¸ª goroutine ä¸­è®¾ç½®æˆªæ­¢æ—¥æœŸã€åŒæ­¥ä¿¡å·ï¼Œä¼ é€’è¯·æ±‚ç›¸å…³å€¼ã€‚</strong><br><strong>æ¯ä¸€æ¬¡ context éƒ½ä¼šä»é¡¶å±‚ä¸€å±‚ä¸€å±‚çš„ä¼ é€’åˆ°ä¸‹é¢ä¸€å±‚çš„ goroutine å½“ä¸Šé¢çš„ context å–æ¶ˆçš„æ—¶å€™ï¼Œä¸‹é¢æ‰€æœ‰çš„ context ä¹Ÿä¼šéšä¹‹å–æ¶ˆã€‚</strong><br>**<br>ä¸Šé¢çš„ä¾‹å­å½“ä¸­ï¼Œå¦‚æœå¼•å…¥ context åå°±ä¼šæ˜¯è¿™æ ·ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œcontext ä¼šç±»ä¼¼ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ä¸€æ ·ä¾é™„åœ¨æ¯ä¸ª goroutine ä¸Šï¼Œå½“ä¸Šå±‚çš„ req goroutine çš„ context è¶…æ—¶ä¹‹åå°±ä¼šå°†å–æ¶ˆä¿¡å·åŒæ­¥åˆ°ä¸‹é¢çš„æ‰€æœ‰ goroutine ä¸Šä¸€èµ·è¿”å›ï¼Œä»è€Œè¾¾åˆ°è¶…æ—¶æ§åˆ¶çš„ä½œç”¨<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1610027726018-4ff7389e-ec4a-4107-99ac-493f587f2a88.svg" alt="02_Goè¿›é˜¶03_blog_context.drawio.svg"><br>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå½“ rpc è°ƒç”¨å¤±è´¥ä¹‹åï¼Œä¼šå‡ºå‘ context å–æ¶ˆï¼Œç„¶åè¿™ä¸ªå–æ¶ˆä¿¡å·å°±ä¼šåŒæ­¥åˆ°å…¶ä»–çš„ goroutine å½“ä¸­<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1610027762059-43c810a8-619e-4f8d-ad74-7a2767635aa0.svg" alt="02_Goè¿›é˜¶03_blog_context.drawio.svg"></p><h2 id="package-context"><a href="#package-context" class="headerlink" title="package context"></a>package context</h2><h3 id="ä½¿ç”¨è¯´æ˜"><a href="#ä½¿ç”¨è¯´æ˜" class="headerlink" title="ä½¿ç”¨è¯´æ˜"></a>ä½¿ç”¨è¯´æ˜</h3><p>åœ¨ä½¿ç”¨ä¸€ä¸ªæ–°çš„åº“çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸€èˆ¬éœ€è¦å…ˆçœ‹å®ƒçš„å®˜æ–¹è¯´æ˜ï¼Œå¾—ç›Šäº godoc çš„çº¦æŸï¼Œæ‰€ä»¥æ ‡å‡†åº“å’Œç¬¬ä¸‰æ–¹åº“çš„æ–‡æ¡£éƒ½å¯ä»¥é€šè¿‡ <a href="https://pkg.go.dev">pkg.go.dev</a> è¿›è¡Œæœç´¢æŸ¥è¯¢</p><h4 id="ä½¿ç”¨å‡†åˆ™"><a href="#ä½¿ç”¨å‡†åˆ™" class="headerlink" title="ä½¿ç”¨å‡†åˆ™"></a>ä½¿ç”¨å‡†åˆ™</h4><p>context åŒ…ä¸€å¼€å§‹å°±å‘Šè¯‰äº†æˆ‘ä»¬åº”è¯¥æ€ä¹ˆç”¨ï¼Œä¸åº”è¯¥æ€ä¹ˆç”¨ï¼Œè¿™æ˜¯åº”è¯¥è¢«å…±åŒéµå®ˆçš„çº¦å®šã€‚</p><ul><li>å¯¹ server åº”ç”¨è€Œè¨€ï¼Œä¼ å…¥çš„è¯·æ±‚åº”è¯¥åˆ›å»ºä¸€ä¸ª contextï¼Œæ¥å—</li><li>é€šè¿‡ <code>WithCancel</code> , <code>WithDeadline</code> , <code>WithTimeout</code>  åˆ›å»ºçš„ Context ä¼šåŒæ—¶è¿”å›ä¸€ä¸ª cancel æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¿…é¡»è¦è¢«æ‰§è¡Œï¼Œä¸ç„¶ä¼šå¯¼è‡´ context æ³„æ¼ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡æ‰§è¡Œ <code>go vet</code>  å‘½ä»¤è¿›è¡Œæ£€æŸ¥</li><li>åº”è¯¥å°† <code>context.Context</code>  ä½œä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œä¼ é€’ï¼Œå‚æ•°å‘½åä¸€èˆ¬ä¸º <code>ctx</code>  ä¸åº”è¯¥å°† Context ä½œä¸ºå­—æ®µæ”¾åœ¨ç»“æ„ä½“ä¸­ã€‚</li><li>ä¸è¦ç»™ context ä¼ é€’ nilï¼Œå¦‚æœä½ ä¸çŸ¥é“åº”è¯¥ä¼ ä»€ä¹ˆçš„æ—¶å€™å°±ä¼ é€’ <code>context.TODO()</code></li><li>ä¸è¦å°†å‡½æ•°çš„å¯é€‰å‚æ•°æ”¾åœ¨ context å½“ä¸­ï¼Œcontext ä¸­ä¸€èˆ¬åªæ”¾ä¸€äº›å…¨å±€é€šç”¨çš„ metadata æ•°æ®ï¼Œä¾‹å¦‚ tracing id ç­‰ç­‰</li><li>context æ˜¯å¹¶å‘å®‰å…¨çš„å¯ä»¥åœ¨å¤šä¸ª goroutine ä¸­å¹¶å‘è°ƒç”¨</li></ul><h4 id="å‡½æ•°ç­¾å"><a href="#å‡½æ•°ç­¾å" class="headerlink" title="å‡½æ•°ç­¾å"></a>å‡½æ•°ç­¾å</h4><p>context åŒ…æš´éœ²çš„æ–¹æ³•ä¸å¤šï¼Œçœ‹ä¸‹æ–¹è¯´æ˜å³å¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå¸¦æœ‰æ–°çš„ Done channel çš„ contextï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªå–æ¶ˆçš„æ–¹æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithCancel</span><span class="hljs-params">(parent Context)</span> <span class="hljs-params">(ctx Context, cancel CancelFunc)</span></span><br><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå…·æœ‰æˆªæ­¢æ—¶é—´çš„ context</span><br><span class="hljs-comment">// æˆªæ­¢æ—¶é—´æ˜¯ d å’Œ parent(å¦‚æœæœ‰æˆªæ­¢æ—¶é—´çš„è¯) çš„æˆªæ­¢æ—¶é—´ä¸­æ›´æ—©çš„é‚£ä¸€ä¸ª</span><br><span class="hljs-comment">// å½“ parent æ‰§è¡Œå®Œæ¯•ï¼Œæˆ– cancel è¢«è°ƒç”¨ æˆ–è€… æˆªæ­¢æ—¶é—´åˆ°äº†çš„æ—¶å€™ï¼Œè¿™ä¸ª context done æ‰</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithDeadline</span><span class="hljs-params">(parent Context, d time.Time)</span> <span class="hljs-params">(Context, CancelFunc)</span></span><br><span class="hljs-comment">// å…¶å®å°±æ˜¯è°ƒç”¨çš„ WithDeadline</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithTimeout</span><span class="hljs-params">(parent Context, timeout time.Duration)</span> <span class="hljs-params">(Context, CancelFunc)</span></span><br><span class="hljs-keyword">type</span> CancelFunc<br><span class="hljs-keyword">type</span> Context<br><span class="hljs-comment">// ä¸€èˆ¬ç”¨äºåˆ›å»º root contextï¼Œè¿™ä¸ª context æ°¸è¿œä¹Ÿä¸ä¼šè¢«å–æ¶ˆï¼Œæˆ–è€…æ˜¯ done</span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Background</span><span class="hljs-params">()</span> <span class="hljs-title">Context</span></span><br><span class="hljs-comment">// åº•å±‚å’Œ Background ä¸€è‡´ï¼Œä½†æ˜¯å«ä¹‰ä¸åŒï¼Œå½“ä¸æ¸…æ¥šç”¨ä»€ä¹ˆçš„æ—¶å€™æˆ–è€…æ˜¯è¿˜æ²¡å‡†å¤‡å¥½çš„æ—¶å€™å¯ä»¥ç”¨å®ƒ</span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TODO</span><span class="hljs-params">()</span> <span class="hljs-title">Context</span></span><br><span class="hljs-comment">// ä¸º context é™„åŠ å€¼</span><br><span class="hljs-comment">// key åº”è¯¥å…·æœ‰å¯æ¯”æ€§ï¼Œä¸€èˆ¬ä¸åº”è¯¥æ˜¯ string int è¿™ç§é»˜è®¤ç±»å‹ï¼Œåº”è¯¥è‡ªå·±åˆ›å»ºä¸€ä¸ªç±»å‹</span><br><span class="hljs-comment">// é¿å…å‡ºç°å†²çªï¼Œä¸€èˆ¬ key ä¸åº”è¯¥å¯¼å‡ºï¼Œå¦‚æœè¦å¯¼å‡ºçš„è¯åº”è¯¥æ˜¯ä¸€ä¸ªæ¥å£æˆ–è€…æ˜¯æŒ‡é’ˆ</span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithValue</span><span class="hljs-params">(parent Context, key, val <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">Context</span></span><br></code></pre></td></tr></table></figure><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="context-Context-æ¥å£"><a href="#context-Context-æ¥å£" class="headerlink" title="context.Context æ¥å£"></a>context.Context æ¥å£</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Context <span class="hljs-keyword">interface</span> &#123;<br>    <span class="hljs-comment">// è¿”å›å½“å‰ context çš„ç»“æŸæ—¶é—´ï¼Œå¦‚æœ ok = false è¯´æ˜å½“å‰ context æ²¡æœ‰è®¾ç½®ç»“æŸæ—¶é—´</span><br>Deadline() (deadline time.Time, ok <span class="hljs-keyword">bool</span>)<br>    <span class="hljs-comment">// è¿”å›ä¸€ä¸ª channelï¼Œç”¨äºåˆ¤æ–­ context æ˜¯å¦ç»“æŸï¼Œå¤šæ¬¡è°ƒç”¨åŒä¸€ä¸ª context done æ–¹æ³•ä¼šè¿”å›ç›¸åŒçš„ channel</span><br>Done() &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;<br>    <span class="hljs-comment">// å½“ context ç»“æŸæ—¶æ‰ä¼šè¿”å›é”™è¯¯ï¼Œæœ‰ä¸¤ç§æƒ…å†µ</span><br>    <span class="hljs-comment">// context è¢«ä¸»åŠ¨è°ƒç”¨ cancel æ–¹æ³•å–æ¶ˆï¼šCanceled</span><br>    <span class="hljs-comment">// context è¶…æ—¶å–æ¶ˆ: DeadlineExceeded</span><br>Err() error<br>    <span class="hljs-comment">// ç”¨äºè¿”å› context ä¸­ä¿å­˜çš„å€¼, å¦‚ä½•æŸ¥æ‰¾ï¼Œè¿™ä¸ªåé¢ä¼šè®²åˆ°</span><br>Value(key <span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="é»˜è®¤ä¸Šä¸‹æ–‡-context-Backgroud"><a href="#é»˜è®¤ä¸Šä¸‹æ–‡-context-Backgroud" class="headerlink" title="é»˜è®¤ä¸Šä¸‹æ–‡: context.Backgroud"></a>é»˜è®¤ä¸Šä¸‹æ–‡: context.Backgroud</h4><p><strong>Backgroud()ï¼Œ</strong>åœ¨å‰é¢æœ‰è®²åˆ°ï¼Œ  ä¸€èˆ¬ç”¨äºåˆ›å»º root contextï¼Œè¿™ä¸ª context æ°¸è¿œä¹Ÿä¸ä¼šè¢«å–æ¶ˆï¼Œæˆ–è¶…æ—¶<br><strong>TODO()ï¼Œ </strong>åº•å±‚å’Œ Background ä¸€è‡´ï¼Œä½†æ˜¯å«ä¹‰ä¸åŒï¼Œå½“ä¸æ¸…æ¥šç”¨ä»€ä¹ˆçš„æ—¶å€™æˆ–è€…æ˜¯è¿˜æ²¡å‡†å¤‡å¥½çš„æ—¶å€™å¯ä»¥ç”¨å®ƒ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> (<br>background = <span class="hljs-built_in">new</span>(emptyCtx)<br>todo       = <span class="hljs-built_in">new</span>(emptyCtx)<br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Background</span><span class="hljs-params">()</span> <span class="hljs-title">Context</span></span> &#123;<br><span class="hljs-keyword">return</span> background<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TODO</span><span class="hljs-params">()</span> <span class="hljs-title">Context</span></span> &#123;<br><span class="hljs-keyword">return</span> todo<br>&#125;<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹æºç æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œbackground å’Œ todo éƒ½æ˜¯å®ä¾‹åŒ–äº†ä¸€ä¸ª emptyCtx</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> emptyCtx <span class="hljs-keyword">int</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(*emptyCtx)</span> <span class="hljs-title">Deadline</span><span class="hljs-params">()</span> <span class="hljs-params">(deadline time.Time, ok <span class="hljs-keyword">bool</span>)</span></span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(*emptyCtx)</span> <span class="hljs-title">Done</span><span class="hljs-params">()</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">struct</span></span>&#123;&#125; &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(*emptyCtx)</span> <span class="hljs-title">Err</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(*emptyCtx)</span> <span class="hljs-title">Value</span><span class="hljs-params">(key <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>emptyCtx å°±å¦‚åŒä»–çš„åå­—ä¸€æ ·ï¼Œå…¨éƒ½è¿”å›ç©ºå€¼</p><h4 id="å¦‚ä½•å–æ¶ˆ-context-WithCancel"><a href="#å¦‚ä½•å–æ¶ˆ-context-WithCancel" class="headerlink" title="å¦‚ä½•å–æ¶ˆ context : WithCancel"></a>å¦‚ä½•å–æ¶ˆ context : WithCancel</h4><p><strong>WithCancel(),</strong> æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ªå¯ä»¥å–æ¶ˆçš„ context</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithCancel</span><span class="hljs-params">(parent Context)</span> <span class="hljs-params">(ctx Context, cancel CancelFunc)</span></span> &#123;<br><span class="hljs-keyword">if</span> parent == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;cannot create context from nil parent&quot;</span>)<br>&#125;<br>    <span class="hljs-comment">// åŒ…è£…å‡ºæ–°çš„ cancelContext</span><br>c := newCancelCtx(parent)<br>    <span class="hljs-comment">// æ„å»ºçˆ¶å­ä¸Šä¸‹æ–‡çš„è”ç³»ï¼Œç¡®ä¿å½“çˆ¶ Context å–æ¶ˆçš„æ—¶å€™ï¼Œå­ Context ä¹Ÿä¼šè¢«å–æ¶ˆ</span><br>propagateCancel(parent, &amp;c)<br><span class="hljs-keyword">return</span> &amp;c, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; c.cancel(<span class="hljs-literal">true</span>, Canceled) &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸æ­¢ WithCancel æ–¹æ³•ï¼Œå…¶ä»–çš„ WithXXX æ–¹æ³•ä¹Ÿä¸å…è®¸ä¼ å…¥ä¸€ä¸ª nil å€¼çš„çˆ¶ context<br><code>newCancelCtx</code>  åªæ˜¯ä¸€ä¸ªç®€å•çš„åŒ…è£…å°±ä¸å±•å¼€äº†ï¼Œ <code>propagateCancel</code>  æ¯”è¾ƒæœ‰æ„æ€ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">propagateCancel</span><span class="hljs-params">(parent Context, child canceler)</span></span> &#123;<br><span class="hljs-comment">// é¦–å…ˆåˆ¤æ–­ parent èƒ½ä¸èƒ½è¢«å–æ¶ˆ</span><br>    done := parent.Done()<br><span class="hljs-keyword">if</span> done == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-comment">// parent is never canceled</span><br>&#125;<br><br>    <span class="hljs-comment">// å¦‚æœå¯ä»¥ï¼Œçœ‹ä¸€ä¸‹ parent æ˜¯ä¸æ˜¯å·²ç»è¢«å–æ¶ˆäº†ï¼Œå·²ç»è¢«å–æ¶ˆçš„æƒ…å†µä¸‹ç›´æ¥å–æ¶ˆ å­ context</span><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-done:<br><span class="hljs-comment">// parent is already canceled</span><br>child.cancel(<span class="hljs-literal">false</span>, parent.Err())<br><span class="hljs-keyword">return</span><br><span class="hljs-keyword">default</span>:<br>&#125;<br><br>    <span class="hljs-comment">// è¿™é‡Œæ˜¯å‘ä¸ŠæŸ¥æ‰¾å¯ä»¥è¢«å–æ¶ˆçš„ parent context</span><br><span class="hljs-keyword">if</span> p, ok := parentCancelCtx(parent); ok &#123;<br>        <span class="hljs-comment">// å¦‚æœæ‰¾åˆ°äº†å¹¶ä¸”æ²¡æœ‰è¢«å–æ¶ˆçš„è¯å°±æŠŠè¿™ä¸ªå­ context æŒ‚è½½åˆ°è¿™ä¸ª parent context ä¸Š</span><br>        <span class="hljs-comment">// è¿™æ ·åªè¦ parent context å–æ¶ˆäº†å­ context ä¹Ÿä¼šè·Ÿç€è¢«å–æ¶ˆ</span><br>p.mu.Lock()<br><span class="hljs-keyword">if</span> p.err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// parent has already been canceled</span><br>child.cancel(<span class="hljs-literal">false</span>, p.err)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> p.children == <span class="hljs-literal">nil</span> &#123;<br>p.children = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[canceler]<span class="hljs-keyword">struct</span>&#123;&#125;)<br>&#125;<br>p.children[child] = <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>&#125;<br>p.mu.Unlock()<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å¦‚æœæ²¡æœ‰æ‰¾åˆ°çš„è¯å°±ä¼šå¯åŠ¨ä¸€ä¸ª goroutine å»ç›‘å¬ parent context çš„å–æ¶ˆ channel</span><br>        <span class="hljs-comment">// æ”¶åˆ°å–æ¶ˆä¿¡å·ä¹‹åå†å»è°ƒç”¨ å­ context çš„ cancel æ–¹æ³•</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-parent.Done():<br>child.cancel(<span class="hljs-literal">false</span>, parent.Err())<br><span class="hljs-keyword">case</span> &lt;-child.Done():<br>&#125;<br>&#125;()<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹çœ‹ cancelCtx é•¿å•¥æ ·</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> cancelCtx <span class="hljs-keyword">struct</span> &#123;<br>Context <span class="hljs-comment">// è¿™é‡Œä¿å­˜çš„æ˜¯çˆ¶ Context</span><br><br>mu       sync.Mutex            <span class="hljs-comment">// äº’æ–¥é”</span><br>done     <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;         <span class="hljs-comment">// å…³é—­ä¿¡å·</span><br>children <span class="hljs-keyword">map</span>[canceler]<span class="hljs-keyword">struct</span>&#123;&#125; <span class="hljs-comment">// ä¿å­˜æ‰€æœ‰çš„å­ contextï¼Œå½“å–æ¶ˆçš„æ—¶å€™ä¼šè¢«è®¾ç½®ä¸º nil</span><br>err      error<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ Done æ–¹æ³•è¿™é‡Œé‡‡ç”¨äº† æ‡’æ±‰å¼åŠ è½½çš„æ–¹å¼ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™æ‰ä¼šå»åˆ›å»ºè¿™ä¸ª channel</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *cancelCtx)</span> <span class="hljs-title">Done</span><span class="hljs-params">()</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">struct</span></span>&#123;&#125; &#123;<br>c.mu.Lock()<br><span class="hljs-keyword">if</span> c.done == <span class="hljs-literal">nil</span> &#123;<br>c.done = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br>&#125;<br>d := c.done<br>c.mu.Unlock()<br><span class="hljs-keyword">return</span> d<br>&#125;<br></code></pre></td></tr></table></figure><p>Value æ–¹æ³•å¾ˆæœ‰æ„æ€ï¼Œè¿™é‡Œç›¸å½“äºæ˜¯å†…éƒ¨ <code>cancelCtxKey</code>  è¿™ä¸ªå˜é‡çš„åœ°å€ä½œä¸ºäº†ä¸€ä¸ªç‰¹æ®Šçš„ keyï¼Œå½“æŸ¥è¯¢è¿™ä¸ª key çš„æ—¶å€™å°±ä¼šè¿”å›å½“å‰ context å¦‚æœä¸æ˜¯è¿™ä¸ª key å°±ä¼šå‘ä¸Šé€’å½’çš„å»è°ƒç”¨ parent context çš„ Value æ–¹æ³•æŸ¥æ‰¾æœ‰æ²¡æœ‰å¯¹åº”çš„å€¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *cancelCtx)</span> <span class="hljs-title">Value</span><span class="hljs-params">(key <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;<br><span class="hljs-keyword">if</span> key == &amp;cancelCtxKey &#123;<br><span class="hljs-keyword">return</span> c<br>&#125;<br><span class="hljs-keyword">return</span> c.Context.Value(key)<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨å‰é¢è®²åˆ°æ„å»ºçˆ¶å­ä¸Šä¸‹æ–‡ä¹‹é—´çš„å…³ç³»çš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªå»æŸ¥æ‰¾å¯ä»¥è¢«å–æ¶ˆçš„çˆ¶ context çš„æ–¹æ³• <code>parentCancelCtx</code>  å°±ç”¨åˆ°äº†è¿™ä¸ªç‰¹æ®Š value</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">parentCancelCtx</span><span class="hljs-params">(parent Context)</span> <span class="hljs-params">(*cancelCtx, <span class="hljs-keyword">bool</span>)</span></span> &#123;<br>    <span class="hljs-comment">// è¿™é‡Œå…ˆåˆ¤æ–­ä¼ å…¥çš„ parent æ˜¯ä¸æ˜¯æ°¸è¿œä¸å¯å–æ¶ˆçš„ï¼Œå¦‚æœæ˜¯å°±ç›´æ¥è¿”å›äº†</span><br>done := parent.Done()<br><span class="hljs-keyword">if</span> done == closedchan || done == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span><br>&#125;<br><br>    <span class="hljs-comment">// è¿™é‡Œåˆ©ç”¨äº† context.Value ä¸æ–­å‘ä¸ŠæŸ¥è¯¢å€¼çš„ç‰¹ç‚¹ï¼Œåªè¦å‡ºç°ç¬¬ä¸€ä¸ªå¯ä»¥å–æ¶ˆçš„ context çš„æ—¶å€™å°±ä¼šè¿”å›</span><br>    <span class="hljs-comment">// å¦‚æœæ²¡æœ‰çš„è¯ï¼Œè¿™æ—¶å€™ ok å°±ä¼šç­‰äº false</span><br>p, ok := parent.Value(&amp;cancelCtxKey).(*cancelCtx)<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span><br>&#125;<br>    <span class="hljs-comment">// è¿™é‡Œå»åˆ¤æ–­è¿”å›çš„ parent çš„ channel å’Œä¼ å…¥çš„ parent æ˜¯ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ˜¯çš„è¯å°±è¿”å›è¿™ä¸ª parent</span><br>p.mu.Lock()<br>ok = p.done == done<br>p.mu.Unlock()<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">return</span> p, <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹æœ€é‡è¦çš„è¿™ä¸ª cancel æ–¹æ³•ï¼Œcancel æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼ŒremoveFromParent ç”¨äºç¡®è®¤æ˜¯ä¸æ˜¯æŠŠè‡ªå·±ä» parent context ä¸­ç§»é™¤ï¼Œerr æ˜¯ ctx.Err() æœ€åè¿”å›çš„é”™è¯¯ä¿¡æ¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *cancelCtx)</span> <span class="hljs-title">cancel</span><span class="hljs-params">(removeFromParent <span class="hljs-keyword">bool</span>, err error)</span></span> &#123;<br><span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;context: internal error: missing cancel error&quot;</span>)<br>&#125;<br>c.mu.Lock()<br><span class="hljs-keyword">if</span> c.err != <span class="hljs-literal">nil</span> &#123;<br>c.mu.Unlock()<br><span class="hljs-keyword">return</span> <span class="hljs-comment">// already canceled</span><br>&#125;<br>c.err = err<br>    <span class="hljs-comment">// ç”±äº cancel context çš„ done æ˜¯æ‡’åŠ è½½çš„ï¼Œæ‰€ä»¥æœ‰å¯èƒ½å­˜åœ¨è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„æƒ…å†µ</span><br><span class="hljs-keyword">if</span> c.done == <span class="hljs-literal">nil</span> &#123;<br>c.done = closedchan<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-built_in">close</span>(c.done)<br>&#125;<br>    <span class="hljs-comment">// å¾ªç¯çš„å°†æ‰€æœ‰çš„å­ context å–æ¶ˆæ‰</span><br><span class="hljs-keyword">for</span> child := <span class="hljs-keyword">range</span> c.children &#123;<br><span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> acquiring the child&#x27;s lock while holding parent&#x27;s lock.</span><br>child.cancel(<span class="hljs-literal">false</span>, err)<br>&#125;<br>    <span class="hljs-comment">// å°†æ‰€æœ‰çš„å­ context å’Œå½“å‰ context å…³ç³»è§£é™¤</span><br>c.children = <span class="hljs-literal">nil</span><br>c.mu.Unlock()<br><br>    <span class="hljs-comment">// å¦‚æœéœ€è¦å°†å½“å‰ context ä» parent context ç§»é™¤ï¼Œå°±ç§»é™¤æ‰</span><br><span class="hljs-keyword">if</span> removeFromParent &#123;<br>removeChild(c.Context, c)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="è¶…æ—¶è‡ªåŠ¨å–æ¶ˆå¦‚ä½•å®ç°-WithDeadline-WithTimeout"><a href="#è¶…æ—¶è‡ªåŠ¨å–æ¶ˆå¦‚ä½•å®ç°-WithDeadline-WithTimeout" class="headerlink" title="è¶…æ—¶è‡ªåŠ¨å–æ¶ˆå¦‚ä½•å®ç°: WithDeadline, WithTimeout"></a>è¶…æ—¶è‡ªåŠ¨å–æ¶ˆå¦‚ä½•å®ç°: WithDeadline, WithTimeout</h4><p>æˆ‘ä»¬å…ˆçœ‹çœ‹æ¯”è¾ƒå¸¸ç”¨çš„ WithTimeout, å¯ä»¥å‘ç° WithTimeout å…¶å®å°±æ˜¯è°ƒç”¨äº† WithDeadline ç„¶åå†ä¼ å…¥çš„å‚æ•°ä¸Šç”¨å½“å‰æ—¶é—´åŠ ä¸Šäº† timeout çš„æ—¶é—´</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithTimeout</span><span class="hljs-params">(parent Context, timeout time.Duration)</span> <span class="hljs-params">(Context, CancelFunc)</span></span> &#123;<br><span class="hljs-keyword">return</span> WithDeadline(parent, time.Now().Add(timeout))<br>&#125;<br></code></pre></td></tr></table></figure><p>å†æ¥çœ‹ä¸€ä¸‹å®ç°è¶…æ—¶çš„ timerCtxï¼ŒWithDeadline æˆ‘ä»¬æ”¾åˆ°åé¢ä¸€ç‚¹ç‚¹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> timerCtx <span class="hljs-keyword">struct</span> &#123;<br>cancelCtx <span class="hljs-comment">// è¿™é‡Œå¤ç”¨äº† cancelCtx</span><br>timer *time.Timer <span class="hljs-comment">// Under cancelCtx.mu.</span><br><br>deadline time.Time <span class="hljs-comment">// è¿™é‡Œä¿å­˜äº†å¿«åˆ°æœŸçš„æ—¶é—´</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>Deadline()</code>  å°±æ˜¯è¿”å›äº†ç»“æ„ä½“ä¸­ä¿å­˜çš„è¿‡æœŸæ—¶é—´</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *timerCtx)</span> <span class="hljs-title">Deadline</span><span class="hljs-params">()</span> <span class="hljs-params">(deadline time.Time, ok <span class="hljs-keyword">bool</span>)</span></span> &#123;<br><span class="hljs-keyword">return</span> c.deadline, <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>cancel</code>  å…¶å®å°±æ˜¯å¤ç”¨äº† cancelCtx ä¸­çš„å–æ¶ˆæ–¹æ³•ï¼Œå”¯ä¸€åŒºåˆ«çš„åœ°æ–¹å°±æ˜¯åœ¨åé¢åŠ ä¸Šäº†å¯¹ timer çš„åˆ¤æ–­ï¼Œå¦‚æœ timer æ²¡æœ‰ç»“æŸä¸»åŠ¨ç»“æŸ timer</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *timerCtx)</span> <span class="hljs-title">cancel</span><span class="hljs-params">(removeFromParent <span class="hljs-keyword">bool</span>, err error)</span></span> &#123;<br>c.cancelCtx.cancel(<span class="hljs-literal">false</span>, err)<br><span class="hljs-keyword">if</span> removeFromParent &#123;<br><span class="hljs-comment">// Remove this timerCtx from its parent cancelCtx&#x27;s children.</span><br>removeChild(c.cancelCtx.Context, c)<br>&#125;<br>c.mu.Lock()<br><span class="hljs-keyword">if</span> c.timer != <span class="hljs-literal">nil</span> &#123;<br>c.timer.Stop()<br>c.timer = <span class="hljs-literal">nil</span><br>&#125;<br>c.mu.Unlock()<br>&#125;<br></code></pre></td></tr></table></figure><p>timerCtx å¹¶æ²¡æœ‰é‡æ–°å®ç° Done() å’Œ Value æ–¹æ³•ï¼Œç›´æ¥å¤ç”¨äº† cancelCtx çš„ç›¸å…³æ–¹æ³•</p><p>æœ€åæˆ‘ä»¬å†çœ‹çœ‹è¿™ä¸ªæœ€é‡è¦çš„ WithDeadline æ–¹æ³•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithDeadline</span><span class="hljs-params">(parent Context, d time.Time)</span> <span class="hljs-params">(Context, CancelFunc)</span></span> &#123;<br><span class="hljs-keyword">if</span> parent == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;cannot create context from nil parent&quot;</span>)<br>&#125;<br><br>   <span class="hljs-comment">// ä¼šå…ˆåˆ¤æ–­ parent context çš„è¿‡æœŸæ—¶é—´ï¼Œå¦‚æœè¿‡æœŸæ—¶é—´æ¯”å½“å‰ä¼ å…¥çš„æ—¶é—´è¦æ—©çš„è¯ï¼Œå°±æ²¡æœ‰å¿…è¦å†è®¾ç½®è¿‡æœŸæ—¶é—´äº†</span><br>    <span class="hljs-comment">// åªéœ€è¦è¿”å› WithCancel å°±å¯ä»¥äº†ï¼Œå› ä¸ºåœ¨ parent è¿‡æœŸçš„æ—¶å€™ï¼Œå­ context ä¹Ÿä¼šè¢«å–æ¶ˆæ‰</span><br><span class="hljs-keyword">if</span> cur, ok := parent.Deadline(); ok &amp;&amp; cur.Before(d) &#123;<br><span class="hljs-comment">// The current deadline is already sooner than the new one.</span><br><span class="hljs-keyword">return</span> WithCancel(parent)<br>&#125;<br><br>    <span class="hljs-comment">// æ„é€ ç›¸å…³ç»“æ„ä½“</span><br>c := &amp;timerCtx&#123;<br>cancelCtx: newCancelCtx(parent),<br>deadline:  d,<br>&#125;<br><br>    <span class="hljs-comment">// å’Œ WithCancel ä¸­çš„é€»è¾‘ç›¸åŒï¼Œæ„å»ºä¸Šä¸‹æ–‡å…³ç³»</span><br>propagateCancel(parent, c)<br><br>    <span class="hljs-comment">// åˆ¤æ–­ä¼ å…¥çš„æ—¶é—´æ˜¯ä¸æ˜¯å·²ç»è¿‡æœŸï¼Œå¦‚æœå·²ç»è¿‡æœŸäº†å°± cancel æ‰ç„¶åå†è¿”å›</span><br>dur := time.Until(d)<br><span class="hljs-keyword">if</span> dur &lt;= <span class="hljs-number">0</span> &#123;<br>c.cancel(<span class="hljs-literal">true</span>, DeadlineExceeded) <span class="hljs-comment">// deadline has already passed</span><br><span class="hljs-keyword">return</span> c, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; c.cancel(<span class="hljs-literal">false</span>, Canceled) &#125;<br>&#125;<br>c.mu.Lock()<br><span class="hljs-keyword">defer</span> c.mu.Unlock()<br><br>    <span class="hljs-comment">// è¿™é‡Œæ˜¯è¶…æ—¶å–æ¶ˆçš„é€»è¾‘ï¼Œå¯åŠ¨ timer æ—¶é—´åˆ°äº†ä¹‹åå°±ä¼šè°ƒç”¨å–æ¶ˆæ–¹æ³•</span><br><span class="hljs-keyword">if</span> c.err == <span class="hljs-literal">nil</span> &#123;<br>c.timer = time.AfterFunc(dur, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>c.cancel(<span class="hljs-literal">true</span>, DeadlineExceeded)<br>&#125;)<br>&#125;<br><span class="hljs-keyword">return</span> c, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; c.cancel(<span class="hljs-literal">true</span>, Canceled) &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°è¶…æ—¶æ§åˆ¶å…¶å®å°±æ˜¯åœ¨å¤ç”¨ cancelCtx çš„åŸºç¡€ä¸ŠåŠ ä¸Šäº†ä¸€ä¸ª timer æ¥åšå®šæ—¶å–æ¶ˆ</p><h4 id="å¦‚ä½•ä¸º-Context-é™„åŠ ä¸€äº›å€¼-WithValue"><a href="#å¦‚ä½•ä¸º-Context-é™„åŠ ä¸€äº›å€¼-WithValue" class="headerlink" title="å¦‚ä½•ä¸º Context é™„åŠ ä¸€äº›å€¼: WithValue"></a>å¦‚ä½•ä¸º Context é™„åŠ ä¸€äº›å€¼: WithValue</h4><p>WithValue ç›¸å¯¹ç®€å•ä¸€ç‚¹ï¼Œä¸»è¦å°±æ˜¯æ ¡éªŒäº†ä¸€ä¸‹ Key æ˜¯ä¸æ˜¯å¯æ¯”è¾ƒçš„ï¼Œç„¶åæ„é€ å‡ºä¸€ä¸ª valueCtx çš„ç»“æ„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithValue</span><span class="hljs-params">(parent Context, key, val <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">Context</span></span> &#123;<br><span class="hljs-keyword">if</span> parent == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;cannot create context from nil parent&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> key == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;nil key&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> !reflectlite.TypeOf(key).Comparable() &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;key is not comparable&quot;</span>)<br>&#125;<br><span class="hljs-keyword">return</span> &amp;valueCtx&#123;parent, key, val&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>valueCtx ä¸»è¦å°±æ˜¯åµŒå…¥äº† parent context ç„¶åé™„åŠ äº†ä¸€ä¸ª key val</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> valueCtx <span class="hljs-keyword">struct</span> &#123;<br>Context<br>key, val <span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Value çš„æŸ¥æ‰¾å’Œä¹‹å‰ cancelCtx ç±»ä¼¼ï¼Œéƒ½æ˜¯å…ˆåˆ¤æ–­å½“å‰æœ‰æ²¡æœ‰ï¼Œæ²¡æœ‰å°±å‘ä¸Šé€’å½’ï¼Œåªæ˜¯åœ¨ cancelCtx å½“ä¸­ key æ˜¯ä¸€ä¸ªå›ºå®šçš„ key è€Œå·²</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *valueCtx)</span> <span class="hljs-title">Value</span><span class="hljs-params">(key <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;<br><span class="hljs-keyword">if</span> c.key == key &#123;<br><span class="hljs-keyword">return</span> c.val<br>&#125;<br><span class="hljs-keyword">return</span> c.Context.Value(key)<br>&#125;<br></code></pre></td></tr></table></figure><p>Value å°±æ²¡æœ‰å®ç° Context æ¥å£çš„å…¶ä»–æ–¹æ³•äº†ï¼Œå…¶ä»–çš„æ–¹æ³•å…¨éƒ½æ˜¯å¤ç”¨çš„ parent context çš„æ–¹æ³•</p><h3 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h3><h4 id="è¶…æ—¶æ§åˆ¶"><a href="#è¶…æ—¶æ§åˆ¶" class="headerlink" title="è¶…æ—¶æ§åˆ¶"></a>è¶…æ—¶æ§åˆ¶</h4><p>è¿™å°±æ˜¯æ–‡ç« å¼€å§‹æ—¶å€™ç¬¬ä¸€ä¸ªåœºæ™¯ä¸‹çš„ä¸€ä¸ªä¾‹å­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;context&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// æ¨¡æ‹Ÿä¸€ä¸ªè€—æ—¶çš„æ“ä½œ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">rpc</span><span class="hljs-params">()</span> <span class="hljs-params">(<span class="hljs-keyword">string</span>, error)</span></span> &#123;<br>time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;rpc done&quot;</span>, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-keyword">type</span> result <span class="hljs-keyword">struct</span> &#123;<br>data <span class="hljs-keyword">string</span><br>err  error<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handle</span><span class="hljs-params">(ctx context.Context, ms <span class="hljs-keyword">int</span>)</span></span> &#123;<br>ctx, cancel := context.WithTimeout(ctx, time.Duration(ms)*time.Millisecond)<br><span class="hljs-keyword">defer</span> cancel()<br><br>r := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> result)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>data, err := rpc()<br>r &lt;- result&#123;data: data, err: err&#125;<br>&#125;()<br><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br>fmt.Printf(<span class="hljs-string">&quot;timeout: %d ms, context exit: %+v\n&quot;</span>, ms, ctx.Err())<br><span class="hljs-keyword">case</span> res := &lt;-r:<br>fmt.Printf(<span class="hljs-string">&quot;result: %s, err: %+v\n&quot;</span>, res.data, res.err)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// è¿™é‡Œæ¨¡æ‹Ÿæ¥å—è¯·æ±‚ï¼Œå¯åŠ¨ä¸€ä¸ªåç¨‹å»å‘èµ·è¯·æ±‚</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;<br>time.Sleep(<span class="hljs-number">1</span> * time.Second)<br><span class="hljs-keyword">go</span> handle(context.Background(), i*<span class="hljs-number">50</span>)<br>&#125;<br><br><span class="hljs-comment">// for test, hang</span><br>time.Sleep(time.Second)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">â–¶ <span class="hljs-keyword">go</span> run *.<span class="hljs-keyword">go</span><br>timeout: <span class="hljs-number">50</span> ms, context exit: context deadline exceeded<br>result: rpc done, err: &lt;<span class="hljs-literal">nil</span>&gt;<br>result: rpc done, err: &lt;<span class="hljs-literal">nil</span>&gt;<br>result: rpc done, err: &lt;<span class="hljs-literal">nil</span>&gt;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å‘ç°åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ä¼ å…¥çš„è¶…æ—¶æ—¶é—´ 50ms ç¨‹åºè¶…æ—¶ç›´æ¥é€€å‡ºäº†ï¼Œä½†æ˜¯åé¢è¶…è¿‡ 50ms çš„æ—¶å€™å‡è¿”å›äº†ç»“æœã€‚</p><h4 id="é”™è¯¯å–æ¶ˆ"><a href="#é”™è¯¯å–æ¶ˆ" class="headerlink" title="é”™è¯¯å–æ¶ˆ"></a>é”™è¯¯å–æ¶ˆ</h4><p>è¿™æ˜¯ç¬¬äºŒä¸ªåœºæ™¯çš„ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬åœ¨ main ä¸­å¹¶å‘è°ƒç”¨äº† <code>f1</code>  <code>f2</code>  ä¸¤ä¸ªå‡½æ•°ï¼Œä½†æ˜¯ <code>f1</code>  å¾ˆå¿«å°±è¿”å›äº†ï¼Œä½†æ˜¯ <code>f2</code>  è¿˜åœ¨é˜»å¡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;context&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;sync&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f1</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;f1: %w&quot;</span>, ctx.Err())<br><span class="hljs-keyword">case</span> &lt;-time.After(time.Millisecond): <span class="hljs-comment">// æ¨¡æ‹ŸçŸ­æ—¶é—´æŠ¥é”™</span><br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;f1 err in 1ms&quot;</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f2</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;f2: %w&quot;</span>, ctx.Err())<br><span class="hljs-keyword">case</span> &lt;-time.After(time.Hour): <span class="hljs-comment">// æ¨¡æ‹Ÿä¸€ä¸ªè€—æ—¶æ“ä½œ</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>ctx, cancel := context.WithTimeout(context.Background(), time.Second)<br><span class="hljs-keyword">defer</span> cancel()<br><br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br>wg.Add(<span class="hljs-number">2</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br><span class="hljs-keyword">if</span> err := f1(ctx); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err)<br>cancel()<br>&#125;<br>&#125;()<br><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br><span class="hljs-keyword">if</span> err := f2(ctx); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err)<br>cancel()<br>&#125;<br>&#125;()<br><br>wg.Wait()<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼Œå¯ä»¥çœ‹åˆ° f1 è¿”å›ä¹‹å f2 ç«‹å³å°±è¿”å›äº†ï¼Œå¹¶ä¸”æŠ¥é”™ context è¢«å–æ¶ˆ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">â–¶ <span class="hljs-keyword">go</span> run *.<span class="hljs-keyword">go</span><br>f1 err in <span class="hljs-number">1</span>ms<br>f2: context canceled<br></code></pre></td></tr></table></figure><p>ç»†å¿ƒçš„åŒå­¦å¯èƒ½å‘ç°äº†ï¼Œè¿™ä¸ªä¾‹å­ä¸å°±æ˜¯ errgroup çš„é€»è¾‘ä¹ˆï¼Œæ˜¯çš„å®ƒå°±æ˜¯ç±»ä¼¼ errgroup çš„ç®€å•é€»è¾‘ï¼Œè¿™æ—¶å€™å†åè¿‡æ¥å»çœ‹ä¸€ä¸‹ ã€Š<a href="https://lailin.xyz/post/go-training-week3-errgroup.html">Week03: Go å¹¶å‘ç¼–ç¨‹(ä¸ƒ) æ·±å…¥ç†è§£ errgroup - Mohuishou</a>ã€‹è¿™ç¯‡æ–‡ç« å¯èƒ½ä¼šæœ‰ä¸ä¸€æ ·çš„ä½“ä¼š</p><h4 id="ä¼ é€’å…±äº«æ•°æ®"><a href="#ä¼ é€’å…±äº«æ•°æ®" class="headerlink" title="ä¼ é€’å…±äº«æ•°æ®"></a>ä¼ é€’å…±äº«æ•°æ®</h4><p>ä¸€èˆ¬ä¼šç”¨æ¥ä¼ é€’ tracing id, request id è¿™ç§æ•°æ®ï¼Œä¸è¦ç”¨æ¥ä¼ é€’å¯é€‰å‚æ•°ï¼Œè¿™é‡Œå€Ÿç”¨ä¸€ä¸‹é¥¶å¤§çš„ä¸€ä¸ªä¾‹å­ï¼Œåœ¨å®é™…çš„ç”Ÿäº§æ¡ˆä¾‹ä¸­æˆ‘ä»¬ä»£ç ä¹Ÿæ˜¯è¿™æ ·å¤§åŒå°å¼‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> requestIDKey <span class="hljs-keyword">int</span> = <span class="hljs-number">0</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithRequestID</span><span class="hljs-params">(next http.Handler)</span> <span class="hljs-title">http</span>.<span class="hljs-title">Handler</span></span> &#123;<br><span class="hljs-keyword">return</span> http.HandlerFunc(<br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(rw http.ResponseWriter, req *http.Request)</span></span> &#123;<br><span class="hljs-comment">// ä» header ä¸­æå– request-id</span><br>reqID := req.Header.Get(<span class="hljs-string">&quot;X-Request-ID&quot;</span>)<br><span class="hljs-comment">// åˆ›å»º valueCtxã€‚ä½¿ç”¨è‡ªå®šä¹‰çš„ç±»å‹ï¼Œä¸å®¹æ˜“å†²çª</span><br>ctx := context.WithValue(<br>req.Context(), requestIDKey, reqID)<br><br><span class="hljs-comment">// åˆ›å»ºæ–°çš„è¯·æ±‚</span><br>req = req.WithContext(ctx)<br><br><span class="hljs-comment">// è°ƒç”¨ HTTP å¤„ç†å‡½æ•°</span><br>next.ServeHTTP(rw, req)<br>&#125;<br>)<br>&#125;<br><br><span class="hljs-comment">// è·å– request-id</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetRequestID</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-title">string</span></span> &#123;<br>ctx.Value(requestIDKey).(<span class="hljs-keyword">string</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Handle</span><span class="hljs-params">(rw http.ResponseWriter, req *http.Request)</span></span> &#123;<br><span class="hljs-comment">// æ‹¿åˆ° reqIdï¼Œåé¢å¯ä»¥è®°å½•æ—¥å¿—ç­‰ç­‰</span><br>reqID := GetRequestID(req.Context())<br>...<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>handler := WithRequestID(http.HandlerFunc(Handle))<br>http.ListenAndServe(<span class="hljs-string">&quot;/&quot;</span>, handler)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="åœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥ç”¨æ¥é˜²æ­¢-goroutine-æ³„æ¼"><a href="#åœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥ç”¨æ¥é˜²æ­¢-goroutine-æ³„æ¼" class="headerlink" title="åœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥ç”¨æ¥é˜²æ­¢ goroutine æ³„æ¼"></a>åœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥ç”¨æ¥é˜²æ­¢ goroutine æ³„æ¼</h4><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£çš„è¿™ä¸ªä¾‹å­, è¿™é‡Œé¢ gen è¿™ä¸ªå‡½æ•°ä¸­å¦‚æœä¸ä½¿ç”¨ context done æ¥æ§åˆ¶çš„è¯å°±ä¼šå¯¼è‡´ goroutine æ³„æ¼ï¼Œå› ä¸ºè¿™é‡Œé¢çš„ for æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œæ²¡æœ‰ ctx å°±æ²¡æœ‰ç›¸å…³çš„é€€å‡ºæœºåˆ¶</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// gen generates integers in a separate goroutine and</span><br><span class="hljs-comment">// sends them to the returned channel.</span><br><span class="hljs-comment">// The callers of gen need to cancel the context once</span><br><span class="hljs-comment">// they are done consuming generated integers not to leak</span><br><span class="hljs-comment">// the internal goroutine started by gen.</span><br>gen := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span> &lt;-<span class="hljs-title">chan</span> <span class="hljs-title">int</span></span> &#123;<br>dst := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)<br>n := <span class="hljs-number">1</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br><span class="hljs-keyword">return</span> <span class="hljs-comment">// returning not to leak the goroutine</span><br><span class="hljs-keyword">case</span> dst &lt;- n:<br>n++<br>&#125;<br>&#125;<br>&#125;()<br><span class="hljs-keyword">return</span> dst<br>&#125;<br><br>ctx, cancel := context.WithCancel(context.Background())<br><span class="hljs-keyword">defer</span> cancel() <span class="hljs-comment">// cancel when we are finished consuming integers</span><br><br><span class="hljs-keyword">for</span> n := <span class="hljs-keyword">range</span> gen(ctx) &#123;<br>fmt.Println(n)<br><span class="hljs-keyword">if</span> n == <span class="hljs-number">5</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><h3 id="ä½¿ç”¨å‡†åˆ™-1"><a href="#ä½¿ç”¨å‡†åˆ™-1" class="headerlink" title="ä½¿ç”¨å‡†åˆ™"></a>ä½¿ç”¨å‡†åˆ™</h3><p>context åŒ…ä¸€å¼€å§‹å°±å‘Šè¯‰äº†æˆ‘ä»¬åº”è¯¥æ€ä¹ˆç”¨ï¼Œä¸åº”è¯¥æ€ä¹ˆç”¨ï¼Œè¿™æ˜¯åº”è¯¥è¢«å…±åŒéµå®ˆçš„çº¦å®šã€‚</p><ul><li>å¯¹ server åº”ç”¨è€Œè¨€ï¼Œä¼ å…¥çš„è¯·æ±‚åº”è¯¥åˆ›å»ºä¸€ä¸ª contextï¼Œæ¥å—</li><li>é€šè¿‡ <code>WithCancel</code> , <code>WithDeadline</code> , <code>WithTimeout</code> åˆ›å»ºçš„ Context ä¼šåŒæ—¶è¿”å›ä¸€ä¸ª cancel æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¿…é¡»è¦è¢«æ‰§è¡Œï¼Œä¸ç„¶ä¼šå¯¼è‡´ context æ³„æ¼ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡æ‰§è¡Œ <code>go vet</code> å‘½ä»¤è¿›è¡Œæ£€æŸ¥</li><li>åº”è¯¥å°† <code>context.Context</code> ä½œä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œä¼ é€’ï¼Œå‚æ•°å‘½åä¸€èˆ¬ä¸º <code>ctx</code> ä¸åº”è¯¥å°† Context ä½œä¸ºå­—æ®µæ”¾åœ¨ç»“æ„ä½“ä¸­ã€‚</li><li>ä¸è¦ç»™ context ä¼ é€’ nilï¼Œå¦‚æœä½ ä¸çŸ¥é“åº”è¯¥ä¼ ä»€ä¹ˆçš„æ—¶å€™å°±ä¼ é€’ <code>context.TODO()</code></li><li>ä¸è¦å°†å‡½æ•°çš„å¯é€‰å‚æ•°æ”¾åœ¨ context å½“ä¸­ï¼Œcontext ä¸­ä¸€èˆ¬åªæ”¾ä¸€äº›å…¨å±€é€šç”¨çš„ metadata æ•°æ®ï¼Œä¾‹å¦‚ tracing id ç­‰ç­‰</li><li>context æ˜¯å¹¶å‘å®‰å…¨çš„å¯ä»¥åœ¨å¤šä¸ª goroutine ä¸­å¹¶å‘è°ƒç”¨</li></ul><h3 id="ä½¿ç”¨åœºæ™¯-1"><a href="#ä½¿ç”¨åœºæ™¯-1" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h3><ul><li>è¶…æ—¶æ§åˆ¶</li><li>é”™è¯¯å–æ¶ˆ</li><li>è·¨ goroutine æ•°æ®åŒæ­¥</li><li>é˜²æ­¢ goroutine æ³„æ¼</li></ul><h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><ul><li>æœ€æ˜¾è‘—çš„ä¸€ä¸ªå°±æ˜¯ context å¼•å…¥éœ€è¦ä¿®æ”¹å‡½æ•°ç­¾åï¼Œå¹¶ä¸”ä¼šç—…æ¯’çš„å¼çš„æ‰©æ•£åˆ°æ¯ä¸ªå‡½æ•°ä¸Šé¢ï¼Œä¸è¿‡è¿™ä¸ªè§ä»è§æ™ºï¼Œæˆ‘çœ‹ç€å…¶å®è¿˜å¥½</li><li>æŸäº›æƒ…å†µä¸‹è™½ç„¶æ˜¯å¯ä»¥åšåˆ°è¶…æ—¶è¿”å›æé«˜ç”¨æˆ·ä½“éªŒï¼Œä½†æ˜¯å®é™…ä¸Šæ˜¯ä¸ä¼šé€€å‡ºç›¸å…³ goroutine çš„ï¼Œè¿™æ—¶å€™å¯èƒ½ä¼šå¯¼è‡´ goroutine çš„æ³„æ¼ï¼Œé’ˆå¯¹è¿™ä¸ªæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­</li></ul><p>æˆ‘ä»¬ä½¿ç”¨æ ‡å‡†åº“çš„ timeout handler æ¥å®ç°è¶…æ—¶æ§åˆ¶ï¼Œåº•å±‚æ˜¯é€šè¿‡ context æ¥å®ç°çš„ã€‚æˆ‘ä»¬è®¾ç½®äº†è¶…æ—¶æ—¶é—´ä¸º 1ms å¹¶ä¸”åœ¨ handler ä¸­æ¨¡æ‹Ÿé˜»å¡ 1000s ä¸æ–­çš„è¯·æ±‚ï¼Œç„¶åçœ‹ pprof çš„ goroutine æ•°æ®</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;net/http&quot;</span><br>_ <span class="hljs-string">&quot;net/http/pprof&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>mux := http.NewServeMux()<br>mux.HandleFunc(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(rw http.ResponseWriter, r *http.Request)</span></span> &#123;<br><span class="hljs-comment">// è¿™é‡Œé˜»å¡ä½ï¼Œgoroutine ä¸ä¼šé‡Šæ”¾çš„</span><br>time.Sleep(<span class="hljs-number">1000</span> * time.Second)<br>rw.Write([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;hello&quot;</span>))<br>&#125;)<br>handler := http.TimeoutHandler(mux, time.Millisecond, <span class="hljs-string">&quot;xxx&quot;</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> err := http.ListenAndServe(<span class="hljs-string">&quot;0.0.0.0:8066&quot;</span>, <span class="hljs-literal">nil</span>); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>&#125;()<br>http.ListenAndServe(<span class="hljs-string">&quot;:8080&quot;</span>, handler)<br>&#125;<br><br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹æ•°æ®æˆ‘ä»¬å¯ä»¥å‘ç°è¯·æ±‚è¿”å›åï¼Œ goroutine å…¶å®å¹¶æœªå›æ”¶ï¼Œä½†æ˜¯å¦‚æœä¸é˜»å¡çš„è¯æ˜¯ä¼šç«‹å³å›æ”¶çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">goroutine profile: total <span class="hljs-number">29</span><br><span class="hljs-number">24</span> @ <span class="hljs-number">0x103b125</span> <span class="hljs-number">0x106cc9f</span> <span class="hljs-number">0x1374110</span> <span class="hljs-number">0x12b9584</span> <span class="hljs-number">0x12bb4ad</span> <span class="hljs-number">0x12c7fbf</span> <span class="hljs-number">0x106fd01</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„æºç ï¼Œè¶…æ—¶æ§åˆ¶ä¸»è¦åœ¨ ServeHTTP ä¸­å®ç°ï¼Œæˆ‘åˆ æ‰äº†éƒ¨åˆ†ä¸å…³é”®çš„æ•°æ®ï¼Œ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‡½æ•°å†…éƒ¨å¯åŠ¨äº†ä¸€ä¸ª goroutine å»å¤„ç†è¯·æ±‚é€»è¾‘ï¼Œç„¶åå†å¤–é¢ç­‰å¾…ï¼Œä½†æ˜¯è¿™é‡Œçš„é—®é¢˜æ˜¯ï¼Œå½“ context è¶…æ—¶ä¹‹å ServeHTTP è¿™ä¸ªå‡½æ•°å°±ç›´æ¥è¿”å›äº†ï¼Œåœ¨è¿™é‡Œé¢å¯åŠ¨çš„è¿™ä¸ª goroutine å°±æ²¡äººç®¡äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *timeoutHandler)</span> <span class="hljs-title">ServeHTTP</span><span class="hljs-params">(w ResponseWriter, r *Request)</span></span> &#123;<br>ctx := h.testContext<br><span class="hljs-keyword">if</span> ctx == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">var</span> cancelCtx context.CancelFunc<br>ctx, cancelCtx = context.WithTimeout(r.Context(), h.dt)<br><span class="hljs-keyword">defer</span> cancelCtx()<br>&#125;<br>r = r.WithContext(ctx)<br>done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br>tw := &amp;timeoutWriter&#123;<br>w:   w,<br>h:   <span class="hljs-built_in">make</span>(Header),<br>req: r,<br>&#125;<br>panicChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> p := <span class="hljs-built_in">recover</span>(); p != <span class="hljs-literal">nil</span> &#123;<br>panicChan &lt;- p<br>&#125;<br>&#125;()<br>h.handler.ServeHTTP(tw, r)<br><span class="hljs-built_in">close</span>(done)<br>&#125;()<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> p := &lt;-panicChan:<br><span class="hljs-built_in">panic</span>(p)<br><span class="hljs-keyword">case</span> &lt;-done:<br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br><span class="hljs-comment">// ...</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>context æ˜¯ä¸€ä¸ªä¼˜ç¼ºç‚¹éƒ½ååˆ†æ˜æ˜¾çš„åŒ…ï¼Œè¿™ä¸ªåŒ…ç›®å‰åŸºæœ¬ä¸Šå·²ç»æˆä¸ºäº†åœ¨ go ä¸­åšè¶…æ—¶æ§åˆ¶é”™è¯¯å–æ¶ˆçš„æ ‡å‡†åšæ³•ï¼Œä½†æ˜¯ä¸ºäº†æ·»åŠ è¶…æ—¶å–æ¶ˆæˆ‘ä»¬éœ€è¦å»ä¿®æ”¹æ‰€æœ‰çš„å‡½æ•°ç­¾åï¼Œå¯¹ä»£ç çš„ä¾µå…¥æ€§æ¯”è¾ƒå¤§ï¼Œå¦‚æœä¹‹å‰ä¸€ç›´éƒ½æ²¡æœ‰ä½¿ç”¨åç»­å†æ·»åŠ çš„è¯è¿˜æ˜¯ä¼šæœ‰ä¸€äº›æ”¹é€ æˆæœ¬</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://pkg.go.dev/context">context Â· pkg.go.dev</a></li><li><a href="https://www.flysnow.org/2017/05/12/go-in-action-go-context.html#%E5%88%9D%E8%AF%86context">Go è¯­è¨€å®æˆ˜ç¬”è®°ï¼ˆäºŒåï¼‰| Go Context</a></li><li><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-context/">Go è¯­è¨€å¹¶å‘ç¼–ç¨‹ä¸ Context | Go è¯­è¨€è®¾è®¡ä¸å®ç°</a></li><li><a href="https://qcrao.com/2019/06/12/dive-into-go-context/">æ·±åº¦è§£å¯† Go è¯­è¨€ä¹‹ context | qcrao</a></li><li><a href="https://blog.golang.org/context">Go Concurrency Patterns: Context - The Go Blog</a></li><li><a href="https://blog.golang.org/pipelines">Go Concurrency Patterns: Pipelines and cancellation - The Go Blog</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week03: Go å¹¶å‘ç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¹¶å‘</tag>
      
      <tag>context</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¹¶å‘ç¼–ç¨‹(å…«) æ·±å…¥ç†è§£ sync.Once</title>
    <link href="/post/go-training-week3-once.html"/>
    <url>/post/go-training-week3-once.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ã€Š<a href="https://lailin.xyz/post/go-training-week3-errgroup.html">Week03: Go å¹¶å‘ç¼–ç¨‹(ä¸ƒ) æ·±å…¥ç†è§£ errgroup</a>ã€‹å½“ä¸­çœ‹ <code>errgourp</code>  æºç çš„æ—¶å€™æˆ‘ä»¬å‘ç°æœ€åè¿”å› <code>err</code>  æ˜¯é€šè¿‡ once æ¥åªä¿è¯è¿”å›ä¸€ä¸ªé nil çš„å€¼çš„ï¼Œæœ¬æ–‡å°±æ¥çœ‹ä¸€ä¸‹ Once çš„ä½¿ç”¨ä¸å®ç°</p><h2 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h2><p>once çš„ä½¿ç”¨å¾ˆç®€å•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> (<br>o  sync.Once<br>wg sync.WaitGroup<br>)<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>wg.Add(<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-keyword">int</span>)</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>o.Do(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;once&quot;</span>, i)<br>&#125;)<br>&#125;(i)<br>&#125;<br><br>wg.Wait()<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">â¯ <span class="hljs-keyword">go</span> run ./main.<span class="hljs-keyword">go</span><br>once <span class="hljs-number">9</span><br></code></pre></td></tr></table></figure><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Once <span class="hljs-keyword">struct</span> &#123;<br>done <span class="hljs-keyword">uint32</span><br>m    Mutex<br>&#125;<br></code></pre></td></tr></table></figure><p>done ç”¨äºåˆ¤å®šå‡½æ•°æ˜¯å¦æ‰§è¡Œï¼Œå¦‚æœä¸ä¸º 0 ä¼šç›´æ¥è¿”å›</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(o *Once)</span> <span class="hljs-title">Do</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>()</span>)</span> &#123;<br><span class="hljs-comment">// Note: Here is an incorrect implementation of Do:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//if atomic.CompareAndSwapUint32(&amp;o.done, 0, 1) &#123;</span><br><span class="hljs-comment">//f()</span><br><span class="hljs-comment">//&#125;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Do guarantees that when it returns, f has finished.</span><br><span class="hljs-comment">// This implementation would not implement that guarantee:</span><br><span class="hljs-comment">// given two simultaneous calls, the winner of the cas would</span><br><span class="hljs-comment">// call f, and the second would return immediately, without</span><br><span class="hljs-comment">// waiting for the first&#x27;s call to f to complete.</span><br><span class="hljs-comment">// This is why the slow path falls back to a mutex, and why</span><br><span class="hljs-comment">// the atomic.StoreUint32 must be delayed until after f returns.</span><br><br><span class="hljs-keyword">if</span> atomic.LoadUint32(&amp;o.done) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Outlined slow-path to allow inlining of the fast-path.</span><br>o.doSlow(f)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹ go çš„æºç çœŸçš„å¯ä»¥å­¦åˆ°å¾ˆå¤šä¸œè¥¿ï¼Œåœ¨è¿™é‡Œè¿˜ç»™å‡ºäº†å¾ˆå®¹æ˜“çŠ¯é”™çš„ä¸€ç§å®ç°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> atomic.CompareAndSwapUint32(&amp;o.done, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) &#123;<br>f()<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœè¿™ä¹ˆå®ç°æœ€å¤§çš„é—®é¢˜æ˜¯ï¼Œå¦‚æœå¹¶å‘è°ƒç”¨ï¼Œä¸€ä¸ª goroutine æ‰§è¡Œï¼Œå¦å¤–ä¸€ä¸ªä¸ä¼šç­‰æ­£åœ¨æ‰§è¡Œçš„è¿™ä¸ªæˆåŠŸä¹‹åè¿”å›ï¼Œè€Œæ˜¯ç›´æ¥å°±è¿”å›äº†ï¼Œè¿™å°±ä¸èƒ½ä¿è¯ä¼ å…¥çš„æ–¹æ³•ä¸€å®šä¼šå…ˆæ‰§è¡Œä¸€æ¬¡äº†<br>æ‰€ä»¥å›å¤´çœ‹å®˜æ–¹çš„å®ç°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> atomic.LoadUint32(&amp;o.done) == <span class="hljs-number">0</span> &#123;<br>    <span class="hljs-comment">// Outlined slow-path to allow inlining of the fast-path.</span><br>    o.doSlow(f)<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼šå…ˆåˆ¤æ–­ done æ˜¯å¦ä¸º 0ï¼Œå¦‚æœä¸ä¸º 0 è¯´æ˜è¿˜æ²¡æ‰§è¡Œè¿‡ï¼Œå°±è¿›å…¥ <code>doSlow</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(o *Once)</span> <span class="hljs-title">doSlow</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>()</span>)</span> &#123;<br>o.m.Lock()<br><span class="hljs-keyword">defer</span> o.m.Unlock()<br><span class="hljs-keyword">if</span> o.done == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">defer</span> atomic.StoreUint32(&amp;o.done, <span class="hljs-number">1</span>)<br>f()<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>doSlow</code>  å½“ä¸­ä½¿ç”¨äº†äº’æ–¥é”æ¥ä¿è¯åªä¼šæ‰§è¡Œä¸€æ¬¡</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li>Once ä¿è¯äº†ä¼ å…¥çš„å‡½æ•°åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œè¿™å¸¸ç”¨åœ¨å•ä¾‹æ¨¡å¼ï¼Œé…ç½®æ–‡ä»¶åŠ è½½ï¼Œåˆå§‹åŒ–è¿™äº›åœºæ™¯ä¸‹</li><li>ä½†æ˜¯éœ€è¦æ³¨æ„ã€‚Once æ˜¯ä¸èƒ½å¤ç”¨çš„ï¼Œåªè¦æ‰§è¡Œè¿‡äº†ï¼Œå†ä¼ å…¥å…¶ä»–çš„æ–¹æ³•ä¹Ÿä¸ä¼šå†æ‰§è¡Œäº†</li><li>å¹¶ä¸” Once.Do åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å¦‚æœ f å‡ºç° panicï¼Œåé¢ä¹Ÿä¸ä¼šå†æ‰§è¡Œäº†</li></ul><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://pkg.go.dev/sync#Once">https://pkg.go.dev/sync#Once</a></li><li><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-sync-primitives/#once">6.2 åŒæ­¥åŸè¯­ä¸é”</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week03: Go å¹¶å‘ç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¹¶å‘</tag>
      
      <tag>sync</tag>
      
      <tag>once</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¹¶å‘ç¼–ç¨‹(ä¸ƒ) æ·±å…¥ç†è§£ errgroup</title>
    <link href="/post/go-training-week3-errgroup.html"/>
    <url>/post/go-training-week3-errgroup.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h2><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç«  ã€Š<a href="https://lailin.xyz/post/go-training-week3-waitgroup.html">Week03: Go å¹¶å‘ç¼–ç¨‹(å…­) æ·±å…¥ç†è§£ WaitGroup</a>ã€‹å½“ä¸­æˆ‘ä»¬ä»æºç å±‚é¢æ·±å…¥çš„äº†è§£äº† WaitGroup ç›¸å…³çš„ä½¿ç”¨ä¸å®ç°ã€‚</p><ul><li>åœ¨ä¸€ä¸ª goroutine éœ€è¦ç­‰å¾…å¤šä¸ª goroutine å®Œæˆå’Œå¤šä¸ª goroutine ç­‰å¾…ä¸€ä¸ª goroutine å¹²æ´»æ—¶éƒ½å¯ä»¥è§£å†³é—®é¢˜ã€‚</li></ul><p>è™½ç„¶ WaitGroup å·²ç»å¸®æˆ‘ä»¬åšäº†å¾ˆå¥½çš„å°è£…ï¼Œä½†æ˜¯ä»ç„¶å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚å¦‚æœéœ€è¦è¿”å›é”™è¯¯ï¼Œæˆ–è€…åªè¦ä¸€ä¸ª goroutine å‡ºé”™æˆ‘ä»¬å°±ä¸å†ç­‰å…¶ä»– goroutine äº†ï¼Œå‡å°‘èµ„æºæµªè´¹ï¼Œè¿™äº› WaitGroup éƒ½ä¸èƒ½å¾ˆå¥½çš„è§£å†³ï¼Œè¿™æ—¶å€™å°±æ´¾å‡ºæœ¬æ–‡çš„é€‰æ‰‹ errgroup å‡ºåœºäº†ã€‚</p><h2 id="å‡½æ•°ç­¾å"><a href="#å‡½æ•°ç­¾å" class="headerlink" title="å‡½æ•°ç­¾å"></a>å‡½æ•°ç­¾å</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Group<br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithContext</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-params">(*Group, context.Context)</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">Go</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>()</span> <span class="hljs-title">error</span>)</span><br>    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">Wait</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span><br></code></pre></td></tr></table></figure><p>æ•´ä¸ªåŒ…å°±ä¸€ä¸ª Group ç»“æ„ä½“</p><ul><li>é€šè¿‡ <code>WithContext</code>  å¯ä»¥åˆ›å»ºä¸€ä¸ªå¸¦å–æ¶ˆçš„ <code>Group</code></li><li>å½“ç„¶é™¤æ­¤ä¹‹å¤–ä¹Ÿå¯ä»¥é›¶å€¼çš„ Group ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä½†æ˜¯å‡ºé”™ä¹‹åå°±ä¸ä¼šå–æ¶ˆå…¶ä»–çš„ goroutine äº†</li><li><code>Go</code>  æ–¹æ³•ä¼ å…¥ä¸€ä¸ª <code>func() error</code>  å†…éƒ¨ä¼šå¯åŠ¨ä¸€ä¸ª goroutine å»å¤„ç†</li><li><code>Wait</code>  ç±»ä¼¼ WaitGroup çš„ Wait æ–¹æ³•ï¼Œç­‰å¾…æ‰€æœ‰çš„ goroutine ç»“æŸåé€€å‡ºï¼Œè¿”å›çš„é”™è¯¯æ˜¯ä¸€ä¸ªå‡ºé”™çš„ err</li></ul><h2 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h2><h3 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Group <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">// context çš„ cancel æ–¹æ³•</span><br>cancel <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span><br><br>    <span class="hljs-comment">// å¤ç”¨ WaitGroup</span><br>wg sync.WaitGroup<br><br><span class="hljs-comment">// ç”¨æ¥ä¿è¯åªä¼šæ¥å—ä¸€æ¬¡é”™è¯¯</span><br>errOnce sync.Once<br>    <span class="hljs-comment">// ä¿å­˜ç¬¬ä¸€ä¸ªè¿”å›çš„é”™è¯¯</span><br>err     error<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="WithContext"><a href="#WithContext" class="headerlink" title="WithContext"></a>WithContext</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithContext</span><span class="hljs-params">(ctx context.Context)</span> <span class="hljs-params">(*Group, context.Context)</span></span> &#123;<br>ctx, cancel := context.WithCancel(ctx)<br><span class="hljs-keyword">return</span> &amp;Group&#123;cancel: cancel&#125;, ctx<br>&#125;<br></code></pre></td></tr></table></figure><p><code>WithContext</code>  å°±æ˜¯ä½¿ç”¨ <code>WithCancel</code>  åˆ›å»ºä¸€ä¸ªå¯ä»¥å–æ¶ˆçš„ context å°† cancel èµ‹å€¼ç»™ Group ä¿å­˜èµ·æ¥ï¼Œç„¶åå†å°† context è¿”å›å›å»</p><div style="background: #FFFBE6;padding:10px;border: 1px solid #C3C3C3;border-radius:5px;margin-bottom:5px;">æ³¨æ„è¿™é‡Œæœ‰ä¸€ä¸ªå‘ï¼Œåœ¨åé¢çš„ä»£ç ä¸­ä¸è¦æŠŠè¿™ä¸ª ctx å½“åšçˆ¶ context åˆä¼ ç»™ä¸‹æ¸¸ï¼Œå› ä¸º errgroup å–æ¶ˆäº†ï¼Œè¿™ä¸ª context å°±æ²¡ç”¨äº†ï¼Œä¼šå¯¼è‡´ä¸‹æ¸¸å¤ç”¨çš„æ—¶å€™å‡ºé”™</div><h3 id="Go"><a href="#Go" class="headerlink" title="Go"></a>Go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">Go</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>()</span> <span class="hljs-title">error</span>)</span> &#123;<br>g.wg.Add(<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> g.wg.Done()<br><br><span class="hljs-keyword">if</span> err := f(); err != <span class="hljs-literal">nil</span> &#123;<br>g.errOnce.Do(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>g.err = err<br><span class="hljs-keyword">if</span> g.cancel != <span class="hljs-literal">nil</span> &#123;<br>g.cancel()<br>&#125;<br>&#125;)<br>&#125;<br>&#125;()<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Go</code>  æ–¹æ³•å…¶å®å°±ç±»ä¼¼äº <code>go</code>  å…³é”®å­—ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªæºç¨‹ï¼Œç„¶ååˆ©ç”¨ <code>waitgroup</code>  æ¥æ§åˆ¶æ˜¯å¦ç»“æŸï¼Œå¦‚æœæœ‰ä¸€ä¸ªé <code>nil</code>  çš„ error å‡ºç°å°±ä¼šä¿å­˜èµ·æ¥å¹¶ä¸”å¦‚æœæœ‰ <code>cancel</code>  å°±ä¼šè°ƒç”¨ <code>cancel</code>  å–æ¶ˆæ‰ï¼Œä½¿ <code>ctx</code>  è¿”å›</p><h3 id="Wait"><a href="#Wait" class="headerlink" title="Wait"></a>Wait</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span> <span class="hljs-title">Wait</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br>g.wg.Wait()<br><span class="hljs-keyword">if</span> g.cancel != <span class="hljs-literal">nil</span> &#123;<br>g.cancel()<br>&#125;<br><span class="hljs-keyword">return</span> g.err<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Wait</code>  æ–¹æ³•å…¶å®å°±æ˜¯è°ƒç”¨ <code>WaitGroup</code>  ç­‰å¾…ï¼Œå¦‚æœæœ‰ <code>cancel</code>  å°±è°ƒç”¨ä¸€ä¸‹</p><h2 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h2><blockquote><p>è¿™ä¸ªå…¶å®æ˜¯ week03 çš„ä½œä¸š</p></blockquote><p>åŸºäº  errgroup  å®ç°ä¸€ä¸ª  http server  çš„å¯åŠ¨å’Œå…³é—­  ï¼Œä»¥åŠ  linux signal  ä¿¡å·çš„æ³¨å†Œå’Œå¤„ç†ï¼Œè¦ä¿è¯èƒ½å¤Ÿ   ä¸€ä¸ªé€€å‡ºï¼Œå…¨éƒ¨æ³¨é”€é€€å‡ºã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>g, ctx := errgroup.WithContext(context.Background())<br><br>mux := http.NewServeMux()<br>mux.HandleFunc(<span class="hljs-string">&quot;/ping&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>w.Write([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;pong&quot;</span>))<br>&#125;)<br><br><span class="hljs-comment">// æ¨¡æ‹Ÿå•ä¸ªæœåŠ¡é”™è¯¯é€€å‡º</span><br>serverOut := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br>mux.HandleFunc(<span class="hljs-string">&quot;/shutdown&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>serverOut &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>&#125;)<br><br>server := http.Server&#123;<br>Handler: mux,<br>Addr:    <span class="hljs-string">&quot;:8080&quot;</span>,<br>&#125;<br><br><span class="hljs-comment">// g1</span><br><span class="hljs-comment">// g1 é€€å‡ºäº†æ‰€æœ‰çš„åç¨‹éƒ½èƒ½é€€å‡ºä¹ˆï¼Ÿ</span><br><span class="hljs-comment">// g1 é€€å‡ºå, context å°†ä¸å†é˜»å¡ï¼Œg2, g3 éƒ½ä¼šéšä¹‹é€€å‡º</span><br><span class="hljs-comment">// ç„¶å main å‡½æ•°ä¸­çš„ g.Wait() é€€å‡ºï¼Œæ‰€æœ‰åç¨‹éƒ½ä¼šé€€å‡º</span><br>g.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> server.ListenAndServe()<br>&#125;)<br><br><span class="hljs-comment">// g2</span><br><span class="hljs-comment">// g2 é€€å‡ºäº†æ‰€æœ‰çš„åç¨‹éƒ½èƒ½é€€å‡ºä¹ˆï¼Ÿ</span><br><span class="hljs-comment">// g2 é€€å‡ºæ—¶ï¼Œè°ƒç”¨äº† shutdownï¼Œg1 ä¼šé€€å‡º</span><br><span class="hljs-comment">// g2 é€€å‡ºå, context å°†ä¸å†é˜»å¡ï¼Œg3 ä¼šéšä¹‹é€€å‡º</span><br><span class="hljs-comment">// ç„¶å main å‡½æ•°ä¸­çš„ g.Wait() é€€å‡ºï¼Œæ‰€æœ‰åç¨‹éƒ½ä¼šé€€å‡º</span><br>g.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br>log.Println(<span class="hljs-string">&quot;errgroup exit...&quot;</span>)<br><span class="hljs-keyword">case</span> &lt;-serverOut:<br>log.Println(<span class="hljs-string">&quot;server will out...&quot;</span>)<br>&#125;<br><br>timeoutCtx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">3</span>*time.Second)<br><span class="hljs-comment">// è¿™é‡Œä¸æ˜¯å¿…é¡»çš„ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨ _ çš„è¯é™æ€æ‰«æå·¥å…·ä¼šæŠ¥é”™ï¼ŒåŠ ä¸Šä¹Ÿæ— ä¼¤å¤§é›…</span><br><span class="hljs-keyword">defer</span> cancel()<br><br>log.Println(<span class="hljs-string">&quot;shutting down server...&quot;</span>)<br><span class="hljs-keyword">return</span> server.Shutdown(timeoutCtx)<br>&#125;)<br><br><span class="hljs-comment">// g3</span><br><span class="hljs-comment">// g3 æ•è·åˆ° os é€€å‡ºä¿¡å·å°†ä¼šé€€å‡º</span><br><span class="hljs-comment">// g3 é€€å‡ºäº†æ‰€æœ‰çš„åç¨‹éƒ½èƒ½é€€å‡ºä¹ˆï¼Ÿ</span><br><span class="hljs-comment">// g3 é€€å‡ºå, context å°†ä¸å†é˜»å¡ï¼Œg2 ä¼šéšä¹‹é€€å‡º</span><br><span class="hljs-comment">// g2 é€€å‡ºæ—¶ï¼Œè°ƒç”¨äº† shutdownï¼Œg1 ä¼šé€€å‡º</span><br><span class="hljs-comment">// ç„¶å main å‡½æ•°ä¸­çš„ g.Wait() é€€å‡ºï¼Œæ‰€æœ‰åç¨‹éƒ½ä¼šé€€å‡º</span><br>g.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br>quit := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal, <span class="hljs-number">0</span>)<br>signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)<br><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br><span class="hljs-keyword">return</span> ctx.Err()<br><span class="hljs-keyword">case</span> sig := &lt;-quit:<br><span class="hljs-keyword">return</span> errors.Errorf(<span class="hljs-string">&quot;get os signal: %v&quot;</span>, sig)<br>&#125;<br>&#125;)<br><br>fmt.Printf(<span class="hljs-string">&quot;errgroup exiting: %+v\n&quot;</span>, g.Wait())<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦ç”¨åˆ°äº† errgroup ä¸€ä¸ªå‡ºé”™ï¼Œå…¶ä½™å–æ¶ˆçš„èƒ½åŠ›</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://pkg.go.dev/golang.org/x/sync/errgroup">https://pkg.go.dev/golang.org/x/sync/errgroup</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week03: Go å¹¶å‘ç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¹¶å‘</tag>
      
      <tag>sync</tag>
      
      <tag>errgroup</tag>
      
      <tag>waitgroup</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¹¶å‘ç¼–ç¨‹(å…­) æ·±å…¥ç†è§£ WaitGroup</title>
    <link href="/post/go-training-week3-waitgroup.html"/>
    <url>/post/go-training-week3-waitgroup.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><p>åœ¨å‰é¢çš„å‡ ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æˆ–å¤šæˆ–å°‘éƒ½ç”¨åˆ°äº† WaitGroup æ¥ç­‰å¾…å¤šä¸ª goroutine æ‰§è¡Œç»“æŸï¼Œä»Šå¤©æˆ‘ä»¬æ¥æ·±å…¥å­¦ä¹ ä¸€ä¸‹</p><h2 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h2><p><code>WaitGroup</code> å¯ä»¥è§£å†³ä¸€ä¸ª goroutine ç­‰å¾…å¤šä¸ª goroutine åŒæ—¶ç»“æŸçš„åœºæ™¯ï¼Œè¿™ä¸ªæ¯”è¾ƒå¸¸è§çš„åœºæ™¯å°±æ˜¯ä¾‹å¦‚ åç«¯ worker å¯åŠ¨äº†å¤šä¸ªæ¶ˆè´¹è€…å¹²æ´»ï¼Œè¿˜æœ‰çˆ¬è™«å¹¶å‘çˆ¬å–æ•°æ®ï¼Œå¤šçº¿ç¨‹ä¸‹è½½ç­‰ç­‰ã€‚<br>æˆ‘ä»¬è¿™é‡Œæ¨¡æ‹Ÿä¸€ä¸ª worker çš„ä¾‹å­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;sync&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">worker</span><span class="hljs-params">(i <span class="hljs-keyword">int</span>)</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;worker: &quot;</span>, i)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-keyword">int</span>)</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>worker(i)<br>&#125;(i)<br>&#125;<br>wg.Wait()<br>&#125;<br></code></pre></td></tr></table></figure><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">é—®é¢˜: åè¿‡æ¥æ”¯æŒå¤šä¸ª goroutine ç­‰å¾…ä¸€ä¸ª goroutine å®Œæˆåå†å¹²æ´»å—ï¼Ÿ<br>çœ‹æˆ‘ä»¬æ¥ä¸‹æ¥çš„æºç åˆ†æä½ å°±çŸ¥é“äº†</div><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> WaitGroup <span class="hljs-keyword">struct</span> &#123;<br>noCopy noCopy<br><br><span class="hljs-comment">// 64-bit value: high 32 bits are counter, low 32 bits are waiter count.</span><br><span class="hljs-comment">// 64-bit atomic operations require 64-bit alignment, but 32-bit</span><br><span class="hljs-comment">// compilers do not ensure it. So we allocate 12 bytes and then use</span><br><span class="hljs-comment">// the aligned 8 bytes in them as state, and the other 4 as storage</span><br><span class="hljs-comment">// for the sema.</span><br>state1 [<span class="hljs-number">3</span>]<span class="hljs-keyword">uint32</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>WaitGroup</code> ç»“æ„ååˆ†ç®€å•ï¼Œç”± <code>nocopy</code> å’Œ <code>state1</code> ä¸¤ä¸ªå­—æ®µç»„æˆï¼Œå…¶ä¸­ <code>nocopy</code> æ˜¯ç”¨æ¥é˜²æ­¢å¤åˆ¶çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> noCopy <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// Lock is a no-op used by -copylocks checker from `go vet`.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(*noCopy)</span> <span class="hljs-title">Lock</span><span class="hljs-params">()</span></span>   &#123;&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(*noCopy)</span> <span class="hljs-title">Unlock</span><span class="hljs-params">()</span></span> &#123;&#125;<br></code></pre></td></tr></table></figure><p>ç”±äºåµŒå…¥äº† <code>nocopy</code> æ‰€ä»¥åœ¨æ‰§è¡Œ <code>go vet</code> æ—¶å¦‚æœæ£€æŸ¥åˆ° <code>WaitGroup</code> è¢«å¤åˆ¶äº†å°±ä¼šæŠ¥é”™ã€‚è¿™æ ·å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šä¿è¯ <code>WaitGroup</code> ä¸è¢«å¤åˆ¶ï¼Œå¯¹äº†ç›´æ¥ go run æ˜¯ä¸ä¼šæœ‰é”™è¯¯çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»£ç  push ä¹‹å‰éƒ½ä¼šå¼ºåˆ¶è¦æ±‚è¿›è¡Œ lint æ£€æŸ¥ï¼Œåœ¨ ci/cd é˜¶æ®µä¹Ÿéœ€è¦å…ˆè¿›è¡Œ lint æ£€æŸ¥ï¼Œé¿å…å‡ºç°è¿™ç§ç±»ä¼¼çš„é”™è¯¯ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">~/project/Go<span class="hljs-number">-000</span>/Week03/blog/<span class="hljs-number">06</span>_waitgroup/<span class="hljs-number">02</span> main*<br>â¯ <span class="hljs-keyword">go</span> run ./main.<span class="hljs-keyword">go</span><br><br>~/project/Go<span class="hljs-number">-000</span>/Week03/blog/<span class="hljs-number">06</span>_waitgroup/<span class="hljs-number">02</span> main*<br>â¯ <span class="hljs-keyword">go</span> vet .<br># github.com/mohuishou/<span class="hljs-keyword">go</span>-training/Week03/blog/<span class="hljs-number">06</span>_waitgroup/<span class="hljs-number">02</span><br>./main.<span class="hljs-keyword">go</span>:<span class="hljs-number">7</span>:<span class="hljs-number">9</span>: assignment copies lock value to wg2: sync.WaitGroup contains sync.noCopy<br></code></pre></td></tr></table></figure><p><code>state1</code> çš„è®¾è®¡éå¸¸å·§å¦™ï¼Œè¿™æ˜¯ä¸€ä¸ªæ˜¯åäºŒå­—èŠ‚çš„æ•°æ®ï¼Œè¿™é‡Œé¢ä¸»è¦åŒ…å«ä¸¤å¤§å—ï¼Œcounter å ç”¨äº† 8 å­—èŠ‚ç”¨äºè®¡æ•°ï¼Œsema å ç”¨ 4 å­—èŠ‚ç”¨åšä¿¡å·é‡</p><p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆæå‘¢ï¼Ÿç›´æ¥ç”¨ä¸¤ä¸ªå­—æ®µä¸€ä¸ªè¡¨ç¤º counterï¼Œä¸€ä¸ªè¡¨ç¤º sema ä¸è¡Œä¹ˆï¼Ÿ<br>ä¸è¡Œï¼Œæˆ‘ä»¬çœ‹çœ‹æ³¨é‡Šé‡Œé¢æ€ä¹ˆå†™çš„ã€‚</p><blockquote><p><em>// 64-bit value: high 32 bits are counter, low 32 bits are waiter count.</em> &gt; <em>// 64-bit atomic operations require 64-bit alignment, but 32-bit</em> &gt; <em>// compilers do not ensure it. So we allocate 12 bytes and then use</em> &gt; <em>// the aligned 8 bytes in them as state, and the other 4 as storage</em> &gt; <em>// for the sema.</em></p></blockquote><p>è¿™æ®µè¯çš„å…³é”®ç‚¹åœ¨äºï¼Œåœ¨åš 64 ä½çš„åŸå­æ“ä½œçš„æ—¶å€™å¿…é¡»è¦ä¿è¯ 64 ä½ï¼ˆ8 å­—èŠ‚ï¼‰å¯¹é½ï¼Œå¦‚æœæ²¡æœ‰å¯¹é½çš„å°±ä¼šæœ‰é—®é¢˜ï¼Œä½†æ˜¯ 32 ä½çš„ç¼–è¯‘å™¨å¹¶ä¸èƒ½ä¿è¯ 64 ä½å¯¹é½æ‰€ä»¥è¿™é‡Œç”¨ä¸€ä¸ª 12 å­—èŠ‚çš„ state1 å­—æ®µæ¥å­˜å‚¨è¿™ä¸¤ä¸ªçŠ¶æ€ï¼Œç„¶åæ ¹æ®æ˜¯å¦ 8 å­—èŠ‚å¯¹é½é€‰æ‹©ä¸åŒçš„ä¿å­˜æ–¹å¼ã€‚<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1609085423413-88a8f508-0269-4cf9-9474-9f78b78a53ea.svg" alt="02_Goè¿›é˜¶03_blog_waitgroup.drawio.svg"><br>è¿™ä¸ªæ“ä½œå·§å¦™åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p><ul><li>å¦‚æœæ˜¯ 64 ä½çš„æœºå™¨é‚£è‚¯å®šæ˜¯ 8 å­—èŠ‚å¯¹é½äº†çš„ï¼Œæ‰€ä»¥æ˜¯ä¸Šé¢ç¬¬ä¸€ç§æ–¹å¼</li><li>å¦‚æœåœ¨ 32 ä½çš„æœºå™¨ä¸Š<ul><li>å¦‚æœæ°å¥½ 8 å­—èŠ‚å¯¹é½äº†ï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ç¬¬ä¸€ç§æ–¹å¼å–å‰é¢çš„ 8 å­—èŠ‚æ•°æ®</li><li>å¦‚æœæ˜¯æ²¡æœ‰å¯¹é½ï¼Œä½†æ˜¯ 32 ä½ 4 å­—èŠ‚æ˜¯å¯¹é½äº†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åç§»å››ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆå°± 8 å­—èŠ‚å¯¹é½äº†ï¼Œæ‰€ä»¥æ˜¯ç¬¬äºŒç§æ–¹å¼</li></ul></li></ul><p>æ‰€ä»¥é€šè¿‡ sema ä¿¡å·é‡è¿™å››ä¸ªå­—èŠ‚çš„ä½ç½®ä¸åŒï¼Œä¿è¯äº† counter è¿™ä¸ªå­—æ®µæ— è®ºåœ¨ 32 ä½è¿˜æ˜¯ 64 ä¸ºæœºå™¨ä¸Šéƒ½æ˜¯ 8 å­—èŠ‚å¯¹é½çš„ï¼Œåç»­åš 64 ä½åŸå­æ“ä½œçš„æ—¶å€™å°±æ²¡é—®é¢˜äº†ã€‚<br>è¿™ä¸ªå®ç°æ˜¯åœ¨ <code>state</code> æ–¹æ³•å®ç°çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(wg *WaitGroup)</span> <span class="hljs-title">state</span><span class="hljs-params">()</span> <span class="hljs-params">(statep *<span class="hljs-keyword">uint64</span>, semap *<span class="hljs-keyword">uint32</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">uintptr</span>(unsafe.Pointer(&amp;wg.state1))%<span class="hljs-number">8</span> == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> (*<span class="hljs-keyword">uint64</span>)(unsafe.Pointer(&amp;wg.state1)), &amp;wg.state1[<span class="hljs-number">2</span>]<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> (*<span class="hljs-keyword">uint64</span>)(unsafe.Pointer(&amp;wg.state1[<span class="hljs-number">1</span>])), &amp;wg.state1[<span class="hljs-number">0</span>]<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>state</code> æ–¹æ³•è¿”å› counter å’Œä¿¡å·é‡ï¼Œé€šè¿‡ <code>uintptr(unsafe.Pointer(&amp;wg.state1))%8 == 0</code> æ¥åˆ¤æ–­æ˜¯å¦ 8 å­—èŠ‚å¯¹é½</p><h3 id="Add"><a href="#Add" class="headerlink" title="Add"></a>Add</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(wg *WaitGroup)</span> <span class="hljs-title">Add</span><span class="hljs-params">(delta <span class="hljs-keyword">int</span>)</span></span> &#123;<br>    <span class="hljs-comment">// å…ˆä» state å½“ä¸­æŠŠæ•°æ®å’Œä¿¡å·é‡å–å‡ºæ¥</span><br>statep, semap := wg.state()<br><br>    <span class="hljs-comment">// åœ¨ waiter ä¸ŠåŠ ä¸Š delta å€¼</span><br>state := atomic.AddUint64(statep, <span class="hljs-keyword">uint64</span>(delta)&lt;&lt;<span class="hljs-number">32</span>)<br>    <span class="hljs-comment">// å–å‡ºå½“å‰çš„ counter</span><br>v := <span class="hljs-keyword">int32</span>(state &gt;&gt; <span class="hljs-number">32</span>)<br>    <span class="hljs-comment">// å–å‡ºå½“å‰çš„ waiterï¼Œæ­£åœ¨ç­‰å¾… goroutine æ•°é‡</span><br>w := <span class="hljs-keyword">uint32</span>(state)<br><br>    <span class="hljs-comment">// counter ä¸èƒ½ä¸ºè´Ÿæ•°</span><br><span class="hljs-keyword">if</span> v &lt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;sync: negative WaitGroup counter&quot;</span>)<br>&#125;<br><br>    <span class="hljs-comment">// è¿™é‡Œå±äºé˜²å¾¡æ€§ç¼–ç¨‹</span><br>    <span class="hljs-comment">// w != 0 è¯´æ˜ç°åœ¨å·²ç»æœ‰ goroutine åœ¨ç­‰å¾…ä¸­ï¼Œè¯´æ˜å·²ç»è°ƒç”¨äº† Wait() æ–¹æ³•</span><br>    <span class="hljs-comment">// è¿™æ—¶å€™ delta &gt; 0 &amp;&amp; v == int32(delta) è¯´æ˜åœ¨è°ƒç”¨äº† Wait() æ–¹æ³•ä¹‹ååˆæƒ³åŠ å…¥æ–°çš„ç­‰å¾…è€…</span><br>    <span class="hljs-comment">// è¿™ç§æ“ä½œæ˜¯ä¸å…è®¸çš„</span><br><span class="hljs-keyword">if</span> w != <span class="hljs-number">0</span> &amp;&amp; delta &gt; <span class="hljs-number">0</span> &amp;&amp; v == <span class="hljs-keyword">int32</span>(delta) &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;sync: WaitGroup misuse: Add called concurrently with Wait&quot;</span>)<br>&#125;<br>    <span class="hljs-comment">// å¦‚æœå½“å‰æ²¡æœ‰äººåœ¨ç­‰å¾…å°±ç›´æ¥è¿”å›ï¼Œå¹¶ä¸” counter &gt; 0</span><br><span class="hljs-keyword">if</span> v &gt; <span class="hljs-number">0</span> || w == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><br>    <span class="hljs-comment">// è¿™é‡Œä¹Ÿæ˜¯é˜²å¾¡ ä¸»è¦é¿å…å¹¶å‘è°ƒç”¨ add å’Œ wait</span><br><span class="hljs-keyword">if</span> *statep != state &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;sync: WaitGroup misuse: Add called concurrently with Wait&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// å”¤é†’æ‰€æœ‰ waiterï¼Œçœ‹åˆ°è¿™é‡Œå°±å›ç­”äº†ä¸Šé¢çš„é—®é¢˜äº†</span><br>*statep = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> ; w != <span class="hljs-number">0</span>; w-- &#123;<br>runtime_Semrelease(semap, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Wait"><a href="#Wait" class="headerlink" title="Wait"></a>Wait</h3><p>wait ä¸»è¦å°±æ˜¯ç­‰å¾…å…¶ä»–çš„ goroutine å®Œäº‹ä¹‹åå”¤é†’</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(wg *WaitGroup)</span> <span class="hljs-title">Wait</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// å…ˆä» state å½“ä¸­æŠŠæ•°æ®å’Œä¿¡å·é‡çš„åœ°å€å–å‡ºæ¥</span><br>    statep, semap := wg.state()<br><br><span class="hljs-keyword">for</span> &#123;<br>     <span class="hljs-comment">// è¿™é‡Œå»é™¤ counter å’Œ waiter çš„æ•°æ®</span><br>state := atomic.LoadUint64(statep)<br>v := <span class="hljs-keyword">int32</span>(state &gt;&gt; <span class="hljs-number">32</span>)<br>w := <span class="hljs-keyword">uint32</span>(state)<br><br>        <span class="hljs-comment">// counter = 0 è¯´æ˜æ²¡æœ‰åœ¨ç­‰çš„ï¼Œç›´æ¥è¿”å›å°±è¡Œ</span><br>        <span class="hljs-keyword">if</span> v == <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Counter is 0, no need to wait.</span><br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// waiter + 1ï¼Œè°ƒç”¨ä¸€æ¬¡å°±å¤šä¸€ä¸ªç­‰å¾…è€…ï¼Œç„¶åä¼‘çœ å½“å‰ goroutine ç­‰å¾…è¢«å”¤é†’</span><br><span class="hljs-keyword">if</span> atomic.CompareAndSwapUint64(statep, state, state+<span class="hljs-number">1</span>) &#123;<br>runtime_Semacquire(semap)<br><span class="hljs-keyword">if</span> *statep != <span class="hljs-number">0</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;sync: WaitGroup is reused before previous Wait has returned&quot;</span>)<br>&#125;<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Done"><a href="#Done" class="headerlink" title="Done"></a>Done</h3><p>è¿™ä¸ªåªæ˜¯ add çš„ç®€å•å°è£…</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(wg *WaitGroup)</span> <span class="hljs-title">Done</span><span class="hljs-params">()</span></span> &#123;<br>wg.Add(<span class="hljs-number">-1</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li><code>WaitGroup</code> å¯ä»¥ç”¨äºä¸€ä¸ª goroutine ç­‰å¾…å¤šä¸ª goroutine å¹²æ´»å®Œæˆï¼Œä¹Ÿå¯ä»¥å¤šä¸ª goroutine ç­‰å¾…ä¸€ä¸ª goroutine å¹²æ´»å®Œæˆï¼Œæ˜¯ä¸€ä¸ªå¤šå¯¹å¤šçš„å…³ç³»<ul><li>å¤šä¸ªç­‰å¾…ä¸€ä¸ªçš„å…¸å‹æ¡ˆä¾‹æ˜¯ <a href="https://pkg.go.dev/golang.org/x/sync/singleflight">singleflight</a>ï¼Œè¿™ä¸ªåœ¨åé¢å°†å¾®æœåŠ¡å¯ç”¨æ€§çš„æ—¶å€™è¿˜ä¼šå†è®²åˆ°ï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹çœ‹æºç </li></ul></li><li><code>Add(n&gt;0)</code> æ–¹æ³•åº”è¯¥åœ¨å¯åŠ¨ goroutine ä¹‹å‰è°ƒç”¨ï¼Œç„¶ååœ¨ goroution å†…éƒ¨è°ƒç”¨ <code>Done</code> æ–¹æ³•</li><li><code>WaitGroup</code> å¿…é¡»åœ¨ <code>Wait</code> æ–¹æ³•è¿”å›ä¹‹åæ‰èƒ½å†æ¬¡ä½¿ç”¨</li><li><code>Done</code> åªæ˜¯ <code>Add</code> çš„ç®€å•å°è£…ï¼Œæ‰€ä»¥å®é™…ä¸Šæ˜¯å¯ä»¥é€šè¿‡ä¸€æ¬¡åŠ ä¸€ä¸ªæ¯”è¾ƒå¤§çš„å€¼å‡å°‘è°ƒç”¨ï¼Œæˆ–è€…è¾¾åˆ°å¿«é€Ÿå”¤é†’çš„ç›®çš„ã€‚</li></ul><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://pkg.go.dev/sync">https://pkg.go.dev/sync</a> å®˜ç½‘æ–‡æ¡£ï¼Œå¿…è¯»</li><li><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-sync-primitives/">Go è¯­è¨€è®¾è®¡ä¸å®ç°-6.2 åŒæ­¥åŸè¯­ä¸é”</a> è¿™æœ¬ä¹¦å€¼å¾—ä¸€çœ‹</li><li><a href="https://gobyexample.com/waitgroups">Go by Example: WaitGroups</a></li><li><a href="https://golang.org/issues/8005#issuecomment-190753527">https://golang.org/issues/8005#issuecomment-190753527</a></li><li><a href="https://juejin.cn/post/6893019249263001613">Golang æºç ç³»åˆ— sync.waitgroup æºç å‰–æ</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week03: Go å¹¶å‘ç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¹¶å‘</tag>
      
      <tag>sync</tag>
      
      <tag>waitgroup</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¹¶å‘ç¼–ç¨‹(äº”) æ·±å…¥ç†è§£ sync/atomic</title>
    <link href="/post/go-training-week3-atomic.html"/>
    <url>/post/go-training-week3-atomic.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h2><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ã€Š<a href="https://lailin.xyz/post/go-training-week3-sync.html">Week03: Go å¹¶å‘ç¼–ç¨‹(å››) æ·±å…¥ç†è§£ Mutex</a>ã€‹å½“ä¸­æˆ‘ä»¬ä¸»è¦è®²åˆ°äº†äº’æ–¥é”ä»¥åŠè¯»å†™é”çš„ä½¿ç”¨ä»¥åŠæºç è§£æã€‚åœ¨çœ‹æºç çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥å‘ç°é‡Œé¢ä½¿ç”¨äº†å¾ˆå¤š atomic åŒ…çš„æ–¹æ³•æ¥ä¿è¯åŸå­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¶çƒ­æ‰“é“æ¥ä¸‹æ¥å°±éšç€æœ¬æ–‡æ¥çœ‹ä¸€çœ‹ atomic åº”è¯¥æ€ä¹ˆç”¨ï¼Œä»¥åŠå®ƒåˆæ˜¯å¦‚ä½•å®ç°çš„</p><h2 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h2><p>ä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä»¬åœ¨è®²è¯»å†™é”çš„æ—¶å€™è®²åˆ°äº†ä¸€ä¸ªé…ç½®è¯»å–çš„ä¾‹å­ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ atomic å®ç°çœ‹ä¸€ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Config atomic å®ç°</span><br><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;<br>v atomic.Value <span class="hljs-comment">// å‡è®¾ data å°±æ˜¯æ•´ä¸ª config äº†</span><br>&#125;<br><br><span class="hljs-comment">// Get get config data</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Config)</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> []<span class="hljs-title">int</span></span> &#123;<br><span class="hljs-comment">// è¿™é‡Œå·ä¸ªæ‡’ï¼Œä¸è¦å­¦</span><br><span class="hljs-keyword">return</span> (*c.v.Load().(*[]<span class="hljs-keyword">int</span>))<br>&#125;<br><br><span class="hljs-comment">// Set set config data</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Config)</span> <span class="hljs-title">Set</span><span class="hljs-params">(n []<span class="hljs-keyword">int</span>)</span></span> &#123;<br>c.v.Store(&amp;n)<br>&#125;<br></code></pre></td></tr></table></figure><p>è·‘ä¸€ä¸ªä¸€æ ·çš„æµ‹è¯•ï¼Œå¯ä»¥å‘ç° atomic çš„æ€§èƒ½åˆå¥½ä¸Šäº†è®¸å¤š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">â¯ <span class="hljs-keyword">go</span> test -race -bench=.<br>goos: linux<br>goarch: amd64<br>pkg: github.com/mohuishou/<span class="hljs-keyword">go</span>-training/Week03/blog/<span class="hljs-number">05</span>_atomic<br>BenchmarkMutexConfig<span class="hljs-number">-4</span>           <span class="hljs-number">1021684</span>              <span class="hljs-number">1121</span> ns/op<br>BenchmarkRWMutexConfig<span class="hljs-number">-4</span>         <span class="hljs-number">2604524</span>               <span class="hljs-number">433</span> ns/op<br>BenchmarkConfig<span class="hljs-number">-4</span>                <span class="hljs-number">6941658</span>               <span class="hljs-number">170</span> ns/op<br>PASS<br></code></pre></td></tr></table></figure><p><code>atomic.Value</code>  è¿™ç§é€‚åˆé…ç½®æ–‡ä»¶è¿™ç§è¯»ç‰¹åˆ«å¤šï¼Œå†™ç‰¹åˆ«å°‘çš„åœºæ™¯ï¼Œå› ä¸ºä»–æ˜¯ COWï¼ˆCopy On Writeï¼‰å†™æ—¶å¤åˆ¶çš„ä¸€ç§æ€æƒ³ï¼ŒCOW å°±æ˜¯æŒ‡æˆ‘éœ€è¦å†™å…¥çš„æ—¶å€™æˆ‘å…ˆæŠŠè€çš„æ•°æ®å¤åˆ¶ä¸€ä»½åˆ°ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œç„¶åå†å†™å…¥æ–°çš„å€¼ã€‚<br>æˆ‘ä»¬çœ‹çœ‹ç»´åŸºç™¾ç§‘çš„æè¿°ï¼Œæˆ‘è§‰å¾—å·²ç»è¯´å¾—å¾ˆæ¸…æ¥šäº†</p><blockquote><p>å†™å…¥æ—¶å¤åˆ¶ï¼ˆè‹±è¯­ï¼šCopy-on-writeï¼Œç®€ç§° COWï¼‰æ˜¯ä¸€ç§è®¡ç®—æœºç¨‹åºè®¾è®¡é¢†åŸŸçš„ä¼˜åŒ–ç­–ç•¥ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœæœ‰å¤šä¸ªè°ƒç”¨è€…ï¼ˆcallersï¼‰åŒæ—¶è¯·æ±‚ç›¸åŒèµ„æºï¼ˆå¦‚å†…å­˜æˆ–ç£ç›˜ä¸Šçš„æ•°æ®å­˜å‚¨ï¼‰ï¼Œä»–ä»¬ä¼šå…±åŒè·å–ç›¸åŒçš„æŒ‡é’ˆæŒ‡å‘ç›¸åŒçš„èµ„æºï¼Œç›´åˆ°æŸä¸ªè°ƒç”¨è€…è¯•å›¾ä¿®æ”¹èµ„æºçš„å†…å®¹æ—¶ï¼Œç³»ç»Ÿæ‰ä¼šçœŸæ­£å¤åˆ¶ä¸€ä»½ä¸“ç”¨å‰¯æœ¬ï¼ˆprivate copyï¼‰ç»™è¯¥è°ƒç”¨è€…ï¼Œè€Œå…¶ä»–è°ƒç”¨è€…æ‰€è§åˆ°çš„æœ€åˆçš„èµ„æºä»ç„¶ä¿æŒä¸å˜ã€‚è¿™è¿‡ç¨‹å¯¹å…¶ä»–çš„è°ƒç”¨è€…éƒ½æ˜¯é€æ˜çš„ã€‚æ­¤ä½œæ³•ä¸»è¦çš„ä¼˜ç‚¹æ˜¯å¦‚æœè°ƒç”¨è€…æ²¡æœ‰ä¿®æ”¹è¯¥èµ„æºï¼Œå°±ä¸ä¼šæœ‰å‰¯æœ¬ï¼ˆprivate copyï¼‰è¢«åˆ›å»ºï¼Œå› æ­¤å¤šä¸ªè°ƒç”¨è€…åªæ˜¯è¯»å–æ“ä½œæ—¶å¯ä»¥å…±äº«åŒä¸€ä»½èµ„æºã€‚</p></blockquote><p>è¿™ç§æ€è·¯ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¯èƒ½æœ‰éƒ¨åˆ† goroutine åœ¨ä½¿ç”¨è€çš„å¯¹è±¡ï¼Œæ‰€ä»¥è€çš„å¯¹è±¡ä¸ä¼šç«‹å³è¢«å›æ”¶ï¼Œå¦‚æœå­˜åœ¨å¤§é‡å†™å…¥çš„è¯ï¼Œä¼šå¯¼è‡´äº§ç”Ÿå¤§é‡çš„å‰¯æœ¬ï¼Œæ€§èƒ½åè€Œä¸ä¸€å®šå¥½ ã€‚<br>è¿™ç§æ–¹å¼çš„å¥½å¤„å°±æ˜¯ä¸ç”¨åŠ é”ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šæœ‰ goroutine çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¹¶ä¸”åœ¨è¯»å–çš„æ—¶å€™å¤§å®¶éƒ½è¯»å–çš„ç›¸åŒçš„å‰¯æœ¬æ‰€ä»¥æ€§èƒ½ä¸Šå›å¥½ä¸€äº›ã€‚<br>COW ç­–ç•¥åœ¨ linuxï¼Œ redis å½“ä¸­éƒ½ç”¨çš„å¾ˆå¤šï¼Œå…·ä½“å¯ä»¥çœ‹ä¸€ä¸‹æˆ‘åé¢çš„å‚è€ƒæ–‡çŒ®ï¼Œæœ¬æ–‡å°±ä¸å±•å¼€è®²äº†ã€‚</p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="æ–¹æ³•ä¸€è§ˆ"><a href="#æ–¹æ³•ä¸€è§ˆ" class="headerlink" title="æ–¹æ³•ä¸€è§ˆ"></a>æ–¹æ³•ä¸€è§ˆ</h3><p>å¦‚æœå»çœ‹æ–‡æ¡£ä¼šå‘ç° atomic çš„å‡½æ•°ç­¾åæœ‰å¾ˆå¤šï¼Œä½†æ˜¯å¤§éƒ¨åˆ†éƒ½æ˜¯é‡å¤çš„ä¸ºäº†ä¸åŒçš„æ•°æ®ç±»å‹åˆ›å»ºäº†ä¸åŒçš„ç­¾åï¼Œè¿™å°±æ˜¯æ²¡æœ‰æ³›å‹çš„åå¤„äº†ï¼ŒåŸºç¡€åº“ä¼šæ¯”è¾ƒéº»çƒ¦</p><p>1ã€ç¬¬ä¸€ç±» <code>AddXXX</code>  å½“éœ€è¦æ·»åŠ çš„å€¼ä¸ºè´Ÿæ•°çš„æ—¶å€™ï¼Œåšå‡æ³•ï¼Œæ­£æ•°åšåŠ æ³•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ç¬¬ä¸€ç±»ï¼ŒAddXXXï¼Œdelta ä¸º</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AddInt32</span><span class="hljs-params">(addr *<span class="hljs-keyword">int32</span>, delta <span class="hljs-keyword">int32</span>)</span> <span class="hljs-params">(<span class="hljs-built_in">new</span> <span class="hljs-keyword">int32</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AddInt64</span><span class="hljs-params">(addr *<span class="hljs-keyword">int64</span>, delta <span class="hljs-keyword">int64</span>)</span> <span class="hljs-params">(<span class="hljs-built_in">new</span> <span class="hljs-keyword">int64</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AddUint32</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint32</span>, delta <span class="hljs-keyword">uint32</span>)</span> <span class="hljs-params">(<span class="hljs-built_in">new</span> <span class="hljs-keyword">uint32</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AddUint64</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint64</span>, delta <span class="hljs-keyword">uint64</span>)</span> <span class="hljs-params">(<span class="hljs-built_in">new</span> <span class="hljs-keyword">uint64</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AddUintptr</span><span class="hljs-params">(addr *<span class="hljs-keyword">uintptr</span>, delta <span class="hljs-keyword">uintptr</span>)</span> <span class="hljs-params">(<span class="hljs-built_in">new</span> <span class="hljs-keyword">uintptr</span>)</span></span><br></code></pre></td></tr></table></figure><p>2ã€ç¬¬äºŒç±» <code>CompareAndSwapXXX</code> CAS æ“ä½œï¼Œ  ä¼šå…ˆæ¯”è¾ƒä¼ å…¥çš„åœ°å€çš„å€¼æ˜¯å¦æ˜¯ oldï¼Œå¦‚æœæ˜¯çš„è¯å°±å°è¯•èµ‹æ–°å€¼ï¼Œå¦‚æœä¸æ˜¯çš„è¯å°±ç›´æ¥è¿”å› falseï¼Œè¿”å› true æ—¶è¡¨ç¤ºèµ‹å€¼æˆåŠŸã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapInt32</span><span class="hljs-params">(addr *<span class="hljs-keyword">int32</span>, old, <span class="hljs-built_in">new</span> <span class="hljs-keyword">int32</span>)</span> <span class="hljs-params">(swapped <span class="hljs-keyword">bool</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapInt64</span><span class="hljs-params">(addr *<span class="hljs-keyword">int64</span>, old, <span class="hljs-built_in">new</span> <span class="hljs-keyword">int64</span>)</span> <span class="hljs-params">(swapped <span class="hljs-keyword">bool</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapPointer</span><span class="hljs-params">(addr *unsafe.Pointer, old, <span class="hljs-built_in">new</span> unsafe.Pointer)</span> <span class="hljs-params">(swapped <span class="hljs-keyword">bool</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapUint32</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint32</span>, old, <span class="hljs-built_in">new</span> <span class="hljs-keyword">uint32</span>)</span> <span class="hljs-params">(swapped <span class="hljs-keyword">bool</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapUint64</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint64</span>, old, <span class="hljs-built_in">new</span> <span class="hljs-keyword">uint64</span>)</span> <span class="hljs-params">(swapped <span class="hljs-keyword">bool</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapUintptr</span><span class="hljs-params">(addr *<span class="hljs-keyword">uintptr</span>, old, <span class="hljs-built_in">new</span> <span class="hljs-keyword">uintptr</span>)</span> <span class="hljs-params">(swapped <span class="hljs-keyword">bool</span>)</span></span><br></code></pre></td></tr></table></figure><p>3ã€ç¬¬ä¸‰ç±» <code>LoadXXX</code> ï¼Œä»æŸä¸ªåœ°å€ä¸­å–å€¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadInt32</span><span class="hljs-params">(addr *<span class="hljs-keyword">int32</span>)</span> <span class="hljs-params">(val <span class="hljs-keyword">int32</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadInt64</span><span class="hljs-params">(addr *<span class="hljs-keyword">int64</span>)</span> <span class="hljs-params">(val <span class="hljs-keyword">int64</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadPointer</span><span class="hljs-params">(addr *unsafe.Pointer)</span> <span class="hljs-params">(val unsafe.Pointer)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadUint32</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint32</span>)</span> <span class="hljs-params">(val <span class="hljs-keyword">uint32</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadUint64</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint64</span>)</span> <span class="hljs-params">(val <span class="hljs-keyword">uint64</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadUintptr</span><span class="hljs-params">(addr *<span class="hljs-keyword">uintptr</span>)</span> <span class="hljs-params">(val <span class="hljs-keyword">uintptr</span>)</span></span><br></code></pre></td></tr></table></figure><p>4ã€ç¬¬å››ç±» <code>StoreXXX</code> ï¼Œç»™æŸä¸ªåœ°å€èµ‹å€¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StoreInt32</span><span class="hljs-params">(addr *<span class="hljs-keyword">int32</span>, val <span class="hljs-keyword">int32</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StoreInt64</span><span class="hljs-params">(addr *<span class="hljs-keyword">int64</span>, val <span class="hljs-keyword">int64</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StorePointer</span><span class="hljs-params">(addr *unsafe.Pointer, val unsafe.Pointer)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StoreUint32</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint32</span>, val <span class="hljs-keyword">uint32</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StoreUint64</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint64</span>, val <span class="hljs-keyword">uint64</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StoreUintptr</span><span class="hljs-params">(addr *<span class="hljs-keyword">uintptr</span>, val <span class="hljs-keyword">uintptr</span>)</span></span><br></code></pre></td></tr></table></figure><p>5ã€ç¬¬äº”ç±» <code>SwapXXX</code> ï¼Œäº¤æ¢ä¸¤ä¸ªå€¼ï¼Œå¹¶ä¸”è¿”å›è€çš„å€¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapInt32</span><span class="hljs-params">(addr *<span class="hljs-keyword">int32</span>, <span class="hljs-built_in">new</span> <span class="hljs-keyword">int32</span>)</span> <span class="hljs-params">(old <span class="hljs-keyword">int32</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapInt64</span><span class="hljs-params">(addr *<span class="hljs-keyword">int64</span>, <span class="hljs-built_in">new</span> <span class="hljs-keyword">int64</span>)</span> <span class="hljs-params">(old <span class="hljs-keyword">int64</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapPointer</span><span class="hljs-params">(addr *unsafe.Pointer, <span class="hljs-built_in">new</span> unsafe.Pointer)</span> <span class="hljs-params">(old unsafe.Pointer)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapUint32</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint32</span>, <span class="hljs-built_in">new</span> <span class="hljs-keyword">uint32</span>)</span> <span class="hljs-params">(old <span class="hljs-keyword">uint32</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapUint64</span><span class="hljs-params">(addr *<span class="hljs-keyword">uint64</span>, <span class="hljs-built_in">new</span> <span class="hljs-keyword">uint64</span>)</span> <span class="hljs-params">(old <span class="hljs-keyword">uint64</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapUintptr</span><span class="hljs-params">(addr *<span class="hljs-keyword">uintptr</span>, <span class="hljs-built_in">new</span> <span class="hljs-keyword">uintptr</span>)</span> <span class="hljs-params">(old <span class="hljs-keyword">uintptr</span>)</span></span><br></code></pre></td></tr></table></figure><p>6ã€æœ€åä¸€ç±» <code>Value</code>  ç”¨äºä»»æ„ç±»å‹çš„å€¼çš„ Storeã€Loadï¼Œæˆ‘ä»¬å¼€å§‹çš„æ¡ˆä¾‹å°±ç”¨åˆ°äº†è¿™ä¸ªï¼Œè¿™æ˜¯ 1.4 ç‰ˆæœ¬ä¹‹åå¼•å…¥çš„ï¼Œç­¾åçš„æ–¹æ³•éƒ½åªèƒ½ä½œç”¨äºç‰¹å®šçš„ç±»å‹ï¼Œå¼•å…¥è¿™ä¸ªæ–¹æ³•ä¹‹åå°±å¯ä»¥ç”¨äºä»»æ„ç±»å‹äº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Value<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(v *Value)</span> <span class="hljs-title">Load</span><span class="hljs-params">()</span> <span class="hljs-params">(x <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(v *Value)</span> <span class="hljs-title">Store</span><span class="hljs-params">(x <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span><br></code></pre></td></tr></table></figure><h3 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h3><p>åœ¨ <code>sync/atomic</code>  åŒ…ä¸­çš„æºç é™¤äº† <code>Value</code>  ä¹‹å¤–å…¶ä»–çš„å‡½æ•°éƒ½æ˜¯æ²¡æœ‰ç›´æ¥çš„æºç çš„ï¼Œéœ€è¦å» <code>runtime/internal/atomic</code>  ä¸­æ‰¾å¯»ï¼Œè¿™é‡Œä¸º <code>CAS</code>  å‡½æ•°ä¸ºä¾‹ï¼Œå…¶ä»–çš„éƒ½æ˜¯å¤§åŒå°å¼‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// bool Cas(int32 *val, int32 old, int32 new)</span><br><span class="hljs-comment">// Atomically:</span><br><span class="hljs-comment">//if(*val == old)&#123;</span><br><span class="hljs-comment">//*val = new;</span><br><span class="hljs-comment">//return 1;</span><br><span class="hljs-comment">//&#125; else</span><br><span class="hljs-comment">//return 0;</span><br>TEXT runtimeâˆ•internalâˆ•atomicÂ·Cas(SB),NOSPLIT,$<span class="hljs-number">0</span><span class="hljs-number">-17</span><br>MOVQptr+<span class="hljs-number">0</span>(FP), BX<br>MOVLold+<span class="hljs-number">8</span>(FP), AX<br>MOVL<span class="hljs-built_in">new</span>+<span class="hljs-number">12</span>(FP), CX<br>LOCK<br>CMPXCHGLCX, <span class="hljs-number">0</span>(BX)<br>SETEQret+<span class="hljs-number">16</span>(FP)<br>RET<br></code></pre></td></tr></table></figure><p>åœ¨æ³¨é‡Šéƒ¨åˆ†å†™çš„éå¸¸æ¸…æ¥šï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯å…ˆæ¯”è¾ƒä¸€ä¸‹å½“å‰ä¼ å…¥çš„åœ°å€çš„å€¼æ˜¯å¦å’Œ old å€¼ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰ï¼Œå°±èµ‹å€¼æ–°å€¼è¿”å› trueï¼Œå¦‚æœä¸ç›¸ç­‰å°±è¿”å› false<br>æˆ‘ä»¬çœ‹è¿™ä¸ªå…·ä½“æ±‡ç¼–ä»£ç å°±å¯ä»¥å‘ç°ï¼Œä½¿ç”¨äº† <code>LOCK</code>  æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œã€Š<a href="https://lailin.xyz/post/go-training-week3-go-memory-model.html#%E5%86%85%E5%AD%98%E9%87%8D%E6%8E%92">Week03: Go å¹¶å‘ç¼–ç¨‹(äºŒ) Go å†…å­˜æ¨¡å‹</a>ã€‹æåˆ°è¿‡çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œ <code>CMPXCHG</code>  æŒ‡ä»¤å…¶å®å°±æ˜¯ CPU å®ç°çš„ CAS æ“ä½œã€‚</p><div style="background: #FFFBE6;padding:10px;border: 1px solid #C3C3C3;border-radius:5px;margin-bottom:5px;">å…³äº LOCK æŒ‡ä»¤é€šè¿‡æŸ¥é˜… intel çš„æ‰‹å†Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå¯¹äºP6ä¹‹å‰çš„å¤„ç†å™¨ï¼ŒLOCK æŒ‡ä»¤ä¼šæ€»æ˜¯é”æ€»çº¿ï¼Œä½†æ˜¯ P6 ä¹‹åå¯èƒ½ä¼šæ‰§è¡Œâ€œç¼“å­˜é”å®šâ€ï¼Œå¦‚æœè¢«é”å®šçš„å†…å­˜åŒºåŸŸè¢«ç¼“å­˜åœ¨äº†å¤„ç†å™¨ä¸­ï¼Œè¿™ä¸ªæ—¶å€™ä¼šé€šè¿‡ç¼“å­˜ä¸€è‡´æ€§æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§</div><h3 id="Value"><a href="#Value" class="headerlink" title="Value"></a>Value</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Value <span class="hljs-keyword">struct</span> &#123;<br>v <span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æ„éå¸¸ç®€å•ï¼Œåªæœ‰ä¸€ä¸ª v ç”¨æ¥ä¿å­˜ä¼ å…¥çš„å€¼</p><h4 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h4><p>æˆ‘ä»¬å…ˆçœ‹çœ‹ store æ–¹æ³•ï¼Œstore æ–¹æ³•ä¼šå°†å€¼å­˜å‚¨ä¸º xï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ï¼Œæ¯æ¬¡ä¼ å…¥çš„ x ä¸èƒ½ä¸º nilï¼Œå¹¶ä¸”ä»–ä»¬ç±»å‹å¿…é¡»æ˜¯ç›¸åŒçš„ï¼Œä¸ç„¶ä¼šå¯¼è‡´ panic</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(v *Value)</span> <span class="hljs-title">Store</span><span class="hljs-params">(x <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br><span class="hljs-keyword">if</span> x == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;sync/atomic: store of nil value into Value&quot;</span>)<br>&#125;<br>    <span class="hljs-comment">// ifaceWords å…¶å®å°±æ˜¯å®šä¹‰äº†ä¸€ä¸‹ interface çš„ç»“æ„ï¼ŒåŒ…å« data å’Œ type ä¸¤éƒ¨åˆ†</span><br>    <span class="hljs-comment">// è¿™é‡Œ vp æ˜¯åŸæœ‰å€¼</span><br>    <span class="hljs-comment">// xp æ˜¯ä¼ å…¥çš„å€¼</span><br>vp := (*ifaceWords)(unsafe.Pointer(v))<br>xp := (*ifaceWords)(unsafe.Pointer(&amp;x))<br>    <span class="hljs-comment">// for å¾ªç¯ä¸æ–­å°è¯•</span><br><span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-comment">// è¿™é‡Œå…ˆç”¨åŸå­æ–¹æ³•å–ä¸€ä¸‹è€çš„ç±»å‹å€¼</span><br>typ := LoadPointer(&amp;vp.typ)<br><span class="hljs-keyword">if</span> typ == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-comment">// ç­‰äº nil å°±è¯´æ˜è¿™æ˜¯ç¬¬ä¸€æ¬¡ store</span><br>            <span class="hljs-comment">// è°ƒç”¨ runtime çš„æ–¹æ³•ç¦æ­¢æŠ¢å ï¼Œé¿å…æ“ä½œå®Œæˆä¸€åŠå°±è¢«æŠ¢å äº†</span><br>            <span class="hljs-comment">// åŒæ—¶å¯ä»¥é¿å… GC çš„æ—¶å€™çœ‹åˆ° unsafe.Pointer(^uintptr(0)) è¿™ä¸ªä¸­é—´çŠ¶æ€çš„å€¼</span><br>runtime_procPin()<br><span class="hljs-keyword">if</span> !CompareAndSwapPointer(&amp;vp.typ, <span class="hljs-literal">nil</span>, unsafe.Pointer(^<span class="hljs-keyword">uintptr</span>(<span class="hljs-number">0</span>))) &#123;<br>runtime_procUnpin()<br><span class="hljs-keyword">continue</span><br>&#125;<br><br><span class="hljs-comment">// åˆ†åˆ«æŠŠå€¼å’Œç±»å‹ä¿å­˜ä¸‹æ¥</span><br>StorePointer(&amp;vp.data, xp.data)<br>StorePointer(&amp;vp.typ, xp.typ)<br>runtime_procUnpin()<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">uintptr</span>(typ) == ^<span class="hljs-keyword">uintptr</span>(<span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// å¦‚æœåˆ¤æ–­å‘ç°è¿™ä¸ªç±»å‹æ˜¯è¿™ä¸ªå›ºå®šå€¼ï¼Œè¯´æ˜å½“å‰ç¬¬ä¸€æ¬¡èµ‹å€¼è¿˜æ²¡æœ‰å®Œæˆï¼Œæ‰€ä»¥è¿›å…¥è‡ªæ—‹ç­‰å¾…</span><br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-comment">// ç¬¬ä¸€æ¬¡èµ‹å€¼å·²ç»å®Œæˆï¼Œåˆ¤æ–­æ–°çš„èµ‹å€¼çš„ç±»å‹å’Œä¹‹å‰æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´å°±ç›´æ¥ panic</span><br><span class="hljs-keyword">if</span> typ != xp.typ &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;sync/atomic: store of inconsistently typed value into Value&quot;</span>)<br>&#125;<br>        <span class="hljs-comment">// ä¿å­˜å€¼</span><br>StorePointer(&amp;vp.data, xp.data)<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…·ä½“çš„é€»è¾‘éƒ½å†™åœ¨æ³¨é‡Šä¸­äº†ï¼Œè¿™é‡Œé¢å¤æ‚é€»è¾‘åœ¨ç¬¬ä¸€æ¬¡å†™å…¥ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡å†™å…¥çš„æ—¶å€™æœ‰ä¸¤æ¬¡åŸå­å†™æ“ä½œï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ç”¨ typ å€¼ä½œä¸ºä¸€ä¸ªåˆ¤æ–­ï¼Œé€šè¿‡ä¸åŒå€¼åˆ¤æ–­å½“å‰æ‰€å¤„çš„çŠ¶æ€ï¼Œè¿™ä¸ªåœ¨æˆ‘ä»¬ä¸šåŠ¡ä»£ç ä¸­å…¶å®ä¹Ÿç»å¸¸ç”¨åˆ°ã€‚ç„¶åå› ä¸ºå¼•å…¥äº†è¿™ä¸ªä¸­é—´çŠ¶æ€ï¼Œæ‰€ä»¥åˆä½¿ç”¨äº† <code>runtime_procPin</code>  æ–¹æ³•é¿å…æŠ¢å </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sync_runtime_procPin</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123;<br><span class="hljs-keyword">return</span> procPin()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">procPin</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123;<br>    <span class="hljs-comment">// è·å–åˆ°å½“å‰ goroutine çš„ m</span><br>_g_ := getg()<br>mp := _g_.m<br><br>    <span class="hljs-comment">// unpin çš„æ—¶å€™å°±æ˜¯ locks--</span><br>mp.locks++<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">int</span>(mp.p.ptr().id)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Load"><a href="#Load" class="headerlink" title="Load"></a>Load</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(v *Value)</span> <span class="hljs-title">Load</span><span class="hljs-params">()</span> <span class="hljs-params">(x <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>vp := (*ifaceWords)(unsafe.Pointer(v))<br>    <span class="hljs-comment">// å…ˆæ‹¿åˆ°ç±»å‹å€¼</span><br>typ := LoadPointer(&amp;vp.typ)<br>    <span class="hljs-comment">// è¿™ä¸ªè¯´æ˜è¿˜æ²¡æœ‰ç¬¬ä¸€æ¬¡ store æˆ–è€…æ˜¯ç¬¬ä¸€æ¬¡ store è¿˜æ²¡æœ‰å®Œæˆ</span><br><span class="hljs-keyword">if</span> typ == <span class="hljs-literal">nil</span> || <span class="hljs-keyword">uintptr</span>(typ) == ^<span class="hljs-keyword">uintptr</span>(<span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">// First store not yet completed.</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br>    <span class="hljs-comment">// è·å–å€¼</span><br>data := LoadPointer(&amp;vp.data)<br>    <span class="hljs-comment">// æ„é€  x ç±»å‹</span><br>xp := (*ifaceWords)(unsafe.Pointer(&amp;x))<br>xp.typ = typ<br>xp.data = data<br><span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å®æˆ˜-å®ç°ä¸€ä¸ªâ€œæ— é”â€æ ˆ"><a href="#å®æˆ˜-å®ç°ä¸€ä¸ªâ€œæ— é”â€æ ˆ" class="headerlink" title="å®æˆ˜: å®ç°ä¸€ä¸ªâ€œæ— é”â€æ ˆ"></a>å®æˆ˜: å®ç°ä¸€ä¸ªâ€œæ— é”â€æ ˆ</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;sync/atomic&quot;</span><br><span class="hljs-string">&quot;unsafe&quot;</span><br>)<br><br><span class="hljs-comment">// LFStack æ— é”æ ˆ</span><br><span class="hljs-comment">// ä½¿ç”¨é“¾è¡¨å®ç°</span><br><span class="hljs-keyword">type</span> LFStack <span class="hljs-keyword">struct</span> &#123;<br>head unsafe.Pointer <span class="hljs-comment">// æ ˆé¡¶</span><br>&#125;<br><br><span class="hljs-comment">// Node èŠ‚ç‚¹</span><br><span class="hljs-keyword">type</span> Node <span class="hljs-keyword">struct</span> &#123;<br>val  <span class="hljs-keyword">int32</span><br>next unsafe.Pointer<br>&#125;<br><br><span class="hljs-comment">// NewLFStack NewLFStack</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewLFStack</span><span class="hljs-params">()</span> *<span class="hljs-title">LFStack</span></span> &#123;<br>n := unsafe.Pointer(&amp;Node&#123;&#125;)<br><span class="hljs-keyword">return</span> &amp;LFStack&#123;head: n&#125;<br>&#125;<br><br><span class="hljs-comment">// Push å…¥æ ˆ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *LFStack)</span> <span class="hljs-title">Push</span><span class="hljs-params">(v <span class="hljs-keyword">int32</span>)</span></span> &#123;<br>n := &amp;Node&#123;val: v&#125;<br><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-comment">// å…ˆå–å‡ºæ ˆé¡¶</span><br>old := atomic.LoadPointer(&amp;s.head)<br>n.next = old<br><span class="hljs-keyword">if</span> atomic.CompareAndSwapPointer(&amp;s.head, old, unsafe.Pointer(n)) &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Pop å‡ºæ ˆï¼Œæ²¡æœ‰æ•°æ®æ—¶è¿”å› nil</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *LFStack)</span> <span class="hljs-title">Pop</span><span class="hljs-params">()</span> <span class="hljs-title">int32</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-comment">// å…ˆå–å‡ºæ ˆé¡¶</span><br>old := atomic.LoadPointer(&amp;s.head)<br><span class="hljs-keyword">if</span> old == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>&#125;<br><br>oldNode := (*Node)(old)<br><span class="hljs-comment">// å–å‡ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br>next := atomic.LoadPointer(&amp;oldNode.next)<br><span class="hljs-comment">// é‡ç½®æ ˆé¡¶</span><br><span class="hljs-keyword">if</span> atomic.CompareAndSwapPointer(&amp;s.head, old, next) &#123;<br><span class="hljs-keyword">return</span> oldNode.val<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„æ— é”å…¶å®åªæ˜¯æ²¡ç”¨äº’æ–¥é”ï¼Œç”¨äº†åŸå­æ“ä½œï¼Œå‰é¢æˆ‘ä»¬çœ‹ atomic çš„æºç çš„æ—¶å€™å¯ä»¥å‘ç°å®é™…ä¸Šåœ¨ CPU ä¸Šè¿˜æ˜¯æœ‰é”çš„ï¼Œåªæ˜¯æˆ‘ä»¬è¿™ä¸ªé”çš„ç²’åº¦éå¸¸å°</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è™½ç„¶åœ¨ä¸€äº›æƒ…å†µä¸‹ atomic çš„æ€§èƒ½è¦å¥½å¾ˆå¤šï¼Œä½†æ˜¯è¿™ä¸ªæ˜¯ä¸€ä¸ª low level çš„åº“ï¼Œåœ¨å®é™…çš„ä¸šåŠ¡ä»£ç ä¸­æœ€å¥½è¿˜æ˜¯ä½¿ç”¨ channel ä½†æ˜¯æˆ‘ä»¬ä¹Ÿéœ€è¦çŸ¥é“ï¼Œåœ¨ä¸€äº›åŸºç¡€åº“ï¼Œæˆ–è€…æ˜¯éœ€è¦æè‡´æ€§èƒ½çš„åœ°æ–¹ç”¨ä¸Šè¿™ä¸ªè¿˜æ˜¯å¾ˆçˆ½çš„ï¼Œä½†æ˜¯ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ä¸€å®šè¦å°å¿ƒï¼Œä¸ç„¶è¿˜æ˜¯ä¼šå®¹æ˜“å‡º bugã€‚</p><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ol><li><a href="https://pkg.go.dev/sync/atomic">https://pkg.go.dev/sync/atomic</a></li><li><a href="https://blog.betacat.io/post/golang-atomic-value-exploration/">Go è¯­è¨€æ ‡å‡†åº“ä¸­ atomic.Value çš„å‰ä¸–ä»Šç”Ÿ</a></li><li><a href="https://xie.infoq.cn/article/562eff7a1108a7a2bc46058ca">æ·±å…¥æµ…å‡º Go - sync/atomic æºç åˆ†æ</a></li><li><a href="https://juejin.cn/post/6844903702373859335">COW å¥¶ç‰›ï¼Copy On Write æœºåˆ¶äº†è§£ä¸€ä¸‹</a></li><li><a href="https://zh.wikipedia.org/wiki/%E5%AF%AB%E5%85%A5%E6%99%82%E8%A4%87%E8%A3%BD">ç»´åŸºç™¾ç§‘: COW</a></li><li><a href="https://albk.tech/%E8%81%8A%E8%81%8ACPU%E7%9A%84LOCK%E6%8C%87%E4%BB%A4.html">èŠèŠ CPU çš„ LOCK æŒ‡ä»¤</a></li><li><a href="https://zhuanlan.zhihu.com/p/24146167">æµ…è®º Lock ä¸ X86 Cache ä¸€è‡´æ€§</a></li><li><a href="https://software.intel.com/sites/default/files/managed/39/c5/325462-sdm-vol-1-2abcd-3abcd.pdf">intel æ‰‹å†Œ</a></li><li><a href="https://colobu.com/2020/08/14/lock-free-queue-in-go/">ä½¿ç”¨ Go å®ç° lock-free çš„é˜Ÿåˆ—</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week03: Go å¹¶å‘ç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¹¶å‘</tag>
      
      <tag>atomic</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¹¶å‘ç¼–ç¨‹(å››) æ·±å…¥ç†è§£ Mutex</title>
    <link href="/post/go-training-week3-sync.html"/>
    <url>/post/go-training-week3-sync.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h1 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h1><p>å‰é¢å‡ ç¯‡æ–‡ç« å½“ä¸­æˆ‘ä»¬éƒ½åå¤æåˆ°äº† goroutine å»ºæ˜¯ç®€å•çš„ï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶è¦å°å¿ƒï¼Œä¹ æƒ¯æ€»ä¼šä¸ç»æ„é—´çš„å¯¼è‡´æˆ‘ä»¬å†™å‡ºå¾ˆå¤š bug å¯¹äºè¯­è¨€è§„èŒƒæ²¡æœ‰å®šä¹‰çš„å†…å®¹æˆ‘ä»¬ä¸è¦åšä»»ä½•å‡è®¾ã€‚æˆ‘ä»¬éœ€è¦é€šè¿‡åŒæ­¥è¯­ä¹‰æ§åˆ¶ä»–ä»¬çš„æ‰§è¡Œé¡ºåºï¼Œå…³äºä¹‹å‰çš„å†…å®¹å¯ä»¥çœ‹å‰é¢çš„ä¸‰ç¯‡æ–‡ç« ï¼š</p><ul><li><a href="https://lailin.xyz/post/go-training-week3-goroutine.html">Week03: Go å¹¶å‘ç¼–ç¨‹(ä¸€) goroutine</a></li><li><a href="https://lailin.xyz/post/go-training-week3-go-memory-model.html">Week03: Go å¹¶å‘ç¼–ç¨‹(äºŒ) Go å†…å­˜æ¨¡å‹</a></li><li><a href="https://lailin.xyz/post/go-training-week3-data-race.html">Week03: Go å¹¶å‘ç¼–ç¨‹(ä¸‰) data race</a></li></ul><p>æ¥ä¸‹æ¥çš„å‡ ç¯‡æ–‡ç« å°±è®©æˆ‘ä»¬æˆ‘ä»¬ä¸€èµ·æ¥äº†è§£ä¸€ä¸‹ sync åŒ…ç›¸å…³çš„ä¸€äº›ç”¨æ³•ï¼Œä»¥åŠéƒ¨åˆ†å®ç°åŸç†ï¼Œå½“ç„¶è¿™é‡Œè¯´æ˜¯ sync åŒ…ï¼Œå®é™…ä¸ŠåŒ…å«äº†ä¸‰ä¸ªåŒ…åˆ†åˆ«æ˜¯: sync, sync/atomic, golang.org/x/sync/errgroup</p><div style="background: #FFFBE6;padding:10px;border: 1px solid #C3C3C3;border-radius:5px;margin-bottom:5px;">è¿™äº›åŒ…æä¾›äº†ä¸€äº›åŸºç¡€çš„åŒæ­¥è¯­ä¹‰ï¼Œä½†æ˜¯åœ¨å®é™…çš„å¹¶å‘ç¼–ç¨‹å½“ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ channel æ¥è¿›è¡ŒåŒæ­¥æ§åˆ¶ã€‚â€œShare memory by communicating; donâ€™t communicate by sharing memory.â€</div><h1 id="Mutex"><a href="#Mutex" class="headerlink" title="Mutex"></a>Mutex</h1><h2 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ä¸Šä¸€ç¯‡æ–‡ç« è¯´åˆ°çš„ä¾‹å­åº”è¯¥æ€ä¹ˆæ”¹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> mu sync.Mutex<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">2</span>; i++ &#123;<br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> routine(i)<br>&#125;<br>wg.Wait()<br>fmt.Printf(<span class="hljs-string">&quot;Final Counter: %d\n&quot;</span>, counter)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">routine</span><span class="hljs-params">(id <span class="hljs-keyword">int</span>)</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++ &#123;<br>mu.Lock()<br>counter++<br>mu.Unlock()<br>&#125;<br>wg.Done()<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦çš„ç›®çš„å°±æ˜¯ä¸ºäº†ä¿æŠ¤æˆ‘ä»¬ä¸´ç•ŒåŒºçš„æ•°æ®ï¼Œé€šè¿‡é”æ¥è¿›è¡Œä¿è¯ã€‚é”çš„ä½¿ç”¨éå¸¸çš„ç®€å•ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹</p><ul><li>é”çš„èŒƒå›´è¦å°½é‡çš„å°ï¼Œä¸è¦æå¾ˆå¤šå¤§é”</li><li>ç”¨é”ä¸€å®šè¦è§£é”ï¼Œå°å¿ƒäº§ç”Ÿæ­»é”</li></ul><h2 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åœ¨ Go ä¸­é”æ˜¯æ€ä¹ˆå®ç°çš„</p><h3 id="é”çš„å®ç°æ¨¡å¼-5"><a href="#é”çš„å®ç°æ¨¡å¼-5" class="headerlink" title="é”çš„å®ç°æ¨¡å¼[5]"></a>é”çš„å®ç°æ¨¡å¼[5]</h3><ul><li><strong>Barging</strong>: è¿™ç§æ¨¡å¼æ˜¯ä¸ºäº†æé«˜ååé‡ï¼Œå½“é”è¢«é‡Šæ”¾æ—¶ï¼Œå®ƒä¼šå”¤é†’ç¬¬ä¸€ä¸ªç­‰å¾…è€…ï¼Œç„¶åæŠŠé”ç»™ç¬¬ä¸€ä¸ªç­‰å¾…è€…æˆ–è€…ç»™ç¬¬ä¸€ä¸ªè¯·æ±‚é”çš„äºº</li></ul><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1608967840701-d8c54ee4-964b-49d0-8fab-6f98dd777fd2.png" alt="1_B1atM-b6GPDS0_Q_TPEUBw.png"></p><ul><li><strong>Handoff: </strong>å½“é”é‡Šæ”¾æ—¶å€™ï¼Œé”ä¼šä¸€ç›´æŒæœ‰ç›´åˆ°ç¬¬ä¸€ä¸ªç­‰å¾…è€…å‡†å¤‡å¥½è·å–é”ã€‚å®ƒé™ä½äº†ååé‡ï¼Œå› ä¸ºé”è¢«æŒæœ‰ï¼Œå³ä½¿å¦ä¸€ä¸ª goroutine å‡†å¤‡è·å–å®ƒã€‚<strong><em>è¿™ç§æ¨¡å¼å¯ä»¥è§£å†³å…¬å¹³æ€§çš„é—®é¢˜ï¼Œå› ä¸ºåœ¨ Barging æ¨¡å¼ä¸‹å¯èƒ½ä¼šå­˜åœ¨è¢«å”¤é†’çš„ goroutine æ°¸è¿œä¹Ÿè·å–ä¸åˆ°é”çš„æƒ…å†µï¼Œæ¯•ç«Ÿä¸€ç›´åœ¨ cpu ä¸Šè·‘ç€çš„ goroutine æ²¡æœ‰ä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šæ›´å¿«ä¸€äº›ã€‚ç¼ºç‚¹å°±æ˜¯æ€§èƒ½ä¼šç›¸å¯¹å·®ä¸€äº›</em></strong></li></ul><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1608967902210-d4c2937f-56fd-49e8-a5a3-903bec31e6fc.png" alt="image.png"></p><ul><li><strong>Spiningï¼š</strong>è‡ªæ—‹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…åº”ç”¨ç¨‹åºé‡åº¦ä½¿ç”¨é”æ—¶æ•ˆæœä¸é”™ã€‚Parking å’Œ Unparking goroutines æœ‰ä¸ä½çš„æ€§èƒ½æˆæœ¬å¼€é”€ï¼Œç›¸æ¯”è‡ªæ—‹æ¥è¯´è¦æ…¢å¾—å¤šã€‚<em><strong>ä½†æ˜¯è‡ªæ—‹æ˜¯æœ‰æˆæœ¬çš„ï¼Œæ‰€ä»¥åœ¨ go çš„å®ç°ä¸­è¿›å…¥è‡ªæ—‹çš„æ¡ä»¶ååˆ†çš„è‹›åˆ»ã€‚</strong></em></li></ul><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1608967913891-eb4cf780-6ffd-4a2d-a3d5-8e05d7e3fce3.png" alt="image.png"></p><h3 id="Go-Mutex-å®ç°åŸç†"><a href="#Go-Mutex-å®ç°åŸç†" class="headerlink" title="Go Mutex å®ç°åŸç†"></a>Go Mutex å®ç°åŸç†</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹åœ¨ Go ä¸­å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæˆ‘ä»¬å…ˆè®²åŸç†å†çœ‹æºç ï¼Œé¿å…çœ‹çš„äº‘é‡Œé›¾é‡Œçš„ã€‚**</p><h4 id="åŠ é”"><a href="#åŠ é”" class="headerlink" title="åŠ é”"></a>åŠ é”</h4><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒGo åœ¨ 1.15 çš„ç‰ˆæœ¬ä¸­é”çš„å®ç°ç»“åˆä¸Šé¢æåˆ°çš„ä¸‰ç§æ¨¡å¼ï¼Œè°ƒç”¨ Lock æ–¹æ³•çš„æ—¶å€™ã€‚</p><ol><li>é¦–å…ˆå¦‚æœå½“å‰é”å¤„äºåˆå§‹åŒ–çŠ¶æ€å°±ç›´æ¥ç”¨ CAS æ–¹æ³•å°è¯•è·å–é”ï¼Œè¿™æ˜¯<strong>_ Fast Path_</strong></li><li>å¦‚æœå¤±è´¥å°±è¿›å…¥<strong><em> Slow Path</em></strong><ol><li>ä¼šé¦–å…ˆåˆ¤æ–­å½“å‰èƒ½ä¸èƒ½è¿›å…¥è‡ªæ—‹çŠ¶æ€ï¼Œå¦‚æœå¯ä»¥å°±è¿›å…¥è‡ªæ—‹ï¼Œæœ€å¤šè‡ªæ—‹ 4 æ¬¡</li><li>è‡ªæ—‹å®Œæˆä¹‹åï¼Œå°±ä¼šå»è®¡ç®—å½“å‰çš„é”çš„çŠ¶æ€</li><li>ç„¶åå°è¯•é€šè¿‡ CAS è·å–é”</li><li>å¦‚æœæ²¡æœ‰è·å–åˆ°å°±è°ƒç”¨ <code>runtime_SemacquireMutex</code> æ–¹æ³•ä¼‘çœ å½“å‰ goroutine å¹¶ä¸”å°è¯•è·å–ä¿¡å·é‡</li><li>goroutine è¢«å”¤é†’ä¹‹åä¼šå…ˆåˆ¤æ–­å½“å‰æ˜¯å¦å¤„åœ¨é¥¥é¥¿çŠ¶æ€ï¼Œï¼ˆå¦‚æœå½“å‰ goroutine è¶…è¿‡ 1ms éƒ½æ²¡æœ‰è·å–åˆ°é”å°±ä¼šè¿›é¥¥é¥¿æ¨¡å¼ï¼‰ 1. å¦‚æœå¤„åœ¨é¥¥é¥¿çŠ¶æ€å°±ä¼šè·å¾—äº’æ–¥é”ï¼Œå¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸­åªå­˜åœ¨å½“å‰ Goroutineï¼Œäº’æ–¥é”è¿˜ä¼šä»é¥¥é¥¿æ¨¡å¼ä¸­é€€å‡º 1. å¦‚æœä¸åœ¨ï¼Œå°±ä¼šè®¾ç½®å”¤é†’å’Œé¥¥é¥¿æ ‡è®°ã€é‡ç½®è¿­ä»£æ¬¡æ•°å¹¶é‡æ–°æ‰§è¡Œè·å–é”çš„å¾ªç¯<br><div style="background: #FFFBE6;padding:10px;border: 1px solid #C3C3C3;border-radius:5px;margin-bottom:5px;">CAS æ–¹æ³•åœ¨è¿™é‡ŒæŒ‡çš„æ˜¯ <code>atomic.CompareAndSwapInt32(addr, old, new) bool</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå…ˆæ¯”è¾ƒä¼ å…¥çš„åœ°å€çš„å€¼æ˜¯å¦æ˜¯ oldï¼Œå¦‚æœæ˜¯çš„è¯å°±å°è¯•èµ‹æ–°å€¼ï¼Œå¦‚æœä¸æ˜¯çš„è¯å°±ç›´æ¥è¿”å› falseï¼Œè¿”å› true æ—¶è¡¨ç¤ºèµ‹å€¼æˆåŠŸ<br>é¥¥é¥¿æ¨¡å¼æ˜¯ Go 1.9 ç‰ˆæœ¬ä¹‹åå¼•å…¥çš„ä¼˜åŒ–ï¼Œç”¨äºè§£å†³å…¬å¹³æ€§çš„é—®é¢˜[10]</div><br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1608970759375-09d8cda7-77ac-48d3-b2f3-b8890e927bd4.svg" alt="02_Goè¿›é˜¶03_blog_sync.drawio.svg"></li></ol></li></ol><h4 id="è§£é”"><a href="#è§£é”" class="headerlink" title="è§£é”"></a>è§£é”</h4><p>è§£é”çš„æµç¨‹ç›¸å¯¹äºåŠ é”ç®€å•è®¸å¤š<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1608978117259-455cf28e-aa1e-46cf-8fd6-6040ed6c0a7a.svg" alt="02_Goè¿›é˜¶03_blog_sync.drawio.svg"></p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="Mutex-åŸºæœ¬ç»“æ„"><a href="#Mutex-åŸºæœ¬ç»“æ„" class="headerlink" title="Mutex åŸºæœ¬ç»“æ„"></a>Mutex åŸºæœ¬ç»“æ„</h3><p>çŸ¥é“å…¶ä¸­çš„åŸç†ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹æºç åˆ†æ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Mutex <span class="hljs-keyword">struct</span> &#123;<br>state <span class="hljs-keyword">int32</span><br>sema  <span class="hljs-keyword">uint32</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>Mutex</code>  ç»“æ„ä½“ç”± <code>state</code>  <code>sema</code>  ä¸¤ä¸ª 4 å­—èŠ‚æˆå‘˜ç»„æˆï¼Œå…¶ä¸­ <code>state</code>  è¡¨ç¤ºäº†å½“å‰é”çš„çŠ¶æ€ï¼Œ <code>sema</code>  æ˜¯ç”¨äºæ§åˆ¶é”çš„ä¿¡å·é‡<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1608972241012-8c0fe8e2-b1c8-4696-a9c4-454e11753e0f.svg" alt="02_Goè¿›é˜¶03_blog_sync.drawio.svg"><br><code>state</code>  å­—æ®µçš„æœ€ä½ä¸‰ä½è¡¨ç¤ºä¸‰ç§çŠ¶æ€ï¼Œåˆ†åˆ«æ˜¯ <code>mutexLocked</code>  <code>mutexWoken</code> <code>mutexStarving</code> ï¼Œå‰©ä¸‹çš„ç”¨äºç»Ÿè®¡å½“å‰åœ¨ç­‰å¾…é”çš„ goroutine æ•°é‡</p><ul><li><code>mutexLocked</code>  è¡¨ç¤ºæ˜¯å¦å¤„äºé”å®šçŠ¶æ€</li><li><code>mutexWoken</code> è¡¨ç¤ºæ˜¯å¦å¤„äºå”¤é†’çŠ¶æ€</li><li><code>mutexStarving</code> è¡¨ç¤ºæ˜¯å¦å¤„äºé¥¥é¥¿çŠ¶æ€</li></ul><h3 id="åŠ é”-1"><a href="#åŠ é”-1" class="headerlink" title="åŠ é”"></a>åŠ é”</h3><p>å›å‘³ä¸€ä¸‹ä¸Šé¢çœ‹åˆ°çš„æµç¨‹å›¾ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹äº’æ–¥é”æ˜¯å¦‚ä½•åŠ é”çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mutex)</span> <span class="hljs-title">Lock</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// Fast path: grab unlocked mutex.</span><br><span class="hljs-keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, <span class="hljs-number">0</span>, mutexLocked) &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-comment">// Slow path (outlined so that the fast path can be inlined)</span><br>m.lockSlow()<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>å½“æˆ‘ä»¬è°ƒç”¨ <code>Lock</code>  æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šå…ˆå°è¯•èµ° Fast Pathï¼Œä¹Ÿå°±æ˜¯å¦‚æœå½“å‰äº’æ–¥é”å¦‚æœå¤„äºæœªåŠ é”çš„çŠ¶æ€ï¼Œå°è¯•åŠ é”ï¼Œåªè¦åŠ é”æˆåŠŸå°±ç›´æ¥è¿”å›</li><li>å¦åˆ™çš„è¯å°±è¿›å…¥ slow path</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mutex)</span> <span class="hljs-title">lockSlow</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> waitStartTime <span class="hljs-keyword">int64</span> <span class="hljs-comment">// ç­‰å¾…æ—¶é—´</span><br>starving := <span class="hljs-literal">false</span> <span class="hljs-comment">// æ˜¯å¦å¤„äºé¥¥é¥¿çŠ¶æ€</span><br>awoke := <span class="hljs-literal">false</span> <span class="hljs-comment">// æ˜¯å¦å¤„äºå”¤é†’çŠ¶æ€</span><br>iter := <span class="hljs-number">0</span> <span class="hljs-comment">// è‡ªæ—‹è¿­ä»£æ¬¡æ•°</span><br>old := m.state<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-comment">// Don&#x27;t spin in starvation mode, ownership is handed off to waiters</span><br><span class="hljs-comment">// so we won&#x27;t be able to acquire the mutex anyway.</span><br><span class="hljs-keyword">if</span> old&amp;(mutexLocked|mutexStarving) == mutexLocked &amp;&amp; runtime_canSpin(iter) &#123;<br><span class="hljs-comment">// Active spinning makes sense.</span><br><span class="hljs-comment">// Try to set mutexWoken flag to inform Unlock</span><br><span class="hljs-comment">// to not wake other blocked goroutines.</span><br><span class="hljs-keyword">if</span> !awoke &amp;&amp; old&amp;mutexWoken == <span class="hljs-number">0</span> &amp;&amp; old&gt;&gt;mutexWaiterShift != <span class="hljs-number">0</span> &amp;&amp;<br>atomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken) &#123;<br>awoke = <span class="hljs-literal">true</span><br>&#125;<br>runtime_doSpin()<br>iter++<br>old = m.state<br><span class="hljs-keyword">continue</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>lockSlow</code>  æ–¹æ³•ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸€ä¸ªå¤§çš„ for å¾ªç¯ï¼Œä¸æ–­çš„å°è¯•å»è·å–äº’æ–¥é”ï¼Œåœ¨å¾ªç¯çš„å†…éƒ¨ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯åˆ¤æ–­èƒ½å¦è‡ªæ—‹çŠ¶æ€ã€‚<br>è¿›å…¥è‡ªæ—‹çŠ¶æ€çš„åˆ¤æ–­æ¯”è¾ƒè‹›åˆ»ï¼Œå…·ä½“éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶å‘¢ï¼Ÿ <code>runtime_canSpin</code>  æºç è§ä¸‹æ–¹</p><ul><li>å½“å‰äº’æ–¥é”çš„çŠ¶æ€æ˜¯éé¥¥é¥¿çŠ¶æ€ï¼Œå¹¶ä¸”å·²ç»è¢«é”å®šäº†</li><li>è‡ªæ—‹æ¬¡æ•°ä¸è¶…è¿‡ 4 æ¬¡</li><li>cpu ä¸ªæ•°å¤§äºä¸€ï¼Œå¿…é¡»è¦æ˜¯å¤šæ ¸ cpu</li><li>å½“å‰æ­£åœ¨æ‰§è¡Œå½“ä¸­ï¼Œå¹¶ä¸”é˜Ÿåˆ—ç©ºé—²çš„ p çš„ä¸ªæ•°å¤§äºç­‰äºä¸€</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Active spinning for sync.Mutex.</span><br><span class="hljs-comment">//go:linkname sync_runtime_canSpin sync.runtime_canSpin</span><br><span class="hljs-comment">//go:nosplit</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sync_runtime_canSpin</span><span class="hljs-params">(i <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span> &#123;<br><span class="hljs-keyword">if</span> i &gt;= active_spin || ncpu &lt;= <span class="hljs-number">1</span> || gomaxprocs &lt;= <span class="hljs-keyword">int32</span>(sched.npidle+sched.nmspinning)+<span class="hljs-number">1</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">if</span> p := getg().m.p.ptr(); !runqempty(p) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœå¯ä»¥è¿›å…¥è‡ªæ—‹çŠ¶æ€ä¹‹åå°±ä¼šè°ƒç”¨ <code>runtime_doSpin</code>  æ–¹æ³•è¿›å…¥è‡ªæ—‹ï¼Œ <code>doSpin</code>  æ–¹æ³•ä¼šè°ƒç”¨ <code>procyield(30)</code>  æ‰§è¡Œä¸‰åæ¬¡ <code>PAUSE</code>  æŒ‡ä»¤</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">TEXT runtimeÂ·procyield(SB),NOSPLIT,$<span class="hljs-number">0</span><span class="hljs-number">-0</span><br>MOVLcycles+<span class="hljs-number">0</span>(FP), AX<br>again:<br>PAUSE<br>SUBL$<span class="hljs-number">1</span>, AX<br>JNZagain<br>RET<br></code></pre></td></tr></table></figure><p><div style="background: #FFFBE6;padding:10px;border: 1px solid #C3C3C3;border-radius:5px;margin-bottom:5px;">ä¸ºä»€ä¹ˆä½¿ç”¨ PAUSE æŒ‡ä»¤å‘¢ï¼Ÿ<br>PAUSE æŒ‡ä»¤ä¼šå‘Šè¯‰ CPU æˆ‘å½“å‰å¤„äºå¤„äºè‡ªæ—‹çŠ¶æ€ï¼Œè¿™æ—¶å€™ CPU ä¼šé’ˆå¯¹æ€§çš„åšä¸€äº›ä¼˜åŒ–ï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œè¿™ä¸ªæŒ‡ä»¤çš„æ—¶å€™ CPU ä¼šé™ä½è‡ªå·±çš„åŠŸè€—ï¼Œå‡å°‘èƒ½æºæ¶ˆè€—</div><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> !awoke &amp;&amp; old&amp;mutexWoken == <span class="hljs-number">0</span> &amp;&amp; old&gt;&gt;mutexWaiterShift != <span class="hljs-number">0</span> &amp;&amp;<br>atomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken) &#123;<br>awoke = <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><br>åœ¨è‡ªæ—‹çš„è¿‡ç¨‹ä¸­ä¼šå°è¯•è®¾ç½® <code>mutexWoken</code> æ¥é€šçŸ¥è§£é”ï¼Œä»è€Œé¿å…å”¤é†’å…¶ä»–å·²ç»ä¼‘çœ çš„ <code>goroutine</code> åœ¨è‡ªæ—‹æ¨¡å¼ä¸‹ï¼Œå½“å‰çš„ <code>goroutine</code> å°±èƒ½æ›´å¿«çš„è·å–åˆ°é”<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-built_in">new</span> := old<br><span class="hljs-comment">// Don&#x27;t try to acquire starving mutex, new arriving goroutines must queue.</span><br><span class="hljs-keyword">if</span> old&amp;mutexStarving == <span class="hljs-number">0</span> &#123;<br><span class="hljs-built_in">new</span> |= mutexLocked<br>&#125;<br><span class="hljs-keyword">if</span> old&amp;(mutexLocked|mutexStarving) != <span class="hljs-number">0</span> &#123;<br><span class="hljs-built_in">new</span> += <span class="hljs-number">1</span> &lt;&lt; mutexWaiterShift<br>&#125;<br><span class="hljs-comment">// The current goroutine switches mutex to starvation mode.</span><br><span class="hljs-comment">// But if the mutex is currently unlocked, don&#x27;t do the switch.</span><br><span class="hljs-comment">// Unlock expects that starving mutex has waiters, which will not</span><br><span class="hljs-comment">// be true in this case.</span><br><span class="hljs-keyword">if</span> starving &amp;&amp; old&amp;mutexLocked != <span class="hljs-number">0</span> &#123;<br><span class="hljs-built_in">new</span> |= mutexStarving<br>&#125;<br><span class="hljs-keyword">if</span> awoke &#123;<br><span class="hljs-comment">// The goroutine has been woken from sleep,</span><br><span class="hljs-comment">// so we need to reset the flag in either case.</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">new</span>&amp;mutexWoken == <span class="hljs-number">0</span> &#123;<br>throw(<span class="hljs-string">&quot;sync: inconsistent mutex state&quot;</span>)<br>&#125;<br><span class="hljs-built_in">new</span> &amp;^= mutexWoken<br>&#125;<br></code></pre></td></tr></table></figure><br>è‡ªæ—‹ç»“æŸä¹‹åå°±ä¼šå»è®¡ç®—å½“å‰äº’æ–¥é”çš„çŠ¶æ€ï¼Œå¦‚æœå½“å‰å¤„åœ¨é¥¥é¥¿æ¨¡å¼ä¸‹åˆ™ä¸ä¼šå»è¯·æ±‚é”ï¼Œè€Œæ˜¯ä¼šå°†å½“å‰ goroutine æ”¾åˆ°é˜Ÿåˆ—çš„æœ«ç«¯<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="hljs-built_in">new</span>) &#123;<br>    <span class="hljs-keyword">if</span> old&amp;(mutexLocked|mutexStarving) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">break</span> <span class="hljs-comment">// locked the mutex with CAS</span><br>    &#125;<br>    <span class="hljs-comment">// If we were already waiting before, queue at the front of the queue.</span><br>    queueLifo := waitStartTime != <span class="hljs-number">0</span><br>    <span class="hljs-keyword">if</span> waitStartTime == <span class="hljs-number">0</span> &#123;<br>        waitStartTime = runtime_nanotime()<br>    &#125;<br>    runtime_SemacquireMutex(&amp;m.sema, queueLifo, <span class="hljs-number">1</span>)<br>    starving = starving || runtime_nanotime()-waitStartTime &gt; starvationThresholdNs<br>    old = m.state<br>    <span class="hljs-keyword">if</span> old&amp;mutexStarving != <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-comment">// If this goroutine was woken and mutex is in starvation mode,</span><br>        <span class="hljs-comment">// ownership was handed off to us but mutex is in somewhat</span><br>        <span class="hljs-comment">// inconsistent state: mutexLocked is not set and we are still</span><br>        <span class="hljs-comment">// accounted as waiter. Fix that.</span><br>        <span class="hljs-keyword">if</span> old&amp;(mutexLocked|mutexWoken) != <span class="hljs-number">0</span> || old&gt;&gt;mutexWaiterShift == <span class="hljs-number">0</span> &#123;<br>            throw(<span class="hljs-string">&quot;sync: inconsistent mutex state&quot;</span>)<br>        &#125;<br>        delta := <span class="hljs-keyword">int32</span>(mutexLocked - <span class="hljs-number">1</span>&lt;&lt;mutexWaiterShift)<br>        <span class="hljs-keyword">if</span> !starving || old&gt;&gt;mutexWaiterShift == <span class="hljs-number">1</span> &#123;<br>            <span class="hljs-comment">// Exit starvation mode.</span><br>            <span class="hljs-comment">// Critical to do it here and consider wait time.</span><br>            <span class="hljs-comment">// Starvation mode is so inefficient, that two goroutines</span><br>            <span class="hljs-comment">// can go lock-step infinitely once they switch mutex</span><br>            <span class="hljs-comment">// to starvation mode.</span><br>            delta -= mutexStarving<br>        &#125;<br>        atomic.AddInt32(&amp;m.state, delta)<br>        <span class="hljs-keyword">break</span><br>    &#125;<br>    awoke = <span class="hljs-literal">true</span><br>    iter = <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><br>çŠ¶æ€è®¡ç®—å®Œæˆä¹‹åå°±ä¼šå°è¯•ä½¿ç”¨ CAS æ“ä½œè·å–é”ï¼Œå¦‚æœè·å–æˆåŠŸå°±ä¼šç›´æ¥é€€å‡ºå¾ªç¯<br>å¦‚æœè·å–å¤±è´¥ï¼Œåˆ™ä¼šè°ƒç”¨ <code>runtime_SemacquireMutex(&amp;m.sema, queueLifo, 1)</code> æ–¹æ³•ä¿è¯é”ä¸ä¼šåŒæ—¶è¢«ä¸¤ä¸ª goroutine è·å–ã€‚<code>runtime_SemacquireMutex</code> æ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯:</p><ul><li>ä¸æ–­è°ƒç”¨å°è¯•è·å–é”</li><li>ä¼‘çœ å½“å‰ goroutine</li><li>ç­‰å¾…ä¿¡å·é‡ï¼Œå”¤é†’ goroutine</li></ul><p>goroutine è¢«å”¤é†’ä¹‹åå°±ä¼šå»åˆ¤æ–­å½“å‰æ˜¯å¦å¤„äºé¥¥é¥¿æ¨¡å¼ï¼Œå¦‚æœå½“å‰ç­‰å¾…è¶…è¿‡ <code>1ms</code>  å°±ä¼šè¿›å…¥é¥¥é¥¿æ¨¡å¼</p><ul><li>é¥¥é¥¿æ¨¡å¼ä¸‹ï¼šä¼šè·å¾—äº’æ–¥é”ï¼Œå¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸­åªå­˜åœ¨å½“å‰ Goroutineï¼Œäº’æ–¥é”è¿˜ä¼šä»é¥¥é¥¿æ¨¡å¼ä¸­é€€å‡º</li><li>æ­£å¸¸æ¨¡å¼ä¸‹ï¼šä¼šè®¾ç½®å”¤é†’å’Œé¥¥é¥¿æ ‡è®°ã€é‡ç½®è¿­ä»£æ¬¡æ•°å¹¶é‡æ–°æ‰§è¡Œè·å–é”çš„å¾ªç¯</li></ul><h3 id="è§£é”-1"><a href="#è§£é”-1" class="headerlink" title="è§£é”"></a>è§£é”</h3><p>å’ŒåŠ é”æ¯”è§£é”å°±å¾ˆç®€å•äº†ï¼Œç›´æ¥çœ‹æ³¨é‡Šå°±å¥½</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// è§£é”ä¸€ä¸ªæ²¡æœ‰é”å®šçš„äº’æ–¥é‡ä¼šæŠ¥è¿è¡Œæ—¶é”™è¯¯</span><br><span class="hljs-comment">// è§£é”æ²¡æœ‰ç»‘å®šå…³ç³»ï¼Œå¯ä»¥ä¸€ä¸ª goroutine é”å®šï¼Œå¦å¤–ä¸€ä¸ª goroutine è§£é”</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mutex)</span> <span class="hljs-title">Unlock</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// Fast path: ç›´æ¥å°è¯•è®¾ç½® state çš„å€¼ï¼Œè¿›è¡Œè§£é”</span><br><span class="hljs-built_in">new</span> := atomic.AddInt32(&amp;m.state, -mutexLocked)<br>    <span class="hljs-comment">// å¦‚æœå‡å»äº† mutexLocked çš„å€¼ä¹‹åä¸ä¸ºé›¶å°±ä¼šè¿›å…¥æ…¢é€Ÿé€šé“ï¼Œè¿™è¯´æ˜æœ‰å¯èƒ½å¤±è´¥äº†ï¼Œæˆ–è€…æ˜¯è¿˜æœ‰å…¶ä»–çš„ goroutine ç­‰ç€</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">new</span> != <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Outlined slow path to allow inlining the fast path.</span><br><span class="hljs-comment">// To hide unlockSlow during tracing we skip one extra frame when tracing GoUnblock.</span><br>m.unlockSlow(<span class="hljs-built_in">new</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mutex)</span> <span class="hljs-title">unlockSlow</span><span class="hljs-params">(<span class="hljs-built_in">new</span> <span class="hljs-keyword">int32</span>)</span></span> &#123;<br>    <span class="hljs-comment">// è§£é”ä¸€ä¸ªæ²¡æœ‰é”å®šçš„äº’æ–¥é‡ä¼šæŠ¥è¿è¡Œæ—¶é”™è¯¯</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">new</span>+mutexLocked)&amp;mutexLocked == <span class="hljs-number">0</span> &#123;<br>throw(<span class="hljs-string">&quot;sync: unlock of unlocked mutex&quot;</span>)<br>&#125;<br>    <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦å¤„äºé¥¥é¥¿æ¨¡å¼</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">new</span>&amp;mutexStarving == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-comment">// æ­£å¸¸æ¨¡å¼</span><br>old := <span class="hljs-built_in">new</span><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-comment">// å¦‚æœå½“å‰æ²¡æœ‰ç­‰å¾…è€….æˆ–è€… goroutine å·²ç»è¢«å”¤é†’æˆ–è€…æ˜¯å¤„äºé”å®šçŠ¶æ€äº†ï¼Œå°±ç›´æ¥è¿”å›</span><br><span class="hljs-keyword">if</span> old&gt;&gt;mutexWaiterShift == <span class="hljs-number">0</span> || old&amp;(mutexLocked|mutexWoken|mutexStarving) != <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-comment">// å”¤é†’ç­‰å¾…è€…å¹¶ä¸”ç§»äº¤é”çš„æ§åˆ¶æƒ</span><br><span class="hljs-built_in">new</span> = (old - <span class="hljs-number">1</span>&lt;&lt;mutexWaiterShift) | mutexWoken<br><span class="hljs-keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="hljs-built_in">new</span>) &#123;<br>runtime_Semrelease(&amp;m.sema, <span class="hljs-literal">false</span>, <span class="hljs-number">1</span>)<br><span class="hljs-keyword">return</span><br>&#125;<br>old = m.state<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// é¥¥é¥¿æ¨¡å¼ï¼Œèµ° handoff æµç¨‹ï¼Œç›´æ¥å°†é”äº¤ç»™ä¸‹ä¸€ä¸ªç­‰å¾…çš„ goroutineï¼Œæ³¨æ„è¿™ä¸ªæ—¶å€™ä¸ä¼šä»é¥¥é¥¿æ¨¡å¼ä¸­é€€å‡º</span><br>runtime_Semrelease(&amp;m.sema, <span class="hljs-literal">true</span>, <span class="hljs-number">1</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="RWMutex"><a href="#RWMutex" class="headerlink" title="RWMutex"></a>RWMutex</h1><p>è¯»å†™é”ç›¸å¯¹äºäº’æ–¥é”æ¥è¯´ç²’åº¦æ›´ç»†ï¼Œä½¿ç”¨è¯»å†™é”å¯ä»¥å¹¶å‘è¯»ï¼Œä½†æ˜¯ä¸èƒ½å¹¶å‘è¯»å†™ï¼Œæˆ–è€…å¹¶å‘å†™å†™</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center"><strong>è¯»</strong></th><th style="text-align:center"><strong>å†™</strong></th></tr></thead><tbody><tr><td style="text-align:center">è¯»</td><td style="text-align:center">Y</td><td style="text-align:center">N</td></tr><tr><td style="text-align:center">å†™</td><td style="text-align:center">N</td><td style="text-align:center">N</td></tr></tbody></table><h2 id="æ¡ˆä¾‹-1"><a href="#æ¡ˆä¾‹-1" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h2><p>å…¶å®å¤§éƒ¨åˆ†çš„ä¸šåŠ¡åº”ç”¨éƒ½æ˜¯è¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œè¿™ä¸ªæ—¶å€™ä½¿ç”¨è¯»å†™é”çš„æ€§èƒ½å°±ä¼šæ¯”äº’æ–¥é”è¦å¥½ä¸€äº›ï¼Œä¾‹å¦‚ä¸‹é¢çš„è¿™ä¸ªä¾‹å­ï¼Œæ˜¯ä¸€ä¸ªé…ç½®è¯»å†™çš„ä¾‹å­ï¼Œæˆ‘ä»¬åˆ†åˆ«ä½¿ç”¨è¯»å†™é”å’Œäº’æ–¥é”å®ç°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// RWMutexConfig è¯»å†™é”å®ç°</span><br><span class="hljs-keyword">type</span> RWMutexConfig <span class="hljs-keyword">struct</span> &#123;<br>rw   sync.RWMutex<br>data []<span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-comment">// Get get config data</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *RWMutexConfig)</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> []<span class="hljs-title">int</span></span> &#123;<br>c.rw.RLock()<br><span class="hljs-keyword">defer</span> c.rw.RUnlock()<br><span class="hljs-keyword">return</span> c.data<br>&#125;<br><br><span class="hljs-comment">// Set set config data</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *RWMutexConfig)</span> <span class="hljs-title">Set</span><span class="hljs-params">(n []<span class="hljs-keyword">int</span>)</span></span> &#123;<br>c.rw.Lock()<br><span class="hljs-keyword">defer</span> c.rw.Unlock()<br>c.data = n<br>&#125;<br></code></pre></td></tr></table></figure><p>äº’æ–¥é”å®ç°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-comment">// MutexConfig äº’æ–¥é”å®ç°</span><br><span class="hljs-keyword">type</span> MutexConfig <span class="hljs-keyword">struct</span> &#123;<br>data []<span class="hljs-keyword">int</span><br>mu   sync.Mutex<br>&#125;<br><br><span class="hljs-comment">// Get get config data</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *MutexConfig)</span> <span class="hljs-title">Get</span><span class="hljs-params">()</span> []<span class="hljs-title">int</span></span> &#123;<br>c.mu.Lock()<br><span class="hljs-keyword">defer</span> c.mu.Unlock()<br><span class="hljs-keyword">return</span> c.data<br>&#125;<br><br><span class="hljs-comment">// Set set config data</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *MutexConfig)</span> <span class="hljs-title">Set</span><span class="hljs-params">(n []<span class="hljs-keyword">int</span>)</span></span> &#123;<br>c.mu.Lock()<br><span class="hljs-keyword">defer</span> c.mu.Unlock()<br>c.data = n<br>&#125;<br></code></pre></td></tr></table></figure><p>å¹¶å‘åŸºå‡†æµ‹è¯•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> iConfig <span class="hljs-keyword">interface</span> &#123;<br>Get() []<span class="hljs-keyword">int</span><br>Set([]<span class="hljs-keyword">int</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">bench</span><span class="hljs-params">(b *testing.B, c iConfig)</span></span> &#123;<br>b.RunParallel(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p *testing.PB)</span></span> &#123;<br><span class="hljs-keyword">for</span> p.Next() &#123;<br>c.Set([]<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">100</span>&#125;)<br>c.Get()<br>c.Get()<br>c.Get()<br>c.Set([]<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">100</span>&#125;)<br>c.Get()<br>c.Get()<br>&#125;<br>&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkMutexConfig</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br>conf := &amp;MutexConfig&#123;data: []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;&#125;<br>bench(b, conf)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkRWMutexConfig</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br>conf := &amp;RWMutexConfig&#123;data: []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;&#125;<br>bench(b, conf)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">â¯ <span class="hljs-keyword">go</span> test -race -bench=.<br>goos: linux<br>goarch: amd64<br>pkg: github.com/mohuishou/<span class="hljs-keyword">go</span>-training/Week03/blog/<span class="hljs-number">04</span>_sync/<span class="hljs-number">02</span>_rwmutex<br>BenchmarkMutexConfig<span class="hljs-number">-4</span>            <span class="hljs-number">179577</span>              <span class="hljs-number">6912</span> ns/op<br>BenchmarkRWMutexConfig<span class="hljs-number">-4</span>          <span class="hljs-number">341620</span>              <span class="hljs-number">3425</span> ns/op<br>PASS<br>ok      github.com/mohuishou/<span class="hljs-keyword">go</span>-training/Week03/blog/<span class="hljs-number">04</span>_sync/<span class="hljs-number">02</span>_rwmutex <span class="hljs-number">3.565</span>s<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é¦–å…ˆæ˜¯æ²¡æœ‰ data race é—®é¢˜ï¼Œå…¶æ¬¡è¯»å†™é”çš„æ€§èƒ½å‡ ä¹æ˜¯äº’æ–¥é”çš„ä¸€å€</p><h2 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h2><h3 id="åŸºæœ¬ç»“æ„"><a href="#åŸºæœ¬ç»“æ„" class="headerlink" title="åŸºæœ¬ç»“æ„"></a>åŸºæœ¬ç»“æ„</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> RWMutex <span class="hljs-keyword">struct</span> &#123;<br>w           Mutex  <span class="hljs-comment">// å¤ç”¨äº’æ–¥é”</span><br>writerSem   <span class="hljs-keyword">uint32</span> <span class="hljs-comment">// ä¿¡å·é‡ï¼Œç”¨äºå†™ç­‰å¾…è¯»</span><br>readerSem   <span class="hljs-keyword">uint32</span> <span class="hljs-comment">// ä¿¡å·é‡ï¼Œç”¨äºè¯»ç­‰å¾…å†™</span><br>readerCount <span class="hljs-keyword">int32</span>  <span class="hljs-comment">// å½“å‰æ‰§è¡Œè¯»çš„ goroutine æ•°é‡</span><br>readerWait  <span class="hljs-keyword">int32</span>  <span class="hljs-comment">// å†™æ“ä½œè¢«é˜»å¡çš„å‡†å¤‡è¯»çš„ goroutine çš„æ•°é‡</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±äºå¤ç”¨äº†äº’æ–¥é”çš„ä»£ç ï¼Œè¯»å†™é”çš„æºç å¾ˆç®€å•ï¼Œè¿™é‡Œæˆ‘å°±ä¸å•ç‹¬ç”»å›¾äº†</p><h3 id="è¯»é”"><a href="#è¯»é”" class="headerlink" title="è¯»é”"></a>è¯»é”</h3><h4 id="åŠ é”-2"><a href="#åŠ é”-2" class="headerlink" title="åŠ é”"></a>åŠ é”</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rw *RWMutex)</span> <span class="hljs-title">RLock</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> atomic.AddInt32(&amp;rw.readerCount, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// A writer is pending, wait for it.</span><br>runtime_SemacquireMutex(&amp;rw.readerSem, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯è¯»é”ï¼Œ <code>atomic.AddInt32(&amp;rw.readerCount, 1)</code>  è°ƒç”¨è¿™ä¸ªåŸå­æ–¹æ³•ï¼Œå¯¹å½“å‰åœ¨è¯»çš„æ•°é‡åŠ ä¸€ï¼Œå¦‚æœè¿”å›è´Ÿæ•°ï¼Œé‚£ä¹ˆè¯´æ˜å½“å‰æœ‰å…¶ä»–å†™é”ï¼Œè¿™æ—¶å€™å°±è°ƒç”¨ <code>runtime_SemacquireMutex</code>  ä¼‘çœ  goroutine ç­‰å¾…è¢«å”¤é†’</p><h4 id="è§£é”-2"><a href="#è§£é”-2" class="headerlink" title="è§£é”"></a>è§£é”</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rw *RWMutex)</span> <span class="hljs-title">RUnlock</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> r := atomic.AddInt32(&amp;rw.readerCount, <span class="hljs-number">-1</span>); r &lt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Outlined slow-path to allow the fast-path to be inlined</span><br>rw.rUnlockSlow(r)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è§£é”çš„æ—¶å€™å¯¹æ­£åœ¨è¯»çš„æ“ä½œå‡ä¸€ï¼Œå¦‚æœè¿”å›å€¼å°äº 0 é‚£ä¹ˆè¯´æ˜å½“å‰æœ‰åœ¨å†™çš„æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™è°ƒç”¨ <code>rUnlockSlow</code>  è¿›å…¥æ…¢é€Ÿé€šé“</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rw *RWMutex)</span> <span class="hljs-title">rUnlockSlow</span><span class="hljs-params">(r <span class="hljs-keyword">int32</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> r+<span class="hljs-number">1</span> == <span class="hljs-number">0</span> || r+<span class="hljs-number">1</span> == -rwmutexMaxReaders &#123;<br>race.Enable()<br>throw(<span class="hljs-string">&quot;sync: RUnlock of unlocked RWMutex&quot;</span>)<br>&#125;<br><span class="hljs-comment">// A writer is pending.</span><br><span class="hljs-keyword">if</span> atomic.AddInt32(&amp;rw.readerWait, <span class="hljs-number">-1</span>) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// The last reader unblocks the writer.</span><br>runtime_Semrelease(&amp;rw.writerSem, <span class="hljs-literal">false</span>, <span class="hljs-number">1</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¢«é˜»å¡çš„å‡†å¤‡è¯»çš„ goroutine çš„æ•°é‡å‡ä¸€ï¼ŒreaderWait ä¸º 0ï¼Œå°±è¡¨ç¤ºå½“å‰æ²¡æœ‰æ­£åœ¨å‡†å¤‡è¯»çš„ goroutine è¿™æ—¶å€™è°ƒç”¨ <code>runtime_Semrelease</code>  å”¤é†’å†™æ“ä½œ</p><h3 id="å†™é”"><a href="#å†™é”" class="headerlink" title="å†™é”"></a>å†™é”</h3><h4 id="åŠ é”-3"><a href="#åŠ é”-3" class="headerlink" title="åŠ é”"></a>åŠ é”</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rw *RWMutex)</span> <span class="hljs-title">Lock</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// First, resolve competition with other writers.</span><br>rw.w.Lock()<br><span class="hljs-comment">// Announce to readers there is a pending writer.</span><br>r := atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders<br><span class="hljs-comment">// Wait for active readers.</span><br><span class="hljs-keyword">if</span> r != <span class="hljs-number">0</span> &amp;&amp; atomic.AddInt32(&amp;rw.readerWait, r) != <span class="hljs-number">0</span> &#123;<br>runtime_SemacquireMutex(&amp;rw.writerSem, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨äº’æ–¥é”çš„ lockï¼Œè·å–åˆ°äº’æ–¥é”ä¹‹åï¼Œ</p><ul><li><code>atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders)</code>  è°ƒç”¨è¿™ä¸ªå‡½æ•°é˜»å¡åç»­çš„è¯»æ“ä½œ</li><li>å¦‚æœè®¡ç®—ä¹‹åå½“å‰ä»ç„¶æœ‰å…¶ä»– goroutine æŒæœ‰è¯»é”ï¼Œé‚£ä¹ˆå°±è°ƒç”¨ <code>runtime_SemacquireMutex</code>  ä¼‘çœ å½“å‰çš„ goroutine ç­‰å¾…æ‰€æœ‰çš„è¯»æ“ä½œå®Œæˆ</li></ul><h4 id="è§£é”-3"><a href="#è§£é”-3" class="headerlink" title="è§£é”"></a>è§£é”</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rw *RWMutex)</span> <span class="hljs-title">Unlock</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// Announce to readers there is no active writer.</span><br>r := atomic.AddInt32(&amp;rw.readerCount, rwmutexMaxReaders)<br><span class="hljs-keyword">if</span> r &gt;= rwmutexMaxReaders &#123;<br>race.Enable()<br>throw(<span class="hljs-string">&quot;sync: Unlock of unlocked RWMutex&quot;</span>)<br>&#125;<br><span class="hljs-comment">// Unblock blocked readers, if any.</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">int</span>(r); i++ &#123;<br>runtime_Semrelease(&amp;rw.readerSem, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è§£é”çš„æ“ä½œï¼Œä¼šå…ˆè°ƒç”¨ <code>atomic.AddInt32(&amp;rw.readerCount, rwmutexMaxReaders)</code>  å°†æ¢å¤ä¹‹å‰å†™å…¥çš„è´Ÿæ•°ï¼Œç„¶åæ ¹æ®å½“å‰æœ‰å¤šå°‘ä¸ªè¯»æ“ä½œåœ¨ç­‰å¾…ï¼Œå¾ªç¯å”¤é†’</p><h1 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h1><ol><li><a href="https://pkg.go.dev/sync">https://pkg.go.dev/sync</a> å®˜ç½‘æ–‡æ¡£ï¼Œå¿…è¯»</li><li><a href="https://pkg.go.dev/golang.org/x/sync@v0.0.0-20201207232520-09787c993a3a/errgroup">https://pkg.go.dev/golang.org/x/sync@v0.0.0-20201207232520-09787c993a3a/errgroup</a> å®˜ç½‘æ–‡æ¡£ï¼Œå¿…è¯»</li><li><a href="https://pkg.go.dev/sync/atomic">https://pkg.go.dev/sync/atomic</a> å®˜ç½‘æ–‡æ¡£ï¼Œå¿…è¯»</li><li><a href="https://medium.com/a-journey-with-go/go-how-to-reduce-lock-contention-with-the-atomic-package-ba3b2664b549">Go: How to Reduce Lock Contention with the Atomic Package</a></li><li><a href="https://medium.com/a-journey-with-go/go-mutex-and-starvation-3f4f4e75ad50">Go: Mutex and Starvation</a></li><li><a href="https://mojotv.cn/go/golang-muteex-starvation">Go è¿›é˜¶ 27:Go è¯­è¨€ Mutex Starvation(è¯‘)</a></li><li><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-sync-primitives/">Go è¯­è¨€è®¾è®¡ä¸å®ç°-6.2 åŒæ­¥åŸè¯­ä¸é”</a> è¿™æœ¬ä¹¦å€¼å¾—ä¸€çœ‹</li><li><a href="https://www.felixcloutier.com/x86/pause">PAUSE â€” Spin Loop Hint</a></li><li><a href="https://github.com/freelancer-leon/notes/blob/master/kernel/lock/Lock-2-Linux_x86_Spin_Lock.md#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E6%98%AF-pause-%E6%8C%87%E4%BB%A4">Linux x86 è‡ªæ—‹é”çš„å®ç°</a></li><li><a href="https://github.com/golang/go/commit/0556e26273f704db73df9e7c4c3d2e8434dec7be">https://github.com/golang/go/commit/0556e26273f704db73df9e7c4c3d2e8434dec7be</a></li></ol><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week03: Go å¹¶å‘ç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¹¶å‘</tag>
      
      <tag>mutex</tag>
      
      <tag>äº’æ–¥é”</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¹¶å‘ç¼–ç¨‹(ä¸‰) data race</title>
    <link href="/post/go-training-week3-data-race.html"/>
    <url>/post/go-training-week3-data-race.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h2><p>åœ¨å‰ä¸¤ç¯‡æ–‡ç« å½“ä¸­æˆ‘ä»¬åå¤æåˆ°äº†è™½ç„¶åœ¨ go ä¸­ï¼Œå¹¶å‘ç¼–ç¨‹ååˆ†ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ <code>go func()</code>  å°±èƒ½å¯åŠ¨ä¸€ä¸ª goroutine å»åšä¸€äº›äº‹æƒ…ï¼Œä½†æ˜¯æ­£æ˜¯ç”±äºè¿™ç§ç®€å•æˆ‘ä»¬è¦ååˆ†å½“å¿ƒï¼Œä¸ç„¶å¾ˆå®¹æ˜“å‡ºç°ä¸€äº›è«åå…¶å¦™çš„ bug æˆ–è€…æ˜¯ä½ çš„æœåŠ¡ç”±äºä¸çŸ¥åçš„åŸå› å°±é‡å¯äº†ã€‚</p><h2 id="æ•°æ®ç«äº‰-data-race"><a href="#æ•°æ®ç«äº‰-data-race" class="headerlink" title="æ•°æ®ç«äº‰(data race)"></a>æ•°æ®ç«äº‰(data race)</h2><p>ä¹‹å‰æˆ‘ä»¬æåˆ°äº†å¾ˆå¤šæ¬¡åœ¨å¤šä¸ª goroutine å¯¹åŒä¸€ä¸ªå˜é‡çš„æ•°æ®è¿›è¡Œä¿®æ”¹çš„æ—¶å€™ä¼šå‡ºç°å¾ˆå¤šå¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ï¼Œé‚£æˆ‘ä»¬æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•æ£€æµ‹å®ƒå‘¢ï¼Œé™¤äº†é€šè¿‡æˆ‘ä»¬èªæ˜çš„è„‘è¢‹ï¼Ÿ</p><p>ç­”æ¡ˆå°±æ˜¯ data race tagï¼Œgo å®˜æ–¹æ—©åœ¨ 1.1 ç‰ˆæœ¬å°±å¼•å…¥äº†æ•°æ®ç«äº‰çš„æ£€æµ‹å·¥å…·ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æ‰§è¡Œæµ‹è¯•æˆ–è€…æ˜¯ç¼–è¯‘çš„æ—¶å€™åŠ ä¸Š <code>-race</code>  çš„ flag å°±å¯ä»¥å¼€å¯æ•°æ®ç«äº‰çš„æ£€æµ‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> test -race ./...<br><span class="hljs-keyword">go</span> build -race<br></code></pre></td></tr></table></figure><div style="background: #FFFBE6;padding:10px;border: 1px solid #C3C3C3;border-radius:5px;margin-bottom:5px;">ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒ build çš„æ—¶å€™å¼€å¯æ•°æ®ç«äº‰æ£€æµ‹ï¼Œå› ä¸ºè¿™ä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½æŸå¤±(ä¸€èˆ¬å†…å­˜5-10å€ï¼Œæ‰§è¡Œæ—¶é—´2-20å€)ï¼Œå½“ç„¶   å¿…é¡»è¦ debug çš„æ—¶å€™é™¤å¤–ã€‚<br>å»ºè®®åœ¨æ‰§è¡Œå•å…ƒæµ‹è¯•æ—¶å§‹ç»ˆå¼€å¯æ•°æ®ç«äº‰çš„æ£€æµ‹ã€‚</div><h3 id="æ¡ˆä¾‹ä¸€"><a href="#æ¡ˆä¾‹ä¸€" class="headerlink" title="æ¡ˆä¾‹ä¸€"></a>æ¡ˆä¾‹ä¸€</h3><p>æˆ‘ä»¬æ¥ç›´æ¥çœ‹ä¸€ä¸‹ä¸‹é¢çš„è¿™ä¸ªä¾‹å­ï¼Œè¿™æ˜¯æ¥è‡ªè¯¾ä¸Šçš„ä¸€ä¸ªä¾‹å­ï¼Œä½†æ˜¯æˆ‘ç¨ç¨åšäº†ä¸€äº›æ”¹é€ ï¼Œæºä»£ç æ²¡æœ‰è·‘ 10w æ¬¡è¿™ä¸ªæ“ä½œï¼Œä¼šå¯¼è‡´çœ‹èµ·æ¥æ¯æ¬¡è·‘çš„ç»“æœéƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠè¿™ä¸ªæ¬¡æ•°æ”¾å¤§å°±å¯ä»¥å‘ç°æ¯æ¬¡ç»“æœéƒ½ä¼šä¸ä¸€æ ·</p><h4 id="æ­£å¸¸æ‰§è¡Œ"><a href="#æ­£å¸¸æ‰§è¡Œ" class="headerlink" title="æ­£å¸¸æ‰§è¡Œ"></a>æ­£å¸¸æ‰§è¡Œ</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;sync&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><span class="hljs-keyword">var</span> counter <span class="hljs-keyword">int</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// å¤šè·‘å‡ æ¬¡æ¥çœ‹ç»“æœ</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; i++ &#123;<br>run()<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">2</span>; i++ &#123;<br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> routine(i)<br>&#125;<br>wg.Wait()<br>fmt.Printf(<span class="hljs-string">&quot;Final Counter: %d\n&quot;</span>, counter)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">routine</span><span class="hljs-params">(id <span class="hljs-keyword">int</span>)</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++ &#123;<br>value := counter<br>value++<br>counter = value<br>&#125;<br>wg.Done()<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘æ‰§è¡Œäº†ä¸‰æ¬¡æ¯æ¬¡çš„ç»“æœéƒ½ä¸ä¸€è‡´ï¼Œåˆ†åˆ«æ˜¯:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">Final Counter: <span class="hljs-number">399996</span><br>Final Counter: <span class="hljs-number">399989</span><br>Final Counter: <span class="hljs-number">399988</span><br></code></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆä¼šå¯¼è‡´è¿™æ ·çš„ç»“æœå‘¢ï¼Œæ˜¯å› ä¸ºæ¯ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½ä½¿ç”¨ <code>go routine(i)</code>  å¯åŠ¨äº†ä¸¤ä¸ª goroutineï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰æ§åˆ¶å®ƒçš„æ‰§è¡Œé¡ºåºï¼Œé‚£å°±æœ‰å¥½å‡ ç§å¯èƒ½äº†ï¼Œæˆ‘è¿™é‡Œæè¿°ä¸¤ç§æƒ…å†µ</p><ol><li>æ‰§è¡Œä¸€æ¬¡ <code>run()</code> , <code>counter + 4</code> è¿™ç§æƒ…å†µä¸‹ï¼Œç¬¬äºŒä¸ª goroutine å¼€å§‹æ‰§è¡Œæ—¶ï¼Œæ‹¿åˆ°äº†ç¬¬ä¸€ä¸ª goroutine çš„æ‰§è¡Œç»“æœï¼Œä¹Ÿå°±æ˜¯ <code>value := counter</code>  è¿™ä¸€æ­¥æ—¶ï¼Œvalue = 2</li><li>æ‰§è¡Œä¸€æ¬¡ <code>run()</code> , <code>counter + 2</code> è¿™ç§æƒ…å†µä¸‹ï¼Œç¬¬äºŒä¸ª goroutine å¼€å§‹æ‰§è¡Œæ—¶ï¼Œæ²¡æœ‰æ‹¿åˆ°äº†ç¬¬ä¸€ä¸ª goroutine çš„æ‰§è¡Œç»“æœï¼Œä¹Ÿå°±æ˜¯ <code>value := counter</code> è¿™ä¸€æ­¥æ—¶ï¼Œcounter è¿˜æ˜¯é›¶å€¼ï¼Œè¿™æ—¶å€™ value = 0</li></ol><p>å½“ç„¶ç”±äºç§ç§ä¸ç¡®å®šæ€§ï¼Œæ‰€æœ‰è‚¯å®šä¸æ­¢è¿™ä¸¤ç§æƒ…å†µï¼Œä½†æ˜¯è¿™ä¸ªä¸æ˜¯æœ¬æ–‡è®¨è®ºçš„é‡ç‚¹ï¼Œå…·ä½“çš„åŸå› å¯ä»¥ç»“åˆä¸Šä¸€ç¯‡æ–‡ç«  <a href="https://lailin.xyz/post/go-training-week3-go-memory-model.html">Week03: Go å¹¶å‘ç¼–ç¨‹(äºŒ) Go å†…å­˜æ¨¡å‹</a> è¿›è¡Œæ€è€ƒ</p><h4 id="data-race-æ‰§è¡Œ"><a href="#data-race-æ‰§è¡Œ" class="headerlink" title="data race æ‰§è¡Œ"></a>data race æ‰§è¡Œ</h4><p>å¯ä»¥å‘ç°ï¼Œå†™å‡ºè¿™ç§ä»£ç æ—¶ä¸Šçº¿åå¦‚æœå‡ºç° bug ä¼šéå¸¸éš¾å®šä½ï¼Œå› ä¸ºä½ ä¸çŸ¥é“åˆ°åº•æ˜¯å“ªé‡Œå‡ºç°äº†é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±è¦åœ¨æµ‹è¯•é˜¶æ®µå°±ç»“åˆ data race å·¥å…·æå‰å‘ç°é—®é¢˜ã€‚<br>æˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> run -race ./main.<span class="hljs-keyword">go</span><br></code></pre></td></tr></table></figure><p>ä¼šå‘ç°ç»“æœä¼šæ‰€æœ‰çš„éƒ½è¾“å‡ºï¼Œ <code>data race</code>  çš„æŠ¥é”™ä¿¡æ¯ï¼Œæˆ‘ä»¬å·²ç»çœ‹ä¸åˆ°äº†ï¼Œå› ä¸ºç»ˆç«¯çš„æ‰“å°çš„å¤ªé•¿äº†ï¼Œå¯ä»¥å‘ç°çš„æ˜¯ï¼Œæœ€åæ‰“å°å‡ºå‘ç°äº†ä¸€å¤„ data race å¹¶ä¸”æ¨å‡ºç ä¸º  <code>66</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">Final Counter: <span class="hljs-number">399956</span><br>Final Counter: <span class="hljs-number">399960</span><br>Found <span class="hljs-number">1</span> data race(s)<br>exit status <span class="hljs-number">66</span><br></code></pre></td></tr></table></figure><h4 id="data-race-é…ç½®"><a href="#data-race-é…ç½®" class="headerlink" title="data race é…ç½®"></a>data race é…ç½®</h4><p>é—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥ç«‹å³çŸ¥é“ data race çš„æŠ¥é”™å‘¢ï¼Ÿ<br>ç­”æ¡ˆå°±åœ¨å®˜æ–¹çš„æ–‡æ¡£å½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½® <code>GORACE</code>  ç¯å¢ƒå˜é‡ï¼Œæ¥æ§åˆ¶ data race çš„è¡Œä¸ºï¼Œ æ ¼å¼å¦‚ä¸‹:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">GORACE=<span class="hljs-string">&quot;option1=val1 option2=val2&quot;</span><br></code></pre></td></tr></table></figure><p>å¯é€‰é…ç½®:</p><table><thead><tr><th><strong> é…ç½® </strong></th><th><strong> é»˜è®¤å€¼ </strong></th><th><strong> è¯´æ˜ </strong></th></tr></thead><tbody><tr><td>log_path</td><td>stderr</td><td>æ—¥å¿—æ–‡ä»¶çš„è·¯å¾„ï¼Œé™¤äº†æ–‡ä»¶è·¯å¾„å¤–æ”¯æŒ  stderr, stdout  è¿™ä¸¤ä¸ªç‰¹æ®Šå€¼</td></tr><tr><td>exitcode</td><td>66</td><td>é€€å‡ºç </td></tr><tr><td>strip_path_prefix</td><td>â€œâ€</td><td>ä»æ—¥å¿—ä¸­çš„æ–‡ä»¶ä¿¡æ¯é‡Œé¢å»é™¤ç›¸å…³çš„å‰ç¼€ï¼Œå¯ä»¥å»é™¤æœ¬åœ°ä¿¡æ¯ï¼ŒåŒæ—¶ä¼šæ›´å¥½çœ‹</td></tr><tr><td>history_size</td><td>1</td><td>per-goroutine å†…å­˜è®¿é—®å†å²è®°å½•ä¸º 32K * 2 ** history_sizeï¼Œå¢åŠ è¿™ä¸ªå¯ä»¥é¿å…å‡ºç°å †æ ˆè¿˜åŸå¤±è´¥çš„é”™è¯¯ï¼Œä½†æ˜¯å¢åŠ è¿™ä¸ªä¼šå¯¼è‡´ä½¿ç”¨çš„å†…å­˜ä¹Ÿè·Ÿç€å¢åŠ </td></tr><tr><td>halt_on_error</td><td>0</td><td>ç”¨æ¥æ§åˆ¶ç¬¬ä¸€ä¸ªæ•°æ®ç«äº‰é”™è¯¯å‡ºç°åæ˜¯å¦ç«‹å³é€€å‡º</td></tr><tr><td>atexit_sleep_ms</td><td>100</td><td>ç”¨æ¥æ§åˆ¶  main  é€€å‡ºä¹‹å‰  sleep  çš„æ—¶é—´</td></tr></tbody></table><p>æœ‰äº†è¿™ä¸ªèƒŒæ™¯çŸ¥è¯†åå°±å¾ˆç®€å•äº†ï¼Œåœ¨æˆ‘ä»¬è¿™ä¸ªåœºæ™¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶å‘ç°æ•°æ®ç«äº‰åç›´æ¥é€€å‡º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">GORACE=<span class="hljs-string">&quot;halt_on_error=1 strip_path_prefix=/home/ll/project/Go-000/Week03/blog/03_sync/01_data_race&quot;</span> <span class="hljs-keyword">go</span> run -race ./main.<span class="hljs-keyword">go</span><br></code></pre></td></tr></table></figure><p>é‡æ–°æ‰§è¡Œåæˆ‘ä»¬çš„ç»“æœ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go">==================<br>WARNING: DATA RACE<br>Read at <span class="hljs-number">0x00000064a9c0</span> by goroutine <span class="hljs-number">7</span>:<br>  main.routine()<br>      /main.<span class="hljs-keyword">go</span>:<span class="hljs-number">29</span> +<span class="hljs-number">0x47</span><br><br>Previous write at <span class="hljs-number">0x00000064a9c0</span> by goroutine <span class="hljs-number">8</span>:<br>  main.routine()<br>      /main.<span class="hljs-keyword">go</span>:<span class="hljs-number">31</span> +<span class="hljs-number">0x64</span><br><br>Goroutine <span class="hljs-number">7</span> (running) created at:<br>  main.run()<br>      /main.<span class="hljs-keyword">go</span>:<span class="hljs-number">21</span> +<span class="hljs-number">0x75</span><br>  main.main()<br>      /main.<span class="hljs-keyword">go</span>:<span class="hljs-number">14</span> +<span class="hljs-number">0x38</span><br><br>Goroutine <span class="hljs-number">8</span> (finished) created at:<br>  main.run()<br>      /main.<span class="hljs-keyword">go</span>:<span class="hljs-number">21</span> +<span class="hljs-number">0x75</span><br>  main.main()<br>      /main.<span class="hljs-keyword">go</span>:<span class="hljs-number">14</span> +<span class="hljs-number">0x38</span><br>==================<br>exit status <span class="hljs-number">66</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç»“æœéå¸¸æ¸…æ™°çš„å‘Šè¯‰äº†æˆ‘ä»¬åœ¨ 29 è¡Œè¿™ä¸ªåœ°æ–¹æˆ‘ä»¬æœ‰ä¸€ä¸ª goroutine åœ¨è¯»å–æ•°æ®ï¼Œä½†æ˜¯å‘¢ï¼Œåœ¨ 31 è¡Œè¿™ä¸ªåœ°æ–¹åˆæœ‰ä¸€ä¸ª goroutine åœ¨å†™å…¥ï¼Œæ‰€ä»¥äº§ç”Ÿäº†æ•°æ®ç«äº‰ã€‚<br>ç„¶åä¸‹é¢åˆ†åˆ«è¯´æ˜è¿™ä¸¤ä¸ª goroutine æ˜¯ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„ï¼Œå·²ç»å½“å‰æ˜¯å¦åœ¨è¿è¡Œå½“ä¸­ã€‚</p><h3 id="å…¸å‹æ¡ˆä¾‹"><a href="#å…¸å‹æ¡ˆä¾‹" class="headerlink" title="å…¸å‹æ¡ˆä¾‹"></a>å…¸å‹æ¡ˆä¾‹</h3><p>æ¥æ¥ä¸‹æˆ‘ä»¬å†æ¥çœ‹ä¸€äº›å…¸å‹æ¡ˆä¾‹ï¼Œè¿™äº›æ¡ˆä¾‹éƒ½æ¥è‡ª go å®˜æ–¹çš„æ–‡æ¡£ <a href="https://golang.org/doc/articles/race_detector.html">Data Race Detector</a>ï¼Œè¿™äº›ä¹Ÿæ˜¯åˆå­¦è€…å¾ˆå®¹æ˜“çŠ¯çš„é”™è¯¯</p><h4 id="æ¡ˆä¾‹äºŒ-åœ¨å¾ªç¯ä¸­å¯åŠ¨-goroutine-å¼•ç”¨ä¸´æ—¶å˜é‡"><a href="#æ¡ˆä¾‹äºŒ-åœ¨å¾ªç¯ä¸­å¯åŠ¨-goroutine-å¼•ç”¨ä¸´æ—¶å˜é‡" class="headerlink" title="æ¡ˆä¾‹äºŒ åœ¨å¾ªç¯ä¸­å¯åŠ¨ goroutine å¼•ç”¨ä¸´æ—¶å˜é‡"></a>æ¡ˆä¾‹äºŒ åœ¨å¾ªç¯ä¸­å¯åŠ¨ goroutine å¼•ç”¨ä¸´æ—¶å˜é‡</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br>wg.Add(<span class="hljs-number">5</span>)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(i) <span class="hljs-comment">// Not the &#x27;i&#x27; you are looking for.</span><br>wg.Done()<br>&#125;()<br>&#125;<br>wg.Wait()<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœä½ å»æ‰¾ä¸€äº› go çš„é¢è¯•é¢˜ï¼Œè‚¯å®šèƒ½æ‰¾åˆ°ç±»ä¼¼çš„ä¾‹å­ï¼Œç„¶åä¼šé—®ä½ è¿™é‡Œä¼šè¾“å‡ºä»€ä¹ˆï¼Ÿ<br>å¸¸è§çš„ç­”æ¡ˆå°±æ˜¯ä¼šè¾“å‡º 5 ä¸ª 5ï¼Œå› ä¸ºåœ¨ for å¾ªç¯çš„ i++ ä¼šæ‰§è¡Œçš„å¿«ä¸€äº›ï¼Œæ‰€ä»¥åœ¨æœ€åæ‰“å°çš„ç»“æœéƒ½æ˜¯ 5<br>è¿™ä¸ªç­”æ¡ˆä¸èƒ½è¯´ä¸å¯¹ï¼Œå› ä¸ºçœŸçš„æ‰§è¡Œçš„è¯å¤§æ¦‚ç‡ä¹Ÿæ˜¯è¿™ä¸ªç»“æœï¼Œä½†æ˜¯ä¸å…¨<br>å› ä¸ºè¿™é‡Œæœ¬è´¨ä¸Šæ˜¯æœ‰æ•°æ®ç«äº‰ï¼Œåœ¨æ–°å¯åŠ¨çš„ goroutine å½“ä¸­è¯»å– i çš„å€¼ï¼Œåœ¨ main ä¸­å†™å…¥ï¼Œå¯¼è‡´å‡ºç°äº† data raceï¼Œè¿™ä¸ªç»“æœåº”è¯¥æ˜¯ä¸å¯é¢„çŸ¥çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½å‡å®š goroutine ä¸­ print å°±ä¸€å®šæ¯”å¤–é¢çš„ i++ æ…¢ï¼Œä¹ æƒ¯æ€§çš„åšè¿™ç§å‡è®¾åœ¨å¹¶å‘ç¼–ç¨‹ä¸­æ˜¯å¾ˆæœ‰å¯èƒ½ä¼šå‡ºé—®é¢˜çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br>wg.Add(<span class="hljs-number">5</span>)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-keyword">int</span>)</span></span> &#123;<br>fmt.Println(i)<br>wg.Done()<br>&#125;(i)<br>&#125;<br>wg.Wait()<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªè¦ä¿®æ”¹ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦å°† i ä½œä¸ºå‚æ•°ä¼ å…¥å³å¯ï¼Œè¿™æ ·æ¯ä¸ª goroutine æ‹¿åˆ°çš„éƒ½æ˜¯æ‹·è´åçš„æ•°æ®</p><h4 id="æ¡ˆä¾‹ä¸‰-ä¸€ä¸å°å¿ƒå°±æŠŠå˜é‡å…±äº«äº†"><a href="#æ¡ˆä¾‹ä¸‰-ä¸€ä¸å°å¿ƒå°±æŠŠå˜é‡å…±äº«äº†" class="headerlink" title="æ¡ˆä¾‹ä¸‰ ä¸€ä¸å°å¿ƒå°±æŠŠå˜é‡å…±äº«äº†"></a>æ¡ˆä¾‹ä¸‰ ä¸€ä¸å°å¿ƒå°±æŠŠå˜é‡å…±äº«äº†</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;os&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>ParallelWrite([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;xxx&quot;</span>))<br>&#125;<br><br><span class="hljs-comment">// ParallelWrite writes data to file1 and file2, returns the errors.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ParallelWrite</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">chan</span> <span class="hljs-title">error</span></span> &#123;<br>res := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> error, <span class="hljs-number">2</span>)<br>f1, err := os.Create(<span class="hljs-string">&quot;/tmp/file1&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>res &lt;- err<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// This err is shared with the main goroutine,</span><br><span class="hljs-comment">// so the write races with the write below.</span><br>_, err = f1.Write(data)<br>res &lt;- err<br>f1.Close()<br>&#125;()<br>&#125;<br>f2, err := os.Create(<span class="hljs-string">&quot;/tmp/file2&quot;</span>) <span class="hljs-comment">// The second conflicting write to err.</span><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>res &lt;- err<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>_, err = f2.Write(data)<br>res &lt;- err<br>f2.Close()<br>&#125;()<br>&#125;<br><span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä½¿ç”¨ <code>go run -race main.go</code>  æ‰§è¡Œï¼Œå¯ä»¥å‘ç°è¿™é‡ŒæŠ¥é”™çš„åœ°æ–¹æ˜¯ï¼Œ19 è¡Œå’Œ 24 è¡Œï¼Œæœ‰ data raceï¼Œè¿™é‡Œä¸»è¦æ˜¯å› ä¸ºå…±äº«äº† err è¿™ä¸ªå˜é‡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go">==================<br>WARNING: DATA RACE<br>Write at <span class="hljs-number">0x00c0000a01a0</span> by goroutine <span class="hljs-number">7</span>:<br>  main.ParallelWrite.func1()<br>      /home/ll/project/Go<span class="hljs-number">-000</span>/Week03/blog/<span class="hljs-number">03</span>_data_race/<span class="hljs-number">03</span>/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">19</span> +<span class="hljs-number">0x94</span><br><br>Previous write at <span class="hljs-number">0x00c0000a01a0</span> by main goroutine:<br>  main.ParallelWrite()<br>      /home/ll/project/Go<span class="hljs-number">-000</span>/Week03/blog/<span class="hljs-number">03</span>_data_race/<span class="hljs-number">03</span>/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">24</span> +<span class="hljs-number">0x1dd</span><br>  main.main()<br>      /home/ll/project/Go<span class="hljs-number">-000</span>/Week03/blog/<span class="hljs-number">03</span>_data_race/<span class="hljs-number">03</span>/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">6</span> +<span class="hljs-number">0x84</span><br><br>Goroutine <span class="hljs-number">7</span> (running) created at:<br>  main.ParallelWrite()<br>      /home/ll/project/Go<span class="hljs-number">-000</span>/Week03/blog/<span class="hljs-number">03</span>_data_race/<span class="hljs-number">03</span>/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">16</span> +<span class="hljs-number">0x336</span><br>  main.main()<br>      /home/ll/project/Go<span class="hljs-number">-000</span>/Week03/blog/<span class="hljs-number">03</span>_data_race/<span class="hljs-number">03</span>/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">6</span> +<span class="hljs-number">0x84</span><br>==================<br>Found <span class="hljs-number">1</span> data race(s)<br>exit status <span class="hljs-number">66</span><br></code></pre></td></tr></table></figure><p>ä¿®æ”¹çš„è¯åªéœ€è¦åœ¨ä¸¤ä¸ª goroutine ä¸­ä½¿ç”¨æ–°çš„ä¸´æ—¶å˜é‡å°±è¡Œäº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">...<br>_, err := f1.Write(data)<br>...<br>_, err := f2.Write(data)<br>...<br></code></pre></td></tr></table></figure><p>ç»†å¿ƒçš„åŒå­¦å¯èƒ½ä¼šæœ‰è¿™ä¸ªç–‘é—®ï¼Œåœ¨ 24 è¡Œä¸ä¹Ÿæ˜¯é‡æ–°èµ‹å€¼äº†ä¹ˆï¼Œä¸ºä»€ä¹ˆåœ¨è¿™é‡Œä¼šå’Œ 19 è¡Œäº§ç”Ÿ data race å‘¢ï¼Ÿ<br>è¿™æ˜¯ç”±äº go çš„è¯­æ³•è§„åˆ™å¯¼è‡´çš„ï¼Œæˆ‘ä»¬åœ¨åˆå§‹åŒ–å˜é‡çš„æ—¶å€™å¦‚æœåœ¨åŒä¸€ä¸ªä½œç”¨åŸŸä¸‹ï¼Œå¦‚ä¸‹æ–¹ä»£ç ï¼Œè¿™é‡Œä½¿ç”¨çš„ err å…¶å®æ˜¯åŒä¸€ä¸ªå˜é‡ï¼Œåªæ˜¯ f1 f2 ä¸åŒï¼Œå…·ä½“å¯ä»¥çœ‹ <a href="https://golang.org/doc/effective_go.html#redeclaration">effective go å½“ä¸­ Redeclaration and reassignment</a> çš„å†…å®¹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">f1, err := os.Create(<span class="hljs-string">&quot;a&quot;</span>)<br>f2, err := os.Create(<span class="hljs-string">&quot;b&quot;</span>)<br></code></pre></td></tr></table></figure><h4 id="æ¡ˆä¾‹å››-ä¸å—ä¿æŠ¤çš„å…¨å±€å˜é‡"><a href="#æ¡ˆä¾‹å››-ä¸å—ä¿æŠ¤çš„å…¨å±€å˜é‡" class="headerlink" title="æ¡ˆä¾‹å›› ä¸å—ä¿æŠ¤çš„å…¨å±€å˜é‡"></a>æ¡ˆä¾‹å›› ä¸å—ä¿æŠ¤çš„å…¨å±€å˜é‡</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> service = <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>&#123;&#125;<br><br><span class="hljs-comment">// RegisterService RegisterService</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RegisterService</span><span class="hljs-params">(name, addr <span class="hljs-keyword">string</span>)</span></span> &#123;<br>service[name] = addr<br>&#125;<br><br><span class="hljs-comment">// LookupService LookupService</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LookupService</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">return</span> service[name]<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªä¹Ÿæ˜¯å¾ˆå®¹æ˜“çŠ¯çš„ä¸€ä¸ªé”™ï¼Œåœ¨ä¹‹å‰å†™ Go è®¾è®¡æ¨¡å¼è¿™ä¸ªç³»åˆ—æ–‡ç« çš„æ—¶å€™ï¼Œåº”è¯¥æœ‰æåˆ°è¿‡æˆ‘ä»¬è¦å†™å‡ºå¯æµ‹æ€§æ¯”è¾ƒé«˜çš„ä»£ç å°±è¦å°‘ç”¨æˆ–è€…æ˜¯å°½é‡é¿å…ç”¨å…¨å±€å˜é‡ï¼Œä½¿ç”¨ map ä½œä¸ºå…¨å±€å˜é‡æ¯”è¾ƒå¸¸è§çš„ä¸€ç§æƒ…å†µå°±æ˜¯é…ç½®ä¿¡æ¯ã€‚å…³äºå…¨å±€å˜é‡çš„è¯ä¸€èˆ¬çš„åšæ³•å°±æ˜¯åŠ é”ï¼Œå°±æœ¬æ–‡è¿™ä¸ªé—®é¢˜ä¹Ÿå¯ä»¥ä½¿ç”¨ sync.Map è¿™ä¸ªä¸‹ä¸€ç¯‡æ–‡ç« ä¼šè®²ï¼Œè¿™é‡Œç¯‡å¹…æœ‰é™å°±ä¸å¤šè®²äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> (<br>service   <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span><br>serviceMu sync.Mutex<br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RegisterService</span><span class="hljs-params">(name, addr <span class="hljs-keyword">string</span>)</span></span> &#123;<br>serviceMu.Lock()<br><span class="hljs-keyword">defer</span> serviceMu.Unlock()<br>service[name] = addr<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LookupService</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;<br>serviceMu.Lock()<br><span class="hljs-keyword">defer</span> serviceMu.Unlock()<br><span class="hljs-keyword">return</span> service[name]<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ¡ˆä¾‹äº”-æœªå—ä¿æŠ¤çš„æˆå‘˜å˜é‡"><a href="#æ¡ˆä¾‹äº”-æœªå—ä¿æŠ¤çš„æˆå‘˜å˜é‡" class="headerlink" title="æ¡ˆä¾‹äº” æœªå—ä¿æŠ¤çš„æˆå‘˜å˜é‡"></a>æ¡ˆä¾‹äº” æœªå—ä¿æŠ¤çš„æˆå‘˜å˜é‡</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Watchdog <span class="hljs-keyword">struct</span>&#123; last <span class="hljs-keyword">int64</span> &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Watchdog)</span> <span class="hljs-title">KeepAlive</span><span class="hljs-params">()</span></span> &#123;<br>w.last = time.Now().UnixNano() <span class="hljs-comment">// First conflicting access.</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Watchdog)</span> <span class="hljs-title">Start</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br>time.Sleep(time.Second)<br><span class="hljs-comment">// Second conflicting access.</span><br><span class="hljs-keyword">if</span> w.last &lt; time.Now().Add(<span class="hljs-number">-10</span>*time.Second).UnixNano() &#123;<br>fmt.Println(<span class="hljs-string">&quot;No keepalives for 10 seconds. Dying.&quot;</span>)<br>os.Exit(<span class="hljs-number">1</span>)<br>&#125;<br>&#125;<br>&#125;()<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ ·æˆå‘˜å˜é‡ä¹Ÿä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œå¯ä»¥ç”¨ <code>atomic</code>  åŒ…æ¥è§£å†³ï¼ŒåŒæ ·è¿™ä¸ªæˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« ä¼šç»†è®²</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Watchdog <span class="hljs-keyword">struct</span>&#123; last <span class="hljs-keyword">int64</span> &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Watchdog)</span> <span class="hljs-title">KeepAlive</span><span class="hljs-params">()</span></span> &#123;<br>atomic.StoreInt64(&amp;w.last, time.Now().UnixNano())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *Watchdog)</span> <span class="hljs-title">Start</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br>time.Sleep(time.Second)<br><span class="hljs-keyword">if</span> atomic.LoadInt64(&amp;w.last) &lt; time.Now().Add(<span class="hljs-number">-10</span>*time.Second).UnixNano() &#123;<br>fmt.Println(<span class="hljs-string">&quot;No keepalives for 10 seconds. Dying.&quot;</span>)<br>os.Exit(<span class="hljs-number">1</span>)<br>&#125;<br>&#125;<br>&#125;()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ¡ˆä¾‹å…­-ä¸€ä¸ªæœ‰è¶£çš„ä¾‹å­"><a href="#æ¡ˆä¾‹å…­-ä¸€ä¸ªæœ‰è¶£çš„ä¾‹å­" class="headerlink" title="æ¡ˆä¾‹å…­ ä¸€ä¸ªæœ‰è¶£çš„ä¾‹å­"></a>æ¡ˆä¾‹å…­ ä¸€ä¸ªæœ‰è¶£çš„ä¾‹å­</h3><p>dava åœ¨åšå®¢ä¸­æåˆ°è¿‡ä¸€ä¸ªå¾ˆæœ‰è¶£çš„ä¾‹å­çš„ <a href="https://dave.cheney.net/2014/06/27/ice-cream-makers-and-data-races">Ice cream makers and data races</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">type</span> IceCreamMaker <span class="hljs-keyword">interface</span> &#123;<br><span class="hljs-comment">// Great a customer.</span><br>Hello()<br>&#125;<br><br><span class="hljs-keyword">type</span> Ben <span class="hljs-keyword">struct</span> &#123;<br>name <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Ben)</span> <span class="hljs-title">Hello</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;Ben says, \&quot;Hello my name is %s\&quot;\n&quot;</span>, b.name)<br>&#125;<br><br><span class="hljs-keyword">type</span> Jerry <span class="hljs-keyword">struct</span> &#123;<br>name <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(j *Jerry)</span> <span class="hljs-title">Hello</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;Jerry says, \&quot;Hello my name is %s\&quot;\n&quot;</span>, j.name)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> ben = &amp;Ben&#123;name: <span class="hljs-string">&quot;Ben&quot;</span>&#125;<br><span class="hljs-keyword">var</span> jerry = &amp;Jerry&#123;<span class="hljs-string">&quot;Jerry&quot;</span>&#125;<br><span class="hljs-keyword">var</span> maker IceCreamMaker = ben<br><br><span class="hljs-keyword">var</span> loop0, loop1 <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span><br><br>loop0 = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>maker = ben<br><span class="hljs-keyword">go</span> loop1()<br>&#125;<br><br>loop1 = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>maker = jerry<br><span class="hljs-keyword">go</span> loop0()<br>&#125;<br><br><span class="hljs-keyword">go</span> loop0()<br><br><span class="hljs-keyword">for</span> &#123;<br>maker.Hello()<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­æœ‰è¶£çš„ç‚¹åœ¨äºï¼Œæœ€åè¾“å‡ºçš„ç»“æœä¼šæœ‰è¿™ç§ä¾‹å­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">Ben says, <span class="hljs-string">&quot;Hello my name is Jerry&quot;</span><br>Ben says, <span class="hljs-string">&quot;Hello my name is Jerry&quot;</span><br></code></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨ <code>maker = jerry</code>  è¿™ç§èµ‹å€¼æ“ä½œçš„æ—¶å€™å¹¶ä¸æ˜¯åŸå­çš„ï¼Œåœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬è®²åˆ°è¿‡ï¼Œåªæœ‰å¯¹ single machine word è¿›è¡Œèµ‹å€¼çš„æ—¶å€™æ‰æ˜¯åŸå­çš„ï¼Œè™½ç„¶è¿™ä¸ªçœ‹ä¸Šå»åªæœ‰ä¸€è¡Œï¼Œä½†æ˜¯ interface åœ¨ go ä¸­å…¶å®æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå®ƒåŒ…å«äº† type å’Œ data ä¸¤ä¸ªéƒ¨åˆ†ï¼Œæ‰€ä»¥å®ƒçš„å¤åˆ¶ä¹Ÿä¸æ˜¯åŸå­çš„ï¼Œä¼šå‡ºç°é—®é¢˜</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> <span class="hljs-keyword">interface</span> <span class="hljs-keyword">struct</span> &#123;<br>       Type <span class="hljs-keyword">uintptr</span>     <span class="hljs-comment">// points to the type of the interface implementation</span><br>       Data <span class="hljs-keyword">uintptr</span>     <span class="hljs-comment">// holds the data for the interface&#x27;s receiver</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ¡ˆä¾‹æœ‰è¶£çš„ç‚¹è¿˜åœ¨äºï¼Œè¿™ä¸ªæ¡ˆä¾‹çš„ä¸¤ä¸ªç»“æ„ä½“çš„å†…å­˜å¸ƒå±€ä¸€æ¨¡ä¸€æ ·æ‰€ä»¥å‡ºç°é”™è¯¯ä¹Ÿä¸ä¼š panic é€€å‡ºï¼Œå¦‚æœåœ¨é‡Œé¢å†åŠ å…¥ä¸€ä¸ª string çš„å­—æ®µï¼Œå»è¯»å–å°±ä¼šå¯¼è‡´ panicï¼Œä½†æ˜¯è¿™ä¹Ÿæ°æ°è¯´æ˜è¿™ä¸ªæ¡ˆä¾‹å¾ˆå¯æ€•ï¼Œè¿™ç§é”™è¯¯åœ¨çº¿ä¸Šå®åœ¨å¤ªéš¾å‘ç°äº†ï¼Œè€Œä¸”å¾ˆæœ‰å¯èƒ½ä¼šå¾ˆè‡´å‘½ã€‚<br>è¿™ä¸ªæ¡ˆä¾‹è¿˜æœ‰ä¸€ä¸ªè¡ç”Ÿæ¡ˆä¾‹ï¼Œå¤§å®¶æœ‰å…´è¶£å¯ä»¥ç‚¹å¼€æŸ¥çœ‹ä¸€ä¸‹ï¼Œå¹¶ä¸æ˜¯è¯´è¦çœ‹èµ·æ¥ä¸€æ ·æ‰ä¸ä¼š panic <a href="https://www.ardanlabs.com/blog/2014/06/ice-cream-makers-and-data-races-part-ii.html">https://www.ardanlabs.com/blog/2014/06/ice-cream-makers-and-data-races-part-ii.html</a></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å›é¡¾ä¸€ä¸‹ï¼Œè¿™ç¯‡æ–‡ç« é€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹è®²è§£äº† data race çš„ä½¿ç”¨æ–¹æ³•:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> build -race main.<span class="hljs-keyword">go</span><br><span class="hljs-keyword">go</span> test -race ./...<br></code></pre></td></tr></table></figure><p>ç„¶åè®²è¿°äº† data race å¦‚ä½•é€šè¿‡ GORACE ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®<br>æœ€åè®²è§£äº†å‡ ä¸ªå…¸å‹æ¡ˆä¾‹ï¼Œçœ‹å®Œè¿™ç¯‡ç›¸ä¿¡ä½ å¯¹ data race å·²ç»æœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„äº†è§£ï¼Œå¸Œæœ›å¯ä»¥åœ¨æ¥ä¸‹æ¥çš„å·¥ä½œå­¦ä¹ å½“ä¸­å¯¹ä½ æœ‰æœ‰æ‰€å¯å‘<br>æœ€ååœ¨é‡ç”³ä¸€ä¸‹å…³é”®ç‚¹ï¼š</p><ul><li>å–„ç”¨ data race è¿™ä¸ªå·¥å…·å¸®åŠ©æˆ‘ä»¬æå‰å‘ç°å¹¶å‘é”™è¯¯</li><li>ä¸è¦å¯¹æœªå®šä¹‰çš„è¡Œä¸ºåšä»»ä½•å‡è®¾ï¼Œè™½ç„¶æœ‰æ—¶å€™æˆ‘ä»¬å†™çš„åªæ˜¯ä¸€è¡Œä»£ç ï¼Œä½†æ˜¯ go ç¼–è¯‘å™¨å¯èƒ½åé¢åäº†å¾ˆå¤šäº‹æƒ…ï¼Œå¹¶ä¸æ˜¯è¯´ä¸€è¡Œå†™å®Œå°±ä¸€å®šæ˜¯åŸå­çš„</li><li>å³ä½¿æ˜¯åŸå­çš„å‡ºç°äº† data race ä¹Ÿä¸èƒ½ä¿è¯å®‰å…¨ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æœ‰å¯è§æ€§çš„é—®é¢˜ï¼Œä¸Šç¯‡æˆ‘ä»¬è®²åˆ°äº†ç°ä»£çš„ cpu åŸºæœ¬ä¸Šéƒ½ä¼šæœ‰ä¸€äº›ç¼“å­˜çš„æ“ä½œã€‚</li><li>æ‰€æœ‰å‡ºç°äº† data race çš„åœ°æ–¹éƒ½éœ€è¦è¿›è¡Œå¤„ç†</li></ul><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ul><li><a href="https://dave.cheney.net/2014/06/27/ice-cream-makers-and-data-races">https://dave.cheney.net/2014/06/27/ice-cream-makers-and-data-races</a></li><li><a href="https://www.ardanlabs.com/blog/2014/06/ice-cream-makers-and-data-races-part-ii.html">https://www.ardanlabs.com/blog/2014/06/ice-cream-makers-and-data-races-part-ii.html</a></li><li><a href="http://blog.golang.org/race-detector">http://blog.golang.org/race-detector</a></li><li><a href="https://golang.org/doc/articles/race_detector.html">https://golang.org/doc/articles/race_detector.html</a></li><li><a href="https://dave.cheney.net/2018/01/06/if-aligned-memory-writes-are-atomic-why-do-we-need-the-sync-atomic-package">https://dave.cheney.net/2018/01/06/if-aligned-memory-writes-are-atomic-why-do-we-need-the-sync-atomic-package</a> é™¤äº†è€ƒè™‘åŸå­æ€§ä¹‹å¤–ï¼Œè¿˜è¦è€ƒè™‘å¯è§æ€§ï¼Œå¹¶ä¸æ˜¯è¯´èµ‹å€¼åŸå­äº†ï¼Œå¹¶å‘æ“ä½œå°±æ²¡æœ‰é—®é¢˜äº†</li><li><a href="https://golang.org/doc/effective_go.html#redeclaration">https://golang.org/doc/effective_go.html#redeclaration</a></li></ul><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week03: Go å¹¶å‘ç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¹¶å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¹¶å‘ç¼–ç¨‹(äºŒ) Go å†…å­˜æ¨¡å‹</title>
    <link href="/post/go-training-week3-go-memory-model.html"/>
    <url>/post/go-training-week3-go-memory-model.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h2><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« å½“ä¸­æˆ‘ä»¬è®²åˆ°äº†ä½¿ç”¨ goroutine çš„ä¸€äº›æ³¨æ„äº‹é¡¹ï¼Œæˆ‘ä»¬å…ˆç®€å•å›é¡¾ä¸€ä¸‹:</p><ol><li><strong>è¯·å°†æ˜¯å¦å¼‚æ­¥è°ƒç”¨çš„é€‰æ‹©æƒäº¤ç»™è°ƒç”¨è€…</strong>ï¼Œä¸ç„¶å¾ˆæœ‰å¯èƒ½å¤§å®¶å¹¶ä¸çŸ¥é“ä½ åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ä½¿ç”¨äº† goroutine</li><li>å¦‚æœä½ è¦å¯åŠ¨ä¸€ä¸ª goroutine è¯·å¯¹å®ƒè´Ÿè´£<ol><li><strong>æ°¸è¿œä¸è¦å¯åŠ¨ä¸€ä¸ªä½ æ— æ³•æ§åˆ¶å®ƒé€€å‡ºï¼Œæˆ–è€…ä½ æ— æ³•çŸ¥é“å®ƒä½•æ—¶æ¨å‡ºçš„ goroutine</strong></li><li>è¿˜æœ‰ä¸Šä¸€ç¯‡æåˆ°çš„ï¼Œå¯åŠ¨ goroutine æ—¶è¯·åŠ ä¸Š panic recovery æœºåˆ¶ï¼Œé¿å…æœåŠ¡ç›´æ¥ä¸å¯ç”¨</li><li>é€ æˆ goroutine æ³„æ¼çš„ä¸»è¦åŸå› å°±æ˜¯ goroutine ä¸­é€ æˆäº†é˜»å¡ï¼Œå¹¶ä¸”æ²¡æœ‰å¤–éƒ¨æ‰‹æ®µæ§åˆ¶å®ƒé€€å‡º</li></ol></li><li><strong>å°½é‡é¿å…åœ¨è¯·æ±‚ä¸­ç›´æ¥å¯åŠ¨ goroutine æ¥å¤„ç†é—®é¢˜</strong>ï¼Œè€Œåº”è¯¥é€šè¿‡å¯åŠ¨ worker æ¥è¿›è¡Œæ¶ˆè´¹ï¼Œè¿™æ ·å¯ä»¥é¿å…ç”±äºè¯·æ±‚é‡è¿‡å¤§ï¼Œè€Œå¯¼è‡´å¤§é‡åˆ›å»º goroutine ä»è€Œå¯¼è‡´ oomï¼Œå½“ç„¶å¦‚æœè¯·æ±‚é‡æœ¬èº«éå¸¸å°ï¼Œé‚£å½“æˆ‘æ²¡è¯´</li></ol><p>é‚£æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆä½¿ç”¨ goroutine å‘¢ï¼Ÿä»Šå¤©æˆ‘ä»¬ä»åŸç†å±‚é¢æ¥äº†è§£ä¸€ä¸‹ goroutine çš„æ³¨æ„äº‹é¡¹ï¼Œæœ¬æ–‡ä»¥ Go å®˜æ–¹åšå®¢å½“ä¸­çš„ <a href="https://golang.org/ref/mem">https://golang.org/ref/mem</a> ä¸ºä¸»å¹²ç©¿æ’è®²è§£ï¼Œå»ºè®®é˜…è¯»æœ¬æ–‡å‰å…ˆè‡ªè¡Œçœ‹å®Œä¸€éåŸæ–‡ï¼Œä¼šæœ‰æ›´å¤šçš„æ”¶è·</p><h2 id="Go-å†…å­˜æ¨¡å‹"><a href="#Go-å†…å­˜æ¨¡å‹" class="headerlink" title="Go å†…å­˜æ¨¡å‹"></a>Go å†…å­˜æ¨¡å‹</h2><p>åŒæ ·æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µä»£ç ï¼Œè¯·é—®ä¸‹é¢çš„ä»£ç å¯èƒ½ä¼šè¾“å‡ºä»€ä¹ˆï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">var</span> a, b <span class="hljs-keyword">int</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span> &#123;<br>a = <span class="hljs-number">1</span><br>b = <span class="hljs-number">2</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">g</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-built_in">print</span>(b)<br><span class="hljs-built_in">print</span>(a)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">go</span> f()<br>g()<br>&#125;<br></code></pre></td></tr></table></figure><p>okï¼Œè¯·å¸¦ç€ä½ çš„ç­”æ¡ˆæˆ–è€…æ˜¯å›°æƒ‘æˆ‘ä»¬å¾€ä¸‹èµ°<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1608363233129-3653a44c-74a9-46dc-94b0-c6151da0c07c.svg" alt="02_Goè¿›é˜¶03_blog_img.drawio.svg"><br>æ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„ç»“æœæ˜¯:</p><ul><li>æ‰§è¡Œé¡ºåº: 1 - 2 - 3 - 4, f å…ˆæ‰§è¡Œ, g åæ‰§è¡Œ, è¾“å‡º <code>2 1</code></li><li>æ‰§è¡Œé¡ºåº: 3 - 4 - 1 - 2, g å…ˆæ‰§è¡Œï¼Œf åæ‰§è¡Œï¼Œè¾“å‡º <code>0 0</code></li></ul><p>å°±è¿™å‡ ç§ç»“æœä¹ˆï¼Ÿå…¶å®ä¸ç„¶ï¼Œè¿˜æœ‰å¯èƒ½</p><ul><li>æ‰§è¡Œé¡ºåº: 1 - 3 - 4 - 2, <code>f</code>  å…ˆæ‰§è¡Œä¸€éƒ¨åˆ†, ç„¶å <code>g</code>  æ‰§è¡Œ, è¾“å‡º <code>0 1</code></li></ul><p>é‚£èƒ½ä¸èƒ½è¾“å‡º <code>2 0</code>  å‘¢ï¼Ÿ</p><ul><li>å…ˆè¯´ç­”æ¡ˆï¼Œæ˜¯æœ‰å¯èƒ½çš„</li></ul><p>æ˜¯ä¸æ˜¯æ„Ÿè§‰æœ‰ç‚¹åå¸¸è¯†ï¼Ÿæ˜¯ä¸æ˜¯æ„Ÿè§‰æœ‰ç‚¹é£˜å¿½ä¸å®šï¼Ÿå¼•ç”¨å‚è€ƒæ–‡ç« é‡Œé¢æ›¹å¤§çš„ä¸€å¥è¯ï¼š</p><blockquote><p>è½¯ä»¶(<em>ç¼–è¯‘å™¨</em>)æˆ–ç¡¬ä»¶(<em>CPU</em>)ç³»ç»Ÿå¯ä»¥æ ¹æ®å…¶å¯¹ä»£ç çš„åˆ†æç»“æœï¼Œä¸€å®šç¨‹åº¦ä¸Šæ‰“ä¹±ä»£ç çš„æ‰§è¡Œé¡ºåºï¼Œä»¥è¾¾åˆ°å…¶ä¸å¯å‘Šäººçš„ç›®çš„(<em>æé«˜ CPU åˆ©ç”¨ç‡)</em></p></blockquote><p>æ‰€ä»¥æˆ‘ä»¬åœ¨ç¼–å†™å¹¶å‘ç¨‹åºçš„æ—¶å€™ä¸€å®šè¦å°å¿ƒï¼Œç„¶åå›åˆ°æˆ‘ä»¬æœ¬æ¬¡çš„ä¸»é¢˜ Go å†…å­˜æ¨¡å‹ï¼Œå°±æ˜¯è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªæ˜¯è¦äº†è§£è°å…ˆè°åï¼Œæœ‰ä¸ªä¸“æœ‰åè¯å« <code>Happens Before</code> ï¼Œå¦å¤–ä¸€ä¸ªå°±æ˜¯äº†è§£å¯è§æ€§çš„é—®é¢˜ï¼Œæˆ‘è¿™æ¬¡è¯»å–èƒ½ä¸èƒ½çœ‹åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„å†™å…¥<br>æ¥ä¸‹æ¥æˆ‘ä»¬å®˜æ–¹çš„æ–‡æ¡£<a href="https://golang.org/ref/mem">ã€ŠThe Go Memory Modelã€‹</a>çš„æ€è·¯ä¸€æ­¥ä¸€æ­¥çš„äº†è§£è¿™äº›é—®é¢˜ï¼Œå› ä¸ºå®˜æ–¹çš„æ–‡æ¡£å†™çš„ç›¸å¯¹æ¯”è¾ƒç²¾ç‚¼ï¼Œæ‰€ä»¥ä¼šæ¯”è¾ƒéš¾æ‡‚ï¼Œæˆ‘ä¼šå°è¯•åŠ å…¥ä¸€äº›æˆ‘çš„ç†è§£è¡¥å……è¯´æ˜</p><h3 id="å¿ å‘Š"><a href="#å¿ å‘Š" class="headerlink" title="å¿ å‘Š"></a>å¿ å‘Š</h3><blockquote><p>Programs that modify data being simultaneously accessed by multiple goroutines must serialize such access.<br>To serialize access, protect the data with channel operations or other synchronization primitives such as those in the <a href="https://golang.org/pkg/sync/"><code>sync</code></a> and <a href="https://golang.org/pkg/sync/atomic/"><code>sync/atomic</code></a> packages.</p></blockquote><p>è¿™ä¸ªæ˜¯è¯´å¦‚æœä½ çš„ç¨‹åºå­˜åœ¨å¤šä¸ª goroutine å»è®¿é—®æ•°æ®çš„æ—¶å€™ï¼Œ<strong>å¿…é¡»åºåˆ—åŒ–çš„è®¿é—®ï¼Œ</strong>å¦‚ä½•ä¿è¯åºåˆ—åŒ–å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ channel æˆ–è€…æ˜¯ sync ä»¥åŠ sync/atomic ä¸‹é¢æä¾›çš„åŒæ­¥è¯­ä¹‰æ¥ä¿è¯</p><h3 id="Happens-Before"><a href="#Happens-Before" class="headerlink" title="Happens Before"></a>Happens Before</h3><h4 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h4><blockquote><p>Within a single goroutine, reads and writes must behave as if they executed in the order specified by the program. That is, compilers and processors may reorder the reads and writes executed within a single goroutine only when the reordering does not change the behavior within that goroutine as defined by the language specification. Because of this reordering, the execution order observed by one goroutine may differ from the order perceived by another. For example, if one goroutine executes a = 1; b = 2;, another might observe the updated value of b before the updated value of a.</p></blockquote><p>è¿™æ®µè¯å°±è§£é‡Šäº†ä¸Šé¢æˆ‘ä»¬ç¤ºä¾‹å½“ä¸­ä¸ºä»€ä¹ˆä¼šå‡ºç° <code>2 0</code>  è¿™ç§æƒ…å†µã€‚<br>è¿™æ®µè¯å°±æ˜¯è¯´æˆ‘ä»¬åœ¨å•ä¸ª goroutine å½“ä¸­çš„ç¼–å†™çš„ä»£ç ä¼šæ€»æ˜¯æŒ‰ç…§æˆ‘ä»¬ç¼–å†™ä»£ç çš„é¡ºåºæ¥æ‰§è¡Œ</p><ul><li>å½“ç„¶è¿™ä¸ªä¹Ÿæ˜¯ç¬¦åˆæˆ‘ä»¬çš„ä¹ æƒ¯çš„</li><li>å½“ç„¶è¿™å¹¶ä¸è¡¨ç¤ºç¼–è¯‘å™¨åœ¨ç¼–è¯‘çš„æ—¶å€™ä¸ä¼šå¯¹æˆ‘ä»¬çš„ç¨‹åºè¿›è¡ŒæŒ‡ä»¤é‡æ’</li><li>è€Œæ˜¯è¯´åªä¼šåœ¨ä¸å½±å“è¯­è¨€è§„èŒƒå¯¹ goroutine çš„è¡Œä¸ºå®šä¹‰çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å’Œ CPU æ‰ä¼šå¯¹è¯»å–å’Œå†™å…¥çš„é¡ºåºè¿›è¡Œé‡æ–°æ’åºã€‚</li></ul><p>ä½†æ˜¯æ­£æ˜¯å› ä¸ºå­˜åœ¨è¿™ç§é‡æ’çš„æƒ…å†µï¼Œæ‰€ä»¥ä¸€ä¸ª goroutine ç›‘æµ‹åˆ°çš„æ‰§è¡Œé¡ºåºå’Œå¦å¤–ä¸€ä¸ª goroutine ç›‘æµ‹åˆ°çš„æœ‰å¯èƒ½ä¸ä¸€æ ·ã€‚å°±åƒæˆ‘ä»¬æœ€ä¸Šé¢çš„è¿™ä¸ªä¾‹å­ä¸€æ ·ï¼Œå¯èƒ½æˆ‘ä»¬åœ¨ f æ‰§è¡Œçš„é¡ºåºæ˜¯å…ˆæ‰§è¡Œ <code>a = 1</code> åæ‰§è¡Œ <code>b = 2</code> ä½†æ˜¯åœ¨ g ä¸­æˆ‘ä»¬åªçœ‹åˆ°äº† b = 2 å…·ä½“ä»€ä¹ˆæƒ…å†µå¯èƒ½ä¼šå¯¼è‡´è¿™ä¸ªå‘¢ï¼Ÿä¸è¦ç€æ€¥ï¼Œæˆ‘ä»¬åé¢è¿˜ä¼šè¯´åˆ°</p><h4 id="ç¼–è¯‘å™¨é‡æ’"><a href="#ç¼–è¯‘å™¨é‡æ’" class="headerlink" title="ç¼–è¯‘å™¨é‡æ’"></a>ç¼–è¯‘å™¨é‡æ’</h4><p>æˆ‘ä»¬æ¥çœ‹å‚è€ƒæ–‡ç« ä¸­çš„ä¸€ä¸ªç¼–è¯‘å™¨é‡æ’ä¾‹å­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">X = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i in <span class="hljs-keyword">range</span>(<span class="hljs-number">100</span>):<br>    X = <span class="hljs-number">1</span><br>    <span class="hljs-built_in">print</span> X<br></code></pre></td></tr></table></figure><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼ŒX = 1 åœ¨ for å¾ªç¯å†…éƒ¨è¢«é‡å¤èµ‹å€¼äº† 100 æ¬¡ï¼Œè¿™å®Œå…¨æ²¡æœ‰å¿…è¦ï¼Œäºæ˜¯èªæ˜çš„ç¼–è¯‘å™¨å°±ä¼šå¸®åŠ©æˆ‘ä»¬ä¼˜åŒ–æˆä¸‹é¢çš„æ ·å­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">X = <span class="hljs-number">1</span><br><span class="hljs-keyword">for</span> i in <span class="hljs-keyword">range</span>(<span class="hljs-number">100</span>):<br>    <span class="hljs-built_in">print</span> X<br></code></pre></td></tr></table></figure><p>å®Œç¾ï¼Œåœ¨å•ä¸ª goroutine ä¸­å¹¶ä¸ä¼šæ”¹å˜ç¨‹åºçš„æ‰§è¡Œï¼Œè¿™æ—¶å€™åŒæ ·ä¼šè¾“å‡º 100 æ¬¡ 1 ï¼Œå¹¶ä¸”å‡å°‘äº† 100 æ¬¡èµ‹å€¼æ“ä½œã€‚<br>ä½†æ˜¯ï¼Œå¦‚æœä¸æ­¤åŒæ—¶æˆ‘ä»¬å­˜åœ¨ä¸€ä¸ªå¦å¤–ä¸€ä¸ª goroutine å¹²äº†å¦å¤–ä¸€ä¸ªäº‹æƒ… X = 0 é‚£ä¹ˆï¼Œè¿™ä¸ªè¾“å‡ºå°±å˜çš„ä¸å¯é¢„çŸ¥äº†ï¼Œå°±æœ‰å¯èƒ½æ˜¯ 1001111101â€¦ è¿™ç§ï¼Œæ‰€ä»¥å›åˆ°åˆšå¼€å§‹çš„å¿ å‘Šï¼š<strong>è¿™ä¸ªæ˜¯è¯´å¦‚æœä½ çš„ç¨‹åºå­˜åœ¨å¤šä¸ª goroutine å»è®¿é—®æ•°æ®çš„æ—¶å€™ï¼Œå¿…é¡»åºåˆ—åŒ–çš„è®¿é—®</strong></p><h4 id="happens-before-å®šä¹‰"><a href="#happens-before-å®šä¹‰" class="headerlink" title="happens before å®šä¹‰"></a>happens before å®šä¹‰</h4><blockquote><p>To specify the requirements of reads and writes, we define happens before, a partial order on the execution of memory operations in a Go program. If event <code>e1</code> happens before event <code>e2</code>, then we say that <code>e2</code> happens after <code>e1</code>. Also, if <code>e1</code> does not happen before <code>e2</code> and does not happen after <code>e2</code>, then we say that <code>e1</code> and <code>e2</code> happen concurrently.</p></blockquote><p>è¿™æ˜¯ Happens Before çš„å®šä¹‰ï¼Œå¦‚æœ <code>e1</code> å‘ç”Ÿåœ¨ <code>e2</code> ä¹‹å‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯´ <code>e2</code> å‘ç”Ÿåœ¨ <code>e1</code> ä¹‹åï¼Œå¦‚æœ <code>e1</code> æ—¢ä¸åœ¨ <code>e2</code> å‰ï¼Œä¹Ÿä¸åœ¨ <code>e2</code> ä¹‹åï¼Œé‚£æˆ‘ä»¬å°±è¯´è¿™ä¿©æ˜¯å¹¶å‘çš„</p><blockquote><p>Within a single goroutine, the happens-before order is the order expressed by the program.</p></blockquote><p>è¿™å°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„ï¼Œåœ¨å•ä¸ª goroutine å½“ä¸­ï¼Œäº‹ä»¶å‘ç”Ÿçš„é¡ºåºï¼Œå°±æ˜¯ç¨‹åºæ‰€è¡¨è¾¾çš„é¡ºåº</p><blockquote><p>A read r of a variable <code>v</code> is allowed to observe a write <code>w</code> to <code>v</code> if both of the following hold:</p><ol><li>r does not happen before <code>w</code>.</li><li>There is no other write <code>w&#39;</code> to <code>v</code> that happens after w but before <code>r</code>.</li></ol></blockquote><p>å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªå˜é‡ <code>v</code>ï¼Œç„¶ååªè¦æ»¡è¶³ä¸‹é¢çš„ä¸¤ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆè¯»å–æ“ä½œ <code>r</code> å°±å¯ä»¥å¯¹è¿™ä¸ªå˜é‡ <code>v</code> çš„å†™å…¥æ“ä½œ <code>w</code> è¿›è¡Œç›‘æµ‹</p><ol><li>è¯»å–æ“ä½œ <code>v</code> å‘ç”Ÿåœ¨å†™å…¥æ“ä½œ <code>w</code> ä¹‹å</li><li>å¹¶ä¸”åœ¨ <code>w</code> ä¹‹åï¼Œ<code>r</code> ä¹‹å‰æ²¡æœ‰å…¶ä»–å¯¹ <code>v</code> çš„å†™å…¥æ“ä½œ <code>w&#39;</code></li></ol><p>æ³¨æ„è¿™é‡Œè¯´çš„åªæ˜¯è¯»å–æ“ä½œ r å¯ä»¥å¯¹ w è¿›è¡Œç›‘æµ‹ï¼Œä½†æ˜¯èƒ½ä¸èƒ½è¯»åˆ°å‘¢ï¼Œå¯èƒ½å¯ä»¥ä¹Ÿå¯èƒ½ä¸è¡Œ</p><blockquote><p>To guarantee that a read <code>r</code> of a variable <code>v</code> observes a particular write <code>w</code> to <code>v</code>, ensure that <code>w</code> is the only write <code>r</code> is allowed to observe. That is, <code>r</code> is guaranteed to observe <code>w</code> if both of the following hold:</p><ol><li><code>w</code> happens before <code>r</code>.</li><li>Any other write to the shared variable <code>v</code> either happens before <code>w</code> or after <code>r</code>.</li></ol></blockquote><p>ä¸ºç¡®ä¿å¯¹å˜é‡ <code>v</code> çš„è¯»å–æ“ä½œ <code>r</code> èƒ½å¤Ÿç›‘æµ‹åˆ°ç‰¹å®šçš„å¯¹ <code>v</code> è¿›è¡Œå†™å…¥çš„æ“ä½œ <code>w</code>ï¼Œéœ€ç¡®ä¿ <code>w</code> æ˜¯å”¯ä¸€å…è®¸è¢« <code>r</code> ç›‘æµ‹çš„å†™å…¥æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè‹¥ä»¥ä¸‹æ¡ä»¶å‡æˆç«‹ï¼Œåˆ™ <code>r</code> èƒ½ä¿è¯ç›‘æµ‹åˆ° <code>w</code>ï¼š</p><ol><li><code>w</code> å‘ç”Ÿåœ¨ <code>r</code> ä¹‹å‰ã€‚</li><li>å¯¹å…±äº«å˜é‡ <code>v</code> çš„å…¶å®ƒä»»ä½•å†™å…¥æ“ä½œéƒ½åªèƒ½å‘ç”Ÿåœ¨ <code>w</code> ä¹‹å‰æˆ– <code>r</code> ä¹‹åã€‚</li></ol><p>è¿™å¯¹æ¡ä»¶çš„è¦æ±‚æ¯”ç¬¬ä¸€ä¸ªæ¡ä»¶æ›´å¼ºï¼Œå®ƒéœ€è¦ç¡®ä¿æ²¡æœ‰å…¶å®ƒå†™å…¥æ“ä½œä¸ <code>w</code> æˆ– <code>r</code> å¹¶å‘ã€‚<br>åœ¨å•ä¸ª goroutine å½“ä¸­è¿™ä¸¤ä¸ªæ¡ä»¶æ˜¯ç­‰ä»·çš„ï¼Œå› ä¸ºå•ä¸ª goroutine ä¸­ä¸å­˜åœ¨å¹¶å‘ï¼Œåœ¨å¤šä¸ª goroutine ä¸­å°±å¿…é¡»ä½¿ç”¨åŒæ­¥è¯­ä¹‰æ¥ç¡®ä¿é¡ºåºï¼Œè¿™æ ·æ‰èƒ½åˆ°ä¿è¯èƒ½å¤Ÿç›‘æµ‹åˆ°é¢„æœŸçš„å†™å…¥<br><strong>å•ä¸ª goroutine çš„æƒ…å†µ</strong>ï¼š<br>æˆ‘ä»¬å¯ä»¥å‘ç°åœ¨å•ä¸ª goroutine å½“ä¸­ï¼Œè¯»å–æ“ä½œ r æ€»æ˜¯å¯ä»¥è¯»å–åˆ°ä¸Šä¸€æ¬¡ w å†™å…¥çš„å€¼çš„<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1608372439492-359ad5bf-1b06-4f4f-ae77-84e96d9f6a7f.png" alt="image.png"><br><strong>å¤šä¸ª goroutine çš„æƒ…å†µ</strong>:<br>ä½†æ˜¯å­˜åœ¨å¤šä¸ª goroutine çš„æ—¶å€™è¿™ä¸ªå°±ä¸ä¸€å®šäº†ï¼Œr0 è¯»åˆ°çš„æ˜¯ å“ªä¸€æ¬¡å†™å…¥çš„å€¼å‘¢ï¼Ÿå¦‚æœçœ‹å›¾çš„è¯åƒæ˜¯ w4 çš„ï¼Œä½†å…¶å®ä¸ä¸€å®šï¼Œå› ä¸ºå›¾ä¸­çš„ä¸¤ä¸ª goroutine æ‰€è¡¨è¾¾çš„æ—¶é—´ç»´åº¦å¯èƒ½æ˜¯ä¸ä¸€è‡´çš„ï¼Œæ‰€ä»¥ r0 å¯èƒ½è¯»åˆ°çš„æ˜¯ w0 w3 w4 ç”šè‡³æ˜¯ w5 çš„ç»“æœï¼Œå½“ç„¶æŒ‰ç…§æˆ‘ä»¬å‰é¢è¯´çš„ç†è®ºï¼Œè¯»åˆ°çš„ä¸å¯èƒ½æ˜¯ w1 çš„ç»“æœçš„<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1608372753766-f3b66fe5-ac34-4f5e-a1b2-c74e7d3dfbc9.png" alt="image.png"><br><strong>æ·»åŠ ä¸€äº›åŒæ­¥ç‚¹</strong><br>å¦‚ä¸‹å›¾æ‰€ç¤ºæˆ‘ä»¬é€šè¿‡ sync åŒ…ä¸­çš„ä¸€äº›åŒæ­¥è¯­ä¹‰æˆ–è€…æ˜¯ channel ä¸ºå¤šä¸ª goroutine åŠ å…¥äº† åŒæ­¥ç‚¹ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å¯¹äº r1 è€Œè¨€ï¼Œä»–å°±æ˜¯æ™šäº w4 å¹¶ä¸”æ—©äº w1 å’Œ w5 æ‰§è¡Œçš„ï¼Œæ‰€ä»¥å®ƒè¯»å–åˆ°çš„æ˜¯å†™å…¥æ“ä½œæ˜¯å¯ä»¥ç¡®å®šçš„ï¼Œæ˜¯ w4<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1608373281116-271c756e-386e-490b-aa7b-0fb2b741ed40.png" alt="image.png"></p><blockquote><p>The initialization of variable <code>v</code> with the zero value for <code>v</code>â€˜s type behaves as a write in the memory model.</p></blockquote><p>ä»¥å˜é‡ <code>v</code> æ‰€å±ç±»å‹çš„é›¶å€¼æ¥å¯¹ <code>v</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œå…¶è¡¨ç°å¦‚åŒåœ¨å†…å­˜æ¨¡å‹ä¸­è¿›è¡Œçš„å†™å…¥æ“ä½œã€‚</p><h4 id="æœºå™¨å­—"><a href="#æœºå™¨å­—" class="headerlink" title="æœºå™¨å­—"></a>æœºå™¨å­—</h4><blockquote><p>Reads and writes of values larger than a single machine word behave as multiple machine-word-sized operations in an unspecified order.</p></blockquote><p>å¯¹å¤§äºå•ä¸ªæœºå™¨å­—çš„å€¼è¿›è¡Œè¯»å–å’Œå†™å…¥ï¼Œå…¶è¡¨ç°å¦‚åŒä»¥ä¸ç¡®å®šçš„é¡ºåºå¯¹å¤šä¸ªæœºå™¨å­—å¤§å°çš„å€¼è¿›è¡Œæ“ä½œã€‚è¦ç†è§£è¿™ä¸ªæˆ‘ä»¬é¦–å…ˆè¦ç†è§£ä»€ä¹ˆæ˜¯æœºå™¨å­—ã€‚<br>æˆ‘ä»¬ç°åœ¨å¸¸è§çš„è¿˜æœ‰ 32 ä½ç³»ç»Ÿå’Œ 64 ä½çš„ç³»ç»Ÿï¼Œcpu åœ¨æ‰§è¡Œä¸€æ¡æŒ‡ä»¤çš„æ—¶å€™å¯¹äºå•ä¸ªæœºå™¨å­—é•¿çš„çš„æ•°æ®çš„å†™å…¥å¯ä»¥ä¿è¯æ˜¯åŸå­çš„ï¼Œå¯¹äº 32 ä½çš„å°±æ˜¯ 4 ä¸ªå­—èŠ‚ï¼Œå¯¹äº 64 ä½çš„å°±æ˜¯ 8 ä¸ªå­—èŠ‚ï¼Œå¯¹äºåœ¨ 32 ä½æƒ…å†µä¸‹å»å†™å…¥ä¸€ä¸ª 8 å­—èŠ‚çš„æ•°æ®æ—¶å°±éœ€è¦æ‰§è¡Œä¸¤æ¬¡å†™å…¥æ“ä½œï¼Œè¿™ä¸¤æ¬¡æ“ä½œä¹‹é—´å°±æ²¡æœ‰åŸå­æ€§ï¼Œé‚£å°±å¯èƒ½å‡ºç°å…ˆå†™å…¥ååŠéƒ¨åˆ†çš„æ•°æ®å†å†™å…¥å‰åŠéƒ¨åˆ†ï¼Œæˆ–è€…æ˜¯å†™å…¥äº†ä¸€åŠæ•°æ®ç„¶åå†™å…¥å¤±è´¥çš„æƒ…å†µã€‚<br>ä¹Ÿå°±æ˜¯è¯´è™½ç„¶æœ‰æ—¶å€™æˆ‘ä»¬çœ‹ç€ä»…ä»…åªåšäº†ä¸€æ¬¡å†™å…¥ä½†æ˜¯è¿˜æ˜¯ä¼šæœ‰å¹¶å‘é—®é¢˜ï¼Œå› ä¸ºå®ƒæœ¬èº«ä¸æ˜¯åŸå­çš„</p><h3 id="åŒæ­¥"><a href="#åŒæ­¥" class="headerlink" title="åŒæ­¥"></a>åŒæ­¥</h3><h4 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h4><blockquote><p>Program initialization runs in a single goroutine, but that goroutine may create other goroutines, which run concurrently.<br>If a package <code>p</code> imports package <code>q</code>, the completion of <code>q</code>â€˜s <code>init</code> functions happens before the start of any of <code>p</code>â€˜s.<br>The start of the function <code>main.main</code> happens after all <code>init</code> functions have finished.</p></blockquote><ul><li>ç¨‹åºçš„åˆå§‹åŒ–è¿è¡Œåœ¨å•ä¸ª goroutine ä¸­ï¼Œä½†è¯¥ goroutine å¯èƒ½ä¼šåˆ›å»ºå…¶å®ƒå¹¶å‘è¿è¡Œçš„ goroutine</li><li>è‹¥åŒ… p å¯¼å…¥äº†åŒ… qï¼Œåˆ™ q çš„ init å‡½æ•°ä¼šåœ¨ p çš„ä»»ä½•å‡½æ•°å¯åŠ¨å‰å®Œæˆã€‚</li><li>å‡½æ•° main.main ä¼šåœ¨æ‰€æœ‰çš„ init å‡½æ•°ç»“æŸåå¯åŠ¨ã€‚<div style="background: #FFFBE6;padding:10px;border: 1px solid #C3C3C3;border-radius:5px;margin-bottom:5px;">æ³¨æ„: åœ¨å®é™…çš„åº”ç”¨ä»£ç ä¸­ä¸è¦éšå¼çš„ä¾èµ–è¿™ä¸ªå¯åŠ¨é¡ºåº</div></li></ul><h4 id="goroutine-çš„åˆ›å»º"><a href="#goroutine-çš„åˆ›å»º" class="headerlink" title="goroutine çš„åˆ›å»º"></a>goroutine çš„åˆ›å»º</h4><blockquote><p>The <code>go</code> statement that starts a new goroutine happens before the goroutineâ€™s execution begins.</p></blockquote><p><code>go</code>  è¯­å¥ä¼šåœ¨ goroutine å¼€å§‹æ‰§è¡Œå‰å¯åŠ¨å®ƒ</p><h4 id="goroutine-çš„é”€æ¯"><a href="#goroutine-çš„é”€æ¯" class="headerlink" title="goroutine çš„é”€æ¯"></a>goroutine çš„é”€æ¯</h4><blockquote><p>The exit of a goroutine is not guaranteed to happen before any event in the programã€‚</p></blockquote><p>goroutine æ— æ³•ç¡®ä¿åœ¨ç¨‹åºä¸­çš„ä»»ä½•äº‹ä»¶å‘ç”Ÿä¹‹å‰é€€å‡º</p><p>æ³¨æ„ <a href="https://golang.org/ref/mem">ã€ŠThe Go Memory Modelã€‹</a>åŸæ–‡ä¸­è¿˜æœ‰å…³äº channelï¼Œ é”ç›¸å…³çš„é˜è¿°ï¼Œå› ä¸ºç¯‡å¹…åŸå› åœ¨æœ¬æ–‡ä¸­å°±ä¸å¤šè®²äº†ï¼Œåé¢æˆ‘ä»¬è¿˜æœ‰å•ç‹¬çš„æ–‡ç« è¯¦ç»†è®² channel å’Œ é” ç›¸å…³çš„ä½¿ç”¨ï¼Œåœ¨å¼ºè°ƒä¸€éï¼ŒåŸæ–‡ä¸€å®šè¦å¤šçœ‹å‡ é</p><h2 id="å†…å­˜é‡æ’"><a href="#å†…å­˜é‡æ’" class="headerlink" title="å†…å­˜é‡æ’"></a>å†…å­˜é‡æ’</h2><p>åœ¨ä¸Šé¢æˆ‘ä»¬è®²åˆ°äº†ç¼–è¯‘å™¨é‡æ’ï¼Œä»¥åŠåœ¨æœ€å¼€å§‹çš„ä¾‹å­ä¸­æˆ‘ä»¬æåˆ°äº†å¯èƒ½ä¼šå­˜åœ¨ <code>2 0</code>  è¿™ä¸ªç­”æ¡ˆï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆã€‚å¦‚æœå¤§å®¶è´­ä¹°ç”µè„‘çš„æ—¶å€™æœ‰å»å¯¹æ¯” cpu çš„è¯åº”è¯¥å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ª cpu éƒ½ä¼šå†™ä¸€ä¸‹ä¸€çº§ç¼“å­˜ï¼ŒäºŒçº§ç¼“å­˜ï¼Œä¸‰çº§ç¼“å­˜çš„å¤§å°ï¼Œè¿™ä¸ªç¼“å­˜å°±æ˜¯è¿™é‡Œçš„ä¸€ä¸ªå…³é”®ç‚¹ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œè¶Šå¾€ä¸‹ç¼“å­˜çš„å¤§å°è¶Šå¤§é€Ÿåº¦è¶Šæ…¢ï¼Œè¿™æ˜¯ cpu ä¸ºäº†æé«˜æ‰§è¡Œé€Ÿåº¦åšçš„ç¼“å­˜ä½“ç³»ï¼Œå°±åƒæˆ‘ä»¬å¹³æ—¶åœ¨åº”ç”¨å½“ä¸­å¼•å…¥ redis ä½œä¸ºç¼“å­˜ç±»ä¼¼ï¼Œéƒ½æ˜¯ä¸ºäº†åŠ é€Ÿã€‚åŒæ—¶è¿™å°±ä¼šå¸¦æ¥ä¸€äº›æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1608385154319-591875fe-fc6f-457f-8fd0-966b8e603310.png" alt="02_Goè¿›é˜¶03_blog_img.drawio-ç¬¬ 4 é¡µ.png"><br><strong>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š</strong></p><ol><li>C1 æ‰§è¡Œ a = 1 å°† store buffer ä¸­ a çš„å€¼å†™ä¸º 1</li><li>C1 æ‰§è¡Œ b = 2 å°† store buffer ä¸­ b çš„å€¼å†™ä¸º 2, ç„¶åç”±äºæŸç§åŸå› å°† b çš„å€¼å†™å…¥åˆ°äº†å†…å­˜ä¸­</li><li>C2 å»è¯»å– b çš„å€¼ï¼Œå‘ç°ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œå°±å»å†…å­˜ä¸­è¯»ï¼Œè¿™æ—¶å€™ print å‡ºæ¥ 2</li><li>C2 å»è¯»å– a çš„å€¼ï¼Œå‘ç°ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œå°±å»å†…å­˜ä¸­è¯»ï¼Œè¿™æ—¶å€™ print å‡ºæ¥ 0</li></ol><p>äº†è§£åˆ°è¿™é‡Œä¹‹åå¯èƒ½ä¼šæœ‰ä¸€äº›ç–‘é—®ï¼Œæ—¢ç„¶ä¼šå­˜åœ¨è¿™ç§ä¸ç¡®å®šæ€§ï¼Œæˆ‘ä»¬æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å»ä¿è¯ä¸€è‡´å‘¢ï¼ŸCPU çš„ä¸€è‡´æ€§å…·ä½“åˆæ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ<br>ä¿è¯ä¸€è‡´ä»ç¨‹åºä¸Šæ¥è®²æˆ‘ä»¬å¿…é¡»ä½¿ç”¨åŒæ­¥è¯­ä¹‰çš„å·¥å…·ç¡®ä¿ä¸€è‡´ï¼Œå¦‚æœæ·±å…¥åˆ°åº•å±‚çš„è¯å°±æ˜¯ä½¿ç”¨ cpu æä¾›çš„å†…å­˜å±éšœå‘½ä»¤ï¼Œä¿è¯æ‰€æœ‰å¯¹å†…å­˜çš„æ“ä½œéƒ½å¿…é¡»è¦â€œæ‰©æ•£â€åˆ° memory ä¹‹åæ‰èƒ½ç»§ç»­æ‰§è¡Œå…¶ä»–å¯¹ memory çš„æ“ä½œã€‚<br>CPU ä¸€è‡´æ€§çš„åŸç†å»ºè®®çœ‹ä¸€ä¸‹ MSI(E)åè®®çš„å®ç°ï¼Œæˆ‘åœ¨å‚è€ƒæ–‡çŒ®ä¸­åˆ—å‡ºçš„æœ€åä¸¤ç¯‡æ–‡ç« è®²çš„å·²ç»æ¯”è¾ƒé€šä¿—æ˜“æ‡‚äº†ï¼Œåœ¨æœ¬æ–‡å°±ä¸å†å™è¿°</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><strong>æ€»ç»“</strong></h2><ul><li>Go çš„å¹¶å‘ç¼–ç¨‹éå¸¸çš„ç®€å•ï¼Œåªéœ€è¦ä½¿ç”¨ go func å°±èƒ½å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹ï¼Œä½†æ˜¯å¹¶å‘ç¼–ç¨‹æœ¬èº«å°±æ˜¯å¾ˆå®¹æ˜“å‡ºç° bug çš„ï¼Œè€Œä¸”ç”±äºå¹¶å‘å¯¼è‡´çš„ bug è¿˜ä¸å¤ªå®¹æ˜“å‘ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å†™å¹¶å‘é€»è¾‘çš„æ—¶å€™ä¸€å®šè¦éå¸¸å°å¿ƒï¼Œç”¨å®˜æ–¹çš„ä¸€å¥è¯å°±æ˜¯<strong>ä½¿ç”¨æ˜¾ç¤ºçš„åŒæ­¥</strong></li><li>æœ¬æ–‡æ›´å¤šæ˜¯æŠ›ç –å¼•ç‰è¿™é‡Œé¢æåˆ°äº†å¾ˆå¤šæœ‰æ„æ€çš„åè¯éƒ½å€¼å¾—å¥½å¥½ç ”ç©¶</li></ul><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ul><li><a href="https://golang.org/ref/mem">https://golang.org/ref/mem</a> å®˜æ–¹æ–‡æ¡£ä¸€å®šè¦å¤šè¯»å‡ é</li><li><a href="https://go-zh.org/ref/mem">https://go-zh.org/ref/mem</a> å®˜æ–¹æ–‡æ¡£çš„ä¸­æ–‡ç¿»è¯‘ï¼Œè‹±æ–‡æ¯”è¾ƒåƒåŠ›å¯ä»¥çœ‹è¿™ç¯‡</li><li><a href="https://qcrao.com/2019/06/17/cch-says-memory-reorder/">https://qcrao.com/2019/06/17/cch-says-memory-reorder/</a></li><li><a href="https://cch123.github.io/ooo/">https://cch123.github.io/ooo/</a></li><li><a href="https://www.cs.utexas.edu/~bornholt/post/memory-models.html">https://www.cs.utexas.edu/~bornholt/post/memory-models.html</a></li><li><a href="https://baike.baidu.com/item/%E6%9C%BA%E5%99%A8%E5%AD%97%E9%95%BF">https://baike.baidu.com/item/%E6%9C%BA%E5%99%A8%E5%AD%97%E9%95%BF</a></li><li><a href="https://zh.wikipedia.org/wiki/%E5%AD%97_(%E8%AE%A1%E7%AE%97%E6%9C%BA">https://zh.wikipedia.org/wiki/%E5%AD%97_(%E8%AE%A1%E7%AE%97%E6%9C%BA)</a>&gt;)</li><li><a href="https://zhuanlan.zhihu.com/p/65245043">https://zhuanlan.zhihu.com/p/65245043</a></li><li><a href="https://zhuanlan.zhihu.com/p/94811032">https://zhuanlan.zhihu.com/p/94811032</a></li></ul><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week03: Go å¹¶å‘ç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¹¶å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goå¹¶å‘ç¼–ç¨‹(ä¸€) goroutine</title>
    <link href="/post/go-training-week3-goroutine.html"/>
    <url>/post/go-training-week3-goroutine.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><p>æ¥ä¸‹æ¥ä¼šä¸€å…±ä¼šæœ‰ 12 - 15 ç¯‡æ–‡ç« è®²è§£ Go å¹¶å‘ç¼–ç¨‹ï¼Œå¹¶å‘ç¼–ç¨‹æœ¬èº«æ˜¯ä¸€ä¸ªæŒºå¤§çš„è¯é¢˜ï¼Œåœ¨ç¬¬å››å‘¨çš„ä¸¤èŠ‚è¯¾ï¼Œæ¯›è€å¸ˆèŠ±äº†å°†è¿‘ 7 ä¸ªå°æ—¶è®²è§£è¿™äº›å†…å®¹ï¼Œæˆ‘ä¹Ÿç»“åˆè‡ªå·±çš„ä¸€äº›å¾®ä¸è¶³é“çš„ç»éªŒï¼Œå†åŠ ä¸Šä¸€äº›å¤§ç¥ä»¬çš„æ–‡ç« ï¼Œæ•´ç†å‡ºäº†è¿™ä¸€éƒ¨åˆ†çš„ç¬”è®°ã€‚<br>å½“ç„¶è¿™é‡Œæ›´å¤šçš„æ˜¯æŠ›ç –å¼•ç‰çš„ä½œç”¨ï¼Œæ›´å¤šçš„è¿˜æ˜¯æˆ‘ä»¬è‡ªå·±è¦æœ‰ç›¸å…³çš„æ„è¯†é¿å…è¸©å‘ï¼Œåœ¨å„ä¸ªå‘çš„è¾¹ç¼˜åå¤æ¨ªè·³ï¼Œå¯èƒ½æˆ‘ä»¬æœ‰ç¼˜ä¼šåœ¨åŒä¸€ä¸ªå‘ä¸­å‘ç°ï¼Œå’¦ï¼ŒåŸæ¥ä½ ä¹Ÿåœ¨è¿™é‡Œ ğŸ˜„</p><h2 id="è¯·å¯¹ä½ åˆ›å»ºçš„-goroutine-è´Ÿè´£"><a href="#è¯·å¯¹ä½ åˆ›å»ºçš„-goroutine-è´Ÿè´£" class="headerlink" title="è¯·å¯¹ä½ åˆ›å»ºçš„ goroutine è´Ÿè´£"></a>è¯·å¯¹ä½ åˆ›å»ºçš„ goroutine è´Ÿè´£</h2><h3 id="ä¸è¦åˆ›å»ºä¸€ä¸ªä½ ä¸çŸ¥é“ä½•æ—¶é€€å‡ºçš„-goroutine"><a href="#ä¸è¦åˆ›å»ºä¸€ä¸ªä½ ä¸çŸ¥é“ä½•æ—¶é€€å‡ºçš„-goroutine" class="headerlink" title="ä¸è¦åˆ›å»ºä¸€ä¸ªä½ ä¸çŸ¥é“ä½•æ—¶é€€å‡ºçš„ goroutine"></a>ä¸è¦åˆ›å»ºä¸€ä¸ªä½ ä¸çŸ¥é“ä½•æ—¶é€€å‡ºçš„ goroutine</h3><p>è¯·é˜…è¯»ä¸‹é¢è¿™æ®µä»£ç ï¼Œçœ‹çœ‹æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p><blockquote><p>ä¸ºä»€ä¹ˆå…ˆä»ä¸‹é¢è¿™æ®µä»£ç å‡ºå‘ï¼Œæ˜¯å› ä¸ºåœ¨ä¹‹å‰çš„ç»éªŒé‡Œé¢æˆ‘ä»¬å†™äº†å¤§é‡ç±»ä¼¼çš„ä»£ç ï¼Œä¹‹å‰æ²¡æœ‰æ„è¯†åˆ°è¿™ä¸ªé—®é¢˜ï¼Œå¹¶ä¸”è¿˜å› ä¸ºè¿™ç§ä»£ç å‡ºç°è¿‡çŸ­æš‚çš„äº‹æ•…</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Week03/blog/01/01.go</span><br><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;log&quot;</span><br><span class="hljs-string">&quot;net/http&quot;</span><br>_ <span class="hljs-string">&quot;net/http/pprof&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// è¿™é‡Œé¢æœ‰ä¸€äº›åˆå§‹åŒ–çš„æ“ä½œ</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>setup()<br><br><span class="hljs-comment">// ä¸»æœåŠ¡</span><br>server()<br><br><span class="hljs-comment">// for debug</span><br>pprof()<br><br><span class="hljs-keyword">select</span> &#123;&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">server</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>mux := http.NewServeMux()<br>mux.HandleFunc(<span class="hljs-string">&quot;/ping&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>w.Write([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;pong&quot;</span>))<br>&#125;)<br><br><span class="hljs-comment">// ä¸»æœåŠ¡</span><br><span class="hljs-keyword">if</span> err := http.ListenAndServe(<span class="hljs-string">&quot;:8080&quot;</span>, mux); err != <span class="hljs-literal">nil</span> &#123;<br>log.Panicf(<span class="hljs-string">&quot;http server err: %+v&quot;</span>, err)<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">pprof</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// è¾…åŠ©æœåŠ¡ï¼Œç›‘å¬äº†å…¶ä»–ç«¯å£ï¼Œè¿™é‡Œæ˜¯ pprof æœåŠ¡ï¼Œç”¨äº debug</span><br><span class="hljs-keyword">go</span> http.ListenAndServe(<span class="hljs-string">&quot;:8081&quot;</span>, <span class="hljs-literal">nil</span>)<br>&#125;<br><br></code></pre></td></tr></table></figure><p>çµé­‚æ‹·é—®æ¥äº†ï¼Œè¯·é—®ï¼š</p><ul><li>å¦‚æœ <code>server</code>  æ˜¯åœ¨å…¶ä»–åŒ…é‡Œé¢ï¼Œå¦‚æœæ²¡æœ‰ç‰¹æ®Šè¯´æ˜ï¼Œä½ çŸ¥é“è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥è°ƒç”¨ä¹ˆï¼Ÿ</li><li><code>main</code>  å‡½æ•°å½“ä¸­æœ€ååœ¨å“ªé‡Œç©ºè½¬å¹²ä»€ä¹ˆï¼Ÿä¼šä¸ä¼šå­˜åœ¨æµªè´¹ï¼Ÿ</li><li>å¦‚æœçº¿ä¸Šå‡ºç°äº‹æ•…ï¼Œdebug æœåŠ¡å·²ç»é€€å‡ºï¼Œä½ æƒ³è¦ debug è¿™æ—¶ä½ æ˜¯å¦å¾ˆèŒ«ç„¶ï¼Ÿ</li><li>å¦‚æœæŸä¸€å¤©æœåŠ¡çªç„¶é‡å¯ï¼Œä½ å´æ‰¾ä¸åˆ°äº‹æ•…æ—¥å¿—ï¼Œä½ æ˜¯å¦èƒ½æƒ³èµ·è¿™ä¸ª <code>8081</code>  ç«¯å£çš„æœåŠ¡ï¼Ÿ</li></ul><h4 id="è¯·å°†é€‰æ‹©æƒç•™ç»™å¯¹æ–¹ï¼Œä¸è¦å¸®åˆ«äººåšé€‰æ‹©"><a href="#è¯·å°†é€‰æ‹©æƒç•™ç»™å¯¹æ–¹ï¼Œä¸è¦å¸®åˆ«äººåšé€‰æ‹©" class="headerlink" title="è¯·å°†é€‰æ‹©æƒç•™ç»™å¯¹æ–¹ï¼Œä¸è¦å¸®åˆ«äººåšé€‰æ‹©"></a>è¯·å°†é€‰æ‹©æƒç•™ç»™å¯¹æ–¹ï¼Œä¸è¦å¸®åˆ«äººåšé€‰æ‹©</h4><p>è¯·æŠŠæ˜¯å¦å¹¶å‘çš„é€‰æ‹©æƒäº¤ç»™ä½ çš„è°ƒç”¨è€…ï¼Œè€Œä¸æ˜¯è‡ªå·±å°±ç›´æ¥æ‚„æ‚„çš„ç”¨ä¸Šäº† goroutine<br>ä¸‹é¢è¿™æ¬¡æ”¹åŠ¨å°†ä¸¤ä¸ªå‡½æ•°æ˜¯å¦å¹¶å‘æ“ä½œçš„é€‰æ‹©æƒç•™ç»™äº† main å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;log&quot;</span><br><span class="hljs-string">&quot;net/http&quot;</span><br>_ <span class="hljs-string">&quot;net/http/pprof&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// è¿™é‡Œé¢æœ‰ä¸€äº›åˆå§‹åŒ–çš„æ“ä½œ</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>setup()<br><br><span class="hljs-comment">// for debug</span><br><span class="hljs-keyword">go</span> pprof()<br><br><span class="hljs-comment">// ä¸»æœåŠ¡</span><br><span class="hljs-keyword">go</span> server()<br><br><span class="hljs-keyword">select</span> &#123;&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">server</span><span class="hljs-params">()</span></span> &#123;<br>mux := http.NewServeMux()<br>mux.HandleFunc(<span class="hljs-string">&quot;/ping&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>w.Write([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;pong&quot;</span>))<br>&#125;)<br><br><span class="hljs-comment">// ä¸»æœåŠ¡</span><br><span class="hljs-keyword">if</span> err := http.ListenAndServe(<span class="hljs-string">&quot;:8080&quot;</span>, mux); err != <span class="hljs-literal">nil</span> &#123;<br>log.Panicf(<span class="hljs-string">&quot;http server err: %+v&quot;</span>, err)<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">pprof</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// è¾…åŠ©æœåŠ¡ï¼Œç›‘å¬äº†å…¶ä»–ç«¯å£ï¼Œè¿™é‡Œæ˜¯ pprof æœåŠ¡ï¼Œç”¨äº debug</span><br>http.ListenAndServe(<span class="hljs-string">&quot;:8081&quot;</span>, <span class="hljs-literal">nil</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="è¯·ä¸è¦ä½œä¸ºä¸€ä¸ªæ—è§‚è€…"><a href="#è¯·ä¸è¦ä½œä¸ºä¸€ä¸ªæ—è§‚è€…" class="headerlink" title="è¯·ä¸è¦ä½œä¸ºä¸€ä¸ªæ—è§‚è€…"></a>è¯·ä¸è¦ä½œä¸ºä¸€ä¸ªæ—è§‚è€…</h4><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸è¦è®©ä¸»è¿›ç¨‹æˆä¸ºä¸€ä¸ªæ—è§‚è€…ï¼Œæ˜æ˜å¯ä»¥å¹²æ´»ï¼Œä½†æ˜¯æœ€åä½¿ç”¨äº†ä¸€ä¸ª <code>select</code>  åœ¨é‚£å„¿ç©ºè·‘<br>æ„Ÿè°¢ä¸Šä¸€æ­¥å°†æ˜¯å¦å¼‚æ­¥çš„é€‰æ‹©æƒäº¤ç»™äº†æˆ‘( <code>main</code> )ï¼Œåœ¨æ—è¾¹çœ‹ç€ä¹Ÿæ€ªå°´å°¬çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;log&quot;</span><br><span class="hljs-string">&quot;net/http&quot;</span><br>_ <span class="hljs-string">&quot;net/http/pprof&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// è¿™é‡Œé¢æœ‰ä¸€äº›åˆå§‹åŒ–çš„æ“ä½œ</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>setup()<br><br><span class="hljs-comment">// for debug</span><br><span class="hljs-keyword">go</span> pprof()<br><br><span class="hljs-comment">// ä¸»æœåŠ¡</span><br>server()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">server</span><span class="hljs-params">()</span></span> &#123;<br>mux := http.NewServeMux()<br>mux.HandleFunc(<span class="hljs-string">&quot;/ping&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>w.Write([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;pong&quot;</span>))<br>&#125;)<br><br><span class="hljs-comment">// ä¸»æœåŠ¡</span><br><span class="hljs-keyword">if</span> err := http.ListenAndServe(<span class="hljs-string">&quot;:8080&quot;</span>, mux); err != <span class="hljs-literal">nil</span> &#123;<br>log.Panicf(<span class="hljs-string">&quot;http server err: %+v&quot;</span>, err)<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">pprof</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// è¾…åŠ©æœåŠ¡ï¼Œç›‘å¬äº†å…¶ä»–ç«¯å£ï¼Œè¿™é‡Œæ˜¯ pprof æœåŠ¡ï¼Œç”¨äº debug</span><br>http.ListenAndServe(<span class="hljs-string">&quot;:8081&quot;</span>, <span class="hljs-literal">nil</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ä¸è¦åˆ›å»ºä¸€ä¸ªä½ æ°¸è¿œä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™ä¼šé€€å‡ºçš„-goroutine"><a href="#ä¸è¦åˆ›å»ºä¸€ä¸ªä½ æ°¸è¿œä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™ä¼šé€€å‡ºçš„-goroutine" class="headerlink" title="ä¸è¦åˆ›å»ºä¸€ä¸ªä½ æ°¸è¿œä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™ä¼šé€€å‡ºçš„ goroutine"></a>ä¸è¦åˆ›å»ºä¸€ä¸ªä½ æ°¸è¿œä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™ä¼šé€€å‡ºçš„ goroutine</h4><p>æˆ‘ä»¬å†åšä¸€äº›æ”¹é€ ï¼Œä½¿ç”¨ <code>channel</code>  æ¥æ§åˆ¶ï¼Œè§£é‡Šéƒ½å†™åœ¨ä»£ç æ³¨é‡Šé‡Œé¢äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;context&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;log&quot;</span><br><span class="hljs-string">&quot;net/http&quot;</span><br>_ <span class="hljs-string">&quot;net/http/pprof&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// è¿™é‡Œé¢æœ‰ä¸€äº›åˆå§‹åŒ–çš„æ“ä½œ</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>setup()<br><br><span class="hljs-comment">// ç”¨äºç›‘å¬æœåŠ¡é€€å‡º</span><br>done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> error, <span class="hljs-number">2</span>)<br><span class="hljs-comment">// ç”¨äºæ§åˆ¶æœåŠ¡é€€å‡ºï¼Œä¼ å…¥åŒä¸€ä¸ª stopï¼Œåšåˆ°åªè¦æœ‰ä¸€ä¸ªæœåŠ¡é€€å‡ºäº†é‚£ä¹ˆå¦å¤–ä¸€ä¸ªæœåŠ¡ä¹Ÿä¼šéšä¹‹é€€å‡º</span><br>stop := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, <span class="hljs-number">0</span>)<br><span class="hljs-comment">// for debug</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>done &lt;- pprof(stop)<br>&#125;()<br><br><span class="hljs-comment">// ä¸»æœåŠ¡</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>done &lt;- app(stop)<br>&#125;()<br><br><span class="hljs-comment">// stoped ç”¨äºåˆ¤æ–­å½“å‰ stop çš„çŠ¶æ€</span><br><span class="hljs-keyword">var</span> stoped <span class="hljs-keyword">bool</span><br><span class="hljs-comment">// è¿™é‡Œå¾ªç¯è¯»å– done è¿™ä¸ª channel</span><br><span class="hljs-comment">// åªè¦æœ‰ä¸€ä¸ªé€€å‡ºäº†ï¼Œæˆ‘ä»¬å°±å…³é—­ stop channel</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">cap</span>(done); i++ &#123;<br><span class="hljs-keyword">if</span> err := &lt;-done; err != <span class="hljs-literal">nil</span> &#123;<br>log.Printf(<span class="hljs-string">&quot;server exit err: %+v&quot;</span>, err)<br>&#125;<br><br><span class="hljs-keyword">if</span> !stoped &#123;<br>stoped = <span class="hljs-literal">true</span><br><span class="hljs-built_in">close</span>(stop)<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">app</span><span class="hljs-params">(stop &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;<br>mux := http.NewServeMux()<br>mux.HandleFunc(<span class="hljs-string">&quot;/ping&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>w.Write([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;pong&quot;</span>))<br>&#125;)<br><br><span class="hljs-keyword">return</span> server(mux, <span class="hljs-string">&quot;:8080&quot;</span>, stop)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">pprof</span><span class="hljs-params">(stop &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-comment">// æ³¨æ„è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†æ¨¡æ‹ŸæœåŠ¡æ„å¤–é€€å‡ºï¼Œç”¨äºéªŒè¯ä¸€ä¸ªæœåŠ¡é€€å‡ºï¼Œå…¶ä»–æœåŠ¡åŒæ—¶é€€å‡ºçš„åœºæ™¯</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>server(http.DefaultServeMux, <span class="hljs-string">&quot;:8081&quot;</span>, stop)<br>&#125;()<br><br>time.Sleep(<span class="hljs-number">5</span> * time.Second)<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;mock pprof exit&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// å¯åŠ¨ä¸€ä¸ªæœåŠ¡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">server</span><span class="hljs-params">(handler http.Handler, addr <span class="hljs-keyword">string</span>, stop &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;<br>s := http.Server&#123;<br>Handler: handler,<br>Addr:    addr,<br>&#125;<br><br><span class="hljs-comment">// è¿™ä¸ª goroutine æˆ‘ä»¬å¯ä»¥æ§åˆ¶é€€å‡ºï¼Œå› ä¸ºåªè¦ stop è¿™ä¸ª channel close æˆ–è€…æ˜¯å†™å…¥æ•°æ®ï¼Œè¿™é‡Œå°±ä¼šé€€å‡º</span><br><span class="hljs-comment">// åŒæ—¶å› ä¸ºè°ƒç”¨äº† s.Shutdown è°ƒç”¨ä¹‹åï¼Œhttp è¿™ä¸ªå‡½æ•°å¯åŠ¨çš„ http server ä¹Ÿä¼šä¼˜é›…é€€å‡º</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>&lt;-stop<br>log.Printf(<span class="hljs-string">&quot;server will exiting, addr: %s&quot;</span>, addr)<br>s.Shutdown(context.Background())<br>&#125;()<br><br><span class="hljs-keyword">return</span> s.ListenAndServe()<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿”å›ç»“æœï¼Œè¿™ä¸ªä»£ç å¯åŠ¨ 5s ä¹‹åå°±ä¼šé€€å‡ºç¨‹åº</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">â¯ <span class="hljs-keyword">go</span> run ./<span class="hljs-number">01</span>_goroutine/<span class="hljs-number">04</span><br><span class="hljs-number">2020</span>/<span class="hljs-number">12</span>/<span class="hljs-number">08</span> <span class="hljs-number">21</span>:<span class="hljs-number">49</span>:<span class="hljs-number">43</span> server exit err: mock pprof exit<br><span class="hljs-number">2020</span>/<span class="hljs-number">12</span>/<span class="hljs-number">08</span> <span class="hljs-number">21</span>:<span class="hljs-number">49</span>:<span class="hljs-number">43</span> server will exiting, addr: :<span class="hljs-number">8081</span><br><span class="hljs-number">2020</span>/<span class="hljs-number">12</span>/<span class="hljs-number">08</span> <span class="hljs-number">21</span>:<span class="hljs-number">49</span>:<span class="hljs-number">43</span> server will exiting, addr: :<span class="hljs-number">8080</span><br><span class="hljs-number">2020</span>/<span class="hljs-number">12</span>/<span class="hljs-number">08</span> <span class="hljs-number">21</span>:<span class="hljs-number">49</span>:<span class="hljs-number">43</span> server exit err: http: Server closed<br></code></pre></td></tr></table></figure><h4 id="æ€è€ƒé¢˜"><a href="#æ€è€ƒé¢˜" class="headerlink" title="æ€è€ƒé¢˜"></a>æ€è€ƒé¢˜</h4><p>è™½ç„¶æˆ‘ä»¬å·²ç»ç»è¿‡äº†ä¸‰è½®ä¼˜åŒ–ï¼Œä½†æ˜¯è¿™é‡Œè¿˜æ˜¯æœ‰ä¸€äº›éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œå¯ä»¥æ€è€ƒä¸€ä¸‹æ€ä¹ˆåš</p><ul><li>è™½ç„¶æˆ‘ä»¬è°ƒç”¨äº† <code>Shutdown</code>  æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬å…¶å®å¹¶æ²¡æœ‰å®ç°ä¼˜é›…é€€å‡ºï¼Œç›¸ä¿¡èªæ˜çš„ä½ å¯ä»¥å®Œæˆè¿™é¡¹å·¥ä½œã€‚å¯ä»¥å‚è€ƒä¸Šä¸€ç¯‡ç¬”è®°ï¼š<a href="https://lailin.xyz/post/go-training-03.html">Go é”™è¯¯å¤„ç†æœ€ä½³å®è·µ</a></li><li>åœ¨ <code>server</code>  æ–¹æ³•ä¸­æˆ‘ä»¬å¹¶æ²¡æœ‰å¤„ç† <code>panic</code>  çš„é€»è¾‘ï¼Œè¿™é‡Œéœ€è¦å¤„ç†ä¹ˆï¼Ÿå¦‚æœéœ€è¦é‚£è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</li></ul><h3 id="ä¸è¦åˆ›å»ºä¸€ä¸ªæ°¸è¿œéƒ½æ— æ³•é€€å‡ºçš„-goroutine-goroutine-æ³„æ¼"><a href="#ä¸è¦åˆ›å»ºä¸€ä¸ªæ°¸è¿œéƒ½æ— æ³•é€€å‡ºçš„-goroutine-goroutine-æ³„æ¼" class="headerlink" title="ä¸è¦åˆ›å»ºä¸€ä¸ªæ°¸è¿œéƒ½æ— æ³•é€€å‡ºçš„ goroutine [goroutine æ³„æ¼]"></a>ä¸è¦åˆ›å»ºä¸€ä¸ªæ°¸è¿œéƒ½æ— æ³•é€€å‡ºçš„ goroutine [goroutine æ³„æ¼]</h3><p>å†æ¥çœ‹ä¸‹é¢ä¸€ä¸ªä¾‹å­ï¼Œè¿™ä¹Ÿæ˜¯å¸¸å¸¸ä¼šç”¨åˆ°çš„æ“ä½œ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">leak</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">bool</span>, <span class="hljs-number">0</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;å¼‚æ­¥ä»»åŠ¡åšä¸€äº›æ“ä½œ&quot;</span>)<br>&lt;-ch<br>&#125;()<br><br>w.Write([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;will leak&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤ç”¨ä¸€ä¸‹ä¸Šé¢çš„ server ä»£ç ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šå†™å‡ºè¿™ç§ç±»ä¼¼çš„ä»£ç </p><ul><li>http è¯·æ±‚æ¥äº†ï¼Œæˆ‘ä»¬å¯åŠ¨ä¸€ä¸ª goroutine å»åšä¸€äº›è€—æ—¶ä¸€ç‚¹çš„å·¥ä½œ</li><li>ç„¶åè¿”å›äº†</li><li>ç„¶åä¹‹å‰åˆ›å»ºçš„é‚£ä¸ª <strong>goroutine é˜»å¡</strong>äº†</li><li>ç„¶åå°±æ³„æ¼äº†</li></ul><p>ç»å¤§éƒ¨åˆ†çš„ goroutine æ³„æ¼éƒ½æ˜¯å› ä¸º goroutine å½“ä¸­å› ä¸ºå„ç§åŸå› é˜»å¡äº†ï¼Œæˆ‘ä»¬åœ¨å¤–é¢ä¹Ÿæ²¡æœ‰æ§åˆ¶å®ƒé€€å‡ºçš„æ–¹å¼ï¼Œæ‰€ä»¥å°±æ³„æ¼äº†ï¼Œå…·ä½“å¯¼è‡´é˜»å¡çš„å¸¸è§åŸå› ä¼šåœ¨æ¥ä¸‹æ¥çš„ sync åŒ…ã€channel ä¸­è®²åˆ°ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šèµ˜è¿°äº†<br>æ¥ä¸‹æ¥æˆ‘ä»¬éªŒè¯ä¸€ä¸‹æ˜¯ä¸æ˜¯çœŸçš„æ³„æ¼äº†<br>å¯åŠ¨ä¹‹åæˆ‘ä»¬è®¿é—®ä¸€ä¸‹: <a href="http://localhost:8081/debug/pprof/goroutine?debug=1">http://localhost:8081/debug/pprof/goroutine?debug=1</a> æŸ¥çœ‹å½“å‰çš„ goroutine ä¸ªæ•°ä¸º 7</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">goroutine profile: total <span class="hljs-number">7</span><br><span class="hljs-number">2</span> @ <span class="hljs-number">0x43b945</span> <span class="hljs-number">0x40814f</span> <span class="hljs-number">0x407d8b</span> <span class="hljs-number">0x770998</span> <span class="hljs-number">0x470381</span><br>#<span class="hljs-number">0x770997</span>main.server.func1+<span class="hljs-number">0x37</span>/home/ll/project/Go<span class="hljs-number">-000</span>/Week03/blog/<span class="hljs-number">01</span>_goroutine/<span class="hljs-number">05</span>/<span class="hljs-number">05.</span><span class="hljs-keyword">go</span>:<span class="hljs-number">71</span><br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å†è®¿é—®å‡ æ¬¡ <a href="http://localhost:8080/leak">http://localhost:8080/leak</a> å¯ä»¥å‘ç° goroutine å¢åŠ åˆ°äº† 15 ä¸ªï¼Œè€Œä¸”ä¸€ç›´ä¸ä¼šä¸‹é™</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">goroutine profile: total <span class="hljs-number">15</span><br><span class="hljs-number">7</span> @ <span class="hljs-number">0x43b945</span> <span class="hljs-number">0x40814f</span> <span class="hljs-number">0x407d8b</span> <span class="hljs-number">0x770ad0</span> <span class="hljs-number">0x470381</span><br>#<span class="hljs-number">0x770acf</span>main.leak.func1+<span class="hljs-number">0x8f</span>/home/ll/project/Go<span class="hljs-number">-000</span>/Week03/blog/<span class="hljs-number">01</span>_goroutine/<span class="hljs-number">05</span>/<span class="hljs-number">05.</span><span class="hljs-keyword">go</span>:<span class="hljs-number">83</span><br></code></pre></td></tr></table></figure><h3 id="ç¡®ä¿åˆ›å»ºå‡ºçš„-goroutine-çš„å·¥ä½œå·²ç»å®Œæˆ"><a href="#ç¡®ä¿åˆ›å»ºå‡ºçš„-goroutine-çš„å·¥ä½œå·²ç»å®Œæˆ" class="headerlink" title="ç¡®ä¿åˆ›å»ºå‡ºçš„ goroutine çš„å·¥ä½œå·²ç»å®Œæˆ"></a>ç¡®ä¿åˆ›å»ºå‡ºçš„ goroutine çš„å·¥ä½œå·²ç»å®Œæˆ</h3><p>è¿™ä¸ªå…¶å®å°±æ˜¯ä¼˜é›…é€€å‡ºçš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯èƒ½å¯åŠ¨äº†å¾ˆå¤šçš„ goroutine å»å¤„ç†ä¸€äº›é—®é¢˜ï¼Œä½†æ˜¯æœåŠ¡é€€å‡ºçš„æ—¶å€™æˆ‘ä»¬å¹¶æ²¡æœ‰è€ƒè™‘åˆ°å°±ç›´æ¥é€€å‡ºäº†ã€‚ä¾‹å¦‚é€€å‡ºå‰æ—¥å¿—æ²¡æœ‰ flush åˆ°ç£ç›˜ï¼Œæˆ‘ä»¬çš„è¯·æ±‚è¿˜æ²¡å®Œå…¨å…³é—­ï¼Œå¼‚æ­¥ worker ä¸­è¿˜æœ‰ job åœ¨æ‰§è¡Œç­‰ç­‰ã€‚<br>æˆ‘ä»¬ä¹Ÿæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªåŸ‹ç‚¹æœåŠ¡ï¼Œæ¯æ¬¡è¯·æ±‚æˆ‘ä»¬éƒ½ä¼šä¸ŠæŠ¥ä¸€äº›ä¿¡æ¯åˆ°åŸ‹ç‚¹æœåŠ¡ä¸Š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Reporter åŸ‹ç‚¹æœåŠ¡ä¸ŠæŠ¥</span><br><span class="hljs-keyword">type</span> Reporter <span class="hljs-keyword">struct</span> &#123;<br>&#125;<br><br><span class="hljs-keyword">var</span> reporter Reporter<br><br><span class="hljs-comment">// æ¨¡æ‹Ÿè€—æ—¶</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r Reporter)</span> <span class="hljs-title">report</span><span class="hljs-params">(data <span class="hljs-keyword">string</span>)</span></span> &#123;<br>time.Sleep(time.Second)<br>fmt.Printf(<span class="hljs-string">&quot;report: %s\n&quot;</span>, data)<br>&#125;<br><br>mux.HandleFunc(<span class="hljs-string">&quot;/ping&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>    <span class="hljs-comment">// åœ¨è¯·æ±‚ä¸­å¼‚æ­¥è°ƒç”¨</span><br>    <span class="hljs-keyword">go</span> reporter.report(<span class="hljs-string">&quot;ping pong&quot;</span>)<br>    fmt.Println(<span class="hljs-string">&quot;ping&quot;</span>)<br>    w.Write([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;pong&quot;</span>))<br>&#125;)<br></code></pre></td></tr></table></figure><p>æˆ‘åœ¨å‘é€äº†ä¸€æ¬¡è¯·æ±‚ä¹‹åç›´æ¥é€€å‡ºäº†ï¼Œå¼‚æ­¥ä¸ŠæŠ¥çš„é€»è¾‘æ ¹æœ¬æ²¡æ‰§è¡Œä¸Š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">â¯ <span class="hljs-keyword">go</span> run ./<span class="hljs-number">01</span>_goroutine/<span class="hljs-number">06</span><br>ping<br>^Csignal: interrupt<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæœ‰ä¸¤ç§æ”¹æ³•ï¼Œä¸€ç§æ˜¯ç»™ reporter åŠ ä¸Š shutdown æ–¹æ³•ï¼Œç±»ä¼¼ http çš„ shutdownï¼Œç­‰å¾…æ‰€æœ‰çš„å¼‚æ­¥ä¸ŠæŠ¥å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å†é€€å‡ºï¼Œå¦å¤–ä¸€ç§æ˜¯æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ ä¸€äº› worker æ¥æ‰§è¡Œï¼Œåœ¨å½“ç„¶è¿™ä¸ª worker ä¹Ÿè¦å®ç°ç±»ä¼¼ shutdown çš„æ–¹æ³•ã€‚ä¸€èˆ¬æ¨èåä¸€ç§ï¼Œå› ä¸ºè¿™æ ·å¯ä»¥é¿å…è¯·æ±‚é‡æ¯”è¾ƒå¤§æ—¶ï¼Œåˆ›å»ºå¤§é‡ goroutineï¼Œå½“ç„¶å¦‚æœè¯·æ±‚é‡æ¯”è¾ƒå°ï¼Œä¸ä¼šå¾ˆå¤§ï¼Œç”¨ç¬¬ä¸€ç§ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚<br>æˆ‘ä»¬ç»™ä¸€ä¸ªç¬¬äºŒç§çš„ç®€å•å®ç°ï¼Œç¬¬ä¸€ç§å¯ä»¥å‚è€ƒ <a href="https://www.ardanlabs.com/blog/2019/04/concurrency-trap-2-incomplete-work.html">https://www.ardanlabs.com/blog/2019/04/concurrency-trap-2-incomplete-work.html</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Reporter åŸ‹ç‚¹æœåŠ¡ä¸ŠæŠ¥</span><br><span class="hljs-keyword">type</span> Reporter <span class="hljs-keyword">struct</span> &#123;<br>worker   <span class="hljs-keyword">int</span><br>messages <span class="hljs-keyword">chan</span> <span class="hljs-keyword">string</span><br>wg       sync.WaitGroup<br>closed   <span class="hljs-keyword">bool</span><br>&#125;<br><br><span class="hljs-comment">// NewReporter NewReporter</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewReporter</span><span class="hljs-params">(worker, buffer <span class="hljs-keyword">int</span>)</span> *<span class="hljs-title">Reporter</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;Reporter&#123;worker: worker, messages: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">string</span>, buffer)&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Reporter)</span> <span class="hljs-title">run</span><span class="hljs-params">(stop &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span></span> &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>&lt;-stop<br>r.shutdown()<br>&#125;()<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; r.worker; i++ &#123;<br>r.wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> msg := <span class="hljs-keyword">range</span> r.messages &#123;<br>time.Sleep(<span class="hljs-number">5</span> * time.Second)<br>fmt.Printf(<span class="hljs-string">&quot;report: %s\n&quot;</span>, msg)<br>&#125;<br>r.wg.Done()<br>&#125;()<br>&#125;<br>r.wg.Wait()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Reporter)</span> <span class="hljs-title">shutdown</span><span class="hljs-params">()</span></span> &#123;<br>r.closed = <span class="hljs-literal">true</span><br><span class="hljs-comment">// æ³¨æ„ï¼Œè¿™ä¸ªä¸€å®šè¦åœ¨ä¸»æœåŠ¡ç»“æŸä¹‹åå†æ‰§è¡Œï¼Œé¿å…å…³é—­ channel è¿˜æœ‰å…¶ä»–åœ°æ–¹åœ¨å•Šå†™å…¥</span><br><span class="hljs-built_in">close</span>(r.messages)<br>&#125;<br><br><span class="hljs-comment">// æ¨¡æ‹Ÿè€—æ—¶</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Reporter)</span> <span class="hljs-title">report</span><span class="hljs-params">(data <span class="hljs-keyword">string</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> r.closed &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>r.messages &lt;- data<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨ main å‡½æ•°ä¸­æˆ‘ä»¬åŠ ä¸Š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>    reporter.run(stop)<br>    done &lt;- <span class="hljs-literal">nil</span><br>&#125;()<br></code></pre></td></tr></table></figure><div style="background: #FFFBE6;padding:10px;border: 1px solid #C3C3C3;border-radius:5px;margin-bottom:5px;">ç•™ä¸€ä¸ªæ€è€ƒé¢˜ï¼šæˆ‘ä»¬åœ¨ reporter çš„å®ç°å¯èƒ½ä¼šå¯¼è‡´ panicï¼Œä½ æ˜¯å¦å‘ç°äº†å‘¢ï¼Ÿå¦‚ä½•ä¿®æ”¹å¯ä»¥é¿å…è¿™ç§æƒ…å†µï¼Ÿ<br>æ„Ÿè°¢è¯„è®ºåŒº @hddxds çš„æŒ‡å‡ºï¼Œæˆ‘è¿™é‡Œç»™å‡ºä¸€ä¸ªå®ç°ä¾‹å­: <a href="https://github.com/mohuishou/Go-000/blob/main/Week03/blog/01_goroutine/07/reporter.go">ç‚¹å‡»æŸ¥çœ‹</a>ï¼Œå¯ä»¥çœ‹çœ‹æ˜¯å¦å’Œä½ æƒ³çš„ä¸€æ ·ï¼Ÿ<br>å¦‚æœä½ å¯¹ä¸ºä»€ä¹ˆä¼šå‡ºç° panic æˆ–è€…ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå®ç°æ„Ÿåˆ°å›°æƒ‘å¯ä»¥æŸ¥çœ‹åé¢çš„è¿™ç¯‡æ–‡ç«  <a href="https://lailin.xyz/post/go-training-week3-channel.html">Goå¹¶å‘ç¼–ç¨‹(å) æ·±å…¥ç†è§£ Channel</a></div><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ€»ç»“ä¸€ä¸‹è¿™ä¸€éƒ¨åˆ†è®²åˆ°çš„å‡ ä¸ªè¦ç‚¹ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬</p><ol><li><strong>è¯·å°†æ˜¯å¦å¼‚æ­¥è°ƒç”¨çš„é€‰æ‹©æƒäº¤ç»™è°ƒç”¨è€…</strong>ï¼Œä¸ç„¶å¾ˆæœ‰å¯èƒ½å¤§å®¶å¹¶ä¸çŸ¥é“ä½ åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ä½¿ç”¨äº† goroutine</li><li>å¦‚æœä½ è¦å¯åŠ¨ä¸€ä¸ª goroutine è¯·å¯¹å®ƒè´Ÿè´£<ol><li><strong>æ°¸è¿œä¸è¦å¯åŠ¨ä¸€ä¸ªä½ æ— æ³•æ§åˆ¶å®ƒé€€å‡ºï¼Œæˆ–è€…ä½ æ— æ³•çŸ¥é“å®ƒä½•æ—¶æ¨å‡ºçš„ goroutine</strong></li><li>è¿˜æœ‰ä¸Šä¸€ç¯‡æåˆ°çš„ï¼Œå¯åŠ¨ goroutine æ—¶è¯·åŠ ä¸Š panic recovery æœºåˆ¶ï¼Œé¿å…æœåŠ¡ç›´æ¥ä¸å¯ç”¨</li><li>é€ æˆ goroutine æ³„æ¼çš„ä¸»è¦åŸå› å°±æ˜¯ goroutine ä¸­é€ æˆäº†é˜»å¡ï¼Œå¹¶ä¸”æ²¡æœ‰å¤–éƒ¨æ‰‹æ®µæ§åˆ¶å®ƒé€€å‡º</li></ol></li><li><strong>å°½é‡é¿å…åœ¨è¯·æ±‚ä¸­ç›´æ¥å¯åŠ¨ goroutine æ¥å¤„ç†é—®é¢˜</strong>ï¼Œè€Œåº”è¯¥é€šè¿‡å¯åŠ¨ worker æ¥è¿›è¡Œæ¶ˆè´¹ï¼Œè¿™æ ·å¯ä»¥é¿å…ç”±äºè¯·æ±‚é‡è¿‡å¤§ï¼Œè€Œå¯¼è‡´å¤§é‡åˆ›å»º goroutine ä»è€Œå¯¼è‡´ oomï¼Œå½“ç„¶å¦‚æœè¯·æ±‚é‡æœ¬èº«éå¸¸å°ï¼Œé‚£å½“æˆ‘æ²¡è¯´</li></ol><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ul><li><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> è¿™ç¯‡ dave åœ¨ Qcon China ä¸Šçš„æ–‡ç« å€¼å¾—å¥½å¥½æ‹œè¯»å‡ é</li><li><a href="https://www.ardanlabs.com/blog/2018/11/goroutine-leaks-the-forgotten-sender.html">https://www.ardanlabs.com/blog/2018/11/goroutine-leaks-the-forgotten-sender.html</a></li><li><a href="https://www.ardanlabs.com/blog/2019/04/concurrency-trap-2-incomplete-work.html">https://www.ardanlabs.com/blog/2019/04/concurrency-trap-2-incomplete-work.html</a></li><li><a href="https://www.ardanlabs.com/blog/2014/01/concurrency-goroutines-and-gomaxprocs.html">https://www.ardanlabs.com/blog/2014/01/concurrency-goroutines-and-gomaxprocs.html</a></li></ul><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week03: Go å¹¶å‘ç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¹¶å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goé”™è¯¯å¤„ç†æœ€ä½³å®è·µ</title>
    <link href="/post/go-training-03.html"/>
    <url>/post/go-training-03.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><p>å¤ªé•¿ä¸çœ‹ç³»åˆ—ï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹åœ¨ go ä¸­ å¦‚ä½•å¤„ç† errorï¼Œå…·ä½“çš„åŸå› æˆ‘ä»¬ä¼šåœ¨ä¸‹é¢çš„å†…å®¹ä¸­è¿›è¡Œè¯¦ç»†çš„è§£é‡Š</p><h3 id="panic"><a href="#panic" class="headerlink" title="panic"></a>panic</h3><ol><li>åœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™ï¼Œå¦‚æœæœ‰å¼ºä¾èµ–çš„æœåŠ¡å‡ºç°æ•…éšœæ—¶ <code>panic</code>  é€€å‡º</li><li>åœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°æœ‰é…ç½®æ˜æ˜¾ä¸ç¬¦åˆè¦æ±‚ï¼Œ å¯ä»¥ <code>panic</code>  é€€å‡ºï¼ˆé˜²å¾¡ç¼–ç¨‹ï¼‰</li><li>å…¶ä»–æƒ…å†µä¸‹åªè¦ä¸æ˜¯ä¸å¯æ¢å¤çš„ç¨‹åºé”™è¯¯ï¼Œéƒ½ä¸åº”è¯¥ç›´æ¥ <code>panic</code>  åº”è¯¥è¿”å› <code>error</code></li><li>åœ¨ç¨‹åºå…¥å£å¤„ï¼Œä¾‹å¦‚ <code>gin</code>  ä¸­é—´ä»¶éœ€è¦ä½¿ç”¨ <code>recover</code>  é¢„é˜² <code>panic</code>  ç¨‹åºé€€å‡º</li><li>åœ¨ç¨‹åºä¸­æˆ‘ä»¬åº”è¯¥é¿å…ä½¿ç”¨é‡ç”Ÿçš„ <code>goroutine</code><ol><li>å¦‚æœæ˜¯åœ¨è¯·æ±‚ä¸­éœ€è¦æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œåº”è¯¥ä½¿ç”¨å¼‚æ­¥ <code>worker</code> ï¼Œæ¶ˆæ¯é€šçŸ¥çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œé¿å…è¯·æ±‚é‡å¤§æ—¶å¤§é‡ <code>goroutine</code> åˆ›å»º</li><li>å¦‚æœéœ€è¦ä½¿ç”¨ <code>goroutine</code> æ—¶ï¼Œåº”è¯¥ä½¿ç”¨åŒä¸€çš„ <code>Go</code>  å‡½æ•°è¿›è¡Œåˆ›å»ºï¼Œè¿™ä¸ªå‡½æ•°ä¸­ä¼šè¿›è¡Œ <code>recover</code> ï¼Œé¿å…å› ä¸ºé‡ç”Ÿ <code>goroutine</code> panic å¯¼è‡´ä¸»è¿›ç¨‹é€€å‡º</li></ol></li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Go</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>()</span>)</span>&#123;<br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span>&#123;<br>            <span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span> &#123;<br>                log.Printf(<span class="hljs-string">&quot;panic: %+v&quot;</span>, err)<br>            &#125;<br>        &#125;()<br><br>        f()<br>    &#125;()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="error"><a href="#error" class="headerlink" title="error"></a>error</h3><ol><li>æˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ <code>github.com/pkg/errors</code>  å¤„ç†åº”ç”¨é”™è¯¯ï¼Œ<strong>æ³¨æ„åœ¨å…¬å…±åº“å½“ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¸ä½¿ç”¨è¿™ä¸ª</strong></li><li><code>error</code>  åº”è¯¥æ˜¯å‡½æ•°çš„æœ€åä¸€ä¸ªè¿”å›å€¼ï¼Œå½“ <code>error</code>  ä¸ä¸º <code>nil</code>  æ—¶ï¼Œå‡½æ•°çš„å…¶ä»–è¿”å›å€¼æ˜¯ä¸å¯ç”¨çš„çŠ¶æ€ï¼Œä¸åº”è¯¥å¯¹å…¶ä»–è¿”å›å€¼åšä»»ä½•æœŸå¾…<ol><li><code>func f() (io.Reader, *S1, error)</code>  åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸çŸ¥é“ <code>io.Reader</code>  ä¸­æ˜¯å¦æœ‰æ•°æ®ï¼Œå¯èƒ½æœ‰ï¼Œä¹Ÿæœ‰å¯èƒ½æœ‰ä¸€éƒ¨åˆ†</li></ol></li><li>é”™è¯¯å¤„ç†çš„æ—¶å€™åº”è¯¥å…ˆåˆ¤æ–­é”™è¯¯ï¼Œ <code>if err != nil</code>  å‡ºç°é”™è¯¯åŠæ—¶è¿”å›ï¼Œä½¿ä»£ç æ˜¯ä¸€æ¡æµç•…çš„ç›´çº¿ï¼Œé¿å…è¿‡å¤šçš„åµŒå¥—.</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// good case</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br>    a, err := A()<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> err<br>    &#125;<br><br>    <span class="hljs-comment">// ... å…¶ä»–é€»è¾‘</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// bad case</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br>    a, err := A()<br>    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-comment">// å…¶ä»–é€»è¾‘</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> err<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>åœ¨<strong>åº”ç”¨ç¨‹åº</strong>ä¸­å‡ºç°é”™è¯¯æ—¶ï¼Œä½¿ç”¨ <code>errors.New</code>  æˆ–è€… <code>errors.Errorf</code>  è¿”å›é”™è¯¯</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *usecese)</span> <span class="hljs-title">usecase1</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br>    money := u.repo.getMoney(uid)<br>    <span class="hljs-keyword">if</span> money &lt; <span class="hljs-number">10</span> &#123;<br>        errors.Errorf(<span class="hljs-string">&quot;ç”¨æˆ·ä½™é¢ä¸è¶³, uid: %d, money: %d&quot;</span>, uid, money)<br>    &#125;<br>    <span class="hljs-comment">// å…¶ä»–é€»è¾‘</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="5"><li>å¦‚æœæ˜¯è°ƒç”¨<strong>åº”ç”¨ç¨‹åºçš„</strong>å…¶ä»–å‡½æ•°å‡ºç°é”™è¯¯ï¼Œè¯·ç›´æ¥è¿”å›ï¼Œå¦‚æœéœ€è¦æºå¸¦ä¿¡æ¯ï¼Œè¯·ä½¿ç”¨ <code>errors.WithMessage</code></li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *usecese)</span> <span class="hljs-title">usecase2</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br>    name, err := u.repo.getUserName(uid)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> errors.WithMessage(err, <span class="hljs-string">&quot;å…¶ä»–é™„åŠ ä¿¡æ¯&quot;</span>)<br>    &#125;<br><br>    <span class="hljs-comment">// å…¶ä»–é€»è¾‘</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="6"><li>å¦‚æœæ˜¯è°ƒç”¨å…¶ä»–åº“ï¼ˆæ ‡å‡†åº“ã€ä¼ä¸šå…¬å…±åº“ã€å¼€æºç¬¬ä¸‰æ–¹åº“ç­‰ï¼‰è·å–åˆ°é”™è¯¯æ—¶ï¼Œè¯·ä½¿ç”¨ <code>errors.Wrap</code>  æ·»åŠ å †æ ˆä¿¡æ¯<ol><li>åˆ‡è®°ï¼Œä¸è¦æ¯ä¸ªåœ°æ–¹éƒ½æ˜¯ç”¨ <code>errors.Wrap</code>  åªéœ€è¦åœ¨é”™è¯¯ç¬¬ä¸€æ¬¡å‡ºç°æ—¶è¿›è¡Œ <code>errors.Wrap</code>  å³å¯</li><li>æ ¹æ®åœºæ™¯è¿›è¡Œåˆ¤æ–­æ˜¯å¦éœ€è¦å°†å…¶ä»–åº“çš„åŸå§‹é”™è¯¯åæ‰ï¼Œä¾‹å¦‚å¯ä»¥æŠŠ <code>repository</code>  å±‚çš„æ•°æ®åº“ç›¸å…³é”™è¯¯åæ‰ï¼Œè¿”å›ä¸šåŠ¡é”™è¯¯ç ï¼Œé¿å…åç»­æˆ‘ä»¬åˆ†å‰²å¾®æœåŠ¡æˆ–è€…æ›´æ¢ <code>ORM</code>  åº“æ—¶éœ€è¦å»ä¿®æ”¹ä¸Šå±‚ä»£ç </li><li>æ³¨æ„æˆ‘ä»¬åœ¨åŸºç¡€åº“ï¼Œè¢«å¤§é‡å¼•å…¥çš„ç¬¬ä¸‰æ–¹åº“ç¼–å†™æ—¶ä¸€èˆ¬ä¸ä½¿ç”¨ <code>errors.Wrap</code>  é¿å…å †æ ˆä¿¡æ¯é‡å¤</li></ol></li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br>    err := json.Unmashal(&amp;a, data)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> errors.Wrap(err, <span class="hljs-string">&quot;å…¶ä»–é™„åŠ ä¿¡æ¯&quot;</span>)<br>    &#125;<br><br>    <span class="hljs-comment">// å…¶ä»–é€»è¾‘</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="7"><li><strong>ç¦æ­¢</strong>æ¯ä¸ªå‡ºé”™çš„åœ°æ–¹éƒ½æ‰“æ—¥å¿—ï¼Œ<strong>åªéœ€è¦</strong>åœ¨è¿›ç¨‹çš„æœ€å¼€å§‹çš„åœ°æ–¹ä½¿ç”¨ <code>%+v</code>  è¿›è¡Œç»Ÿä¸€æ‰“å°ï¼Œä¾‹å¦‚ http/rpc æœåŠ¡çš„ä¸­é—´ä»¶</li><li>é”™è¯¯åˆ¤æ–­ä½¿ç”¨ <code>errors.Is</code>  è¿›è¡Œæ¯”è¾ƒ</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br>    err := A()<br>    <span class="hljs-keyword">if</span> errors.Is(err, io.EOF)&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br><br>    <span class="hljs-comment">// å…¶ä»–é€»è¾‘</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="9"><li>é”™è¯¯ç±»å‹åˆ¤æ–­ï¼Œä½¿ç”¨ <code>errors.As</code>  è¿›è¡Œèµ‹å€¼</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br>    err := A()<br><br>    <span class="hljs-keyword">var</span> errA errorA<br>    <span class="hljs-keyword">if</span> errors.As(err, &amp;errA)&#123;<br>    <span class="hljs-comment">// ...</span><br>    &#125;<br><br>    <span class="hljs-comment">// å…¶ä»–é€»è¾‘</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="10"><li>å¦‚ä½•åˆ¤å®šé”™è¯¯çš„ä¿¡æ¯æ˜¯å¦è¶³å¤Ÿï¼Œæƒ³ä¸€æƒ³å½“ä½ çš„ä»£ç å‡ºç°é—®é¢˜éœ€è¦æ’æŸ¥çš„æ—¶å€™ä½ çš„é”™è¯¯ä¿¡æ¯æ˜¯å¦å¯ä»¥å¸®åŠ©ä½ å¿«é€Ÿçš„å®šä½é—®é¢˜ï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨è¯·æ±‚ä¸­ä¸€èˆ¬ä¼šè¾“å‡ºå‚æ•°ä¿¡æ¯ï¼Œç”¨äºè¾…åŠ©åˆ¤æ–­é”™è¯¯</li><li>å¯¹äºä¸šåŠ¡é”™è¯¯ï¼Œæ¨èåœ¨ä¸€ä¸ªç»Ÿä¸€çš„åœ°æ–¹åˆ›å»ºä¸€ä¸ªé”™è¯¯å­—å…¸ï¼Œé”™è¯¯å­—å…¸é‡Œé¢åº”è¯¥åŒ…å«é”™è¯¯çš„ codeï¼Œå¹¶ä¸”åœ¨æ—¥å¿—ä¸­ä½œä¸ºç‹¬ç«‹å­—æ®µæ‰“å°ï¼Œæ–¹ä¾¿åšä¸šåŠ¡å‘Šè­¦çš„åˆ¤æ–­ï¼Œé”™è¯¯å¿…é¡»æœ‰æ¸…æ™°çš„é”™è¯¯æ–‡æ¡£</li><li>ä¸éœ€è¦è¿”å›ï¼Œè¢«å¿½ç•¥çš„é”™è¯¯<strong>å¿…é¡»</strong>è¾“å‡ºæ—¥å¿—ä¿¡æ¯</li><li>åŒä¸€ä¸ªåœ°æ–¹ä¸åœçš„æŠ¥é”™ï¼Œæœ€å¥½ä¸è¦ä¸åœè¾“å‡ºé”™è¯¯æ—¥å¿—ï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´è¢«å¤§é‡çš„é”™è¯¯æ—¥å¿—ä¿¡æ¯æ·¹æ²¡ï¼Œæ— æ³•æ’æŸ¥é—®é¢˜ï¼Œæ¯”è¾ƒå¥½çš„åšæ³•æ˜¯æ‰“å°ä¸€æ¬¡é”™è¯¯è¯¦æƒ…ï¼Œç„¶åæ‰“å°å‡ºé”™è¯¯å‡ºç°çš„æ¬¡æ•°</li><li>å¯¹åŒä¸€ä¸ªç±»å‹çš„é”™è¯¯ï¼Œé‡‡ç”¨ç›¸åŒçš„æ¨¡å¼ï¼Œä¾‹å¦‚å‚æ•°é”™è¯¯ï¼Œä¸è¦æœ‰çš„è¿”å› 404 æœ‰çš„è¿”å› 200</li><li>å¤„ç†é”™è¯¯çš„æ—¶å€™ï¼Œéœ€è¦å¤„ç†å·²åˆ†é…çš„èµ„æºï¼Œä½¿ç”¨ <code>defer</code>  è¿›è¡Œæ¸…ç†ï¼Œä¾‹å¦‚æ–‡ä»¶å¥æŸ„</li></ol><h2 id="panic-or-error"><a href="#panic-or-error" class="headerlink" title="panic or error?"></a>panic or error?</h2><ol><li>åœ¨ Go ä¸­ panic ä¼šå¯¼è‡´ç¨‹åºç›´æ¥é€€å‡ºï¼Œæ˜¯ä¸€ä¸ªè‡´å‘½çš„é”™è¯¯ï¼Œå¦‚æœä½¿ç”¨ <code>panic</code>  <code>recover</code>  è¿›è¡Œå¤„ç†çš„è¯ï¼Œä¼šå­˜åœ¨å¾ˆå¤šé—®é¢˜<ol><li>æ€§èƒ½é—®é¢˜ï¼Œé¢‘ç¹ panic recover æ€§èƒ½ä¸å¥½</li><li>å®¹æ˜“å¯¼è‡´ç¨‹åºå¼‚å¸¸é€€å‡ºï¼Œåªè¦æœ‰ä¸€ä¸ªåœ°æ–¹æ²¡æœ‰å¤„ç†åˆ°å°±ä¼šå¯¼è‡´ç¨‹åºè¿›ç¨‹æ•´ä¸ªé€€å‡º</li><li>ä¸å¯æ§ï¼Œä¸€æ—¦ panic å°±å°†å¤„ç†é€»è¾‘ç§»äº¤ç»™äº†å¤–éƒ¨ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½é¢„è®¾å¤–éƒ¨åŒ…ä¸€å®šä¼šè¿›è¡Œå¤„ç†</li></ol></li><li>ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ panic å‘¢ï¼Ÿ<ol><li>å¯¹äºçœŸæ­£æ„å¤–çš„æƒ…å†µï¼Œé‚£äº›è¡¨ç¤ºä¸å¯æ¢å¤çš„ç¨‹åºé”™è¯¯ï¼Œä¾‹å¦‚ç´¢å¼•è¶Šç•Œã€ä¸å¯æ¢å¤çš„ç¯å¢ƒé—®é¢˜ã€æ ˆæº¢å‡ºï¼Œæˆ‘ä»¬æ‰ä½¿ç”¨ panic</li></ol></li><li>ä½¿ç”¨ error å¤„ç†æœ‰å“ªäº›å¥½å¤„ï¼Ÿ<ol><li>ç®€å•ã€‚</li><li>è€ƒè™‘å¤±è´¥ï¼Œè€Œä¸æ˜¯æˆåŠŸ(Plan for failure, not success)ã€‚</li><li>æ²¡æœ‰éšè—çš„æ§åˆ¶æµã€‚</li><li>å®Œå…¨äº¤ç»™ä½ æ¥æ§åˆ¶ errorã€‚</li><li>Error are valuesã€‚</li></ol></li></ol><h2 id="ä¸ºä»€ä¹ˆæ ‡å‡†åº“ä¸­-errors-New-ä¼šè¿”å›ä¸€ä¸ªæŒ‡é’ˆ"><a href="#ä¸ºä»€ä¹ˆæ ‡å‡†åº“ä¸­-errors-New-ä¼šè¿”å›ä¸€ä¸ªæŒ‡é’ˆ" class="headerlink" title="ä¸ºä»€ä¹ˆæ ‡å‡†åº“ä¸­ errors.New ä¼šè¿”å›ä¸€ä¸ªæŒ‡é’ˆ"></a>ä¸ºä»€ä¹ˆæ ‡å‡†åº“ä¸­ errors.New ä¼šè¿”å›ä¸€ä¸ªæŒ‡é’ˆ</h2><p>ç¿»çœ‹æ ‡å‡†åº“çš„æºä»£ç æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ <code>errors</code>  åº“ä¸­çš„ <code>errorString</code>  ç»“æ„ä½“å®ç°äº† <code>error</code>  æ¥å£ï¼Œä¸ºä»€ä¹ˆåœ¨ <code>New</code>  ä¸€ä¸ª error çš„æ—¶å€™ä¼šè¿”å›ä¸€ä¸ªç»“æ„ä½“çš„æŒ‡é’ˆå‘¢ï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// New returns an error that formats as the given text.</span><br><span class="hljs-comment">// Each call to New returns a distinct error value even if the text is identical.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">(text <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;errorString&#123;text&#125;<br>&#125;<br><br><span class="hljs-comment">// errorString is a trivial implementation of error.</span><br><span class="hljs-keyword">type</span> errorString <span class="hljs-keyword">struct</span> &#123;<br>s <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *errorString)</span> <span class="hljs-title">Error</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">return</span> e.s<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬åŒæ ·åˆ›å»ºäº† errorString çš„ç»“æ„ä½“ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„å’Œæ ‡å‡†åº“ä¸­çš„å”¯ä¸€ä¸åŒå°±æ˜¯ï¼Œè‡ªå»ºçš„è¿™ä¸ªè¿”å›çš„æ˜¯å€¼ï¼Œè€Œä¸æ˜¯æŒ‡é’ˆã€‚<br>åœ¨ <code>main</code>  å‡½æ•°çš„å¯¹æ¯”ä¸­æˆ‘ä»¬å°±å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ <code>errorString</code>  åœ¨å¯¹æ¯”çš„æ—¶å€™åªè¦å¯¹åº”çš„å­—ç¬¦ä¸²ç›¸åŒå°±ä¼šè¿”å› trueï¼Œä½†æ˜¯æ ‡å‡†åº“çš„åŒ…ä¸ä¼šã€‚<br>è¿™æ˜¯å› ä¸ºï¼Œåœ¨å¯¹æ¯”ä¸¤ä¸ª struct æ˜¯å¦ç›¸åŒçš„æ—¶å€™ï¼Œä¼šå»å¯¹æ¯”ï¼Œè¿™ä¸¤ä¸ª struct é‡Œé¢çš„å„ä¸ªå­—æ®µæ˜¯å¦æ˜¯ç›¸åŒçš„ï¼Œå¦‚æœç›¸åŒå°±è¿”å› trueï¼Œä½†æ˜¯å¯¹æ¯”æŒ‡é’ˆçš„æ—¶å€™ä¼šå»åˆ¤æ–­ä¸¤ä¸ªæŒ‡é’ˆçš„åœ°å€æ˜¯å¦ä¸€è‡´ã€‚<br><strong>å¦‚æœå­—ç¬¦ä¸²ç›¸ç­‰å°±è¿”å› true ä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</strong><br>å¦‚æœæˆ‘æœ‰ä¸¤ä¸ªåŒ…å®šä¹‰äº†å­—ç¬¦ä¸²ç›¸åŒçš„æƒ³ä¸ªé”™è¯¯ï¼Œåœ¨å…¶ä»–åº“è°ƒç”¨å¯¹æ¯”çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šç”±äºä¸åŒçš„ä¹¦å†™é¡ºåºèµ°è¿›ä¸åŒçš„åˆ†æ”¯å¯¼è‡´ä¸€äº›ä¸å¯é¢„æœŸçš„å¥‡å¥‡æ€ªæ€ªçš„é”™è¯¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> errorString <span class="hljs-keyword">struct</span> &#123;<br>text <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e errorString)</span> <span class="hljs-title">Error</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">return</span> e.text<br>&#125;<br><br><span class="hljs-comment">// New åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰é”™è¯¯</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">(s <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> errorString&#123;text: s&#125;<br>&#125;<br><br><span class="hljs-keyword">var</span> errorString1 = New(<span class="hljs-string">&quot;test a&quot;</span>)<br><span class="hljs-keyword">var</span> err1 = errors.New(<span class="hljs-string">&quot;test b&quot;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> errorString1 == New(<span class="hljs-string">&quot;test a&quot;</span>) &#123;<br>fmt.Println(<span class="hljs-string">&quot;err string a&quot;</span>) <span class="hljs-comment">// ä¼šè¾“å‡º</span><br>&#125;<br><br><span class="hljs-keyword">if</span> err1 == errors.New(<span class="hljs-string">&quot;test b&quot;</span>) &#123;<br>fmt.Println(<span class="hljs-string">&quot;err b&quot;</span>) <span class="hljs-comment">// ä¸ä¼šè¾“å‡º</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="error-type-é”™è¯¯å®šä¹‰ä¸åˆ¤æ–­"><a href="#error-type-é”™è¯¯å®šä¹‰ä¸åˆ¤æ–­" class="headerlink" title="error type: é”™è¯¯å®šä¹‰ä¸åˆ¤æ–­"></a>error type: é”™è¯¯å®šä¹‰ä¸åˆ¤æ–­</h2><h3 id="Sentinel-Error"><a href="#Sentinel-Error" class="headerlink" title="Sentinel Error"></a>Sentinel Error</h3><p>å“¨å…µé”™è¯¯ï¼Œå°±æ˜¯å®šä¹‰ä¸€äº›åŒ…çº§åˆ«çš„é”™è¯¯å˜é‡ï¼Œç„¶ååœ¨è°ƒç”¨çš„æ—¶å€™å¤–éƒ¨åŒ…å¯ä»¥ç›´æ¥å¯¹æ¯”å˜é‡è¿›è¡Œåˆ¤å®šï¼Œåœ¨æ ‡å‡†åº“å½“ä¸­å¤§é‡çš„ä½¿ç”¨äº†è¿™ç§æ–¹å¼<br>ä¾‹å¦‚ä¸‹æ–¹ <code>io</code>  åº“ä¸­å®šä¹‰çš„é”™è¯¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// EOF is the error returned by Read when no more input is available.</span><br><span class="hljs-comment">// Functions should return EOF only to signal a graceful end of input.</span><br><span class="hljs-comment">// If the EOF occurs unexpectedly in a structured data stream,</span><br><span class="hljs-comment">// the appropriate error is either ErrUnexpectedEOF or some other error</span><br><span class="hljs-comment">// giving more detail.</span><br><span class="hljs-keyword">var</span> EOF = errors.New(<span class="hljs-string">&quot;EOF&quot;</span>)<br><br><span class="hljs-comment">// ErrUnexpectedEOF means that EOF was encountered in the</span><br><span class="hljs-comment">// middle of reading a fixed-size block or data structure.</span><br><span class="hljs-keyword">var</span> ErrUnexpectedEOF = errors.New(<span class="hljs-string">&quot;unexpected EOF&quot;</span>)<br><br><span class="hljs-comment">// ErrNoProgress is returned by some clients of an io.Reader when</span><br><span class="hljs-comment">// many calls to Read have failed to return any data or error,</span><br><span class="hljs-comment">// usually the sign of a broken io.Reader implementation.</span><br><span class="hljs-keyword">var</span> ErrNoProgress = errors.New(<span class="hljs-string">&quot;multiple Read calls return no data or error&quot;</span>)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨å¤–éƒ¨åˆ¤å®šçš„æ—¶å€™ä¸€èˆ¬ä½¿ç”¨ç­‰å€¼åˆ¤å®šæˆ–è€…ä½¿ç”¨ <code>errors.Is</code>  è¿›è¡Œåˆ¤æ–­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> err == io.EOF &#123;<br><span class="hljs-comment">//...</span><br>&#125;<br><br><span class="hljs-keyword">if</span> errors.Is(err, io.EOF)&#123;<br><span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§é”™è¯¯å¤„ç†æ–¹å¼æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå°† error å½“åšåŒ…çš„ API æš´éœ²ç»™äº†ç¬¬ä¸‰æ–¹ï¼Œè¿™æ ·ä¼šå¯¼è‡´åœ¨åšé‡æ„æˆ–è€…å‡çº§çš„æ—¶å€™å¾ˆéº»çƒ¦ï¼Œå¹¶ä¸”è¿™ç§æ–¹å¼åŒ…å«çš„é”™è¯¯ä¿¡æ¯ä¼šååˆ†çš„æœ‰é™</p><h3 id="error-types"><a href="#error-types" class="headerlink" title="error types"></a>error types</h3><p>è¿™ä¸ªå°±ç±»ä¼¼æˆ‘ä»¬å‰é¢å®šä¹‰çš„ <code>errorString</code>  ä¸€æ ·å®ç°äº† <code>error</code>  çš„æ¥å£ï¼Œç„¶ååœ¨å¤–éƒ¨æ˜¯å¦ç±»å‹æ–­è¨€æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è¿™ç§é”™è¯¯ç±»å‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> MyStruct <span class="hljs-keyword">struct</span> &#123;<br>s <span class="hljs-keyword">string</span><br>    name <span class="hljs-keyword">string</span><br>    path <span class="hljs-keyword">string</span><br>&#125;<br><br><br><br><span class="hljs-comment">// ä½¿ç”¨çš„æ—¶å€™</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">switch</span> err.(<span class="hljs-keyword">type</span>) &#123;<br>        <span class="hljs-keyword">case</span> *MyStruct:<br>        <span class="hljs-comment">// ...</span><br>        <span class="hljs-keyword">case</span> others:<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼ç›¸å¯¹äºå“¨å…µæ¥è¯´ï¼Œå¯ä»¥åŒ…å«æ›´åŠ ä¸°å¯Œçš„ä¿¡æ¯ï¼Œä½†æ˜¯åŒæ ·ä¹Ÿå°†é”™è¯¯çš„ç±»å‹æš´éœ²ç»™äº†å¤–éƒ¨ï¼Œä¾‹å¦‚æ ‡å‡†åº“ä¸­çš„ <code>os.PathError</code></p><h3 id="Opaque-errors"><a href="#Opaque-errors" class="headerlink" title="Opaque errors"></a>Opaque errors</h3><p>ä¸é€æ˜çš„é”™è¯¯å¤„ç†ï¼Œè¿™ç§æ–¹å¼æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯åªè¿”å›é”™è¯¯ï¼Œæš´éœ²é”™è¯¯åˆ¤å®šæ¥å£ï¼Œä¸è¿”å›ç±»å‹ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ API çš„æš´éœ²ï¼Œåç»­çš„å¤„ç†ä¼šæ¯”è¾ƒçµæ´»ï¼Œè¿™ä¸ªä¸€èˆ¬ç”¨åœ¨å…¬å…±åº“ä¼šæ¯”è¾ƒå¥½</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> temporary <span class="hljs-keyword">interface</span> &#123;<br>Temporary() <span class="hljs-keyword">bool</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">IsTemporary</span><span class="hljs-params">(err error)</span> <span class="hljs-title">bool</span></span> &#123;<br>te, ok := err.(temporary)<br><span class="hljs-keyword">return</span> ok &amp;&amp; te.Temporary()<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼æˆ‘ä»¬å¯ä»¥æ–­è¨€é”™è¯¯å®ç°äº†ç‰¹å®šçš„è¡Œä¸ºï¼Œè€Œä¸æ˜¯æ–­è¨€é”™è¯¯æ˜¯ç‰¹å®šçš„ç±»å‹æˆ–å€¼</p><h2 id="error-handle-é”™è¯¯å¤„ç†ä¼˜åŒ–"><a href="#error-handle-é”™è¯¯å¤„ç†ä¼˜åŒ–" class="headerlink" title="error handle: é”™è¯¯å¤„ç†ä¼˜åŒ–"></a>error handle: é”™è¯¯å¤„ç†ä¼˜åŒ–</h2><p>åœ¨ go ä¸­å¸¸å¸¸ä¼šå­˜åœ¨å¤§é‡çš„ <code>if err</code>  ä»£ç ï¼Œä¸‹é¢ä»‹ç»ä¸¤ç§å¸¸è§çš„å‡å°‘è¿™ç§ä»£ç çš„æ–¹å¼</p><h3 id="bufio-scan"><a href="#bufio-scan" class="headerlink" title="bufio.scan"></a>bufio.scan</h3><p>å¯¹æ¯”ä¸‹é¢ä¸¤ä¸ªå‡½æ•°çš„å¤„ç†æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ <code>count2</code>  ä½¿ç”¨ <code>sc.Scan</code>  ä¹‹åä¸€ä¸ª <code>if err</code>  çš„åˆ¤æ–­éƒ½æ²¡æœ‰ï¼Œæå¤§çš„ç®€åŒ–äº†ä»£ç ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ <code>sc.Scan</code>  åšäº†å¾ˆå¤šå¤„ç†ï¼Œåƒå¾ˆå¤šç±»ä¼¼çš„ï¼Œéœ€è¦å¾ªç¯è¯»å–çš„éƒ½å¯ä»¥è€ƒè™‘åƒè¿™æ ·åŒ…è£…ä¹‹åè¿›è¡Œå¤„ç†ï¼Œè¿™æ ·å¤–éƒ¨åŒ…è°ƒç”¨çš„æ—¶å€™å°±ä¼šéå¸¸ç®€æ´</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ç»Ÿè®¡æ–‡ä»¶è¡Œæ•°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">count</span><span class="hljs-params">(r io.Reader)</span> <span class="hljs-params">(<span class="hljs-keyword">int</span>, error)</span></span> &#123;<br><span class="hljs-keyword">var</span> (<br>br    = bufio.NewReader(r)<br>lines <span class="hljs-keyword">int</span><br>err   error<br>)<br><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-comment">// è¯»å–åˆ°æ¢è¡Œç¬¦å°±è¯´æ˜æ˜¯ä¸€è¡Œ</span><br>_, err = br.ReadString(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>lines++<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br><br><span class="hljs-comment">// å½“é”™è¯¯æ˜¯ EOF çš„æ—¶å€™è¯´æ˜æ–‡ä»¶è¯»å–å®Œæ¯•äº†</span><br><span class="hljs-keyword">if</span> err != io.EOF &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, err<br>&#125;<br><br><span class="hljs-keyword">return</span> lines, err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">count2</span><span class="hljs-params">(r io.Reader)</span> <span class="hljs-params">(<span class="hljs-keyword">int</span>, error)</span></span> &#123;<br><span class="hljs-keyword">var</span> (<br>sc    = bufio.NewScanner(r)<br>lines <span class="hljs-keyword">int</span><br>)<br><br><span class="hljs-keyword">for</span> sc.Scan() &#123;<br>lines++<br>&#125;<br><br><span class="hljs-keyword">return</span> lines, sc.Err()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="error-writer"><a href="#error-writer" class="headerlink" title="error writer"></a>error writer</h3><p>çœ‹ä¸€ä¸ªæ¥è‡ª go blog çš„ä¾‹å­ï¼š<a href="https://blog.golang.org/errors-are-values">https://blog.golang.org/errors-are-values</a><br>ä¸€èˆ¬ä»£ç </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go">_, err = fd.Write(p0[a:b])<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-keyword">return</span> err<br>&#125;<br>_, err = fd.Write(p1[c:d])<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-keyword">return</span> err<br>&#125;<br>_, err = fd.Write(p2[e:f])<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-keyword">return</span> err<br>&#125;<br><span class="hljs-comment">// and so on</span><br></code></pre></td></tr></table></figure><p>errWriter</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> errWriter <span class="hljs-keyword">struct</span> &#123;<br>    w   io.Writer<br>    err error<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ew *errWriter)</span> <span class="hljs-title">write</span><span class="hljs-params">(buf []<span class="hljs-keyword">byte</span>)</span></span> &#123;<br>    <span class="hljs-keyword">if</span> ew.err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    _, ew.err = ew.w.Write(buf)<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨æ—¶</span><br>ew := &amp;errWriter&#123;w: fd&#125;<br>ew.write(p0[a:b])<br>ew.write(p1[c:d])<br>ew.write(p2[e:f])<br><span class="hljs-comment">// and so on</span><br><span class="hljs-keyword">if</span> ew.err != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-keyword">return</span> ew.err<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœå»ç¿» æ ‡å‡†åº“ä¸­ bufio.Writer çš„æºä»£ç ï¼Œä½ ä¼šå‘ç°ä¹Ÿæœ‰è¿™ç§ç”¨æ³•ï¼Œè¿™ç§å°±æ˜¯å°†é‡å¤çš„é€»è¾‘è¿›è¡Œäº†å°è£…ï¼Œç„¶åæŠŠ error æš‚å­˜ï¼Œç„¶åæˆ‘ä»¬å°±åªéœ€è¦åœ¨æœ€ååˆ¤æ–­ä¸€ä¸‹ error å°±è¡Œäº†</p><h2 id="wrap-error-é”™è¯¯åŒ…è£…"><a href="#wrap-error-é”™è¯¯åŒ…è£…" class="headerlink" title="wrap error: é”™è¯¯åŒ…è£…"></a>wrap error: é”™è¯¯åŒ…è£…</h2><h3 id="errors-wrap-æœ‰ä½•ä½œç”¨ï¼Œä¸ºä»€ä¹ˆä¸ç”¨æ ‡å‡†åº“çš„-fmt-Errorf-quot-w-quot"><a href="#errors-wrap-æœ‰ä½•ä½œç”¨ï¼Œä¸ºä»€ä¹ˆä¸ç”¨æ ‡å‡†åº“çš„-fmt-Errorf-quot-w-quot" class="headerlink" title="errors.wrap æœ‰ä½•ä½œç”¨ï¼Œä¸ºä»€ä¹ˆä¸ç”¨æ ‡å‡†åº“çš„ fmt.Errorf(&quot;%w&quot;)"></a>errors.wrap æœ‰ä½•ä½œç”¨ï¼Œä¸ºä»€ä¹ˆä¸ç”¨æ ‡å‡†åº“çš„ <code>fmt.Errorf(&quot;%w&quot;)</code></h3><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æ ‡å‡†åº“çš„æºç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å½“ <code>p.wrappedErr != nil</code>  çš„æ—¶å€™ï¼ˆä¹Ÿå°±æ˜¯æœ‰ %wï¼‰çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨ä¸€ä¸ª <code>wrapError</code>  å°†é”™è¯¯åŒ…è£…ï¼Œçœ‹ <code>wrapError</code>  çš„æºç å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªæ–¹æ³•åªæ˜¯åŒ…è£…äº†ä¸€ä¸‹åŸå§‹é”™è¯¯ï¼Œå¹¶ä¸”å¯ä»¥åšåˆ°é™„åŠ ä¸€äº›æ–‡æœ¬ä¿¡æ¯ï¼Œä½†æ˜¯æ²¡æœ‰å †æ ˆä¿¡æ¯ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Errorf</span><span class="hljs-params">(format <span class="hljs-keyword">string</span>, a ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;<br>p := newPrinter()<br>p.wrapErrs = <span class="hljs-literal">true</span><br>p.doPrintf(format, a)<br>s := <span class="hljs-keyword">string</span>(p.buf)<br><span class="hljs-keyword">var</span> err error<br><span class="hljs-keyword">if</span> p.wrappedErr == <span class="hljs-literal">nil</span> &#123;<br>err = errors.New(s)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>err = &amp;wrapError&#123;s, p.wrappedErr&#125;<br>&#125;<br>p.free()<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-keyword">type</span> wrapError <span class="hljs-keyword">struct</span> &#123;<br>msg <span class="hljs-keyword">string</span><br>err error<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *wrapError)</span> <span class="hljs-title">Error</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">return</span> e.msg<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *wrapError)</span> <span class="hljs-title">Unwrap</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> e.err<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨çœ‹ä¸€ä¸‹ pkg/errors çš„æºç ï¼Œæˆ‘è‚¯å¯ä»¥å‘ç°é™¤äº†ä½¿ç”¨ <code>withMessage</code>  é™„åŠ äº†é”™è¯¯ä¿¡æ¯ä¹‹å¤–è¿˜ä½¿ç”¨ <code>withStack</code>  é™„åŠ äº†å †æ ˆä¿¡æ¯ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨ç¨‹åºå…¥å£å¤„æ‰“å°æ—¥å¿—ä¿¡æ¯çš„æ—¶å€™å°±å¯ä»¥å°†å †æ ˆä¿¡æ¯ä¸€å¹¶æ‰“å‡ºäº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Wrap returns an error annotating err with a stack trace</span><br><span class="hljs-comment">// at the point Wrap is called, and the supplied message.</span><br><span class="hljs-comment">// If err is nil, Wrap returns nil.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Wrap</span><span class="hljs-params">(err error, message <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br>err = &amp;withMessage&#123;<br>cause: err,<br>msg:   message,<br>&#125;<br><span class="hljs-keyword">return</span> &amp;withStack&#123;<br>err,<br>callers(),<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¸ºä»€ä¹ˆä¸å…è®¸å¤„å¤„ä½¿ç”¨-errors-Wrap"><a href="#ä¸ºä»€ä¹ˆä¸å…è®¸å¤„å¤„ä½¿ç”¨-errors-Wrap" class="headerlink" title="ä¸ºä»€ä¹ˆä¸å…è®¸å¤„å¤„ä½¿ç”¨ errors.Wrap"></a>ä¸ºä»€ä¹ˆä¸å…è®¸å¤„å¤„ä½¿ç”¨ errors.Wrap</h3><p>å› ä¸ºæ¯ä¸€æ¬¡ <code>errors.Wrap</code>  çš„è°ƒç”¨éƒ½ä¼šä¸ºé”™è¯¯æ·»åŠ å †æ ˆä¿¡æ¯ï¼Œå¦‚æœå¤„å¤„è°ƒç”¨é‚£ä¼šæœ‰å¤§é‡çš„æ— ç”¨å †æ ˆ<br>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹åªæœ‰ä¸€å¤„ wrap</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;err: %+v&quot;</span>, c())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">a</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> errors.Wrap(fmt.Errorf(<span class="hljs-string">&quot;xxx&quot;</span>), <span class="hljs-string">&quot;test&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">b</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> a()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">c</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> b()<br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹ç»“æœæˆ‘ä»¬å¯ä»¥å‘ç°å·²ç»å¯ä»¥æ‰“å°å‡ºå…¨éƒ¨çš„å †æ ˆä¿¡æ¯äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go">err: xxx<br>test<br>main.a<br>        /home/ll/project/Go<span class="hljs-number">-000</span>/Week02/blog/wrap.<span class="hljs-keyword">go</span>:<span class="hljs-number">14</span><br>main.b<br>        /home/ll/project/Go<span class="hljs-number">-000</span>/Week02/blog/wrap.<span class="hljs-keyword">go</span>:<span class="hljs-number">18</span><br>main.c<br>        /home/ll/project/Go<span class="hljs-number">-000</span>/Week02/blog/wrap.<span class="hljs-keyword">go</span>:<span class="hljs-number">22</span><br>main.main<br>        /home/ll/project/Go<span class="hljs-number">-000</span>/Week02/blog/wrap.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span><br>runtime.main<br>        /usr/local/<span class="hljs-keyword">go</span>/src/runtime/proc.<span class="hljs-keyword">go</span>:<span class="hljs-number">204</span><br>runtime.goexit<br>        /usr/local/<span class="hljs-keyword">go</span>/src/runtime/asm_amd64.s:<span class="hljs-number">1374</span><br></code></pre></td></tr></table></figure><p>å†çœ‹å¤šå¤„ wrap çš„ç°è±¡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;err: %+v&quot;</span>, c())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">a</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> errors.Wrap(fmt.Errorf(<span class="hljs-string">&quot;xxx&quot;</span>), <span class="hljs-string">&quot;a&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">b</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> errors.Wrap(a(), <span class="hljs-string">&quot;b&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">c</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> errors.Wrap(b(), <span class="hljs-string">&quot;c&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ¯ä¸€å¤„ wrap éƒ½æ·»åŠ äº†ä¸€æ¬¡å †æ ˆä¿¡æ¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go">err: xxx<br>a<br>main.a<br>        /home/ll/project/Go<span class="hljs-number">-000</span>/Week02/blog/wrap.<span class="hljs-keyword">go</span>:<span class="hljs-number">14</span><br>main.b<br>        /home/ll/project/Go<span class="hljs-number">-000</span>/Week02/blog/wrap.<span class="hljs-keyword">go</span>:<span class="hljs-number">18</span><br>main.c<br>        /home/ll/project/Go<span class="hljs-number">-000</span>/Week02/blog/wrap.<span class="hljs-keyword">go</span>:<span class="hljs-number">22</span><br>main.main<br>        /home/ll/project/Go<span class="hljs-number">-000</span>/Week02/blog/wrap.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span><br>runtime.main<br>        /usr/local/<span class="hljs-keyword">go</span>/src/runtime/proc.<span class="hljs-keyword">go</span>:<span class="hljs-number">204</span><br>runtime.goexit<br>        /usr/local/<span class="hljs-keyword">go</span>/src/runtime/asm_amd64.s:<span class="hljs-number">1374</span><br>b<br>main.b<br>        /home/ll/project/Go<span class="hljs-number">-000</span>/Week02/blog/wrap.<span class="hljs-keyword">go</span>:<span class="hljs-number">18</span><br>main.c<br>        /home/ll/project/Go<span class="hljs-number">-000</span>/Week02/blog/wrap.<span class="hljs-keyword">go</span>:<span class="hljs-number">22</span><br>main.main<br>        /home/ll/project/Go<span class="hljs-number">-000</span>/Week02/blog/wrap.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span><br>runtime.main<br>        /usr/local/<span class="hljs-keyword">go</span>/src/runtime/proc.<span class="hljs-keyword">go</span>:<span class="hljs-number">204</span><br>runtime.goexit<br>        /usr/local/<span class="hljs-keyword">go</span>/src/runtime/asm_amd64.s:<span class="hljs-number">1374</span><br>c<br>main.c<br>        /home/ll/project/Go<span class="hljs-number">-000</span>/Week02/blog/wrap.<span class="hljs-keyword">go</span>:<span class="hljs-number">22</span><br>main.main<br>        /home/ll/project/Go<span class="hljs-number">-000</span>/Week02/blog/wrap.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span><br>runtime.main<br>        /usr/local/<span class="hljs-keyword">go</span>/src/runtime/proc.<span class="hljs-keyword">go</span>:<span class="hljs-number">204</span><br>runtime.goexit<br>        /usr/local/<span class="hljs-keyword">go</span>/src/runtime/asm_amd64.s:<span class="hljs-number">1374</span><br></code></pre></td></tr></table></figure><h2 id="æ ‡å‡†åº“-errors-Is-As-æ€ä¹ˆåˆ¤æ–­é”™è¯¯"><a href="#æ ‡å‡†åº“-errors-Is-As-æ€ä¹ˆåˆ¤æ–­é”™è¯¯" class="headerlink" title="æ ‡å‡†åº“ errors.Is / As æ€ä¹ˆåˆ¤æ–­é”™è¯¯"></a>æ ‡å‡†åº“ errors.Is / As æ€ä¹ˆåˆ¤æ–­é”™è¯¯</h2><h3 id="errors-Is"><a href="#errors-Is" class="headerlink" title="errors.Is"></a>errors.Is</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Is</span><span class="hljs-params">(err, target error)</span> <span class="hljs-title">bool</span></span> &#123;<br><span class="hljs-keyword">if</span> target == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err == target<br>&#125;<br><span class="hljs-comment">// é€šè¿‡åå°„åˆ¤è¯» target æ˜¯å¦å¯ä»¥è¢«æ¯”è¾ƒ</span><br>isComparable := reflectlite.TypeOf(target).Comparable()<br><span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-comment">// å¾ªç¯åˆ¤æ–­æ˜¯å¦ç›¸ç­‰</span><br><span class="hljs-keyword">if</span> isComparable &amp;&amp; err == target &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br>        <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦å®ç°äº† is æ¥å£ï¼Œå¦‚æœæœ‰å®ç°å°±ç›´æ¥åˆ¤æ–­</span><br><span class="hljs-keyword">if</span> x, ok := err.(<span class="hljs-keyword">interface</span>&#123; Is(error) <span class="hljs-keyword">bool</span> &#125;); ok &amp;&amp; x.Is(target) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-comment">// å»åˆ¤æ–­æ˜¯å¦å®ç°äº† unwrap çš„æ¥å£ï¼Œå¦‚æœå®ç°äº†å°±è¿›è¡Œ unwrap</span><br><span class="hljs-keyword">if</span> err = Unwrap(err); err == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="errors-As"><a href="#errors-As" class="headerlink" title="errors.As"></a>errors.As</h3><p>å’Œ is çš„é€»è¾‘ç±»ä¼¼ï¼Œå°±æ˜¯ä¸æ–­çš„è¿›è¡Œ unwrap è¿›è¡Œæ¯”è¾ƒï¼Œåªè¦æœ‰ä¸€ä¸ªç›¸åŒå°±è¿”å›ï¼Œå¦‚æœä¸€ç›´åˆ°åº•éƒ½ä¸è¡Œå°±è¿”å› false</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">As</span><span class="hljs-params">(err error, target <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span> &#123;<br><span class="hljs-keyword">if</span> target == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;errors: target cannot be nil&quot;</span>)<br>&#125;<br>val := reflectlite.ValueOf(target)<br>typ := val.Type()<br><span class="hljs-keyword">if</span> typ.Kind() != reflectlite.Ptr || val.IsNil() &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;errors: target must be a non-nil pointer&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> e := typ.Elem(); e.Kind() != reflectlite.Interface &amp;&amp; !e.Implements(errorType) &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;errors: *target must be interface or implement error&quot;</span>)<br>&#125;<br>targetType := typ.Elem()<br><span class="hljs-keyword">for</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> reflectlite.TypeOf(err).AssignableTo(targetType) &#123;<br>val.Elem().Set(reflectlite.ValueOf(err))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><span class="hljs-keyword">if</span> x, ok := err.(<span class="hljs-keyword">interface</span>&#123; As(<span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-keyword">bool</span> &#125;); ok &amp;&amp; x.As(target) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br>err = Unwrap(err)<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week02: Goé”™è¯¯å¤„ç†</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>error</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¾®æœåŠ¡(äºŒ) æœåŠ¡å‘ç°&amp;å¤šç§Ÿæˆ·</title>
    <link href="/post/go-training-02.html"/>
    <url>/post/go-training-02.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><p>ä¸Šç¯‡æ–‡ç« æˆ‘ä»¬è®²åˆ°å¾®æœåŠ¡çš„å®šä¹‰ï¼Œä¼˜ç¼ºç‚¹ï¼Œå¯¹å¤–æš´éœ²ç­‰ï¼ŒæœåŠ¡é™¤äº†å¯¹å¤–æš´éœ²ä¹‹å¤–ï¼ŒæœåŠ¡ä¹‹é—´è¿˜éœ€è¦ç›¸äº’è¿›è¡Œè°ƒç”¨ï¼Œä¸åŒçš„æœåŠ¡ä¹‹é—´é€šè¿‡ä»€ä¹ˆæ ·çš„åè®®è¿›è¡Œäº¤äº’ï¼ŒæœåŠ¡å‘ç°å¦‚ä½•å®ç°ï¼Œå¦‚ä½•ä¿è¯æœåŠ¡çš„å¹³æ»‘å‘å¸ƒä¸é‡å¯ï¼Œæµ‹è¯•ç¯å¢ƒçš„é—®é¢˜å¦‚ä½•è§£å†³ç­‰ã€‚</p><h2 id="æœåŠ¡é—´é€šä¿¡æ–¹å¼-gRPC"><a href="#æœåŠ¡é—´é€šä¿¡æ–¹å¼-gRPC" class="headerlink" title="æœåŠ¡é—´é€šä¿¡æ–¹å¼: gRPC"></a>æœåŠ¡é—´é€šä¿¡æ–¹å¼: gRPC</h2><ul><li><strong>ä¸ºä»€ä¹ˆé‡‡ç”¨ gRPC?</strong><ul><li><strong>å¤šè¯­è¨€ï¼š</strong>è¯­è¨€ä¸­ç«‹ï¼Œæ”¯æŒå¤šç§è¯­è¨€ã€‚</li><li><strong>è½»é‡çº§ã€é«˜æ€§èƒ½ï¼š</strong>åºåˆ—åŒ–æ”¯æŒ PB(Protocol Buffer)å’Œ JSONï¼ŒPB æ˜¯ä¸€ç§è¯­è¨€æ— å…³çš„é«˜æ€§èƒ½åºåˆ—åŒ–æ¡†æ¶ã€‚</li><li><strong>å¯æ’æ‹”</strong></li><li><strong>IDLï¼š</strong>åŸºäºæ–‡ä»¶å®šä¹‰æœåŠ¡ï¼Œé€šè¿‡ proto3 å·¥å…·ç”ŸæˆæŒ‡å®šè¯­è¨€çš„æ•°æ®ç»“æ„ã€æœåŠ¡ç«¯æ¥å£ä»¥åŠå®¢æˆ·ç«¯ Stubã€‚</li><li>ç§»åŠ¨ç«¯ï¼šåŸºäº<strong>æ ‡å‡†çš„ HTTP2 è®¾è®¡ï¼Œæ”¯æŒåŒå‘æµã€æ¶ˆæ¯å¤´å‹ç¼©ã€å• TCP çš„å¤šè·¯å¤ç”¨</strong>ã€æœåŠ¡ç«¯æ¨é€ç­‰ç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§ä½¿å¾— gRPC åœ¨ç§»åŠ¨ç«¯è®¾å¤‡ä¸Šæ›´åŠ <strong>çœç”µå’ŒèŠ‚çœç½‘ç»œæµé‡</strong>ã€‚</li><li><strong>æœåŠ¡è€Œéå¯¹è±¡ã€æ¶ˆæ¯è€Œéå¼•ç”¨ï¼š</strong>ä¿ƒè¿›å¾®æœåŠ¡çš„ç³»ç»Ÿé—´ç²—ç²’åº¦æ¶ˆæ¯äº¤äº’è®¾è®¡ç†å¿µã€‚</li><li><strong>è´Ÿè½½æ— å…³çš„ï¼š</strong>ä¸åŒçš„æœåŠ¡éœ€è¦ä½¿ç”¨ä¸åŒçš„æ¶ˆæ¯ç±»å‹å’Œç¼–ç ï¼Œä¾‹å¦‚ protocol buffersã€JSONã€XML å’Œ Thriftã€‚</li><li>æµï¼šStreaming APIã€‚</li><li><strong>é˜»å¡å¼å’Œéé˜»å¡å¼ï¼š</strong>æ”¯æŒå¼‚æ­¥å’ŒåŒæ­¥å¤„ç†åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é—´äº¤äº’çš„æ¶ˆæ¯åºåˆ—ã€‚</li><li><strong>å…ƒæ•°æ®äº¤æ¢ï¼š</strong>å¸¸è§çš„æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œå¦‚è®¤è¯æˆ–è·Ÿè¸ªï¼Œä¾èµ–æ•°æ®äº¤æ¢ã€‚<ul><li>metadata</li></ul></li><li><strong>æ ‡å‡†åŒ–çŠ¶æ€ç ï¼š</strong>å®¢æˆ·ç«¯é€šå¸¸ä»¥æœ‰é™çš„æ–¹å¼å“åº” API è°ƒç”¨è¿”å›çš„é”™è¯¯ã€‚</li></ul></li><li><strong>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ restful</strong><ul><li>æ¯ä¸ªå®¢æˆ·ç«¯éƒ½éœ€è¦å•ç‹¬å†™ SDKï¼Œå¤æ‚éº»çƒ¦</li><li>éœ€è¦å•ç‹¬å†™æ–‡æ¡£ï¼Œå¸¸å¸¸ä¼šå› ä¸ºä»£ç æ›´æ–°äº†ä½†æ˜¯æ–‡æ¡£æ²¡æ›´æ–°é™·å…¥å‘ä¸­</li><li>æ€§èƒ½ä¸å¤ªå¥½ï¼Œjson ä¼ é€’ç›¸å¯¹äº pb æ›´è€—æµé‡ï¼Œæ€§èƒ½æ›´ä½</li><li>http1.1 æ˜¯ä¸€ä¸ªå•è¿æ¥çš„è¯·æ±‚ï¼Œåœ¨å†…éƒ¨ç½‘ç»œç¯å¢ƒï¼Œä½¿ç”¨ http æ¯”è¾ƒæµªè´¹</li><li><strong>restful æ˜¯ä¸€ä¸ªæ¾æ•£çº¦æŸçš„åè®®ï¼Œéå¸¸çµæ´»ï¼Œæ¯ä¸ªäººï¼Œæ¯ä¸ªå›¢é˜Ÿå‡ºæ¥çš„ä»£ç éƒ½ä¸å¤ªä¸€æ ·ï¼Œæ¯”è¾ƒå®¹æ˜“å‡ºé”™</strong></li></ul></li></ul><h2 id="ä¼˜é›…å¯åŠ¨ä¸ä¼˜é›…ä¸­æ­¢ï¼ˆå¥åº·æ£€æŸ¥ï¼‰"><a href="#ä¼˜é›…å¯åŠ¨ä¸ä¼˜é›…ä¸­æ­¢ï¼ˆå¥åº·æ£€æŸ¥ï¼‰" class="headerlink" title="ä¼˜é›…å¯åŠ¨ä¸ä¼˜é›…ä¸­æ­¢ï¼ˆå¥åº·æ£€æŸ¥ï¼‰"></a>ä¼˜é›…å¯åŠ¨ä¸ä¼˜é›…ä¸­æ­¢ï¼ˆå¥åº·æ£€æŸ¥ï¼‰</h2><h3 id="ä¼˜é›…å¯åŠ¨"><a href="#ä¼˜é›…å¯åŠ¨" class="headerlink" title="ä¼˜é›…å¯åŠ¨"></a>ä¼˜é›…å¯åŠ¨</h3><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1606735520428-1f37cd30-225e-4b2c-a104-7ba3bbfe17c2.svg" alt="01_Goè¿›é˜¶è®­ç»ƒè¥_å¾®æœåŠ¡_v1.svg"></p><ol><li>Provider å¯åŠ¨ï¼Œk8s ä¸­çš„å¯åŠ¨è„šæœ¬ä¼šå®šæ—¶å»æ£€æŸ¥æœåŠ¡çš„å¥åº·æ£€æŸ¥æ¥å£</li><li>å¥åº·æ£€æŸ¥é€šè¿‡ä¹‹åï¼ŒæœåŠ¡æ³¨å†Œè„šæœ¬å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡ï¼ˆrpc://ip:portï¼‰</li><li>æ¶ˆè´¹è€…å®šæ—¶ä»æœåŠ¡æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡æ–¹åœ°å€ä¿¡æ¯</li><li>è·å–æˆåŠŸåï¼Œä¼šå®šæ—¶çš„å‘æœåŠ¡æ–¹å‘èµ·å¥åº·æ£€æŸ¥ï¼Œå¥åº·æ£€æŸ¥é€šè¿‡åæ‰ä¼šå‘è¿™ä¸ªåœ°å€å‘èµ·è¯·æ±‚<ol><li>åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å¦‚æœå¥åº·æ£€æŸ¥å‡ºç°é—®é¢˜ï¼Œä¼šä»æ¶ˆè´¹è€…æœ¬åœ°çš„è´Ÿè½½å‡è¡¡ä¸­ç§»é™¤</li></ol></li></ol><h3 id="ä¼˜é›…ä¸­æ­¢"><a href="#ä¼˜é›…ä¸­æ­¢" class="headerlink" title="ä¼˜é›…ä¸­æ­¢"></a>ä¼˜é›…ä¸­æ­¢</h3><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1606742744880-38b16366-6370-408b-8619-7a67d56c0c49.svg" alt="01_Goè¿›é˜¶è®­ç»ƒè¥_å¾®æœåŠ¡_v1.drawio.svg"></p><ol><li>è§¦å‘ä¸‹çº¿æ“ä½œ: é¦–å…ˆç”¨æˆ·åœ¨å‘å¸ƒå¹³å°ç‚¹å‡»å‘ç‰ˆ/ä¸‹çº¿æŒ‰é’®</li><li>å‘å¸ƒéƒ¨ç½²å¹³å°å‘æ³¨å†Œä¸­å¿ƒå‘èµ·æœåŠ¡æ³¨é”€è¯·æ±‚ï¼Œåœ¨æ³¨å†Œä¸­å¿ƒä¸‹çº¿æœåŠ¡çš„è¿™ä¸ªèŠ‚ç‚¹<ul><li>è¿™é‡Œåœ¨å‘å¸ƒéƒ¨ç½²å¹³å°å®ç°æœ‰ä¸ªå¥½å¤„ï¼Œä¸ç”¨æ¯ä¸ªåº”ç”¨éƒ½å»å®ç°ä¸€éç›¸åŒçš„é€»è¾‘</li><li>åœ¨åº”ç”¨å—åˆ°é€€å‡ºä¿¡å·ä¹‹åç”±åº”ç”¨ä¸»åŠ¨å‘èµ·æ³¨é”€æ“ä½œä¹Ÿæ˜¯å¯ä»¥çš„</li></ul></li></ol><ul><li>2.1 æ³¨å†Œä¸­å¿ƒä¸‹çº¿åº”ç”¨ä¹‹åï¼Œæ¶ˆè´¹è€…ä¼šè·å–åˆ°æœåŠ¡æ³¨é”€çš„äº‹ä»¶ï¼Œç„¶åå°†æœåŠ¡æ–¹çš„èŠ‚ç‚¹ä»æœ¬åœ°è´Ÿè½½å‡è¡¡å½“ä¸­ç§»é™¤<ol><li>æ³¨æ„è¿™ä¸€æ­¥æ“ä½œä¼šæœ‰ä¸€æ®µæ—¶é—´ï¼Œä¸‹é¢çš„ç¬¬å››æ­¥å¹¶ä¸æ˜¯è¿™ä¸€æ­¥ç»“æŸäº†æ‰å¼€å§‹</li></ol></li></ul><ol start="3"><li>å‘å¸ƒéƒ¨ç½²å¹³å°å‘åº”ç”¨å‘é€ <code>SIGTERM</code>  ä¿¡å·ï¼Œåº”ç”¨æ•è·åˆ°ä¹‹åæ‰§è¡Œ<ol><li>å°†å¥åº·æ£€æŸ¥æ¥å£è®¾ç½®ä¸ºä¸å¥åº·ï¼Œè¿”å›é”™è¯¯<ol><li>è¿™ä¸ªæ—¶å€™å¦‚æœæ¶ˆè´¹è€…è¿˜åœ¨è°ƒç”¨åº”ç”¨ç¨‹åºï¼Œè°ƒç”¨å¥åº·æ£€æŸ¥æ¥å£å‘ç°æ— æ³•é€šè¿‡ï¼Œä¹Ÿä¼šå°†æœåŠ¡èŠ‚ç‚¹ä»æœ¬åœ°è´Ÿè½½å‡è¡¡å½“ä¸­ç§»é™¤</li></ol></li><li>è°ƒç”¨ grpc/http çš„ shutdown æ¥å£ï¼Œå¹¶ä¸”ä¼ é€’è¶…æ—¶æ—¶é—´ï¼Œç­‰å¾…è¿æ¥å…¨éƒ¨å…³é—­åé€€å‡º<ol><li>è¿™ä¸ªè¶…æ—¶æ—¶é—´ä¸€èˆ¬ä¸º 2 ä¸ªå¿ƒè·³å‘¨æœŸ</li></ol></li></ol></li><li>å‘å¸ƒéƒ¨ç½²å¹³å°å¦‚æœå‘ç°åº”ç”¨ç¨‹åºé•¿æ—¶é—´æ²¡æœ‰å®Œæˆé€€å‡ºï¼Œå‘é€ <code>SIGKILL</code>  å¼ºåˆ¶é€€å‡ºåº”ç”¨<ol><li>è¿™ä¸ªè¶…æ—¶æ—¶é—´æ ¹æ®åº”ç”¨è¿›è¡Œè®¾ç½®ä¸€èˆ¬ä¸º 10 - 60s</li></ol></li></ol><h3 id="å®æˆ˜-åœ¨-gin-ä¸­å®ç°ä¼˜é›…å¯åŠ¨å’Œä¼˜é›…ä¸­æ­¢"><a href="#å®æˆ˜-åœ¨-gin-ä¸­å®ç°ä¼˜é›…å¯åŠ¨å’Œä¼˜é›…ä¸­æ­¢" class="headerlink" title="å®æˆ˜-åœ¨ gin ä¸­å®ç°ä¼˜é›…å¯åŠ¨å’Œä¼˜é›…ä¸­æ­¢"></a>å®æˆ˜-åœ¨ gin ä¸­å®ç°ä¼˜é›…å¯åŠ¨å’Œä¼˜é›…ä¸­æ­¢</h3><p>æºç å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°<br><a href="https://github.com/mohuishou/Go-000/tree/main/Week01">https://github.com/mohuishou/Go-000/tree/main/Week01</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;context&quot;</span><br><span class="hljs-string">&quot;log&quot;</span><br><span class="hljs-string">&quot;net/http&quot;</span><br><span class="hljs-string">&quot;os&quot;</span><br><span class="hljs-string">&quot;os/signal&quot;</span><br><span class="hljs-string">&quot;syscall&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br><br><span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>)<br><br><span class="hljs-comment">// æ¨¡æ‹Ÿæ…¢è¯·æ±‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sleep</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>t := ctx.Query(<span class="hljs-string">&quot;t&quot;</span>)<br>s, err := strconv.Atoi(t)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>ctx.JSON(http.StatusBadRequest, gin.H&#123;<span class="hljs-string">&quot;msg&quot;</span>: <span class="hljs-string">&quot;å‚æ•°é”™è¯¯: &quot;</span> + t&#125;)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>time.Sleep(time.Duration(s) * time.Second)<br>ctx.JSON(http.StatusOK, gin.H&#123;<span class="hljs-string">&quot;msg&quot;</span>: fmt.Sprintf(<span class="hljs-string">&quot;sleep %d s&quot;</span>, s)&#125;)<br>&#125;<br><br><br><span class="hljs-keyword">const</span> (<br>stateHealth   = <span class="hljs-string">&quot;health&quot;</span><br>stateUnHealth = <span class="hljs-string">&quot;unhealth&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> state = stateHealth<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">health</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>status := http.StatusOK<br><span class="hljs-keyword">if</span> state == stateUnHealth &#123;<br>status = http.StatusServiceUnavailable<br>&#125;<br>ctx.JSON(status, gin.H&#123;<span class="hljs-string">&quot;data&quot;</span>: state&#125;)<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>e := gin.Default()<br>e.GET(<span class="hljs-string">&quot;/health&quot;</span>, health)<br>e.GET(<span class="hljs-string">&quot;/sleep&quot;</span>, sleep)<br><br>server := &amp;http.Server&#123;<br>Addr:    <span class="hljs-string">&quot;:8080&quot;</span>,<br>Handler: e,<br>&#125;<br><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> err := server.ListenAndServe(); err != <span class="hljs-literal">nil</span> &amp;&amp; err != http.ErrServerClosed &#123;<br>log.Fatalf(<span class="hljs-string">&quot;server run err: %+v&quot;</span>, err)<br>&#125;<br>&#125;()<br><br><span class="hljs-comment">// ç”¨äºæ•è·é€€å‡ºä¿¡å·</span><br>quit := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal)<br><br><span class="hljs-comment">// kill (no param) default send syscall.SIGTERM</span><br><span class="hljs-comment">// kill -2 is syscall.SIGINT</span><br><span class="hljs-comment">// kill -9 is syscall.SIGKILL but can&#x27;t be catch, so don&#x27;t need add it</span><br>signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)<br>&lt;-quit<br>log.Println(<span class="hljs-string">&quot;Shutting down server...&quot;</span>)<br><br><span class="hljs-comment">// æ•è·åˆ°é€€å‡ºä¿¡å·ä¹‹åå°†å¥åº·æ£€æŸ¥çŠ¶æ€è®¾ç½®ä¸º unhealth</span><br>state = stateUnHealth<br>log.Println(<span class="hljs-string">&quot;Shutting down state: &quot;</span>, state)<br><br><span class="hljs-comment">// è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œä¸¤ä¸ªå¿ƒè·³å‘¨æœŸï¼Œå‡è®¾ä¸€æ¬¡å¿ƒè·³ 3s</span><br>ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">6</span>*time.Second)<br><span class="hljs-keyword">defer</span> cancel()<br><br><span class="hljs-comment">// Shutdown æ¥å£ï¼Œå¦‚æœæ²¡æœ‰æ–°çš„è¿æ¥äº†å°±ä¼šé‡Šæ”¾ï¼Œä¼ å…¥è¶…æ—¶ context</span><br><span class="hljs-comment">// è°ƒç”¨è¿™ä¸ªæ¥å£ä¼šå…³é—­æœåŠ¡ï¼Œä½†æ˜¯ä¸ä¼šä¸­æ–­æ´»åŠ¨è¿æ¥</span><br><span class="hljs-comment">// é¦–å…ˆä¼šå°†ç«¯å£ç›‘å¬ç§»é™¤</span><br><span class="hljs-comment">// ç„¶åä¼šå…³é—­æ‰€æœ‰çš„ç©ºé—²è¿æ¥</span><br><span class="hljs-comment">// ç„¶åç­‰å¾…æ´»åŠ¨çš„è¿æ¥å˜ä¸ºç©ºé—²åå…³é—­</span><br><span class="hljs-comment">// å¦‚æœç­‰å¾…æ—¶é—´è¶…è¿‡äº†ä¼ å…¥çš„ context çš„è¶…æ—¶æ—¶é—´ï¼Œå°±ä¼šå¼ºåˆ¶é€€å‡º</span><br><span class="hljs-comment">// è°ƒç”¨è¿™ä¸ªæ¥å£ server ç›‘å¬ç«¯å£ä¼šè¿”å› ErrServerClosed é”™è¯¯</span><br><span class="hljs-comment">// æ³¨æ„ï¼Œè¿™ä¸ªæ¥å£ä¸ä¼šå…³é—­å’Œç­‰å¾…websocketè¿™ç§è¢«åŠ«æŒçš„é“¾æ¥ï¼Œå¦‚æœåšä¸€äº›å¤„ç†ã€‚å¯ä»¥ä½¿ç”¨ RegisterOnShutdown æ³¨å†Œä¸€äº›æ¸…ç†çš„æ–¹æ³•</span><br><span class="hljs-keyword">if</span> err := server.Shutdown(ctx); err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatal(<span class="hljs-string">&quot;Server forced to shutdown:&quot;</span>, err)<br>&#125;<br><br>log.Println(<span class="hljs-string">&quot;Server exiting&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æœåŠ¡å‘ç°"><a href="#æœåŠ¡å‘ç°" class="headerlink" title="æœåŠ¡å‘ç°"></a>æœåŠ¡å‘ç°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1606744144537-0fe881ca-5716-4b80-8800-0dee0a266c5f.png" alt="image.png"></p><h3 id="å®¢æˆ·ç«¯å‘ç°"><a href="#å®¢æˆ·ç«¯å‘ç°" class="headerlink" title="å®¢æˆ·ç«¯å‘ç°"></a>å®¢æˆ·ç«¯å‘ç°</h3><ul><li>ç›´è¿ï¼Œæ¯”æœåŠ¡ç«¯æœåŠ¡å‘ç°å°‘ä¸€æ¬¡ç½‘ç»œè·³è½¬</li><li>Consumer éœ€è¦å†…ç½®ç‰¹å®šçš„æœåŠ¡å‘ç°å®¢æˆ·ç«¯å’Œå‘ç°é€»è¾‘<ul><li>å¯ä»¥å°†è´Ÿè½½å‡è¡¡é€»è¾‘ä¸‹æ”¾åˆ° sidecar ä¸­è¿›è¡Œè§£è€¦</li></ul></li></ul><h3 id="æœåŠ¡ç«¯å‘ç°"><a href="#æœåŠ¡ç«¯å‘ç°" class="headerlink" title="æœåŠ¡ç«¯å‘ç°"></a>æœåŠ¡ç«¯å‘ç°</h3><ul><li>Consumer æ— éœ€å…³æ³¨æœåŠ¡å‘ç°å…·ä½“ç»†èŠ‚ï¼Œåªéœ€çŸ¥é“æœåŠ¡çš„ DNS åŸŸåå³å¯</li><li>æ”¯æŒå¼‚æ„è¯­è¨€å¼€å‘ï¼Œéœ€è¦åŸºç¡€è®¾æ–½æ”¯æ’‘ï¼Œå¤šäº†ä¸€æ¬¡ç½‘ç»œè·³è½¬ï¼Œå¯èƒ½æœ‰æ€§èƒ½æŸå¤±ï¼ŒåŸºç¡€è®¾æ–½ä¼šæ¯”è¾ƒå¤æ‚<blockquote><p>B ç«™è¿™è¾¹é‡‡ç”¨çš„æ˜¯å®¢æˆ·ç«¯å‘ç°çš„æ¨¡å¼ï¼Œæˆ‘ä»¬å…¬å¸ç”¨çš„æ›´å¤šçš„æ˜¯æœåŠ¡ç«¯å‘ç°çš„æ¨¡å¼</p></blockquote></li></ul><h3 id="æ³¨å†Œä¸­å¿ƒ"><a href="#æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="æ³¨å†Œä¸­å¿ƒ"></a>æ³¨å†Œä¸­å¿ƒ</h3><p><strong>CPã€CAã€è¿˜æ˜¯ AP</strong><br>å®é™…åœºæ™¯æ˜¯æµ·é‡æœåŠ¡å‘ç°å’Œæ³¨å†Œï¼ŒæœåŠ¡çŠ¶æ€å¯ä»¥å¼±ä¸€è‡´, éœ€è¦çš„æ˜¯ AP ç³»ç»Ÿï¼Œåªéœ€æœ€ç»ˆä¸€è‡´æ€§å³å¯</p><ul><li>æ³¨å†Œçš„äº‹ä»¶å»¶è¿Ÿ<ul><li>é«˜å¯ç”¨çš„æœåŠ¡åœ¨è¿™æ–¹é¢é—®é¢˜ä¸å¤§</li></ul></li><li>æ³¨é”€çš„äº‹ä»¶å»¶è¿Ÿ<ul><li>å› ä¸ºæœ‰ä¸Šæ–‡æåˆ°çš„å¥åº·æ£€æŸ¥çš„æœºåˆ¶ï¼Œå³ä½¿æ³¨é”€å»¶è¿Ÿï¼Œå®¢æˆ·ç«¯ä¹Ÿä¼šä¸»åŠ¨çš„å°†èŠ‚ç‚¹ç§»é™¤</li></ul></li><li>ç›¸å…³æ–‡æ¡£<ul><li>å¤šä¸ªæ³¨å†Œä¸­å¿ƒçš„å¯¹æ¯”ï¼š<a href="https://developer.aliyun.com/article/698930">https://developer.aliyun.com/article/698930</a></li><li><a href="https://nacos.io/zh-cn/index.html">https://nacos.io/zh-cn/index.html</a> é˜¿é‡Œå¼€æºçš„æ³¨å†Œä¸­å¿ƒï¼Œæ¯›è€å¸ˆæ¨è ğŸ˜‚</li></ul></li></ul><p><strong>eureka å®ç°åŸç†</strong></p><blockquote><p>b ç«™ä»¿ç…§ç”¨ go å†™äº†ä¸€ä¸ª <a href="https://github.com/bilibili/discovery">https://github.com/bilibili/discovery</a></p></blockquote><p><strong><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1606745349658-c7638390-9cbd-4eca-b2ad-4baa15449c3f.png" alt="image.png"></strong></p><ul><li>æœåŠ¡æ³¨å†Œ<ul><li><strong>æ³¨å†Œï¼š</strong>æœåŠ¡æ–¹å¯åŠ¨åå‘æ³¨å†Œä¸­å¿ƒä»»æ„ä¸€ä¸ªèŠ‚ç‚¹å‘é€æ³¨å†Œè¯·æ±‚ï¼Œç„¶åè¿™ä¸ªèŠ‚ç‚¹ä¼šå‘å…¶ä»–èŠ‚ç‚¹è¿›è¡Œå¹¿æ’­åŒæ­¥</li><li><strong>å¿ƒè·³ï¼š</strong>æ³¨å†Œåå®šæœŸï¼ˆ30sï¼‰å‘æ³¨å†Œä¸­å¿ƒå‘é€å¿ƒè·³</li><li><strong>ä¸‹çº¿ï¼š</strong>ä¸‹çº¿æ—¶å‘æ³¨å†Œä¸­å¿ƒå‘é€ä¸‹çº¿è¯·æ±‚</li><li>æ³¨æ„ï¼šæ³¨å†Œä¸­å¿ƒèŠ‚ç‚¹å¯ä¸œå¸‚éœ€è¦åŠ è½½ç¼“å­˜è¿›è¡Œé¢„çƒ­ï¼Œæ‰€ä»¥ä¸å»ºè®®è¿™ä¸ªæ—¶å€™æœåŠ¡è¿›è¡Œé‡å¯æˆ–è€…æ˜¯å‘ç‰ˆ</li></ul></li><li>æœåŠ¡å‘ç°<ul><li>æ¶ˆè´¹è€…å®šæœŸå‘æ³¨å†Œä¸­å¿ƒé•¿è½®è®­è·å–èŠ‚ç‚¹ä¿¡æ¯ï¼Œè·å–åˆ°ä¹‹åç¼“å­˜åˆ°æœ¬åœ°</li></ul></li><li><strong>ç½‘ç»œæ•…éšœ</strong><ul><li>æœåŠ¡æ–¹ä¸æ³¨å†Œä¸­å¿ƒ<ul><li>æ³¨å†Œä¸­å¿ƒä¼šå®šæœŸï¼ˆ60sï¼‰æ£€æµ‹å·²å¤±æ•ˆï¼ˆ90s æœªæ›´æ–°ï¼‰çš„å®ä¾‹ï¼Œå¤±æ•ˆä¹‹åå°±ä¼šç§»é™¤ï¼Œä½†æ˜¯å¦‚æœçŸ­æ—¶é—´å†…ä¸¢å¤±å¤§é‡å¿ƒè·³è¿æ¥ï¼Œï¼ˆ15min å†…å¿ƒè·³ä½äºæœŸæœ›å€¼çš„ 85%ï¼‰å°±ä¼šå¼€å¯è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ï¼Œä¿ç•™è¿‡æœŸçš„æœåŠ¡ä¸ä¼šè¿›è¡Œåˆ é™¤</li></ul></li><li>æ³¨å†Œä¸­å¿ƒä¸æ¶ˆè´¹è€…<ul><li>æ¶ˆè´¹è€…æœ¬åœ°æœ‰ç¼“å­˜ï¼Œé—®é¢˜ä¸å¤§</li></ul></li><li>æœåŠ¡æ–¹ä¸æ¶ˆè´¹è€…<ul><li>æœ‰å¥åº·æ£€æŸ¥ï¼Œå¥åº·æ£€æŸ¥ä¸é€šè¿‡æ—¶ï¼Œä¼šä»æ¶ˆè´¹è€…æœ¬åœ°è´Ÿè½½å‡è¡¡ä¸­ç§»é™¤</li></ul></li></ul></li><li><strong>æ³¨å†Œä¸­å¿ƒæ•…éšœ</strong><ul><li>ä¸å»ºè®®è¿™ä¸ªæ—¶å€™æœåŠ¡è¿›è¡Œé‡å¯æˆ–è€…æ˜¯å‘ç‰ˆï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™æ³¨å†Œä¸ä¸Šï¼Œä¼šå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ï¼Œä¸å‘ç‰ˆçŸ­æ—¶é—´æ²¡æœ‰å½±å“</li><li>å¦‚æœå…¨éƒ¨æŒ‚æ‰ï¼Œå¯åŠ¨æ—¶å¿…é¡»è¦ç­‰ä¸¤åˆ°ä¸‰ä¸ªå¿ƒè·³å‘¨æœŸï¼Œç­‰æ‰€æœ‰çš„æœåŠ¡éƒ½æ³¨å†Œä¸Šä¹‹åå†å¼€å§‹æä¾›æœåŠ¡è¿è¡Œæ¶ˆè´¹è€…æ‹‰å–æ•°æ®</li><li>å¦‚æœæŒ‚æ‰ä¸€ä¸ªï¼Œéœ€è¦ç­‰å…¶ä»–çš„èŠ‚ç‚¹å°†ä¿¡æ¯åŒæ­¥åˆ°æœ¬æœºä¹‹åå†æä¾›æœåŠ¡</li><li>æ•°æ®åŒæ­¥æ—¶ä¼šå¯¹æ¯”æ—¶é—´æˆ³ï¼Œä¼šä¿è¯å½“å‰èŠ‚ç‚¹çš„æ•°æ®æ˜¯æœ€æ–°çš„</li></ul></li></ul><h2 id="å¤šé›†ç¾¤"><a href="#å¤šé›†ç¾¤" class="headerlink" title="å¤šé›†ç¾¤"></a>å¤šé›†ç¾¤</h2><blockquote><p>æ³¨æ„è¿™é‡Œçš„å¤šé›†ç¾¤éƒ½æ˜¯å•ä¸ªæœºæˆ¿å†…çš„</p></blockquote><h3 id="å¤šé›†ç¾¤éœ€æ±‚ä»ä½•è€Œæ¥ï¼Ÿ"><a href="#å¤šé›†ç¾¤éœ€æ±‚ä»ä½•è€Œæ¥ï¼Ÿ" class="headerlink" title="å¤šé›†ç¾¤éœ€æ±‚ä»ä½•è€Œæ¥ï¼Ÿ"></a>å¤šé›†ç¾¤éœ€æ±‚ä»ä½•è€Œæ¥ï¼Ÿ</h3><p>å¯¹äºç±»ä¼¼è´¦å·æœåŠ¡çš„ L0 çº§åˆ«çš„æœåŠ¡ï¼Œå‡ ä¹æ‰€æœ‰çš„æœåŠ¡éƒ½æœ‰ä¾èµ–ï¼Œéœ€è¦å°½å¯èƒ½çš„æé«˜æœåŠ¡çš„å¯ç”¨æ€§</p><ul><li>ä»å•ä¸€é›†ç¾¤è€ƒè™‘ï¼Œå¤šä¸ªèŠ‚ç‚¹ä¿è¯å¯ç”¨æ€§ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ N+2 çš„æ–¹å¼æ¥å†—ä½™èŠ‚ç‚¹ã€‚<ul><li>N ä¸€èˆ¬é€šè¿‡å‹æµ‹å¾—å‡º</li></ul></li><li>ä»å•ä¸€é›†ç¾¤æ•…éšœå¸¦æ¥çš„å½±å“é¢è§’åº¦è€ƒè™‘å†—ä½™å¤šå¥—é›†ç¾¤ã€‚<ul><li>ä¾‹å¦‚ä¾èµ–çš„ redis å‡ºç°é—®é¢˜ï¼Œæ•´ä¸ªé›†ç¾¤æŒ‚æ‰äº†</li></ul></li><li>å•ä¸ªæœºæˆ¿å†…çš„æœºæˆ¿æ•…éšœå¯¼è‡´çš„é—®é¢˜<ul><li>å¤šæœºæˆ¿éƒ¨ç½²ï¼Œå¦‚æœåœ¨äº‘ä¸Šå¯èƒ½æ˜¯å¤šä¸ªå¯ç”¨åŒº</li></ul></li></ul><h3 id="ä»€ä¹ˆæ˜¯å¤šé›†ç¾¤ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å¤šé›†ç¾¤ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å¤šé›†ç¾¤ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯å¤šé›†ç¾¤ï¼Ÿ</h3><ul><li>ç»™æŸä¸ªæœåŠ¡éƒ¨ç½²å¤šå¥—ï¼Œæ¯ä¸€å¥—éƒ½æ‹¥æœ‰ç‹¬ç«‹çš„ç¼“å­˜ï¼Œç‰©ç†ä¸Šç›¸å½“äºæœ‰å¤šå¥—èµ„æºï¼Œé€»è¾‘ä¸Šåˆ’åˆ†ä¸ºä¸åŒçš„é›†ç¾¤ï¼Œåœ¨æœåŠ¡æ³¨å†Œçš„æ—¶å€™å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œçš„æ—¶å€™æºå¸¦ç›¸å…³çš„é›†ç¾¤æ ‡ç­¾</li></ul><h3 id="å¦‚ä½•é™ä½å¥åº·æ£€æŸ¥æµé‡"><a href="#å¦‚ä½•é™ä½å¥åº·æ£€æŸ¥æµé‡" class="headerlink" title="å¦‚ä½•é™ä½å¥åº·æ£€æŸ¥æµé‡"></a>å¦‚ä½•é™ä½å¥åº·æ£€æŸ¥æµé‡</h3><p>å¯¹äºè´¦å·è¿™ç§å¤§é‡æœåŠ¡ä¾èµ–çš„æœåŠ¡ï¼Œä»…ä»…æ˜¯å¥åº·æ£€æŸ¥æµé‡å°±ä¼šå¯¼è‡´ 30%ä»¥ä¸Šçš„èµ„æºå ç”¨ï¼ˆB ç«™ä¹‹å‰çš„çœŸå®æƒ…å†µï¼‰<br>å¯ä»¥ä½¿ç”¨å­é›†ç®—æ³•ï¼Œå°†åç«¯çš„èŠ‚ç‚¹å‡åˆ†ç»™æ‰€æœ‰çš„å®¢æˆ·ç«¯</p><ul><li>é€šå¸¸ 20-100 ä¸ªåç«¯ï¼Œéƒ¨åˆ†åœºæ™¯éœ€è¦å¤§å­é›†ï¼Œæ¯”å¦‚å¤§æ‰¹é‡è¯»å†™æ“ä½œã€‚</li><li>åç«¯å¹³å‡åˆ†ç»™å®¢æˆ·ç«¯ã€‚</li><li>å®¢æˆ·ç«¯é‡å¯ï¼Œä¿æŒé‡æ–°å‡è¡¡ï¼ŒåŒæ—¶å¯¹åç«¯é‡å¯ä¿æŒé€æ˜ï¼ŒåŒæ—¶è¿æ¥çš„å˜åŠ¨æœ€å°<ul><li>æ¶ˆè´¹è€…å˜åŒ–çš„æ—¶å€™éœ€è¦ é‡æ–°å¹³è¡¡</li></ul></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// from google sre</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Subset</span><span class="hljs-params">(backends []<span class="hljs-keyword">string</span>, clientID, subsetSize <span class="hljs-keyword">int</span>)</span> []<span class="hljs-title">string</span></span> &#123;<br>subsetCount := <span class="hljs-built_in">len</span>(backends) / subsetSize<br><br><span class="hljs-comment">// Group clients into rounds; each round uses the same shuffled list:</span><br>round := clientID / subsetCount<br><br>r := rand.New(rand.NewSource(<span class="hljs-keyword">int64</span>(round)))<br>r.Shuffle(<span class="hljs-built_in">len</span>(backends), <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-keyword">int</span>)</span></span> &#123; backends[i], backends[j] = backends[j], backends[i] &#125;)<br><br><span class="hljs-comment">// The subset id corresponding to the current client:</span><br>subsetID := clientID % subsetCount<br><br>start := subsetID * subsetSize<br><span class="hljs-keyword">return</span> backends[start : start+subsetSize]<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¸ºä»€ä¹ˆä¸Šé¢è¿™ä¸ªç®—æ³•å¯ä»¥ä¿è¯å¯ä»¥å‡åŒ€åˆ†å¸ƒï¼Ÿ</strong><br>é¦–å…ˆï¼Œ<strong>shuffle ç®—æ³•ä¿è¯åœ¨ round ä¸€è‡´çš„æƒ…å†µä¸‹ï¼Œbackend çš„æ’åˆ—ä¸€å®šæ˜¯ä¸€è‡´çš„ã€‚</strong><br>å› ä¸ºæ¯ä¸ªå®ä¾‹æ‹¥æœ‰ä» 0 å¼€å§‹çš„è¿ç»­å”¯ä¸€çš„è‡ªå¢ idï¼Œä¸”è®¡ç®—è¿‡ç¨‹èƒ½å¤Ÿä¿è¯æ¯ä¸ª round å†…æ‰€æœ‰å®ä¾‹æ‹¿åˆ°çš„æœåŠ¡åˆ—è¡¨çš„æ’åˆ—ä¸€è‡´ï¼Œå› æ­¤åœ¨åŒä¸€ä¸ª round å†…çš„ client ä¼šåˆ†åˆ« backend æ’åˆ—çš„ä¸åŒéƒ¨åˆ†çš„åˆ‡ç‰‡ä½œä¸ºé€‰ä¸­çš„åç«¯æœåŠ¡æ¥å»ºç«‹è¿æ¥ã€‚<br>æ‰€ä»¥åªè¦ client id æ˜¯è¿ç»­çš„ï¼Œé‚£ä¹ˆ client å‘å‘ åç«¯çš„è¿æ¥å°±ä¸€å®šæ˜¯è¿ç»­çš„<br><strong>å‚è€ƒèµ„æ–™:</strong><br><a href="https://sre.google/sre-book/load-balancing-datacenter/">https://sre.google/sre-book/load-balancing-datacenter/</a><br><a href="https://xargin.com/limiting-conn-wih-subset/">https://xargin.com/limiting-conn-wih-subset/</a></p><h2 id="å¤šç§Ÿæˆ·ï¼ˆå¦‚ä½•è§£å†³å¤šå¥—æµ‹è¯•ç¯å¢ƒçš„é—®é¢˜ï¼‰"><a href="#å¤šç§Ÿæˆ·ï¼ˆå¦‚ä½•è§£å†³å¤šå¥—æµ‹è¯•ç¯å¢ƒçš„é—®é¢˜ï¼‰" class="headerlink" title="å¤šç§Ÿæˆ·ï¼ˆå¦‚ä½•è§£å†³å¤šå¥—æµ‹è¯•ç¯å¢ƒçš„é—®é¢˜ï¼‰"></a>å¤šç§Ÿæˆ·ï¼ˆå¦‚ä½•è§£å†³å¤šå¥—æµ‹è¯•ç¯å¢ƒçš„é—®é¢˜ï¼‰</h2><p>åœ¨ä¸€ä¸ªå¾®æœåŠ¡æ¶æ„ä¸­<strong>å…è®¸å¤šç³»ç»Ÿå…±å­˜</strong>æ˜¯åˆ©ç”¨å¾®æœåŠ¡ç¨³å®šæ€§ä»¥åŠæ¨¡å—åŒ–æœ€æœ‰æ•ˆçš„æ–¹å¼ä¹‹ä¸€ï¼Œè¿™ç§æ–¹å¼ä¸€èˆ¬è¢«ç§°ä¸ºå¤šç§Ÿæˆ·(multi-tenancy)ã€‚ç§Ÿæˆ·å¯ä»¥æ˜¯æµ‹è¯•ï¼Œé‡‘ä¸é›€å‘å¸ƒï¼Œå½±å­ç³»ç»Ÿ(shadow systems)ï¼Œç”šè‡³æœåŠ¡å±‚æˆ–è€…äº§å“çº¿ï¼Œä½¿ç”¨ç§Ÿæˆ·èƒ½å¤Ÿä¿è¯ä»£ç çš„éš”ç¦»æ€§å¹¶ä¸”èƒ½å¤ŸåŸºäºæµé‡ç§Ÿæˆ·åšè·¯ç”±å†³ç­–ã€‚</p><h3 id="å¦‚ä½•è§£å†³æµ‹è¯•ç¯å¢ƒçš„é—®é¢˜"><a href="#å¦‚ä½•è§£å†³æµ‹è¯•ç¯å¢ƒçš„é—®é¢˜" class="headerlink" title="å¦‚ä½•è§£å†³æµ‹è¯•ç¯å¢ƒçš„é—®é¢˜"></a>å¦‚ä½•è§£å†³æµ‹è¯•ç¯å¢ƒçš„é—®é¢˜</h3><h4 id="åœºæ™¯"><a href="#åœºæ™¯" class="headerlink" title="åœºæ™¯"></a>åœºæ™¯</h4><p>å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªæœåŠ¡è°ƒç”¨é“¾ A -&gt; B -&gt; Cï¼Œå¦‚æœ C åŒæ—¶æœ‰å¤šä¸ªåŒå­¦å¼€å‘ï¼Œå¦‚æœç”²åŒå­¦çš„ä»£ç æ­£åœ¨æµ‹è¯•ä¸­ï¼Œä½†æ˜¯ä¹™åŒå­¦ä¸å°å¿ƒå‘äº†ä¸€ä¸ªç‰ˆæœ¬ï¼Œå°±ä¼šå¯¼è‡´ç”²åŒå­¦çš„ä»£ç è¢«å†²æ‰ï¼Œå¯¼è‡´æµ‹è¯•åŒå­¦æµ‹ç€æµ‹ç€å°±å‡ºç° bugã€‚æµ‹è¯•åŒå­¦æ— æ³•å¾—çŸ¥è¿™ä¸ªé—®é¢˜æ˜¯ç”±äºç¯å¢ƒå¯¼è‡´çš„è¿˜æ˜¯ä»£ç ç¼ºé™·ã€‚</p><h4 id="è§£å†³æ–¹æ¡ˆ-1ï¼šå¤šå¥—ç‰©ç†ç¯å¢ƒï¼ˆç±»ä¼¼ä¸Šæ–‡çš„å¤šé›†ç¾¤ï¼‰"><a href="#è§£å†³æ–¹æ¡ˆ-1ï¼šå¤šå¥—ç‰©ç†ç¯å¢ƒï¼ˆç±»ä¼¼ä¸Šæ–‡çš„å¤šé›†ç¾¤ï¼‰" class="headerlink" title="è§£å†³æ–¹æ¡ˆ 1ï¼šå¤šå¥—ç‰©ç†ç¯å¢ƒï¼ˆç±»ä¼¼ä¸Šæ–‡çš„å¤šé›†ç¾¤ï¼‰"></a>è§£å†³æ–¹æ¡ˆ 1ï¼šå¤šå¥—ç‰©ç†ç¯å¢ƒï¼ˆç±»ä¼¼ä¸Šæ–‡çš„å¤šé›†ç¾¤ï¼‰</h4><p>æ­å»ºå¤šå¥—æµ‹è¯•ç¯å¢ƒï¼Œå¯ä»¥åšåˆ°ç‰©ç†éš”ç¦»ï¼Œä½†æ˜¯ä¹Ÿä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š</p><ul><li>æ··ç”¨ç¯å¢ƒå¯¼è‡´çš„ä¸å¯é æµ‹è¯•ã€‚</li><li>å¤šå¥—ç¯å¢ƒå¸¦æ¥çš„ç¡¬ä»¶æˆæœ¬ã€‚</li><li>éš¾ä»¥åšè´Ÿè½½æµ‹è¯•ï¼Œä»¿çœŸçº¿ä¸ŠçœŸå®æµé‡æƒ…å†µã€‚</li><li>æ²»æ ‡ä¸æ²»æœ¬ï¼Œæ— æ³•çŸ¥é“å½“å‰ç¯å¢ƒè°åœ¨ä½¿ç”¨ï¼Œå¹¶ä¸”å‡ å¥—ç¯å¢ƒå¯ä»¥æ»¡è¶³éœ€æ±‚ï¼Ÿä¸‡ä¸€åˆå¤šå‡ ä¸ªäººå¼€å‘æ˜¯ä¸æ˜¯åˆéœ€è¦å†æ¥å‡ å¥—ï¼Ÿ</li></ul><h4 id="è§£å†³æ–¹æ¡ˆ-2ï¼šå¤šç§Ÿæˆ·ï¼ŒæŸ“è‰²å‘å¸ƒ"><a href="#è§£å†³æ–¹æ¡ˆ-2ï¼šå¤šç§Ÿæˆ·ï¼ŒæŸ“è‰²å‘å¸ƒ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ 2ï¼šå¤šç§Ÿæˆ·ï¼ŒæŸ“è‰²å‘å¸ƒ"></a>è§£å†³æ–¹æ¡ˆ 2ï¼šå¤šç§Ÿæˆ·ï¼ŒæŸ“è‰²å‘å¸ƒ</h4><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1606799997241-a37aa06a-4d44-4001-96bb-b0287e9eead5.png" alt="image.png"></p><ul><li>æ³¨å†Œæµç¨‹<ul><li>å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€å¥—é—®é¢˜çš„ <code>FAT1</code>  æµ‹è¯•ç¯å¢ƒï¼Œç„¶åç°åœ¨å¯¹åº”ç”¨ B åšäº†ä¿®æ”¹</li><li>å¼€å‘åŒå­¦é€šè¿‡å‘å¸ƒå¹³å°å‘å¸ƒä¸€ä¸ªæ–°çš„ B åº”ç”¨ B<code>ï¼Œå¹¶ä¸”å¸¦ä¸Šç¯å¢ƒæ ‡ç­¾ï¼Œä¾‹å¦‚:</code>red`</li><li>åº”ç”¨ B<code>å‘æ³¨å†Œä¸­å¿ƒè¿›è¡Œæ³¨å†Œæ—¶å€™ä¼šå¸¦ä¸Š</code>red`  æ ‡ç­¾</li><li>æ¶ˆè´¹è€… A åœ¨å‘æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡èŠ‚ç‚¹æ•°æ®çš„æ—¶å€™ä¹Ÿä¼šè·å–åˆ°è¿™ä¸ªæ ‡ç­¾ï¼Œå¹¶ä¸”åœ¨æœ¬åœ°çš„è´Ÿè½½å‡è¡¡å½“ä¸­ä½¿ç”¨ <code>map[string]pool</code>  çš„ç»“æ„è¿›è¡Œä¿å­˜</li></ul></li><li>è°ƒç”¨æµç¨‹<ul><li>æµ‹è¯•åŒå­¦é€šè¿‡ A è¿›è¡Œè°ƒç”¨æµ‹è¯•ï¼Œå¦‚æœæ˜¯ http å°±åœ¨ header ä¸­æ‰“ä¸Šè¿™ä¸ª <code>red</code>  æ ‡ç­¾ï¼Œå¦‚æœæ˜¯ grpc å°±åœ¨ metadata ä¸­åŠ å…¥è¿™ä¸ªæ ‡ç­¾</li><li>A è°ƒç”¨ B çš„æ—¶å€™ï¼Œå‘ç° header ä¸­å­˜åœ¨ <code>red</code>  æ ‡ç­¾å°±ä¼šå»æœ¬åœ°è´Ÿè½½å‡è¡¡æŸ¥è¯¢ï¼Œå‘ç°è´Ÿè½½å‡è¡¡ä¸­æœ‰ red æ ‡ç­¾çš„è¿æ¥ï¼Œè¿™ä¸ªä¹‹åå°±ç›´æ¥è°ƒç”¨åˆ° B`ï¼Œå¹¶ä¸”åœ¨è°ƒç”¨çš„æ—¶å€™ A ä¼šå°† header çš„æ ‡ç­¾ä¿¡æ¯è¿›è¡Œé€ä¼ </li><li>B` æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œéœ€è¦è°ƒç”¨ Cã€D è¿™æ—¶å€™ä¹Ÿæ˜¯ä¸€æ ·çš„ä¼šå»è´Ÿè½½å‡è¡¡ä¸­è¿›è¡ŒæŸ¥è¯¢ï¼Œå‘ç°æ²¡æœ‰å°±ä¼šé€€å›åˆ°é»˜è®¤çš„è¿æ¥æ± ä¸­</li></ul></li><li>å¦‚ä½•è¿›è¡Œè”è°ƒï¼Ÿ<ul><li>éœ€è¦è”è°ƒçš„åº”ç”¨æ‰“ä¸Šç›¸åŒçš„æ ‡ç­¾å°±å¯ä»¥äº†</li></ul></li><li>æ³¨æ„äº‹é¡¹<ul><li>åº”ç”¨ç‰ˆæœ¬å‘å¸ƒæ—¶æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚ db ä¸­çš„è¡¨ï¼Œredis ä¸­çš„ keyï¼Œå¿…é¡»ä¿è¯å‘ä¸‹å…¼å®¹</li><li>æµ‹è¯•çš„æ—¶å€™éœ€è¦ä½¿ç”¨ä¸åŒçš„æµ‹è¯•è´¦å·</li><li>æ³¨æ„æ¥è‡ªå¤–ç½‘çš„è¯·æ±‚ä¸­çš„ header å¿…é¡»åˆ é™¤ï¼Œç¡®ä¿å®‰å…¨</li></ul></li><li><strong>æ ¸å¿ƒæ€è·¯</strong><ul><li>è·¨æœåŠ¡ä¼ é€’è¯·æ±‚æºå¸¦ä¸Šä¸‹æ–‡(context)ï¼Œæ•°æ®éš”ç¦»çš„æµé‡è·¯ç”±æ–¹æ¡ˆã€‚<ul><li>æ ¹æ®æ ‡ç­¾è¿›è¡Œæµé‡è·¯ç”±ï¼Œå¹¶ä¸”è¦ç¡®ä¿å¯ä»¥é€ä¼ </li></ul></li><li>åˆ©ç”¨æœåŠ¡å‘ç°æ³¨å†Œç§Ÿæˆ·ä¿¡æ¯ï¼Œæ³¨å†Œæˆç‰¹å®šçš„ç§Ÿæˆ·ã€‚<ul><li>å‘å¸ƒéƒ¨ç½²å¹³å°éœ€è¦æ”¯æŒæ–¹ä¾¿å¯åŠ¨å¤šå¥—ç¯å¢ƒï¼Œä»¥åŠæ ‡ç­¾æ³¨å…¥</li><li>å¯¹ä¸åŒçš„ç¯å¢ƒåšäº†éš”ç¦»ï¼Œå¯ä»¥ä¿è¯å¯¹å…³é”®ä¸šåŠ¡æ²¡æœ‰å½±å“</li></ul></li></ul></li></ul><h3 id="å¦‚ä½•è¿›è¡Œå…¨é“¾è·¯å‹æµ‹"><a href="#å¦‚ä½•è¿›è¡Œå…¨é“¾è·¯å‹æµ‹" class="headerlink" title="å¦‚ä½•è¿›è¡Œå…¨é“¾è·¯å‹æµ‹"></a>å¦‚ä½•è¿›è¡Œå…¨é“¾è·¯å‹æµ‹</h3><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1606802196792-9f605d74-4f29-458a-923f-6adc7a087e70.png" alt="image.png"><br>å’Œä¸Šé¢çš„æµ‹è¯•ç¯å¢ƒçš„è§£å†³æ–¹æ¡ˆç±»ä¼¼ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦æ­å»ºä¸€å¥—å’Œçº¿ä¸Šä¸€è‡´çš„å½±å­ç³»ç»Ÿ</p><ul><li>å¦‚ä½•è§£å†³å‹æµ‹æ•°æ®å¯¹çº¿ä¸Šæ•°æ®çš„å½±å“<ul><li>åŸºç¡€è®¾æ–½éœ€è¦åšæ”¹é€ ï¼Œé‡‡ç”¨åŒæ ·çš„åŸºç¡€è®¾æ–½èŠ‚ç‚¹</li><li>ç¼“å­˜ï¼šå½±å­åº”ç”¨å­˜å‚¨çš„æ•°æ®æ”¾åˆ°å½±å­åº“ä¸­ï¼Œä½¿ç”¨ä¸åŒçš„ db</li><li>æ•°æ®åº“ï¼šè‡ªåŠ¨å°†çº¿ä¸Šçš„æ•°æ®ç»“æ„å¤åˆ¶ä¸€ä»½åˆ°å½±å­æ•°æ®åº“ä¸­ã€‚é‡Œé¢çš„è¡¨ç»“æ„ä¿æŒä¸€è‡´ï¼Œæ•°æ®åº“ååšä¸€äº›å˜åŒ–ï¼Œä¾‹å¦‚ db_shadow</li><li>æ¶ˆæ¯é˜Ÿåˆ—: æ¨é€æ¶ˆæ¯çš„æ—¶å€™ä½¿ç”¨ä¸åŒçš„ topic æˆ–è€…æ˜¯æºå¸¦ä¸€äº› metadata ä¿¡æ¯</li></ul></li><li>éœ€è¦æå‰åšä¸€äº›æ•°æ®åˆå§‹åŒ–çš„æ“ä½œï¼Œæå‰è¿›è¡Œå‡†å¤‡</li><li>å‹æµ‹æ—¶æºå¸¦å‹æµ‹æ ‡ç­¾ï¼Œå°†æµé‡è‡ªåŠ¨è·¯ç”±åˆ°å½±å­æœåŠ¡è¿›è¡Œå‹æµ‹</li></ul><p>è¿™ç§æ–¹æ¡ˆåŒæ ·å¯ä»¥ç”¨äºç°åº¦å‘ç‰ˆå½“ä¸­</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°"><a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°</h2><p>çœ‹åˆ°è¿™é‡Œäº†è¿˜ä¸ç‚¹ä¸ªå…³æ³¨èµ°ä¸€æ³¢</p><ul><li><a href="https://lailin.xyz">åšå®¢</a> å¯ä»¥è®¢é˜… RSS</li><li><a href="https://github.com/mohuishou">Github</a> Follow me</li><li><a href="https://www.zhihu.com/people/mo-hui-shou-76">çŸ¥ä¹</a> å…³æ³¨è´¦å·ï¼Œé¡ºä¾¿ç‚¹ä¸ª ğŸ‘</li><li><a href="https://toutiao.io/subjects/387401?f=new">å¼€å‘è€…å¤´æ¡</a> è®¢é˜…è®¢é˜…å·ï¼Œé¡ºä¾¿ç‚¹ä¸ª ğŸ‘</li></ul><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week01: å¾®æœåŠ¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¾®æœåŠ¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¾®æœåŠ¡(ä¸€) å¾®æœåŠ¡æ¦‚è§ˆ</title>
    <link href="/post/go-training-01.html"/>
    <url>/post/go-training-01.html</url>
    
    <content type="html"><![CDATA[<div class="note note-info">            <p>æœ¬ç³»åˆ—ä¸º Go è¿›é˜¶è®­ç»ƒè¥ ç¬”è®°ï¼Œé¢„è®¡ 2021Q2 å®Œæˆæ›´æ–°ï¼Œè®¿é—® <a href="https://lailin.xyz/categories/Go%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/">åšå®¢: Goè¿›é˜¶è®­ç»ƒè¥</a>, å³å¯æŸ¥çœ‹å½“å‰æ›´æ–°è¿›åº¦ï¼Œéƒ¨åˆ†æ–‡ç« ç¯‡å¹…è¾ƒé•¿ï¼Œä½¿ç”¨ PC å¤§å±æµè§ˆä½“éªŒæ›´ä½³ã€‚</p>          </div><p>å‡ ä¸ªé—®é¢˜</p><p>å…ˆé—®è‡ªå·±å‡ ä¸ªé—®é¢˜ï¼Œçœ‹æ˜¯å¦å¯ä»¥å›ç­”ï¼Œä¸‹é¢æˆ‘ä»¬å°±å¸¦ç€é—®é¢˜æ€»ç»“è¯¾ç¨‹çš„å†…å®¹</p><ul><li>ä¸ºä»€ä¹ˆä¼šæœ‰å¾®æœåŠ¡ï¼Ÿ</li><li>å¾®æœåŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>å¾®æœåŠ¡å¯ä»¥å¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼Œåˆæœ‰é‚£äº›ç¼ºç‚¹ï¼Ÿ</li><li>å¾®æœåŠ¡å¦‚ä½•æ„å»ºï¼Ÿ</li><li>å¾®æœåŠ¡å¦‚ä½•å¯¹å¤–æš´éœ²ï¼Ÿ</li><li>å¾®æœåŠ¡å¦‚ä½•æ‹†åˆ†ï¼Ÿ</li><li>å¦‚ä½•ä¿è¯å¾®æœåŠ¡ä¹‹é—´çš„å®‰å…¨ï¼Ÿ</li></ul><h2 id="Q1-ä¸ºä»€ä¹ˆä¼šæœ‰å¾®æœåŠ¡ï¼Ÿ"><a href="#Q1-ä¸ºä»€ä¹ˆä¼šæœ‰å¾®æœåŠ¡ï¼Ÿ" class="headerlink" title="Q1: ä¸ºä»€ä¹ˆä¼šæœ‰å¾®æœåŠ¡ï¼Ÿ"></a>Q1: ä¸ºä»€ä¹ˆä¼šæœ‰å¾®æœåŠ¡ï¼Ÿ</h2><ul><li>ä¹‹å‰ä¸€èˆ¬æ˜¯ä¸€ä¸ªå•ä¸€çš„å·¨çŸ³æ¶æ„ï¼Œå­˜åœ¨å¾ˆå¤šé—®é¢˜<ul><li>åº”ç”¨æ¯”è¾ƒå¤æ‚ï¼Œæ²¡æœ‰äººèƒ½å¤Ÿææ‡‚</li><li>åº”ç”¨æ‰©å±•æ¯”è¾ƒå¤æ‚ï¼Œå¯é æ€§æ¯”è¾ƒä½</li><li>æ— æ³•è¿›è¡Œæ•æ·å¼€å‘å’Œéƒ¨ç½²</li></ul></li><li>æ‰€ä»¥ä¸€èˆ¬è¿™ä¸ªæ—¶å€™å°±ä¼šè€ƒè™‘æŒ‰ç…§æœåŠ¡ã€åŠŸèƒ½è¿›è¡Œæ‹†åˆ†</li></ul><h2 id="Q2-å¾®æœåŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#Q2-å¾®æœåŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Q2: å¾®æœåŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ"></a>Q2: å¾®æœåŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ</h2><ul><li>SOA ï¼ˆé¢å‘æœåŠ¡ï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ<ul><li>æœåŠ¡æ‹†åˆ†åæ¯”è¾ƒå°ï¼ŒBUG å°‘ï¼Œå®¹æ˜“æµ‹è¯•å’Œç»´æŠ¤ï¼Œä¹Ÿå®¹æ˜“æ‰©å±•</li><li><strong>å•ä¸€èŒè´£ï¼Œ</strong>ä¸€ä¸ªæœåŠ¡åªåšä¸€ä»¶äº‹æƒ…</li><li><strong>å°½å¯èƒ½çš„æ—©çš„åˆ›å»ºåŸå‹ï¼Œ</strong>å…ˆå®šä¹‰ APIï¼Œè¾¾æˆå¥‘çº¦</li><li><strong>å¯ç§»æ¤æ€§æ¯”æ•ˆç‡æ›´é‡è¦ï¼Œ</strong>é€šè®¯åè®®çš„å¯ç§»æ¤æ€§æ›´åŠ é‡è¦</li></ul></li><li>SOA å’Œ å¾®æœåŠ¡ æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ<ul><li>å¾®æœåŠ¡æ˜¯ SOA çš„ä¸€ç§å®è·µï¼Œå¾®æœåŠ¡ä¹Ÿæ˜¯é¢å‘æœåŠ¡çš„ä¸€ç§æ¶æ„</li></ul></li><li>å¾®æœåŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ<ul><li><strong>å›´ç»•ä¸šåŠ¡åŠŸèƒ½æ„å»ºçš„ï¼ŒæœåŠ¡å…³æ³¨å•ä¸€ä¸šåŠ¡ï¼ŒæœåŠ¡é—´é‡‡ç”¨è½»é‡çº§çš„é€šä¿¡æœºåˆ¶ï¼Œå¯ä»¥å…¨è‡ªåŠ¨ç‹¬ç«‹éƒ¨ç½²ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€å’Œæ•°æ®å­˜å‚¨æŠ€æœ¯ã€‚</strong></li></ul></li></ul><h2 id="Q3-å¾®æœåŠ¡å¯ä»¥å¸¦æ¥é‚£äº›å¥½å¤„ï¼Œåˆæœ‰å“ªäº›ç¼ºç‚¹ï¼Ÿ"><a href="#Q3-å¾®æœåŠ¡å¯ä»¥å¸¦æ¥é‚£äº›å¥½å¤„ï¼Œåˆæœ‰å“ªäº›ç¼ºç‚¹ï¼Ÿ" class="headerlink" title="Q3: å¾®æœåŠ¡å¯ä»¥å¸¦æ¥é‚£äº›å¥½å¤„ï¼Œåˆæœ‰å“ªäº›ç¼ºç‚¹ï¼Ÿ"></a>Q3: å¾®æœåŠ¡å¯ä»¥å¸¦æ¥é‚£äº›å¥½å¤„ï¼Œåˆæœ‰å“ªäº›ç¼ºç‚¹ï¼Ÿ</h2><ul><li>ä¼˜ç‚¹<ul><li>æœåŠ¡æ‹†åˆ†åæ¯”è¾ƒå°ï¼ŒBUG å°‘ï¼Œå®¹æ˜“æµ‹è¯•å’Œç»´æŠ¤ï¼Œä¹Ÿå®¹æ˜“æ‰©å±•</li><li><strong>åŸå­æœåŠ¡ï¼Œ</strong>ä¸€ä¸ªæœåŠ¡åªåšä¸€ä»¶äº‹æƒ…ï¼Œå¹¶ä¸”è¿™ä¸ªå±äºè¿™ä¸ªæœåŠ¡çš„ä¹Ÿä¸åº”è¯¥æ‹†åˆ†åˆ°å…¶ä»–æœåŠ¡å»</li><li><strong>ç‹¬ç«‹è¿›ç¨‹ï¼Œ</strong>ä¸€ä¸ªæœåŠ¡åªæœ‰ä¸€ä¸ªç‹¬ç«‹è¿›ç¨‹ï¼Œå¯ä»¥å¾ˆå¥½çš„å’Œå½“å‰çš„å®¹å™¨åŒ–è¿›è¡Œç»“åˆï¼Œæ— çŠ¶æ€çš„æœåŠ¡å¯ä»¥å¾ˆå®¹æ˜“çš„äº«å—åˆ°ï¼Œk8s ä¸Šçš„æ•…éšœè½¬ç§»ï¼Œè‡ªåŠ¨é‡å¯ç­‰å¥½å¤„</li><li><strong>éš”ç¦»éƒ¨ç½²ï¼Œ</strong>æ¯ä¸ªæœåŠ¡ä¹‹é—´ç‹¬ç«‹éƒ¨ç½²ï¼Œå¯ä»¥é¿å…ç›¸äº’å½±å“ï¼Œå¹¶ä¸”å’ŒæŒ‰éœ€è¿›è¡Œåˆ†é…èµ„æºï¼ŒèŠ‚çœæˆæœ¬</li><li><strong>å»ä¸­å¿ƒåŒ–æœåŠ¡æ²»ç†</strong><ul><li>æ•°æ®å»ä¸­å¿ƒåŒ–ï¼Œæ¯ä¸ªæœåŠ¡ç‹¬äº«æ•°æ®åº“ï¼Œç¼“å­˜ç­‰è®¾æ–½ï¼Œä¹Ÿæœ‰ä¸ªåˆ«æƒ…å†µå¤šä¸ªæœåŠ¡å…±äº«æ•°æ®åº“ï¼Œä¾‹å¦‚é¢å‘ç”¨æˆ·çš„ç®¡ç†åå°å’Œé¢å‘ç®¡ç†å‘˜çš„ç®¡ç†åå°</li><li>æ²»ç†å»ä¸­å¿ƒåŒ–</li><li>æŠ€æœ¯å»ä¸­å¿ƒåŒ–ï¼Œæ¯ä¸ªæœåŠ¡å¯ä»¥ä½¿ç”¨é€‚åˆè‡ªå·±çš„æŠ€æœ¯è¿›è¡Œå®æ–½ï¼Œä½†æ˜¯æ³¨æ„å¦‚æœæŠ€æœ¯æ ˆè¿‡äºå‘æ•£å¯¹äºä¼ä¸šæˆ–è€…å›¢é˜Ÿæœ¬èº«ä¹Ÿæ˜¯ä¸åˆ©çš„</li></ul></li></ul></li><li>ç¼ºç‚¹<ul><li><strong>æœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»å¤æ‚</strong>ï¼Œæˆåƒä¸Šä¸‡ä¸ªæœåŠ¡ç›¸äº’ä¾èµ–å°±åƒä¸€å›¢ä¹±éº»ä¸€æ ·ï¼Œå‰ªä¸æ–­ç†è¿˜ä¹±ã€‚<ul><li>å¸¸è§çš„è§£å†³æ–¹æ¡ˆï¼šå…¨é“¾è·¯è¿½è¸ªï¼Œä¾‹å¦‚ï¼Œ opentracing</li></ul></li><li>å¾®æœåŠ¡æœ¬èº«æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œéœ€è¦ä½¿ç”¨ RPC æˆ–è€… æ¶ˆæ¯è¿›è¡Œé€šä¿¡ï¼Œæ­¤å¤–<strong>ï¼Œå¿…é¡»è¦å†™ä»£ç æ¥å¤„ç†æ¶ˆæ¯ä¼ é€’ä¸­é€Ÿåº¦è¿‡æ…¢æˆ–è€…æœåŠ¡ä¸å¯ç”¨ç­‰å±€éƒ¨å¤±æ•ˆé—®é¢˜</strong><ul><li>ä¾‹å­ï¼šæœåŠ¡è°ƒç”¨æµé‡ä¼šå®¹æ˜“è¢«æ”¾å¤§ï¼Œå¦‚æœ æœåŠ¡ A -&gt; B -&gt;C å¦‚æœ A æœ‰ä¸€ä¸ªå¾ªç¯è°ƒç”¨ Bï¼ŒB ä¹Ÿæœ‰ä¸€ä¸ªå¾ªç¯è°ƒç”¨ Cï¼Œé‚£ä¹ˆä¸€ä¸ªè¯·æ±‚åˆ°è¾¾ C ä¹‹åå°±è¢«æ”¾å¤§äº† 100 å€ç”šè‡³ä¸Šåƒå€ã€‚è¿™æ˜¯æ‰›ä¸ä½çš„</li><li><strong>å¸¸è§è§£å†³æ–¹æ¡ˆï¼šç²—ç²’åº¦çš„è¿›ç¨‹é—´é€šä¿¡ï¼ˆbatch æ¥å£ï¼Œæ‰¹é‡è¯·æ±‚ï¼Œé¿å… n+1 é—®é¢˜ï¼‰ï¼Œéš”ç¦»ï¼Œè¶…æ—¶ä¿æŠ¤ï¼Œè´Ÿè½½ä¿æŠ¤ï¼Œç†”æ–­ã€é™æµã€é™çº§ã€é‡è¯•ï¼Œè´Ÿè½½å‡è¡¡</strong></li></ul></li><li><strong>ä¼šæœ‰åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ï¼Œ</strong>å› ä¸ºç°åœ¨æ¯ä¸ªå¾®æœåŠ¡ä¹‹é—´éƒ½ä¼šæœ‰ä¸€ä¸ªç‹¬ç«‹çš„æ•°æ®åº“ï¼Œäº‹åŠ¡åœ¨å•ä½“åº”ç”¨ä¸­å¾ˆå¥½å¤„ç†ï¼Œä½†æ˜¯åœ¨è·¨æœåŠ¡æ—¶ä¼šå˜å¾—å¾ˆéº»çƒ¦<ul><li>å¸¸è§è§£å†³æ–¹æ¡ˆï¼šä¸¤é˜¶æ®µæäº¤ã€TCC ç­‰</li><li><a href="https://xiaomi-info.github.io/2020/01/02/distributed-transaction/">å°ç±³ä¿¡æ¯éƒ¨æŠ€æœ¯å›¢é˜Ÿ: åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œè¿™ä¸€ç¯‡å°±å¤Ÿäº†</a></li></ul></li><li><strong>æµ‹è¯•ä¼šéå¸¸å¤æ‚ï¼Œ</strong>ç”±äºä¾èµ–å¤šï¼Œæ— æ³•å¾—çŸ¥æ˜¯å› ä¸ºåŠŸèƒ½å¼‚å¸¸è¿˜æ˜¯ä¾èµ–çš„æŸä¸ªæœåŠ¡å‘ç‰ˆå‡ºç°é—®é¢˜<ul><li>å¸¸è§è§£å†³æ–¹æ¡ˆï¼šç‹¬ç«‹æµ‹è¯•ç¯å¢ƒï¼Œåé¢ä¼šæœ‰ä¸€ä¸ªè§£å†³æ–¹æ¡ˆ</li></ul></li><li>æœåŠ¡æ¨¡å—é—´çš„ä¾èµ–ï¼Œåº”ç”¨çš„å‡çº§æœ‰å¯èƒ½ä¼šæ³¢åŠå¤šä¸ªæœåŠ¡æ¨¡å—çš„ä¿®æ”¹ã€‚<ul><li>åˆ‡è®°ï¼Œåœ¨æœåŠ¡éœ€è¦å˜æ›´æ—¶æˆ‘ä»¬è¦ç‰¹åˆ«å°å¿ƒï¼ŒæœåŠ¡æä¾›è€…çš„å˜æ›´å¯èƒ½å¼•å‘æœåŠ¡æ¶ˆè´¹è€…çš„å…¼å®¹æ€§ç ´åï¼Œ<strong>æ—¶åˆ»è°¨è®°ä¿æŒæœåŠ¡å¥‘çº¦(æ¥å£)çš„å…¼å®¹æ€§</strong></li><li>å‘é€æ—¶è¦ä¿å®ˆï¼Œæ¥æ”¶æ—¶è¦å¼€æ”¾ã€‚æŒ‰ç…§ä¼¯æ–¯å¡”å°”æ³•åˆ™çš„æ€æƒ³æ¥è®¾è®¡å’Œå®ç°æœåŠ¡æ—¶ï¼Œå‘é€çš„æ•°æ®è¦æ›´ä¿å®ˆï¼Œæ„å‘³ç€æœ€å°åŒ–çš„ä¼ é€å¿…è¦çš„ä¿¡æ¯ï¼Œæ¥æ”¶æ—¶æ›´å¼€æ”¾æ„å‘³ç€è¦æœ€å¤§é™åº¦çš„å®¹å¿å†—ä½™æ•°æ®ï¼Œä¿è¯å…¼å®¹æ€§ã€‚</li></ul></li><li><strong>å¯¹åŸºç¡€å»ºè®¾çš„è¦æ±‚å¾ˆé«˜ï¼Œ</strong>åŸºç¡€è®¾æ–½éœ€è¦è‡ªåŠ¨åŒ–ï¼Œæ—¥å¿—é‡‡é›†ï¼Œç›‘æ§æ•°æ®é‡‡é›†ï¼Œå‘Šè­¦ï¼ŒCICDï¼ŒK8s ç­‰<ul><li>å¸¸è§è§£å†³æ–¹æ¡ˆï¼šä¸Šäº‘</li></ul></li></ul></li></ul><h2 id="Q4-å¾®æœåŠ¡å¦‚ä½•æ„å»ºï¼Ÿ"><a href="#Q4-å¾®æœåŠ¡å¦‚ä½•æ„å»ºï¼Ÿ" class="headerlink" title="Q4: å¾®æœåŠ¡å¦‚ä½•æ„å»ºï¼Ÿ"></a>Q4: å¾®æœåŠ¡å¦‚ä½•æ„å»ºï¼Ÿ</h2><blockquote><p>å¤šä¸ªå¾®æœåŠ¡ç»„åˆ(compose)å®Œæˆäº†ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·åœºæ™¯(usecase)ã€‚</p></blockquote><ul><li>kitï¼šä¸€ä¸ªå¾®æœåŠ¡çš„åŸºç¡€åº“(æ¡†æ¶)ã€‚</li><li>serviceï¼šä¸šåŠ¡ä»£ç  + kit ä¾èµ– + ç¬¬ä¸‰æ–¹ä¾èµ–ç»„æˆçš„ä¸šåŠ¡å¾®æœåŠ¡</li><li>rpc + message queueï¼šè½»é‡çº§é€šè®¯</li></ul><h2 id="Q5-å¾®æœåŠ¡å¦‚ä½•å¯¹å¤–æš´éœ²ï¼Ÿ"><a href="#Q5-å¾®æœåŠ¡å¦‚ä½•å¯¹å¤–æš´éœ²ï¼Ÿ" class="headerlink" title="Q5: å¾®æœåŠ¡å¦‚ä½•å¯¹å¤–æš´éœ²ï¼Ÿ"></a>Q5: å¾®æœåŠ¡å¦‚ä½•å¯¹å¤–æš´éœ²ï¼Ÿ</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1606552913072-f2ae26c9-6897-4dc8-9384-95f493ff5006.svg" alt="01_Goè¿›é˜¶è®­ç»ƒè¥_å¾®æœåŠ¡_v1.svg"><br>æµé‡é“¾è·¯æ˜¯ä»€ä¹ˆï¼Ÿ</p><ul><li>ç§»åŠ¨ç«¯ -&gt; API Gateway -&gt; BFF -&gt; å¾®æœåŠ¡</li><li>ä¸å« CDNã€è´Ÿè½½å‡è¡¡ï¼ˆLBï¼‰</li><li>BFF çº¯ web çš„ä¸šåŠ¡ä¸€èˆ¬ç”¨ nodejs åš SSR</li></ul><p>ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„æœåŠ¡ä¸ç›´æ¥å¯¹å¤–è¿›è¡Œæš´éœ²ï¼Ÿ</p><ul><li>å‰ç«¯ï¼ˆç§»åŠ¨ç«¯ã€å®¢æˆ·ç«¯ã€webï¼‰åŒå­¦éå¸¸ç—›è‹¦ï¼Œéœ€è¦å¯¹æ¥å¤šä¸ªæœåŠ¡ï¼Œå…¼å®¹æ€§å·®ï¼Œæ²Ÿé€šæ•ˆç‡ä½</li><li>åç«¯åŒå­¦ä¹Ÿå¾ˆç—›è‹¦ï¼Œä¸€å¹´å‰çš„ç‰ˆæœ¬éƒ½æœ‰äººä½¿ç”¨ï¼ŒæœåŠ¡æ— æ³•è¿›è¡Œé‡æ„å‡çº§</li></ul><p>ä¸ºä»€ä¹ˆéœ€è¦æœ€å¤–å±‚çš„ api gateway?</p><ul><li>åŸºç¡€åº“çš„åŒå­¦éå¸¸åŒæ­¥ï¼Œé™æµç†”æ–­å®‰å…¨ç­‰ä¸šåŠ¡æ— å…³çš„åŠŸèƒ½éœ€è¦è¿›è¡Œå‡çº§çš„æ—¶å€™å‡ä¸åŠ¨</li></ul><h2 id="Q6-å¾®æœåŠ¡å¦‚ä½•æ‹†åˆ†ï¼Ÿ"><a href="#Q6-å¾®æœåŠ¡å¦‚ä½•æ‹†åˆ†ï¼Ÿ" class="headerlink" title="Q6: å¾®æœåŠ¡å¦‚ä½•æ‹†åˆ†ï¼Ÿ"></a>Q6: å¾®æœåŠ¡å¦‚ä½•æ‹†åˆ†ï¼Ÿ</h2><ul><li>åœ¨å¯¹ä¸šåŠ¡é¢†åŸŸä¸æ˜¯ç‰¹åˆ«ç†Ÿæ‚‰çš„æ—¶å€™ï¼ŒæŒ‰ç…§<strong>éƒ¨é—¨èŒèƒ½è¿›è¡Œåˆ’åˆ†ï¼Œä¾‹å¦‚è´¦å·ã€è´¢åŠ¡ç­‰</strong><ul><li>æ³¨æ„åˆ’åˆ†çš„æ—¶å€™<strong>è¦é—­ç¯</strong>ï¼Œä¸è¦ç›¸åŒçš„åŠŸèƒ½æ•£è½åˆ°å‡ ä¸ªéƒ¨é—¨å½“ä¸­</li></ul></li><li>åœ¨ç³»ç»Ÿç¨³å®šä¹‹åï¼Œç§¯ç´¯äº†ç›¸å…³çš„ä¸šåŠ¡ç»éªŒå’Œå¾®æœåŠ¡å¼€å‘ç»éªŒä¹‹åï¼Œå†è€ƒè™‘ä½¿ç”¨ DDD é™ç•Œä¸Šä¸‹æ–‡è¿›è¡Œåˆ’åˆ†</li><li>å¦‚æœå¯ä»¥é—­ç¯çš„è§£å†³ä¸€ä¸ªç”¨æˆ·åœºæ™¯ï¼Œé‚£ä¹ˆå®ƒåº”è¯¥æ˜¯ä¸€ä¸ªå¾®æœåŠ¡</li><li>è¿˜å¯ä»¥æ ¹æ®è®¿é—®é¢‘ç‡è¿›è¡ŒåŒºåˆ†åˆ’åˆ†ï¼Œå°†ç”¨æˆ·é«˜é¢‘è®¿é—®çš„éƒ¨åˆ†åˆ’åˆ†ä¸ºä¸€ä¸ªæœåŠ¡</li><li>è¿˜å¯ä»¥æ ¹æ®è¯»å†™è¿›è¡Œåˆ’åˆ†<ul><li>CQRS: å°†åº”ç”¨ç¨‹åºåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šå‘½ä»¤ç«¯å’ŒæŸ¥è¯¢ç«¯ã€‚å‘½ä»¤ç«¯å¤„ç†ç¨‹åºåˆ›å»ºï¼Œæ›´æ–°å’Œåˆ é™¤è¯·æ±‚ï¼Œå¹¶åœ¨æ•°æ®æ›´æ”¹æ—¶å‘å‡ºäº‹ä»¶ã€‚æŸ¥è¯¢ç«¯é€šè¿‡é’ˆå¯¹ä¸€ä¸ªæˆ–å¤šä¸ªç‰©åŒ–è§†å›¾æ‰§è¡ŒæŸ¥è¯¢æ¥å¤„ç†æŸ¥è¯¢ï¼Œè¿™äº›ç‰©åŒ–è§†å›¾é€šè¿‡è®¢é˜…æ•°æ®æ›´æ”¹æ—¶å‘å‡ºçš„äº‹ä»¶æµè€Œä¿æŒæœ€æ–°</li><li><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1606631756304-ac2b31e1-771a-45e7-9b99-5234badc5d0d.svg" alt="01_Goè¿›é˜¶è®­ç»ƒè¥_å¾®æœåŠ¡_v1.svg"></li></ul></li></ul><h2 id="Q7-å¦‚ä½•ä¿è¯å¾®æœåŠ¡ä¹‹é—´çš„å®‰å…¨ï¼Ÿ"><a href="#Q7-å¦‚ä½•ä¿è¯å¾®æœåŠ¡ä¹‹é—´çš„å®‰å…¨ï¼Ÿ" class="headerlink" title="Q7: å¦‚ä½•ä¿è¯å¾®æœåŠ¡ä¹‹é—´çš„å®‰å…¨ï¼Ÿ"></a>Q7: å¦‚ä½•ä¿è¯å¾®æœåŠ¡ä¹‹é—´çš„å®‰å…¨ï¼Ÿ</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1606632869613-c887da17-ec2f-4221-822a-84bbd21e4d3f.svg" alt="01_Goè¿›é˜¶è®­ç»ƒè¥_å¾®æœåŠ¡_v1.svg"><br>åœ¨å†…ç½‘ä¸»è¦çœ‹å®‰å…¨çº§åˆ«ä¸€èˆ¬æœ‰ä¸‰ç§ï¼š</p><ul><li>Full Trustï¼šå‡å®šå†…ç½‘æœåŠ¡ä¹‹é—´æ˜¯å®‰å…¨çš„ï¼Œåœ¨å†…ç½‘è£¸å¥”</li><li>Half Trustï¼šå†…ç½‘æœåŠ¡ä¹‹é—´éœ€è¦è¿›è¡Œè®¤è¯é‰´æƒï¼Œä½†æ˜¯ä¸éœ€è¦æ‰€æœ‰çš„éƒ½è¿›è¡ŒåŠ å¯†</li><li>Zero Trust: é›¶ä¿¡ä»»ï¼Œä»»åŠ¡å†…éƒ¨ç½‘ç»œæ˜¯ä¸å®‰å…¨çš„ï¼Œç±»ä¼¼å…¬ç½‘ï¼Œæ‰€æœ‰çš„è¯·æ±‚é€šè¿‡èº«ä»½è®¤è¯é‰´æƒä¹‹åï¼Œéƒ½éœ€è¦é€šè¿‡å®‰å…¨åŠ å¯†ï¼Œé˜²æ­¢è¢«å—…æ¢<ul><li><a href="https://www.microsoft.com/en-us/security/business/zero-trust">https://www.microsoft.com/en-us/security/business/zero-trust</a></li></ul></li></ul><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°"><a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°</h2><p>çœ‹åˆ°è¿™é‡Œäº†è¿˜ä¸ç‚¹ä¸ªå…³æ³¨èµ°ä¸€æ³¢</p><ul><li><a href="https://lailin.xyz">åšå®¢</a> å¯ä»¥è®¢é˜… RSS</li><li><a href="https://github.com/mohuishou">Github</a> Follow me</li><li><a href="https://www.zhihu.com/people/mo-hui-shou-76">çŸ¥ä¹</a> å…³æ³¨è´¦å·ï¼Œé¡ºä¾¿ç‚¹ä¸ª ğŸ‘</li><li><a href="https://toutiao.io/subjects/387401?f=new">å¼€å‘è€…å¤´æ¡</a> è®¢é˜…è®¢é˜…å·ï¼Œé¡ºä¾¿ç‚¹ä¸ª ğŸ‘</li></ul><div class="note note-info">            <p>ç¬¬ 0 æœŸå·²ç»ç»“æŸï¼Œæƒ³è¦æŠ¥ååé¢è¯¾ç¨‹çš„åŒå­¦ï¼Œæˆ‘è”ç³»æå®¢æ—¶é—´ä¸ºå¤§å®¶äº‰å–åˆ°äº†è¯»è€…ä¸“å±ä¼˜æƒ <br><strong>æ‰«æä¸‹æ–¹å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç ï¼Œå‘é€ã€ç¦åˆ©ã€‘è·å–ä¸“å±ä¼˜æƒ ï¼Œæ¯”å®˜æ–¹ä¼˜æƒ æ›´ç»™åŠ›å“¦</strong></p>          </div><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè¿›é˜¶è®­ç»ƒè¥</category>
      
      <category>Week01: å¾®æœåŠ¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>Goè¿›é˜¶è®­ç»ƒè¥</tag>
      
      <tag>å¾®æœåŠ¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goæ•°æ®ç»“æ„ä¸ç®—æ³•05-æ ˆä¸‹: æ·±å…¥ç†è§£ defer</title>
    <link href="/post/defer.html"/>
    <url>/post/defer.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go æ•°æ®ç»“æ„ä¸ç®—æ³•ç³»åˆ—æ–‡ç« ï¼Œæœ¬ç³»åˆ—æ–‡ç« ä¸»è¦ä¼šåŒ…æ‹¬å¸¸è§çš„æ•°æ®ç»“æ„ä¸ç®—æ³•å®ç°ï¼ŒåŒæ—¶ä¼šåŒ…æ‹¬ Go æ ‡å‡†åº“ä»£ç çš„åˆ†æç†è§£ï¼Œè®²åˆ°å¯¹åº”ç« èŠ‚çš„æ—¶å€™ä¼˜å…ˆå­¦ä¹ åˆ†æ Go çš„æºç å®ç°ï¼Œä¾‹å¦‚ sliceã€listã€sort ç­‰ï¼Œç„¶åå¯èƒ½ä¼šæœ‰ä¸€äº›å¸¸è§çš„æ¡ˆä¾‹å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/126">æå®¢æ—¶é—´-æ•°æ®ç»“æ„ä¸ç®—æ³•ä¹‹ç¾</a> çš„è¯¾ç¨‹ç¬”è®°</li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“:</strong> <a href="https://github.com/mohuishou/go-algorithm">https://github.com/mohuishou/go-algorithm</a> ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 1 ~ 2 ç¯‡æ–‡ç« ï¼Œé¢„è®¡åˆ° 202101 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°:</strong> <a href="https://github.com/mohuishou">Github</a>ã€<a href="https://zhuanlan.zhihu.com/mohuishou">çŸ¥ä¹</a>ã€<a href="https://lailin.xyz/atom.xml">RSS</a>ã€<a href="https://toutiao.io/subjects/387401?f=new">å¼€å‘è€…å¤´æ¡</a></li><li>ä¸Šä¸€ä¸ªç³»åˆ—åˆšåˆšå®Œæˆäº† <a href="https://lailin.xyz/post/go-design-pattern.html">Go è®¾è®¡æ¨¡å¼</a>ï¼Œå¦‚æœæ„Ÿå…´è¶£ä¹Ÿå¯ä»¥è¿›è¡ŒæŸ¥çœ‹</li></ul><h2 id="æ·±å…¥ç†è§£-go-defer"><a href="#æ·±å…¥ç†è§£-go-defer" class="headerlink" title="æ·±å…¥ç†è§£ go defer"></a>æ·±å…¥ç†è§£ go defer</h2><p>ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬è®²åˆ°æ ˆçš„æ—¶å€™è¯´åˆ°å…ˆå…¥åå‡ºè¿™ç§ç‰¹æ€§ï¼Œåœ¨ Go ä¸­ç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„å°±æ˜¯ <code>defer</code>  æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ·±å…¥ç†è§£ä¸€ä¸‹ defer</p><h3 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h3><p>ä¸‹é¢å…ˆå›é¡¾ä¸€ä¸‹åŸºæœ¬çš„ç”¨æ³•ä»¥åŠè¾ƒä¸ºå¸¸è§çš„å‘ï¼Œæ–‡æœ«ä¼šç»™å‡ºè¾“å‡ºç»“æœï¼Œå¯ä»¥å…ˆæƒ³æƒ³ä¼šè¾“å‡ºä»€ä¹ˆ</p><h4 id="åŸºæœ¬ç”¨æ³•-1-å»¶è¿Ÿå¤„ç†ï¼Œèµ„æºæ¸…ç†"><a href="#åŸºæœ¬ç”¨æ³•-1-å»¶è¿Ÿå¤„ç†ï¼Œèµ„æºæ¸…ç†" class="headerlink" title="åŸºæœ¬ç”¨æ³• 1: å»¶è¿Ÿå¤„ç†ï¼Œèµ„æºæ¸…ç†"></a>åŸºæœ¬ç”¨æ³• 1: å»¶è¿Ÿå¤„ç†ï¼Œèµ„æºæ¸…ç†</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åŸºæœ¬ç”¨æ³•ï¼šå»¶è¿Ÿè°ƒç”¨ï¼Œæ¸…ç†èµ„æº</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f0</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> fmt.Println(<span class="hljs-string">&quot;clean&quot;</span>)<br>fmt.Println(<span class="hljs-string">&quot;hello&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="åŸºæœ¬ç”¨æ³•-2-åè¿›å…ˆå‡º"><a href="#åŸºæœ¬ç”¨æ³•-2-åè¿›å…ˆå‡º" class="headerlink" title="åŸºæœ¬ç”¨æ³• 2: åè¿›å…ˆå‡º"></a>åŸºæœ¬ç”¨æ³• 2: åè¿›å…ˆå‡º</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åŸºæœ¬ç”¨æ³•1: åè¿›å…ˆå‡º</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f1</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> fmt.Println(<span class="hljs-string">&quot;1&quot;</span>)<br><span class="hljs-keyword">defer</span> fmt.Println(<span class="hljs-string">&quot;2&quot;</span>)<br><br>fmt.Println(<span class="hljs-string">&quot;3&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="åŸºæœ¬ç”¨æ³•-3-å¼‚å¸¸æ¢å¤"><a href="#åŸºæœ¬ç”¨æ³•-3-å¼‚å¸¸æ¢å¤" class="headerlink" title="åŸºæœ¬ç”¨æ³• 3: å¼‚å¸¸æ¢å¤"></a>åŸºæœ¬ç”¨æ³• 3: å¼‚å¸¸æ¢å¤</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åŸºæœ¬ç”¨æ³•2ï¼šå¼‚å¸¸æ¢å¤</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f2</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;paniced: %+v \n&quot;</span>, err)<br>&#125;<br>&#125;()<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;test&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å®¹æ˜“æ‰å‘-1-é—­åŒ…å˜é‡"><a href="#å®¹æ˜“æ‰å‘-1-é—­åŒ…å˜é‡" class="headerlink" title="å®¹æ˜“æ‰å‘ 1: é—­åŒ…å˜é‡"></a>å®¹æ˜“æ‰å‘ 1: é—­åŒ…å˜é‡</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å®¹æ˜“æ‰å‘ä¹‹ï¼Œå‡½æ•°å˜é‡ä¿®æ”¹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f3</span><span class="hljs-params">()</span> <span class="hljs-params">(res <span class="hljs-keyword">int</span>)</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>res++<br>&#125;()<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å®¹æ˜“æ‰å‘-2-å‚æ•°ä¼ é€’"><a href="#å®¹æ˜“æ‰å‘-2-å‚æ•°ä¼ é€’" class="headerlink" title="å®¹æ˜“æ‰å‘ 2: å‚æ•°ä¼ é€’"></a>å®¹æ˜“æ‰å‘ 2: å‚æ•°ä¼ é€’</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å®¹æ˜“æ‰å‘ä¹‹ï¼Œå‚æ•°å¤åˆ¶</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f4</span><span class="hljs-params">()</span> <span class="hljs-params">(res <span class="hljs-keyword">int</span>)</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(res <span class="hljs-keyword">int</span>)</span></span> &#123;<br>res++<br>&#125;(res)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æºç å‰–æ"><a href="#æºç å‰–æ" class="headerlink" title="æºç å‰–æ"></a>æºç å‰–æ</h3><p>æƒ³è¦çœ‹æºç ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ‰¾åˆ°æºç çš„ä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ‰§è¡Œ <code>go tool compile -N -l -S main.go</code> è·å–æ±‡ç¼–ä»£ç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">// ....<br> 0x00d8 00216 (main_2.go:6)PCDATA<span class="hljs-variable">$1</span>, <span class="hljs-variable">$0</span><br>0x00d8 00216 (main_2.go:6)CALLruntime.deferprocStack(SB)<br>0x00dd 00221 (main_2.go:6)NOP<br>0x00e0 00224 (main_2.go:6)TESTLAX, AX<br>0x00e2 00226 (main_2.go:6)JNE252<br>0x00e4 00228 (main_2.go:6)JMP230<br>0x00e6 00230 (main_2.go:7)XCHGLAX, AX<br>0x00e7 00231 (main_2.go:7)CALLruntime.deferreturn(SB)<br>0x00ec 00236 (main_2.go:7)MOVQ216(SP), BP<br>0x00f4 00244 (main_2.go:7)ADDQ<span class="hljs-variable">$224</span>, SP<br>0x00fb 00251 (main_2.go:7)RET<br>0x00fc 00252 (main_2.go:6)XCHGLAX, AX<br>0x00fd 00253 (main_2.go:6)NOP<br>0x0100 00256 (main_2.go:6)CALLruntime.deferreturn(SB)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸»è¦æ˜¯è°ƒç”¨äº† <code>runtime.deferprocStack</code> ï¼Œ <code>runtime.deferreturn</code>  è¿™ä¸¤ä¸ªè¿è¡Œæ—¶çš„æ–¹æ³•</p><h4 id="defer-å®šä¹‰"><a href="#defer-å®šä¹‰" class="headerlink" title="defer å®šä¹‰"></a>defer å®šä¹‰</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> _defer <span class="hljs-keyword">struct</span> &#123;<br>siz     <span class="hljs-keyword">int32</span> <span class="hljs-comment">// æ‰€æœ‰ä¼ å…¥å‚æ•°å’Œè¿”å›å€¼çš„æ€»å¤§å°</span><br>started <span class="hljs-keyword">bool</span>  <span class="hljs-comment">// defer æ˜¯å¦æ‰§è¡Œäº†</span><br>heap    <span class="hljs-keyword">bool</span>  <span class="hljs-comment">// æ˜¯å¦åœ¨å †ä¸Šï¼Œè¿™æ˜¯ go1.13 æ–°åŠ çš„ï¼Œåˆ’é‡ç‚¹</span><br>sp        <span class="hljs-keyword">uintptr</span>  <span class="hljs-comment">// å‡½æ•°æ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼Œä¸€èˆ¬æŒ‡å‘å½“å‰å‡½æ•°æ ˆçš„æ ˆé¡¶</span><br>pc        <span class="hljs-keyword">uintptr</span>  <span class="hljs-comment">// ç¨‹åºè®¡æ•°å™¨ï¼ŒæŒ‡å‘ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤</span><br>fn        *funcval <span class="hljs-comment">// æŒ‡å‘ä¼ å…¥çš„å‡½æ•°åœ°å€å’Œå‚æ•°</span><br>_panic    *_panic  <span class="hljs-comment">// æŒ‡å‘ panic é“¾è¡¨</span><br>link      *_defer  <span class="hljs-comment">// æŒ‡å‘ defer é“¾è¡¨</span><br><br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="deferprocStack"><a href="#deferprocStack" class="headerlink" title="deferprocStack"></a>deferprocStack</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deferprocStack</span><span class="hljs-params">(d *_defer)</span></span> &#123;<br>gp := getg() <span class="hljs-comment">// è·å– gï¼Œåˆ¤æ–­æ˜¯å¦åœ¨ç”¨æˆ·æ ˆä¸Š</span><br><span class="hljs-keyword">if</span> gp.m.curg != gp &#123;<br><span class="hljs-comment">// go code on the system stack can&#x27;t defer</span><br>throw(<span class="hljs-string">&quot;defer on system stack&quot;</span>)<br>&#125;<br><span class="hljs-comment">// siz and fn are already set.</span><br><span class="hljs-comment">// The other fields are junk on entry to deferprocStack and</span><br><span class="hljs-comment">// are initialized here.</span><br>d.started = <span class="hljs-literal">false</span><br>d.heap = <span class="hljs-literal">false</span><br>d.openDefer = <span class="hljs-literal">false</span><br>d.sp = getcallersp()<br>d.pc = getcallerpc()<br>d.framepc = <span class="hljs-number">0</span><br>d.varp = <span class="hljs-number">0</span><br><span class="hljs-comment">// The lines below implement:</span><br><span class="hljs-comment">//   d.panic = nil</span><br><span class="hljs-comment">//   d.fd = nil</span><br><span class="hljs-comment">//   d.link = gp._defer // è¿™ä¸¤ä¸ªæ˜¯å°†å½“å‰ defer æ’å…¥åˆ°é“¾è¡¨å¤´éƒ¨ï¼Œä¹Ÿå°±æ˜¯deferä¸ºä»€ä¹ˆæ—¶å€™å…ˆå…¥åå‡ºçš„åŸå› </span><br><span class="hljs-comment">//   gp._defer = d</span><br><span class="hljs-comment">// But without write barriers. The first three are writes to</span><br><span class="hljs-comment">// the stack so they don&#x27;t need a write barrier, and furthermore</span><br><span class="hljs-comment">// are to uninitialized memory, so they must not use a write barrier.</span><br><span class="hljs-comment">// The fourth write does not require a write barrier because we</span><br><span class="hljs-comment">// explicitly mark all the defer structures, so we don&#x27;t need to</span><br><span class="hljs-comment">// keep track of pointers to them with a write barrier.</span><br>*(*<span class="hljs-keyword">uintptr</span>)(unsafe.Pointer(&amp;d._panic)) = <span class="hljs-number">0</span><br>*(*<span class="hljs-keyword">uintptr</span>)(unsafe.Pointer(&amp;d.fd)) = <span class="hljs-number">0</span><br>*(*<span class="hljs-keyword">uintptr</span>)(unsafe.Pointer(&amp;d.link)) = <span class="hljs-keyword">uintptr</span>(unsafe.Pointer(gp._defer))<br>*(*<span class="hljs-keyword">uintptr</span>)(unsafe.Pointer(&amp;gp._defer)) = <span class="hljs-keyword">uintptr</span>(unsafe.Pointer(d))<br><br>return0()<br><span class="hljs-comment">// No code can go here - the C return register has</span><br><span class="hljs-comment">// been set and must not be clobbered.</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ³¨æ„è¿™å‡ è¡Œ</strong><br>è¯´æ˜è¿™ä¸ª defer ä¸åœ¨å †ä¸Š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">d.heap = <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªæ˜¯å°†å½“å‰ defer æ’å…¥åˆ°é“¾è¡¨å¤´éƒ¨ï¼Œä¹Ÿå°±æ˜¯ defer ä¸ºä»€ä¹ˆæ—¶å€™å…ˆå…¥åå‡ºçš„åŸå› </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//   d.link = gp._defer</span><br><span class="hljs-comment">//   gp._defer = d</span><br></code></pre></td></tr></table></figure><h4 id="deferreturn"><a href="#deferreturn" class="headerlink" title="deferreturn"></a>deferreturn</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deferreturn</span><span class="hljs-params">(arg0 <span class="hljs-keyword">uintptr</span>)</span></span> &#123;<br>gp := getg()<br>d := gp._defer<br><span class="hljs-keyword">if</span> d == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>sp := getcallersp()<br><span class="hljs-keyword">if</span> d.sp != sp &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">if</span> d.openDefer &#123;<br>done := runOpenDeferFrame(gp, d)<br><span class="hljs-keyword">if</span> !done &#123;<br>throw(<span class="hljs-string">&quot;unfinished open-coded defers in deferreturn&quot;</span>)<br>&#125;<br>gp._defer = d.link<br>freedefer(d)<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-keyword">switch</span> d.siz &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br><span class="hljs-comment">// Do nothing.</span><br><span class="hljs-keyword">case</span> sys.PtrSize:<br>*(*<span class="hljs-keyword">uintptr</span>)(unsafe.Pointer(&amp;arg0)) = *(*<span class="hljs-keyword">uintptr</span>)(deferArgs(d))<br><span class="hljs-keyword">default</span>:<br>memmove(unsafe.Pointer(&amp;arg0), deferArgs(d), <span class="hljs-keyword">uintptr</span>(d.siz))<br>&#125;<br>fn := d.fn<br>d.fn = <span class="hljs-literal">nil</span><br>gp._defer = d.link<br>freedefer(d)<br><span class="hljs-comment">// If the defer function pointer is nil, force the seg fault to happen</span><br><span class="hljs-comment">// here rather than in jmpdefer. gentraceback() throws an error if it is</span><br><span class="hljs-comment">// called with a callback on an LR architecture and jmpdefer is on the</span><br><span class="hljs-comment">// stack, because the stack trace can be incorrect in that case - see</span><br><span class="hljs-comment">// issue #8153).</span><br>_ = fn.fn<br>jmpdefer(fn, <span class="hljs-keyword">uintptr</span>(unsafe.Pointer(&amp;arg0)))<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœå‡½æ•°ä¸­å­˜åœ¨ defer ç¼–è¯‘å™¨å°±ä¼šè‡ªåŠ¨åœ¨å‡½æ•°çš„æœ€åæ’å…¥ä¸€ä¸ª deferreturn</p><ul><li>æ¸…ç©º defer çš„è°ƒç”¨ä¿¡æ¯</li><li>freedefer å°† defer å¯¹è±¡æ”¾å…¥åˆ° defer æ± ä¸­ï¼Œåé¢å¯ä»¥å¤ç”¨</li><li>å¦‚æœå­˜åœ¨å»¶è¿Ÿå‡½æ•°å°±ä¼šè°ƒç”¨ runtimeÂ·jmpdefer æ–¹æ³•è·³è½¬åˆ°å¯¹åº”çš„æ–¹æ³•ä¸Šå»</li><li>runtimeÂ·jmpdefer æ–¹æ³•ä¼šé€’å½’è°ƒç”¨ deferreturn ä¸€ç›´æ‰§è¡Œåˆ°ç»“æŸä¸ºæ­¢</li></ul><h4 id="deferproc"><a href="#deferproc" class="headerlink" title="deferproc"></a>deferproc</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deferproc</span><span class="hljs-params">(siz <span class="hljs-keyword">int32</span>, fn *funcval)</span></span> &#123; <span class="hljs-comment">// arguments of fn follow fn</span><br>gp := getg()<br><span class="hljs-keyword">if</span> gp.m.curg != gp &#123;<br><span class="hljs-comment">// go code on the system stack can&#x27;t defer</span><br>throw(<span class="hljs-string">&quot;defer on system stack&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// the arguments of fn are in a perilous state. The stack map</span><br><span class="hljs-comment">// for deferproc does not describe them. So we can&#x27;t let garbage</span><br><span class="hljs-comment">// collection or stack copying trigger until we&#x27;ve copied them out</span><br><span class="hljs-comment">// to somewhere safe. The memmove below does that.</span><br><span class="hljs-comment">// Until the copy completes, we can only call nosplit routines.</span><br>sp := getcallersp()<br>argp := <span class="hljs-keyword">uintptr</span>(unsafe.Pointer(&amp;fn)) + unsafe.Sizeof(fn)<br>callerpc := getcallerpc()<br><br>d := newdefer(siz)<br><span class="hljs-keyword">if</span> d._panic != <span class="hljs-literal">nil</span> &#123;<br>throw(<span class="hljs-string">&quot;deferproc: d.panic != nil after newdefer&quot;</span>)<br>&#125;<br>d.link = gp._defer<br>gp._defer = d<br>d.fn = fn<br>d.pc = callerpc<br>d.sp = sp<br><span class="hljs-keyword">switch</span> siz &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br><span class="hljs-comment">// Do nothing.</span><br><span class="hljs-keyword">case</span> sys.PtrSize:<br>*(*<span class="hljs-keyword">uintptr</span>)(deferArgs(d)) = *(*<span class="hljs-keyword">uintptr</span>)(unsafe.Pointer(argp))<br><span class="hljs-keyword">default</span>:<br>memmove(deferArgs(d), unsafe.Pointer(argp), <span class="hljs-keyword">uintptr</span>(siz))<br>&#125;<br><br><span class="hljs-comment">// deferproc returns 0 normally.</span><br><span class="hljs-comment">// a deferred func that stops a panic</span><br><span class="hljs-comment">// makes the deferproc return 1.</span><br><span class="hljs-comment">// the code the compiler generates always</span><br><span class="hljs-comment">// checks the return value and jumps to the</span><br><span class="hljs-comment">// end of the function if deferproc returns != 0.</span><br>return0()<br><span class="hljs-comment">// No code can go here - the C return register has</span><br><span class="hljs-comment">// been set and must not be clobbered.</span><br>&#125;<br></code></pre></td></tr></table></figure><p>é™¤äº† deferprocStack è¿˜æœ‰ deferproc è¿™ä¸ªæ–¹æ³•ï¼Œé‚£è¿™ä¸ªæ–¹æ³•å’Œä¹‹å‰çš„æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ<br>ä¸»è¦çš„åŒºåˆ«å°±æ˜¯è¿™ä¸ªæ–¹æ³•å°† defer åˆ†é…åœ¨äº†å †ä¸Šï¼Œçœ‹ä¸‹æ–¹çš„ <code>newdefer</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newdefer</span><span class="hljs-params">(siz <span class="hljs-keyword">int32</span>)</span> *_<span class="hljs-title">defer</span></span> &#123;<br>    <span class="hljs-comment">// ...</span><br>    d.heap = <span class="hljs-literal">true</span><br><span class="hljs-keyword">return</span> d<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä»–å’Œ deferprocStack ç±»ä¼¼è¿™é‡Œå°±ä¸èµ˜è¿°äº†</p><h4 id="ä»€ä¹ˆæ—¶å€™-defer-ä¼šåœ¨å †ä¸Šä»€ä¹ˆæ—¶å€™ä¼šåœ¨æ ˆä¸Šï¼Ÿ"><a href="#ä»€ä¹ˆæ—¶å€™-defer-ä¼šåœ¨å †ä¸Šä»€ä¹ˆæ—¶å€™ä¼šåœ¨æ ˆä¸Šï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ—¶å€™ defer ä¼šåœ¨å †ä¸Šä»€ä¹ˆæ—¶å€™ä¼šåœ¨æ ˆä¸Šï¼Ÿ"></a>ä»€ä¹ˆæ—¶å€™ defer ä¼šåœ¨å †ä¸Šä»€ä¹ˆæ—¶å€™ä¼šåœ¨æ ˆä¸Šï¼Ÿ</h4><p>é‚£é—®é¢˜æ¥äº†å¦‚ä½•åˆ¤æ–­ defer åœ¨å †ä¸Šè¿˜æ˜¯åœ¨æ ˆä¸Šå‘¢ï¼Ÿ<br><a href="https://github.com/golang/go/blob/master/src/cmd/compile/internal/gc/escape.go#L743">https://github.com/golang/go/blob/master/src/cmd/compile/internal/gc/escape.go#L743</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">topLevelDefer := where != <span class="hljs-literal">nil</span> &amp;&amp; where.Op == ODEFER &amp;&amp; e.loopDepth == <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> topLevelDefer &#123;<br>    <span class="hljs-comment">// force stack allocation of defer record, unless</span><br>    <span class="hljs-comment">// open-coded defers are used (see ssa.go)</span><br>    where.Esc = EscNever<br>&#125;<br></code></pre></td></tr></table></figure><p><a href="https://github.com/golang/go/blob/6965b01ea248cabb70c3749fd218b36089a21efb/src/cmd/compile/internal/gc/ssa.go#L1116">https://github.com/golang/go/blob/6965b01ea248cabb70c3749fd218b36089a21efb/src/cmd/compile/internal/gc/ssa.go#L1116</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">d := callDefer<br><span class="hljs-keyword">if</span> n.Esc == EscNever &#123;<br>    d = callDeferStack<br>&#125;<br>s.call(n.Left, d)<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸»è¦æ˜¯åœ¨é€ƒé€¸åˆ†æçš„æ—¶å€™ï¼Œå‘ç° <code>e.loopDepth == 1</code>  å¹¶ä¸”ä¸æ˜¯ open-coded defer å°±ä¼šåˆ†é…åˆ°æ ˆä¸Šã€‚<br>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ go 1.13 ä¹‹å defer æ€§èƒ½æå‡çš„åŸå› ï¼Œæ‰€ä»¥<strong>åˆ‡è®°ä¸è¦åœ¨å¾ªç¯ä¸­ä½¿ç”¨ defer ä¸ç„¶ä¼˜åŒ–ä¹Ÿäº«å—ä¸åˆ°</strong><br>æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f6</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;f6: %d\n&quot;</span>, i)<br>&#125;()<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹æ±‡ç¼–ç»“æœ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-number">0x0073</span> <span class="hljs-number">00115</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">67</span>)CALLruntime.deferproc(SB)<br><span class="hljs-number">0x0078</span> <span class="hljs-number">00120</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">67</span>)TESTLAX, AX<br><span class="hljs-number">0x007a</span> <span class="hljs-number">00122</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">67</span>)JNE<span class="hljs-number">151</span><br><span class="hljs-number">0x007c</span> <span class="hljs-number">00124</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">67</span>)JMP<span class="hljs-number">126</span><br><span class="hljs-number">0x007e</span> <span class="hljs-number">00126</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">66</span>)PCDATA$<span class="hljs-number">1</span>, $<span class="hljs-number">-1</span><br><span class="hljs-number">0x007e</span> <span class="hljs-number">00126</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">66</span>)NOP<br><span class="hljs-number">0x0080</span> <span class="hljs-number">00128</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">66</span>)JMP<span class="hljs-number">130</span><br><span class="hljs-number">0x0082</span> <span class="hljs-number">00130</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">66</span>)MOVQ<span class="hljs-string">&quot;&quot;</span>.&amp;i+<span class="hljs-number">32</span>(SP), AX<br><span class="hljs-number">0x0087</span> <span class="hljs-number">00135</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">66</span>)MOVQ(AX), AX<br><span class="hljs-number">0x008a</span> <span class="hljs-number">00138</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">66</span>)MOVQ<span class="hljs-string">&quot;&quot;</span>.&amp;i+<span class="hljs-number">32</span>(SP), CX<br><span class="hljs-number">0x008f</span> <span class="hljs-number">00143</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">66</span>)INCQAX<br><span class="hljs-number">0x0092</span> <span class="hljs-number">00146</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">66</span>)MOVQAX, (CX)<br><span class="hljs-number">0x0095</span> <span class="hljs-number">00149</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">66</span>)JMP<span class="hljs-number">68</span><br><span class="hljs-number">0x0097</span> <span class="hljs-number">00151</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">67</span>)PCDATA$<span class="hljs-number">1</span>, $<span class="hljs-number">0</span><br><span class="hljs-number">0x0097</span> <span class="hljs-number">00151</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">67</span>)XCHGLAX, AX<br><span class="hljs-number">0x0098</span> <span class="hljs-number">00152</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">67</span>)CALLruntime.deferreturn(SB)<br></code></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°åœ¨å¾ªç¯åµŒå¥—çš„åœºæ™¯ä¸‹ï¼Œçš„ç¡®è°ƒç”¨çš„æ˜¯ <code>runtime.deferproc</code>  æ–¹æ³•ï¼Œè¢«åˆ†é…åˆ°æ ˆä¸Šäº†</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>ç®—æ³•</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>æ•°æ®ç»“æ„</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goæ•°æ®ç»“æ„ä¸ç®—æ³•04-æ ˆä¸Š: å¦‚ä½•å®ç°ä¸€ä¸ªè®¡ç®—å™¨</title>
    <link href="/post/stack.html"/>
    <url>/post/stack.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go æ•°æ®ç»“æ„ä¸ç®—æ³•ç³»åˆ—æ–‡ç« ï¼Œæœ¬ç³»åˆ—æ–‡ç« ä¸»è¦ä¼šåŒ…æ‹¬å¸¸è§çš„æ•°æ®ç»“æ„ä¸ç®—æ³•å®ç°ï¼ŒåŒæ—¶ä¼šåŒ…æ‹¬ Go æ ‡å‡†åº“ä»£ç çš„åˆ†æç†è§£ï¼Œè®²åˆ°å¯¹åº”ç« èŠ‚çš„æ—¶å€™ä¼˜å…ˆå­¦ä¹ åˆ†æ Go çš„æºç å®ç°ï¼Œä¾‹å¦‚ sliceã€listã€sort ç­‰ï¼Œç„¶åå¯èƒ½ä¼šæœ‰ä¸€äº›å¸¸è§çš„æ¡ˆä¾‹å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/126">æå®¢æ—¶é—´-æ•°æ®ç»“æ„ä¸ç®—æ³•ä¹‹ç¾</a> çš„è¯¾ç¨‹ç¬”è®°</li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“:</strong> <a href="https://github.com/mohuishou/go-algorithm">https://github.com/mohuishou/go-algorithm</a> ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 1 ~ 2 ç¯‡æ–‡ç« ï¼Œé¢„è®¡åˆ° 202101 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°:</strong> <a href="https://github.com/mohuishou">Github</a>ã€<a href="https://zhuanlan.zhihu.com/mohuishou">çŸ¥ä¹</a>ã€<a href="https://lailin.xyz/atom.xml">RSS</a>ã€<a href="https://toutiao.io/subjects/387401?f=new">å¼€å‘è€…å¤´æ¡</a></li><li>ä¸Šä¸€ä¸ªç³»åˆ—åˆšåˆšå®Œæˆäº† <a href="https://lailin.xyz/post/go-design-pattern.html">Go è®¾è®¡æ¨¡å¼</a>ï¼Œå¦‚æœæ„Ÿå…´è¶£ä¹Ÿå¯ä»¥è¿›è¡ŒæŸ¥çœ‹</li></ul><h2 id="æ ˆ"><a href="#æ ˆ" class="headerlink" title="æ ˆ"></a>æ ˆ</h2><h3 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h3><p>æ ˆæ˜¯ä¸€ç§â€œæ“ä½œå—é™â€çš„çº¿æ€§è¡¨ï¼Œ<strong>åè¿›è€…å…ˆå‡ºï¼Œå…ˆè¿›è€…åå‡ºã€‚</strong><br>æ¯”è¾ƒå…¸å‹çš„ä¾‹å­å°±æ˜¯æˆ‘ä»¬åœ¨å ç›˜å­çš„æ—¶å€™ï¼Œå çš„æ—¶å€™ä»ä¸‹åˆ°ä¸Šä¸€ä¸ªä¸€ä¸ªç£Šèµ·æ¥ï¼Œå–çš„æ—¶å€™ï¼Œå†ä»ä¸Šåˆ°ä¸‹ä¸€ä¸ªä¸€ä¸ªçš„æ‹¿å‡ºæ¥ã€‚<br>è¯´åˆ°å…ˆå…¥åå‡ºè¿™ç§ç‰¹æ€§ï¼Œåœ¨ Go ä¸­ä½ ç¬¬ä¸€æ—¶é—´æƒ³åˆ°äº†ä»€ä¹ˆï¼Ÿä¸çŸ¥é“æ˜¯å¦å’Œæˆ‘çš„ç­”æ¡ˆä¸€æ ·ï¼Œ <code>defer</code><br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1606140416813-6b90944b-87c1-43eb-8443-c747e6559200.svg" alt="01_stack.drawio.svg"></p><h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><p>å­˜åœ¨ä¸¤ç§å®ç°æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯æ•°ç»„å®ç°çš„é¡ºåºæ ˆï¼Œç¬¬äºŒç§æ˜¯é“¾è¡¨é“¾å¼æ ˆ</p><h4 id="æ•°ç»„å®ç°"><a href="#æ•°ç»„å®ç°" class="headerlink" title="æ•°ç»„å®ç°"></a>æ•°ç»„å®ç°</h4><p>æ•°ç»„å®ç°æˆ‘ä»¬ç›´æ¥ä½¿ç”¨äº† <code>slice</code> ï¼Œå¹¶ä¸”å€ŸåŠ© <code>slice</code>  å®ç°äº†è‡ªåŠ¨æ‰©å®¹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Stack Stack</span><br><span class="hljs-keyword">type</span> Stack <span class="hljs-keyword">struct</span> &#123;<br>items   []<span class="hljs-keyword">string</span><br>current <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-comment">// NewStack NewStack</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewStack</span><span class="hljs-params">()</span> *<span class="hljs-title">Stack</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;Stack&#123;<br>items:   <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">string</span>, <span class="hljs-number">10</span>),<br>current: <span class="hljs-number">0</span>,<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Push å…¥æ ˆ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Stack)</span> <span class="hljs-title">Push</span><span class="hljs-params">(item <span class="hljs-keyword">string</span>)</span></span> &#123;<br>s.current++<br><span class="hljs-comment">// åˆ¤æ–­åº•å±‚ slice æ˜¯å¦æ»¡äº†ï¼Œå¦‚æœæ»¡äº†å°± append</span><br><span class="hljs-keyword">if</span> s.current == <span class="hljs-built_in">len</span>(s.items) &#123;<br>s.items = <span class="hljs-built_in">append</span>(s.items, item)<br><span class="hljs-keyword">return</span><br>&#125;<br>s.items[s.current] = item<br>&#125;<br><br><span class="hljs-comment">// Pop å‡ºæ ˆ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Stack)</span> <span class="hljs-title">Pop</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">if</span> s.current == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>&#125;<br>item := s.items[s.current]<br>s.current--<br><span class="hljs-keyword">return</span> item<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="é“¾è¡¨å®ç°"><a href="#é“¾è¡¨å®ç°" class="headerlink" title="é“¾è¡¨å®ç°"></a>é“¾è¡¨å®ç°</h4><p>é“¾å¼æ ˆçš„å®ç°æˆ‘ä»¬åˆ©ç”¨åŒå‘å¾ªç¯é“¾è¡¨ï¼Œç®€åŒ–æ ˆçš„æ’å…¥æ“ä½œ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// node èŠ‚ç‚¹</span><br><span class="hljs-keyword">type</span> node <span class="hljs-keyword">struct</span> &#123;<br>prev, next *node<br>value      <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-comment">// Stack é“¾å¼æ ˆ</span><br><span class="hljs-keyword">type</span> Stack <span class="hljs-keyword">struct</span> &#123;<br>root *node<br><span class="hljs-built_in">len</span>  <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-comment">// NewStack NewStack</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewStack</span><span class="hljs-params">()</span> *<span class="hljs-title">Stack</span></span> &#123;<br>n := &amp;node&#123;&#125;<br>n.next = n<br>n.prev = n<br><span class="hljs-keyword">return</span> &amp;Stack&#123;root: n&#125;<br>&#125;<br><br><span class="hljs-comment">// Push å…¥æ ˆ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Stack)</span> <span class="hljs-title">Push</span><span class="hljs-params">(item <span class="hljs-keyword">string</span>)</span></span> &#123;<br>n := &amp;node&#123;value: item&#125;<br>s.root.prev.next = n<br>n.prev = s.root.prev<br>n.next = s.root<br>s.root.prev = n<br>s.<span class="hljs-built_in">len</span>++<br>&#125;<br><br><span class="hljs-comment">// Pop å‡ºæ ˆ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Stack)</span> <span class="hljs-title">Pop</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br>item := s.root.prev<br><span class="hljs-keyword">if</span> item == s.root &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>&#125;<br><br>s.root.prev = item.prev<br>item.prev.next = s.root<br><span class="hljs-comment">// é¿å…å†…å­˜æ³„æ¼</span><br>item.prev = <span class="hljs-literal">nil</span><br>item.next = <span class="hljs-literal">nil</span><br>s.<span class="hljs-built_in">len</span>--<br><span class="hljs-keyword">return</span> item.value<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å…¸å‹é—®é¢˜"><a href="#å…¸å‹é—®é¢˜" class="headerlink" title="å…¸å‹é—®é¢˜"></a>å…¸å‹é—®é¢˜</h3><h4 id="å®ç°ä¸€ä¸ªè®¡ç®—å™¨"><a href="#å®ç°ä¸€ä¸ªè®¡ç®—å™¨" class="headerlink" title="å®ç°ä¸€ä¸ªè®¡ç®—å™¨"></a>å®ç°ä¸€ä¸ªè®¡ç®—å™¨</h4><p>æˆ‘ä»¬å®ç°äº†æ”¯æŒ<code>+ã€-ã€*ã€/ã€(ã€)</code>  çš„è®¡ç®—å™¨ï¼Œè¿™ä¹Ÿæ˜¯<a href="https://leetcode-cn.com/problems/basic-calculator/">leetcode#244</a>çš„ä¸€ç§è§£æ³•ï¼Œå¹¶ä¸”æˆ‘ä»¬è¿™ä¸ªå®ç°æ›´åŠ å¤æ‚ï¼ŒåŸé¢˜åªéœ€è¦è®¡ç®—åŠ å‡æ³•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> calculation<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;strconv&quot;</span><br>)<br><br><span class="hljs-comment">// æ“ä½œç¬¦çš„ä¼˜å…ˆçº§</span><br><span class="hljs-keyword">var</span> operatorPriority = <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">int</span>&#123;<br><span class="hljs-string">&quot;+&quot;</span>: <span class="hljs-number">0</span>,<br><span class="hljs-string">&quot;-&quot;</span>: <span class="hljs-number">0</span>,<br><span class="hljs-string">&quot;*&quot;</span>: <span class="hljs-number">1</span>,<br><span class="hljs-string">&quot;/&quot;</span>: <span class="hljs-number">1</span>,<br><span class="hljs-string">&quot;(&quot;</span>: <span class="hljs-number">2</span>,<br><span class="hljs-string">&quot;)&quot;</span>: <span class="hljs-number">2</span>,<br>&#125;<br><br><span class="hljs-comment">// Calculator è®¡ç®—å™¨</span><br><span class="hljs-keyword">type</span> Calculator <span class="hljs-keyword">struct</span> &#123;<br>nums      *StackInt<br>operators *Stack<br>exp       <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-comment">// NewCalculator NewCalculator</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewCalculator</span><span class="hljs-params">(exp <span class="hljs-keyword">string</span>)</span> *<span class="hljs-title">Calculator</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;Calculator&#123;<br>nums:      NewStackInt(),<br>operators: NewStack(),<br>exp:       exp,<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Calculate è·å–è®¡ç®—ç»“æœ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Calculator)</span> <span class="hljs-title">Calculate</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123;<br>l := <span class="hljs-built_in">len</span>(c.exp)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; l; i++ &#123;<br><span class="hljs-keyword">switch</span> e := (c.exp[i]); e &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27; &#x27;</span>:<br><span class="hljs-keyword">continue</span><br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-string">&#x27;4&#x27;</span>, <span class="hljs-string">&#x27;5&#x27;</span>, <span class="hljs-string">&#x27;6&#x27;</span>, <span class="hljs-string">&#x27;7&#x27;</span>, <span class="hljs-string">&#x27;8&#x27;</span>, <span class="hljs-string">&#x27;9&#x27;</span>:<br><span class="hljs-comment">// ä¸€ç›´å¾€åè·å–æ•°å­—ï¼Œå¦‚æœä¸‹ä¸€ä¸ªè¿˜æ˜¯æ•°å­—è¯´æ˜è¿™ä¸€ä¸ªæ•°è¿˜ä¸å®Œæ•´</span><br>j := i<br><span class="hljs-keyword">for</span> j &lt; l &amp;&amp; c.exp[j] &lt;= <span class="hljs-string">&#x27;9&#x27;</span> &amp;&amp; c.exp[j] &gt;= <span class="hljs-string">&#x27;0&#x27;</span> &#123;<br>j++<br>&#125;<br>n, _ := strconv.Atoi(c.exp[i:j])<br>i = j - <span class="hljs-number">1</span><br>c.nums.Push(n)<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;+&#x27;</span>, <span class="hljs-string">&#x27;-&#x27;</span>, <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>:<br><span class="hljs-comment">// ä»è®¡ç®—ç¬¦æ ˆä¸­è·å–æ ˆé¡¶å…ƒç´ ï¼Œå¦‚æœå½“å‰æ“ä½œç¬¦çš„ä¼˜å…ˆçº§ä½äºæ ˆé¡¶å…ƒç´ çš„ä¼˜å…ˆçº§</span><br><span class="hljs-comment">// å¹¶ä¸”æ ˆé¡¶å…ƒç´ ä¸ä¸ºç©ºï¼Œå’Œæ‹¬å·</span><br><span class="hljs-comment">// é‚£ä¹ˆä»æ•°æ®æ ˆä¸­å–ä¸¤ä¸ªæ•°æ®å’Œæ ˆé¡¶æ“ä½œç¬¦è¿›è¡Œè®¡ç®—</span><br>pre := c.operators.Pop()<br><span class="hljs-keyword">for</span> pre != <span class="hljs-string">&quot;&quot;</span> &amp;&amp; pre != <span class="hljs-string">&quot;(&quot;</span> &amp;&amp; operatorPriority[<span class="hljs-keyword">string</span>(e)] &lt;= operatorPriority[pre] &#123;<br>c.nums.Push(c.calc(pre))<br>pre = c.operators.Pop()<br>&#125;<br><span class="hljs-keyword">if</span> pre != <span class="hljs-string">&quot;&quot;</span> &#123;<br>c.operators.Push(pre)<br>&#125;<br>c.operators.Push(<span class="hljs-keyword">string</span>(e))<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;(&#x27;</span>:<br>c.operators.Push(<span class="hljs-keyword">string</span>(e))<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;)&#x27;</span>:<br><span class="hljs-comment">// ç¢°åˆ°å³æ‹¬å·ä¹‹åå°±ä¸€ç›´ä¸æ–­æ“ä½œç¬¦æ ˆä¸­å¼¹å‡ºå…ƒç´ ï¼Œå¹¶ä¸”å–ä¸¤ä¸ªæ•°æ®è¿›è¡Œè®¡ç®—</span><br><span class="hljs-comment">// ç›´åˆ°ç¢°åˆ°å·¦æ‹¬å·ä¸ºæ­¢</span><br><span class="hljs-keyword">for</span> o := c.operators.Pop(); o != <span class="hljs-string">&quot;(&quot;</span> &amp;&amp; o != <span class="hljs-string">&quot;&quot;</span>; o = c.operators.Pop() &#123;<br>c.nums.Push(c.calc(o))<br>&#125;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;invalid exp&quot;</span>)<br>&#125;<br>&#125;<br><span class="hljs-comment">// æœ€åå¦‚æœä¸å­˜åœ¨æ“ä½œç¬¦ï¼Œè¯´æ˜æ•°æ®æ ˆä¸­çš„æ ˆé¡¶å…ƒç´ å°±æ˜¯æœ€åç»“æœ</span><br>o := c.operators.Pop()<br><span class="hljs-keyword">if</span> o == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-keyword">return</span> c.nums.Pop()<br>&#125;<br><span class="hljs-comment">// å¦‚æœå­˜åœ¨ï¼Œå°±æŠŠæœ€åçš„æ•°æ®è¿›è¡Œè®¡ç®—åè¿”å›</span><br><span class="hljs-keyword">return</span> c.calc(o)<br>&#125;<br><br><span class="hljs-comment">// calc å•æ¬¡è®¡ç®—æ“ä½œï¼Œo: è®¡ç®—ç¬¦</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Calculator)</span> <span class="hljs-title">calc</span><span class="hljs-params">(o <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">int</span></span> &#123;<br>b := c.nums.Pop()<br>a := c.nums.Pop()<br><br>fmt.Printf(<span class="hljs-string">&quot;%d %s %d\n&quot;</span>, a, o, b)<br><br><span class="hljs-keyword">switch</span> o &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;+&quot;</span>:<br><span class="hljs-keyword">return</span> a + b<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;-&quot;</span>:<br><span class="hljs-keyword">return</span> a - b<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;*&quot;</span>:<br><span class="hljs-keyword">return</span> a * b<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;/&quot;</span>:<br><span class="hljs-keyword">return</span> a / b<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>&#125;<br><br><span class="hljs-comment">// calculate è®¡ç®—å™¨ï¼Œæ”¯æŒåŠ å‡ä¹˜é™¤</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">calculate</span><span class="hljs-params">(s <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">int</span></span> &#123;<br><span class="hljs-keyword">return</span> NewCalculator(s).Calculate()<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>ç®—æ³•</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>æ•°æ®ç»“æ„</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go Struct åˆå§‹åŒ–é£æ ¼çš„æŠ‰æ‹©</title>
    <link href="/post/go-new-struct-style-select.html"/>
    <url>/post/go-new-struct-style-select.html</url>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>æœ€è¿‘åœ¨å¯¹ä¹‹å‰çš„ä»£ç åšé‡æ„ï¼Œä»ä¹‹å‰çš„ <code>MVC</code>  ç»“æ„åˆ‡æ¢åˆ° <code>Clean Arch</code>  çš„ç»“æ„ï¼Œä½†æ˜¯åœ¨åˆ‡æ¢çš„æ—¶å€™å…³äºä»£ç é£æ ¼å‡ºç°äº†ä¸€äº›å›°æƒ‘<br>åœ¨ä¸‹é¢çš„ä»£ç ä¸­ <code>repository</code>  æ˜¯å­˜å‚¨åº“ï¼Œä¸»è¦ç”¨äºå°è£…æ•°æ®åº“æŸ¥è¯¢æˆ–è€…æ˜¯ç¬¬ä¸‰æ–¹å¾®æœåŠ¡çš„è°ƒç”¨ï¼Œå®ƒå®ç°äº† <code>domain.IAzRepository</code>  æ¥å£ï¼Œå…¶ä»–å±‚çš„ä»£ç éƒ½åªä¾èµ–è¿™ä¸ªæ¥å£è€Œä¸ä¾èµ–å…·ä½“çš„å®ç°</p><h2 id="ä¸‰ç§ä»£ç é£æ ¼"><a href="#ä¸‰ç§ä»£ç é£æ ¼" class="headerlink" title="ä¸‰ç§ä»£ç é£æ ¼"></a>ä¸‰ç§ä»£ç é£æ ¼</h2><h3 id="é£æ ¼ä¸€"><a href="#é£æ ¼ä¸€" class="headerlink" title="é£æ ¼ä¸€"></a>é£æ ¼ä¸€</h3><p>åœ¨ Go ä¸­æˆ‘ä»¬å¸¸å¸¸â€œè¿”å›å®ç°(struct)ï¼Œä¾èµ–æ¥å£â€ï¼Œå…¶å®å°±æ˜¯åœ¨å‡½æ•°è¿”å›çš„æ—¶å€™æˆ‘ä»¬è¿”å›ä¸€ä¸ªå…·ä½“çš„å®ç°ï¼Œå‡½æ•°çš„å‚æ•°æˆ–è€…æ˜¯ Struct çš„æˆå‘˜éƒ¨åˆ†æˆ‘ä»¬ä¾èµ–æ¥å£ï¼Œè¿™ä¸ªé£æ ¼çœ‹èµ·æ¥æ˜¯è¿èƒŒäº†è¿™ä¸ªåŸåˆ™çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// repository å­˜å‚¨åº“</span><br><span class="hljs-keyword">type</span> repository <span class="hljs-keyword">struct</span> &#123;<br>db *gorm.DB<br>&#125;<br><br><span class="hljs-comment">// NewAZRepository NewAZRepository</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewAZRepository</span><span class="hljs-params">(db *gorm.DB)</span> <span class="hljs-title">domain</span>.<span class="hljs-title">IAzRepository</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;repository&#123;db: db&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é£æ ¼äºŒ"><a href="#é£æ ¼äºŒ" class="headerlink" title="é£æ ¼äºŒ"></a>é£æ ¼äºŒ</h3><p>è¿™ä¸ªé£æ ¼è¿”å›äº†å®ç°ï¼Œå¹¶ä¸”ç”±äºå¹¶æ²¡æœ‰å¯¼å‡ºçœ‹èµ·æ¥ä¹Ÿå…·æœ‰å°è£…çš„ç‰¹æ€§ï¼Œä½†æ˜¯å¦‚æœä½ è¿è¡Œ golint ä½ å°±ä¼šå‘ç°ä¼šæŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºè¿™ä¹ˆå†™ï¼Œä¼šå¯¼è‡´æˆ‘ä»¬ç”¨å¯¼å‡ºçš„æ–¹æ³•å°†æ²¡æœ‰å¯¼å‡º struct ç»™æš´éœ²äº†å‡ºå»</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// repository å­˜å‚¨åº“</span><br><span class="hljs-keyword">type</span> repository <span class="hljs-keyword">struct</span> &#123;<br>db *gorm.DB<br>&#125;<br><br><span class="hljs-comment">// NewAZRepository NewAZRepository</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewAZRepository</span><span class="hljs-params">(db *gorm.DB)</span> *<span class="hljs-title">repository</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;repository&#123;db: db&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é£æ ¼ä¸‰"><a href="#é£æ ¼ä¸‰" class="headerlink" title="é£æ ¼ä¸‰"></a>é£æ ¼ä¸‰</h3><p>è¿™ä¸ªå†™æ³•çš„ä¸»è¦é—®é¢˜æ˜¯ï¼Œç”±äº <code>Repository</code>  è¢«å¯¼å‡ºï¼Œæ‰€ä»¥åœ¨å¤–éƒ¨å…¶ä»–çš„åŒ…ä¸­å°±å¯ä»¥ç›´æ¥é€šè¿‡ <code>&amp;Repository&#123;&#125;</code>  è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ ·åˆå§‹åŒ–ä¹‹åä½¿ç”¨å°±ä¼šå¯¼è‡´ panicï¼Œå› ä¸ºæˆå‘˜å‡½æ•°æ˜¯ä¸€ä¸ª nil æŒ‡é’ˆ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Repository å­˜å‚¨åº“</span><br><span class="hljs-keyword">type</span> Repository <span class="hljs-keyword">struct</span> &#123;<br>db *gorm.DB<br>&#125;<br><br><span class="hljs-comment">// NewAZRepository NewAZRepository</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewAZRepository</span><span class="hljs-params">(db *gorm.DB)</span> *<span class="hljs-title">Repository</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;Repository&#123;db: db&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é€‰æ‹©"><a href="#é€‰æ‹©" class="headerlink" title="é€‰æ‹©"></a>é€‰æ‹©</h2><p>é€‰æ‹©æ€»æ˜¯å›°éš¾çš„ï¼Œå¸¦ç€è¿™ä¸ªé—®é¢˜æˆ‘å’¨è¯¢äº†åŒç»„çš„åŒäº‹è¿˜æœ‰å¥½å‡ ä¸ª Go è¯­è¨€äº¤æµç¾¤çš„åŒå­¦ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†éƒ½ä¼šé€‰æ‹©é£æ ¼ä¸‰ï¼Œå°éƒ¨åˆ†ä¼šé€‰æ‹©é£æ ¼ä¸€ï¼Œé£æ ¼äºŒå‡ ä¹æ²¡æœ‰äººé€‰æ‹©ã€‚æœ€åæˆ‘é€‰ä»€ä¹ˆå‘¢ï¼Ÿ<br>æœ€åæˆ‘çš„é€‰æ‹©æ˜¯é£æ ¼ä¸€ï¼Œè¿™æ˜¯é’ˆå¯¹åœºæ™¯æ¥çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„è¿™ä¸ªåŒ…å…¶å®ä¸å¸Œæœ›å…¶ä»–åŒ…ç›´æ¥ä¾èµ–å®ç°ï¼Œå› ä¸ºåç»­æœ‰å¯èƒ½éšç€å‘å±•è¢«å•ç‹¬æ‹†åˆ†æˆä¸€ä¸ªå¾®æœåŠ¡æˆ–è€…æ˜¯éœ€è¦æ›´æ¢å­˜å‚¨åº“ï¼Œå¦‚æœå¤–éƒ¨æœ‰åŒ…ç›´æ¥ä¾èµ– repository ä¼šå¯¼è‡´åç»­çš„é‡æ„æ¯”è¾ƒå›°éš¾<br>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬åœ¨å…¶ä»–åœ°æ–¹ä¸€èˆ¬è¿˜æ˜¯ä¼šé€‰æ‹©é£æ ¼ä¸‰ï¼Œå› ä¸ºç»“æ„ä½“åä¸å¯¼å‡ºï¼Œå¤–éƒ¨å…¶å®æ²¡æœ‰æ¯”è¾ƒå¥½çš„åŠæ³•è¿›è¡Œåˆå§‹åŒ–ï¼Œä¾‹å¦‚æƒ³è¦ <code>var r Repository</code>ï¼Œè‡³äºå‰é¢æåˆ°çš„ç›´æ¥å­—é¢é‡åˆå§‹åŒ–çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»Ÿä¸€ä»£ç é£æ ¼è§£å†³ã€‚</p><blockquote><p>åœ¨<strong>å¤–éƒ¨åŒ…</strong>ä¸­é™¤äº†ç”¨äºå‚æ•°ä¼ é€’çš„ <code>Option</code>  ç»“æ„ä¹‹å¤–ï¼Œå…¶ä½™çš„ä¸å…è®¸ç›´æ¥é€šè¿‡ &amp;XXX{} çš„æ–¹å¼è¿›è¡Œåˆå§‹åŒ–</p></blockquote><p>æœ€åæ„Ÿè°¢çƒ­å¿ƒå›ç­”æˆ‘çš„å›°æƒ‘çš„å°ä¼™ä¼´ä»¬ ğŸ¤—</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>ä»£ç é£æ ¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goæ•°æ®ç»“æ„ä¸ç®—æ³•03-æ•°ç»„ä¸‹: ä½¿ç”¨ GDB è°ƒè¯• Golang ä»£ç </title>
    <link href="/post/array_2.html"/>
    <url>/post/array_2.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go æ•°æ®ç»“æ„ä¸ç®—æ³•ç³»åˆ—æ–‡ç« ï¼Œæœ¬ç³»åˆ—æ–‡ç« ä¸»è¦ä¼šåŒ…æ‹¬å¸¸è§çš„æ•°æ®ç»“æ„ä¸ç®—æ³•å®ç°ï¼ŒåŒæ—¶ä¼šåŒ…æ‹¬ Go æ ‡å‡†åº“ä»£ç çš„åˆ†æç†è§£ï¼Œè®²åˆ°å¯¹åº”ç« èŠ‚çš„æ—¶å€™ä¼˜å…ˆå­¦ä¹ åˆ†æ Go çš„æºç å®ç°ï¼Œä¾‹å¦‚ sliceã€listã€sort ç­‰ï¼Œç„¶åå¯èƒ½ä¼šæœ‰ä¸€äº›å¸¸è§çš„æ¡ˆä¾‹å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/126">æå®¢æ—¶é—´-æ•°æ®ç»“æ„ä¸ç®—æ³•ä¹‹ç¾</a> çš„è¯¾ç¨‹ç¬”è®°</li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“:</strong> <a href="https://github.com/mohuishou/go-algorithm">https://github.com/mohuishou/go-algorithm</a> ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 1 ~ 2 ç¯‡æ–‡ç« ï¼Œé¢„è®¡åˆ° 202101 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°:</strong> <a href="https://github.com/mohuishou">Github</a>ã€<a href="https://zhuanlan.zhihu.com/mohuishou">çŸ¥ä¹</a>ã€<a href="https://lailin.xyz/atom.xml">RSS</a>ã€<a href="https://toutiao.io/subjects/387401?f=new">å¼€å‘è€…å¤´æ¡</a></li><li>ä¸Šä¸€ä¸ªç³»åˆ—åˆšåˆšå®Œæˆäº† <a href="https://lailin.xyz/post/go-design-pattern.html">Go è®¾è®¡æ¨¡å¼</a>ï¼Œå¦‚æœæ„Ÿå…´è¶£ä¹Ÿå¯ä»¥è¿›è¡ŒæŸ¥çœ‹</li></ul><h2 id="é—®é¢˜å›é¡¾"><a href="#é—®é¢˜å›é¡¾" class="headerlink" title="é—®é¢˜å›é¡¾"></a>é—®é¢˜å›é¡¾</h2><p>æœ¬æ–‡ç« ä¸»è¦æ˜¯ä¸ºäº†å›ç­”ä¸Šä¸€ç¯‡æ–‡ç« çš„é—®é¢˜ï¼Œå¹¶ä¸”ä»‹ç»ä¸€ä¸‹åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä»¥åŠåç»­éƒ½ä¼šä½¿ç”¨åˆ°çš„è°ƒè¯•å·¥å…· <code>gdb</code></p><ul><li>è¯·æŸ¥çœ‹ä¸‹é¢ä¸€æ®µä»£ç ï¼Œä¼šè¾“å‡ºä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆï¼Ÿ<ul><li>A: 5 8 B: 8 8 C: 5 5 D: 5 6</li></ul></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>s := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;<br>s = <span class="hljs-built_in">append</span>(s, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)<br>fmt.Println(<span class="hljs-built_in">len</span>(s), <span class="hljs-built_in">cap</span>(s))<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>åœ¨è®²è§£ slice åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œä¸ºä»€ä¹ˆ <code>s2</code> , <code>s3</code> æ‰“å°çš„æ•°ç»„æŒ‡é’ˆéƒ½æ˜¯ <code>0x587450</code> ?</li></ul><h2 id="slice-æ‰©å®¹ç®—æ³•æ˜¯å¦é—æ¼äº†ä»€ä¹ˆï¼Ÿ"><a href="#slice-æ‰©å®¹ç®—æ³•æ˜¯å¦é—æ¼äº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="slice æ‰©å®¹ç®—æ³•æ˜¯å¦é—æ¼äº†ä»€ä¹ˆï¼Ÿ"></a>slice æ‰©å®¹ç®—æ³•æ˜¯å¦é—æ¼äº†ä»€ä¹ˆï¼Ÿ</h2><p>é¦–å…ˆæˆ‘ä»¬å›é¡¾ä¸€ä¸‹ä¸Šä¸€ç¯‡æ–‡ç« å½“ä¸­è®²åˆ°çš„ slice æ‰©å®¹çš„ ç®—æ³•:</p><ul><li>å¦‚æœéœ€è¦çš„æœ€å°å®¹é‡æ¯”ä¸¤å€åŸæœ‰å®¹é‡å¤§ï¼Œé‚£ä¹ˆå°±å–éœ€è¦çš„å®¹é‡</li><li>å¦‚æœåŸæœ‰ slice é•¿åº¦å°äº 1024 é‚£ä¹ˆæ¯æ¬¡å°±æ‰©å®¹ä¸ºåŸæ¥çš„ä¸¤å€</li><li>å¦‚æœåŸ slice å¤§äºç­‰äº 1024 é‚£ä¹ˆæ¯æ¬¡æ‰©å®¹å°±æ‰©ä¸ºåŸæ¥çš„ 1.25 å€</li></ul><p>æŒ‰ç…§è¿™ä¸ªé€»è¾‘è¿›è¡Œå¥—ç”¨:</p><ul><li><code>s</code>  åˆå§‹åŒ–æ—¶ <code>len=2</code></li><li><code>s = append(s, 3, 4, 5)</code>  æ­¤æ—¶éœ€è¦çš„æœ€å°å®¹é‡ä¸º <code>5 &gt; 2*2</code></li><li>æŒ‰ç…§è¿™ä¸ªé€»è¾‘æœ€åçš„ç­”æ¡ˆåº”è¯¥æ˜¯ <code>C: 5 5</code></li><li>ä½†æ˜¯å¦‚æœå¤§å®¶è¿è¡Œè¿‡è¿™æ®µä»£ç åº”è¯¥ä¼šçŸ¥é“è¿™ä¸ªç­”æ¡ˆæ˜¯ <code>D: 5 6</code>  ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™ä¸ªé€»è¾‘å’Œæˆ‘ä»¬ä¹‹å‰äº†è§£åˆ°çš„ä¸å¤ªä¸€æ ·å•Š</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä½¿ç”¨ gdb è°ƒè¯•ä¸€ä¸‹çœ‹çœ‹ç»“æœ</p><h2 id="ä½¿ç”¨-GDB-è°ƒè¯•-Golang-ä»£ç "><a href="#ä½¿ç”¨-GDB-è°ƒè¯•-Golang-ä»£ç " class="headerlink" title="ä½¿ç”¨ GDB è°ƒè¯• Golang ä»£ç "></a>ä½¿ç”¨ GDB è°ƒè¯• Golang ä»£ç </h2><p>è°ƒè¯• go ç¨‹åºæˆ‘ä»¬å¸¸ç”¨çš„è°ƒè¯•å·¥å…·å…¶å®æ˜¯ <a href="https://github.com/go-delve/delve">dlv</a> è¿™ä¸ªå·¥å…·éå¸¸å¥½ç”¨ï¼Œå¹¶ä¸”å¯ä»¥å¾ˆå¥½çš„å’Œ <code>VS Code</code> <code>Goland</code>  ç­‰ IDE è¿›è¡Œç»“åˆï¼Œä½†æ˜¯å®ƒæ— æ³•è°ƒè¯• runtime çš„ä»£ç ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦ä½¿ç”¨ä¸Š gdb äº†ï¼Œå¦‚æœå¤§å®¶ä¸éœ€è¦è°ƒè¯• runtime çš„ä»£ç çš„è¯è¿˜æ˜¯å»ºè®®ä½¿ç”¨ dlv</p><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">brew install gdb <span class="hljs-comment"># for mac</span><br></code></pre></td></tr></table></figure><p>å¦‚æœæ˜¯ linux ä½¿ç”¨è‡ªå¸¦çš„åŒ…ç®¡ç†å·¥å…·è¿›è¡Œå®‰è£…å³å¯<br>æ³¨æ„å®‰è£…å®Œæˆä¹‹åéœ€è¦åœ¨ home ç›®å½•ä¸Šæ·»åŠ ç›¸å…³é…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim ~/.gdbinit<br><br><span class="hljs-comment"># è¾“å…¥ä¸‹é¢</span><br>add-auto-load-safe-path <span class="hljs-variable">$GOROOT</span>/src/runtime/runtime-gdb.py <span class="hljs-comment"># è¿™é‡Œå°† $GOROOT æ›¿æ¢ä¸ºä½ çš„ GO å®‰è£…ç›®å½•</span><br></code></pre></td></tr></table></figure><p>å¦‚æœä½ æ˜¯ mac é¦–æ¬¡å®‰è£… gdb éœ€è¦ç»™ gdb ç­¾åï¼Œå¯ä»¥å‚è€ƒ: <a href="https://gist.github.com/hlissner/898b7dfc0a3b63824a70e15cd0180154">https://gist.github.com/hlissner/898b7dfc0a3b63824a70e15cd0180154</a></p><h3 id="ç¼–è¯‘ä»£ç "><a href="#ç¼–è¯‘ä»£ç " class="headerlink" title="ç¼–è¯‘ä»£ç "></a>ç¼–è¯‘ä»£ç </h3><ul><li>æˆ‘ä»¬ä½¿ç”¨ <code>-gcflags=all=&quot;-N -l&quot;</code>  ç¦ç”¨å†…è”ä¼˜åŒ–æ–¹ä¾¿åé¢è°ƒè¯•</li><li>åœ¨ mac ä¸Šå¦‚æœä¸åŠ  <code>-ldflags=&#39;-compressdwarf=false&#39;</code>  åœ¨ gdb è°ƒè¯•çš„æ—¶å€™å¯èƒ½ä¼šæç¤º <code>No symbol table is loaded. Use the &quot;file&quot; command.</code><ul><li>è¿™æ˜¯å› ä¸ºä¸ºäº†å‡å°‘äºŒè¿›åˆ¶å¤§å°ä¼šé»˜è®¤å‹ç¼© <strong>DWARF</strong> è°ƒè¯•ä¿¡æ¯ï¼Œè¿™ä¸ªåœ¨ mac å’Œ windows ä¸Šéƒ¨åˆ†å·¥å…·ä¸æ”¯æŒï¼Œlinux ä¸€èˆ¬æ²¡æœ‰è¿™ä¸ªé—®é¢˜</li><li>åŠ ä¸Š <code>-ldflags=&#39;-compressdwarf=false&#39;</code> è¿™ä¸ªæ ‡å¿—å¯ä»¥ç¦ç”¨å‹ç¼©æ–¹ä¾¿è°ƒè¯•</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go build -o bin/03_q1_slice_cap -gcflags=all=<span class="hljs-string">&quot;-N -l&quot;</span> -ldflags=<span class="hljs-string">&#x27;-compressdwarf=false&#x27;</span> 02_array/03_q1_slice_cap/main.go<br></code></pre></td></tr></table></figure><h3 id="è¿›å…¥-GDB-è°ƒè¯•çª—å£"><a href="#è¿›å…¥-GDB-è°ƒè¯•çª—å£" class="headerlink" title="è¿›å…¥ GDB è°ƒè¯•çª—å£"></a>è¿›å…¥ GDB è°ƒè¯•çª—å£</h3><ul><li><code>-tui</code>  è¡¨ç¤ºåŒæ—¶æ˜¾ç¤ºä»£ç çª—å£</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gdb -tui ./bin/03_q1_slice_cap<br></code></pre></td></tr></table></figure><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå›è½¦å‡ æ¬¡ä¹‹åå‡ºç° <code>Loading Go Runtime support.</code>  å°±è¯´æ˜æ­£å¸¸äº†<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1605939788051-1d907407-893d-4d1c-bf87-8b9a91dc2905.png" alt="image.png"></p><h3 id="å¸¸ç”¨è°ƒè¯•å‘½ä»¤"><a href="#å¸¸ç”¨è°ƒè¯•å‘½ä»¤" class="headerlink" title="å¸¸ç”¨è°ƒè¯•å‘½ä»¤"></a>å¸¸ç”¨è°ƒè¯•å‘½ä»¤</h3><ul><li><code>b æ–‡ä»¶å:è¡Œæ•°</code>  æ‰“æ–­ç‚¹</li><li><code>info b</code>  å½“å‰çš„æ–­ç‚¹æƒ…å†µ</li><li><code>r</code>  è¿è¡Œç¨‹åºçŸ¥é“æ–­ç‚¹å¤„</li><li><code>c</code>  ç»§ç»­æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹</li><li><code>s</code>  å•æ­¥æ‰§è¡Œï¼Œå¦‚æœæœ‰è°ƒç”¨å‡½æ•°åˆ™è¿›å…¥å‡½æ•°ï¼Œæ³¨æ„å’Œ n çš„åŒºåˆ«</li><li><code>n</code>  å•æ­¥æ‰§è¡Œï¼Œå¦‚æœæœ‰è°ƒç”¨çš„å‡½æ•°ä¸ä¼šè¿›å…¥å‡½æ•°å†…éƒ¨</li><li><code>until</code>  é€€å‡ºå¾ªç¯</li><li><code>until:è¡Œå·</code>  æ‰§è¡Œåˆ°æŒ‡å®šè¡Œ</li><li><code>info locals</code>  å½“å‰å †æ ˆçš„æ‰€æœ‰å˜é‡</li><li><code>info args</code>  æ‰“å°å‚æ•°</li><li><code>info goroutines</code>  æŸ¥çœ‹æ‰€æœ‰çš„ goroutine åŠå…¶ ID</li><li><code>help</code>  å¸®åŠ©</li><li><code>q</code>  é€€å‡º</li></ul><h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>çŸ¥é“å¦‚ä½•æ“ä½œä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹å¹²æ´»</p><ol><li>é¦–å…ˆç»™ append å‡½æ•°æ‰“ä¸€ä¸ªæ–­ç‚¹ <code>b main.go:11</code></li><li>ç„¶åæ‰§è¡Œåˆ°æ–­ç‚¹å¤„ <code>r</code></li><li>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå•æ­¥è¿è¡Œè¿›å…¥åˆ° <code>slice</code>  çš„æ‰©å®¹å‡½æ•°ä¸­ <code>s</code></li></ol><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1605942212393-f3cdd7f9-29a9-47ad-8d6b-f298dcf8a9e9.png" alt="image.png"></p><ol start="4"><li>æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ <code>n</code>  ä¸€ç›´å•æ­¥æ‰§è¡Œåˆ°æ‰©å®¹ç®—æ³•ç»“æŸï¼Œä½¿ç”¨ <code>info locals</code>  æ‰“å°å˜é‡ã€‚æˆ‘ä»¬å¯ä»¥å‘ç°è¿™ä¸ªæ—¶å€™è®¡ç®—å‡ºçš„ <code>newcap</code>  å’Œæˆ‘ä»¬æœ€åˆé¢„è®¡çš„ä¸€æ ·æ˜¯ 5ï¼Œé‚£å“ªé‡Œå‡ºäº†é—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­ä½¿ç”¨ <code>n</code>  æ¥ç€çœ‹</li></ol><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1605942355389-cee6e121-db45-4062-b100-7fc225346368.png" alt="image.png"></p><ol start="5"><li>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ‰§è¡Œåˆ°è¿™é‡Œæˆ‘ä»¬å‘ç°ï¼Œ <code>newcap</code>  è¢«é‡æ–°èµ‹å€¼äº†ï¼Œå¹¶ä¸”è¿™ä¸ªæ—¶å€™ <code>capmem=48</code> <code>PtrSize=8</code>  æ‰€ä»¥æœ€åçš„å‡ºæ¥äº† <code>newcap</code>  ç­‰äº 6</li></ol><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1605942584081-99ee845c-c590-48fe-8736-aafdc6088dbd.png" alt="image.png"><br>çŸ¥é“é—®é¢˜å‡ºç°åœ¨å“ªé‡Œä¹‹åæˆ‘ä»¬å¯ä»¥å†æ¥çœ‹ä¸€ä¸‹æºä»£ç ï¼Œæœ‰ä¸€ä¸ªå†…å­˜å¯¹é½çš„å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Returns size of the memory block that mallocgc will allocate if you ask for the size.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">roundupsize</span><span class="hljs-params">(size <span class="hljs-keyword">uintptr</span>)</span> <span class="hljs-title">uintptr</span></span> &#123;<br><span class="hljs-keyword">if</span> size &lt; _MaxSmallSize &#123;<br><span class="hljs-keyword">if</span> size &lt;= smallSizeMax<span class="hljs-number">-8</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">uintptr</span>(class_to_size[size_to_class8[divRoundUp(size, smallSizeDiv)]])<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">uintptr</span>(class_to_size[size_to_class128[divRoundUp(size-smallSizeMax, largeSizeDiv)]])<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> size+_PageSize &lt; size &#123;<br><span class="hljs-keyword">return</span> size<br>&#125;<br><span class="hljs-keyword">return</span> alignUp(size, _PageSize)<br>&#125;<br><br><span class="hljs-keyword">const</span> (<br>_MaxSmallSize   = <span class="hljs-number">32768</span><br>smallSizeDiv    = <span class="hljs-number">8</span><br>smallSizeMax    = <span class="hljs-number">1024</span><br>largeSizeDiv    = <span class="hljs-number">128</span><br>_NumSizeClasses = <span class="hljs-number">67</span><br>_PageShift      = <span class="hljs-number">13</span><br>)<br><br><span class="hljs-keyword">var</span> class_to_size = [_NumSizeClasses]<span class="hljs-keyword">uint16</span>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">8</span>, <span class="hljs-number">16</span>, <span class="hljs-number">32</span>, <span class="hljs-number">48</span>, <span class="hljs-number">64</span>, <span class="hljs-number">80</span>, <span class="hljs-number">96</span>, <span class="hljs-number">112</span>, ...&#125;<br><span class="hljs-keyword">var</span> class_to_allocnpages = [_NumSizeClasses]<span class="hljs-keyword">uint8</span>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, ...&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°æˆ‘ä»¬ä¹‹å‰åœ¨è®¡ç®— capmem çš„æ—¶å€™ä¼ å…¥çš„ <code>capmem = roundupsize(uintptr(newcap) * sys.PtrSize)</code>  å€¼æ˜¯ <code>5*8=40</code>  æœ€åå¯¹é½å‡ºçš„ç»“æœå°±æ˜¯ <code>48</code>  äº†</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><h3 id="slice-æ‰©å®¹ç®—æ³•"><a href="#slice-æ‰©å®¹ç®—æ³•" class="headerlink" title="slice æ‰©å®¹ç®—æ³•"></a>slice æ‰©å®¹ç®—æ³•</h3><ul><li><strong>å¦‚æœéœ€è¦çš„æœ€å°å®¹é‡æ¯”ä¸¤å€åŸæœ‰å®¹é‡å¤§ï¼Œé‚£ä¹ˆå°±å–éœ€è¦çš„å®¹é‡</strong></li><li>å¦‚æœåŸæœ‰ slice é•¿åº¦å°äº 1024 é‚£ä¹ˆæ¯æ¬¡å°±æ‰©å®¹ä¸ºåŸæ¥çš„ä¸¤å€</li><li>å¦‚æœåŸ slice å¤§äºç­‰äº 1024 é‚£ä¹ˆæ¯æ¬¡æ‰©å®¹å°±æ‰©ä¸ºåŸæ¥çš„ 1.25 å€</li><li><strong>é™¤æ­¤ä¹‹å¤–æ‰©å®¹å®¹é‡è®¡ç®—å®Œæˆä¹‹åï¼Œè¿˜ä¼šè¿›è¡Œä¸€æ¬¡å†…å­˜å¯¹é½æ“ä½œ</strong></li></ul><p>æœç´¢ slice æ‰©å®¹ç­–ç•¥å¾ˆå¤šéƒ½ä¼šè¯´ç¬¬ 2ã€3 ç‚¹ä½†æ˜¯æ²¡æœ‰è¯´ 1, 4 ç‚¹å°±ä¼šé€ æˆä¸€äº›å›°æƒ‘</p><h3 id="GDB-è°ƒè¯•"><a href="#GDB-è°ƒè¯•" class="headerlink" title="GDB è°ƒè¯•"></a>GDB è°ƒè¯•</h3><ul><li>mac ä¸‹å®‰è£…ä½¿ç”¨ gdb æ¯”è¾ƒéº»çƒ¦ï¼Œå»ºè®®ä½¿ç”¨ linux</li><li>ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬è¿˜æ˜¯å»ºè®®ä½¿ç”¨ dlv è¿›è¡Œè°ƒè¯•ï¼Œå¦‚æœæœ‰ runtime åº“çš„è°ƒè¯•éœ€æ±‚å¯ä»¥ä½¿ç”¨ gdb</li><li>å­¦ä¹ äº† gdb çš„å®‰è£…ä»¥åŠåŸºæœ¬ä½¿ç”¨æ–¹å¼ï¼Œä½ ä¹‹å‰æœ‰ç±»ä¼¼çš„ç»å†ä¹ˆï¼Ÿä¸€èˆ¬ä¼šåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨ gdb è¿›è¡Œè°ƒè¯•</li></ul><h3 id="é—®é¢˜-2-è§£ç­”-åœ¨è®²è§£-slice-åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œä¸ºä»€ä¹ˆ-s2-s3-æ‰“å°çš„æ•°ç»„æŒ‡é’ˆéƒ½æ˜¯-0x587450"><a href="#é—®é¢˜-2-è§£ç­”-åœ¨è®²è§£-slice-åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œä¸ºä»€ä¹ˆ-s2-s3-æ‰“å°çš„æ•°ç»„æŒ‡é’ˆéƒ½æ˜¯-0x587450" class="headerlink" title="é—®é¢˜ 2 è§£ç­”: åœ¨è®²è§£ slice åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œä¸ºä»€ä¹ˆ s2 , s3 æ‰“å°çš„æ•°ç»„æŒ‡é’ˆéƒ½æ˜¯ 0x587450 ?"></a>é—®é¢˜ 2 è§£ç­”: åœ¨è®²è§£ slice åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œä¸ºä»€ä¹ˆ <code>s2</code> , <code>s3</code> æ‰“å°çš„æ•°ç»„æŒ‡é’ˆéƒ½æ˜¯ <code>0x587450</code> ?</h3><p>åœ¨è®²è§£ <code>makeslice</code>  çš„æ—¶å€™æˆ‘ä»¬æœ‰è¯´åˆ°æœ€åä¸€æ­¥ä¼šè°ƒç”¨ <code>mallocgc</code>  åˆ†é…å†…å­˜ï¼Œçœ‹è¿™ä¸ªå‡½æ•°çš„æºç æˆ‘ä»¬å°±èƒ½å‘ç°ï¼Œæœ‰ä¸€æ­¥åˆ¤æ–­ï¼Œå¦‚æœå®¹é‡ä¸º 0 ä¼šè¿”å›ä¸€ä¸ªå›ºå®šçš„åœ°å€</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> size == <span class="hljs-number">0</span> &#123;<br>    <span class="hljs-keyword">return</span> unsafe.Pointer(&amp;zerobase)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>ç®—æ³•</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>æ•°æ®ç»“æ„</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goæ•°æ®ç»“æ„ä¸ç®—æ³•02-æ•°ç»„ä¸Š: æ·±å…¥ç†è§£ slice</title>
    <link href="/post/array.html"/>
    <url>/post/array.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go æ•°æ®ç»“æ„ä¸ç®—æ³•ç³»åˆ—æ–‡ç« ï¼Œæœ¬ç³»åˆ—æ–‡ç« ä¸»è¦ä¼šåŒ…æ‹¬å¸¸è§çš„æ•°æ®ç»“æ„ä¸ç®—æ³•å®ç°ï¼ŒåŒæ—¶ä¼šåŒ…æ‹¬ Go æ ‡å‡†åº“ä»£ç çš„åˆ†æç†è§£ï¼Œè®²åˆ°å¯¹åº”ç« èŠ‚çš„æ—¶å€™ä¼˜å…ˆå­¦ä¹ åˆ†æ Go çš„æºç å®ç°ï¼Œä¾‹å¦‚ sliceã€listã€sort ç­‰ï¼Œç„¶åå¯èƒ½ä¼šæœ‰ä¸€äº›å¸¸è§çš„æ¡ˆä¾‹å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/126">æå®¢æ—¶é—´-æ•°æ®ç»“æ„ä¸ç®—æ³•ä¹‹ç¾</a> çš„è¯¾ç¨‹ç¬”è®°</li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“:</strong> <a href="https://github.com/mohuishou/go-algorithm">https://github.com/mohuishou/go-algorithm</a> ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 1 ~ 2 ç¯‡æ–‡ç« ï¼Œé¢„è®¡åˆ° 202101 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°:</strong> <a href="https://github.com/mohuishou">Github</a>ã€<a href="https://zhuanlan.zhihu.com/mohuishou">çŸ¥ä¹</a>ã€<a href="https://lailin.xyz/atom.xml">RSS</a>ã€<a href="https://toutiao.io/subjects/387401?f=new">å¼€å‘è€…å¤´æ¡</a></li><li>ä¸Šä¸€ä¸ªç³»åˆ—åˆšåˆšå®Œæˆäº† <a href="https://lailin.xyz/post/go-design-pattern.html">Go è®¾è®¡æ¨¡å¼</a>ï¼Œå¦‚æœæ„Ÿå…´è¶£ä¹Ÿå¯ä»¥è¿›è¡ŒæŸ¥çœ‹</li></ul><h2 id="ä¸ŠæœŸç­”æ¡ˆ"><a href="#ä¸ŠæœŸç­”æ¡ˆ" class="headerlink" title="ä¸ŠæœŸç­”æ¡ˆ"></a>ä¸ŠæœŸç­”æ¡ˆ</h2><h3 id="Q-é€šè¿‡-Element-èŠ‚ç‚¹ä¸­çš„-List-ç»“æ„æ¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å±äºå½“å‰é“¾è¡¨çš„æ–¹å¼ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šå‡ºç°-bug"><a href="#Q-é€šè¿‡-Element-èŠ‚ç‚¹ä¸­çš„-List-ç»“æ„æ¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å±äºå½“å‰é“¾è¡¨çš„æ–¹å¼ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šå‡ºç°-bug" class="headerlink" title="Q: é€šè¿‡ Element èŠ‚ç‚¹ä¸­çš„ List ç»“æ„æ¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å±äºå½“å‰é“¾è¡¨çš„æ–¹å¼ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šå‡ºç°  bug"></a>Q: é€šè¿‡ Element èŠ‚ç‚¹ä¸­çš„ List ç»“æ„æ¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å±äºå½“å‰é“¾è¡¨çš„æ–¹å¼ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šå‡ºç°  <code>bug</code></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">l := list.List&#123;&#125;<br>e := l.PushBack(<span class="hljs-number">10</span>)<br><br>l = list.List&#123;&#125;<br>l.Remove(e)<br>fmt.Println(<span class="hljs-string">&quot;list len: &quot;</span>, l.Len())<br></code></pre></td></tr></table></figure><p>æ¥ç€çœ‹ä¸‹é¢ä¹‹å‰ï¼Œå…ˆæƒ³ä¸€æƒ³ï¼Œä½ è§‰å¾—è¿™æ®µä»£ç ä¼šè¾“å‡ºä»€ä¹ˆï¼Ÿ<br>è¿™ä¸ªé—®é¢˜æ¥è‡ª: <a href="https://github.com/golang/go/issues/39014">https://github.com/golang/go/issues/39014</a><br>è¿™æ®µä»£ç ä¼šè¾“å‡º -1ï¼Œä½†æ˜¯æˆ‘ä»¬æœŸæœ›çš„ä¸åº”è¯¥æ˜¯è¾“å‡º 0 ä¹ˆï¼Ÿ<br>æˆ‘ä»¬æ¥çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1605409586875-e7ef8b69-b95a-4fb8-9d6a-27f33f8f689c.svg" alt="01_é“¾è¡¨.drawio.svg"></p><ul><li>å½“æˆ‘ä»¬æ‰§è¡Œå®Œ <code>l.PushBack(10)</code>  è¿™æ®µä»£ç ç›´æ¥ï¼Œå°±å¦‚å·¦å›¾æ‰€ç¤ºäº†ï¼ŒèŠ‚ç‚¹ e æŒ‡å‘äº†é“¾è¡¨ lï¼Œé“¾è¡¨ l çš„å€¼çš„é•¿åº¦æ˜¯ 1</li><li>ä½†æ˜¯å½“æˆ‘ä»¬æ‰§è¡Œå®Œ <code>l = list.List&#123;&#125;</code>  æˆ‘ä»¬é‡ç½®äº†é“¾è¡¨ l çš„å€¼ï¼Œå¹¶æ²¡æœ‰ä¿®æ”¹ä»–çš„åœ°å€ï¼Œæ‰€ä»¥ e è¿˜æ˜¯æŒ‡å‘çš„é“¾è¡¨ lï¼Œå½“æ‰§è¡Œ <code>Remove</code>  æ–¹æ³•çš„æ—¶å€™ï¼Œe çš„é“¾è¡¨å’Œå½“å‰æ‰§è¡Œçš„ l çš„åœ°å€åˆ¤æ–­æ˜¯å¯ä»¥å¯¹åº”çš„ä¸Šçš„ï¼Œä½†æ˜¯å®é™…ä¸Šé“¾è¡¨çš„å€¼å·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼Œé“¾è¡¨çš„é•¿åº¦å·²ç»ä¸ä¸º 1 çš„ï¼Œå¹¶ä¸”æ–°çš„é“¾è¡¨çš„æ ¹èŠ‚ç‚¹ä¹Ÿæ²¡æœ‰æŒ‡å‘ e</li><li>æ‰€ä»¥æœ€åå¾—åˆ°çš„é•¿åº¦æ‰æ˜¯ -1</li><li>æœ€åç»†å¿ƒçš„åŒå­¦åº”è¯¥å·²ç»å‘ç°ï¼Œè¿™é‡Œå…¶å®è¿˜å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œå…ƒç´  e -&gt; root(0x2) å…¶å®å·²ç»æ²¡æœ‰ç”¨åˆ°äº†</li></ul><h2 id="ä»€ä¹ˆæ˜¯æ•°ç»„ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯æ•°ç»„ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯æ•°ç»„ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯æ•°ç»„ï¼Ÿ</h2><ul><li>æ•°ç»„å¤§å®¶åº”è¯¥éƒ½éå¸¸å±æ€§æˆ‘ä»¬æ¥ç®€å•çš„å›é¡¾ä¸€ä¸‹</li><li>æ•°ç»„æ˜¯ä¸€ä¸ªå…·æœ‰è¿ç»­çš„å†…å­˜ç©ºé—´å’Œç›¸åŒç±»å‹çš„æ•°æ®çš„æ•°æ®ç»“æ„</li><li>æˆ‘ä»¬éšæœºè®¿é—®ä»»æ„ä¸€ä¸ªä¸‹æ ‡çš„æ•°æ®çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(1)</li><li>ä½†æ˜¯æ­£æ˜¯ç”±äºè¿™ç§ç‰¹æ€§ï¼Œå¯¼è‡´å®ƒæ’å…¥å’Œåˆ é™¤å…ƒç´ çš„æ•ˆç‡æ¯”è¾ƒä½ï¼Œæ˜¯ O(n)</li></ul><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1605409904549-b00a01d7-340f-4101-9e11-cdcea25528e1.svg" alt="01_array.drawio.svg"></p><h2 id="Go-ä¸­çš„æ•°ç»„"><a href="#Go-ä¸­çš„æ•°ç»„" class="headerlink" title="Go ä¸­çš„æ•°ç»„"></a>Go ä¸­çš„æ•°ç»„</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// åˆå§‹åŒ–æ•°ç»„</span><br><span class="hljs-keyword">var</span> arr = [<span class="hljs-number">3</span>]<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;<br><span class="hljs-comment">// æŸ¥æ‰¾å…ƒç´ </span><br>fmt.Printf(<span class="hljs-string">&quot;arr[1]: %d\n&quot;</span>, arr[<span class="hljs-number">1</span>])<br><span class="hljs-comment">// åˆ é™¤å…ƒç´ </span><br>remove(&amp;arr, <span class="hljs-number">2</span>)<br><span class="hljs-comment">// remove(&amp;arr, 3) // will panic</span><br>fmt.Println(arr)<br>&#125;<br><br><span class="hljs-comment">// åˆ é™¤æ•°ç»„ arr çš„æŸä¸ªå…ƒç´ </span><br><span class="hljs-comment">// index ä¸ºéœ€è¦åˆ é™¤çš„ç´¢å¼•</span><br><span class="hljs-comment">// ä»éœ€è¦åˆ é™¤çš„å…ƒç´ å¼€å§‹ï¼Œä¾æ¬¡å°†åé¢çš„å…ƒç´ å¾€å‰ç§»åŠ¨ä¸€ä½å³å¯</span><br><span class="hljs-comment">// ç„¶åå°†æœ€åä¸€ä½ä¿®æ”¹ä¸ºè¯¥ç±»å‹çš„é»˜è®¤å€¼</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">remove</span><span class="hljs-params">(arr *[3]<span class="hljs-keyword">int</span>, index <span class="hljs-keyword">int</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> index &gt;= <span class="hljs-built_in">len</span>(arr) &#123;<br>log.Panicf(<span class="hljs-string">&quot;%d remove out range arr&quot;</span>, index)<br>&#125;<br><span class="hljs-keyword">for</span> i := index; i &lt; <span class="hljs-built_in">len</span>(arr)<span class="hljs-number">-1</span>; i++ &#123;<br>arr[i] = arr[i+<span class="hljs-number">1</span>]<br>&#125;<br>arr[<span class="hljs-built_in">len</span>(arr)<span class="hljs-number">-1</span>] = <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Q-ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨-remove-å‡½æ•°å½“ä¸­çš„å‚æ•°ä½¿ç”¨çš„æ˜¯æŒ‡é’ˆ"><a href="#Q-ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨-remove-å‡½æ•°å½“ä¸­çš„å‚æ•°ä½¿ç”¨çš„æ˜¯æŒ‡é’ˆ" class="headerlink" title="Q: ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ remove å‡½æ•°å½“ä¸­çš„å‚æ•°ä½¿ç”¨çš„æ˜¯æŒ‡é’ˆ"></a>Q: ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ remove å‡½æ•°å½“ä¸­çš„å‚æ•°ä½¿ç”¨çš„æ˜¯æŒ‡é’ˆ</h3><p>è¿™æ˜¯å› ä¸ºåœ¨ go ä¸­å‚æ•°çš„ä¼ é€’éƒ½æ˜¯å€¼ä¼ é€’ï¼Œå¦‚æœä¸ç”¨æŒ‡é’ˆçš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå¤åˆ¶ä¸€ä»½æ•°æ®åˆ°å‡½æ•°ä¸­ï¼Œè¿™æ ·å°±æ— æ³•åšåˆ°åˆ é™¤çš„ä½œç”¨</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åœ¨å‡½æ•° main ä¸­</span><br>fmt.Printf(<span class="hljs-string">&quot;main: %p --&gt; %+v\n&quot;</span>, &amp;arr, arr)<br>p(arr)<br>p2(&amp;arr)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">p</span><span class="hljs-params">(arr [3]<span class="hljs-keyword">int</span>)</span></span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;p: %p --&gt; %+v\n&quot;</span>, &amp;arr, arr)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">p2</span><span class="hljs-params">(arr *[3]<span class="hljs-keyword">int</span>)</span></span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;p2: %p --&gt; %+v\n&quot;</span>, arr, arr)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡º:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">main: <span class="hljs-number">0xc0000c2000</span> --&gt; [<span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">0</span>]<br>p: <span class="hljs-number">0xc0000c2080</span> --&gt; [<span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">0</span>]<br>p2: <span class="hljs-number">0xc0000c2000</span> --&gt; &amp;[<span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å°±å¯ä»¥å‘ç°ï¼Œåœ¨å‡½æ•° p ä¸­æˆ‘ä»¬ç›´æ¥ä¼ é€’çš„æ•°ç»„ï¼Œæœ€åæ‰“å°çš„å˜é‡åœ°å€æ˜¯å’Œ main ä¸­ä¸åŒçš„ï¼Œå°±å°è¯äº†æˆ‘ä»¬ä¹‹å‰çš„è¯´æ³•<br>åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å…¶å®æ˜¯å¾ˆå°‘ä½¿ç”¨åˆ°å›ºå®šé•¿åº¦çš„æ•°ç»„çš„ï¼Œè€Œæ˜¯ä½¿ç”¨å¯ä»¥è‡ªåŠ¨æ‰©å®¹çš„ sliceï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ·±å…¥çš„çœ‹ä¸€ä¸‹ slice å½“ä¸­çš„ä¸€äº›ç»†èŠ‚</p><h2 id="æ·±å…¥ç†è§£-Slice"><a href="#æ·±å…¥ç†è§£-Slice" class="headerlink" title="æ·±å…¥ç†è§£ Slice"></a>æ·±å…¥ç†è§£ Slice</h2><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><h4 id="åŸºç¡€ä½¿ç”¨"><a href="#åŸºç¡€ä½¿ç”¨" class="headerlink" title="åŸºç¡€ä½¿ç”¨"></a>åŸºç¡€ä½¿ç”¨</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åˆå§‹åŒ–</span><br>s1 := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-number">2</span>)<br>fmt.Printf(<span class="hljs-string">&quot;s1(%p): %v, len: %d, cap: %d\n&quot;</span>, &amp;s1, s1, <span class="hljs-built_in">len</span>(s1), <span class="hljs-built_in">cap</span>(s1))<br><span class="hljs-comment">// s1(0xc00000c080): [0 0], len: 2, cap: 2</span><br><br><span class="hljs-comment">// èµ‹å€¼</span><br>s1[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span><br>s1[<span class="hljs-number">1</span>] = <span class="hljs-number">2</span><br>fmt.Printf(<span class="hljs-string">&quot;s1(%p): %v, len: %d, cap: %d\n&quot;</span>, &amp;s1, s1, <span class="hljs-built_in">len</span>(s1), <span class="hljs-built_in">cap</span>(s1))<br><span class="hljs-comment">//s1(0xc00000c080): [1 2], len: 2, cap: 2</span><br><br><span class="hljs-comment">// æ‰©å®¹</span><br>s1 = <span class="hljs-built_in">append</span>(s1, <span class="hljs-number">3</span>)<br>fmt.Printf(<span class="hljs-string">&quot;s1(%p): %v, len: %d, cap: %d\n&quot;</span>, &amp;s1, s1, <span class="hljs-built_in">len</span>(s1), <span class="hljs-built_in">cap</span>(s1))<br><span class="hljs-comment">// s1(0xc00000c080): [1 2 3], len: 3, cap: 4</span><br><br><span class="hljs-comment">// åˆ é™¤å…ƒç´ </span><br>s1 = <span class="hljs-built_in">append</span>(s1[:<span class="hljs-number">1</span>], s1[<span class="hljs-number">2</span>:]...)<br>fmt.Printf(<span class="hljs-string">&quot;s1(%p): %v, len: %d, cap: %d\n&quot;</span>, &amp;s1, s1, <span class="hljs-built_in">len</span>(s1), <span class="hljs-built_in">cap</span>(s1))<br><span class="hljs-comment">// s1(0xc00000c080): [1 3], len: 2, cap: 4</span><br></code></pre></td></tr></table></figure><ul><li>å¯ä»¥å‘ç°ï¼Œé€šè¿‡ append ä¹‹å s1 çš„å®¹é‡å’Œé•¿åº¦éƒ½å‘ç”Ÿäº†å˜åŒ–ï¼Œè¯´æ˜å®Œæˆäº†è‡ªåŠ¨æ‰©å®¹</li><li>åˆ é™¤å…ƒç´ ä¹‹åæˆ‘ä»¬çš„é•¿åº¦å‘ç”Ÿäº†å˜åŒ–ï¼Œä½†æ˜¯å®¹é‡è¿˜æ˜¯åŸæœ¬ä¸å˜</li></ul><h4 id="å¸¸è§å‘"><a href="#å¸¸è§å‘" class="headerlink" title="å¸¸è§å‘"></a>å¸¸è§å‘</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å¤åˆ¶ä¸€ä¸ª slice</span><br>s2 := s1[:<span class="hljs-number">2</span>]<br>fmt.Printf(<span class="hljs-string">&quot;s2(%p): %v, len: %d, cap: %d\n&quot;</span>, &amp;s2, s2, <span class="hljs-built_in">len</span>(s2), <span class="hljs-built_in">cap</span>(s2))<br><span class="hljs-comment">// s2(0xc00000c120): [1 3], len: 2, cap: 4</span><br><br>s1[<span class="hljs-number">0</span>] = <span class="hljs-number">10</span> <span class="hljs-comment">// è¿™é‡Œå¯ä»¥å‘ç°ï¼Œs1[0] s2[0] éƒ½è¢«ä¿®æ”¹ä¸ºäº† 10</span><br>fmt.Printf(<span class="hljs-string">&quot;s1(%p): %v, len: %d, cap: %d\n&quot;</span>, &amp;s1, s1, <span class="hljs-built_in">len</span>(s1), <span class="hljs-built_in">cap</span>(s1))<br><span class="hljs-comment">// s1(0xc00000c080): [10 3], len: 2, cap: 4</span><br>fmt.Printf(<span class="hljs-string">&quot;s2(%p): %v, len: %d, cap: %d\n&quot;</span>, &amp;s2, s2, <span class="hljs-built_in">len</span>(s2), <span class="hljs-built_in">cap</span>(s2))<br><span class="hljs-comment">// s2(0xc00000c120): [10 3], len: 2, cap: 4</span><br><br>s1 = <span class="hljs-built_in">append</span>(s1, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>)<br>s1[<span class="hljs-number">0</span>] = <span class="hljs-number">11</span> <span class="hljs-comment">// è¿™é‡Œå¯ä»¥å‘ç°ï¼Œs1[0] è¢«ä¿®æ”¹ä¸ºäº† 11, s2[0] è¿˜æ˜¯10</span><br>fmt.Printf(<span class="hljs-string">&quot;s1(%p): %v, len: %d, cap: %d\n&quot;</span>, &amp;s1, s1, <span class="hljs-built_in">len</span>(s1), <span class="hljs-built_in">cap</span>(s1))<br><span class="hljs-comment">// s1(0xc00011c020): [11 3 5 6 7 8], len: 6, cap: 8</span><br>fmt.Printf(<span class="hljs-string">&quot;s2(%p): %v, len: %d, cap: %d\n&quot;</span>, &amp;s2, s2, <span class="hljs-built_in">len</span>(s2), <span class="hljs-built_in">cap</span>(s2))<br><span class="hljs-comment">// s2(0xc00011c0c0): [10 3], len: 2, cap: 4</span><br></code></pre></td></tr></table></figure><ul><li>è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„ä¾‹å­ï¼Œæˆ‘ä»¬ä» s1 å¤åˆ¶äº†ä¸€ä¸ª s2</li><li>ä¿®æ”¹ s1 çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¹‹åï¼Œs2 çš„ä¸€ä¸ªå…ƒç´ ä¹Ÿè¢«ä¿®æ”¹äº†</li><li>ä½†æ˜¯æˆ‘ä»¬è§¦å‘äº† s1 çš„è‡ªåŠ¨æ‰©å®¹ä¹‹åï¼Œs2 çš„ç¬¬ä¸€ä¸ªå…ƒç´ å°±ä¸ä¼šéšç€ s1 çš„ä¿®æ”¹è€Œå˜åŒ–äº†</li><li>è¿™ä¹Ÿæ˜¯å½“å‡½æ•°çš„å‚æ•°æ˜¯ slice æ—¶æˆ‘ä»¬ä¸å…è®¸ç›´æ¥ä¿®æ”¹ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹éœ€è¦è¿”å›è¿™ä¸ª slice çš„åŸå› ï¼Œå› ä¸ºå‡½æ•°çš„å‚æ•°ä¹Ÿæ˜¯å€¼çš„å¤åˆ¶</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sliceChange</span><span class="hljs-params">(s []<span class="hljs-keyword">int</span>)</span></span> &#123;<br><span class="hljs-comment">// ä¸å…è®¸ç›´æ¥è¿™ä¹ˆæ“ä½œ</span><br>s[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h3><p>å¤§å®¶å¦‚æœä½¿ç”¨è¿‡ä¸€æ®µæ—¶é—´ golang åº”è¯¥çŸ¥é“ slice çš„åº•å±‚ç»“æ„å…¶å®æ˜¯ä¸€ä¸ª struct<br><a href="https://github.com/golang/go/blob/go1.15/src/runtime/slice.go">https://github.com/golang/go/blob/go1.15/src/runtime/slice.go</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> slice <span class="hljs-keyword">struct</span> &#123;<br>array unsafe.Pointer<br><span class="hljs-built_in">len</span>   <span class="hljs-keyword">int</span><br><span class="hljs-built_in">cap</span>   <span class="hljs-keyword">int</span><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1605449197795-9ca02de7-b129-4f7c-a0c3-930798b881c0.svg" alt="02_slice_struct.drawio.svg"></p><ul><li>å¦‚å›¾æ‰€ç¤ºæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œslice çš„åº•å±‚ç»“æ„æ˜¯ä¸€ä¸ªç»“æ„ä½“<ul><li>å®ƒåŒ…å«äº†ä¸€ä¸ªæŒ‡å‘ä¸€ä¸ªæ•°ç»„çš„æŒ‡é’ˆï¼Œæ•°æ®å®é™…ä¸Šå­˜å‚¨åœ¨è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„æ•°ç»„ä¸Š</li><li>len è¡¨ç¤ºå½“å‰ slice ä½¿ç”¨åˆ°çš„é•¿åº¦</li><li>cap è¡¨ç¤ºå½“å‰ slice çš„å®¹é‡ï¼ŒåŒæ—¶ä¹Ÿæ˜¯åº•å±‚æ•°ç»„ array çš„é•¿åº¦</li></ul></li><li>è¿™ä¹Ÿå°±å›ç­”äº†æˆ‘ä»¬ä¸Šé¢çš„å‘ç°çš„ç°è±¡ï¼Œåœ¨å¤åˆ¶ slice çš„æ—¶å€™ï¼Œslice ä¸­æ•°ç»„çš„æŒ‡é’ˆä¹Ÿè¢«å¤åˆ¶äº†ï¼Œåœ¨å‡ºå‘æ‰©å®¹é€»è¾‘ä¹‹å‰ï¼Œä¸¤ä¸ª slice æŒ‡å‘çš„æ˜¯ç›¸åŒçš„æ•°ç»„ï¼Œå‡ºå‘æ‰©å®¹é€»è¾‘ä¹‹åæŒ‡å‘çš„å°±æ˜¯ä¸åŒçš„æ•°ç»„äº†</li><li>åŒæ—¶å› ä¸ºç»“æ„ä½“ä¸­ array æ˜¯ä¸€ä¸ªæŒ‡é’ˆæ‰€ä»¥åœ¨ slice ä½œä¸ºå‚æ•°ä¼ é€’çš„æ—¶å€™ï¼Œè¿™ä¸ªæŒ‡é’ˆä¹Ÿä¼šè¢«å¤åˆ¶ä¸€ä»½ï¼Œæ‰€ä»¥ä¹Ÿä¼šæœ‰ç›¸åŒçš„é—®é¢˜</li></ul><h3 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ª slice</span><br><span class="hljs-comment">// et: æ•°æ®çš„ç±»å‹</span><br><span class="hljs-comment">// len: slice é•¿åº¦</span><br><span class="hljs-comment">// cap: slice å®¹é‡</span><br><span class="hljs-comment">// è¿”å›ä¸€ä¸ªæŒ‡é’ˆ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">makeslice</span><span class="hljs-params">(et *_type, <span class="hljs-built_in">len</span>, <span class="hljs-built_in">cap</span> <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">unsafe</span>.<span class="hljs-title">Pointer</span></span> &#123;<br>    <span class="hljs-comment">// é€šè¿‡ cap è®¡ç®—å½“å‰ç±»å‹çš„ slice éœ€è¦çš„å†…å­˜å®¹é‡ä»¥åŠæ˜¯å¦è¶…å‡ºæœ€å¤§å®¹é‡</span><br>mem, overflow := math.MulUintptr(et.size, <span class="hljs-keyword">uintptr</span>(<span class="hljs-built_in">cap</span>))<br>    <span class="hljs-comment">// å¼‚å¸¸æƒ…å†µåˆ¤æ–­</span><br><span class="hljs-keyword">if</span> overflow || mem &gt; maxAlloc || <span class="hljs-built_in">len</span> &lt; <span class="hljs-number">0</span> || <span class="hljs-built_in">len</span> &gt; <span class="hljs-built_in">cap</span> &#123;<br><span class="hljs-comment">// é€šè¿‡ len è®¡ç®—å½“å‰ç±»å‹çš„ slice éœ€è¦çš„å†…å­˜å®¹é‡ä»¥åŠæ˜¯å¦è¶…å‡ºæœ€å¤§å®¹é‡</span><br>        <span class="hljs-comment">// å¦‚æœæ˜¯ len è¶…è¿‡é™åˆ¶åˆ™æŠ›å‡º len çš„ç›¸å…³å¼‚å¸¸ï¼Œå¦åˆ™æŠ›å‡º cap å¼‚å¸¸</span><br>mem, overflow := math.MulUintptr(et.size, <span class="hljs-keyword">uintptr</span>(<span class="hljs-built_in">len</span>))<br><span class="hljs-keyword">if</span> overflow || mem &gt; maxAlloc || <span class="hljs-built_in">len</span> &lt; <span class="hljs-number">0</span> &#123;<br>panicmakeslicelen()<br>&#125;<br>panicmakeslicecap()<br>&#125;<br><br><span class="hljs-keyword">return</span> mallocgc(mem, et, <span class="hljs-literal">true</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ä¸ª 64 ä½çš„</p><ul><li>64 ä½å¯¹æ¯”é»˜è®¤çš„åªæ˜¯è¿›è¡Œäº†ä¸€ä¸‹æ•°æ®æ ¼å¼è½¬æ¢ï¼Œä½†æ˜¯è¿™ä¸ªè½¬æ¢çš„å¯¹æ¯”è¿˜æ˜¯å¾ˆæœ‰æ„æ€çš„</li><li>å¦‚æœæ˜¯åœ¨ 64 ä½çš„æœºå™¨ä¸Šï¼Œé‚£ä¹ˆ int == int64 çš„</li><li>å¦‚æœæ˜¯åœ¨ 32 ä½çš„æœºå™¨ä¸Šï¼Œé‚£ä¹ˆ int == int32ï¼Œå¦‚æœ int64(int(len64)) != len64ï¼Œé‚£ä¹ˆå°±è¯´æ˜è¿™ä¸ªé•¿åº¦è¶…å‡ºäº†å½“å‰æœºå™¨çš„å†…å­˜ä½æ•°ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸é”™è¯¯å°±å¥½äº†</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">makeslice64</span><span class="hljs-params">(et *_type, len64, cap64 <span class="hljs-keyword">int64</span>)</span> <span class="hljs-title">unsafe</span>.<span class="hljs-title">Pointer</span></span> &#123;<br><span class="hljs-built_in">len</span> := <span class="hljs-keyword">int</span>(len64)<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">int64</span>(<span class="hljs-built_in">len</span>) != len64 &#123;<br>panicmakeslicelen()<br>&#125;<br><br><span class="hljs-built_in">cap</span> := <span class="hljs-keyword">int</span>(cap64)<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">int64</span>(<span class="hljs-built_in">cap</span>) != cap64 &#123;<br>panicmakeslicecap()<br>&#125;<br><br><span class="hljs-keyword">return</span> makeslice(et, <span class="hljs-built_in">len</span>, <span class="hljs-built_in">cap</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ‰©å®¹"><a href="#æ‰©å®¹" class="headerlink" title="æ‰©å®¹"></a>æ‰©å®¹</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å½“ append éœ€è¦æ‰©å®¹çš„æ—¶å€™ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°</span><br><span class="hljs-comment">// et æ˜¯å½“å‰ slice çš„ç±»å‹</span><br><span class="hljs-comment">// old æ˜¯åŸæœ‰çš„ slice</span><br><span class="hljs-comment">// cap æ˜¯æ»¡è¶³æ‰©å®¹æ‰€éœ€çš„æœ€å°å®¹é‡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">growslice</span><span class="hljs-params">(et *_type, old slice, <span class="hljs-built_in">cap</span> <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">slice</span></span> &#123;<br><span class="hljs-comment">// ... ä¸€äº›æ ¡éªŒé€»è¾‘ï¼Œç•¥è¿‡</span><br><br>    <span class="hljs-comment">// ä¸‹é¢è¿™ä¸ªå°±æ˜¯æ‰©å®¹ç®—æ³•</span><br>newcap := old.<span class="hljs-built_in">cap</span><br>doublecap := newcap + newcap<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">cap</span> &gt; doublecap &#123;<br>newcap = <span class="hljs-built_in">cap</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> old.<span class="hljs-built_in">len</span> &lt; <span class="hljs-number">1024</span> &#123;<br>newcap = doublecap<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// Check 0 &lt; newcap to detect overflow</span><br><span class="hljs-comment">// and prevent an infinite loop.</span><br><span class="hljs-keyword">for</span> <span class="hljs-number">0</span> &lt; newcap &amp;&amp; newcap &lt; <span class="hljs-built_in">cap</span> &#123;<br>newcap += newcap / <span class="hljs-number">4</span><br>&#125;<br><span class="hljs-comment">// Set newcap to the requested cap when</span><br><span class="hljs-comment">// the newcap calculation overflowed.</span><br><span class="hljs-keyword">if</span> newcap &lt;= <span class="hljs-number">0</span> &#123;<br>newcap = <span class="hljs-built_in">cap</span><br>&#125;<br>&#125;<br>&#125;<br><br>    <span class="hljs-comment">// ä¸‹é¢å»è®¡ç®—æ–°çš„æ•°ç»„æ‰€éœ€è¦çš„å†…å­˜</span><br>    <span class="hljs-comment">// é€šè¿‡ old.len, cap, ä»¥åŠ newcap è®¡ç®—</span><br><span class="hljs-keyword">var</span> overflow <span class="hljs-keyword">bool</span><br><span class="hljs-keyword">var</span> lenmem, newlenmem, capmem <span class="hljs-keyword">uintptr</span><br><span class="hljs-comment">// Specialize for common values of et.size.</span><br><span class="hljs-comment">// For 1 we don&#x27;t need any division/multiplication.</span><br><span class="hljs-comment">// For sys.PtrSize, compiler will optimize division/multiplication into a shift by a constant.</span><br><span class="hljs-comment">// For powers of 2, use a variable shift.</span><br><span class="hljs-keyword">switch</span> &#123;<br><span class="hljs-keyword">case</span> et.size == <span class="hljs-number">1</span>:<br>lenmem = <span class="hljs-keyword">uintptr</span>(old.<span class="hljs-built_in">len</span>)<br>newlenmem = <span class="hljs-keyword">uintptr</span>(<span class="hljs-built_in">cap</span>)<br>capmem = roundupsize(<span class="hljs-keyword">uintptr</span>(newcap))<br>overflow = <span class="hljs-keyword">uintptr</span>(newcap) &gt; maxAlloc<br>newcap = <span class="hljs-keyword">int</span>(capmem)<br><span class="hljs-comment">// ... æœ‰å¥½å‡ ä¸ªåˆ†æ”¯ï¼Œçœ‹ä¸€ä¸ªç±»ä¼¼çš„å°±å¯ä»¥äº†</span><br>&#125;<br><br><span class="hljs-comment">// æ£€æŸ¥æ˜¯ä¸æ˜¯è¶…è¿‡å†…å­˜é™åˆ¶</span><br><span class="hljs-keyword">if</span> overflow || capmem &gt; maxAlloc &#123;<br><span class="hljs-built_in">panic</span>(errorString(<span class="hljs-string">&quot;growslice: cap out of range&quot;</span>))<br>&#125;<br><br>    <span class="hljs-comment">// åˆ†é…å†…å­˜</span><br><span class="hljs-keyword">var</span> p unsafe.Pointer<br><span class="hljs-keyword">if</span> et.ptrdata == <span class="hljs-number">0</span> &#123;<br>p = mallocgc(capmem, <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span>)<br><span class="hljs-comment">// The append() that calls growslice is going to overwrite from old.len to cap (which will be the new length).</span><br><span class="hljs-comment">// Only clear the part that will not be overwritten.</span><br>memclrNoHeapPointers(add(p, newlenmem), capmem-newlenmem)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// Note: can&#x27;t use rawmem (which avoids zeroing of memory), because then GC can scan uninitialized memory.</span><br>p = mallocgc(capmem, et, <span class="hljs-literal">true</span>)<br><span class="hljs-keyword">if</span> lenmem &gt; <span class="hljs-number">0</span> &amp;&amp; writeBarrier.enabled &#123;<br><span class="hljs-comment">// Only shade the pointers in old.array since we know the destination slice p</span><br><span class="hljs-comment">// only contains nil pointers because it has been cleared during alloc.</span><br>bulkBarrierPreWriteSrcOnly(<span class="hljs-keyword">uintptr</span>(p), <span class="hljs-keyword">uintptr</span>(old.array), lenmem-et.size+et.ptrdata)<br>&#125;<br>&#125;<br><br>    <span class="hljs-comment">// å°†åŸæœ¬çš„æ•°ç»„å¤åˆ¶åˆ°æ–°æ•°ç»„ä¸Š</span><br>memmove(p, old.array, lenmem)<br><br><span class="hljs-keyword">return</span> slice&#123;p, old.<span class="hljs-built_in">len</span>, newcap&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹æ‰©å®¹çš„ç®—æ³•ï¼Œå¯ä»¥å‘ç°æœ‰ä¸‰ç§é€»è¾‘</p><ul><li>å¦‚æœéœ€è¦çš„æœ€å°å®¹é‡æ¯”ä¸¤å€åŸæœ‰å®¹é‡å¤§ï¼Œé‚£ä¹ˆå°±å–éœ€è¦çš„å®¹é‡</li><li>å¦‚æœåŸæœ‰ slice é•¿åº¦å°äº 1024 é‚£ä¹ˆæ¯æ¬¡å°±æ‰©å®¹ä¸ºåŸæ¥çš„ä¸¤å€</li><li>å¦‚æœåŸ slice å¤§äºç­‰äº 1024 é‚£ä¹ˆæ¯æ¬¡æ‰©å®¹å°±æ‰©ä¸ºåŸæ¥çš„ 1.25 å€</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go">newcap := old.<span class="hljs-built_in">cap</span><br>doublecap := newcap + newcap<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">cap</span> &gt; doublecap &#123;<br>    newcap = <span class="hljs-built_in">cap</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">if</span> old.<span class="hljs-built_in">len</span> &lt; <span class="hljs-number">1024</span> &#123;<br>        newcap = doublecap<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Check 0 &lt; newcap to detect overflow</span><br>        <span class="hljs-comment">// and prevent an infinite loop.</span><br>        <span class="hljs-keyword">for</span> <span class="hljs-number">0</span> &lt; newcap &amp;&amp; newcap &lt; <span class="hljs-built_in">cap</span> &#123;<br>            newcap += newcap / <span class="hljs-number">4</span><br>        &#125;<br>        <span class="hljs-comment">// Set newcap to the requested cap when</span><br>        <span class="hljs-comment">// the newcap calculation overflowed.</span><br>        <span class="hljs-keyword">if</span> newcap &lt;= <span class="hljs-number">0</span> &#123;<br>            newcap = <span class="hljs-built_in">cap</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ç©º-Slice"><a href="#ç©º-Slice" class="headerlink" title="ç©º Slice"></a>ç©º Slice</h3><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ Slice åˆå§‹åŒ–çš„æ–¹å¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> s1 []<span class="hljs-keyword">int</span><br>s2 := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">uint</span>, <span class="hljs-number">0</span>)<br>s3 := []<span class="hljs-keyword">int</span>&#123;&#125;<br><span class="hljs-comment">// fmt.Printf(&quot;%p: %v, len: %d, cap: %d\n&quot;, s1, s1, len(s1), cap(s1))</span><br><span class="hljs-comment">// 0x0: [], len: 0, cap: 0</span><br><span class="hljs-comment">// 0x587450: [], len: 0, cap: 0</span><br><span class="hljs-comment">// 0x587450: [], len: 0, cap: 0</span><br></code></pre></td></tr></table></figure><ul><li>tips: <code>%p</code>  æ‰“å° slice ä¼šæ‰“å° slice åº•å±‚æŒ‡å‘çš„æ•°ç»„çš„åœ°å€</li><li>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œç¬¬ä¸€ç§æ–¹å¼è¿›è¡Œåˆå§‹åŒ–ï¼Œå‡ºç°çš„ä¹Ÿå°±æ˜¯ slice çš„é›¶å€¼ï¼Œåº•å±‚çš„æ•°ç»„æŒ‡é’ˆæ˜¯ä¸€ä¸ª nil</li><li>ç¬¬äºŒç§å’Œç¬¬ä¸‰ç§çš„åº•å±‚æŒ‡é’ˆéƒ½æœ‰ä¸€ä¸ªå€¼ï¼Œä¸è¿‡æ²¡æœ‰å®é™…åˆ†é…å†…å­˜</li><li>è¿™ä¸‰ç§æ–¹å¼åˆå§‹åŒ–å‡ºæ¥çš„ capã€å’Œ len çš„é•¿åº¦éƒ½æ˜¯ 0</li></ul><h3 id="è§„èŒƒæŠ€å·§"><a href="#è§„èŒƒæŠ€å·§" class="headerlink" title="è§„èŒƒæŠ€å·§"></a>è§„èŒƒæŠ€å·§</h3><ol><li>slice ä½œä¸ºå‚æ•°æ—¶ï¼Œä¸è¦ç›´æ¥å­˜å‚¨å®ƒçš„å¼•ç”¨ï¼Œè€Œæ˜¯é€šè¿‡ <code>copy</code>  å¤åˆ¶ä¸€ä»½<ol><li>åŸå› è¯·æŸ¥çœ‹ä¸Šæ–‡ï¼ŒSlice çš„ç»“æ„</li><li>ç¤ºä¾‹ï¼š<a href="https://github.com/xxjwxc/uber_go_guide_cn#nil-%E6%98%AF%E4%B8%80%E4%B8%AA%E6%9C%89%E6%95%88%E7%9A%84-slice">Uber Go è§„èŒƒ: nil-æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„-slice</a></li></ol></li><li>è¦æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦ä¸ºç©ºï¼Œè¯·å§‹ç»ˆä½¿ç”¨ <code>len(s) == 0</code> ã€‚è€Œé <code>nil</code> ã€‚<ol><li>åŸå› è¯·æŸ¥çœ‹ä¸Šæ–‡ï¼ŒSlice åˆå§‹åŒ–</li><li>ç¤ºä¾‹ï¼š<a href="https://github.com/xxjwxc/uber_go_guide_cn#%E5%9C%A8%E8%BE%B9%E7%95%8C%E5%A4%84%E6%8B%B7%E8%B4%9D-Slices-%E5%92%8C-Maps">Uber Go è§„èŒƒ: åœ¨è¾¹ç•Œå¤„æ‹·è´-Slices-å’Œ-Maps</a></li></ol></li></ol><h2 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h2><ul><li>åœ¨è®²è§£ slice åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œä¸ºä»€ä¹ˆ <code>s2</code> , <code>s3</code>  æ‰“å°çš„æ•°ç»„æŒ‡é’ˆéƒ½æ˜¯ <code>0x587450</code> ?</li><li>è¯·æŸ¥çœ‹ä¸‹é¢ä¸€æ®µä»£ç ï¼Œä¼šè¾“å‡ºä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆï¼Ÿ<ul><li>A: 5 8 B: 8 8 C: 5 5 D: 5 6</li></ul></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>s := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;<br>s = <span class="hljs-built_in">append</span>(s, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)<br>fmt.Println(<span class="hljs-built_in">len</span>(s), <span class="hljs-built_in">cap</span>(s))<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>ç®—æ³•</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>æ•°æ®ç»“æ„</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goæ•°æ®ç»“æ„ä¸ç®—æ³•01-é“¾è¡¨: æ·±å…¥ç†è§£container/list&amp;LRUç¼“å­˜çš„å®ç°</title>
    <link href="/post/list.html"/>
    <url>/post/list.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go æ•°æ®ç»“æ„ä¸ç®—æ³•ç³»åˆ—æ–‡ç« ï¼Œæœ¬ç³»åˆ—æ–‡ç« ä¸»è¦ä¼šåŒ…æ‹¬å¸¸è§çš„æ•°æ®ç»“æ„ä¸ç®—æ³•å®ç°ï¼ŒåŒæ—¶ä¼šåŒ…æ‹¬ Go æ ‡å‡†åº“ä»£ç çš„åˆ†æç†è§£ï¼Œè®²åˆ°å¯¹åº”ç« èŠ‚çš„æ—¶å€™ä¼˜å…ˆå­¦ä¹ åˆ†æ Go çš„æºç å®ç°ï¼Œä¾‹å¦‚ sliceã€listã€sort ç­‰ï¼Œç„¶åå¯èƒ½ä¼šæœ‰ä¸€äº›å¸¸è§çš„æ¡ˆä¾‹å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/126">æå®¢æ—¶é—´-æ•°æ®ç»“æ„ä¸ç®—æ³•ä¹‹ç¾</a> çš„è¯¾ç¨‹ç¬”è®°</li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“:</strong> <a href="https://github.com/mohuishou/go-algorithm">https://github.com/mohuishou/go-algorithm</a> ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 1 ~ 2 ç¯‡æ–‡ç« ï¼Œé¢„è®¡åˆ° 202101 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°:</strong> <a href="https://github.com/mohuishou/go-design-pattern">Github</a>ã€<a href="https://zhuanlan.zhihu.com/mohuishou">çŸ¥ä¹</a>ã€<a href="https://lailin.xyz/atom.xml">RSS</a>ã€<a href="https://toutiao.io/subjects/387401?f=new">å¼€å‘è€…å¤´æ¡</a></li><li>ä¸Šä¸€ä¸ªç³»åˆ—åˆšåˆšå®Œæˆäº† <a href="https://lailin.xyz/post/go-design-pattern.html">Go è®¾è®¡æ¨¡å¼</a>ï¼Œå¦‚æœæ„Ÿå…´è¶£ä¹Ÿå¯ä»¥è¿›è¡ŒæŸ¥çœ‹</li></ul><h2 id="ä»€ä¹ˆæ˜¯é“¾è¡¨ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯é“¾è¡¨ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯é“¾è¡¨ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯é“¾è¡¨ï¼Ÿ</h2><h3 id="å•é“¾è¡¨"><a href="#å•é“¾è¡¨" class="headerlink" title="å•é“¾è¡¨"></a>å•é“¾è¡¨</h3><ul><li>é“¾è¡¨é€šè¿‡æŒ‡é’ˆå°†é›¶æ•£çš„å†…å­˜æ•°æ®è”ç³»åœ¨ä¸€èµ·</li><li>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒåŒ…å«ä¸¤ä¸ªç»“æ„ï¼Œä¸€ä¸ªæ˜¯æ•°æ® dataï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å†…å­˜åœ°å€</li><li>æœ€åä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘ NULL</li></ul><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1604804227362-0a6030ac-cf14-4052-8a4b-87eec4e1a904.jpeg" alt="01_é“¾è¡¨-å•é“¾è¡¨.jpg"></p><h3 id="å¾ªç¯é“¾è¡¨"><a href="#å¾ªç¯é“¾è¡¨" class="headerlink" title="å¾ªç¯é“¾è¡¨"></a>å¾ªç¯é“¾è¡¨</h3><ul><li>å’Œå•é“¾è¡¨çš„åŒºåˆ«å°±æ˜¯ï¼Œå°†å°¾èŠ‚ç‚¹æŒ‡å‘çš„å¤´ç»“ç‚¹ï¼Œå°†æ•´ä¸ªé“¾è¡¨ç»„æˆäº†ä¸€ä¸ªç¯çŠ¶</li></ul><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1604804281440-be68f311-161b-42bf-b8ac-f48f917b8732.png" alt="01_é“¾è¡¨-å¾ªç¯é“¾è¡¨.png"></p><h3 id="åŒå‘é“¾è¡¨"><a href="#åŒå‘é“¾è¡¨" class="headerlink" title="åŒå‘é“¾è¡¨"></a>åŒå‘é“¾è¡¨</h3><ul><li>å’Œåœ¨å•é“¾è¡¨çš„åŸºç¡€ä¹‹ä¸Šæ·»åŠ äº†ä¸€ä¸ªæŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œè¿™æ ·æˆ‘ä»¬çŸ¥é“ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹å°±å¯ä»¥åŒæ—¶çŸ¥é“ä»–ä»¬çš„ä¸Šä¸‹ä¸¤ä¸ªèŠ‚ç‚¹</li><li>è¿™æ˜¯å®é™…ä½¿ç”¨çš„æ—¶å€™æœ€å¸¸ç”¨çš„</li></ul><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1604804268492-79fe5525-be57-4eb8-bee7-0900e041af66.jpeg" alt="01_é“¾è¡¨-åŒå‘é“¾è¡¨.jpg"></p><h3 id="å’Œæ•°ç»„å¯¹æ¯”"><a href="#å’Œæ•°ç»„å¯¹æ¯”" class="headerlink" title="å’Œæ•°ç»„å¯¹æ¯”"></a>å’Œæ•°ç»„å¯¹æ¯”</h3><table><thead><tr><th style="text-align:center"></th><th style="text-align:center"><strong>é“¾è¡¨</strong></th><th style="text-align:center"><strong>æ•°ç»„</strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong>æŸ¥æ‰¾æŸä¸ªå…ƒç´ </strong></td><td style="text-align:center">O(n)</td><td style="text-align:center">O(1)</td></tr><tr><td style="text-align:center"><strong>åˆ é™¤æˆ–è€…æ·»åŠ ä¸€ä¸ªå…ƒç´ </strong></td><td style="text-align:center">O(1)</td><td style="text-align:center">O(n)</td></tr></tbody></table><h2 id="æ ‡å‡†åº“-Container-list-çš„å®ç°"><a href="#æ ‡å‡†åº“-Container-list-çš„å®ç°" class="headerlink" title="æ ‡å‡†åº“ Container/list çš„å®ç°"></a>æ ‡å‡†åº“ Container/list çš„å®ç°</h2><h3 id="ç»“æ„ä½“å®šä¹‰"><a href="#ç»“æ„ä½“å®šä¹‰" class="headerlink" title="ç»“æ„ä½“å®šä¹‰"></a>ç»“æ„ä½“å®šä¹‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Element ç”¨äºè¡¨ç¤ºé“¾è¡¨å½“ä¸­çš„èŠ‚ç‚¹</span><br><span class="hljs-keyword">type</span> Element <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">// next, prev åˆ†åˆ«è¡¨ç¤ºä¸Šä¸ªèŠ‚ç‚¹å’Œä¸‹ä¸ªèŠ‚ç‚¹</span><br>next, prev *Element<br><br><span class="hljs-comment">// è¡¨ç¤ºèŠ‚ç‚¹æ‰€åœ¨çš„å…ƒç´ </span><br>list *List<br><br><span class="hljs-comment">// èŠ‚ç‚¹æ‰€ä¿å­˜çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢å›¾ä¸­çš„ data</span><br>Value <span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br><br><span class="hljs-comment">// List è¿™æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨</span><br><span class="hljs-comment">// List çš„é›¶å€¼æ˜¯ä¸€ä¸ªç©ºé“¾è¡¨</span><br><span class="hljs-keyword">type</span> List <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">// æ ¹èŠ‚ç‚¹ï¼ŒList å…¶å®æ˜¯ä¸€ä¸ªåŒå‘å¾ªç¯é“¾è¡¨ï¼Œrootï¼Œ root.prev æ˜¯å°¾èŠ‚ç‚¹, å°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘ root</span><br>    <span class="hljs-comment">// æ ¹èŠ‚ç‚¹æ˜¯ä¸€ä¸ªå“¨å…µèŠ‚ç‚¹ï¼Œæ˜¯ä¸ºäº†ç”¨æ¥ç®€åŒ–èŠ‚ç‚¹æ“ä½œä½¿ç”¨çš„</span><br>root Element<br><br>    <span class="hljs-comment">// é“¾è¡¨çš„é•¿åº¦ï¼Œä¸åŒ…æ‹¬å“¨å…µèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ ¹èŠ‚ç‚¹</span><br><span class="hljs-built_in">len</span>  <span class="hljs-keyword">int</span><br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™é‡Œæˆ‘ä¸‹æ„è¯†çš„ä¼šæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p><ul><li>ä¸ºä»€ä¹ˆåœ¨ <code>Element</code>  å½“ä¸­ä¼šæŒæœ‰ä¸€ä¸ª <code>List</code>  ç»“æ„ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆéœ€è¦ä¸€ä¸ªå•ç‹¬çš„ <code>List</code>  ç»“æ„ä½“ï¼Œç›´æ¥è¦ä¸€ä¸ª <code>Root</code>  èŠ‚ç‚¹ä¸å°±å®Œäº‹äº†ä¹ˆï¼Ÿ</li></ul><h3 id="æ–¹æ³•é›†"><a href="#æ–¹æ³•é›†" class="headerlink" title="æ–¹æ³•é›†"></a>æ–¹æ³•é›†</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go">Remove(e *Element) <span class="hljs-keyword">interface</span>&#123;&#125; <span class="hljs-comment">// åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹</span><br>PushFront(v <span class="hljs-keyword">interface</span>&#123;&#125;) *Element <span class="hljs-comment">// å°†å€¼æ’å…¥åˆ°é“¾è¡¨å¤´éƒ¨</span><br>PushBack(v <span class="hljs-keyword">interface</span>&#123;&#125;) *Element <span class="hljs-comment">// å°†å€¼æ’å…¥åˆ°é“¾è¡¨å°¾éƒ¨</span><br>InsertBefore(v <span class="hljs-keyword">interface</span>&#123;&#125;, mark *Element) *Element <span class="hljs-comment">// åœ¨ mark èŠ‚ç‚¹ä¹‹å‰æ’å…¥å€¼</span><br>InsertAfter(v <span class="hljs-keyword">interface</span>&#123;&#125;, mark *Element) *Element <span class="hljs-comment">// åœ¨ mark èŠ‚ç‚¹ä¹‹åæ’å…¥å€¼</span><br>MoveToFront(e *Element) <span class="hljs-comment">// å°†èŠ‚ç‚¹ e ç§»åŠ¨è‡³é“¾è¡¨å¤´éƒ¨</span><br>MoveToBack(e *Element) <span class="hljs-comment">// å°†èŠ‚ç‚¹ e ç§»åŠ¨è‡³é“¾è¡¨å°¾éƒ¨</span><br>MoveBefore(e, mark *Element) <span class="hljs-comment">// å°†èŠ‚ç‚¹ e ç§»åŠ¨åˆ° mark èŠ‚ç‚¹ä¹‹å‰</span><br>MoveAfter(e, mark *Element) <span class="hljs-comment">// å°†èŠ‚ç‚¹ e ç§»åŠ¨åˆ° mark èŠ‚ç‚¹ä¹‹å</span><br>PushBackList(other *List) <span class="hljs-comment">// å°†é“¾è¡¨ other è¿æ¥åˆ°å½“å‰é“¾è¡¨ä¹‹å</span><br>PushFrontList(other *List) <span class="hljs-comment">// å°†é“¾è¡¨ other è¿æ¥åˆ°å½“å‰é“¾è¡¨ä¹‹å‰</span><br></code></pre></td></tr></table></figure><p>çœ‹äº†æš´éœ²çš„æ–¹æ³•é›†ä¹‹åæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™é‡Œé¢æ ¸å¿ƒçš„å‡ ä¸ªæ–¹æ³•ï¼Œä¸Šè¯‰æš´éœ²çš„æ–¹æ³•å®è´¨ä¸Šéƒ½æ˜¯é€šè¿‡è°ƒç”¨ä¸‹é¢çš„æ–¹æ³•å®ç°çš„</p><h4 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å°†èŠ‚ç‚¹ e æ’å…¥ at ä¹‹å</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *List)</span> <span class="hljs-title">insert</span><span class="hljs-params">(e, at *Element)</span> *<span class="hljs-title">Element</span></span> &#123;<br>    <span class="hljs-comment">// å‡è®¾ at.next ä¸º nt</span><br>    <span class="hljs-comment">// 1. å°†èŠ‚ç‚¹ e çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘ at</span><br>e.prev = at<br>    <span class="hljs-comment">// 2. å°†èŠ‚ç‚¹ e çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘ nt</span><br>e.next = at.next<br>    <span class="hljs-comment">// 3. è¿™ä¸ªæ—¶å€™  e.prev.next == at.next</span><br>    <span class="hljs-comment">// å…¶å®å°±æ˜¯æœ¬æ¥ at --&gt; ntï¼Œä¿®æ”¹ä¸º at --&gt; e</span><br>e.prev.next = e<br>    <span class="hljs-comment">// 4. e.next.prev == nt.prev</span><br>    <span class="hljs-comment">// æœ¬æ¥ at &lt;--- ntï¼Œä¿®æ”¹ä¸º e &lt;--- nt</span><br>e.next.prev = e<br>e.list = l<br>l.<span class="hljs-built_in">len</span>++<br><span class="hljs-keyword">return</span> e<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// remove removes e from its list, decrements l.len, and returns e.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *List)</span> <span class="hljs-title">remove</span><span class="hljs-params">(e *Element)</span> *<span class="hljs-title">Element</span></span> &#123;<br>e.prev.next = e.next<br>e.next.prev = e.prev<br>    <span class="hljs-comment">// è¿™é‡Œä¸ºäº†é¿å…å†…å­˜æ³„æ¼çš„æ“ä½œå¯ä»¥å­¦ä¹ </span><br>e.next = <span class="hljs-literal">nil</span> <span class="hljs-comment">// avoid memory leaks</span><br>e.prev = <span class="hljs-literal">nil</span> <span class="hljs-comment">// avoid memory leaks</span><br>e.list = <span class="hljs-literal">nil</span><br>l.<span class="hljs-built_in">len</span>--<br><span class="hljs-keyword">return</span> e<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="move"><a href="#move" class="headerlink" title="move"></a>move</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// move moves e to next to at and returns e.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *List)</span> <span class="hljs-title">move</span><span class="hljs-params">(e, at *Element)</span> *<span class="hljs-title">Element</span></span> &#123;<br><span class="hljs-keyword">if</span> e == at &#123;<br><span class="hljs-keyword">return</span> e<br>&#125;<br>    <span class="hljs-comment">// å…ˆæŠŠå½“å‰èŠ‚ç‚¹ä»åŸæ¥çš„ä½ç½®ç§»é™¤</span><br>e.prev.next = e.next<br>e.next.prev = e.prev<br><br>    <span class="hljs-comment">// å†å°†å½“å‰èŠ‚ç‚¹ e æ’å…¥åˆ° at èŠ‚ç‚¹ä¹‹å</span><br>e.prev = at<br>e.next = at.next<br>e.prev.next = e<br>e.next.prev = e<br><br><span class="hljs-keyword">return</span> e<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¸¤ä¸ªé—®é¢˜"><a href="#ä¸¤ä¸ªé—®é¢˜" class="headerlink" title="ä¸¤ä¸ªé—®é¢˜"></a>ä¸¤ä¸ªé—®é¢˜</h3><p>æˆ‘ä»¬åœ¨çœ‹ä¸€ä¸‹æœ€å¼€å§‹çš„ä¸¤ä¸ªé—®é¢˜<br><strong>1. ä¸ºä»€ä¹ˆåœ¨ <code>Element</code> å½“ä¸­ä¼šæŒæœ‰ä¸€ä¸ª <code>List</code> ç»“æ„ï¼Ÿ</strong></p><ul><li>æŸ¥çœ‹ä¸Šæ–¹çš„ move æ–¹æ³•æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ï¼Œlist æä¾›äº†è®²èŠ‚ç‚¹ç§»åŠ¨åˆ°æŸä¸ªèŠ‚ç‚¹ä¹‹åçš„æ–¹æ³•ï¼Œé€šè¿‡ e.List è¿›è¡Œå¯¹æ¯”æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“éœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹æ˜¯ä¸æ˜¯å±äºå½“å‰è¿™ä¸ªé“¾è¡¨äº†ï¼Œè¿™ä¹Ÿæ˜¯ <code>MoveToFront</code> ç­‰æ–¹æ³•çš„å®ç°æ–¹å¼</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *List)</span> <span class="hljs-title">MoveToFront</span><span class="hljs-params">(e *Element)</span></span> &#123;<br><span class="hljs-keyword">if</span> e.list != l || l.root.next == e &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-comment">// see comment in List.Remove about initialization of l</span><br>l.move(e, &amp;l.root)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>2. ä¸ºä»€ä¹ˆéœ€è¦ä¸€ä¸ªå•ç‹¬çš„ <code>List</code> ç»“æ„ä½“ï¼Œç›´æ¥è¦ä¸€ä¸ª <code>Root</code>  èŠ‚ç‚¹ä¸å°±å®Œäº‹äº†ä¹ˆï¼Ÿ</strong></p><ul><li>çœ‹ä¹‹å‰çš„ <code>List</code> çš„ç»“æ„æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨ç»“æ„ä½“ä¸­åŒ…å«äº†ä¸€ä¸ª <code>len</code> ï¼Œè¿™æ ·å¯ä»¥é¿å…éœ€è¦å–é•¿åº¦çš„æ—¶å€™æ¯æ¬¡éƒ½éœ€è¦ä»å¤´åˆ°å°¾éå†ä¸€é</li></ul><h2 id="å¦‚ä½•å®ç°ä¸€ä¸ªå¹¶å‘å®‰å…¨çš„-Container-listï¼Ÿ"><a href="#å¦‚ä½•å®ç°ä¸€ä¸ªå¹¶å‘å®‰å…¨çš„-Container-listï¼Ÿ" class="headerlink" title="å¦‚ä½•å®ç°ä¸€ä¸ªå¹¶å‘å®‰å…¨çš„ Container/listï¼Ÿ"></a>å¦‚ä½•å®ç°ä¸€ä¸ªå¹¶å‘å®‰å…¨çš„ Container/listï¼Ÿ</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>go test -race .</code>  æµ‹è¯•æ˜¯å¦å­˜åœ¨å¹¶å‘å®‰å…¨çš„é—®é¢˜</p><h3 id="æ ‡å‡†åº“åŒ…"><a href="#æ ‡å‡†åº“åŒ…" class="headerlink" title="æ ‡å‡†åº“åŒ…"></a>æ ‡å‡†åº“åŒ…</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestList</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>l := list.New()<br>wg := sync.WaitGroup&#123;&#125;<br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>l.PushBack(i)<br>&#125;<br>wg.Done()<br>&#125;()<br>l.PushBack(<span class="hljs-number">11</span>)<br>wg.Wait()<br>&#125;<br></code></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥æ˜æ˜¾çš„çœ‹åˆ°å­˜åœ¨å¹¶å‘é—®é¢˜</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"> <span class="hljs-keyword">go</span> test  -v -timeout <span class="hljs-number">1</span>s -race -run ^TestList$ ./...<br>=== RUN   TestList<br>==================<br>WARNING: DATA RACE<br>Read at <span class="hljs-number">0x00c00006e330</span> by goroutine <span class="hljs-number">8</span>:<br>  container/list.(*List).lazyInit()<br>      /usr/local/<span class="hljs-keyword">go</span>/src/container/list/list.<span class="hljs-keyword">go</span>:<span class="hljs-number">86</span> +<span class="hljs-number">0xb2</span><br></code></pre></td></tr></table></figure><h3 id="ç¨ä½œæ”¹é€ "><a href="#ç¨ä½œæ”¹é€ " class="headerlink" title="ç¨ä½œæ”¹é€ "></a>ç¨ä½œæ”¹é€ </h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// List é“¾è¡¨</span><br><span class="hljs-keyword">type</span> List <span class="hljs-keyword">struct</span> &#123;<br>*list.List<br>mu sync.Mutex<br>&#125;<br><br><span class="hljs-comment">// New æ–°å»ºé“¾è¡¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">()</span> *<span class="hljs-title">List</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;List&#123;List: list.New()&#125;<br>&#125;<br><br><span class="hljs-comment">// PushBack åƒé“¾è¡¨å°¾éƒ¨æ’å…¥å€¼</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *List)</span> <span class="hljs-title">PushBack</span><span class="hljs-params">(v <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>    <span class="hljs-comment">// åŠ é”</span><br>l.mu.Lock()<br><span class="hljs-keyword">defer</span> l.mu.Unlock()<br>l.List.PushBack(v)<br>&#125;<br></code></pre></td></tr></table></figure><p>é—®é¢˜è§£å†³</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> test  -v -timeout <span class="hljs-number">1</span>s -race -run ^TestList_PushBack$ ./...<br>=== RUN   TestList_PushBack<br>--- PASS: TestList_PushBack (<span class="hljs-number">0.00</span>s)<br>PASS<br>ok      github.com/mohuishou/<span class="hljs-keyword">go</span>-algorithm/<span class="hljs-number">01</span>_list/list  (cached)<br></code></pre></td></tr></table></figure><h2 id="å¦‚ä½•å®ç°ä¸€ä¸ª-LRU-ç¼“å­˜ï¼Ÿ"><a href="#å¦‚ä½•å®ç°ä¸€ä¸ª-LRU-ç¼“å­˜ï¼Ÿ" class="headerlink" title="å¦‚ä½•å®ç°ä¸€ä¸ª LRU ç¼“å­˜ï¼Ÿ"></a>å¦‚ä½•å®ç°ä¸€ä¸ª LRU ç¼“å­˜ï¼Ÿ</h2><p>LRU: Least Recently Used æœ€è¿‘æœ€å°‘ä½¿ç”¨ç­–ç•¥</p><blockquote><p>è¿™é‡Œä¸ºäº†è®­ç»ƒä¸€ä¸‹ä»£ç ï¼Œå°±æ²¡æœ‰ç›´æ¥ä½¿ç”¨æ ‡å‡†åº“çš„åŒ…äº†</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> lru<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-comment">// Node é“¾è¡¨çš„èŠ‚ç‚¹</span><br><span class="hljs-keyword">type</span> Node <span class="hljs-keyword">struct</span> &#123;<br>prev, next *Node<br><br>list *LRU<br><br>key   <span class="hljs-keyword">string</span><br>value <span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br><br><span class="hljs-comment">// LRU ç¼“å­˜</span><br><span class="hljs-keyword">type</span> LRU <span class="hljs-keyword">struct</span> &#123;<br>root *Node <span class="hljs-comment">// æ ¹èŠ‚ç‚¹</span><br><span class="hljs-built_in">cap</span>  <span class="hljs-keyword">int</span>   <span class="hljs-comment">// å½“å‰ç¼“å­˜å®¹é‡</span><br><span class="hljs-built_in">len</span>  <span class="hljs-keyword">int</span>   <span class="hljs-comment">// ç¼“å­˜çš„é•¿åº¦</span><br>&#125;<br><br><span class="hljs-comment">// NewLRU NewLRU</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewLRU</span><span class="hljs-params">(<span class="hljs-built_in">cap</span> <span class="hljs-keyword">int</span>)</span> *<span class="hljs-title">LRU</span></span> &#123;<br>l := &amp;LRU&#123;<br>root: &amp;Node&#123;&#125;,<br><span class="hljs-built_in">cap</span>:  <span class="hljs-built_in">cap</span>,<br>&#125;<br>l.root.prev = l.root<br>l.root.next = l.root<br>l.root.list = l<br><span class="hljs-keyword">return</span> l<br>&#125;<br><br><span class="hljs-comment">// Get è·å–ç¼“å­˜æ•°æ®</span><br><span class="hljs-comment">// å¦‚æœè·å–åˆ°æ•°æ®ï¼Œå°±æŠŠè¿™ä¸ªèŠ‚ç‚¹ç§»åŠ¨åˆ°é“¾è¡¨å¤´éƒ¨</span><br><span class="hljs-comment">// å¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œå°±è¿”å›nil</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *LRU)</span> <span class="hljs-title">Get</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;<br><span class="hljs-keyword">defer</span> l.debug()<br>n := l.get(key)<br><span class="hljs-keyword">if</span> n == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-keyword">return</span> n.value<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *LRU)</span> <span class="hljs-title">get</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> *<span class="hljs-title">Node</span></span> &#123;<br><span class="hljs-keyword">for</span> n := l.root.next; n != l.root; n = n.next &#123;<br><span class="hljs-keyword">if</span> n.key == key &#123;<br>n.prev.next = n.next<br>n.next.prev = n.prev<br><br>n.next = l.root.next<br>l.root.next.prev = n<br>l.root.next = n<br>n.prev = l.root<br><span class="hljs-keyword">return</span> n<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// Put å†™å…¥ç¼“å­˜æ•°æ®</span><br><span class="hljs-comment">// å¦‚æœ key å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆæ›´æ–°å€¼</span><br><span class="hljs-comment">// å¦‚æœ key ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆæ’å…¥åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span><br><span class="hljs-comment">// å½“ç¼“å­˜å®¹é‡æ»¡äº†çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨åˆ é™¤æœ€åçš„æ•°æ®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *LRU)</span> <span class="hljs-title">Put</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>, value <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br><span class="hljs-keyword">defer</span> l.debug()<br>n := l.get(key)<br><span class="hljs-keyword">if</span> n != <span class="hljs-literal">nil</span> &#123;<br>n.value = value<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// ç¼“å­˜æ»¡äº†</span><br><span class="hljs-keyword">if</span> l.<span class="hljs-built_in">len</span> == l.<span class="hljs-built_in">cap</span> &#123;<br>last := l.root.prev<br>last.prev.next = l.root<br>l.root.prev = last.prev<br>last.list = <span class="hljs-literal">nil</span><br>last.prev = <span class="hljs-literal">nil</span><br>last.next = <span class="hljs-literal">nil</span><br>l.<span class="hljs-built_in">len</span>--<br>&#125;<br><br>node := &amp;Node&#123;key: key, value: value&#125;<br>head := l.root.next<br>head.prev = node<br>node.next = head<br>node.prev = l.root<br>l.root.next = node<br>l.<span class="hljs-built_in">len</span>++<br>node.list = l<br>&#125;<br><br><span class="hljs-comment">// debug for debug</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *LRU)</span> <span class="hljs-title">debug</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;lru len: &quot;</span>, l.<span class="hljs-built_in">len</span>)<br>fmt.Println(<span class="hljs-string">&quot;lru cap: &quot;</span>, l.<span class="hljs-built_in">cap</span>)<br><span class="hljs-keyword">for</span> n := l.root.next; n != l.root; n = n.next &#123;<br>fmt.Printf(<span class="hljs-string">&quot;%s:%v -&gt; &quot;</span>, n.key, n.value)<br>&#125;<br>fmt.Println()<br>fmt.Println()<br>&#125;<br></code></pre></td></tr></table></figure><p>å•å…ƒæµ‹è¯•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> lru<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestNewLRU</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>l := NewLRU(<span class="hljs-number">3</span>)<br>assert.Equal(t, l.Get(<span class="hljs-string">&quot;&quot;</span>), <span class="hljs-literal">nil</span>)<br><br>l.Put(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-number">1</span>)<br>l.Put(<span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-number">2</span>)<br>l.Put(<span class="hljs-string">&quot;3&quot;</span>, <span class="hljs-number">3</span>)<br>assert.Equal(t, <span class="hljs-number">3</span>, l.Get(<span class="hljs-string">&quot;3&quot;</span>))<br>assert.Equal(t, <span class="hljs-number">1</span>, l.Get(<span class="hljs-string">&quot;1&quot;</span>))<br><br>l.Put(<span class="hljs-string">&quot;4&quot;</span>, <span class="hljs-number">4</span>)<br>assert.Equal(t, <span class="hljs-literal">nil</span>, l.Get(<span class="hljs-string">&quot;2&quot;</span>))<br><br>l.Put(<span class="hljs-string">&quot;3&quot;</span>, <span class="hljs-number">31</span>)<br>assert.Equal(t, <span class="hljs-number">31</span>, l.Get(<span class="hljs-string">&quot;3&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h2><ul><li>å‰é¢è®²åˆ°çš„ é€šè¿‡ Element èŠ‚ç‚¹ä¸­çš„ List ç»“æ„æ¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å±äºå½“å‰é“¾è¡¨çš„æ–¹å¼ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šå‡ºç° <code>bug</code>  ä½ å‘ç°äº†ä¹ˆï¼Ÿ</li><li>LRU ç¼“å­˜å¯ä»¥å‚è€ƒ leetcode è¿›è¡Œæµ‹è¯•ï¼Œ<a href="https://leetcode-cn.com/problems/lru-cache/">146. LRU ç¼“å­˜æœºåˆ¶</a>ï¼Œæ–‡ä¸­çš„ LRU ç¼“å­˜å®ç°æœ‰è®¸å¤šå€¼å¾—ä¼˜åŒ–çš„åœ°æ–¹ï¼Œä½ è®¤ä¸ºæœ‰å“ªäº›å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ï¼Ÿ</li><li>é—®é¢˜å¯ä»¥å›å¤åœ¨è¯„è®ºåŒºï¼Œå°†åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­è§£ç­”</li></ul><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>ç®—æ³•</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>æ•°æ®ç»“æ„</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼24-æ€»ç»“(æ›´æ–°å®Œæ¯•)</title>
    <link href="/post/go-design-pattern.html"/>
    <url>/post/go-design-pattern.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/intro/100039001">è®¾è®¡æ¨¡å¼ä¹‹ç¾</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 24/24 </strong>è¿™æ˜¯è¯¥ç³»åˆ—çš„æœ€åä¸€ç¯‡æ–‡ç« å•¦ï¼Œåç»­çœ‹æƒ…å†µå¯èƒ½ä¼šä¸å®šæœŸè¡¥å……ä¸€äº›å®æˆ˜çš„å†…å®¹ï¼Œä½†æ˜¯æ­£æ–‡å°±è¿™ä¹ˆå¤šäº†</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åŸæœ¬é¢„è®¡æ˜¯åœ¨åæœˆåº•æ›´æ–°å®Œæ¯•è¿™ä¸ªç³»åˆ—ï¼Œåˆ°ä»Šå¤©æ˜¯ 11-05ï¼Œæ™šäº†å‡ å¤©ï¼Œä¸è¿‡ä¹Ÿè¿˜å¥½ï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡è¿™ä¹ˆå¯†é›†çš„å»æ›´æ–°åšå®¢ä¸Šçš„å†…å®¹ï¼Œæ›´å¤šçš„æ˜¯ä»¥ç¬”è®°çš„å½¢å¼æ¥å‘ˆç°ï¼ŒåŠ ä¸Šè¿™ç¯‡ä¸€å…± 24 ç¯‡æ–‡ç« å·®ä¸å¤šä¸¤ä¸ªåŠæœˆçš„æ—¶é—´ï¼Œå¹³å‡æ¯å‘¨è¾“å‡ºä¸¤ç¯‡ï¼Œæ„Ÿè§‰è¿˜æ˜¯ä¸é”™ã€‚åç»­å¯èƒ½ä¼šè§†æƒ…å†µä¸å®šæœŸçš„æ›´æ–°ä¸€äº›å®æˆ˜å†…å®¹ï¼Œä¹Ÿæœ‰å¯èƒ½æ²¡æœ‰ã€‚æ¥ä¸‹æ¥ä¸‹ä¸€ä¸ªç³»åˆ—åº”è¯¥æ˜¯æ•°æ®ç»“æ„ä¸ç®—æ³•ï¼ŒåŒ…å«å¯¹ Go ä¸­ä¸€äº›åº•å±‚æ•°æ®å’Œæ ‡å‡†åº“åŒ…çš„å­¦ä¹ ï¼Œä¾‹å¦‚ slice, sort ç­‰ç­‰ã€‚</p><p>è¯è¯´å›æ¥ï¼Œå›å¤´å†çœ‹å­¦ä¹ è®¾è®¡æ¨¡å¼æˆ‘ä»¬ç©¶ç«Ÿéœ€è¦å­¦ä¹ ä¸€äº›ä»€ä¹ˆï¼Ÿ</p><ul><li>å†™ Go éœ€è¦ä½¿ç”¨åˆ°è®¾è®¡æ¨¡å¼ä¹ˆï¼Ÿ<ul><li>éœ€è¦ï¼Œä½†æ˜¯åˆ‡è®°è¯·å‹¿ä½¿ç”¨å…¶ä»–è¯­è¨€çš„æ–¹å¼æ¥å†™ Go</li><li>å¦‚æœçœ‹è¿‡ä¹‹å‰çš„ä¸€äº›æ–‡ç« ï¼Œå°±ä¼šå‘ç°ç±»ä¼¼ JAVA çš„è¿™äº›é¢å‘å¯¹è±¡è¯­è¨€ä¸­çš„æŸäº›è®¾è®¡æ¨¡å¼çš„å†™æ³•åœ¨ Go ä¸­ä¼šååˆ†çš„åˆ«æ‰­</li><li>ä½†æ˜¯ Go ä¸éœ€è¦è®¾è®¡æ¨¡å¼ä¹ˆï¼Ÿä¸æ˜¯çš„ï¼Œè®¾è®¡æ¨¡å¼çš„æ€æƒ³æ˜¯æƒ³é€šçš„ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¸€ç›´éƒ½åœ¨ä½¿ç”¨ï¼Œä¾‹å¦‚æˆ‘ä»¬å¸¸è§çš„å¯¹è±¡åˆ›å»ºæ–¹å¼ <code>NewXXX</code>  è¿™å…¶å®å°±æ˜¯ä¸€ä¸ªç®€å•å·¥å‚</li></ul></li><li>è®¾è®¡æ¨¡å¼å­¦ä¹ çš„é‡ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ<ul><li>è®¾è®¡åŸåˆ™ï¼Œä»¥åŠè®¾è®¡æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯å’Œä¼˜ç¼ºç‚¹ï¼Œå®ç°ç›¸å¯¹æ¥è¯´è¿˜æ²¡æœ‰é‚£ä¹ˆé‡è¦</li><li>å¦‚æœæ˜¯å¸¸è§çš„è®¾è®¡æ¨¡å¼æ˜¯æ­¦æœ¯æ‹›å¼ï¼Œé‚£ä¹ˆè®¾è®¡åŸåˆ™å°±æ˜¯å†…åŠŸå¿ƒæ³•ï¼Œæ²¡æœ‰å†…åŠŸå¿ƒæ³•é‚£ä¹ˆæ‹›å¼å¥—è·¯ä¹Ÿå°±æ˜¯èŠ±æ¶å­</li><li>ç†Ÿç»ƒæŒæ¡ä¸åŒè®¾è®¡æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬å­¦ä¼šè§æ‹›æ‹†æ‹›ï¼Œçµæ´»åº”ç”¨è€Œä¸æ˜¯åªä¼šå¥—è·¯</li></ul></li><li><strong>æœ€åè®¾è®¡æ¨¡å¼ä¸æ˜¯é“¶å¼¹ï¼Œä¸è¦æ‹¿ç€ ğŸ”¨ å°±è§‰å¾—å“ªé‡Œéƒ½åƒæ˜¯é’‰å­ï¼Œä¸è¦è¿‡æ—©ä¼˜åŒ–ï¼ŒæŒç»­é‡æ„æ‰æ˜¯æ­£é“</strong></li></ul><h3 id="è®¾è®¡åŸåˆ™"><a href="#è®¾è®¡åŸåˆ™" class="headerlink" title="è®¾è®¡åŸåˆ™"></a>è®¾è®¡åŸåˆ™</h3><blockquote><p>åŒæ—¶è¿™ä¹Ÿæ˜¯ Code Review çš„é‡è¦æ ‡å‡†ä¹‹ä¸€</p></blockquote><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154616603-6328f638-0536-407e-afdf-7f2b33a97f91.jpeg" alt=""></p><h3 id="è®¾è®¡æ¨¡å¼"><a href="#è®¾è®¡æ¨¡å¼" class="headerlink" title="è®¾è®¡æ¨¡å¼"></a>è®¾è®¡æ¨¡å¼</h3><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154618733-bb131bea-bf76-4244-bb78-8bed8bfdddf1.jpeg" alt=""></p><h2 id="Go-è®¾è®¡æ¨¡å¼"><a href="#Go-è®¾è®¡æ¨¡å¼" class="headerlink" title="Go è®¾è®¡æ¨¡å¼"></a>Go è®¾è®¡æ¨¡å¼</h2><ul><li>å•ä¾‹æ¨¡å¼åŒ…å«é¥¿æ±‰å¼å’Œæ‡’æ±‰å¼ä¸¤ç§å®ç°</li><li>å·¥å‚æ¨¡å¼åŒ…å«ç®€å•å·¥å‚ã€å·¥å‚æ–¹æ³•ã€æŠ½è±¡å·¥å‚ã€DI å®¹å™¨</li><li>ä»£ç†æ¨¡å¼åŒ…å«é™æ€ä»£ç†ã€åŠ¨æ€ä»£ç†ï¼ˆé‡‡ç”¨ go generate æ¨¡æ‹Ÿï¼‰</li><li>è§‚å¯Ÿè€…æ¨¡å¼åŒ…å«è§‚å¯Ÿè€…æ¨¡å¼ã€eventbus</li></ul><table><thead><tr><th style="text-align:center"><strong>ç±»å‹</strong></th><th style="text-align:center"><strong>è®¾è®¡æ¨¡å¼ï¼ˆGithubï¼‰</strong></th><th style="text-align:center"><strong>å¸¸ç”¨</strong></th><th style="text-align:center"><strong>åšå®¢</strong></th></tr></thead><tbody><tr><td style="text-align:center"><strong>åˆ›å»ºå‹</strong></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/01_singleton">å•ä¾‹æ¨¡å¼(Singleton Design Pattern)</a></td><td style="text-align:center">âœ…</td><td style="text-align:center"><a href="https://lailin.xyz/post/singleton.html">Go è®¾è®¡æ¨¡å¼ 01-å•ä¾‹æ¨¡å¼</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/02_factory">å·¥å‚æ¨¡å¼(Factory Design Pattern)</a></td><td style="text-align:center">âœ…</td><td style="text-align:center"><a href="https://lailin.xyz/post/factory.html">Go è®¾è®¡æ¨¡å¼ 02-å·¥å‚æ¨¡å¼&amp;DI å®¹å™¨</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/03_builder">å»ºé€ è€…æ¨¡å¼(Builder Design Pattern)</a></td><td style="text-align:center">âœ…</td><td style="text-align:center"><a href="https://lailin.xyz/post/builder.html">Go è®¾è®¡æ¨¡å¼ 03-å»ºé€ è€…æ¨¡å¼</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/04_prototype">åŸå‹æ¨¡å¼(Prototype Design Pattern)</a></td><td style="text-align:center">âŒ</td><td style="text-align:center"><a href="https://lailin.xyz/post/prototype.html">Go è®¾è®¡æ¨¡å¼ 04-åŸå‹æ¨¡å¼</a></td></tr><tr><td style="text-align:center"><strong>ç»“æ„å‹</strong></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/05_proxy">ä»£ç†æ¨¡å¼(Proxy Design Pattern)</a></td><td style="text-align:center">âœ…</td><td style="text-align:center"><a href="https://lailin.xyz/post/proxy.html">Go è®¾è®¡æ¨¡å¼ 06-ä»£ç†æ¨¡å¼(generate å®ç°ç±»ä¼¼åŠ¨æ€ä»£ç†)</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/06_bridge">æ¡¥æ¥æ¨¡å¼(Bridge Design Pattern)</a></td><td style="text-align:center">âœ…</td><td style="text-align:center"><a href="https://lailin.xyz/post/bridge.html">Go è®¾è®¡æ¨¡å¼ 07-æ¡¥æ¥æ¨¡å¼</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/07_decorator">è£…é¥°å™¨æ¨¡å¼(Decorator Design Pattern)</a></td><td style="text-align:center">âœ…</td><td style="text-align:center"><a href="https://lailin.xyz/post/decorator.html">Go è®¾è®¡æ¨¡å¼ 08-è£…é¥°å™¨æ¨¡å¼</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/08_adapter">é€‚é…å™¨æ¨¡å¼(Adapter Design Pattern)</a></td><td style="text-align:center">âœ…</td><td style="text-align:center"><a href="https://lailin.xyz/post/adapter.html">Go è®¾è®¡æ¨¡å¼ 09-é€‚é…å™¨æ¨¡å¼</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/09_facade">é—¨é¢æ¨¡å¼(Facade Design Pattern)</a></td><td style="text-align:center">âŒ</td><td style="text-align:center"><a href="https://lailin.xyz/post/facade.html">Go è®¾è®¡æ¨¡å¼ 10-é—¨é¢æ¨¡å¼</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/10_composite">ç»„åˆæ¨¡å¼(Composite Design Pattern)</a></td><td style="text-align:center">âŒ</td><td style="text-align:center"><a href="https://lailin.xyz/post/composite.html">Go è®¾è®¡æ¨¡å¼ 11-ç»„åˆæ¨¡å¼</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/11_flyweight">äº«å…ƒæ¨¡å¼(Flyweight Design Pattern)</a></td><td style="text-align:center">âŒ</td><td style="text-align:center"><a href="https://lailin.xyz/post/flyweight.html">Go è®¾è®¡æ¨¡å¼ 12-äº«å…ƒæ¨¡å¼</a></td></tr><tr><td style="text-align:center"><strong>è¡Œä¸ºå‹</strong></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/12_observer">è§‚å¯Ÿè€…æ¨¡å¼(Observer Design Pattern)</a></td><td style="text-align:center">âœ…</td><td style="text-align:center"><a href="https://lailin.xyz/post/observer.html">Go è®¾è®¡æ¨¡å¼ 13-è§‚å¯Ÿè€…æ¨¡å¼(å®ç°ç®€å•çš„ EventBus)</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/13_template">æ¨¡æ¿æ¨¡å¼(Template Method Design Pattern)</a></td><td style="text-align:center">âœ…</td><td style="text-align:center"><a href="https://lailin.xyz/post/template.html">Go æ¨¡æ¿æ¨¡å¼ 14-æ¨¡æ¿æ¨¡å¼</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/14_strategy">ç­–ç•¥æ¨¡å¼(Strategy Method Design Pattern)</a></td><td style="text-align:center">âœ…</td><td style="text-align:center"><a href="https://lailin.xyz/post/strategy.html">Go è®¾è®¡æ¨¡å¼ 15-ç­–ç•¥æ¨¡å¼</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/15_chain">èŒè´£é“¾æ¨¡å¼(Chain Of Responsibility Design Pattern)</a></td><td style="text-align:center">âœ…</td><td style="text-align:center"><a href="https://lailin.xyz/post/chain.html">Go è®¾è®¡æ¨¡å¼ 16-èŒè´£é“¾æ¨¡å¼(Gin çš„ä¸­é—´ä»¶å®ç°)</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/16_state">çŠ¶æ€æ¨¡å¼(State Design Pattern)</a></td><td style="text-align:center">âœ…</td><td style="text-align:center"><a href="https://lailin.xyz/post/state.html">Go è®¾è®¡æ¨¡å¼ 17-çŠ¶æ€æ¨¡å¼</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/17_iterator">è¿­ä»£å™¨æ¨¡å¼(Iterator Design Pattern)</a></td><td style="text-align:center">âœ…</td><td style="text-align:center"><a href="https://lailin.xyz/post/iterator.html">Go è®¾è®¡æ¨¡å¼ 18-è¿­ä»£å™¨æ¨¡å¼</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/18_visitor/visitor.go">è®¿é—®è€…æ¨¡å¼(Visitor Design Pattern)</a></td><td style="text-align:center">âŒ</td><td style="text-align:center"><a href="https://lailin.xyz/post/visitor.html">Go è®¾è®¡æ¨¡å¼ 19-è®¿é—®è€…æ¨¡å¼</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/19_memento">å¤‡å¿˜å½•æ¨¡å¼(Memento Design Pattern)</a></td><td style="text-align:center">âŒ</td><td style="text-align:center"><a href="https://lailin.xyz/post/memento.html">Go è®¾è®¡æ¨¡å¼ 20-å¤‡å¿˜å½•æ¨¡å¼</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/20_command">å‘½ä»¤æ¨¡å¼(Command Design Pattern)</a></td><td style="text-align:center">âŒ</td><td style="text-align:center"><a href="https://lailin.xyz/post/command.html">Go è®¾è®¡æ¨¡å¼ 21-å‘½ä»¤æ¨¡å¼</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/21_interpreter">è§£é‡Šå™¨æ¨¡å¼(Interpreter Design Pattern)</a></td><td style="text-align:center">âŒ</td><td style="text-align:center"><a href="https://lailin.xyz/post/interpreter.html">Go è®¾è®¡æ¨¡å¼ 22-è§£é‡Šå™¨æ¨¡å¼</a></td></tr><tr><td style="text-align:center"></td><td style="text-align:center"><a href="https://github.com/mohuishou/go-design-pattern/blob/master/22_mediator">ä¸­ä»‹æ¨¡å¼(Mediator Design Pattern)</a></td><td style="text-align:center">âŒ</td><td style="text-align:center"><a href="https://lailin.xyz/post/mediator.html">Go è®¾è®¡æ¨¡å¼ 23-ä¸­ä»‹æ¨¡å¼</a></td></tr></tbody></table><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>æ€»ç»“</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼23-ä¸­ä»‹æ¨¡å¼</title>
    <link href="/post/mediator.html"/>
    <url>/post/mediator.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/226710">73 | ä¸­ä»‹æ¨¡å¼ï¼šä»€ä¹ˆæ—¶å€™ç”¨ä¸­ä»‹æ¨¡å¼ï¼Ÿä»€ä¹ˆæ—¶å€™ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼Ÿ</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 23/24 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154460349-be763ff7-4247-4a3e-adaa-68da5146d4e9.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Package mediator ä¸­ä»‹æ¨¡å¼</span><br><span class="hljs-comment">// é‡‡ç”¨åŸè¯¾ç¨‹çš„ç¤ºä¾‹ï¼Œå¹¶ä¸”åšäº†ä¸€äº›è£å‰ª</span><br><span class="hljs-comment">// å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªè¾ƒä¸ºå¤æ‚çš„å¯¹è¯æ¡†ï¼Œé‡Œé¢åŒ…æ‹¬ï¼Œç™»å½•ç»„ä»¶ï¼Œæ³¨å†Œç»„ä»¶ï¼Œä»¥åŠé€‰æ‹©æ¡†</span><br><span class="hljs-comment">// å½“é€‰æ‹©æ¡†é€‰æ‹©â€œç™»å½•â€æ—¶ï¼Œå±•ç¤ºç™»å½•ç›¸å…³ç»„ä»¶</span><br><span class="hljs-comment">// å½“é€‰æ‹©æ¡†é€‰æ‹©â€œæ³¨å†Œâ€æ—¶ï¼Œå±•ç¤ºæ³¨å†Œç›¸å…³ç»„ä»¶</span><br><span class="hljs-keyword">package</span> mediator<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;reflect&quot;</span><br>)<br><br><span class="hljs-comment">// Input å‡è®¾è¿™è¡¨ç¤ºä¸€ä¸ªè¾“å…¥æ¡†</span><br><span class="hljs-keyword">type</span> Input <span class="hljs-keyword">string</span><br><br><span class="hljs-comment">// String String</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(i Input)</span> <span class="hljs-title">String</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">string</span>(i)<br>&#125;<br><br><span class="hljs-comment">// Selection å‡è®¾è¿™è¡¨ç¤ºä¸€ä¸ªé€‰æ‹©æ¡†</span><br><span class="hljs-keyword">type</span> Selection <span class="hljs-keyword">string</span><br><br><span class="hljs-comment">// Selected å½“å‰é€‰ä¸­çš„å¯¹è±¡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s Selection)</span> <span class="hljs-title">Selected</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">string</span>(s)<br>&#125;<br><br><span class="hljs-comment">// Button å‡è®¾è¿™è¡¨ç¤ºä¸€ä¸ªæŒ‰é’®</span><br><span class="hljs-keyword">type</span> Button <span class="hljs-keyword">struct</span> &#123;<br>onClick <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span><br>&#125;<br><br><span class="hljs-comment">// SetOnClick æ·»åŠ ç‚¹å‡»äº‹ä»¶å›è°ƒ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Button)</span> <span class="hljs-title">SetOnClick</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>()</span>)</span> &#123;<br>b.onClick = f<br>&#125;<br><br><span class="hljs-comment">// IMediator ä¸­ä»‹æ¨¡å¼æ¥å£</span><br><span class="hljs-keyword">type</span> IMediator <span class="hljs-keyword">interface</span> &#123;<br>HandleEvent(component <span class="hljs-keyword">interface</span>&#123;&#125;)<br>&#125;<br><br><span class="hljs-comment">// Dialog å¯¹è¯æ¡†ç»„ä»¶</span><br><span class="hljs-keyword">type</span> Dialog <span class="hljs-keyword">struct</span> &#123;<br>LoginButton         *Button<br>RegButton           *Button<br>Selection           *Selection<br>UsernameInput       *Input<br>PasswordInput       *Input<br>RepeatPasswordInput *Input<br>&#125;<br><br><span class="hljs-comment">// HandleEvent HandleEvent</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d *Dialog)</span> <span class="hljs-title">HandleEvent</span><span class="hljs-params">(component <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br><span class="hljs-keyword">switch</span> &#123;<br><span class="hljs-keyword">case</span> reflect.DeepEqual(component, d.Selection):<br><span class="hljs-keyword">if</span> d.Selection.Selected() == <span class="hljs-string">&quot;ç™»å½•&quot;</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;select login&quot;</span>)<br>fmt.Printf(<span class="hljs-string">&quot;show: %s\n&quot;</span>, d.UsernameInput)<br>fmt.Printf(<span class="hljs-string">&quot;show: %s\n&quot;</span>, d.PasswordInput)<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> d.Selection.Selected() == <span class="hljs-string">&quot;æ³¨å†Œ&quot;</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;select register&quot;</span>)<br>fmt.Printf(<span class="hljs-string">&quot;show: %s\n&quot;</span>, d.UsernameInput)<br>fmt.Printf(<span class="hljs-string">&quot;show: %s\n&quot;</span>, d.PasswordInput)<br>fmt.Printf(<span class="hljs-string">&quot;show: %s\n&quot;</span>, d.RepeatPasswordInput)<br>&#125;<br><span class="hljs-comment">// others, å¦‚æœç‚¹å‡»äº†ç™»å½•æŒ‰é’®ï¼Œæ³¨å†ŒæŒ‰é’®</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> mediator<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestDemo</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>usernameInput := Input(<span class="hljs-string">&quot;username input&quot;</span>)<br>passwordInput := Input(<span class="hljs-string">&quot;password input&quot;</span>)<br>repeatPwdInput := Input(<span class="hljs-string">&quot;repeat password input&quot;</span>)<br><br>selection := Selection(<span class="hljs-string">&quot;ç™»å½•&quot;</span>)<br>d := &amp;Dialog&#123;<br>Selection:           &amp;selection,<br>UsernameInput:       &amp;usernameInput,<br>PasswordInput:       &amp;passwordInput,<br>RepeatPasswordInput: &amp;repeatPwdInput,<br>&#125;<br>d.HandleEvent(&amp;selection)<br><br>regSelection := Selection(<span class="hljs-string">&quot;æ³¨å†Œ&quot;</span>)<br>d.Selection = &amp;regSelection<br>d.HandleEvent(&amp;regSelection)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>è¡Œä¸ºå‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼22-è§£é‡Šå™¨æ¨¡å¼</title>
    <link href="/post/interpreter.html"/>
    <url>/post/interpreter.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/225904">72 | è§£é‡Šå™¨æ¨¡å¼ï¼šå¦‚ä½•è®¾è®¡å®ç°ä¸€ä¸ªè‡ªå®šä¹‰æ¥å£å‘Šè­¦è§„åˆ™åŠŸèƒ½ï¼Ÿ</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 22/24 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154449974-ca9fbc7c-7cbc-4753-ad43-776dedf33c3b.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Package interpreter è§£é‡Šå™¨æ¨¡å¼</span><br><span class="hljs-comment">// é‡‡ç”¨åŸè¯¾ç¨‹çš„ç¤ºä¾‹, å¹¶ä¸”åšäº†ä¸€ä¸‹ç®€åŒ–</span><br><span class="hljs-comment">// å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªç›‘æ§ç³»ç»Ÿ</span><br><span class="hljs-comment">// ç°åœ¨éœ€è¦å®ç°ä¸€ä¸ªå‘Šè­¦æ¨¡å—ï¼Œå¯ä»¥æ ¹æ®è¾“å…¥çš„å‘Šè­¦è§„åˆ™æ¥å†³å®šæ˜¯å¦è§¦å‘å‘Šè­¦</span><br><span class="hljs-comment">// å‘Šè­¦è§„åˆ™æ”¯æŒ &amp;&amp;ã€&gt;ã€&lt; 3ç§è¿ç®—ç¬¦</span><br><span class="hljs-comment">// å…¶ä¸­ &gt;ã€&lt; ä¼˜å…ˆçº§æ¯”  &amp;&amp; æ›´é«˜</span><br><span class="hljs-keyword">package</span> interpreter<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;regexp&quot;</span><br><span class="hljs-string">&quot;strconv&quot;</span><br><span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-comment">// AlertRule å‘Šè­¦è§„åˆ™</span><br><span class="hljs-keyword">type</span> AlertRule <span class="hljs-keyword">struct</span> &#123;<br>expression IExpression<br>&#125;<br><br><span class="hljs-comment">// NewAlertRule NewAlertRule</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewAlertRule</span><span class="hljs-params">(rule <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*AlertRule, error)</span></span> &#123;<br>exp, err := NewAndExpression(rule)<br><span class="hljs-keyword">return</span> &amp;AlertRule&#123;expression: exp&#125;, err<br>&#125;<br><br><span class="hljs-comment">// Interpret åˆ¤æ–­å‘Šè­¦æ˜¯å¦è§¦å‘</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r AlertRule)</span> <span class="hljs-title">Interpret</span><span class="hljs-params">(stats <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">float64</span>)</span> <span class="hljs-title">bool</span></span> &#123;<br><span class="hljs-keyword">return</span> r.expression.Interpret(stats)<br>&#125;<br><br><span class="hljs-comment">// IExpression è¡¨è¾¾å¼æ¥å£</span><br><span class="hljs-keyword">type</span> IExpression <span class="hljs-keyword">interface</span> &#123;<br>Interpret(stats <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">float64</span>) <span class="hljs-keyword">bool</span><br>&#125;<br><br><span class="hljs-comment">// GreaterExpression &gt;</span><br><span class="hljs-keyword">type</span> GreaterExpression <span class="hljs-keyword">struct</span> &#123;<br>key   <span class="hljs-keyword">string</span><br>value <span class="hljs-keyword">float64</span><br>&#125;<br><br><span class="hljs-comment">// Interpret Interpret</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g GreaterExpression)</span> <span class="hljs-title">Interpret</span><span class="hljs-params">(stats <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">float64</span>)</span> <span class="hljs-title">bool</span></span> &#123;<br>v, ok := stats[g.key]<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">return</span> v &gt; g.value<br>&#125;<br><br><span class="hljs-comment">// NewGreaterExpression NewGreaterExpression</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewGreaterExpression</span><span class="hljs-params">(exp <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*GreaterExpression, error)</span></span> &#123;<br>data := regexp.MustCompile(<span class="hljs-string">`\s+`</span>).Split(strings.TrimSpace(exp), <span class="hljs-number">-1</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) != <span class="hljs-number">3</span> || data[<span class="hljs-number">1</span>] != <span class="hljs-string">&quot;&gt;&quot;</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;exp is invalid: %s&quot;</span>, exp)<br>&#125;<br><br>val, err := strconv.ParseFloat(data[<span class="hljs-number">2</span>], <span class="hljs-number">10</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;exp is invalid: %s&quot;</span>, exp)<br>&#125;<br><br><span class="hljs-keyword">return</span> &amp;GreaterExpression&#123;<br>key:   data[<span class="hljs-number">0</span>],<br>value: val,<br>&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// LessExpression &lt;</span><br><span class="hljs-keyword">type</span> LessExpression <span class="hljs-keyword">struct</span> &#123;<br>key   <span class="hljs-keyword">string</span><br>value <span class="hljs-keyword">float64</span><br>&#125;<br><br><span class="hljs-comment">// Interpret Interpret</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g LessExpression)</span> <span class="hljs-title">Interpret</span><span class="hljs-params">(stats <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">float64</span>)</span> <span class="hljs-title">bool</span></span> &#123;<br>v, ok := stats[g.key]<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">return</span> v &lt; g.value<br>&#125;<br><br><span class="hljs-comment">// NewLessExpression NewLessExpression</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewLessExpression</span><span class="hljs-params">(exp <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*LessExpression, error)</span></span> &#123;<br>data := regexp.MustCompile(<span class="hljs-string">`\s+`</span>).Split(strings.TrimSpace(exp), <span class="hljs-number">-1</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) != <span class="hljs-number">3</span> || data[<span class="hljs-number">1</span>] != <span class="hljs-string">&quot;&lt;&quot;</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;exp is invalid: %s&quot;</span>, exp)<br>&#125;<br><br>val, err := strconv.ParseFloat(data[<span class="hljs-number">2</span>], <span class="hljs-number">10</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;exp is invalid: %s&quot;</span>, exp)<br>&#125;<br><br><span class="hljs-keyword">return</span> &amp;LessExpression&#123;<br>key:   data[<span class="hljs-number">0</span>],<br>value: val,<br>&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// AndExpression &amp;&amp;</span><br><span class="hljs-keyword">type</span> AndExpression <span class="hljs-keyword">struct</span> &#123;<br>expressions []IExpression<br>&#125;<br><br><span class="hljs-comment">// Interpret Interpret</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e AndExpression)</span> <span class="hljs-title">Interpret</span><span class="hljs-params">(stats <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">float64</span>)</span> <span class="hljs-title">bool</span></span> &#123;<br><span class="hljs-keyword">for</span> _, expression := <span class="hljs-keyword">range</span> e.expressions &#123;<br><span class="hljs-keyword">if</span> !expression.Interpret(stats) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-comment">// NewAndExpression NewAndExpression</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewAndExpression</span><span class="hljs-params">(exp <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*AndExpression, error)</span></span> &#123;<br>exps := strings.Split(exp, <span class="hljs-string">&quot;&amp;&amp;&quot;</span>)<br>expressions := <span class="hljs-built_in">make</span>([]IExpression, <span class="hljs-built_in">len</span>(exps))<br><br><span class="hljs-keyword">for</span> i, e := <span class="hljs-keyword">range</span> exps &#123;<br><span class="hljs-keyword">var</span> expression IExpression<br><span class="hljs-keyword">var</span> err error<br><br><span class="hljs-keyword">switch</span> &#123;<br><span class="hljs-keyword">case</span> strings.Contains(e, <span class="hljs-string">&quot;&gt;&quot;</span>):<br>expression, err = NewGreaterExpression(e)<br><span class="hljs-keyword">case</span> strings.Contains(e, <span class="hljs-string">&quot;&lt;&quot;</span>):<br>expression, err = NewLessExpression(e)<br><span class="hljs-keyword">default</span>:<br>err = fmt.Errorf(<span class="hljs-string">&quot;exp is invalid: %s&quot;</span>, exp)<br>&#125;<br><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br>expressions[i] = expression<br>&#125;<br><br><span class="hljs-keyword">return</span> &amp;AndExpression&#123;expressions: expressions&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> interpreter<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br><span class="hljs-string">&quot;github.com/stretchr/testify/require&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestAlertRule_Interpret</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>stats := <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">float64</span>&#123;<br><span class="hljs-string">&quot;a&quot;</span>: <span class="hljs-number">1</span>,<br><span class="hljs-string">&quot;b&quot;</span>: <span class="hljs-number">2</span>,<br><span class="hljs-string">&quot;c&quot;</span>: <span class="hljs-number">3</span>,<br>&#125;<br>tests := []<span class="hljs-keyword">struct</span> &#123;<br>name  <span class="hljs-keyword">string</span><br>stats <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">float64</span><br>rule  <span class="hljs-keyword">string</span><br>want  <span class="hljs-keyword">bool</span><br>&#125;&#123;<br>&#123;<br>name:  <span class="hljs-string">&quot;case1&quot;</span>,<br>stats: stats,<br>rule:  <span class="hljs-string">&quot;a &gt; 1 &amp;&amp; b &gt; 10 &amp;&amp; c &lt; 5&quot;</span>,<br>want:  <span class="hljs-literal">false</span>,<br>&#125;,<br>&#123;<br>name:  <span class="hljs-string">&quot;case2&quot;</span>,<br>stats: stats,<br>rule:  <span class="hljs-string">&quot;a &lt; 2 &amp;&amp; b &gt; 10 &amp;&amp; c &lt; 5&quot;</span>,<br>want:  <span class="hljs-literal">false</span>,<br>&#125;,<br>&#123;<br>name:  <span class="hljs-string">&quot;case3&quot;</span>,<br>stats: stats,<br>rule:  <span class="hljs-string">&quot;a &lt; 5 &amp;&amp; b &gt; 1 &amp;&amp; c &lt; 10&quot;</span>,<br>want:  <span class="hljs-literal">false</span>,<br>&#125;,<br>&#125;<br><span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;<br>t.Run(tt.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>r, err := NewAlertRule(tt.rule)<br>require.NoError(t, err)<br>assert.Equal(t, tt.want, r.Interpret(tt.stats))<br>&#125;)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>è¡Œä¸ºå‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼21-å‘½ä»¤æ¨¡å¼</title>
    <link href="/post/command.html"/>
    <url>/post/command.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/224549">71 | å‘½ä»¤æ¨¡å¼ï¼šå¦‚ä½•åˆ©ç”¨å‘½ä»¤æ¨¡å¼å®ç°ä¸€ä¸ªæ‰‹æ¸¸åç«¯æ¶æ„ï¼Ÿ</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 21/24 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154439561-d9919c73-0afb-467d-bd0b-70708362b923.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>æ¥ä¸‹æ¥ä¼šæœ‰ä¸¤ä¸ªä¾‹å­ï¼Œç¬¬ä¸€ä¸ªæ˜¯æŒ‰ç…§åŸæ–‡å®šä¹‰çš„æ–¹å¼ï¼Œå°†å‡½æ•°å°è£…æˆå¯¹è±¡ï¼Œç¬¬äºŒä¸ªä¾‹å­æˆ‘ä»¬ç›´æ¥å°†å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ã€‚</p><h3 id="å°†å‡½æ•°å°è£…ä¸ºå¯¹è±¡"><a href="#å°†å‡½æ•°å°è£…ä¸ºå¯¹è±¡" class="headerlink" title="å°†å‡½æ•°å°è£…ä¸ºå¯¹è±¡"></a>å°†å‡½æ•°å°è£…ä¸ºå¯¹è±¡</h3><h4 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Package command å‘½ä»¤æ¨¡å¼</span><br><span class="hljs-comment">// Blog: https://lailin.xyz/post/command.html</span><br><span class="hljs-comment">// è¿™æ˜¯ç¤ºä¾‹ä¸€ï¼Œé‡‡ç”¨å°†å‡½æ•°å°è£…ä¸ºå¯¹è±¡çš„æ–¹å¼å®ç°ï¼Œ</span><br><span class="hljs-comment">// ç¤ºä¾‹è¯´æ˜:</span><br><span class="hljs-comment">// å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªæ¸¸æˆæœåŠ¡ï¼Œæˆ‘ä»¬æ­£åœ¨å®ç°ä¸€ä¸ªæ¸¸æˆåç«¯</span><br><span class="hljs-comment">// ä½¿ç”¨ä¸€ä¸ª goroutine ä¸æ–­æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯è¯·æ±‚çš„å‘½ä»¤ï¼Œå¹¶ä¸”å°†å®ƒæ”¾ç½®åˆ°ä¸€ä¸ªé˜Ÿåˆ—å½“ä¸­</span><br><span class="hljs-comment">// ç„¶åæˆ‘ä»¬åœ¨å¦å¤–ä¸€ä¸ª goroutine ä¸­æ¥æ‰§è¡Œå®ƒ</span><br><span class="hljs-keyword">package</span> command<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-comment">// ICommand å‘½ä»¤</span><br><span class="hljs-keyword">type</span> ICommand <span class="hljs-keyword">interface</span> &#123;<br>Execute() error<br>&#125;<br><br><span class="hljs-comment">// StartCommand æ¸¸æˆå¼€å§‹è¿è¡Œ</span><br><span class="hljs-keyword">type</span> StartCommand <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// NewStartCommand NewStartCommand</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewStartCommand</span><span class="hljs-params">( /*æ­£å¸¸æƒ…å†µä¸‹è¿™é‡Œä¼šæœ‰ä¸€äº›å‚æ•°*/ )</span> *<span class="hljs-title">StartCommand</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;StartCommand&#123;&#125;<br>&#125;<br><br><span class="hljs-comment">// Execute Execute</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *StartCommand)</span> <span class="hljs-title">Execute</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;game start&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// ArchiveCommand æ¸¸æˆå­˜æ¡£</span><br><span class="hljs-keyword">type</span> ArchiveCommand <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// NewArchiveCommand NewArchiveCommand</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewArchiveCommand</span><span class="hljs-params">( /*æ­£å¸¸æƒ…å†µä¸‹è¿™é‡Œä¼šæœ‰ä¸€äº›å‚æ•°*/ )</span> *<span class="hljs-title">ArchiveCommand</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;ArchiveCommand&#123;&#125;<br>&#125;<br><br><span class="hljs-comment">// Execute Execute</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *ArchiveCommand)</span> <span class="hljs-title">Execute</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;game archive&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> command<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;testing&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestDemo</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-comment">// ç”¨äºæµ‹è¯•ï¼Œæ¨¡æ‹Ÿæ¥è‡ªå®¢æˆ·ç«¯çš„äº‹ä»¶</span><br>eventChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">string</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>events := []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">&quot;start&quot;</span>, <span class="hljs-string">&quot;archive&quot;</span>, <span class="hljs-string">&quot;start&quot;</span>, <span class="hljs-string">&quot;archive&quot;</span>, <span class="hljs-string">&quot;start&quot;</span>, <span class="hljs-string">&quot;start&quot;</span>&#125;<br><span class="hljs-keyword">for</span> _, e := <span class="hljs-keyword">range</span> events &#123;<br>eventChan &lt;- e<br>&#125;<br>&#125;()<br><span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(eventChan)<br><br><span class="hljs-comment">// ä½¿ç”¨å‘½ä»¤é˜Ÿåˆ—ç¼“å­˜å‘½ä»¤</span><br>commands := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ICommand, <span class="hljs-number">1000</span>)<br><span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(commands)<br><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-comment">// ä»è¯·æ±‚æˆ–è€…å…¶ä»–åœ°æ–¹è·å–ç›¸å…³äº‹ä»¶å‚æ•°</span><br>event, ok := &lt;-eventChan<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-keyword">var</span> command ICommand<br><span class="hljs-keyword">switch</span> event &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;start&quot;</span>:<br>command = NewStartCommand()<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;archive&quot;</span>:<br>command = NewArchiveCommand()<br>&#125;<br><br><span class="hljs-comment">// å°†å‘½ä»¤å…¥é˜Ÿ</span><br>commands &lt;- command<br>&#125;<br>&#125;()<br><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> c := &lt;-commands:<br>c.Execute()<br><span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">1</span> * time.Second):<br>fmt.Println(<span class="hljs-string">&quot;timeout 1s&quot;</span>)<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å°†å‡½æ•°ç›´æ¥ä½œä¸ºå‚æ•°"><a href="#å°†å‡½æ•°ç›´æ¥ä½œä¸ºå‚æ•°" class="headerlink" title="å°†å‡½æ•°ç›´æ¥ä½œä¸ºå‚æ•°"></a>å°†å‡½æ•°ç›´æ¥ä½œä¸ºå‚æ•°</h3><h4 id="Code-1"><a href="#Code-1" class="headerlink" title="Code"></a>Code</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Package command å‘½ä»¤æ¨¡å¼</span><br><span class="hljs-comment">// Blog: https://lailin.xyz/post/command.html</span><br><span class="hljs-comment">// è¿™æ˜¯ç¤ºä¾‹äºŒï¼Œé‡‡ç”¨å°†ç›´æ¥è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œä¸ç”¨å¯¹è±¡</span><br><span class="hljs-comment">// ç¤ºä¾‹è¯´æ˜:</span><br><span class="hljs-comment">// å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªæ¸¸æˆæœåŠ¡ï¼Œæˆ‘ä»¬æ­£åœ¨å®ç°ä¸€ä¸ªæ¸¸æˆåç«¯</span><br><span class="hljs-comment">// ä½¿ç”¨ä¸€ä¸ª goroutine ä¸æ–­æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯è¯·æ±‚çš„å‘½ä»¤ï¼Œå¹¶ä¸”å°†å®ƒæ”¾ç½®åˆ°ä¸€ä¸ªé˜Ÿåˆ—å½“ä¸­</span><br><span class="hljs-comment">// ç„¶åæˆ‘ä»¬åœ¨å¦å¤–ä¸€ä¸ª goroutine ä¸­æ¥æ‰§è¡Œå®ƒ</span><br><span class="hljs-keyword">package</span> command<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-comment">// Command å‘½ä»¤</span><br><span class="hljs-keyword">type</span> Command <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span><br><br><span class="hljs-comment">// StartCommandFunc è¿”å›ä¸€ä¸ª Command å‘½ä»¤</span><br><span class="hljs-comment">// æ˜¯å› ä¸ºæ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šæ˜¯è¿™ä¹ˆç®€å•çš„å‡½æ•°</span><br><span class="hljs-comment">// ä¸€èˆ¬éƒ½ä¼šæœ‰ä¸€äº›å‚æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StartCommandFunc</span><span class="hljs-params">()</span> <span class="hljs-title">Command</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;game start&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br>&#125;<br><br><span class="hljs-comment">// ArchiveCommandFunc ArchiveCommandFunc</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ArchiveCommandFunc</span><span class="hljs-params">()</span> <span class="hljs-title">Command</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;game archive&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æµ‹è¯•-1"><a href="#æµ‹è¯•-1" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> command<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;testing&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestDemoFunc</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-comment">// ç”¨äºæµ‹è¯•ï¼Œæ¨¡æ‹Ÿæ¥è‡ªå®¢æˆ·ç«¯çš„äº‹ä»¶</span><br>eventChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">string</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>events := []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">&quot;start&quot;</span>, <span class="hljs-string">&quot;archive&quot;</span>, <span class="hljs-string">&quot;start&quot;</span>, <span class="hljs-string">&quot;archive&quot;</span>, <span class="hljs-string">&quot;start&quot;</span>, <span class="hljs-string">&quot;start&quot;</span>&#125;<br><span class="hljs-keyword">for</span> _, e := <span class="hljs-keyword">range</span> events &#123;<br>eventChan &lt;- e<br>&#125;<br><br>&#125;()<br><span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(eventChan)<br><br><span class="hljs-comment">// ä½¿ç”¨å‘½ä»¤é˜Ÿåˆ—ç¼“å­˜å‘½ä»¤</span><br>commands := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Command, <span class="hljs-number">1000</span>)<br><span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(commands)<br><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-comment">// ä»è¯·æ±‚æˆ–è€…å…¶ä»–åœ°æ–¹è·å–ç›¸å…³äº‹ä»¶å‚æ•°</span><br>event, ok := &lt;-eventChan<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-keyword">var</span> command Command<br><span class="hljs-keyword">switch</span> event &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;start&quot;</span>:<br>command = StartCommandFunc()<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;archive&quot;</span>:<br>command = ArchiveCommandFunc()<br>&#125;<br><br><span class="hljs-comment">// å°†å‘½ä»¤å…¥é˜Ÿ</span><br>commands &lt;- command<br>&#125;<br>&#125;()<br><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> c := &lt;-commands:<br>c()<br><span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">1</span> * time.Second):<br>fmt.Println(<span class="hljs-string">&quot;timeout 1s&quot;</span>)<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>è¡Œä¸ºå‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼20-å¤‡å¿˜å½•æ¨¡å¼</title>
    <link href="/post/memento.html"/>
    <url>/post/memento.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/223947">70 | å¤‡å¿˜å½•æ¨¡å¼ï¼šå¯¹äºå¤§å¯¹è±¡çš„å¤‡ä»½å’Œæ¢å¤ï¼Œå¦‚ä½•ä¼˜åŒ–å†…å­˜å’Œæ—¶é—´çš„æ¶ˆè€—ï¼Ÿ</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 20/24 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154429386-ecc22950-5378-4064-a658-109b323a3a0f.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Package memento å¤‡å¿˜å½•æ¨¡å¼</span><br><span class="hljs-comment">// ä¸‹é¢è¿™ä¸ªä¾‹å­é‡‡ç”¨åŸè¯¾ç¨‹çš„ä¾‹å­ï¼Œä¸€ä¸ªè¾“å…¥ç¨‹åº</span><br><span class="hljs-comment">// å¦‚æœè¾“å…¥ :list åˆ™æ˜¾ç¤ºå½“å‰ä¿å­˜çš„å†…å®¹</span><br><span class="hljs-comment">// å¦‚æœè¾“å…¥ :undo åˆ™åˆ é™¤ä¸Šä¸€æ¬¡çš„è¾“å…¥</span><br><span class="hljs-comment">// å¦‚æœè¾“å…¥å…¶ä»–çš„å†…å®¹åˆ™è¿½åŠ ä¿å­˜</span><br><span class="hljs-keyword">package</span> memento<br><br><span class="hljs-comment">// InputText ç”¨äºä¿å­˜æ•°æ®</span><br><span class="hljs-keyword">type</span> InputText <span class="hljs-keyword">struct</span> &#123;<br>content <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-comment">// Append è¿½åŠ æ•°æ®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(in *InputText)</span> <span class="hljs-title">Append</span><span class="hljs-params">(content <span class="hljs-keyword">string</span>)</span></span> &#123;<br>in.content += content<br>&#125;<br><br><span class="hljs-comment">// GetText è·å–æ•°æ®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(in *InputText)</span> <span class="hljs-title">GetText</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">return</span> in.content<br>&#125;<br><br><span class="hljs-comment">// Snapshot åˆ›å»ºå¿«ç…§</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(in *InputText)</span> <span class="hljs-title">Snapshot</span><span class="hljs-params">()</span> *<span class="hljs-title">Snapshot</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;Snapshot&#123;content: in.content&#125;<br>&#125;<br><br><span class="hljs-comment">// Restore ä»å¿«ç…§ä¸­æ¢å¤</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(in *InputText)</span> <span class="hljs-title">Restore</span><span class="hljs-params">(s *Snapshot)</span></span> &#123;<br>in.content = s.GetText()<br>&#125;<br><br><span class="hljs-comment">// Snapshot å¿«ç…§ï¼Œç”¨äºå­˜å‚¨æ•°æ®å¿«ç…§</span><br><span class="hljs-comment">// å¯¹äºå¿«ç…§æ¥è¯´ï¼Œåªèƒ½ä¸èƒ½è¢«å¤–éƒ¨ï¼ˆä¸åŒåŒ…ï¼‰ä¿®æ”¹ï¼Œåªèƒ½è·å–æ•°æ®ï¼Œæ»¡è¶³å°è£…çš„ç‰¹æ€§</span><br><span class="hljs-keyword">type</span> Snapshot <span class="hljs-keyword">struct</span> &#123;<br>content <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-comment">// GetText GetText</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Snapshot)</span> <span class="hljs-title">GetText</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">return</span> s.content<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> memento<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestDemo</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>in := &amp;InputText&#123;&#125;<br>snapshots := []*Snapshot&#123;&#125;<br><br>tests := []<span class="hljs-keyword">struct</span> &#123;<br>input <span class="hljs-keyword">string</span><br>want  <span class="hljs-keyword">string</span><br>&#125;&#123;<br>&#123;<br>input: <span class="hljs-string">&quot;:list&quot;</span>,<br>want:  <span class="hljs-string">&quot;&quot;</span>,<br>&#125;,<br>&#123;<br>input: <span class="hljs-string">&quot;hello&quot;</span>,<br>want:  <span class="hljs-string">&quot;&quot;</span>,<br>&#125;,<br>&#123;<br>input: <span class="hljs-string">&quot;:list&quot;</span>,<br>want:  <span class="hljs-string">&quot;hello&quot;</span>,<br>&#125;,<br>&#123;<br>input: <span class="hljs-string">&quot;world&quot;</span>,<br>want:  <span class="hljs-string">&quot;&quot;</span>,<br>&#125;,<br>&#123;<br>input: <span class="hljs-string">&quot;:list&quot;</span>,<br>want:  <span class="hljs-string">&quot;helloworld&quot;</span>,<br>&#125;,<br>&#123;<br>input: <span class="hljs-string">&quot;:undo&quot;</span>,<br>want:  <span class="hljs-string">&quot;&quot;</span>,<br>&#125;,<br>&#123;<br>input: <span class="hljs-string">&quot;:list&quot;</span>,<br>want:  <span class="hljs-string">&quot;hello&quot;</span>,<br>&#125;,<br>&#125;<br><span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;<br>t.Run(tt.input, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">switch</span> tt.input &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;:list&quot;</span>:<br>assert.Equal(t, tt.want, in.GetText())<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;:undo&quot;</span>:<br>in.Restore(snapshots[<span class="hljs-built_in">len</span>(snapshots)<span class="hljs-number">-1</span>])<br>snapshots = snapshots[:<span class="hljs-built_in">len</span>(snapshots)<span class="hljs-number">-1</span>]<br><span class="hljs-keyword">default</span>:<br>snapshots = <span class="hljs-built_in">append</span>(snapshots, in.Snapshot())<br>in.Append(tt.input)<br>&#125;<br>&#125;)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>è¡Œä¸ºå‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼19-è®¿é—®è€…æ¨¡å¼</title>
    <link href="/post/visitor.html"/>
    <url>/post/visitor.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/221852">68 | è®¿é—®è€…æ¨¡å¼ï¼ˆä¸Šï¼‰ï¼šæ‰‹æŠŠæ‰‹å¸¦ä½ è¿˜åŸè®¿é—®è€…æ¨¡å¼è¯ç”Ÿçš„æ€ç»´è¿‡ç¨‹</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 19/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154416485-f2ea2728-3c85-49e3-99e5-1058c9a9f062.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>åŸè¯¾ç¨‹ä¸­è®²è§£è®¿é—®è€…æ¨¡å¼çš„æ—¶å€™ç”¨åˆ°äº†ç»§æ‰¿å’Œå‡½æ•°é‡è½½è¿™ä¸¤ä¸ª Go ä¸­æ²¡æœ‰çš„ç‰¹æ€§ï¼Œæ¥ä¸‹æ¥çš„å‘¢ï¼Œä¼šé€šè¿‡ç»§æ‰¿å®ç°ã€‚<br><strong>æ³¨æ„ç”±äºæ²¡æœ‰å‡½æ•°é‡è½½ï¼Œæ‰€ä»¥æˆ‘ä»¬å¹¶ä¸çŸ¥é“ä¼ é€’è¿‡æ¥çš„å¯¹è±¡æ˜¯ä»€ä¹ˆç±»å‹ï¼Œè¿™ä¸ªæ—¶å€™åªèƒ½é‡‡ç”¨ç±»å‹æ–­è¨€çš„æ–¹å¼æ¥å¯¹ä¸åŒçš„ç±»å‹åšä¸åŒçš„æ“ä½œï¼Œä½†æ˜¯æ­£å¼ç”±äºæ²¡æœ‰å‡½æ•°é‡è½½ï¼Œæ‰€ä»¥å…¶å®å®Œå…¨å¯ä»¥ä¸ç”¨è®¿é—®è€…æ¨¡å¼ç›´æ¥ä¼ å…¥å‚æ•°å°±å¥½äº†ã€‚</strong><br>ä»¥å‰æˆ‘ä»¬ç»å¸¸è¯´ä¸è¦ç”¨å†™å…¶ä»–è¯­è¨€çš„æ–¹å¼æ¥å†™ Goï¼ŒGo ä¸éœ€è¦å¤ªå¤šçš„è®¾è®¡æ¨¡å¼ï¼Œè¿™ä¸ªå°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒé²œæ˜çš„ä¾‹å­</p><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> visitor<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;path&quot;</span><br>)<br><br><span class="hljs-comment">// Visitor è®¿é—®è€…</span><br><span class="hljs-keyword">type</span> Visitor <span class="hljs-keyword">interface</span> &#123;<br>Visit(IResourceFile) error<br>&#125;<br><br><span class="hljs-comment">// IResourceFile IResourceFile</span><br><span class="hljs-keyword">type</span> IResourceFile <span class="hljs-keyword">interface</span> &#123;<br>Accept(Visitor) error<br>&#125;<br><br><span class="hljs-comment">// NewResourceFile NewResourceFile</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewResourceFile</span><span class="hljs-params">(filepath <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(IResourceFile, error)</span></span> &#123;<br><span class="hljs-keyword">switch</span> path.Ext(filepath) &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;.ppt&quot;</span>:<br><span class="hljs-keyword">return</span> &amp;PPTFile&#123;path: filepath&#125;, <span class="hljs-literal">nil</span><br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;.pdf&quot;</span>:<br><span class="hljs-keyword">return</span> &amp;PdfFile&#123;path: filepath&#125;, <span class="hljs-literal">nil</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;not found file type: %s&quot;</span>, filepath)<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// PdfFile PdfFile</span><br><span class="hljs-keyword">type</span> PdfFile <span class="hljs-keyword">struct</span> &#123;<br>path <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-comment">// Accept Accept</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *PdfFile)</span> <span class="hljs-title">Accept</span><span class="hljs-params">(visitor Visitor)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> visitor.Visit(f)<br>&#125;<br><br><span class="hljs-comment">// PPTFile PPTFile</span><br><span class="hljs-keyword">type</span> PPTFile <span class="hljs-keyword">struct</span> &#123;<br>path <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-comment">// Accept Accept</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *PPTFile)</span> <span class="hljs-title">Accept</span><span class="hljs-params">(visitor Visitor)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> visitor.Visit(f)<br>&#125;<br><br><span class="hljs-comment">// Compressor å®ç°å‹ç¼©åŠŸèƒ½</span><br><span class="hljs-keyword">type</span> Compressor <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// Visit å®ç°è®¿é—®è€…æ¨¡å¼æ–¹æ³•</span><br><span class="hljs-comment">// æˆ‘ä»¬å¯ä»¥å‘ç°ç”±äºæ²¡æœ‰å‡½æ•°é‡è½½ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡æ–­è¨€æ¥æ ¹æ®ä¸åŒçš„ç±»å‹è°ƒç”¨ä¸åŒå‡½æ•°</span><br><span class="hljs-comment">// ä½†æ˜¯æˆ‘ä»¬å³ä½¿ä¸é‡‡ç”¨è®¿é—®è€…æ¨¡å¼ï¼Œæˆ‘ä»¬å…¶å®ä¹Ÿæ˜¯å¯ä»¥è¿™ä¹ˆæ“ä½œçš„</span><br><span class="hljs-comment">// å¹¶ä¸”ç”±äºé‡‡ç”¨äº†ç±»å‹æ–­è¨€ï¼Œæ‰€ä»¥å¦‚æœéœ€è¦æ“ä½œçš„å¯¹è±¡æ¯”è¾ƒå¤šçš„è¯ï¼Œè¿™ä¸ªå‡½æ•°å…¶å®ä¹Ÿä¼šè†¨èƒ€çš„æ¯”è¾ƒå‰å®³</span><br><span class="hljs-comment">// åç»­å¯ä»¥è€ƒè™‘æŒ‰ç…§å‘½åçº¦å®šä½¿ç”¨ generate è‡ªåŠ¨ç”Ÿæˆä»£ç </span><br><span class="hljs-comment">// æˆ–è€…æ˜¯ä½¿ç”¨åå°„ç®€åŒ–</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Compressor)</span> <span class="hljs-title">Visit</span><span class="hljs-params">(r IResourceFile)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">switch</span> f := r.(<span class="hljs-keyword">type</span>) &#123;<br><span class="hljs-keyword">case</span> *PPTFile:<br><span class="hljs-keyword">return</span> c.VisitPPTFile(f)<br><span class="hljs-keyword">case</span> *PdfFile:<br><span class="hljs-keyword">return</span> c.VisitPDFFile(f)<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;not found resource typr: %#v&quot;</span>, r)<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// VisitPPTFile VisitPPTFile</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Compressor)</span> <span class="hljs-title">VisitPPTFile</span><span class="hljs-params">(f *PPTFile)</span> <span class="hljs-title">error</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;this is ppt file&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// VisitPDFFile VisitPDFFile</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Compressor)</span> <span class="hljs-title">VisitPDFFile</span><span class="hljs-params">(f *PdfFile)</span> <span class="hljs-title">error</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;this is pdf file&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> visitor<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/require&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestCompressor_Visit</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>tests := []<span class="hljs-keyword">struct</span> &#123;<br>name    <span class="hljs-keyword">string</span><br>path    <span class="hljs-keyword">string</span><br>wantErr <span class="hljs-keyword">string</span><br>&#125;&#123;<br>&#123;<br>name: <span class="hljs-string">&quot;pdf&quot;</span>,<br>path: <span class="hljs-string">&quot;./xx.pdf&quot;</span>,<br>&#125;,<br>&#123;<br>name: <span class="hljs-string">&quot;ppt&quot;</span>,<br>path: <span class="hljs-string">&quot;./xx.ppt&quot;</span>,<br>&#125;,<br>&#123;<br>name:    <span class="hljs-string">&quot;404&quot;</span>,<br>path:    <span class="hljs-string">&quot;./xx.xx&quot;</span>,<br>wantErr: <span class="hljs-string">&quot;not found file type&quot;</span>,<br>&#125;,<br>&#125;<br><br><span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;<br>t.Run(tt.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>f, err := NewResourceFile(tt.path)<br><span class="hljs-keyword">if</span> tt.wantErr != <span class="hljs-string">&quot;&quot;</span> &#123;<br>require.Error(t, err)<br>require.Contains(t, err.Error(), tt.wantErr)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>require.NoError(t, err)<br>compressor := &amp;Compressor&#123;&#125;<br>f.Accept(compressor)<br>&#125;)<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// ä¸ç”¨ Accept å…¶å®ä¹Ÿæ˜¯å¯ä»¥çš„</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestCompressor_Visit2</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>tests := []<span class="hljs-keyword">struct</span> &#123;<br>name    <span class="hljs-keyword">string</span><br>path    <span class="hljs-keyword">string</span><br>wantErr <span class="hljs-keyword">string</span><br>&#125;&#123;<br>&#123;<br>name: <span class="hljs-string">&quot;pdf&quot;</span>,<br>path: <span class="hljs-string">&quot;./xx.pdf&quot;</span>,<br>&#125;,<br>&#123;<br>name: <span class="hljs-string">&quot;ppt&quot;</span>,<br>path: <span class="hljs-string">&quot;./xx.ppt&quot;</span>,<br>&#125;,<br>&#123;<br>name:    <span class="hljs-string">&quot;404&quot;</span>,<br>path:    <span class="hljs-string">&quot;./xx.xx&quot;</span>,<br>wantErr: <span class="hljs-string">&quot;not found file type&quot;</span>,<br>&#125;,<br>&#125;<br><br><span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;<br>t.Run(tt.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>f, err := NewResourceFile(tt.path)<br><span class="hljs-keyword">if</span> tt.wantErr != <span class="hljs-string">&quot;&quot;</span> &#123;<br>require.Error(t, err)<br>require.Contains(t, err.Error(), tt.wantErr)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>require.NoError(t, err)<br>compressor := &amp;Compressor&#123;&#125;<br>compressor.Visit(f)<br>&#125;)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>è¡Œä¸ºå‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼18-è¿­ä»£å™¨æ¨¡å¼</title>
    <link href="/post/iterator.html"/>
    <url>/post/iterator.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/219290">65 | è¿­ä»£å™¨æ¨¡å¼ï¼ˆä¸Šï¼‰ï¼šç›¸æ¯”ç›´æ¥éå†é›†åˆæ•°æ®ï¼Œä½¿ç”¨è¿­ä»£å™¨æœ‰å“ªäº›ä¼˜åŠ¿ï¼Ÿ</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 18/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154405094-ece2ac1d-0998-404e-8b2c-d4d897eea149.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„è‡ªå®šä¹‰æ•°ç»„ç±»å‹çš„ä¾‹å­</p><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> iterator<br><br><span class="hljs-comment">// Iterator è¿­ä»£å™¨æ¥å£</span><br><span class="hljs-keyword">type</span> Iterator <span class="hljs-keyword">interface</span> &#123;<br>HasNext() <span class="hljs-keyword">bool</span><br>Next()<br><span class="hljs-comment">// è·å–å½“å‰å…ƒç´ ï¼Œç”±äº Go 1.15 ä¸­è¿˜æ²¡æœ‰æ³›å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥è¿”å› interface&#123;&#125;</span><br>CurrentItem() <span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br><br><span class="hljs-comment">// ArrayInt æ•°ç»„</span><br><span class="hljs-keyword">type</span> ArrayInt []<span class="hljs-keyword">int</span><br><br><span class="hljs-comment">// Iterator è¿”å›è¿­ä»£å™¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a ArrayInt)</span> <span class="hljs-title">Iterator</span><span class="hljs-params">()</span> <span class="hljs-title">Iterator</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;ArrayIntIterator&#123;<br>arrayInt: a,<br>index:    <span class="hljs-number">0</span>,<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// ArrayIntIterator æ•°ç»„è¿­ä»£</span><br><span class="hljs-keyword">type</span> ArrayIntIterator <span class="hljs-keyword">struct</span> &#123;<br>arrayInt ArrayInt<br>index    <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-comment">// HasNext æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ª</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(iter *ArrayIntIterator)</span> <span class="hljs-title">HasNext</span><span class="hljs-params">()</span> <span class="hljs-title">bool</span></span> &#123;<br><span class="hljs-keyword">return</span> iter.index &lt; <span class="hljs-built_in">len</span>(iter.arrayInt)<span class="hljs-number">-1</span><br>&#125;<br><br><span class="hljs-comment">// Next æ¸¸æ ‡åŠ ä¸€</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(iter *ArrayIntIterator)</span> <span class="hljs-title">Next</span><span class="hljs-params">()</span></span> &#123;<br>iter.index++<br>&#125;<br><br><span class="hljs-comment">// CurrentItem è·å–å½“å‰å…ƒç´ </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(iter *ArrayIntIterator)</span> <span class="hljs-title">CurrentItem</span><span class="hljs-params">()</span> <span class="hljs-title">interface</span></span>&#123;&#125; &#123;<br><span class="hljs-keyword">return</span> iter.arrayInt[iter.index]<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> iterator<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestArrayInt_Iterator</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>data := ArrayInt&#123;<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>&#125;<br>iterator := data.Iterator()<br><span class="hljs-comment">// i ç”¨äºæµ‹è¯•</span><br>i := <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> iterator.HasNext() &#123;<br>assert.Equal(t, data[i], iterator.CurrentItem())<br>iterator.Next()<br>i++<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>è¡Œä¸ºå‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼17-çŠ¶æ€æ¨¡å¼</title>
    <link href="/post/state.html"/>
    <url>/post/state.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/218375">64 | çŠ¶æ€æ¨¡å¼ï¼šæ¸¸æˆã€å·¥ä½œæµå¼•æ“ä¸­å¸¸ç”¨çš„çŠ¶æ€æœºæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 17/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154394191-56852903-913e-4937-a049-f5d0d832841b.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>é€šè¿‡ä¸‹é¢çš„ä¾‹å­å¯ä»¥å‘ç°ï¼Œå¼•å…¥çŠ¶æ€æ¨¡å¼æ¥å†™çŠ¶æ€æœºä¼šæœ‰å¼•å…¥æ¯”è¾ƒå¤šçš„ç»“æ„ä½“ï¼Œå¹¶ä¸”æ”¹åŠ¨ä»£ç çš„æ—¶å€™å¦‚æœè¦æ–°å¢æˆ–è€…æ˜¯åˆ é™¤æŸä¸€ä¸ªçŠ¶æ€çš„è¯ï¼Œä¿®æ”¹ä¹Ÿéœ€è¦åœ¨å…¶ä»–çŠ¶æ€çš„ç»“æ„ä½“æ–¹æ³•ä¸­ä¿®æ”¹ï¼Œæ‰€ä»¥è¿™ä¸ªä¸å¤ªé€‚åˆçŠ¶æ€ç»å¸¸å˜æ›´æˆ–è€…æ˜¯çŠ¶æ€å¾ˆå¤šçš„æƒ…å†µ</p><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Package state çŠ¶æ€æ¨¡å¼</span><br><span class="hljs-comment">// ç¬”è®°è¯·æŸ¥çœ‹: https://lailin.xyz/state.html</span><br><span class="hljs-comment">// è¿™æ˜¯ä¸€ä¸ªå·¥ä½œæµçš„ä¾‹å­ï¼Œåœ¨ä¼ä¸šå†…éƒ¨æˆ–è€…æ˜¯å­¦æ ¡æˆ‘ä»¬ç»å¸¸ä¼šçœ‹åˆ°å¾ˆå¤šå®¡æ‰¹æµç¨‹</span><br><span class="hljs-comment">// å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæŠ¥é”€çš„æµç¨‹: å‘˜å·¥æäº¤æŠ¥é”€ç”³è¯· -&gt; ç›´å±éƒ¨é—¨é¢†å¯¼å®¡æ‰¹ -&gt; è´¢åŠ¡å®¡æ‰¹ -&gt; ç»“æŸ</span><br><span class="hljs-comment">// åœ¨è¿™ä¸ªå®¡æ‰¹æµä¸­ï¼Œå¤„åœ¨ä¸åŒçš„ç¯èŠ‚å°±æ˜¯ä¸åŒçš„çŠ¶æ€</span><br><span class="hljs-comment">// è€Œæµç¨‹çš„å®¡æ‰¹ã€é©³å›å°±æ˜¯ä¸åŒçš„äº‹ä»¶</span><br><span class="hljs-keyword">package</span> state<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-comment">// Machine çŠ¶æ€æœº</span><br><span class="hljs-keyword">type</span> Machine <span class="hljs-keyword">struct</span> &#123;<br>state IState<br>&#125;<br><br><span class="hljs-comment">// SetState æ›´æ–°çŠ¶æ€</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Machine)</span> <span class="hljs-title">SetState</span><span class="hljs-params">(state IState)</span></span> &#123;<br>m.state = state<br>&#125;<br><br><span class="hljs-comment">// GetStateName è·å–å½“å‰çŠ¶æ€</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Machine)</span> <span class="hljs-title">GetStateName</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">return</span> m.state.GetName()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Machine)</span> <span class="hljs-title">Approval</span><span class="hljs-params">()</span></span> &#123;<br>m.state.Approval(m)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Machine)</span> <span class="hljs-title">Reject</span><span class="hljs-params">()</span></span> &#123;<br>m.state.Reject(m)<br>&#125;<br><br><span class="hljs-comment">// IState çŠ¶æ€</span><br><span class="hljs-keyword">type</span> IState <span class="hljs-keyword">interface</span> &#123;<br><span class="hljs-comment">// å®¡æ‰¹é€šè¿‡</span><br>Approval(m *Machine)<br><span class="hljs-comment">// é©³å›</span><br>Reject(m *Machine)<br><span class="hljs-comment">// è·å–å½“å‰çŠ¶æ€åç§°</span><br>GetName() <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-comment">// leaderApproveState ç›´å±é¢†å¯¼å®¡æ‰¹</span><br><span class="hljs-keyword">type</span> leaderApproveState <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// Approval è·å–çŠ¶æ€åå­—</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(leaderApproveState)</span> <span class="hljs-title">Approval</span><span class="hljs-params">(m *Machine)</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;leader å®¡æ‰¹æˆåŠŸ&quot;</span>)<br>m.SetState(GetFinanceApproveState())<br>&#125;<br><br><span class="hljs-comment">// GetName è·å–çŠ¶æ€åå­—</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(leaderApproveState)</span> <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;LeaderApproveState&quot;</span><br>&#125;<br><br><span class="hljs-comment">// Reject è·å–çŠ¶æ€åå­—</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(leaderApproveState)</span> <span class="hljs-title">Reject</span><span class="hljs-params">(m *Machine)</span></span> &#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetLeaderApproveState</span><span class="hljs-params">()</span> <span class="hljs-title">IState</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;leaderApproveState&#123;&#125;<br>&#125;<br><br><span class="hljs-comment">// financeApproveState è´¢åŠ¡å®¡æ‰¹</span><br><span class="hljs-keyword">type</span> financeApproveState <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// Approval å®¡æ‰¹é€šè¿‡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f financeApproveState)</span> <span class="hljs-title">Approval</span><span class="hljs-params">(m *Machine)</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;è´¢åŠ¡å®¡æ‰¹æˆåŠŸ&quot;</span>)<br>fmt.Println(<span class="hljs-string">&quot;å‡ºå‘æ‰“æ¬¾æ“ä½œ&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// æ‹’ç»</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f financeApproveState)</span> <span class="hljs-title">Reject</span><span class="hljs-params">(m *Machine)</span></span> &#123;<br>m.SetState(GetLeaderApproveState())<br>&#125;<br><br><span class="hljs-comment">// GetName è·å–åå­—</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f financeApproveState)</span> <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;FinanceApproveState&quot;</span><br>&#125;<br><br><span class="hljs-comment">// GetFinanceApproveState GetFinanceApproveState</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetFinanceApproveState</span><span class="hljs-params">()</span> <span class="hljs-title">IState</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;financeApproveState&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> state<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMachine_GetStateName</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>m := &amp;Machine&#123;state: GetLeaderApproveState()&#125;<br>assert.Equal(t, <span class="hljs-string">&quot;LeaderApproveState&quot;</span>, m.GetStateName())<br>m.Approval()<br>assert.Equal(t, <span class="hljs-string">&quot;FinanceApproveState&quot;</span>, m.GetStateName())<br>m.Reject()<br>assert.Equal(t, <span class="hljs-string">&quot;LeaderApproveState&quot;</span>, m.GetStateName())<br>m.Approval()<br>assert.Equal(t, <span class="hljs-string">&quot;FinanceApproveState&quot;</span>, m.GetStateName())<br>m.Approval()<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>è¡Œä¸ºå‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼16-èŒè´£é“¾æ¨¡å¼(Ginçš„ä¸­é—´ä»¶å®ç°)</title>
    <link href="/post/chain.html"/>
    <url>/post/chain.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/216278">62 | èŒè´£é“¾æ¨¡å¼ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•å®ç°å¯çµæ´»æ‰©å±•ç®—æ³•çš„æ•æ„Ÿä¿¡æ¯è¿‡æ»¤æ¡†æ¶ï¼Ÿ</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 16/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154384873-d9ff58d7-c0f7-49af-90d4-26e8e256e504.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸€ä¸ªç®€å•çš„å®ç°æ¨¡æ¿ï¼Œç„¶åæˆ‘ä»¬å†çœ‹çœ‹å®é™…ä¸Šæˆ‘ä»¬å¸¸ç”¨ web æ¡†æ¶ gin å½“ä¸­æ˜¯å¦‚ä½•å¤„ç†è¯·æ±‚çš„</p><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Package chain èŒè´£é“¾æ¨¡å¼</span><br><span class="hljs-comment">// ğŸŒ° å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸ªæ ¡å›­è®ºå›ï¼Œç”±äºç¤¾åŒºè§„ç« åˆ¶åº¦ã€å¹¿å‘Šã€æ³•å¾‹æ³•è§„çš„åŸå› éœ€è¦å¯¹ç”¨æˆ·çš„å‘è¨€è¿›è¡Œæ•æ„Ÿè¯è¿‡æ»¤</span><br><span class="hljs-comment">//    å¦‚æœè¢«åˆ¤å®šä¸ºæ•æ„Ÿè¯ï¼Œé‚£ä¹ˆè¿™ç¯‡å¸–å­å°†ä¼šè¢«å°ç¦</span><br><span class="hljs-keyword">package</span> chain<br><br><span class="hljs-comment">// SensitiveWordFilter æ•æ„Ÿè¯è¿‡æ»¤å™¨ï¼Œåˆ¤å®šæ˜¯å¦æ˜¯æ•æ„Ÿè¯</span><br><span class="hljs-keyword">type</span> SensitiveWordFilter <span class="hljs-keyword">interface</span> &#123;<br>Filter(content <span class="hljs-keyword">string</span>) <span class="hljs-keyword">bool</span><br>&#125;<br><br><span class="hljs-comment">// SensitiveWordFilterChain èŒè´£é“¾</span><br><span class="hljs-keyword">type</span> SensitiveWordFilterChain <span class="hljs-keyword">struct</span> &#123;<br>filters []SensitiveWordFilter<br>&#125;<br><br><span class="hljs-comment">// AddFilter æ·»åŠ ä¸€ä¸ªè¿‡æ»¤å™¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *SensitiveWordFilterChain)</span> <span class="hljs-title">AddFilter</span><span class="hljs-params">(filter SensitiveWordFilter)</span></span> &#123;<br>c.filters = <span class="hljs-built_in">append</span>(c.filters, filter)<br>&#125;<br><br><span class="hljs-comment">// Filter æ‰§è¡Œè¿‡æ»¤</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *SensitiveWordFilterChain)</span> <span class="hljs-title">Filter</span><span class="hljs-params">(content <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">bool</span></span> &#123;<br><span class="hljs-keyword">for</span> _, filter := <span class="hljs-keyword">range</span> c.filters &#123;<br><span class="hljs-comment">// å¦‚æœå‘ç°æ•æ„Ÿç›´æ¥è¿”å›ç»“æœ</span><br><span class="hljs-keyword">if</span> filter.Filter(content) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-comment">// AdSensitiveWordFilter å¹¿å‘Š</span><br><span class="hljs-keyword">type</span> AdSensitiveWordFilter <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// Filter å®ç°è¿‡æ»¤ç®—æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *AdSensitiveWordFilter)</span> <span class="hljs-title">Filter</span><span class="hljs-params">(content <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">bool</span></span> &#123;<br><span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> å®ç°ç®—æ³•</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-comment">// PoliticalWordFilter æ”¿æ²»æ•æ„Ÿ</span><br><span class="hljs-keyword">type</span> PoliticalWordFilter <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// Filter å®ç°è¿‡æ»¤ç®—æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *PoliticalWordFilter)</span> <span class="hljs-title">Filter</span><span class="hljs-params">(content <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">bool</span></span> &#123;<br><span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> å®ç°ç®—æ³•</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> chain<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSensitiveWordFilterChain_Filter</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>chain := &amp;SensitiveWordFilterChain&#123;&#125;<br>chain.AddFilter(&amp;AdSensitiveWordFilter&#123;&#125;)<br>assert.Equal(t, <span class="hljs-literal">false</span>, chain.Filter(<span class="hljs-string">&quot;test&quot;</span>))<br><br>chain.AddFilter(&amp;PoliticalWordFilter&#123;&#125;)<br>assert.Equal(t, <span class="hljs-literal">true</span>, chain.Filter(<span class="hljs-string">&quot;test&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Gin-çš„ä¸­é—´ä»¶å®ç°"><a href="#Gin-çš„ä¸­é—´ä»¶å®ç°" class="headerlink" title="Gin çš„ä¸­é—´ä»¶å®ç°"></a>Gin çš„ä¸­é—´ä»¶å®ç°</h3><p>æˆ‘ä»¬ç›´æ¥çœ‹ä¸€ä¸‹ <code>gin Context</code>  çš„å®ç°ï¼Œå…¶ä¸­ <code>Next()</code>  æ–¹æ³•å°±æ˜¯ä¸»è¦çš„æ‰§è¡Œæ–¹æ³•ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯æˆ‘ä»¬æœ€ä¸Šé¢è¯´åˆ°çš„èŒè´£é“¾æ¨¡å¼çš„å˜ä½“ï¼Œå› ä¸ºå®ƒä¼šåœ¨æ¯ä¸€ä¸ªå¤„ç†å‡½æ•°ä¸­è¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯ç¬¬ä¸€ä¸ªæ¥æ”¶åˆ°å°±åœæ­¢äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Context <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">// ...</span><br><br>    <span class="hljs-comment">// handlers æ˜¯ä¸€ä¸ªåŒ…å«æ‰§è¡Œå‡½æ•°çš„æ•°ç»„</span><br>    <span class="hljs-comment">// type HandlersChain []HandlerFunc</span><br>handlers HandlersChain<br>    <span class="hljs-comment">// index è¡¨ç¤ºå½“å‰æ‰§è¡Œåˆ°å“ªä¸ªä½ç½®äº†</span><br>index    <span class="hljs-keyword">int8</span><br><br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-comment">// Next ä¼šæŒ‰ç…§é¡ºåºå°†ä¸€ä¸ªä¸ªä¸­é—´ä»¶æ‰§è¡Œå®Œæ¯•</span><br><span class="hljs-comment">// å¹¶ä¸” Next ä¹Ÿå¯ä»¥åœ¨ä¸­é—´ä»¶ä¸­è¿›è¡Œè°ƒç”¨ï¼Œè¾¾åˆ°è¯·æ±‚å‰ä»¥åŠè¯·æ±‚åçš„å¤„ç†</span><br><span class="hljs-comment">// Next should be used only inside middleware.</span><br><span class="hljs-comment">// It executes the pending handlers in the chain inside the calling handler.</span><br><span class="hljs-comment">// See example in GitHub.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Context)</span> <span class="hljs-title">Next</span><span class="hljs-params">()</span></span> &#123;<br>c.index++<br><span class="hljs-keyword">for</span> c.index &lt; <span class="hljs-keyword">int8</span>(<span class="hljs-built_in">len</span>(c.handlers)) &#123;<br>c.handlers[c.index](c)<br>c.index++<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>è¡Œä¸ºå‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼15-ç­–ç•¥æ¨¡å¼</title>
    <link href="/post/strategy.html"/>
    <url>/post/strategy.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/214014">60 | ç­–ç•¥æ¨¡å¼ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•é¿å…å†—é•¿çš„ if-else/switch åˆ†æ”¯åˆ¤æ–­ä»£ç ï¼Ÿ</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 15/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154375192-13015b66-5328-4c36-a494-9e083de2021b.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>æ¥ä¸ª ğŸŒ°ï¼Œæˆ‘ä»¬åœ¨ä¿å­˜æ–‡ä»¶çš„æ—¶å€™ï¼Œç”±äºæ”¿ç­–æˆ–è€…å…¶ä»–çš„åŸå› å¯èƒ½éœ€è¦é€‰æ‹©ä¸åŒçš„å­˜å‚¨æ–¹å¼ï¼Œæ•æ„Ÿæ•°æ®æˆ‘ä»¬éœ€è¦åŠ å¯†å­˜å‚¨ï¼Œä¸æ•æ„Ÿçš„æ•°æ®æˆ‘ä»¬å¯ä»¥ç›´æ¥æ˜æ–‡ä¿å­˜ã€‚</p><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> strategy<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;io/ioutil&quot;</span><br><span class="hljs-string">&quot;os&quot;</span><br>)<br><br><span class="hljs-comment">// StorageStrategy å­˜å‚¨ç­–ç•¥</span><br><span class="hljs-keyword">type</span> StorageStrategy <span class="hljs-keyword">interface</span> &#123;<br>Save(name <span class="hljs-keyword">string</span>, data []<span class="hljs-keyword">byte</span>) error<br>&#125;<br><br><span class="hljs-keyword">var</span> strategys = <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]StorageStrategy&#123;<br><span class="hljs-string">&quot;file&quot;</span>:         &amp;fileStorage&#123;&#125;,<br><span class="hljs-string">&quot;encrypt_file&quot;</span>: &amp;encryptFileStorage&#123;&#125;,<br>&#125;<br><br><span class="hljs-comment">// NewStorageStrategy NewStorageStrategy</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewStorageStrategy</span><span class="hljs-params">(t <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(StorageStrategy, error)</span></span> &#123;<br>s, ok := strategys[t]<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;not found StorageStrategy: %s&quot;</span>, t)<br>&#125;<br><br><span class="hljs-keyword">return</span> s, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// FileStorage ä¿å­˜åˆ°æ–‡ä»¶</span><br><span class="hljs-keyword">type</span> fileStorage <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// Save Save</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *fileStorage)</span> <span class="hljs-title">Save</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>, data []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> ioutil.WriteFile(name, data, os.ModeAppend)<br>&#125;<br><br><span class="hljs-comment">// encryptFileStorage åŠ å¯†ä¿å­˜åˆ°æ–‡ä»¶</span><br><span class="hljs-keyword">type</span> encryptFileStorage <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// Save Save</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *encryptFileStorage)</span> <span class="hljs-title">Save</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>, data []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-comment">// åŠ å¯†</span><br>data, err := encrypt(data)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-keyword">return</span> ioutil.WriteFile(name, data, os.ModeAppend)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">encrypt</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-params">([]<span class="hljs-keyword">byte</span>, error)</span></span> &#123;<br><span class="hljs-comment">// è¿™é‡Œå®ç°åŠ å¯†ç®—æ³•</span><br><span class="hljs-keyword">return</span> data, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> strategy<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Test_demo</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-comment">// å‡è®¾è¿™é‡Œè·å–æ•°æ®ï¼Œä»¥åŠæ•°æ®æ˜¯å¦æ•æ„Ÿ</span><br>data, sensitive := getData()<br>strategyType := <span class="hljs-string">&quot;file&quot;</span><br><span class="hljs-keyword">if</span> sensitive &#123;<br>strategyType = <span class="hljs-string">&quot;encrypt_file&quot;</span><br>&#125;<br><br>storage, err := NewStorageStrategy(strategyType)<br>assert.NoError(t, err)<br>assert.NoError(t, storage.Save(<span class="hljs-string">&quot;./test.txt&quot;</span>, data))<br>&#125;<br><br><span class="hljs-comment">// getData è·å–æ•°æ®çš„æ–¹æ³•</span><br><span class="hljs-comment">// è¿”å›æ•°æ®ï¼Œä»¥åŠæ•°æ®æ˜¯å¦æ•æ„Ÿ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getData</span><span class="hljs-params">()</span> <span class="hljs-params">([]<span class="hljs-keyword">byte</span>, <span class="hljs-keyword">bool</span>)</span></span> &#123;<br><span class="hljs-keyword">return</span> []<span class="hljs-keyword">byte</span>(<span class="hljs-string">&quot;test data&quot;</span>), <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>è¡Œä¸ºå‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goæ¨¡æ¿æ¨¡å¼14-æ¨¡æ¿æ¨¡å¼</title>
    <link href="/post/template.html"/>
    <url>/post/template.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/212049">58 | æ¨¡æ¿æ¨¡å¼ï¼ˆä¸Šï¼‰ï¼šå‰–ææ¨¡æ¿æ¨¡å¼åœ¨ JDKã€Servletã€JUnit ç­‰ä¸­çš„åº”ç”¨</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 14/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154364395-c5c6468a-ba2c-4a51-bea4-3bcf1fe87d0d.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>ä¸¾ä¸ª ğŸŒ°ï¼Œå‡è®¾æˆ‘ç°åœ¨è¦åšä¸€ä¸ªçŸ­ä¿¡æ¨é€çš„ç³»ç»Ÿï¼Œé‚£ä¹ˆéœ€è¦</p><ol><li>æ£€æŸ¥çŸ­ä¿¡å­—æ•°æ˜¯å¦è¶…è¿‡é™åˆ¶</li><li>æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦æ­£ç¡®</li><li>å‘é€çŸ­ä¿¡</li><li>è¿”å›çŠ¶æ€</li></ol><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨å‘é€çŸ­ä¿¡çš„æ—¶å€™ç”±äºä¸åŒçš„ä¾›åº”å•†è°ƒç”¨çš„æ¥å£ä¸åŒï¼Œæ‰€ä»¥ä¼šæœ‰ä¸€äº›å®ç°ä¸Šçš„å·®å¼‚ï¼Œä½†æ˜¯ä»–çš„ç®—æ³•ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰æ˜¯å›ºå®šçš„</p><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> template<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-comment">// ISMS ISMS</span><br><span class="hljs-keyword">type</span> ISMS <span class="hljs-keyword">interface</span> &#123;<br>send(content <span class="hljs-keyword">string</span>, phone <span class="hljs-keyword">int</span>) error<br>&#125;<br><br><span class="hljs-comment">// SMS çŸ­ä¿¡å‘é€åŸºç±»</span><br><span class="hljs-keyword">type</span> sms <span class="hljs-keyword">struct</span> &#123;<br>ISMS<br>&#125;<br><br><span class="hljs-comment">// Valid æ ¡éªŒçŸ­ä¿¡å­—æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *sms)</span> <span class="hljs-title">Valid</span><span class="hljs-params">(content <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(content) &gt; <span class="hljs-number">63</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;content is too long&quot;</span>)<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// Send å‘é€çŸ­ä¿¡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *sms)</span> <span class="hljs-title">Send</span><span class="hljs-params">(content <span class="hljs-keyword">string</span>, phone <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">if</span> err := s.Valid(content); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-comment">// è°ƒç”¨å­ç±»çš„æ–¹æ³•å‘é€çŸ­ä¿¡</span><br><span class="hljs-keyword">return</span> s.send(content, phone)<br>&#125;<br><br><span class="hljs-comment">// TelecomSms èµ°ç”µä¿¡é€šé“</span><br><span class="hljs-keyword">type</span> TelecomSms <span class="hljs-keyword">struct</span> &#123;<br>*sms<br>&#125;<br><br><span class="hljs-comment">// NewTelecomSms NewTelecomSms</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewTelecomSms</span><span class="hljs-params">()</span> *<span class="hljs-title">TelecomSms</span></span> &#123;<br>tel := &amp;TelecomSms&#123;&#125;<br><span class="hljs-comment">// è¿™é‡Œæœ‰ç‚¹ç»•ï¼Œæ˜¯å› ä¸º go æ²¡æœ‰ç»§æ‰¿ï¼Œç”¨åµŒå¥—ç»“æ„ä½“çš„æ–¹æ³•è¿›è¡Œæ¨¡æ‹Ÿ</span><br><span class="hljs-comment">// è¿™é‡Œå°†å­ç±»ä½œä¸ºæ¥å£åµŒå…¥çˆ¶ç±»ï¼Œå°±å¯ä»¥è®©çˆ¶ç±»çš„æ¨¡æ¿æ–¹æ³• Send è°ƒç”¨åˆ°å­ç±»çš„å‡½æ•°</span><br><span class="hljs-comment">// å®é™…ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šè¿™ä¹ˆå†™ï¼Œéƒ½æ˜¯é‡‡ç”¨ç»„åˆ+æ¥å£çš„æ–¹å¼å®Œæˆç±»ä¼¼çš„åŠŸèƒ½</span><br>tel.sms = &amp;sms&#123;ISMS: tel&#125;<br><span class="hljs-keyword">return</span> tel<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tel *TelecomSms)</span> <span class="hljs-title">send</span><span class="hljs-params">(content <span class="hljs-keyword">string</span>, phone <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">error</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;send by telecom success&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> template<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Test_sms_Send</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>tel := NewTelecomSms()<br>err := tel.Send(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-number">1239999</span>)<br>assert.NoError(t, err)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>è¡Œä¸ºå‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼13-è§‚å¯Ÿè€…æ¨¡å¼(å®ç°ç®€å•çš„EventBus)</title>
    <link href="/post/observer.html"/>
    <url>/post/observer.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/210170">56 | è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆä¸Šï¼‰ï¼šè¯¦è§£å„ç§åº”ç”¨åœºæ™¯ä¸‹è§‚å¯Ÿè€…æ¨¡å¼çš„ä¸åŒå®ç°æ–¹å¼</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 13/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a> **</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154349618-498355aa-3d37-4e65-a532-3aa5e1a336dd.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><h3 id="åŸºç¡€å®ç°"><a href="#åŸºç¡€å®ç°" class="headerlink" title="åŸºç¡€å®ç°"></a>åŸºç¡€å®ç°</h3><h4 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> observer<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-comment">// ISubject subject</span><br><span class="hljs-keyword">type</span> ISubject <span class="hljs-keyword">interface</span> &#123;<br>Register(observer IObsever)<br>Remove(observer IObsever)<br>Notify(observer IObsever)<br>&#125;<br><br><span class="hljs-comment">// IObsever è§‚å¯Ÿè€…</span><br><span class="hljs-keyword">type</span> IObsever <span class="hljs-keyword">interface</span> &#123;<br>Update(msg <span class="hljs-keyword">string</span>)<br>&#125;<br><br><span class="hljs-comment">// Subject Subject</span><br><span class="hljs-keyword">type</span> Subject <span class="hljs-keyword">struct</span> &#123;<br>observers []IObsever<br>&#125;<br><br><span class="hljs-comment">// Register æ³¨å†Œ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(sub *Subject)</span> <span class="hljs-title">Register</span><span class="hljs-params">(observer IObsever)</span></span> &#123;<br>sub.observers = <span class="hljs-built_in">append</span>(sub.observers, observer)<br>&#125;<br><br><span class="hljs-comment">// Remove ç§»é™¤è§‚å¯Ÿè€…</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(sub *Subject)</span> <span class="hljs-title">Remove</span><span class="hljs-params">(observer IObsever)</span></span> &#123;<br><span class="hljs-keyword">for</span> i, ob := <span class="hljs-keyword">range</span> sub.observers &#123;<br><span class="hljs-keyword">if</span> ob == observer &#123;<br>sub.observers = <span class="hljs-built_in">append</span>(sub.observers[:i], sub.observers[i+<span class="hljs-number">1</span>:]...)<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Notify é€šçŸ¥</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(sub *Subject)</span> <span class="hljs-title">Notify</span><span class="hljs-params">(msg <span class="hljs-keyword">string</span>)</span></span> &#123;<br><span class="hljs-keyword">for</span> _, o := <span class="hljs-keyword">range</span> sub.observers &#123;<br>o.Update(msg)<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Obsever1 Obsever1</span><br><span class="hljs-keyword">type</span> Obsever1 <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// Update å®ç°è§‚å¯Ÿè€…æ¥å£</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(Obsever1)</span> <span class="hljs-title">Update</span><span class="hljs-params">(msg <span class="hljs-keyword">string</span>)</span></span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;Obsever1: %s&quot;</span>, msg)<br>&#125;<br><br><span class="hljs-comment">// Obsever2 Obsever2</span><br><span class="hljs-keyword">type</span> Obsever2 <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// Update å®ç°è§‚å¯Ÿè€…æ¥å£</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(Obsever2)</span> <span class="hljs-title">Update</span><span class="hljs-params">(msg <span class="hljs-keyword">string</span>)</span></span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;Obsever2: %s&quot;</span>, msg)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> observer<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSubject_Notify</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>sub := &amp;Subject&#123;&#125;<br>sub.Register(&amp;Obsever1&#123;&#125;)<br>sub.Register(&amp;Obsever2&#123;&#125;)<br>sub.Notify(<span class="hljs-string">&quot;hi&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä½¿ç”¨-Golang-å®ç°-EventBus"><a href="#ä½¿ç”¨-Golang-å®ç°-EventBus" class="headerlink" title="ä½¿ç”¨ Golang å®ç° EventBus"></a>ä½¿ç”¨ Golang å®ç° EventBus</h3><p>æˆ‘ä»¬å®ç°ä¸€ä¸ªæ”¯æŒä»¥ä¸‹åŠŸèƒ½çš„äº‹ä»¶æ€»çº¿</p><ol><li>å¼‚æ­¥ä¸é˜»å¡</li><li>æ”¯æŒä»»æ„å‚æ•°å€¼</li></ol><h4 id="Code-1"><a href="#Code-1" class="headerlink" title="Code"></a>Code</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> eventbus<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;reflect&quot;</span><br><span class="hljs-string">&quot;sync&quot;</span><br>)<br><br><span class="hljs-comment">// Bus Bus</span><br><span class="hljs-keyword">type</span> Bus <span class="hljs-keyword">interface</span> &#123;<br>Subscribe(topic <span class="hljs-keyword">string</span>, handler <span class="hljs-keyword">interface</span>&#123;&#125;) error<br>Publish(topic <span class="hljs-keyword">string</span>, args ...<span class="hljs-keyword">interface</span>&#123;&#125;)<br>&#125;<br><br><span class="hljs-comment">// AsyncEventBus å¼‚æ­¥äº‹ä»¶æ€»çº¿</span><br><span class="hljs-keyword">type</span> AsyncEventBus <span class="hljs-keyword">struct</span> &#123;<br>handlers <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>][]reflect.Value<br>lock     sync.Mutex<br>&#125;<br><br><span class="hljs-comment">// NewAsyncEventBus new</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewAsyncEventBus</span><span class="hljs-params">()</span> *<span class="hljs-title">AsyncEventBus</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;AsyncEventBus&#123;<br>handlers: <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>][]reflect.Value&#123;&#125;,<br>lock:     sync.Mutex&#123;&#125;,<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Subscribe è®¢é˜…</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(bus *AsyncEventBus)</span> <span class="hljs-title">Subscribe</span><span class="hljs-params">(topic <span class="hljs-keyword">string</span>, f <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;<br>bus.lock.Lock()<br><span class="hljs-keyword">defer</span> bus.lock.Unlock()<br><br>v := reflect.ValueOf(f)<br><span class="hljs-keyword">if</span> v.Type().Kind() != reflect.Func &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;handler is not a function&quot;</span>)<br>&#125;<br><br>handler, ok := bus.handlers[topic]<br><span class="hljs-keyword">if</span> !ok &#123;<br>handler = []reflect.Value&#123;&#125;<br>&#125;<br>handler = <span class="hljs-built_in">append</span>(handler, v)<br>bus.handlers[topic] = handler<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// Publish å‘å¸ƒ</span><br><span class="hljs-comment">// è¿™é‡Œå¼‚æ­¥æ‰§è¡Œï¼Œå¹¶ä¸”ä¸ä¼šç­‰å¾…è¿”å›ç»“æœ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(bus *AsyncEventBus)</span> <span class="hljs-title">Publish</span><span class="hljs-params">(topic <span class="hljs-keyword">string</span>, args ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>handlers, ok := bus.handlers[topic]<br><span class="hljs-keyword">if</span> !ok &#123;<br>fmt.Println(<span class="hljs-string">&quot;not found handlers in topic:&quot;</span>, topic)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>params := <span class="hljs-built_in">make</span>([]reflect.Value, <span class="hljs-built_in">len</span>(args))<br><span class="hljs-keyword">for</span> i, arg := <span class="hljs-keyword">range</span> args &#123;<br>params[i] = reflect.ValueOf(arg)<br>&#125;<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> handlers &#123;<br><span class="hljs-keyword">go</span> handlers[i].Call(params)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å•å…ƒæµ‹è¯•-1"><a href="#å•å…ƒæµ‹è¯•-1" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> eventbus<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;testing&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sub1</span><span class="hljs-params">(msg1, msg2 <span class="hljs-keyword">string</span>)</span></span> &#123;<br>time.Sleep(<span class="hljs-number">1</span> * time.Microsecond)<br>fmt.Printf(<span class="hljs-string">&quot;sub1, %s %s\n&quot;</span>, msg1, msg2)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sub2</span><span class="hljs-params">(msg1, msg2 <span class="hljs-keyword">string</span>)</span></span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;sub2, %s %s\n&quot;</span>, msg1, msg2)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestAsyncEventBus_Publish</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>bus := NewAsyncEventBus()<br>bus.Subscribe(<span class="hljs-string">&quot;topic:1&quot;</span>, sub1)<br>bus.Subscribe(<span class="hljs-string">&quot;topic:1&quot;</span>, sub2)<br>bus.Publish(<span class="hljs-string">&quot;topic:1&quot;</span>, <span class="hljs-string">&quot;test1&quot;</span>, <span class="hljs-string">&quot;test2&quot;</span>)<br>bus.Publish(<span class="hljs-string">&quot;topic:1&quot;</span>, <span class="hljs-string">&quot;testA&quot;</span>, <span class="hljs-string">&quot;testB&quot;</span>)<br>time.Sleep(<span class="hljs-number">1</span> * time.Second)<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">=== RUN   TestAsyncEventBus_Publish<br>sub2, testA testB<br>sub2, test1 test2<br>sub1, testA testB<br>sub1, test1 test2<br>--- PASS: TestAsyncEventBus_Publish (<span class="hljs-number">1.01</span>s)<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>è¡Œä¸ºå‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼12-äº«å…ƒæ¨¡å¼</title>
    <link href="/post/flyweight.html"/>
    <url>/post/flyweight.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/208572">54 | äº«å…ƒæ¨¡å¼ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•åˆ©ç”¨äº«å…ƒæ¨¡å¼ä¼˜åŒ–æ–‡æœ¬ç¼–è¾‘å™¨çš„å†…å­˜å ç”¨ï¼Ÿ</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 12/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154335161-74381c22-12a0-4878-8665-fd94e4bb7d27.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>å¤ç”¨è¯¾ç¨‹ä¸­çš„ ğŸŒ°ï¼Œå¦‚æœæˆ‘ä»¬ç°åœ¨æ­£åœ¨åšä¸€ä¸ªæ£‹ç‰Œç±»çš„æ¸¸æˆï¼Œä¾‹å¦‚è±¡æ£‹ï¼Œæ— è®ºæ˜¯ä»€ä¹ˆå¯¹å±€ï¼Œæ£‹å­çš„åŸºæœ¬å±æ€§å…¶å®æ˜¯å›ºå®šçš„ï¼Œå¹¶ä¸ä¼šå› ä¸ºéšç€ä¸‹æ£‹çš„è¿‡ç¨‹å˜åŒ–ã€‚é‚£æˆ‘ä»¬å°±å¯ä»¥æŠŠæ£‹å­å˜ä¸ºäº«å…ƒï¼Œè®©æ‰€æœ‰çš„å¯¹å±€éƒ½å…±äº«è¿™äº›å¯¹è±¡ï¼Œä»¥æ­¤è¾¾åˆ°èŠ‚çœå†…å­˜çš„ç›®çš„ã€‚</p><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> flyweight<br><br><span class="hljs-keyword">var</span> units = <span class="hljs-keyword">map</span>[<span class="hljs-keyword">int</span>]*ChessPieceUnit&#123;<br><span class="hljs-number">1</span>: &#123;<br>ID:    <span class="hljs-number">1</span>,<br>Name:  <span class="hljs-string">&quot;è»Š&quot;</span>,<br>Color: <span class="hljs-string">&quot;red&quot;</span>,<br>&#125;,<br><span class="hljs-number">2</span>: &#123;<br>ID:    <span class="hljs-number">2</span>,<br>Name:  <span class="hljs-string">&quot;ç‚®&quot;</span>,<br>Color: <span class="hljs-string">&quot;red&quot;</span>,<br>&#125;,<br><span class="hljs-comment">// ... å…¶ä»–æ£‹å­</span><br>&#125;<br><br><span class="hljs-comment">// ChessPieceUnit æ£‹å­äº«å…ƒ</span><br><span class="hljs-keyword">type</span> ChessPieceUnit <span class="hljs-keyword">struct</span> &#123;<br>ID    <span class="hljs-keyword">uint</span><br>Name  <span class="hljs-keyword">string</span><br>Color <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-comment">// NewChessPieceUnit å·¥å‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewChessPieceUnit</span><span class="hljs-params">(id <span class="hljs-keyword">int</span>)</span> *<span class="hljs-title">ChessPieceUnit</span></span> &#123;<br><span class="hljs-keyword">return</span> units[id]<br>&#125;<br><br><span class="hljs-comment">// ChessPiece æ£‹å­</span><br><span class="hljs-keyword">type</span> ChessPiece <span class="hljs-keyword">struct</span> &#123;<br>Unit *ChessPieceUnit<br>X    <span class="hljs-keyword">int</span><br>Y    <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-comment">// ChessBoard æ£‹å±€</span><br><span class="hljs-keyword">type</span> ChessBoard <span class="hljs-keyword">struct</span> &#123;<br>chessPieces <span class="hljs-keyword">map</span>[<span class="hljs-keyword">int</span>]*ChessPiece<br>&#125;<br><br><span class="hljs-comment">// NewChessBoard åˆå§‹åŒ–æ£‹ç›˜</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewChessBoard</span><span class="hljs-params">()</span> *<span class="hljs-title">ChessBoard</span></span> &#123;<br>board := &amp;ChessBoard&#123;chessPieces: <span class="hljs-keyword">map</span>[<span class="hljs-keyword">int</span>]*ChessPiece&#123;&#125;&#125;<br><span class="hljs-keyword">for</span> id := <span class="hljs-keyword">range</span> units &#123;<br>board.chessPieces[id] = &amp;ChessPiece&#123;<br>Unit: NewChessPieceUnit(id),<br>X:    <span class="hljs-number">0</span>,<br>Y:    <span class="hljs-number">0</span>,<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> board<br>&#125;<br><br><span class="hljs-comment">// Move ç§»åŠ¨æ£‹å­</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *ChessBoard)</span> <span class="hljs-title">Move</span><span class="hljs-params">(id, x, y <span class="hljs-keyword">int</span>)</span></span> &#123;<br>c.chessPieces[id].X = x<br>c.chessPieces[id].Y = y<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> flyweight<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestNewChessBoard</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>board1 := NewChessBoard()<br>board1.Move(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<br>board2 := NewChessBoard()<br>board2.Move(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)<br><br>assert.Equal(t, board1.chessPieces[<span class="hljs-number">1</span>].Unit, board2.chessPieces[<span class="hljs-number">1</span>].Unit)<br>assert.Equal(t, board1.chessPieces[<span class="hljs-number">2</span>].Unit, board2.chessPieces[<span class="hljs-number">2</span>].Unit)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>ç»“æ„å‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼11-ç»„åˆæ¨¡å¼</title>
    <link href="/post/composite.html"/>
    <url>/post/composite.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/207456">53 | ç»„åˆæ¨¡å¼ï¼šå¦‚ä½•è®¾è®¡å®ç°æ”¯æŒé€’å½’éå†çš„æ–‡ä»¶ç³»ç»Ÿç›®å½•æ ‘ç»“æ„ï¼Ÿ</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 11/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154326470-badb82c8-7938-4201-b024-c3dcd033f593.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>å…¬å¸çš„äººå‘˜ç»„ç»‡å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„æ ‘çŠ¶çš„ç»“æ„ï¼Œç°åœ¨å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰éƒ¨åˆ†ï¼Œå’Œå‘˜å·¥ï¼Œä¸¤ç§è§’è‰²ï¼Œä¸€ä¸ªéƒ¨é—¨ä¸‹é¢å¯ä»¥å­˜åœ¨å­éƒ¨é—¨å’Œå‘˜å·¥ï¼Œå‘˜å·¥ä¸‹é¢ä¸èƒ½å†åŒ…å«å…¶ä»–èŠ‚ç‚¹ã€‚<br>æˆ‘ä»¬ç°åœ¨è¦å®ç°ä¸€ä¸ªç»Ÿè®¡ä¸€ä¸ªéƒ¨é—¨ä¸‹å‘˜å·¥æ•°é‡çš„åŠŸèƒ½</p><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> composite<br><br><span class="hljs-comment">// IOrganization ç»„ç»‡æ¥å£ï¼Œéƒ½å®ç°ç»Ÿè®¡äººæ•°çš„åŠŸèƒ½</span><br><span class="hljs-keyword">type</span> IOrganization <span class="hljs-keyword">interface</span> &#123;<br>Count() <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-comment">// Employee å‘˜å·¥</span><br><span class="hljs-keyword">type</span> Employee <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-comment">// Count äººæ•°ç»Ÿè®¡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(Employee)</span> <span class="hljs-title">Count</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>&#125;<br><br><span class="hljs-comment">// Department éƒ¨é—¨</span><br><span class="hljs-keyword">type</span> Department <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-keyword">string</span><br><br>SubOrganizations []IOrganization<br>&#125;<br><br><span class="hljs-comment">// Count äººæ•°ç»Ÿè®¡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d Department)</span> <span class="hljs-title">Count</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123;<br>c := <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> _, org := <span class="hljs-keyword">range</span> d.SubOrganizations &#123;<br>c += org.Count()<br>&#125;<br><span class="hljs-keyword">return</span> c<br>&#125;<br><br><span class="hljs-comment">// AddSub æ·»åŠ å­èŠ‚ç‚¹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d *Department)</span> <span class="hljs-title">AddSub</span><span class="hljs-params">(org IOrganization)</span></span> &#123;<br>d.SubOrganizations = <span class="hljs-built_in">append</span>(d.SubOrganizations, org)<br>&#125;<br><br><span class="hljs-comment">// NewOrganization æ„å»ºç»„ç»‡æ¶æ„ demo</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewOrganization</span><span class="hljs-params">()</span> <span class="hljs-title">IOrganization</span></span> &#123;<br>root := &amp;Department&#123;Name: <span class="hljs-string">&quot;root&quot;</span>&#125;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>root.AddSub(&amp;Employee&#123;&#125;)<br>root.AddSub(&amp;Department&#123;Name: <span class="hljs-string">&quot;sub&quot;</span>, SubOrganizations: []IOrganization&#123;&amp;Employee&#123;&#125;&#125;&#125;)<br>&#125;<br><span class="hljs-keyword">return</span> root<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> composite<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestNewOrganization</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>got := NewOrganization().Count()<br>assert.Equal(t, <span class="hljs-number">20</span>, got)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>ç»“æ„å‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼10-é—¨é¢æ¨¡å¼</title>
    <link href="/post/facade.html"/>
    <url>/post/facade.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/206409">52 | é—¨é¢æ¨¡å¼ï¼šå¦‚ä½•è®¾è®¡åˆç†çš„æ¥å£ç²’åº¦ä»¥å…¼é¡¾æ¥å£çš„æ˜“ç”¨æ€§å’Œé€šç”¨æ€§ï¼Ÿ</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: /22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154318152-556e1feb-221d-43cb-8e67-3457a27956af.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>å‡è®¾ç°åœ¨æˆ‘æœ‰ä¸€ä¸ªç½‘ç«™ï¼Œä»¥å‰æœ‰ç™»å½•å’Œæ³¨å†Œçš„æµç¨‹ï¼Œç™»å½•çš„æ—¶å€™è°ƒç”¨ç”¨æˆ·çš„æŸ¥è¯¢æ¥å£ï¼Œæ³¨å†Œæ—¶è°ƒç”¨ç”¨æˆ·çš„åˆ›å»ºæ¥å£ã€‚ä¸ºäº†ç®€åŒ–ç”¨æˆ·çš„ä½¿ç”¨æµç¨‹ï¼Œæˆ‘ä»¬ç°åœ¨æä¾›ç›´æ¥éªŒè¯ç ç™»å½•/æ³¨å†Œçš„åŠŸèƒ½ï¼Œå¦‚æœè¯¥æ‰‹æœºå·å·²æ³¨å†Œé‚£ä¹ˆæˆ‘ä»¬å°±èµ°ç™»å½•æµç¨‹ï¼Œå¦‚æœè¯¥æ‰‹æœºå·æœªæ³¨å†Œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·ã€‚</p><h3 id="code"><a href="#code" class="headerlink" title="code"></a>code</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> facade<br><br><span class="hljs-comment">// IUser ç”¨æˆ·æ¥å£</span><br><span class="hljs-keyword">type</span> IUser <span class="hljs-keyword">interface</span> &#123;<br>Login(phone <span class="hljs-keyword">int</span>, code <span class="hljs-keyword">int</span>) (*User, error)<br>Register(phone <span class="hljs-keyword">int</span>, code <span class="hljs-keyword">int</span>) (*User, error)<br>&#125;<br><br><span class="hljs-comment">// IUserFacade é—¨é¢æ¨¡å¼</span><br><span class="hljs-keyword">type</span> IUserFacade <span class="hljs-keyword">interface</span> &#123;<br>LoginOrRegister(phone <span class="hljs-keyword">int</span>, code <span class="hljs-keyword">int</span>) error<br>&#125;<br><br><span class="hljs-comment">// User ç”¨æˆ·</span><br><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-comment">// UserService UserService</span><br><span class="hljs-keyword">type</span> UserService <span class="hljs-keyword">struct</span> &#123;&#125;<br><br><span class="hljs-comment">// Login ç™»å½•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u UserService)</span> <span class="hljs-title">Login</span><span class="hljs-params">(phone <span class="hljs-keyword">int</span>, code <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(*User, error)</span></span> &#123;<br><span class="hljs-comment">// æ ¡éªŒæ“ä½œ ...</span><br><span class="hljs-keyword">return</span> &amp;User&#123;Name: <span class="hljs-string">&quot;test login&quot;</span>&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// Register æ³¨å†Œ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u UserService)</span> <span class="hljs-title">Register</span><span class="hljs-params">(phone <span class="hljs-keyword">int</span>, code <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(*User, error)</span></span> &#123;<br><span class="hljs-comment">// æ ¡éªŒæ“ä½œ ...</span><br><span class="hljs-comment">// åˆ›å»ºç”¨æˆ·</span><br><span class="hljs-keyword">return</span> &amp;User&#123;Name: <span class="hljs-string">&quot;test register&quot;</span>&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// LoginOrRegister ç™»å½•æˆ–æ³¨å†Œ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u UserService)</span><span class="hljs-title">LoginOrRegister</span><span class="hljs-params">(phone <span class="hljs-keyword">int</span>, code <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(*User, error)</span></span> &#123;<br>user, err := u.Login(phone, code)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br><span class="hljs-keyword">if</span> user != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> user, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-keyword">return</span> u.Register(phone, code)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> facade<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br><span class="hljs-string">&quot;testing&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestUserService_Login</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>service := UserService&#123;&#125;<br>user, err := service.Login(<span class="hljs-number">13001010101</span>, <span class="hljs-number">1234</span>)<br>assert.NoError(t, err)<br>assert.Equal(t, &amp;User&#123;Name: <span class="hljs-string">&quot;test login&quot;</span>&#125;, user)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestUserService_LoginOrRegister</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>service := UserService&#123;&#125;<br>user, err := service.LoginOrRegister(<span class="hljs-number">13001010101</span>, <span class="hljs-number">1234</span>)<br>assert.NoError(t, err)<br>assert.Equal(t, &amp;User&#123;Name: <span class="hljs-string">&quot;test login&quot;</span>&#125;, user)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestUserService_Register</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>service := UserService&#123;&#125;<br>user, err := service.Register(<span class="hljs-number">13001010101</span>, <span class="hljs-number">1234</span>)<br>assert.NoError(t, err)<br>assert.Equal(t, &amp;User&#123;Name: <span class="hljs-string">&quot;test register&quot;</span>&#125;, user)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>ç»“æ„å‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼09-é€‚é…å™¨æ¨¡å¼</title>
    <link href="/post/adapter.html"/>
    <url>/post/adapter.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/205912">51 | é€‚é…å™¨æ¨¡å¼ï¼šä»£ç†ã€é€‚é…å™¨ã€æ¡¥æ¥ã€è£…é¥°ï¼Œè¿™å››ä¸ªæ¨¡å¼æœ‰ä½•åŒºåˆ«ï¼Ÿ</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 09/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154310450-6522fa7f-2807-4f79-8cc7-9c95d848bb25.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>å‡è®¾æˆ‘ç°åœ¨æœ‰ä¸€ä¸ªè¿ç»´ç³»ç»Ÿï¼Œéœ€è¦åˆ†åˆ«è°ƒç”¨é˜¿é‡Œäº‘å’Œ AWS çš„ SDK åˆ›å»ºä¸»æœºï¼Œä¸¤ä¸ª SDK æä¾›çš„åˆ›å»ºä¸»æœºçš„æ¥å£ä¸ä¸€è‡´ï¼Œæ­¤æ—¶å°±å¯ä»¥é€šè¿‡é€‚é…å™¨æ¨¡å¼ï¼Œå°†ä¸¤ä¸ªæ¥å£ç»Ÿä¸€ã€‚<br><strong>PSï¼šAWS å’Œ é˜¿é‡Œäº‘çš„æ¥å£çº¯å±è™šæ„ï¼Œæ²¡æœ‰ç›´æ¥ç”¨åŸå§‹çš„ SDKï¼Œåªæ˜¯ä¸¾ä¸ªä¾‹å­</strong></p><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> adapter<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-comment">// ICreateServer åˆ›å»ºäº‘ä¸»æœº</span><br><span class="hljs-keyword">type</span> ICreateServer <span class="hljs-keyword">interface</span> &#123;<br>CreateServer(cpu, mem <span class="hljs-keyword">float64</span>) error<br>&#125;<br><br><span class="hljs-comment">// AWSClient aws sdk</span><br><span class="hljs-keyword">type</span> AWSClient <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// RunInstance å¯åŠ¨å®ä¾‹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *AWSClient)</span> <span class="hljs-title">RunInstance</span><span class="hljs-params">(cpu, mem <span class="hljs-keyword">float64</span>)</span> <span class="hljs-title">error</span></span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;aws client run success, cpuï¼š %f, mem: %f&quot;</span>, cpu, mem)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// AwsClientAdapter é€‚é…å™¨</span><br><span class="hljs-keyword">type</span> AwsClientAdapter <span class="hljs-keyword">struct</span> &#123;<br>Client AWSClient<br>&#125;<br><br><span class="hljs-comment">// CreateServer å¯åŠ¨å®ä¾‹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *AwsClientAdapter)</span> <span class="hljs-title">CreateServer</span><span class="hljs-params">(cpu, mem <span class="hljs-keyword">float64</span>)</span> <span class="hljs-title">error</span></span> &#123;<br>a.Client.RunInstance(cpu, mem)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// AliyunClient aliyun sdk</span><br><span class="hljs-keyword">type</span> AliyunClient <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// CreateServer å¯åŠ¨å®ä¾‹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *AliyunClient)</span> <span class="hljs-title">CreateServer</span><span class="hljs-params">(cpu, mem <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">error</span></span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;aws client run success, cpuï¼š %d, mem: %d&quot;</span>, cpu, mem)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// AliyunClientAdapter é€‚é…å™¨</span><br><span class="hljs-keyword">type</span> AliyunClientAdapter <span class="hljs-keyword">struct</span> &#123;<br>Client AliyunClient<br>&#125;<br><br><span class="hljs-comment">// CreateServer å¯åŠ¨å®ä¾‹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *AliyunClientAdapter)</span> <span class="hljs-title">CreateServer</span><span class="hljs-params">(cpu, mem <span class="hljs-keyword">float64</span>)</span> <span class="hljs-title">error</span></span> &#123;<br>a.Client.CreateServer(<span class="hljs-keyword">int</span>(cpu), <span class="hljs-keyword">int</span>(mem))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> adapter<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestAliyunClientAdapter_CreateServer</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-comment">// ç¡®ä¿ adapter å®ç°äº†ç›®æ ‡æ¥å£</span><br><span class="hljs-keyword">var</span> a ICreateServer = &amp;AliyunClientAdapter&#123;<br>Client: AliyunClient&#123;&#125;,<br>&#125;<br><br>a.CreateServer(<span class="hljs-number">1.0</span>, <span class="hljs-number">2.0</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestAwsClientAdapter_CreateServer</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-comment">// ç¡®ä¿ adapter å®ç°äº†ç›®æ ‡æ¥å£</span><br><span class="hljs-keyword">var</span> a ICreateServer = &amp;AwsClientAdapter&#123;<br>Client: AWSClient&#123;&#125;,<br>&#125;<br><br>a.CreateServer(<span class="hljs-number">1.0</span>, <span class="hljs-number">2.0</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>ç»“æ„å‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼08-è£…é¥°å™¨æ¨¡å¼</title>
    <link href="/post/decorator.html"/>
    <url>/post/decorator.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/204845">50 | è£…é¥°å™¨æ¨¡å¼ï¼šé€šè¿‡å‰–æ Java IO ç±»åº“æºç å­¦ä¹ è£…é¥°å™¨æ¨¡å¼</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 08/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154301481-9e70e78b-03b0-45a4-b33d-e2f972d100e5.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç”»ç”»çš„ä¾‹å­ï¼Œé»˜è®¤çš„ <code>Square</code>  åªæœ‰åŸºç¡€çš„ç”»ç”»åŠŸèƒ½ï¼Œ <code>ColorSquare</code>  ä¸ºä»–åŠ ä¸Šäº†é¢œè‰²</p><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> decorator<br><br><span class="hljs-comment">// IDraw IDraw</span><br><span class="hljs-keyword">type</span> IDraw <span class="hljs-keyword">interface</span> &#123;<br>Draw() <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-comment">// Square æ­£æ–¹å½¢</span><br><span class="hljs-keyword">type</span> Square <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// Draw Draw</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s Square)</span> <span class="hljs-title">Draw</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;this is a square&quot;</span><br>&#125;<br><br><span class="hljs-comment">// ColorSquare æœ‰é¢œè‰²çš„æ­£æ–¹å½¢</span><br><span class="hljs-keyword">type</span> ColorSquare <span class="hljs-keyword">struct</span> &#123;<br>square IDraw<br>color  <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-comment">// NewColorSquare NewColorSquare</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewColorSquare</span><span class="hljs-params">(square IDraw, color <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">ColorSquare</span></span> &#123;<br><span class="hljs-keyword">return</span> ColorSquare&#123;color: color, square: square&#125;<br>&#125;<br><br><span class="hljs-comment">// Draw Draw</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c ColorSquare)</span> <span class="hljs-title">Draw</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">return</span> c.square.Draw() + <span class="hljs-string">&quot;, color is &quot;</span> + c.color<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestColorSquare_Draw</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>sq := Square&#123;&#125;<br>csq := NewColorSquare(sq, <span class="hljs-string">&quot;red&quot;</span>)<br>got := csq.Draw()<br>assert.Equal(t, <span class="hljs-string">&quot;this is a square, color is red&quot;</span>, got)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>ç»“æ„å‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼07-æ¡¥æ¥æ¨¡å¼</title>
    <link href="/post/bridge.html"/>
    <url>/post/bridge.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/202786">49 | æ¡¥æ¥æ¨¡å¼ï¼šå¦‚ä½•å®ç°æ”¯æŒä¸åŒç±»å‹å’Œæ¸ é“çš„æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼Ÿ</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 07/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154283457-c3b8b276-b7d3-4615-b6c2-b5f67860ed01.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> bridge<br><br><span class="hljs-comment">// IMsgSender IMsgSender</span><br><span class="hljs-keyword">type</span> IMsgSender <span class="hljs-keyword">interface</span> &#123;<br>Send(msg <span class="hljs-keyword">string</span>) error<br>&#125;<br><br><span class="hljs-comment">// EmailMsgSender å‘é€é‚®ä»¶</span><br><span class="hljs-comment">// å¯èƒ½è¿˜æœ‰ ç”µè¯ã€çŸ­ä¿¡ç­‰å„ç§å®ç°</span><br><span class="hljs-keyword">type</span> EmailMsgSender <span class="hljs-keyword">struct</span> &#123;<br>emails []<span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-comment">// NewEmailMsgSender NewEmailMsgSender</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewEmailMsgSender</span><span class="hljs-params">(emails []<span class="hljs-keyword">string</span>)</span> *<span class="hljs-title">EmailMsgSender</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;EmailMsgSender&#123;emails: emails&#125;<br>&#125;<br><br><span class="hljs-comment">// Send Send</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *EmailMsgSender)</span> <span class="hljs-title">Send</span><span class="hljs-params">(msg <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-comment">// è¿™é‡Œå»å‘é€æ¶ˆæ¯</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// INotification é€šçŸ¥æ¥å£</span><br><span class="hljs-keyword">type</span> INotification <span class="hljs-keyword">interface</span> &#123;<br>Notify(msg <span class="hljs-keyword">string</span>) error<br>&#125;<br><br><span class="hljs-comment">// ErrorNotification é”™è¯¯é€šçŸ¥</span><br><span class="hljs-comment">// åé¢å¯èƒ½è¿˜æœ‰ warning å„ç§çº§åˆ«</span><br><span class="hljs-keyword">type</span> ErrorNotification <span class="hljs-keyword">struct</span> &#123;<br>sender IMsgSender<br>&#125;<br><br><span class="hljs-comment">// NewErrorNotification NewErrorNotification</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewErrorNotification</span><span class="hljs-params">(sender IMsgSender)</span> *<span class="hljs-title">ErrorNotification</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;ErrorNotification&#123;sender: sender&#125;<br>&#125;<br><br><span class="hljs-comment">// Notify å‘é€é€šçŸ¥</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(n *ErrorNotification)</span> <span class="hljs-title">Notify</span><span class="hljs-params">(msg <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> n.sender.Send(msg)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestErrorNotification_Notify</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>sender := NewEmailMsgSender([]<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">&quot;test@test.com&quot;</span>&#125;)<br>n := NewErrorNotification(sender)<br>err := n.Notify(<span class="hljs-string">&quot;test msg&quot;</span>)<br><br>assert.Nil(t, err)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>ç»“æ„å‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼06-ä»£ç†æ¨¡å¼(generateå®ç°ç±»ä¼¼åŠ¨æ€ä»£ç†)</title>
    <link href="/post/proxy.html"/>
    <url>/post/proxy.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/201823">48 | ä»£ç†æ¨¡å¼ï¼šä»£ç†åœ¨ RPCã€ç¼“å­˜ã€ç›‘æ§ç­‰åœºæ™¯ä¸­çš„åº”ç”¨</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 06/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154274933-9fbee90c-d205-4651-9c8d-73b60fe63e1b.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>æ¥ä¸‹æ¥ä¼šé€šè¿‡ golang å®ç°é™æ€ä»£ç†ï¼Œæœ‰ Golang å’Œ java çš„å·®å¼‚æ€§ï¼Œæˆ‘ä»¬æ— æ³•æ¯”è¾ƒæ–¹ä¾¿çš„åˆ©ç”¨åå°„å®ç°åŠ¨æ€ä»£ç†ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨<strong> go generate </strong>å®ç°ç±»ä¼¼çš„æ•ˆæœï¼Œå¹¶ä¸”è¿™æ ·å®ç°æœ‰ä¸¤ä¸ªæ¯”è¾ƒå¤§çš„å¥½å¤„ï¼Œä¸€ä¸ªæ˜¯æœ‰é™æ€ä»£ç æ£€æŸ¥ï¼Œæˆ‘ä»¬åœ¨ç¼–è¯‘æœŸé—´å°±å¯ä»¥åŠæ—©å‘ç°é—®é¢˜ï¼Œç¬¬äºŒä¸ªæ˜¯æ€§èƒ½ä¼šæ›´å¥½ã€‚</p><h3 id="é™æ€ä»£ç†"><a href="#é™æ€ä»£ç†" class="headerlink" title="é™æ€ä»£ç†"></a>é™æ€ä»£ç†</h3><h4 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> proxy<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;log&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// IUser IUser</span><br><span class="hljs-keyword">type</span> IUser <span class="hljs-keyword">interface</span> &#123;<br>Login(username, password <span class="hljs-keyword">string</span>) error<br>&#125;<br><br><span class="hljs-comment">// User ç”¨æˆ·</span><br><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>&#125;<br><br><span class="hljs-comment">// Login ç”¨æˆ·ç™»å½•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *User)</span> <span class="hljs-title">Login</span><span class="hljs-params">(username, password <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-comment">// ä¸å®ç°ç»†èŠ‚</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// UserProxy ä»£ç†ç±»</span><br><span class="hljs-keyword">type</span> UserProxy <span class="hljs-keyword">struct</span> &#123;<br>user *User<br>&#125;<br><br><span class="hljs-comment">// NewUserProxy NewUserProxy</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserProxy</span><span class="hljs-params">(user *User)</span> *<span class="hljs-title">UserProxy</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;UserProxy&#123;<br>user: user,<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Login ç™»å½•ï¼Œå’Œ user å®ç°ç›¸åŒçš„æ¥å£</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *UserProxy)</span> <span class="hljs-title">Login</span><span class="hljs-params">(username, password <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-comment">// before è¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸€äº›ç»Ÿè®¡çš„é€»è¾‘</span><br>start := time.Now()<br><br><span class="hljs-comment">// è¿™é‡Œæ˜¯åŸæœ‰çš„ä¸šåŠ¡é€»è¾‘</span><br><span class="hljs-keyword">if</span> err := p.user.Login(username, password); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-comment">// after è¿™é‡Œå¯èƒ½ä¹Ÿæœ‰ä¸€äº›ç›‘æ§ç»Ÿè®¡çš„é€»è¾‘</span><br>log.Printf(<span class="hljs-string">&quot;user login cost time: %s&quot;</span>, time.Now().Sub(start))<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> proxy<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/require&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestUserProxy_Login</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>proxy := NewUserProxy(&amp;User&#123;&#125;)<br><br>err := proxy.Login(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;password&quot;</span>)<br><br>require.Nil(t, err)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Go-Generate-å®ç°-â€œåŠ¨æ€ä»£ç†â€"><a href="#Go-Generate-å®ç°-â€œåŠ¨æ€ä»£ç†â€" class="headerlink" title="Go Generate å®ç° â€œåŠ¨æ€ä»£ç†â€"></a>Go Generate å®ç° â€œåŠ¨æ€ä»£ç†â€</h3><p>å…³äº go generate ä¹‹å‰å·²ç»å†™è¿‡ä¸€ç¯‡å…¥é—¨çš„ä»‹ç»æ–‡ç« : <a href="https://lailin.xyz/post/41140.html">go generate and ast</a>ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ï¼Œå¦‚æœå¯¹ç›¸å…³çš„çŸ¥è¯†ç‚¹ä¸å¤ªæ¸…æ¥šï¼Œå¯ä»¥å…ˆçœ‹å‰é¢çš„é‚£ç¯‡æ–‡ç« ã€‚<br><strong>æ³¨æ„: åœ¨çœŸå®çš„é¡¹ç›®ä¸­å¹¶ä¸æ¨èè¿™ä¹ˆåšï¼Œå› ä¸ºæœ‰ç‚¹å¾—ä¸å¿å¤±ï¼Œæœ¬æ–‡åªæ˜¯åœ¨æ¢è®¨ä¸€ç§å¯èƒ½æ€§ï¼Œå¹¶ä¸”å¯ä»¥å¤ä¹ ä¸€ä¸‹ go è¯­æ³•æ ‘å…ˆå…³çš„çŸ¥è¯†ç‚¹</strong><br>æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹éœ€æ±‚ã€‚</p><h4 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h4><p>åŠ¨æ€ä»£ç†ç›¸æ¯”é™æ€ä»£ç†ä¸»è¦å°±æ˜¯ä¸ºäº†è§£å†³ç”Ÿäº§åŠ›ï¼Œå°†æˆ‘ä»¬ä»ç¹æ‚çš„é‡å¤åŠ³åŠ¨ä¸­è§£æ”¾å‡ºæ¥ï¼Œæ­£å¥½ï¼Œåœ¨ Go ä¸­ Generate ä¹Ÿæ˜¯å¹²è¿™ä¸ªæ´»çš„<br>å¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬çš„ generate ä¼šè¯»å– struct ä¸Šçš„æ³¨é‡Šï¼Œå¦‚æœå‡ºç° <code>@proxy æ¥å£å</code>  çš„æ³¨é‡Šï¼Œæˆ‘ä»¬å°±ä¼šä¸ºè¿™ä¸ª struct ç”Ÿæˆä¸€ä¸ª proxy ç±»ï¼ŒåŒæ—¶å®ç°ç›¸åŒçš„æ¥å£ï¼Œè¿™ä¸ªæ¥å£å°±æ˜¯åœ¨æ³¨é‡Šä¸­æŒ‡å®šçš„æ¥å£</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// User ç”¨æˆ·</span><br><span class="hljs-comment">// @proxy IUser</span><br><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Code-1"><a href="#Code-1" class="headerlink" title="Code"></a>Code</h4><p>æ¥æ¥ä¸‹æˆ‘ä»¬ä¼šç®€å•çš„å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œç”±äºç¯‡å¹…å’Œæ—¶é—´çš„å…³ç³»ï¼Œæˆ‘ä»¬ä¼šç•¥è¿‡ä¸€äº›æ£€æŸ¥ä¹‹ç±»çš„ä»£ç ï¼Œä¾‹å¦‚ <code>User</code>  æ˜¯å¦çœŸæ­£å®ç°äº† <code>IUser</code>  è¿™ç§æƒ…å†µã€‚<br><strong>ä»£ç æœ‰ç‚¹é•¿ï¼Œä¸»è¦æ€è·¯:</strong></p><ul><li>è¯»å–æ–‡ä»¶, è·å–æ–‡ä»¶çš„ ast è¯­æ³•æ ‘</li><li>é€šè¿‡ NewCommentMap æ„å»º node å’Œ comment çš„å…³ç³»</li><li>é€šè¿‡ comment æ˜¯å¦åŒ…å« <code>@proxy æ¥å£å</code>  çš„æ¥å£ï¼Œåˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç”Ÿæˆä»£ç†ç±»</li><li>é€šè¿‡ Lookup æ–¹æ³•æ‰¾åˆ°æ¥å£</li><li>å¾ªç¯è·å–æ¥å£çš„æ¯ä¸ªæ–¹æ³•çš„ï¼Œæ–¹æ³•åã€å‚æ•°ã€è¿”å›å€¼ä¿¡æ¯</li><li>å°†æ–¹æ³•ä¿¡æ¯ï¼ŒåŒ…åã€éœ€è¦ä»£ç†ç±»åä¼ é€’ç»™æ„å»ºå¥½çš„æ¨¡æ¿æ–‡ä»¶ï¼Œç”Ÿæˆä»£ç†ç±»</li><li>æœ€åç”¨ format åŒ…çš„æ–¹æ³•æ ¼å¼åŒ–æºä»£ç </li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> proxy<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;bytes&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;go/ast&quot;</span><br><span class="hljs-string">&quot;go/format&quot;</span><br><span class="hljs-string">&quot;go/parser&quot;</span><br><span class="hljs-string">&quot;go/token&quot;</span><br><span class="hljs-string">&quot;strings&quot;</span><br><span class="hljs-string">&quot;text/template&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generate</span><span class="hljs-params">(file <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(<span class="hljs-keyword">string</span>, error)</span></span> &#123;<br>fset := token.NewFileSet() <span class="hljs-comment">// positions are relative to fset</span><br>f, err := parser.ParseFile(fset, file, <span class="hljs-literal">nil</span>, parser.ParseComments)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>&#125;<br><br><span class="hljs-comment">// è·å–ä»£ç†éœ€è¦çš„æ•°æ®</span><br>data := proxyData&#123;<br>Package: f.Name.Name,<br>&#125;<br><br><span class="hljs-comment">// æ„å»ºæ³¨é‡Šå’Œ node çš„å…³ç³»</span><br>cmap := ast.NewCommentMap(fset, f, f.Comments)<br><span class="hljs-keyword">for</span> node, group := <span class="hljs-keyword">range</span> cmap &#123;<br><span class="hljs-comment">// ä»æ³¨é‡Š @proxy æ¥å£åï¼Œè·å–æ¥å£åç§°</span><br>name := getProxyInterfaceName(group)<br><span class="hljs-keyword">if</span> name == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br><span class="hljs-comment">// è·å–ä»£ç†çš„ç±»å</span><br>data.ProxyStructName = node.(*ast.GenDecl).Specs[<span class="hljs-number">0</span>].(*ast.TypeSpec).Name.Name<br><br><span class="hljs-comment">// ä»æ–‡ä»¶ä¸­æŸ¥æ‰¾æ¥å£</span><br>obj := f.Scope.Lookup(name)<br><br><span class="hljs-comment">// ç±»å‹è½¬æ¢ï¼Œæ³¨æ„: è¿™é‡Œæ²¡æœ‰å¯¹æ–­è¨€è¿›è¡Œåˆ¤æ–­ï¼Œå¯èƒ½ä¼šå¯¼è‡´ panic</span><br>t := obj.Decl.(*ast.TypeSpec).Type.(*ast.InterfaceType)<br><br><span class="hljs-keyword">for</span> _, field := <span class="hljs-keyword">range</span> t.Methods.List &#123;<br>fc := field.Type.(*ast.FuncType)<br><br><span class="hljs-comment">// ä»£ç†çš„æ–¹æ³•</span><br>method := &amp;proxyMethod&#123;<br>Name: field.Names[<span class="hljs-number">0</span>].Name,<br>&#125;<br><br><span class="hljs-comment">// è·å–æ–¹æ³•çš„å‚æ•°å’Œè¿”å›å€¼</span><br>method.Params, method.ParamNames = getParamsOrResults(fc.Params)<br>method.Results, method.ResultNames = getParamsOrResults(fc.Results)<br><br>data.Methods = <span class="hljs-built_in">append</span>(data.Methods, method)<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// ç”Ÿæˆæ–‡ä»¶</span><br>tpl, err := template.New(<span class="hljs-string">&quot;&quot;</span>).Parse(proxyTpl)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>&#125;<br><br>buf := &amp;bytes.Buffer&#123;&#125;<br><span class="hljs-keyword">if</span> err := tpl.Execute(buf, data); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ go fmt å¯¹ç”Ÿæˆçš„ä»£ç è¿›è¡Œæ ¼å¼åŒ–</span><br>src, err := format.Source(buf.Bytes())<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-keyword">string</span>(src), <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// getParamsOrResults è·å–å‚æ•°æˆ–è€…æ˜¯è¿”å›å€¼</span><br><span class="hljs-comment">// è¿”å›å¸¦ç±»å‹çš„å‚æ•°ï¼Œä»¥åŠä¸å¸¦ç±»å‹çš„å‚æ•°ï¼Œä»¥é€—å·é—´éš”</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getParamsOrResults</span><span class="hljs-params">(fields *ast.FieldList)</span> <span class="hljs-params">(<span class="hljs-keyword">string</span>, <span class="hljs-keyword">string</span>)</span></span> &#123;<br><span class="hljs-keyword">var</span> (<br>params     []<span class="hljs-keyword">string</span><br>paramNames []<span class="hljs-keyword">string</span><br>)<br><br><span class="hljs-keyword">for</span> i, param := <span class="hljs-keyword">range</span> fields.List &#123;<br><span class="hljs-comment">// å¾ªç¯è·å–æ‰€æœ‰çš„å‚æ•°å</span><br><span class="hljs-keyword">var</span> names []<span class="hljs-keyword">string</span><br><span class="hljs-keyword">for</span> _, name := <span class="hljs-keyword">range</span> param.Names &#123;<br>names = <span class="hljs-built_in">append</span>(names, name.Name)<br>&#125;<br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(names) == <span class="hljs-number">0</span> &#123;<br>names = <span class="hljs-built_in">append</span>(names, fmt.Sprintf(<span class="hljs-string">&quot;r%d&quot;</span>, i))<br>&#125;<br><br>paramNames = <span class="hljs-built_in">append</span>(paramNames, names...)<br><br><span class="hljs-comment">// å‚æ•°ååŠ å‚æ•°ç±»å‹ç»„æˆå®Œæ•´çš„å‚æ•°</span><br>param := fmt.Sprintf(<span class="hljs-string">&quot;%s %s&quot;</span>,<br>strings.Join(names, <span class="hljs-string">&quot;,&quot;</span>),<br>param.Type.(*ast.Ident).Name,<br>)<br>params = <span class="hljs-built_in">append</span>(params, strings.TrimSpace(param))<br>&#125;<br><br><span class="hljs-keyword">return</span> strings.Join(params, <span class="hljs-string">&quot;,&quot;</span>), strings.Join(paramNames, <span class="hljs-string">&quot;,&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getProxyInterfaceName</span><span class="hljs-params">(groups []*ast.CommentGroup)</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">for</span> _, commentGroup := <span class="hljs-keyword">range</span> groups &#123;<br><span class="hljs-keyword">for</span> _, comment := <span class="hljs-keyword">range</span> commentGroup.List &#123;<br><span class="hljs-keyword">if</span> strings.Contains(comment.Text, <span class="hljs-string">&quot;@proxy&quot;</span>) &#123;<br>interfaceName := strings.TrimLeft(comment.Text, <span class="hljs-string">&quot;// @proxy &quot;</span>)<br><span class="hljs-keyword">return</span> strings.TrimSpace(interfaceName)<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>&#125;<br><br><span class="hljs-comment">// ç”Ÿæˆä»£ç†ç±»çš„æ–‡ä»¶æ¨¡æ¿</span><br><span class="hljs-keyword">const</span> proxyTpl = <span class="hljs-string">`</span><br><span class="hljs-string">package &#123;&#123;.Package&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">type &#123;&#123; .ProxyStructName &#125;&#125;Proxy struct &#123;</span><br><span class="hljs-string">child *&#123;&#123; .ProxyStructName &#125;&#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">func New&#123;&#123; .ProxyStructName &#125;&#125;Proxy(child *&#123;&#123; .ProxyStructName &#125;&#125;) *&#123;&#123; .ProxyStructName &#125;&#125;Proxy &#123;</span><br><span class="hljs-string">return &amp;&#123;&#123; .ProxyStructName &#125;&#125;Proxy&#123;child: child&#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#123;&#123; range .Methods &#125;&#125;</span><br><span class="hljs-string">func (p *&#123;&#123;$.ProxyStructName&#125;&#125;Proxy) &#123;&#123; .Name &#125;&#125; (&#123;&#123; .Params &#125;&#125;) (&#123;&#123; .Results &#125;&#125;) &#123;</span><br><span class="hljs-string">// before è¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸€äº›ç»Ÿè®¡çš„é€»è¾‘</span><br><span class="hljs-string">start := time.Now()</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#123;&#123; .ResultNames &#125;&#125; = p.child.&#123;&#123; .Name &#125;&#125;(&#123;&#123; .ParamNames &#125;&#125;)</span><br><span class="hljs-string"></span><br><span class="hljs-string">// after è¿™é‡Œå¯èƒ½ä¹Ÿæœ‰ä¸€äº›ç›‘æ§ç»Ÿè®¡çš„é€»è¾‘</span><br><span class="hljs-string">log.Printf(&quot;user login cost time: %s&quot;, time.Now().Sub(start))</span><br><span class="hljs-string"></span><br><span class="hljs-string">return &#123;&#123; .ResultNames &#125;&#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">&#123;&#123; end &#125;&#125;</span><br><span class="hljs-string">`</span><br><br><span class="hljs-keyword">type</span> proxyData <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// åŒ…å</span><br>Package <span class="hljs-keyword">string</span><br><span class="hljs-comment">// éœ€è¦ä»£ç†çš„ç±»å</span><br>ProxyStructName <span class="hljs-keyword">string</span><br><span class="hljs-comment">// éœ€è¦ä»£ç†çš„æ–¹æ³•</span><br>Methods []*proxyMethod<br>&#125;<br><br><span class="hljs-comment">// proxyMethod ä»£ç†çš„æ–¹æ³•</span><br><span class="hljs-keyword">type</span> proxyMethod <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// æ–¹æ³•å</span><br>Name <span class="hljs-keyword">string</span><br><span class="hljs-comment">// å‚æ•°ï¼Œå«å‚æ•°ç±»å‹</span><br>Params <span class="hljs-keyword">string</span><br><span class="hljs-comment">// å‚æ•°å</span><br>ParamNames <span class="hljs-keyword">string</span><br><span class="hljs-comment">// è¿”å›å€¼</span><br>Results <span class="hljs-keyword">string</span><br><span class="hljs-comment">// è¿”å›å€¼å</span><br>ResultNames <span class="hljs-keyword">string</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å•å…ƒæµ‹è¯•-1"><a href="#å•å…ƒæµ‹è¯•-1" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> proxy<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br><span class="hljs-string">&quot;github.com/stretchr/testify/require&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Test_generate</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>want := <span class="hljs-string">`package proxy</span><br><span class="hljs-string"></span><br><span class="hljs-string">type UserProxy struct &#123;</span><br><span class="hljs-string">child *User</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">func NewUserProxy(child *User) *UserProxy &#123;</span><br><span class="hljs-string">return &amp;UserProxy&#123;child: child&#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">func (p *UserProxy) Login(username, password string) (r0 error) &#123;</span><br><span class="hljs-string">// before è¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸€äº›ç»Ÿè®¡çš„é€»è¾‘</span><br><span class="hljs-string">start := time.Now()</span><br><span class="hljs-string"></span><br><span class="hljs-string">r0 = p.child.Login(username, password)</span><br><span class="hljs-string"></span><br><span class="hljs-string">// after è¿™é‡Œå¯èƒ½ä¹Ÿæœ‰ä¸€äº›ç›‘æ§ç»Ÿè®¡çš„é€»è¾‘</span><br><span class="hljs-string">log.Printf(&quot;user login cost time: %s&quot;, time.Now().Sub(start))</span><br><span class="hljs-string"></span><br><span class="hljs-string">return r0</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">`</span><br>got, err := generate(<span class="hljs-string">&quot;./static_proxy.go&quot;</span>)<br>require.Nil(t, err)<br>assert.Equal(t, want, got)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>ç»“æ„å‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼05-åˆ›å»ºå‹æ¨¡å¼æ€»ç»“</title>
    <link href="/post/go-design-pattern-create.html"/>
    <url>/post/go-design-pattern-create.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å« 23 ç§å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 05/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a></li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è€—æ—¶ 2 å‘¨æ›´æ–°å®Œäº†åˆ›å»ºå‹çš„è®¾è®¡æ¨¡å¼ï¼Œå›å¤´æ€è€ƒä¸€ä¸‹ï¼Œå­¦ä¹ è®¾è®¡æ¨¡å¼æˆ‘ä»¬å…³æ³¨çš„æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•å®ç°ä¹ˆï¼Ÿæ˜¯ä¹Ÿä¸æ˜¯ã€‚æˆ‘è®¤ä¸ºæ¯”äº†è§£å¦‚ä½•å®ç°è®¾è®¡æ¨¡å¼æ›´é‡è¦çš„æ˜¯è¿™äº›è®¾è®¡æ¨¡å¼çš„åº”ç”¨åœºæ™¯ï¼Œä»€ä¹ˆåœºæ™¯ä¸‹æˆ‘ä»¬è¯¥ç”¨è¿™ç§è®¾è®¡æ¨¡å¼ï¼›ä»¥åŠè¿™äº›è®¾è®¡æ¨¡å¼æ‰€åŒ…å«çš„æ€æƒ³ï¼Œæœ€ç»ˆå¸®åŠ©æˆ‘ä»¬æŠŠä»£ç å†™â€œå¥½â€ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ»¡è¶³ä¸€ç³»åˆ—çš„è®¾è®¡åŸåˆ™ï¼š</p><ul><li>å•ä¸€èŒè´£</li><li>å¼€é—­åŸåˆ™</li><li>é‡Œå¼æ›¿æ¢</li><li>æ¥å£éš”ç¦»</li><li>ä¾èµ–å€’ç½®</li><li>KISS</li><li>DRYï¼šä¸è¦é‡å¤</li><li>é«˜å†…èšã€æ¾è€¦åˆ</li><li>è¿ªç±³ç‰¹æ³•åˆ™: ä¸è¦ä¾èµ–ç±»ï¼Œä¾èµ–æ¥å£</li><li><p>â€¦â€¦<br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1599038480370-ac7b0eef-eaf3-4f6b-bd53-0b464aa591da.png" alt=""><strong>å…·ä½“å®ç°å¯ä»¥æŸ¥çœ‹ä¹‹å‰æ›´æ–°çš„æ–‡ç« </strong></p></li><li><p><a href="https://lailin.xyz/post/singleton.html">å•ä¾‹æ¨¡å¼</a></p><ul><li>é¥¿æ±‰å¼</li><li>æ‡’æ±‰å¼</li></ul></li><li><a href="https://lailin.xyz/post/factory.html">å·¥å‚æ¨¡å¼</a><ul><li>ç®€å•å·¥å‚</li><li>å·¥å‚æ–¹æ³•</li><li>æŠ½è±¡å·¥å‚</li><li>DI å®¹å™¨</li></ul></li><li><a href="https://lailin.xyz/post/builder.html">å»ºé€ è€…æ¨¡å¼</a></li><li><a href="https://lailin.xyz/post/prototype.html">åŸå‹æ¨¡å¼</a></li></ul><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>åˆ›å»ºå‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼04-åŸå‹æ¨¡å¼</title>
    <link href="/post/prototype.html"/>
    <url>/post/prototype.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/200786">47 | åŸå‹æ¨¡å¼ï¼šå¦‚ä½•æœ€å¿«é€Ÿåœ° clone ä¸€ä¸ª HashMap æ•£åˆ—è¡¨ï¼Ÿ</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 04/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154244534-22c36924-2fcc-493b-82dd-386dc02dbcd1.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><ul><li>è¿™ä¸ªæ¨¡å¼åœ¨ Javaã€C++ è¿™ç§é¢å‘å¯¹è±¡çš„è¯­è¨€ä¸å¤ªå¸¸ç”¨ï¼Œä½†æ˜¯å¦‚æœå¤§å®¶ä½¿ç”¨è¿‡ javascript çš„è¯å°±ä¼šéå¸¸ç†Ÿæ‚‰äº†ï¼Œå› ä¸º js æœ¬èº«æ˜¯åŸºäºåŸå‹çš„é¢å‘å¯¹è±¡è¯­è¨€ï¼Œæ‰€ä»¥åŸå‹æ¨¡å¼åœ¨ js ä¸­åº”ç”¨éå¸¸å¹¿æ³›ã€‚</li><li>æ¥ä¸‹æ¥ä¼šæŒ‰ç…§ä¸€ä¸ªç±»ä¼¼è¯¾ç¨‹ä¸­çš„ä¾‹å­ä½¿ç”¨æ·±æ‹·è´å’Œæµ…æ‹·è´ç»“åˆçš„æ–¹å¼è¿›è¡Œå®ç°</li><li>éœ€æ±‚: å‡è®¾ç°åœ¨æ•°æ®åº“ä¸­æœ‰å¤§é‡æ•°æ®ï¼ŒåŒ…å«äº†å…³é”®è¯ï¼Œå…³é”®è¯è¢«æœç´¢çš„æ¬¡æ•°ç­‰ä¿¡æ¯ï¼Œæ¨¡å— A ä¸ºäº†ä¸šåŠ¡éœ€è¦<ul><li>ä¼šåœ¨å¯åŠ¨æ—¶åŠ è½½è¿™éƒ¨åˆ†æ•°æ®åˆ°å†…å­˜ä¸­</li><li>å¹¶ä¸”éœ€è¦å®šæ—¶æ›´æ–°é‡Œé¢çš„æ•°æ®</li><li>åŒæ—¶å±•ç¤ºç»™ç”¨æˆ·çš„æ•°æ®æ¯æ¬¡å¿…é¡»è¦æ˜¯ç›¸åŒç‰ˆæœ¬çš„æ•°æ®ï¼Œä¸èƒ½ä¸€éƒ¨åˆ†æ•°æ®æ¥è‡ªç‰ˆæœ¬ 1 ä¸€éƒ¨åˆ†æ¥è‡ªç‰ˆæœ¬ 2</li></ul></li></ul><h4 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> prototype<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;encoding/json&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// Keyword æœç´¢å…³é”®å­—</span><br><span class="hljs-keyword">type</span> Keyword <span class="hljs-keyword">struct</span> &#123;<br>word      <span class="hljs-keyword">string</span><br>visit     <span class="hljs-keyword">int</span><br>UpdatedAt *time.Time<br>&#125;<br><br><span class="hljs-comment">// Clone è¿™é‡Œä½¿ç”¨åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„æ–¹å¼æ·±æ‹·è´</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(k *Keyword)</span> <span class="hljs-title">Clone</span><span class="hljs-params">()</span> *<span class="hljs-title">Keyword</span></span> &#123;<br><span class="hljs-keyword">var</span> newKeyword Keyword<br>b, _ := json.Marshal(k)<br>json.Unmarshal(b, &amp;newKeyword)<br><span class="hljs-keyword">return</span> &amp;newKeyword<br>&#125;<br><br><span class="hljs-comment">// Keywords å…³é”®å­— map</span><br><span class="hljs-keyword">type</span> Keywords <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*Keyword<br><br><span class="hljs-comment">// Clone å¤åˆ¶ä¸€ä¸ªæ–°çš„ keywords</span><br><span class="hljs-comment">// updatedWords: éœ€è¦æ›´æ–°çš„å…³é”®è¯åˆ—è¡¨ï¼Œç”±äºä»æ•°æ®åº“ä¸­è·å–æ•°æ®å¸¸å¸¸æ˜¯æ•°ç»„çš„æ–¹å¼</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(words Keywords)</span> <span class="hljs-title">Clone</span><span class="hljs-params">(updatedWords []*Keyword)</span> <span class="hljs-title">Keywords</span></span> &#123;<br>newKeywords := Keywords&#123;&#125;<br><br><span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> words &#123;<br><span class="hljs-comment">// è¿™é‡Œæ˜¯æµ…æ‹·è´ï¼Œç›´æ¥æ‹·è´äº†åœ°å€</span><br>newKeywords[k] = v<br>&#125;<br><br><span class="hljs-comment">// æ›¿æ¢æ‰éœ€è¦æ›´æ–°çš„å­—æ®µï¼Œè¿™é‡Œç”¨çš„æ˜¯æ·±æ‹·è´</span><br><span class="hljs-keyword">for</span> _, word := <span class="hljs-keyword">range</span> updatedWords &#123;<br>newKeywords[word.word] = word.Clone()<br>&#125;<br><br><span class="hljs-keyword">return</span> newKeywords<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> prototype<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestKeywords_Clone</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>updateAt, _ := time.Parse(<span class="hljs-string">&quot;2006&quot;</span>, <span class="hljs-string">&quot;2020&quot;</span>)<br>words := Keywords&#123;<br><span class="hljs-string">&quot;testA&quot;</span>: &amp;Keyword&#123;<br>word:      <span class="hljs-string">&quot;testA&quot;</span>,<br>visit:     <span class="hljs-number">1</span>,<br>UpdatedAt: &amp;updateAt,<br>&#125;,<br><span class="hljs-string">&quot;testB&quot;</span>: &amp;Keyword&#123;<br>word:      <span class="hljs-string">&quot;testB&quot;</span>,<br>visit:     <span class="hljs-number">2</span>,<br>UpdatedAt: &amp;updateAt,<br>&#125;,<br><span class="hljs-string">&quot;testC&quot;</span>: &amp;Keyword&#123;<br>word:      <span class="hljs-string">&quot;testC&quot;</span>,<br>visit:     <span class="hljs-number">3</span>,<br>UpdatedAt: &amp;updateAt,<br>&#125;,<br>&#125;<br><br>now := time.Now()<br>updatedWords := []*Keyword&#123;<br>&#123;<br>word:      <span class="hljs-string">&quot;testB&quot;</span>,<br>visit:     <span class="hljs-number">10</span>,<br>UpdatedAt: &amp;now,<br>&#125;,<br>&#125;<br><br>got := words.Clone(updatedWords)<br><br>assert.Equal(t, words[<span class="hljs-string">&quot;testA&quot;</span>], got[<span class="hljs-string">&quot;testA&quot;</span>])<br>assert.NotEqual(t, words[<span class="hljs-string">&quot;testB&quot;</span>], got[<span class="hljs-string">&quot;testB&quot;</span>])<br>assert.NotEqual(t, updatedWords[<span class="hljs-number">0</span>], got[<span class="hljs-string">&quot;testB&quot;</span>])<br>assert.Equal(t, words[<span class="hljs-string">&quot;testC&quot;</span>], got[<span class="hljs-string">&quot;testC&quot;</span>])<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>åˆ›å»ºå‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼03-å»ºé€ è€…æ¨¡å¼</title>
    <link href="/post/builder.html"/>
    <url>/post/builder.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å«å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/199674">46 | å»ºé€ è€…æ¨¡å¼ï¼šè¯¦è§£æ„é€ å‡½æ•°ã€set æ–¹æ³•ã€å»ºé€ è€…æ¨¡å¼ä¸‰ç§å¯¹è±¡åˆ›å»ºæ–¹å¼</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 03/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>å…³æ³¨æˆ‘ï¼Œè·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a>**</li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154226181-c4b56fbc-6a50-4c21-9d50-d9ce1c999a49.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>å…¶å®åœ¨ Golang ä¸­å¯¹äºåˆ›å»ºç±»å‚æ•°æ¯”è¾ƒå¤šçš„å¯¹è±¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸¸è§çš„åšæ³•æ˜¯å¿…å¡«å‚æ•°ç›´æ¥ä¼ é€’ï¼Œå¯é€‰å‚æ•°é€šè¿‡ä¼ é€’å¯å˜çš„æ–¹æ³•è¿›è¡Œåˆ›å»ºã€‚<br>æœ¬æ–‡ä¼šå…ˆå®ç°è¯¾ç¨‹ä¸­çš„å»ºé€ è€…æ¨¡å¼ï¼Œç„¶åå†å®ç°æˆ‘ä»¬å¸¸ç”¨çš„æ–¹å¼ã€‚</p><h3 id="å»ºé€ è€…æ¨¡å¼"><a href="#å»ºé€ è€…æ¨¡å¼" class="headerlink" title="å»ºé€ è€…æ¨¡å¼"></a>å»ºé€ è€…æ¨¡å¼</h3><h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><p>é€šè¿‡ä¸‹é¢å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ Go ç¼–å†™å»ºé€ è€…æ¨¡å¼çš„ä»£ç å…¶å®ä¼šå¾ˆé•¿ï¼Œè¿™äº›æ˜¯å®ƒçš„ä¸€ä¸ªç¼ºç‚¹ï¼Œæ‰€ä»¥å¦‚æœä¸æ˜¯å‚æ•°çš„æ ¡éªŒé€»è¾‘å¾ˆå¤æ‚çš„æƒ…å†µä¸‹ä¸€èˆ¬æˆ‘ä»¬åœ¨ Go ä¸­ä¸ä¼šé‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œè€Œä¼šé‡‡ç”¨åé¢çš„å¦å¤–ä¸€ç§æ–¹å¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> builder<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">const</span> (<br>defaultMaxTotal = <span class="hljs-number">10</span><br>defaultMaxIdle  = <span class="hljs-number">9</span><br>defaultMinIdle  = <span class="hljs-number">1</span><br>)<br><br><span class="hljs-comment">// ResourcePoolConfig resource pool</span><br><span class="hljs-keyword">type</span> ResourcePoolConfig <span class="hljs-keyword">struct</span> &#123;<br>name     <span class="hljs-keyword">string</span><br>maxTotal <span class="hljs-keyword">int</span><br>maxIdle  <span class="hljs-keyword">int</span><br>minIdle  <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-comment">// ResourcePoolConfigBuilder ç”¨äºæ„å»º ResourcePoolConfig</span><br><span class="hljs-keyword">type</span> ResourcePoolConfigBuilder <span class="hljs-keyword">struct</span> &#123;<br>name     <span class="hljs-keyword">string</span><br>maxTotal <span class="hljs-keyword">int</span><br>maxIdle  <span class="hljs-keyword">int</span><br>minIdle  <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-comment">// SetName SetName</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *ResourcePoolConfigBuilder)</span> <span class="hljs-title">SetName</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">if</span> name == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;name can not be empty&quot;</span>)<br>&#125;<br>b.name = name<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// SetMinIdle SetMinIdle</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *ResourcePoolConfigBuilder)</span> <span class="hljs-title">SetMinIdle</span><span class="hljs-params">(minIdle <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">if</span> minIdle &lt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;max tatal cannot &lt; 0, input: %d&quot;</span>, minIdle)<br>&#125;<br>b.minIdle = minIdle<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// SetMaxIdle SetMaxIdle</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *ResourcePoolConfigBuilder)</span> <span class="hljs-title">SetMaxIdle</span><span class="hljs-params">(maxIdle <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">if</span> maxIdle &lt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;max tatal cannot &lt; 0, input: %d&quot;</span>, maxIdle)<br>&#125;<br>b.maxIdle = maxIdle<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// SetMaxTotal SetMaxTotal</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *ResourcePoolConfigBuilder)</span> <span class="hljs-title">SetMaxTotal</span><span class="hljs-params">(maxTotal <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">if</span> maxTotal &lt;= <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;max tatal cannot &lt;= 0, input: %d&quot;</span>, maxTotal)<br>&#125;<br>b.maxTotal = maxTotal<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// Build Build</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *ResourcePoolConfigBuilder)</span> <span class="hljs-title">Build</span><span class="hljs-params">()</span> <span class="hljs-params">(*ResourcePoolConfig, error)</span></span> &#123;<br><span class="hljs-keyword">if</span> b.name == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;name can not be empty&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// è®¾ç½®é»˜è®¤å€¼</span><br><span class="hljs-keyword">if</span> b.minIdle == <span class="hljs-number">0</span> &#123;<br>b.minIdle = defaultMinIdle<br>&#125;<br><br><span class="hljs-keyword">if</span> b.maxIdle == <span class="hljs-number">0</span> &#123;<br>b.maxIdle = defaultMaxIdle<br>&#125;<br><br><span class="hljs-keyword">if</span> b.maxTotal == <span class="hljs-number">0</span> &#123;<br>b.maxTotal = defaultMaxTotal<br>&#125;<br><br><span class="hljs-keyword">if</span> b.maxTotal &lt; b.maxIdle &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;max total(%d) cannot &lt; max idle(%d)&quot;</span>, b.maxTotal, b.maxIdle)<br>&#125;<br><br><span class="hljs-keyword">if</span> b.minIdle &gt; b.maxIdle &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;max idle(%d) cannot &lt; min idle(%d)&quot;</span>, b.maxIdle, b.minIdle)<br>&#125;<br><br><span class="hljs-keyword">return</span> &amp;ResourcePoolConfig&#123;<br>name:     b.name,<br>maxTotal: b.maxTotal,<br>maxIdle:  b.maxIdle,<br>minIdle:  b.minIdle,<br>&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> builder<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br><span class="hljs-string">&quot;github.com/stretchr/testify/require&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestResourcePoolConfigBuilder_Build</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>tests := []<span class="hljs-keyword">struct</span> &#123;<br>name    <span class="hljs-keyword">string</span><br>builder *ResourcePoolConfigBuilder<br>want    *ResourcePoolConfig<br>wantErr <span class="hljs-keyword">bool</span><br>&#125;&#123;<br>&#123;<br>name: <span class="hljs-string">&quot;name empty&quot;</span>,<br>builder: &amp;ResourcePoolConfigBuilder&#123;<br>name:     <span class="hljs-string">&quot;&quot;</span>,<br>maxTotal: <span class="hljs-number">0</span>,<br>&#125;,<br>want:    <span class="hljs-literal">nil</span>,<br>wantErr: <span class="hljs-literal">true</span>,<br>&#125;,<br>&#123;<br>name: <span class="hljs-string">&quot;maxIdle &lt; minIdle&quot;</span>,<br>builder: &amp;ResourcePoolConfigBuilder&#123;<br>name:     <span class="hljs-string">&quot;test&quot;</span>,<br>maxTotal: <span class="hljs-number">0</span>,<br>maxIdle:  <span class="hljs-number">10</span>,<br>minIdle:  <span class="hljs-number">20</span>,<br>&#125;,<br>want:    <span class="hljs-literal">nil</span>,<br>wantErr: <span class="hljs-literal">true</span>,<br>&#125;,<br>&#123;<br>name: <span class="hljs-string">&quot;success&quot;</span>,<br>builder: &amp;ResourcePoolConfigBuilder&#123;<br>name: <span class="hljs-string">&quot;test&quot;</span>,<br>&#125;,<br>want: &amp;ResourcePoolConfig&#123;<br>name:     <span class="hljs-string">&quot;test&quot;</span>,<br>maxTotal: defaultMaxTotal,<br>maxIdle:  defaultMaxIdle,<br>minIdle:  defaultMinIdle,<br>&#125;,<br>wantErr: <span class="hljs-literal">false</span>,<br>&#125;,<br>&#125;<br><span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;<br>t.Run(tt.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>got, err := tt.builder.Build()<br>require.Equalf(t, tt.wantErr, err != <span class="hljs-literal">nil</span>, <span class="hljs-string">&quot;Build() error = %v, wantErr %v&quot;</span>, err, tt.wantErr)<br>assert.Equal(t, tt.want, got)<br>&#125;)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Go-å¸¸ç”¨çš„å‚æ•°ä¼ é€’æ–¹æ³•"><a href="#Go-å¸¸ç”¨çš„å‚æ•°ä¼ é€’æ–¹æ³•" class="headerlink" title="Go å¸¸ç”¨çš„å‚æ•°ä¼ é€’æ–¹æ³•"></a>Go å¸¸ç”¨çš„å‚æ•°ä¼ é€’æ–¹æ³•</h3><h4 id="ä»£ç -1"><a href="#ä»£ç -1" class="headerlink" title="ä»£ç "></a>ä»£ç </h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> builder<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-comment">// ResourcePoolConfigOption option</span><br><span class="hljs-keyword">type</span> ResourcePoolConfigOption <span class="hljs-keyword">struct</span> &#123;<br>maxTotal <span class="hljs-keyword">int</span><br>maxIdle  <span class="hljs-keyword">int</span><br>minIdle  <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-comment">// ResourcePoolConfigOptFunc to set option</span><br><span class="hljs-keyword">type</span> ResourcePoolConfigOptFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(option *ResourcePoolConfigOption)</span></span><br><br><span class="hljs-comment">// NewResourcePoolConfig NewResourcePoolConfig</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewResourcePoolConfig</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>, opts ...ResourcePoolConfigOptFunc)</span> <span class="hljs-params">(*ResourcePoolConfig, error)</span></span> &#123;<br><span class="hljs-keyword">if</span> name == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;name can not be empty&quot;</span>)<br>&#125;<br><br>option := &amp;ResourcePoolConfigOption&#123;<br>maxTotal: <span class="hljs-number">10</span>,<br>maxIdle:  <span class="hljs-number">9</span>,<br>minIdle:  <span class="hljs-number">1</span>,<br>&#125;<br><br><span class="hljs-keyword">for</span> _, opt := <span class="hljs-keyword">range</span> opts &#123;<br>opt(option)<br>&#125;<br><br><span class="hljs-keyword">if</span> option.maxTotal &lt; <span class="hljs-number">0</span> || option.maxIdle &lt; <span class="hljs-number">0</span> || option.minIdle &lt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;args err, option: %v&quot;</span>, option)<br>&#125;<br><br><span class="hljs-keyword">if</span> option.maxTotal &lt; option.maxIdle || option.minIdle &gt; option.maxIdle &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;args err, option: %v&quot;</span>, option)<br>&#125;<br><br><span class="hljs-keyword">return</span> &amp;ResourcePoolConfig&#123;<br>name:     name,<br>maxTotal: option.maxTotal,<br>maxIdle:  option.maxIdle,<br>minIdle:  option.minIdle,<br>&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å•å…ƒæµ‹è¯•-1"><a href="#å•å…ƒæµ‹è¯•-1" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> builder<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br><span class="hljs-string">&quot;github.com/stretchr/testify/require&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestNewResourcePoolConfig</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">type</span> args <span class="hljs-keyword">struct</span> &#123;<br>name <span class="hljs-keyword">string</span><br>opts []ResourcePoolConfigOptFunc<br>&#125;<br>tests := []<span class="hljs-keyword">struct</span> &#123;<br>name    <span class="hljs-keyword">string</span><br>args    args<br>want    *ResourcePoolConfig<br>wantErr <span class="hljs-keyword">bool</span><br>&#125;&#123;<br>&#123;<br>name: <span class="hljs-string">&quot;name empty&quot;</span>,<br>args: args&#123;<br>name: <span class="hljs-string">&quot;&quot;</span>,<br>&#125;,<br>want:    <span class="hljs-literal">nil</span>,<br>wantErr: <span class="hljs-literal">true</span>,<br>&#125;,<br>&#123;<br>name: <span class="hljs-string">&quot;success&quot;</span>,<br>args: args&#123;<br>name: <span class="hljs-string">&quot;test&quot;</span>,<br>opts: []ResourcePoolConfigOptFunc&#123;<br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(option *ResourcePoolConfigOption)</span></span> &#123;<br>option.minIdle = <span class="hljs-number">2</span><br>&#125;,<br>&#125;,<br>&#125;,<br>want: &amp;ResourcePoolConfig&#123;<br>name:     <span class="hljs-string">&quot;test&quot;</span>,<br>maxTotal: <span class="hljs-number">10</span>,<br>maxIdle:  <span class="hljs-number">9</span>,<br>minIdle:  <span class="hljs-number">2</span>,<br>&#125;,<br>wantErr: <span class="hljs-literal">false</span>,<br>&#125;,<br>&#125;<br><span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;<br>t.Run(tt.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>got, err := NewResourcePoolConfig(tt.args.name, tt.args.opts...)<br>require.Equalf(t, tt.wantErr, err != <span class="hljs-literal">nil</span>, <span class="hljs-string">&quot;error = %v, wantErr %v&quot;</span>, err, tt.wantErr)<br>assert.Equal(t, tt.want, got)<br>&#125;)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å…¶å®å¯ä»¥çœ‹åˆ°ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹ç›´æ¥ä½¿ç”¨åé¢çš„è¿™ç§æ–¹å¼å°±å¯ä»¥äº†ï¼Œå¹¶ä¸”åœ¨ç¼–å†™å…¬å…±åº“çš„æ—¶å€™ï¼Œ<strong>å¼ºçƒˆå»ºè®®</strong>å…¥å£çš„å‚æ•°éƒ½å¯ä»¥è¿™ä¹ˆä¼ é€’ï¼Œè¿™æ ·å¯ä»¥æœ€å¤§ç¨‹åº¦çš„ä¿è¯æˆ‘ä»¬å…¬å…±åº“çš„å…¼å®¹æ€§ï¼Œé¿å…åœ¨åç»­çš„æ›´æ–°çš„æ—¶å€™å‡ºç°ç ´åæ€§çš„æ›´æ–°çš„æƒ…å†µã€‚</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>åˆ›å»ºå‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼02-å·¥å‚æ¨¡å¼&amp;DIå®¹å™¨</title>
    <link href="/post/factory.html"/>
    <url>/post/factory.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>æ³¨æ„ï¼šè¿™ç¯‡æ–‡ç« ä»£ç æ¯”è¾ƒå¤šï¼ŒåŒ…å«äº† ç®€å•å·¥å‚ã€å·¥å‚æ–¹æ³•ã€æŠ½è±¡å·¥å‚ã€DI å®¹å™¨çš„å®ç°ï¼Œç”±äºå†…å®¹å…·æœ‰å…³è”æ€§å°±ä¸è¿›è¡Œæ‹†åˆ†äº†</li><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å« 23 ç§å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/197254">44 | å·¥å‚æ¨¡å¼ï¼ˆä¸Šï¼‰ï¼šæˆ‘ä¸ºä»€ä¹ˆè¯´æ²¡äº‹ä¸è¦éšä¾¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºå¯¹è±¡ï¼Ÿ</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 02/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a><br><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154206593-589dd3c8-561e-4c96-9268-490b1a5221da.jpeg" alt=""></li></ul><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><h3 id="ç®€å•å·¥å‚"><a href="#ç®€å•å·¥å‚" class="headerlink" title="ç®€å•å·¥å‚"></a>ç®€å•å·¥å‚</h3><p>ç”±äº Go æœ¬èº«æ˜¯æ²¡æœ‰æ„é€ å‡½æ•°çš„ï¼Œä¸€èˆ¬è€Œè¨€æˆ‘ä»¬é‡‡ç”¨ <code>NewName</code>  çš„æ–¹å¼åˆ›å»ºå¯¹è±¡/æ¥å£ï¼Œå½“å®ƒè¿”å›çš„æ˜¯æ¥å£çš„æ—¶å€™ï¼Œå…¶å®å°±æ˜¯ç®€å•å·¥å‚æ¨¡å¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> factory<br><br><span class="hljs-comment">// IRuleConfigParser IRuleConfigParser</span><br><span class="hljs-keyword">type</span> IRuleConfigParser <span class="hljs-keyword">interface</span> &#123;<br>Parse(data []<span class="hljs-keyword">byte</span>)<br>&#125;<br><br><span class="hljs-comment">// jsonRuleConfigParser jsonRuleConfigParser</span><br><span class="hljs-keyword">type</span> jsonRuleConfigParser <span class="hljs-keyword">struct</span> &#123;<br>&#125;<br><br><span class="hljs-comment">// Parse Parse</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(J jsonRuleConfigParser)</span> <span class="hljs-title">Parse</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span></span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;implement me&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// yamlRuleConfigParser yamlRuleConfigParser</span><br><span class="hljs-keyword">type</span> yamlRuleConfigParser <span class="hljs-keyword">struct</span> &#123;<br>&#125;<br><br><span class="hljs-comment">// Parse Parse</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(Y yamlRuleConfigParser)</span> <span class="hljs-title">Parse</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span></span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;implement me&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// NewIRuleConfigParser NewIRuleConfigParser</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewIRuleConfigParser</span><span class="hljs-params">(t <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">IRuleConfigParser</span></span> &#123;<br><span class="hljs-keyword">switch</span> t &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;json&quot;</span>:<br><span class="hljs-keyword">return</span> jsonRuleConfigParser&#123;&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;yaml&quot;</span>:<br><span class="hljs-keyword">return</span> yamlRuleConfigParser&#123;&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> factory<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;reflect&quot;</span><br><span class="hljs-string">&quot;testing&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestNewIRuleConfigParser</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">type</span> args <span class="hljs-keyword">struct</span> &#123;<br>t <span class="hljs-keyword">string</span><br>&#125;<br>tests := []<span class="hljs-keyword">struct</span> &#123;<br>name <span class="hljs-keyword">string</span><br>args args<br>want IRuleConfigParser<br>&#125;&#123;<br>&#123;<br>name: <span class="hljs-string">&quot;json&quot;</span>,<br>args: args&#123;t: <span class="hljs-string">&quot;json&quot;</span>&#125;,<br>want: jsonRuleConfigParser&#123;&#125;,<br>&#125;,<br>&#123;<br>name: <span class="hljs-string">&quot;yaml&quot;</span>,<br>args: args&#123;t: <span class="hljs-string">&quot;yaml&quot;</span>&#125;,<br>want: yamlRuleConfigParser&#123;&#125;,<br>&#125;,<br>&#125;<br><span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;<br>t.Run(tt.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">if</span> got := NewIRuleConfigParser(tt.args.t); !reflect.DeepEqual(got, tt.want) &#123;<br>t.Errorf(<span class="hljs-string">&quot;NewIRuleConfigParser() = %v, want %v&quot;</span>, got, tt.want)<br>&#125;<br>&#125;)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å·¥å‚æ–¹æ³•"><a href="#å·¥å‚æ–¹æ³•" class="headerlink" title="å·¥å‚æ–¹æ³•"></a>å·¥å‚æ–¹æ³•</h3><p>å½“å¯¹è±¡çš„åˆ›å»ºé€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œä¸åªæ˜¯ç®€å•çš„ new ä¸€ä¸‹å°±å¯ä»¥ï¼Œè€Œæ˜¯è¦ç»„åˆå…¶ä»–ç±»å¯¹è±¡ï¼Œåšå„ç§åˆå§‹åŒ–æ“ä½œçš„æ—¶å€™ï¼Œæ¨èä½¿ç”¨å·¥å‚æ–¹æ³•æ¨¡å¼ï¼Œå°†å¤æ‚çš„åˆ›å»ºé€»è¾‘æ‹†åˆ†åˆ°å¤šä¸ªå·¥å‚ç±»ä¸­ï¼Œè®©æ¯ä¸ªå·¥å‚ç±»éƒ½ä¸è‡³äºè¿‡äºå¤æ‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// IRuleConfigParserFactory å·¥å‚æ–¹æ³•æ¥å£</span><br><span class="hljs-keyword">type</span> IRuleConfigParserFactory <span class="hljs-keyword">interface</span> &#123;<br>CreateParser() IRuleConfigParser<br>&#125;<br><br><span class="hljs-comment">// yamlRuleConfigParserFactory yamlRuleConfigParser çš„å·¥å‚ç±»</span><br><span class="hljs-keyword">type</span> yamlRuleConfigParserFactory <span class="hljs-keyword">struct</span> &#123;<br>&#125;<br><br><span class="hljs-comment">// CreateParser CreateParser</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(y yamlRuleConfigParserFactory)</span> <span class="hljs-title">CreateParser</span><span class="hljs-params">()</span> <span class="hljs-title">IRuleConfigParser</span></span> &#123;<br><span class="hljs-keyword">return</span> yamlRuleConfigParser&#123;&#125;<br>&#125;<br><br><span class="hljs-comment">// jsonRuleConfigParserFactory jsonRuleConfigParser çš„å·¥å‚ç±»</span><br><span class="hljs-keyword">type</span> jsonRuleConfigParserFactory <span class="hljs-keyword">struct</span> &#123;<br>&#125;<br><br><span class="hljs-comment">// CreateParser CreateParser</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(j jsonRuleConfigParserFactory)</span> <span class="hljs-title">CreateParser</span><span class="hljs-params">()</span> <span class="hljs-title">IRuleConfigParser</span></span> &#123;<br><span class="hljs-keyword">return</span> jsonRuleConfigParser&#123;&#125;<br>&#125;<br><br><span class="hljs-comment">// NewIRuleConfigParserFactory ç”¨ä¸€ä¸ªç®€å•å·¥å‚å°è£…å·¥å‚æ–¹æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewIRuleConfigParserFactory</span><span class="hljs-params">(t <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">IRuleConfigParserFactory</span></span> &#123;<br><span class="hljs-keyword">switch</span> t &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;json&quot;</span>:<br><span class="hljs-keyword">return</span> jsonRuleConfigParserFactory&#123;&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;yaml&quot;</span>:<br><span class="hljs-keyword">return</span> yamlRuleConfigParserFactory&#123;&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å•å…ƒæµ‹è¯•-1"><a href="#å•å…ƒæµ‹è¯•-1" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> factory<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;reflect&quot;</span><br><span class="hljs-string">&quot;testing&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestNewIRuleConfigParserFactory</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">type</span> args <span class="hljs-keyword">struct</span> &#123;<br>t <span class="hljs-keyword">string</span><br>&#125;<br>tests := []<span class="hljs-keyword">struct</span> &#123;<br>name <span class="hljs-keyword">string</span><br>args args<br>want IRuleConfigParserFactory<br>&#125;&#123;<br>&#123;<br>name: <span class="hljs-string">&quot;json&quot;</span>,<br>args: args&#123;t: <span class="hljs-string">&quot;json&quot;</span>&#125;,<br>want: jsonRuleConfigParserFactory&#123;&#125;,<br>&#125;,<br>&#123;<br>name: <span class="hljs-string">&quot;yaml&quot;</span>,<br>args: args&#123;t: <span class="hljs-string">&quot;yaml&quot;</span>&#125;,<br>want: yamlRuleConfigParserFactory&#123;&#125;,<br>&#125;,<br>&#125;<br><span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;<br>t.Run(tt.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br><span class="hljs-keyword">if</span> got := NewIRuleConfigParserFactory(tt.args.t); !reflect.DeepEqual(got, tt.want) &#123;<br>t.Errorf(<span class="hljs-string">&quot;NewIRuleConfigParserFactory() = %v, want %v&quot;</span>, got, tt.want)<br>&#125;<br>&#125;)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æŠ½è±¡å·¥å‚"><a href="#æŠ½è±¡å·¥å‚" class="headerlink" title="æŠ½è±¡å·¥å‚"></a>æŠ½è±¡å·¥å‚</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> factory<br><br><span class="hljs-comment">// IRuleConfigParser IRuleConfigParser</span><br><span class="hljs-keyword">type</span> IRuleConfigParser <span class="hljs-keyword">interface</span> &#123;<br>Parse(data []<span class="hljs-keyword">byte</span>)<br>&#125;<br><br><span class="hljs-comment">// jsonRuleConfigParser jsonRuleConfigParser</span><br><span class="hljs-keyword">type</span> jsonRuleConfigParser <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// Parse Parse</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(j jsonRuleConfigParser)</span> <span class="hljs-title">Parse</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span></span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;implement me&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// ISystemConfigParser ISystemConfigParser</span><br><span class="hljs-keyword">type</span> ISystemConfigParser <span class="hljs-keyword">interface</span> &#123;<br>ParseSystem(data []<span class="hljs-keyword">byte</span>)<br>&#125;<br><br><span class="hljs-comment">// jsonSystemConfigParser jsonSystemConfigParser</span><br><span class="hljs-keyword">type</span> jsonSystemConfigParser <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-comment">// Parse Parse</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(j jsonSystemConfigParser)</span> <span class="hljs-title">ParseSystem</span><span class="hljs-params">(data []<span class="hljs-keyword">byte</span>)</span></span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;implement me&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// IConfigParserFactory å·¥å‚æ–¹æ³•æ¥å£</span><br><span class="hljs-keyword">type</span> IConfigParserFactory <span class="hljs-keyword">interface</span> &#123;<br>CreateRuleParser() IRuleConfigParser<br>CreateSystemParser() ISystemConfigParser<br>&#125;<br><br><span class="hljs-keyword">type</span> jsonConfigParserFactory <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(j jsonConfigParserFactory)</span> <span class="hljs-title">CreateRuleParser</span><span class="hljs-params">()</span> <span class="hljs-title">IRuleConfigParser</span></span> &#123;<br><span class="hljs-keyword">return</span> jsonRuleConfigParser&#123;&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(j jsonConfigParserFactory)</span> <span class="hljs-title">CreateSystemParser</span><span class="hljs-params">()</span> <span class="hljs-title">ISystemConfigParser</span></span> &#123;<br><span class="hljs-keyword">return</span> jsonSystemConfigParser&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å•å…ƒæµ‹è¯•-2"><a href="#å•å…ƒæµ‹è¯•-2" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> factory<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;reflect&quot;</span><br><span class="hljs-string">&quot;testing&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Test_jsonConfigParserFactory_CreateRuleParser</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>tests := []<span class="hljs-keyword">struct</span> &#123;<br>name <span class="hljs-keyword">string</span><br>want IRuleConfigParser<br>&#125;&#123;<br>&#123;<br>name: <span class="hljs-string">&quot;json&quot;</span>,<br>want: jsonRuleConfigParser&#123;&#125;,<br>&#125;,<br>&#125;<br><span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;<br>t.Run(tt.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>j := jsonConfigParserFactory&#123;&#125;<br><span class="hljs-keyword">if</span> got := j.CreateRuleParser(); !reflect.DeepEqual(got, tt.want) &#123;<br>t.Errorf(<span class="hljs-string">&quot;CreateRuleParser() = %v, want %v&quot;</span>, got, tt.want)<br>&#125;<br>&#125;)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Test_jsonConfigParserFactory_CreateSystemParser</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>tests := []<span class="hljs-keyword">struct</span> &#123;<br>name <span class="hljs-keyword">string</span><br>want ISystemConfigParser<br>&#125;&#123;<br>&#123;<br>name: <span class="hljs-string">&quot;json&quot;</span>,<br>want: jsonSystemConfigParser&#123;&#125;,<br>&#125;,<br>&#125;<br><span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;<br>t.Run(tt.name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>j := jsonConfigParserFactory&#123;&#125;<br><span class="hljs-keyword">if</span> got := j.CreateSystemParser(); !reflect.DeepEqual(got, tt.want) &#123;<br>t.Errorf(<span class="hljs-string">&quot;CreateSystemParser() = %v, want %v&quot;</span>, got, tt.want)<br>&#125;<br>&#125;)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="DI-å®¹å™¨"><a href="#DI-å®¹å™¨" class="headerlink" title="DI å®¹å™¨"></a>DI å®¹å™¨</h3><p>golang ç°æœ‰çš„ä¾èµ–æ³¨å…¥æ¡†æ¶:</p><ul><li>ä½¿ç”¨åå°„å®ç°çš„: <a href="https://github.com/uber-go/dig">https://github.com/uber-go/dig</a></li><li>ä½¿ç”¨ generate å®ç°çš„: <a href="https://github.com/google/wire">https://github.com/google/wire</a></li></ul><p>ä¸‹æ–‡å°†é€šè¿‡åå°„å®ç°ä¸€ä¸ªç±»ä¼¼ dig ç®€å•çš„ demoï¼Œåœ¨è¯¾ç¨‹é‡Œé¢çš„ä¾‹å­æ˜¯è¯»å–é…ç½®æ–‡ä»¶ï¼Œç„¶åè¿›è¡Œç”Ÿæˆï¼Œä¸‹é¢æä¾›æ˜¯é€šè¿‡ provider è¿›è¡Œæ„å»ºä¾èµ–å…³ç³»ã€‚</p><h4 id="ä»£ç å®ç°-1"><a href="#ä»£ç å®ç°-1" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> di<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;reflect&quot;</span><br>)<br><br><span class="hljs-comment">// Container DI å®¹å™¨</span><br><span class="hljs-keyword">type</span> Container <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// å‡è®¾ä¸€ç§ç±»å‹åªèƒ½æœ‰ä¸€ä¸ª provider æä¾›</span><br>providers <span class="hljs-keyword">map</span>[reflect.Type]provider<br><br><span class="hljs-comment">// ç¼“å­˜ä»¥ç”Ÿæˆçš„å¯¹è±¡</span><br>results <span class="hljs-keyword">map</span>[reflect.Type]reflect.Value<br>&#125;<br><br><span class="hljs-keyword">type</span> provider <span class="hljs-keyword">struct</span> &#123;<br>value reflect.Value<br><br>params []reflect.Type<br>&#125;<br><br><span class="hljs-comment">// New åˆ›å»ºä¸€ä¸ªå®¹å™¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">()</span> *<span class="hljs-title">Container</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;Container&#123;<br>providers: <span class="hljs-keyword">map</span>[reflect.Type]provider&#123;&#125;,<br>results:   <span class="hljs-keyword">map</span>[reflect.Type]reflect.Value&#123;&#125;,<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// isError åˆ¤æ–­æ˜¯å¦æ˜¯ error ç±»å‹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isError</span><span class="hljs-params">(t reflect.Type)</span> <span class="hljs-title">bool</span></span> &#123;<br><span class="hljs-keyword">if</span> t.Kind() != reflect.Interface &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">return</span> t.Implements(reflect.TypeOf(reflect.TypeOf((*error)(<span class="hljs-literal">nil</span>)).Elem()))<br>&#125;<br><br><span class="hljs-comment">// Provide å¯¹è±¡æä¾›è€…ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªå¯¹è±¡çš„å·¥å‚æ–¹æ³•ï¼Œåç»­ä¼šç”¨äºå¯¹è±¡çš„åˆ›å»º</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Container)</span> <span class="hljs-title">Provide</span><span class="hljs-params">(constructor <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;<br>v := reflect.ValueOf(constructor)<br><br><span class="hljs-comment">// ä»…æ”¯æŒå‡½æ•° provider</span><br><span class="hljs-keyword">if</span> v.Kind() != reflect.Func &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;constructor must be a func&quot;</span>)<br>&#125;<br><br>vt := v.Type()<br><br><span class="hljs-comment">// è·å–å‚æ•°</span><br>params := <span class="hljs-built_in">make</span>([]reflect.Type, vt.NumIn())<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; vt.NumIn(); i++ &#123;<br>params[i] = vt.In(i)<br>&#125;<br><br><span class="hljs-comment">// è·å–è¿”å›å€¼</span><br>results := <span class="hljs-built_in">make</span>([]reflect.Type, vt.NumOut())<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; vt.NumOut(); i++ &#123;<br>results[i] = vt.Out(i)<br>&#125;<br><br>provider := provider&#123;<br>value:  v,<br>params: params,<br>&#125;<br><br><span class="hljs-comment">// ä¿å­˜ä¸åŒç±»å‹çš„ provider</span><br><span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results &#123;<br><span class="hljs-comment">// åˆ¤æ–­è¿”å›å€¼æ˜¯ä¸æ˜¯ error</span><br><span class="hljs-keyword">if</span> isError(result) &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br><span class="hljs-keyword">if</span> _, ok := c.providers[result]; ok &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;%s had a provider&quot;</span>, result)<br>&#125;<br><br>c.providers[result] = provider<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// Invoke å‡½æ•°æ‰§è¡Œå…¥å£</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Container)</span> <span class="hljs-title">Invoke</span><span class="hljs-params">(function <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;<br>v := reflect.ValueOf(function)<br><br><span class="hljs-comment">// ä»…æ”¯æŒå‡½æ•° provider</span><br><span class="hljs-keyword">if</span> v.Kind() != reflect.Func &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;constructor must be a func&quot;</span>)<br>&#125;<br><br>vt := v.Type()<br><br><span class="hljs-comment">// è·å–å‚æ•°</span><br><span class="hljs-keyword">var</span> err error<br>params := <span class="hljs-built_in">make</span>([]reflect.Value, vt.NumIn())<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; vt.NumIn(); i++ &#123;<br>params[i], err = c.buildParam(vt.In(i))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br>&#125;<br><br>v.Call(params)<br><br><span class="hljs-comment">// è·å– providers</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// buildParam æ„å»ºå‚æ•°</span><br><span class="hljs-comment">// 1. ä»å®¹å™¨ä¸­è·å– provider</span><br><span class="hljs-comment">// 2. é€’å½’è·å– provider çš„å‚æ•°å€¼</span><br><span class="hljs-comment">// 3. è·å–åˆ°å‚æ•°ä¹‹åæ‰§è¡Œå‡½æ•°</span><br><span class="hljs-comment">// 4. å°†ç»“æœç¼“å­˜å¹¶ä¸”è¿”å›ç»“æœ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Container)</span> <span class="hljs-title">buildParam</span><span class="hljs-params">(param reflect.Type)</span> <span class="hljs-params">(val reflect.Value, err error)</span></span> &#123;<br><span class="hljs-keyword">if</span> result, ok := c.results[param]; ok &#123;<br><span class="hljs-keyword">return</span> result, <span class="hljs-literal">nil</span><br>&#125;<br><br>provider, ok := c.providers[param]<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span> reflect.Value&#123;&#125;, fmt.Errorf(<span class="hljs-string">&quot;can not found provider: %s&quot;</span>, param)<br>&#125;<br><br>params := <span class="hljs-built_in">make</span>([]reflect.Value, <span class="hljs-built_in">len</span>(provider.params))<br><span class="hljs-keyword">for</span> i, p := <span class="hljs-keyword">range</span> provider.params &#123;<br>params[i], err = c.buildParam(p)<br>&#125;<br><br>results := provider.value.Call(params)<br><span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results &#123;<br><span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æŠ¥é”™</span><br><span class="hljs-keyword">if</span> isError(result.Type()) &amp;&amp; !result.IsNil() &#123;<br><span class="hljs-keyword">return</span> reflect.Value&#123;&#125;, fmt.Errorf(<span class="hljs-string">&quot;%s call err: %+v&quot;</span>, provider, result)<br>&#125;<br><br><span class="hljs-keyword">if</span> !isError(result.Type()) &amp;&amp; !result.IsNil() &#123;<br>c.results[result.Type()] = result<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> c.results[param], <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿™é‡Œçš„å®ç°æ¯”è¾ƒç²—ç³™ï¼Œä½†æ˜¯ä½œä¸ºä¸€ä¸ª demo ç†è§£ di å®¹å™¨ä¹Ÿè¶³å¤Ÿäº†ï¼Œå’Œ dig ç›¸æ¯”è¿˜ç¼ºå°‘å¾ˆå¤šä¸œè¥¿ï¼Œå¹¶ä¸”æœ‰è®¸å¤šçš„é—®é¢˜ï¼Œä¾‹å¦‚ ä¾èµ–å…³ç³»ï¼Œä¸€ç§ç±»å‹å¦‚æœæœ‰å¤šä¸ª provider å¦‚ä½•å¤„ç†ç­‰ç­‰ç­‰ç­‰ã€‚<br>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ€»å…±å°±ä¸‰ä¸ªå‡½æ•°</p><ul><li>Provide: è·å–å¯¹è±¡å·¥å‚ï¼Œå¹¶ä¸”ä½¿ç”¨ä¸€ä¸ª map å°†å¯¹è±¡å·¥å‚ä¿å­˜</li><li>Invoke: æ‰§è¡Œå…¥å£</li><li>buildParam: æ ¸å¿ƒé€»è¾‘ï¼Œæ„å»ºå‚æ•°<ul><li>ä»å®¹å™¨ä¸­è·å– provider</li><li>é€’å½’è·å– provider çš„å‚æ•°å€¼</li><li>è·å–åˆ°å‚æ•°ä¹‹åæ‰§è¡Œå‡½æ•°</li><li>å°†ç»“æœç¼“å­˜å¹¶ä¸”è¿”å›ç»“æœ</li></ul></li></ul><h4 id="example"><a href="#example" class="headerlink" title="example"></a>example</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><br>di <span class="hljs-string">&quot;github.com/mohuishou/go-design-pattern/02_factory/024_di&quot;</span><br>)<br><br><span class="hljs-comment">// A ä¾èµ–å…³ç³» A -&gt; B -&gt; C</span><br><span class="hljs-keyword">type</span> A <span class="hljs-keyword">struct</span> &#123;<br>B *B<br>&#125;<br><br><span class="hljs-comment">// NewA NewA</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewA</span><span class="hljs-params">(b *B)</span> *<span class="hljs-title">A</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;A&#123;<br>B: b,<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// B B</span><br><span class="hljs-keyword">type</span> B <span class="hljs-keyword">struct</span> &#123;<br>C *C<br>&#125;<br><br><span class="hljs-comment">// NewB NewB</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewB</span><span class="hljs-params">(c *C)</span> *<span class="hljs-title">B</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;B&#123;C: c&#125;<br>&#125;<br><br><span class="hljs-comment">// C C</span><br><span class="hljs-keyword">type</span> C <span class="hljs-keyword">struct</span> &#123;<br>Num <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-comment">// NewC NewC</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewC</span><span class="hljs-params">()</span> *<span class="hljs-title">C</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;C&#123;<br>Num: <span class="hljs-number">1</span>,<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>container := di.New()<br><span class="hljs-keyword">if</span> err := container.Provide(NewA); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br><span class="hljs-keyword">if</span> err := container.Provide(NewB); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br><span class="hljs-keyword">if</span> err := container.Provide(NewC); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br><br>err := container.Invoke(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(a *A)</span></span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;%+v: %d&quot;</span>, a, a.B.C.Num)<br>&#125;)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>åˆ›å»ºå‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¬”è®°-è®©ä½ æœ€å¿«é€Ÿåœ°æ”¹å–„ä»£ç è´¨é‡çš„20æ¡ç¼–ç¨‹è§„èŒƒ</title>
    <link href="/post/fe1ma9.html"/>
    <url>/post/fe1ma9.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å« 23 ç§å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/188622">31 | ç†è®ºäº”ï¼šè®©ä½ æœ€å¿«é€Ÿåœ°æ”¹å–„ä»£ç è´¨é‡çš„ 20 æ¡ç¼–ç¨‹è§„èŒƒï¼ˆä¸Šï¼‰</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li></ul><h3 id="å‘½å"><a href="#å‘½å" class="headerlink" title="å‘½å"></a>å‘½å</h3><ul><li>å‘½åçš„å…³é”®æ˜¯èƒ½<strong>å‡†ç¡®è¾¾æ„</strong>ã€‚å¯¹äºä¸åŒä½œç”¨åŸŸçš„å‘½åï¼Œæˆ‘ä»¬å¯ä»¥é€‚å½“åœ°é€‰æ‹©ä¸åŒçš„é•¿åº¦ã€‚</li><li>æˆ‘ä»¬<strong>å¯ä»¥å€ŸåŠ©ç±»çš„ä¿¡æ¯æ¥ç®€åŒ–å±æ€§ã€å‡½æ•°çš„å‘½åï¼Œåˆ©ç”¨å‡½æ•°çš„ä¿¡æ¯æ¥ç®€åŒ–å‡½æ•°å‚æ•°çš„å‘½å</strong>ã€‚</li><li><strong>å‘½åè¦å¯è¯»ã€å¯æœç´¢</strong>ã€‚ä¸è¦ä½¿ç”¨ç”Ÿåƒ»çš„ã€ä¸å¥½è¯»çš„è‹±æ–‡å•è¯æ¥å‘½åã€‚å‘½åè¦ç¬¦åˆé¡¹ç›®çš„ç»Ÿä¸€è§„èŒƒï¼Œä¹Ÿä¸è¦ç”¨äº›åç›´è§‰çš„å‘½åã€‚</li><li><strong>æ¥å£æœ‰ä¸¤ç§å‘½åæ–¹å¼ï¼šä¸€ç§æ˜¯åœ¨æ¥å£ä¸­å¸¦å‰ç¼€â€œIâ€ï¼›å¦ä¸€ç§æ˜¯åœ¨æ¥å£çš„å®ç°ç±»ä¸­å¸¦åç¼€â€œImplâ€</strong>ã€‚å¯¹äºæŠ½è±¡ç±»çš„å‘½åï¼Œä¹Ÿæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯å¸¦ä¸Šå‰ç¼€â€œAbstractâ€ï¼Œä¸€ç§æ˜¯ä¸å¸¦å‰ç¼€ã€‚è¿™ä¸¤ç§å‘½åæ–¹å¼éƒ½å¯ä»¥ï¼Œå…³é”®æ˜¯è¦åœ¨é¡¹ç›®ä¸­ç»Ÿä¸€ã€‚</li></ul><h3 id="æ³¨é‡Š"><a href="#æ³¨é‡Š" class="headerlink" title="æ³¨é‡Š"></a>æ³¨é‡Š</h3><ul><li><strong>æ³¨é‡Šçš„å†…å®¹ä¸»è¦åŒ…å«è¿™æ ·ä¸‰ä¸ªæ–¹é¢ï¼šåšä»€ä¹ˆã€ä¸ºä»€ä¹ˆã€æ€ä¹ˆåš</strong>ã€‚å¯¹äºä¸€äº›å¤æ‚çš„ç±»å’Œæ¥å£ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜éœ€è¦å†™æ˜â€œå¦‚ä½•ç”¨â€ã€‚</li><li><strong>ç±»å’Œå‡½æ•°ä¸€å®šè¦å†™æ³¨é‡Šï¼Œè€Œä¸”è¦å†™å¾—å°½å¯èƒ½å…¨é¢è¯¦ç»†</strong>ã€‚<strong>å‡½æ•°å†…éƒ¨çš„æ³¨é‡Šè¦ç›¸å¯¹å°‘ä¸€äº›</strong>ï¼Œä¸€èˆ¬éƒ½æ˜¯é å¥½çš„å‘½åã€æç‚¼å‡½æ•°ã€è§£é‡Šæ€§å˜é‡ã€æ€»ç»“æ€§æ³¨é‡Šæ¥æé«˜ä»£ç å¯è¯»æ€§ã€‚</li></ul><h3 id="ä»£ç é£æ ¼"><a href="#ä»£ç é£æ ¼" class="headerlink" title="ä»£ç é£æ ¼"></a>ä»£ç é£æ ¼</h3><ul><li>å‡½æ•°ã€ç±»å¤šå¤§æ‰åˆé€‚ï¼Ÿ<strong>å‡½æ•°çš„ä»£ç è¡Œæ•°ä¸è¦è¶…è¿‡ä¸€å±å¹•çš„å¤§å°ï¼Œæ¯”å¦‚ 50 è¡Œ</strong>ã€‚ç±»çš„å¤§å°é™åˆ¶æ¯”è¾ƒéš¾ç¡®å®šã€‚</li><li><strong>ä¸€è¡Œä»£ç å¤šé•¿æœ€åˆé€‚ï¼Ÿæœ€å¥½ä¸è¦è¶…è¿‡ IDE çš„æ˜¾ç¤ºå®½åº¦</strong>ã€‚å½“ç„¶ï¼Œä¹Ÿä¸èƒ½å¤ªå°ï¼Œå¦åˆ™ä¼šå¯¼è‡´å¾ˆå¤šç¨å¾®é•¿ç‚¹çš„è¯­å¥è¢«æŠ˜æˆä¸¤è¡Œï¼Œä¹Ÿä¼šå½±å“åˆ°ä»£ç çš„æ•´æ´ï¼Œä¸åˆ©äºé˜…è¯»ã€‚</li><li><strong>å–„ç”¨ç©ºè¡Œåˆ†å‰²å•å…ƒå—</strong>ã€‚å¯¹äºæ¯”è¾ƒé•¿çš„å‡½æ•°ï¼Œä¸ºäº†è®©é€»è¾‘æ›´åŠ æ¸…æ™°ï¼Œå¯ä»¥ä½¿ç”¨ç©ºè¡Œæ¥åˆ†å‰²å„ä¸ªä»£ç å—ã€‚</li><li>å››æ ¼ç¼©è¿›è¿˜æ˜¯ä¸¤æ ¼ç¼©è¿›ï¼Ÿæˆ‘ä¸ªäººæ¯”è¾ƒæ¨èä½¿ç”¨ä¸¤æ ¼ç¼©è¿›ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœç©ºé—´ï¼Œå°¤å…¶æ˜¯åœ¨ä»£ç åµŒå¥—å±‚æ¬¡æ¯”è¾ƒæ·±çš„æƒ…å†µä¸‹ã€‚ä¸ç®¡æ˜¯ç”¨ä¸¤æ ¼ç¼©è¿›è¿˜æ˜¯å››æ ¼ç¼©è¿›ï¼Œä¸€å®šä¸è¦ç”¨ tab é”®ç¼©è¿›ã€‚<em>(PS: Golang æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼Œé»˜è®¤ä½¿ç”¨ Tab ç¼©è¿›)</em></li><li>å¤§æ‹¬å·æ˜¯å¦è¦å¦èµ·ä¸€è¡Œï¼Ÿå°†å¤§æ‹¬å·æ”¾åˆ°è·Ÿä¸Šä¸€æ¡è¯­å¥åŒä¸€è¡Œï¼Œå¯ä»¥èŠ‚çœä»£ç è¡Œæ•°ã€‚ä½†æ˜¯å°†å¤§æ‹¬å·å¦èµ·æ–°çš„ä¸€è¡Œçš„æ–¹å¼ï¼Œå·¦å³æ‹¬å·å¯ä»¥å‚ç›´å¯¹é½ï¼Œå“ªäº›ä»£ç å±äºå“ªä¸€ä¸ªä»£ç å—ï¼Œæ›´åŠ ä¸€ç›®äº†ç„¶ã€‚<em>(PS: Golang æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼‰</em></li><li>ç±»ä¸­æˆå‘˜æ€ä¹ˆæ’åˆ—ï¼Ÿåœ¨ Google Java ç¼–ç¨‹è§„èŒƒä¸­ï¼Œ<strong>ä¾èµ–ç±»æŒ‰ç…§å­—æ¯åºä»å°åˆ°å¤§æ’åˆ—ã€‚ç±»ä¸­å…ˆå†™æˆå‘˜å˜é‡åå†™å‡½æ•°ã€‚æˆå‘˜å˜é‡ä¹‹é—´æˆ–å‡½æ•°ä¹‹é—´ï¼Œå…ˆå†™é™æ€æˆå‘˜å˜é‡æˆ–å‡½æ•°ï¼Œåå†™æ™®é€šå˜é‡æˆ–å‡½æ•°ï¼Œå¹¶ä¸”æŒ‰ç…§ä½œç”¨åŸŸå¤§å°ä¾æ¬¡æ’åˆ—</strong>ã€‚</li></ul><h3 id="ç¼–ç æŠ€å·§"><a href="#ç¼–ç æŠ€å·§" class="headerlink" title="ç¼–ç æŠ€å·§"></a>ç¼–ç æŠ€å·§</h3><ul><li><strong>å°†å¤æ‚çš„é€»è¾‘æç‚¼æ‹†åˆ†æˆå‡½æ•°å’Œç±»ã€‚</strong></li><li><strong>é€šè¿‡æ‹†åˆ†æˆå¤šä¸ªå‡½æ•°æˆ–å°†å‚æ•°å°è£…ä¸ºå¯¹è±¡çš„æ–¹å¼ï¼Œæ¥å¤„ç†å‚æ•°è¿‡å¤šçš„æƒ…å†µ</strong>ã€‚</li><li><strong>å‡½æ•°ä¸­ä¸è¦ä½¿ç”¨å‚æ•°æ¥åšä»£ç æ‰§è¡Œé€»è¾‘çš„æ§åˆ¶</strong>ã€‚</li><li><strong>å‡½æ•°è®¾è®¡è¦èŒè´£å•ä¸€</strong>ã€‚</li><li><strong>ç§»é™¤è¿‡æ·±çš„åµŒå¥—å±‚æ¬¡ï¼Œæ–¹æ³•åŒ…æ‹¬ï¼šå»æ‰å¤šä½™çš„ if æˆ– else è¯­å¥ï¼Œä½¿ç”¨ continueã€breakã€return å…³é”®å­—æå‰é€€å‡ºåµŒå¥—ï¼Œè°ƒæ•´æ‰§è¡Œé¡ºåºæ¥å‡å°‘åµŒå¥—ï¼Œå°†éƒ¨åˆ†åµŒå¥—é€»è¾‘æŠ½è±¡æˆå‡½æ•°</strong>ã€‚</li><li>ç”¨å­—é¢å¸¸é‡å–ä»£é­”æ³•æ•°ã€‚</li><li>ç”¨è§£é‡Šæ€§å˜é‡æ¥è§£é‡Šå¤æ‚è¡¨è¾¾å¼ï¼Œä»¥æ­¤æé«˜ä»£ç å¯è¯»æ€§ã€‚</li></ul><h3 id="ç»Ÿä¸€ç¼–ç è§„èŒƒ"><a href="#ç»Ÿä¸€ç¼–ç è§„èŒƒ" class="headerlink" title="ç»Ÿä¸€ç¼–ç è§„èŒƒ"></a>ç»Ÿä¸€ç¼–ç è§„èŒƒ</h3><ul><li>é™¤äº†è¿™ä¸‰èŠ‚è®²åˆ°çš„æ¯”è¾ƒç»†èŠ‚çš„çŸ¥è¯†ç‚¹ä¹‹å¤–ï¼Œæœ€åï¼Œ<strong>è¿˜æœ‰ä¸€æ¡éå¸¸é‡è¦çš„ï¼Œé‚£å°±æ˜¯ï¼Œé¡¹ç›®ã€å›¢é˜Ÿï¼Œç”šè‡³å…¬å¸ï¼Œä¸€å®šè¦åˆ¶å®šç»Ÿä¸€çš„ç¼–ç è§„èŒƒ</strong>ï¼Œå¹¶ä¸”é€šè¿‡ Code Review ç£ä¿ƒæ‰§è¡Œï¼Œè¿™å¯¹æé«˜ä»£ç è´¨é‡æœ‰ç«‹ç«¿è§å½±çš„æ•ˆæœã€‚</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»£ç è§„èŒƒå¾ˆå¤šæƒ…å†µä¸‹éƒ½æ˜¯è§ä»è§æ™ºçš„çœ‹æ³•ï¼Œæˆ‘è®¤ä¸ºæœ€ä¸»è¦çš„æ˜¯ç»Ÿä¸€ï¼Œä¸ªäººé£æ ¼è¦ç»Ÿä¸€ï¼Œå›¢é˜Ÿé£æ ¼ä¹Ÿéœ€è¦ç»Ÿä¸€ï¼Œç„¶åä¾é å·¥å…·è¿›è¡Œç®¡ç†ã€‚æˆ‘å¸¸ç”¨çš„ Golang ä»£ç é£æ ¼å·¥å…·ï¼š</p><ul><li>format: <a href="https://godoc.org/golang.org/x/tools/cmd/goimports">https://godoc.org/golang.org/x/tools/cmd/goimports</a></li><li>lint: <a href="https://github.com/golang/lint">https://github.com/golang/lint</a></li><li><strong>ci:</strong> <a href="https://golangci-lint.run/">https://golangci-lint.run/</a> è¿™ä¸ªæ”¯æŒå¤šä¸ªé™æ€æ‰«æå·¥å…·ï¼Œä¸Šé¢ä¸¤ç§ä¹Ÿæ˜¯æ”¯æŒçš„ï¼Œä¸åœ¨ ide ç›´æ¥ä½¿ç”¨çš„ä¸»è¦åŸå› æ˜¯ï¼Œæ’ä»¶å¼€å¯è¾ƒå¤šçš„æ—¶å€™ä¼šæ¯”è¾ƒæ…¢ï¼Œä¸å¤ªé€‚åˆéšæ—¶è¿è¡Œï¼Œä½†æ˜¯ ci ä¸Šæ˜¯éœ€è¦çš„</li></ul><h2 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h2><h3 id="golangci-lint-gitlab-ci-yml-é…ç½®"><a href="#golangci-lint-gitlab-ci-yml-é…ç½®" class="headerlink" title="golangci-lint .gitlab-ci.yml é…ç½®"></a>golangci-lint .gitlab-ci.yml é…ç½®</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">lint:</span><br>  <span class="hljs-attr">stage:</span> <span class="hljs-string">lint</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">$CI_REGISTRY/library/golangci-lint:v1.27-alpine</span><br>  <span class="hljs-attr">script:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">golangci-lint</span> <span class="hljs-string">run</span> <span class="hljs-string">./...</span><br>  <span class="hljs-attr">retry:</span><br>    <span class="hljs-attr">max:</span> <span class="hljs-number">1</span><br>    <span class="hljs-attr">when:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">runner_system_failure</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">stuck_or_timeout_failure</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">job_execution_timeout</span><br>  <span class="hljs-attr">tags:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">test</span><br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè®¾è®¡æ¨¡å¼01-å•ä¾‹æ¨¡å¼</title>
    <link href="/post/singleton.html"/>
    <url>/post/singleton.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><ul><li>Go è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒ…å« 23 ç§å¸¸è§çš„è®¾è®¡æ¨¡å¼å®ç°ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ <a href="https://time.geekbang.org/column/intro/250">æå®¢æ—¶é—´-è®¾è®¡æ¨¡å¼ä¹‹ç¾</a> çš„ç¬”è®°ï¼Œæºè¯¾ç¨‹é‡‡ç”¨ Java å®ç°ï¼Œæœ¬ç³»åˆ—ä¼šé‡‡ç”¨ Go å®ç°</li><li><strong>è¯¾ç¨‹:</strong> <a href="https://time.geekbang.org/column/article/194035">41 | å•ä¾‹æ¨¡å¼ï¼ˆä¸Šä¸ºä»€ä¹ˆè¯´æ”¯æŒæ‡’åŠ è½½çš„åŒé‡æ£€æµ‹ä¸æ¯”é¥¿æ±‰å¼æ›´ä¼˜ï¼Ÿ</a></li><li><strong>æœ¬æ–‡ä»£ç ä»“åº“: <a href="https://github.com/mohuishou/go-design-pattern">https://github.com/mohuishou/go-design-pattern</a> </strong>ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</li><li><strong>RoadMap: 01/22 </strong>æŒç»­æ›´æ–°ä¸­ï¼Œé¢„è®¡ä¸€å‘¨æ›´æ–° 2 ~ 3 ç§è®¾è®¡æ¨¡å¼ï¼Œé¢„è®¡åˆ° 202010 æœˆåº•å‰æ›´æ–°å®Œæˆ</li><li><strong>è·å–æ›´æ–°: </strong><a href="https://github.com/mohuishou/go-design-pattern"><strong>Github</strong></a><strong>ã€</strong><a href="https://zhuanlan.zhihu.com/mohuishou"><strong>çŸ¥ä¹</strong></a><strong>ã€</strong><a href="https://lailin.xyz/atom.xml"><strong>RSS</strong></a><strong>ã€</strong><a href="https://toutiao.io/subjects/387401?f=new"><strong>å¼€å‘è€…å¤´æ¡</strong></a></li></ul><h2 id="ç¬”è®°"><a href="#ç¬”è®°" class="headerlink" title="ç¬”è®°"></a>ç¬”è®°</h2><p><img src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/image/1612154194185-d6422000-58c5-493c-9008-a4dc52cd9251.jpeg" alt=""></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>å•ä¾‹æ¨¡å¼é‡‡ç”¨äº† é¥¿æ±‰å¼ å’Œ æ‡’æ±‰å¼ ä¸¤ç§å®ç°ï¼Œä¸ªäººå…¶å®æ›´å€¾å‘äºé¥¿æ±‰å¼çš„å®ç°ï¼Œç®€å•ï¼Œå¹¶ä¸”å¯ä»¥å°†é—®é¢˜åŠæ—©æš´éœ²ï¼Œæ‡’æ±‰å¼è™½ç„¶æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Œä½†æ˜¯è¿™åªæ˜¯æŠŠå†·å¯åŠ¨æ—¶é—´æ”¾åˆ°äº†ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰æœ¬è´¨ä¸Šè§£å†³é—®é¢˜ï¼Œå¹¶ä¸”ä¸ºäº†å®ç°æ‡’æ±‰å¼è¿˜ä¸å¯é¿å…çš„éœ€è¦åŠ é”ã€‚</p><h3 id="é¥¿æ±‰å¼"><a href="#é¥¿æ±‰å¼" class="headerlink" title="é¥¿æ±‰å¼"></a>é¥¿æ±‰å¼</h3><p><strong>ä»£ç å®ç°:</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> singleton<br><br><span class="hljs-comment">// Singleton é¥¿æ±‰å¼å•ä¾‹</span><br><span class="hljs-keyword">type</span> Singleton <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-keyword">var</span> singleton *Singleton<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>singleton = &amp;Singleton&#123;&#125;<br>&#125;<br><br><span class="hljs-comment">// GetInstance è·å–å®ä¾‹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetInstance</span><span class="hljs-params">()</span> *<span class="hljs-title">Singleton</span></span> &#123;<br><span class="hljs-keyword">return</span> singleton<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å•å…ƒæµ‹è¯•:</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> singleton_test<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br>singleton <span class="hljs-string">&quot;github.com/mohuishou/go-design-pattern/01_singleton&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestGetInstance</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>assert.Equal(t, singleton.GetInstance(), singleton.GetInstance())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkGetInstanceParallel</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br>b.RunParallel(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(pb *testing.PB)</span></span> &#123;<br><span class="hljs-keyword">for</span> pb.Next() &#123;<br><span class="hljs-keyword">if</span> singleton.GetInstance() != singleton.GetInstance() &#123;<br>b.Errorf(<span class="hljs-string">&quot;test fail&quot;</span>)<br>&#125;<br>&#125;<br>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ‡’æ±‰å¼ï¼ˆåŒé‡æ£€æµ‹ï¼‰"><a href="#æ‡’æ±‰å¼ï¼ˆåŒé‡æ£€æµ‹ï¼‰" class="headerlink" title="æ‡’æ±‰å¼ï¼ˆåŒé‡æ£€æµ‹ï¼‰"></a>æ‡’æ±‰å¼ï¼ˆåŒé‡æ£€æµ‹ï¼‰</h3><p><strong>ä»£ç å®ç°:</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> singleton<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;sync&quot;</span><br><br><span class="hljs-keyword">var</span> (<br>lazySingleton *Singleton<br>once          = &amp;sync.Once&#123;&#125;<br>)<br><br><span class="hljs-comment">// GetLazyInstance æ‡’æ±‰å¼</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetLazyInstance</span><span class="hljs-params">()</span> *<span class="hljs-title">Singleton</span></span> &#123;<br><span class="hljs-keyword">if</span> lazySingleton == <span class="hljs-literal">nil</span> &#123;<br>once.Do(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>lazySingleton = &amp;Singleton&#123;&#125;<br>&#125;)<br>&#125;<br><span class="hljs-keyword">return</span> lazySingleton<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å•å…ƒæµ‹è¯•:</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> singleton_test<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;testing&quot;</span><br><br>singleton <span class="hljs-string">&quot;github.com/mohuishou/go-design-pattern/01_singleton&quot;</span><br><br><span class="hljs-string">&quot;github.com/stretchr/testify/assert&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestGetLazyInstance</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>assert.Equal(t, singleton.GetLazyInstance(), singleton.GetLazyInstance())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkGetLazyInstanceParallel</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br>b.RunParallel(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(pb *testing.PB)</span></span> &#123;<br><span class="hljs-keyword">for</span> pb.Next() &#123;<br><span class="hljs-keyword">if</span> singleton.GetLazyInstance() != singleton.GetLazyInstance() &#123;<br>b.Errorf(<span class="hljs-string">&quot;test fail&quot;</span>)<br>&#125;<br>&#125;<br>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h3><blockquote><p>æ„Ÿè°¢ <a href="https://github.com/scuplus/blogComment/issues/231#issuecomment-706009469">@lixianyang</a> çš„æŒ‡æ­£</p></blockquote><p>å¯ä»¥çœ‹åˆ°ç›´æ¥ init è·å–çš„æ€§èƒ½è¦å¥½ä¸€äº›</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">â–¶ C:\Users\laili\sdk\go1.15\bin\go.exe <span class="hljs-built_in">test</span> -benchmem -bench=<span class="hljs-string">&quot;.&quot;</span> -v<br>=== RUN   TestGetLazyInstance<br>--- PASS: TestGetLazyInstance (0.00s)<br>=== RUN   TestGetInstance<br>--- PASS: TestGetInstance (0.00s)<br>goos: windows<br>goarch: amd64<br>pkg: github.com/mohuishou/go-design-pattern/01_singleton<br>BenchmarkGetLazyInstanceParallel<br>BenchmarkGetLazyInstanceParallel-4      535702941                2.24 ns/op           0 B/op<br>      0 allocs/op<br>BenchmarkGetInstanceParallel<br>BenchmarkGetInstanceParallel-4          1000000000               0.586 ns/op          0 B/op<br>      0 allocs/op<br>PASS<br>ok      github.com/mohuishou/go-design-pattern/01_singleton     3.161s<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>Goè®¾è®¡æ¨¡å¼</category>
      
      <category>åˆ›å»ºå‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸€ç‚¹æ‹™è§-å¦‚ä½•å†™å¥½ä¸€ä¸ªæŠ€æœ¯é¢„ç ”æŠ¥å‘Š?</title>
    <link href="/post/how-to-write-a-pre-research-report.html"/>
    <url>/post/how-to-write-a-pre-research-report.html</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åšäº†ä¸€äº›é¢„ç ”çš„å·¥ä½œï¼Œä¸»è¦æ˜¯ä¸€äº›æŠ€æœ¯è°ƒç ”ï¼ŒæŠ¥å‘Šå‘ˆç°çš„è¿‡ç¨‹å½“ä¸­æ”¶åˆ°äº†è®¸å¤šå»ºè®¾æ€§çš„å»ºè®®ï¼ŒåŒæ—¶åŒ…å«ä¸€ç‚¹è‡ªå·±çš„æ‹™è§ï¼Œå¦‚æœèƒ½ç»™ä½ å¸¦æ¥ä¸€äº›æ€è€ƒï¼Œé‚£æœ€å¥½ä¸è¿‡ã€‚</p><h2 id="æ˜ç¡®é¢å‘å¯¹è±¡"><a href="#æ˜ç¡®é¢å‘å¯¹è±¡" class="headerlink" title="æ˜ç¡®é¢å‘å¯¹è±¡"></a>æ˜ç¡®é¢å‘å¯¹è±¡</h2><p>ä¸€ç¯‡å¥½çš„æ–‡ç« ï¼Œä¸€ä»½å¥½çš„æŠ¥å‘Šä¸€å®šè¦è€ƒè™‘ä¸€ä¸‹çš„ä½ é¢å‘å¯¹è±¡ï¼Œå¦‚ä½•èƒ½å¤Ÿè®©ä»–å¯ä»¥éšç€ä½ çš„æ€è·¯å¿«é€Ÿç®€è¦çš„ç†è§£ä½ æƒ³è¦ä¼ è¾¾çš„å†…å®¹ã€‚é‚£ä¹ˆï¼ŒæŠ€æœ¯é¢„ç ”æŠ¥å‘Šä¸€èˆ¬æ˜¯ç»™è°çœ‹çš„å‘¢ï¼Ÿè¯·æ³¨æ„ï¼Œæˆ‘ä»¬è¿™é‡Œè¯´çš„æŠ¥å‘Šæ˜¯<strong>å†…éƒ¨çš„è°ƒç ”æŠ¥å‘Š</strong>ï¼Œè€Œä¸æ˜¯ä¾‹å¦‚ä¸€äº›ä¸“é—¨åšå’¨è¯¢çš„å…¬å¸ï¼Œæä¾›ç»™å¤–éƒ¨å…¬å¸è´­ä¹°ä½¿ç”¨ã€‚è¿™ç§æŠ¥å‘Šçš„é¢å‘å¯¹è±¡ä¸€èˆ¬è€Œè¨€æ˜¯ä½ çš„ä¸Šçº§ï¼Œæˆ–è€…æ˜¯ä¸Šä¸Šçº§ï¼Œæˆ–è€…æ˜¯æ›´é«˜å±‚çº§çš„é¢†å¯¼ã€‚<br>è¿™ä¸ªæ—¶å€™åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œä»–æ‡‚æŠ€æœ¯ï¼Œä½†æ˜¯å¯èƒ½ä¸äº†è§£ç»†èŠ‚ï¼Œéœ€è¦ä¸€äº›æ•°æ®å¸®åŠ©ä»–åšå†³ç­–ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯ä»–æ²¡æœ‰å¤ªå¤šçš„æŠ€æœ¯èƒŒæ™¯ï¼Œä¸æ˜¯ç‰¹åˆ«äº†è§£ã€‚</p><ul><li>å¦‚æœæ˜¯ä¸å¤ªäº†è§£æŠ€æœ¯çš„é¢†å¯¼ï¼Œè¦æ³¨æ„ä¸èƒ½ç”¨è¿‡å¤šçš„ä¸“ä¸šæœ¯è¯­ï¼Œåœ¨æŠ¥å‘Šé‡Œé¢å¯ä»¥é€‚å½“çš„æ·»åŠ ä¸€äº›è¯´æ˜ï¼Œç±»æ¯”è¾…åŠ©ç†è§£ï¼Œè¿™ä¸ªç¯‡å¹…éœ€è¦æ³¨æ„ï¼Œä¹Ÿä¸èƒ½è¿‡é•¿ã€‚</li><li>å¦‚æœæ˜¯æ¯”è¾ƒäº†è§£çš„ï¼Œå¯ä»¥æ›´å¤šçš„ä»æŠ€æœ¯æ–¹é¢è¿›è¡Œåˆ†æï¼Œå¯ä»¥æ·»åŠ ä¸€äº›æŠ€æœ¯æŒ‡æ ‡çš„å¯¹æ¯”ã€‚å¯¹äºæŠ€æœ¯é¢„ç ”è¿™ç§æƒ…å†µï¼Œä¸€èˆ¬è¿˜æ˜¯è¿™ç§æƒ…å†µå±…å¤šã€‚</li></ul><p>æ¥ä¸‹æ¥æˆ‘å°±ä¼šä»æŠ€æœ¯é¢„ç ”æŠ¥å‘Šçš„ä¸€ä¸ªæœ€åŸºç¡€çš„æ¨¡æ¿è¯´æ˜æ¯ä¸ªéƒ¨åˆ†éœ€è¦æœ‰å“ªäº›å†…å®¹ï¼Œè¿™ä¸ªä¸æ˜¯æ ‡å‡†ç­”æ¡ˆï¼Œè¿™æ˜¯æˆ‘è®¤ä¸ºçš„ä¸€ä¸ªæŠ¥å‘Šå½“ä¸­å¿…è¦çš„ä¸€äº›å…ƒç´ ã€‚</p><h2 id="é¢„ç ”æŠ¥å‘Šæ¨¡æ¿"><a href="#é¢„ç ”æŠ¥å‘Šæ¨¡æ¿" class="headerlink" title="é¢„ç ”æŠ¥å‘Šæ¨¡æ¿"></a>é¢„ç ”æŠ¥å‘Šæ¨¡æ¿</h2><h3 id="ç†æ¸…ç°çŠ¶"><a href="#ç†æ¸…ç°çŠ¶" class="headerlink" title="ç†æ¸…ç°çŠ¶"></a>ç†æ¸…ç°çŠ¶</h3><p>æŠ€æœ¯é¢„ç ”ä¸€èˆ¬æ˜¯ç”¨æ¥è§£å†³å½“ä¸‹æˆ‘ä»¬éœ€è¦è§£å†³çš„ä¸€äº›é—®é¢˜çš„ï¼Œå¯èƒ½è¿™äº›é—®é¢˜ç”¨å·²æœ‰çš„ç³»ç»Ÿæˆ–è€…æŠ€æœ¯æš‚æ—¶æ— æ³•è§£å†³ï¼Œæˆ–è€…æ˜¯è§£å†³æ–¹æ³•ä¸å¤Ÿä¼˜é›…ï¼Œä¸å¤Ÿç®€æ´ç­‰ç­‰ã€‚æ‰€ä»¥é¦–å…ˆæˆ‘ä»¬éœ€è¦çš„æ˜¯ä»ç°çŠ¶å‡ºå‘ï¼Œç†æ¸…éœ€æ±‚æ‰¾å‡†ç›®æ ‡ã€‚é—®é¢˜æ¥äº†æ€ä¹ˆæè¿°ç°çŠ¶å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­<em>ï¼ˆæ³¨æ„æœ¬æ–‡æ‰€æœ‰ç¤ºä¾‹æ•°æ®å‡æ¥æºäºè™šæ„ï¼‰</em>:</p><h4 id="ä¸€ä¸ªä¾‹å­"><a href="#ä¸€ä¸ªä¾‹å­" class="headerlink" title="ä¸€ä¸ªä¾‹å­:"></a>ä¸€ä¸ªä¾‹å­:</h4><ul><li><strong>åé¢æ•™æ: </strong>é›†ç¾¤å†…åº”ç”¨çš„èµ„æºè®¾ç½®ä¸åˆç†</li><li><strong>æ­£é¢æ•™æ: </strong>æœ€è¿‘ä¸€ä¸ªæœˆæŸåŒºåŸŸé›†ç¾¤èŠ‚ç‚¹ NotReady å‘Šè­¦æ¬¡æ•°è¶…è¿‡ 200 æ¬¡ï¼Œå¯¼è‡´ 30 å¤šä¸ªåº”ç”¨ POD æ¼‚ç§»ã€‚å…¶åŸå› æ˜¯ç”±äºåº”ç”¨è¶…é…æ¯”ä¾‹è¿‡é«˜ï¼Œé…ç½®ä¸åˆç†<ul><li>æ•°æ®è¯´è¯: æœ€è¿‘ä¸€ä¸ªæœˆæŸåŒºåŸŸé›†ç¾¤èŠ‚ç‚¹ NotReady å‘Šè­¦æ¬¡æ•°è¶…è¿‡ 200 æ¬¡</li><li>å½±å“èŒƒå›´: å¯¼è‡´ 30 å¤šä¸ªåº”ç”¨ POD æ¼‚ç§»</li><li>åŸå› : åº”ç”¨è¶…é…æ¯”ä¾‹è¿‡é«˜ï¼Œé…ç½®ä¸åˆç†</li></ul></li></ul><p>ä¸Šé¢è¿™ä¸ªç¤ºä¾‹æ˜¯ä¸€ä¸ªæœ€å¸¸è§çš„é”™è¯¯æ¡ˆä¾‹ï¼Œåœ¨ç°çŠ¶åˆ†æå½“ä¸­ï¼Œç»å¸¸<strong>å–œæ¬¢ç›´æ¥è¯´é—®é¢˜çš„åŸå› ï¼Œä¸è¯´è¿™ä¸ªé—®é¢˜å¯¼è‡´çš„ç°è±¡ï¼Œä»¥åŠå½±å“èŒƒå›´ã€‚</strong>æˆ‘ä»¬éœ€è¦æ˜ç™½æŸ¥çœ‹æˆ‘ä»¬è°ƒç ”æŠ¥å‘Šçš„è§‚çœ‹å¯¹è±¡æ˜¯è°ï¼Ÿå¾€å¾€æ˜¯æˆ‘ä»¬çš„ä¸Šçº§æˆ–è€…æ˜¯ä¸Šä¸Šçº§é¢†å¯¼ï¼Œä»–ä»¬ç®¡ç†çš„äº§å“æ¯”è¾ƒå¤šï¼Œä¸ä¸€å®šèƒ½å¤Ÿç†è§£åˆ°ååˆ†ç»†èŠ‚ã€‚æ‰€ä»¥æˆ‘ä»¬è¦<strong>ä»åœºæ™¯è§¦å‘ï¼Œé¦–å…ˆé™ä½æ²Ÿé€šæˆæœ¬ï¼Œç½—åˆ—å†å²æ•°æ®ï¼Œå¢å¼ºè¯´æœåŠ›çš„åŒæ—¶å¯ä»¥å¸®åŠ©ä»–ä»¬äº†è§£å½“å‰äº§å“çš„ç°çŠ¶ã€‚</strong></p><h4 id="å¦‚ä½•è¯´æ˜ç°çŠ¶"><a href="#å¦‚ä½•è¯´æ˜ç°çŠ¶" class="headerlink" title="å¦‚ä½•è¯´æ˜ç°çŠ¶?"></a>å¦‚ä½•è¯´æ˜ç°çŠ¶?</h4><ul><li>ä»å®é™…çš„åœºæ™¯å‡ºå‘ï¼Œç®€æ˜æ‰¼è¦çš„è¯´æ˜æ›¾ä»Šå‡ºç°è¿‡æˆ–è€…å½“å‰å­˜åœ¨ç€çš„é—®é¢˜</li><li>ç”¨æ•°æ®è¯´è¯ï¼Œç»Ÿè®¡å†å²æ•°æ®ï¼ŒåŒ…å«ä½†ä¸é™äºï¼Œå½±å“èŒƒå›´ï¼Œå‡ºç°çš„æ¬¡æ•°ï¼Œåé¦ˆç”¨æˆ·äººæ¬¡ç­‰ç­‰</li></ul><h3 id="ç•…æƒ³æœªæ¥"><a href="#ç•…æƒ³æœªæ¥" class="headerlink" title="ç•…æƒ³æœªæ¥"></a>ç•…æƒ³æœªæ¥</h3><p>äº†è§£äº†ç°çŠ¶ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªå¿ƒç†é¢„æœŸçš„ç»“æœï¼Œæˆ‘ä»¬æœŸæœ›ç†æƒ³çŠ¶æ€ä¸‹ï¼Œèƒ½å¤Ÿè¾¾åˆ°ä»€ä¹ˆç¨‹åº¦ï¼Œè¿™ä¸€éƒ¨åˆ†å¯ä»¥è„‘æ´å¤§ä¸€äº›ï¼ŒæœŸæœ›é«˜ä¸€ç‚¹ï¼Œä¸è¦å±€é™åœ¨çœ¼å‰ã€‚</p><h4 id="ä¸€ä¸ªä¾‹å­-1"><a href="#ä¸€ä¸ªä¾‹å­-1" class="headerlink" title="ä¸€ä¸ªä¾‹å­"></a>ä¸€ä¸ªä¾‹å­</h4><ul><li><strong>åé¢æ•™æ: </strong>é›†ç¾¤å†…åº”ç”¨éšæ„æ¼‚ç§»ï¼Œå¯ä»¥å‡å°‘é›†ç¾¤ä¸­èŠ‚ç‚¹æ•…éšœæ¬¡æ•°</li><li><strong>æ­£é¢æ•™æ: </strong>ä¸ºä¸šåŠ¡åº”ç”¨æä¾›å®‰å…¨ã€å¯é ã€ç¨³å®šã€èˆ’å¿ƒçš„æœåŠ¡ï¼Œä¸šåŠ¡é«˜å³°æ—¶èµ„æºåŠæ—¶æ‰©å®¹ï¼Œæ´ªå³°æ¥ä¸´æ—¶ï¼Œä¼˜å…ˆç¡®ä¿æ ¸å¿ƒåº”ç”¨ç¨³å®šï¼ŒåŠ›äº‰åšåˆ°è®©å¼€å‘æ—©ä¸‹ç­ï¼Œè¿ç»´ä¸åŠ ç­ï¼Œå‘¨æœ«æ— å‘Šè­¦ï¼Œå‡æœŸæ— è´Ÿæ‹…ã€‚</li></ul><p>è¿™ä¸¤ä¸ªä¾‹å­é‡Œé¢ï¼Œåé¢æ•™æå¤ªè¿‡äºåŠ¡å®äº†ï¼Œè¿™ä¸ªåªèƒ½è¯´æ˜¯å±…äºç°çŠ¶çš„æ”¹è¿›ï¼Œä¸èƒ½è¯´æ˜¯å¯¹æœªæ¥åœºæ™¯çš„æƒ³è±¡ï¼Œå¦ä¸€ä¸ªæ˜¯ä¸€ä¸ªå¸¸è§çš„åœºæ™¯åŠ ä¸Šä¸€äº›å½¢è€Œä¸Šçš„æƒ³è±¡ã€‚</p><h4 id="å¦‚ä½•ç•…äº«æœªæ¥ï¼Ÿ"><a href="#å¦‚ä½•ç•…äº«æœªæ¥ï¼Ÿ" class="headerlink" title="å¦‚ä½•ç•…äº«æœªæ¥ï¼Ÿ"></a>å¦‚ä½•ç•…äº«æœªæ¥ï¼Ÿ</h4><ul><li>ä»åœºæ™¯å‡ºå‘ï¼Œæç»˜ç†æƒ³çŠ¶æ€ä¸‹å¯ä»¥è¾¾åˆ°çš„çŠ¶æ€</li><li>ç»“åˆç°çŠ¶ï¼Œåˆ‡å¿Œè·‘é¢˜ï¼Œè¿™æ˜¯å±•æœ›æœªæ¥çš„æ—¶å€™ï¼Œæˆ‘æœ€å®¹æ˜“çŠ¯çš„ä¸€ä¸ªé”™è¯¯ï¼Œå…±å‹‰ã€‚</li></ul><h3 id="è¡Œä¸šå®è·µ"><a href="#è¡Œä¸šå®è·µ" class="headerlink" title="è¡Œä¸šå®è·µ"></a>è¡Œä¸šå®è·µ</h3><p>ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šå¯ä»¥è®©æˆ‘ä»¬çœ‹çš„æ›´è¿œï¼Œç»å¤§éƒ¨åˆ†çš„æƒ…å†µä¸‹è°ƒç ”æ—¶å€™çš„éœ€æ±‚éƒ½ä¼šæœ‰ä¸€äº›ä¸šç•Œçš„å®è·µæ¡ˆä¾‹ï¼Œç”šè‡³æœ‰ä¸€äº›å¼€æºçš„ç¤¾åŒºæ–¹æ¡ˆï¼Œä¾‹å¦‚ Googleã€äºšé©¬é€Šã€é˜¿é‡Œã€è…¾è®¯ç­‰ï¼Œè¿™æ˜¯è¯´ä»–ä»¬çš„æ–¹æ¡ˆæ˜¯å¦é€‚åˆæˆ‘ä»¬ï¼Œèƒ½å¦è½åœ°ã€‚<br>å¯¹äºè¡Œä¸šçš„å®è·µè¿™ä¸€å—çš„å†…å®¹ï¼Œå»ºè®®<strong>é‡‡ç”¨è¡¨æ ¼çš„æ–¹å¼è¿›è¡Œå¯¹æ¯”</strong>ï¼Œå¦‚æœå¯ä»¥çš„è¯è¿˜å¯ä»¥åšä¸€äº›<strong>ç°åœºæ¼”ç¤º</strong>ï¼Œæˆ–è€…æ˜¯<strong>å½•åˆ¶è§†é¢‘ã€‚</strong></p><table><thead><tr><th>ç»´åº¦</th><th>ç°çŠ¶</th><th>æ–¹æ¡ˆ A</th><th>æ–¹æ¡ˆ B</th><th>æ–¹æ¡ˆ C</th></tr></thead><tbody><tr><td>ç»´åº¦ 1</td><td>ç°çŠ¶ 1</td><td>âŒ æ–¹æ¡ˆ A</td><td>æ–¹æ¡ˆ B</td><td>âœ… æ–¹æ¡ˆ C</td></tr><tr><td>ç»´åº¦ 2</td><td>ç°çŠ¶ 1</td><td>âœ… æ–¹æ¡ˆ A</td><td>âŒ æ–¹æ¡ˆ B</td><td>æ–¹æ¡ˆ C</td></tr></tbody></table><p>å¦‚ä¸Šè¡¨æ‰€ç¤ºï¼Œå°±æ˜¯ä¸€ä¸ªååˆ†å¸¸è§çš„ä¸€ä¸ªå¯¹æ¯”è¡¨æ ¼ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€å®š<strong>ä¸è¦å¿˜è®°æˆ‘ä»¬å½“å‰çš„ç°çŠ¶æ˜¯ä»€ä¹ˆ</strong>ï¼Œæœ€åå¯ä»¥æœ‰ä¸€ä¸ªæ€»ç»“ï¼Œè¯´æ˜ä¸åŒæ–¹æ¡ˆçš„ä¼˜åŠ£ä¹‹å¤„ï¼Œå¦‚æœé‡‡ç”¨æŸä¸ªæ–¹æ¡ˆï¼Œåç»­æ˜¯å¦éœ€è¦æ›´åŠ æ·±å…¥çš„è°ƒç ”ç­‰ç­‰ã€‚</p><h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p><strong>è°ƒç ”ä¸€å®šè¦æœ‰ç»“è®º!</strong><br>è¿™é‡Œç»“è®ºä¸æ˜¯å†³ç­–ï¼Œä¹Ÿä¸æ˜¯ä¸€å®šæ˜¯æ–¹æ¡ˆï¼Œç”±äºæ—¶é—´ã€ç²¾åŠ›ä»¥åŠäº†è§£åˆ°çš„ä¿¡æ¯ç­‰ç­‰é™åˆ¶ï¼Œå¯èƒ½å¯¼è‡´æˆ‘ä»¬å½“ä¸‹æ˜¯æ— æ³•å¾—å‡ºä¸€ä¸ªå†³ç­–ï¼Œæ˜¯å¦é‡‡ç”¨æŸä¸ªæ–¹æ¡ˆï¼Œä½†æ˜¯ä¸€å®šè¦æœ‰ç»“è®ºï¼Œè¿™ä¸ªç»“è®ºï¼Œæ—¢å¯ä»¥æ˜¯ä¸€ä¸ªæ–¹å‘ä¸Šçš„å»ºè®®ï¼Œä¹Ÿå¯ä»¥æ˜¯éœ€è¦ç»§ç»­æ·±å…¥è°ƒç ”ã€‚åˆ‡è®°ä¸èƒ½ä»…ä¸ºäº†è°ƒç ”è€Œè°ƒç ”ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>â€œæ²¡æœ‰åæ€å’Œè¿›æ­¥çš„äººç”Ÿä¸å€¼å¾—ä¸€è¿‡â€ï¼Œæœ€è¿‘æŒºå–œæ¬¢è¿™å¥ Sloganï¼Œæˆ‘è§‰å¾—åæ€å’Œæ€»ç»“å¯ä»¥è¿›æ­¥æ›´å¿«ï¼Œæˆ‘çš„ä¸€ç‚¹æ‹™è§æˆ–è®¸ç”±äºæˆ‘çš„è§†é‡åŸå› ï¼Œä¼šæ¯”è¾ƒç‹­éš˜ï¼Œä½†æ˜¯å¦‚æœä½ å¦‚æœçœ‹äº†è¿™ç¯‡æ–‡ç« èƒ½æœ‰ä¸€äº›æ€è€ƒï¼Œæ— è®ºè®¤åŒä¸å¦ï¼Œé‚£éƒ½å¾ˆå€¼å¾—ã€‚</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>æ€»ç»“</tag>
      
      <tag>åæ€</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go Webå°æŠ€å·§ï¼ˆå››ï¼‰åœ¨å•ä¸ªä»“åº“ä¸­æ”¯æŒå¤šä¸ª go mod æ¨¡å—</title>
    <link href="/post/auxvv1.html"/>
    <url>/post/auxvv1.html</url>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>æœ€è¿‘åœ¨æ›´æ–°å†…éƒ¨çš„å·¥å…·åº“çš„æ—¶å€™å‘ç°ï¼Œå·¥å…·ä»“åº“ä¸­å…¶å®åŒ…å«äº†å¾ˆå¤šçš„æ¨¡å—ï¼Œä½†æ˜¯ç°åœ¨çš„ç‰ˆæœ¬å‘å¸ƒéƒ½æ˜¯åˆå¹¶åœ¨åœ¨ä¸€èµ·å‘çš„ï¼Œä¸ºäº†ç®¡ç†æ›´åŠ ç»†è‡´å’Œç›´è§‚ï¼Œæ‰€ä»¥æƒ³è¦åœ¨ä¸€ä¸ªä»“åº“ä¸­å®ç°å®ç°å¤šä¸ªæ¨¡å—çš„å‘å¸ƒã€‚<a id="more"></a></p><h2 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h2><ol><li>å•ä¸ªä»“åº“ä¸­åŒ…å«å¤šä¸ª go module æ¨¡å—</li><li>ç‰ˆæœ¬å‘å¸ƒå¯ä»¥æ ¹æ®æ¨¡å—æ¥å‘ç‰ˆï¼Œè€Œä¸æ˜¯æ•´ä¸ªä»“åº“è¿›è¡Œå‘ç‰ˆ</li></ol><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="ä»“åº“ç»“æ„"><a href="#ä»“åº“ç»“æ„" class="headerlink" title="ä»“åº“ç»“æ„"></a>ä»“åº“ç»“æ„</h3><p>å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªä»“åº“ <code>github.com/mohuishou/go-test-multi-module</code>  ç›®å½•ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">.<br>â”œâ”€â”€ a<br>â”‚   â”œâ”€â”€ a.go<br>â”‚   â””â”€â”€ go.mod<br>â””â”€â”€ b<br>    â”œâ”€â”€ b.go<br>    â””â”€â”€ go.mod<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>a/go.mod</code>  ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go mod init github.com/mohuishou/go-test-multi-module/a<br></code></pre></td></tr></table></figure><h3 id="ç‰ˆæœ¬å‘å¸ƒ"><a href="#ç‰ˆæœ¬å‘å¸ƒ" class="headerlink" title="ç‰ˆæœ¬å‘å¸ƒ"></a>ç‰ˆæœ¬å‘å¸ƒ</h3><p>å¯¹æ¨¡å—è¿›è¡Œå‘ç‰ˆæ—¶ï¼Œåªéœ€æ‰“ä¸Š <code>[æ¨¡å—å]/ç‰ˆæœ¬å·</code>  å³å¯<br>ä»¥æˆ‘ä»¬çš„ç¤ºä¾‹ä¸ºä¾‹ï¼Œå¯¹æ¨¡å— <code>a</code>  è¿›è¡Œå‘ç‰ˆæ—¶æˆ‘ä»¬åªéœ€è¦æ‰“ä¸Š tag <code>a/v1.0.0</code> ï¼ŒåŒç†å¯¹æ¨¡å— b è¿›è¡Œå‘ç‰ˆæ—¶ï¼Œéœ€è¦æ‰“ä¸Š tag <code>b/v1.0.0</code>  å³å¯</p><h3 id="ç”¨æˆ·ä½¿ç”¨"><a href="#ç”¨æˆ·ä½¿ç”¨" class="headerlink" title="ç”¨æˆ·ä½¿ç”¨"></a>ç”¨æˆ·ä½¿ç”¨</h3><p>ç”¨æˆ·åœ¨å®‰è£…çš„æ—¶å€™åªéœ€è¦å’Œæ™®é€šæ¨¡å—ä¸€æ ·æ‰§è¡Œå‘½ä»¤å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go get -u github.com/mohuishou/go-test-multi-module/a<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸€èˆ¬æƒ…å†µä¸‹ä¸æ¨èé‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œè¿˜æ˜¯ä¸€ä¸ªä»“åº“ä¸€ä¸ªæ¨¡å—æ¯”è¾ƒå¥½ï¼Œä¾¿äºç®¡ç†ï¼Œä½†æ˜¯å¯¹äºä¸€äº›å·¥å…·åº“é‡Œé¢åŒ…å«äº†è¾ƒå¤šçš„å·¥å…·ï¼Œæƒ³è¦ä¸åŒç±»å‹å•ç‹¬å‘ç‰ˆä¹Ÿå¯ä»¥é‡‡ç”¨æœ¬æ–‡æåˆ°çš„æ–¹å¼</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://github.com/mohuishou/go-test-multi-module">æœ¬æ–‡çš„ç¤ºä¾‹ä»“åº“</a></li><li><a href="https://github.com/golang/tools/releases">golang/tools</a> [å®˜æ–¹çš„ gopls ä¹Ÿæ˜¯è¿™ä¹ˆå‘å¸ƒç‰ˆæœ¬çš„]</li></ul><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>å°æŠ€å·§</tag>
      
      <tag>go mod</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go Web å°æŠ€å·§ï¼ˆä¸‰ï¼‰Gin å‚æ•°ç»‘å®š</title>
    <link href="/post/11996.html"/>
    <url>/post/11996.html</url>
    
    <content type="html"><![CDATA[<h2 id="æ¥”-xie-å­"><a href="#æ¥”-xie-å­" class="headerlink" title="æ¥”(xiÄ“)å­"></a>æ¥”(xiÄ“)å­</h2><p>åœ¨ç¬¬ä¸€ç¯‡æ–‡ç«  <a href="https://lailin.xyz/post/38237.html">ç®€åŒ– Gin æ¥å£ä»£ç </a> å½“ä¸­ä¸ºå¤§å®¶æä¾›äº†ä¸€ç§æŠ½è±¡ <code>gin</code> æ¥å£ä»£ç çš„æ€è·¯ï¼Œè€Œè¿™ç¯‡æ–‡ç« ä¼šä¸ºå¤§å®¶å¸¦æ¥å‚æ•°ç»‘å®šçš„ä¸€äº›æŠ€å·§ã€‚</p><p>åœ¨æˆ‘ä»¬å†™çš„ç»å¤§éƒ¨åˆ†çš„ API ä»£ç å½“ä¸­ï¼Œå…¶å®éƒ½æ˜¯éœ€è¦ä¼ é€’å‚æ•°çš„ï¼Œæ— è®ºæ˜¯é€šè¿‡ <code>path</code>ã€<code>query string</code> è¿˜æ˜¯ <code>body</code>ï¼Œåœ¨ <code>gin</code> å½“ä¸­ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç³»åˆ—çš„ <code>binding</code> æ–¹æ³•è®©æˆ‘ä»¬å¯ä»¥æŠŠè¿™äº›å‚æ•°ç»‘å®šåˆ°ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œé€šè¿‡è¿˜å¯ä»¥é€šè¿‡ <code>struct tag</code> æ¥å¯¹å‚æ•°è¿›è¡Œæ ¡éªŒï¼Œä¸çŸ¥é“åˆ°å¤§å®¶æ›¾ä»Šæ˜¯å¦å’Œé‡åˆ°è¿‡ç›¸åŒçš„å›°æƒ‘ï¼š</p><ul><li>æˆ‘åˆ›å»º/æ›´æ–°æ¥å£æœ‰æ—¶å€™å°±ä»…ä»…åªç›¸å·®ä¸€ä¸ª idï¼Œæˆ‘æ˜¯ä¸æ˜¯å¯ä»¥å¤ç”¨ä»£ç ï¼Ÿ</li><li>æ˜¯å¦å¯ä»¥ç›´æ¥ç”¨ model å±‚çš„ struct ç»‘å®šå‚æ•°ï¼Ÿ</li></ul><p>æ¥ä¸‹æ¥æœ¬æ–‡å°±ä»è¿™äº›é—®é¢˜å‡ºå‘ï¼Œåˆ©ç”¨ go çš„ç»„åˆç‰¹ç‚¹ï¼Œä»‹ç»ä¸€äº›å‚æ•°ç»‘å®šä¸Šçš„å°æŠ€å·§</p><a id="more"></a><h2 id="å‚æ•°ç»‘å®šæŠ€å·§"><a href="#å‚æ•°ç»‘å®šæŠ€å·§" class="headerlink" title="å‚æ•°ç»‘å®šæŠ€å·§"></a>å‚æ•°ç»‘å®šæŠ€å·§</h2><h3 id="1-å¤ç”¨åˆ›å»º-æ›´æ–°æ—¶çš„å‚æ•°"><a href="#1-å¤ç”¨åˆ›å»º-æ›´æ–°æ—¶çš„å‚æ•°" class="headerlink" title="1. å¤ç”¨åˆ›å»º/æ›´æ–°æ—¶çš„å‚æ•°"></a>1. å¤ç”¨åˆ›å»º/æ›´æ–°æ—¶çš„å‚æ•°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// UserParams ç”¨æˆ·å‚æ•°</span><br><span class="hljs-keyword">type</span> UserParams <span class="hljs-keyword">struct</span> &#123;<br>Name     <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;name&quot; binding:&quot;required&quot;`</span><br>Password <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;password&quot; binding:&quot;required&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// CreateUserParams åˆ›å»ºç”¨æˆ·</span><br><span class="hljs-keyword">type</span> CreateUserParams <span class="hljs-keyword">struct</span> &#123;<br>UserParams<br>&#125;<br><br><span class="hljs-comment">// UpdateUserParams æ›´æ–°ç”¨æˆ·</span><br><span class="hljs-keyword">type</span> UpdateUserParams <span class="hljs-keyword">struct</span> &#123;<br>UserParams<br>ID <span class="hljs-keyword">uint</span> <span class="hljs-string">`json:&quot;id&quot; binding:&quot;required&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-ç”¨-model-å±‚çš„-struct-ç»‘å®šå‚æ•°"><a href="#2-ç”¨-model-å±‚çš„-struct-ç»‘å®šå‚æ•°" class="headerlink" title="2. ç”¨ model å±‚çš„ struct ç»‘å®šå‚æ•°"></a>2. ç”¨ model å±‚çš„ struct ç»‘å®šå‚æ•°</h3><p>å¦‚æœæˆ‘ä»¬åœ¨å‚æ•°ç»‘å®šçš„æ—¶å€™ï¼Œå‘ä¸Šé¢é‚£æ ·ï¼Œæ¯ä¸ªå‚æ•°å•ç‹¬åˆ›å»ºä¸€ä¸ªç»‘å®šï¼Œè¿™æ ·åœ¨ Model å±‚åˆ›å»ºæ•°æ®åº“è®°å½•çš„æ—¶å€™å°±éœ€è¦å»æ‰‹åŠ¨çš„è½¬æ¢ä¸€é“äº†ï¼Œå¦‚æœæ¯ä¸ªéƒ½éœ€è¦è¿™ä¹ˆå†™ï¼Œä¼šæ„Ÿè§‰å¾ˆéº»çƒ¦ã€‚</p><p>è¿™æ˜¯åŸæœ¬çš„ <code>user</code> è¡¨</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// model/model.go</span><br><br><span class="hljs-comment">// Model default model</span><br><span class="hljs-keyword">type</span> Model <span class="hljs-keyword">struct</span> &#123;<br>ID        <span class="hljs-keyword">uint</span>       <span class="hljs-string">`json:&quot;id&quot; gorm:&quot;primary_key&quot;`</span><br>CreatedAt time.Time  <span class="hljs-string">`json:&quot;created_at&quot;`</span><br>UpdatedAt time.Time  <span class="hljs-string">`json:&quot;updated_at&quot;`</span><br>DeletedAt *time.Time <span class="hljs-string">`json:&quot;deleted_at&quot; sql:&quot;index&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// model/user.go</span><br><br><span class="hljs-comment">// User ç”¨æˆ·è¡¨</span><br><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>    Model<br><br>Name     <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>Password <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;password&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ—¶æˆ‘ä»¬å¯ä»¥ç¨å¾®æ”¹é€ ä¸€ä¸‹, åˆ©ç”¨ <code>binding:&quot;-&quot;</code> å¿½ç•¥å­—æ®µçš„åŠŸèƒ½ï¼Œå’Œ <code>struct</code> ç»„åˆï¼Œå°† api çš„å‚æ•°å’Œ model å…³è”åœ¨ä¸€èµ·ï¼Œå‡å°‘ä¸€äº›ç»“æ„ä½“è½¬æ¢çš„ä»£ç </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// model/model.go</span><br><br><span class="hljs-comment">// Model default model</span><br><span class="hljs-keyword">type</span> Model <span class="hljs-keyword">struct</span> &#123;<br>    ID        <span class="hljs-keyword">uint</span>       <span class="hljs-string">`json:&quot;id&quot; gorm:&quot;primary_key&quot;`</span><br>CreatedAt time.Time  <span class="hljs-string">`json:&quot;created_at&quot; binding:&quot;-&quot;`</span><br>UpdatedAt time.Time  <span class="hljs-string">`json:&quot;updated_at&quot; binding:&quot;-&quot;`</span><br>DeletedAt *time.Time <span class="hljs-string">`json:&quot;deleted_at&quot; sql:&quot;index&quot; binding:&quot;-&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// model/user.go</span><br><br><span class="hljs-comment">// User ç”¨æˆ·è¡¨</span><br><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>    Model<br><br>Name     <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;name&quot; binding:&quot;required&quot;`</span><br>Password <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;password&quot; binding:&quot;required&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// api/user.go</span><br><span class="hljs-comment">// UserParams ç”¨æˆ·å‚æ•°</span><br><span class="hljs-keyword">type</span> UserParams <span class="hljs-keyword">struct</span> &#123;<br>    model.User<br>&#125;<br><br><span class="hljs-comment">// CreateUserParams åˆ›å»ºç”¨æˆ·</span><br><span class="hljs-keyword">type</span> CreateUserParams <span class="hljs-keyword">struct</span> &#123;<br>UserParams<br>    ID    <span class="hljs-keyword">uint</span>    <span class="hljs-string">`json:&quot;id&quot; gorm:&quot;primary_key&quot; binding:&quot;-&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// UpdateUserParams æ›´æ–°ç”¨æˆ·</span><br><span class="hljs-keyword">type</span> UpdateUserParams <span class="hljs-keyword">struct</span> &#123;<br>UserParams<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-ä½¿ç”¨-ShouldBind-è€Œä¸æ˜¯-Bind"><a href="#3-ä½¿ç”¨-ShouldBind-è€Œä¸æ˜¯-Bind" class="headerlink" title="3. ä½¿ç”¨ ShouldBind è€Œä¸æ˜¯ Bind"></a>3. ä½¿ç”¨ <code>ShouldBind</code> è€Œä¸æ˜¯ <code>Bind</code></h3><p><code>Bind</code> æ–¹æ³•ä¼šè‡ªåŠ¨å°† http status è®¾ç½®ä¸º 400, ç„¶åæŠ¥é”™ï¼Œä½†æ˜¯æˆ‘ä»¬å¾€å¾€ä¼šéœ€è¦æºå¸¦æ›´å¤šçš„ä¿¡æ¯è¿”å›ï¼Œæˆ–è€…è¿”å›ä¸åŒçš„ <code>status</code> è¿™æ—¶å€™å¾€å¾€ä¼šå‡ºç°ä¸‹é¢è¿™æ ·çš„è­¦å‘Šï¼Œè€Œä½¿ç”¨ <code>ShouldBind</code> å¯ä»¥é¿å…æ­¤ç±»é—®é¢˜</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[WARNING] Headers were already written. Wanted to override status code 400 with 200<br></code></pre></td></tr></table></figure><h3 id="4-å¤šæ¬¡ç»‘å®š-request-body-æ•°æ®"><a href="#4-å¤šæ¬¡ç»‘å®š-request-body-æ•°æ®" class="headerlink" title="4. å¤šæ¬¡ç»‘å®š request body æ•°æ®"></a>4. å¤šæ¬¡ç»‘å®š request body æ•°æ®</h3><p>è¿™æ˜¯å®˜æ–¹æ–‡æ¡£çš„ä¸€ä¸ªç¤ºä¾‹ï¼Œä¸€èˆ¬æƒ…å†µç¬¬äºŒæ¬¡è¯»å– request body çš„æ•°æ®å°±ä¼šå‡ºç° EOF çš„é”™è¯¯ï¼Œå› ä¸º <code>c.Request.Body</code> ä¸å¯ä»¥é‡ç”¨</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> formA <span class="hljs-keyword">struct</span> &#123;<br>  Foo <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;foo&quot; binding:&quot;required&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> formB <span class="hljs-keyword">struct</span> &#123;<br>  Bar <span class="hljs-keyword">string</span> <span class="hljs-string">`json:&quot;bar&quot; binding:&quot;required&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SomeHandler</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>  objA := formA&#123;&#125;<br>  objB := formB&#123;&#125;<br>  <span class="hljs-comment">// c.ShouldBind ä½¿ç”¨äº† c.Request.Bodyï¼Œä¸å¯é‡ç”¨ã€‚</span><br>  <span class="hljs-keyword">if</span> errA := c.ShouldBind(&amp;objA); errA == <span class="hljs-literal">nil</span> &#123;<br>    c.String(http.StatusOK, <span class="hljs-string">`the body should be formA`</span>)<br>  <span class="hljs-comment">// å› ä¸ºç°åœ¨ c.Request.Body æ˜¯ EOFï¼Œæ‰€ä»¥è¿™é‡Œä¼šæŠ¥é”™ã€‚</span><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> errB := c.ShouldBind(&amp;objB); errB == <span class="hljs-literal">nil</span> &#123;<br>    c.String(http.StatusOK, <span class="hljs-string">`the body should be formB`</span>)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    ...<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>gin 1.4 ä¹‹åå®˜æ–¹æä¾›äº†ä¸€ä¸ª <code>ShouldBindBodyWith</code> çš„æ–¹æ³•ï¼Œå¯ä»¥æ”¯æŒé‡å¤ç»‘å®šï¼ŒåŸç†å°±æ˜¯å°† body çš„æ•°æ®ç¼“å­˜äº†ä¸‹æ¥ï¼Œä½†æ˜¯äºŒæ¬¡å–æ•°æ®çš„æ—¶å€™è¿˜æ˜¯å¾—ç”¨ <code>ShouldBindBodyWith</code> æ‰è¡Œï¼Œç›´æ¥ç”¨ <code>ShouldBind</code> è¿˜æ˜¯ä¼šæŠ¥é”™çš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SomeHandler</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>  objA := formA&#123;&#125;<br>  objB := formB&#123;&#125;<br>  <span class="hljs-comment">// è¯»å– c.Request.Body å¹¶å°†ç»“æœå­˜å…¥ä¸Šä¸‹æ–‡ã€‚</span><br>  <span class="hljs-keyword">if</span> errA := c.ShouldBindBodyWith(&amp;objA, binding.JSON); errA == <span class="hljs-literal">nil</span> &#123;<br>    c.String(http.StatusOK, <span class="hljs-string">`the body should be formA`</span>)<br>  <span class="hljs-comment">// è¿™æ—¶, å¤ç”¨å­˜å‚¨åœ¨ä¸Šä¸‹æ–‡ä¸­çš„ bodyã€‚</span><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> errB := c.ShouldBindBodyWith(&amp;objB, binding.JSON); errB == <span class="hljs-literal">nil</span> &#123;<br>    c.String(http.StatusOK, <span class="hljs-string">`the body should be formB JSON`</span>)<br>  <span class="hljs-comment">// å¯ä»¥æ¥å—å…¶ä»–æ ¼å¼</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    ...<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼å…¶å®æœ‰ä¸ªé—®é¢˜ï¼Œä»€ä¹ˆæƒ…å†µä¸‹æˆ‘ä»¬ä¼šå»å¤šæ¬¡è¯»å– <code>body</code> çš„æ•°æ®ï¼Œå…¶å®åœ¨ä¸­é—´ä»¶ä¸­æˆ‘ä»¬æ˜¯éœ€è¦ç”¨åˆ°ï¼Œæœ‰çš„ä¸­é—´ä»¶éœ€è¦è¯»å–å‚æ•°åšä¸€äº›å¤„ç†ï¼Œä¾‹å¦‚æƒé™ä¸­é—´ä»¶éœ€è¦è·å–å½“å‰èµ„æºçš„ idï¼Œåˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æƒé™ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ç›´æ¥ä½¿ç”¨ <code>ShouldBindBodyWith</code> ä¼šå¯¼è‡´ä¹‹åçš„æ‰€æœ‰çš„æ¥å£éƒ½ä¿®æ”¹æ‰è¡Œï¼Œååˆ†çš„ä¸ä¼˜é›…ï¼Œä¸‹é¢æä¾›ä¸€ç§ä¸ç”¨å½±å“åç»­ä½¿ç”¨çš„æ–¹æ³•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startPage</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br><span class="hljs-keyword">var</span> (<br>p1 Person<br>p2 Person<br>)<br>buf := &amp;bytes.Buffer&#123;&#125;<br>tea := io.TeeReader(c.Request.Body, buf)<br>body, err := ioutil.ReadAll(tea)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Panicf(<span class="hljs-string">&quot;read body err: %+v&quot;</span>, err)<br>&#125;<br>c.Request.Body = ioutil.NopCloser(buf)<br><span class="hljs-comment">// read buf ...</span><br><span class="hljs-keyword">if</span> err := binding.JSON.BindBody(body, &amp;p1); err != <span class="hljs-literal">nil</span> &#123;<br>log.Panic(<span class="hljs-string">&quot;p1&quot;</span>, err)<br>&#125;<br>log.Println(<span class="hljs-string">&quot;p1&quot;</span>, p1)<br><span class="hljs-comment">// use ShouldBind again ..</span><br><span class="hljs-keyword">if</span> err := c.ShouldBind(&amp;p2); err != <span class="hljs-literal">nil</span> &#123;<br>log.Panic(<span class="hljs-string">&quot;p2&quot;</span>, err)<br>&#125;<br>log.Println(<span class="hljs-string">&quot;p2&quot;</span>, p2)<br>c.String(<span class="hljs-number">200</span>, <span class="hljs-string">&quot;Success&quot;</span>)<br>&#125;<br><br><br><span class="hljs-comment">// output</span><br><span class="hljs-comment">// 2019/11/06 23:10:04 p1 &#123;hello world&#125;</span><br><span class="hljs-comment">// 2019/11/06 23:10:04 p2 &#123;hello world&#125;</span><br><span class="hljs-comment">// [GIN] 2019/11/06 - 23:10:04 | 200 |   27.0400917s |             ::1 | POST     /testing</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸‰è¡Œä¹Ÿé€‚ç”¨äºå…¶ä»–éœ€è¦å¤šæ¬¡è¯»å– <code>io.Reader</code> çš„æƒ…å†µ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">buf := &amp;bytes.Buffer&#123;&#125;<br>tea := io.TeeReader(c.Request.Body, buf)<br>body, err := ioutil.ReadAll(tea)<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ç¯‡æ–‡ç« ä»å‚æ•°ç»‘å®šçš„é—®é¢˜å‡ºå‘ï¼Œä¸ºå¤§å®¶ä»‹ç»äº†ä¸¤ç§ç»„åˆå‚æ•°çš„å°æŠ€å·§ï¼Œæä¾›äº†ä½¿ç”¨å‚æ•°ç»‘å®šçš„æ—¶å€™çš„ä¸€ä¸ªå»ºè®®ï¼Œå¹¶ä¸”æå‡ºäº†éå®˜æ–¹ï¼Œä¾µå…¥æ€§å°çš„çš„å¤šæ¬¡è¯»å– request body çš„æ–¹å¼ã€‚</p><p>ä¸‹ä¸€ç¯‡æ–‡ç« ç»™å¤§å®¶ä»‹ç» gorm äº‹åŠ¡çš„ä¸€äº›å°æŠ€å·§</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><p><a href="https://gin-gonic.com/zh-cn/">gin å®˜æ–¹æ–‡æ¡£</a></p></li><li><p><a href="https://stackoverflow.com/questions/39791021/how-to-read-multiple-times-from-same-io-reader">How to read multiple times from same io.Reader</a></p></li></ol><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>å°æŠ€å·§</tag>
      
      <tag>api</tag>
      
      <tag>gin</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go Web å°æŠ€å·§ï¼ˆäºŒï¼‰GORM ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹</title>
    <link href="/post/17394.html"/>
    <url>/post/17394.html</url>
    
    <content type="html"><![CDATA[<p>ä¸çŸ¥é“å¤§å®¶åœ¨ä½¿ç”¨ Gorm çš„æ—¶å€™ï¼Œæ˜¯å¦æœ‰é‡åˆ°è¿‡å¤æ‚ç±»å‹ ( map, structâ€¦) å¦‚ä½•æ˜ å°„åˆ°æ•°æ®åº“çš„å­—æ®µä¸Šçš„é—®é¢˜ï¼Ÿ</p><p>æœ¬æ–‡åˆ†åˆ«ä»‹ç»é€šè¿‡å®ç°é€šç”¨æ¥å£å’Œ Hook çš„æ–¹å¼ç»‘å®šå¤æ‚çš„æ•°æ®ç±»å‹ã€‚</p><a id="more"></a><h2 id="ä¸€ã€GORM-æ¨¡å‹å®šä¹‰"><a href="#ä¸€ã€GORM-æ¨¡å‹å®šä¹‰" class="headerlink" title="ä¸€ã€GORM æ¨¡å‹å®šä¹‰"></a>ä¸€ã€GORM æ¨¡å‹å®šä¹‰</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>  gorm.Model<br>  Name         <span class="hljs-keyword">string</span><br>  Age          sql.NullInt64<br>  Birthday     *time.Time<br>  Email        <span class="hljs-keyword">string</span>  <span class="hljs-string">`gorm:&quot;type:varchar(100);unique_index&quot;`</span><br>  Role         <span class="hljs-keyword">string</span>  <span class="hljs-string">`gorm:&quot;size:255&quot;`</span> <span class="hljs-comment">// è®¾ç½®å­—æ®µå¤§å°ä¸º255</span><br>  MemberNumber *<span class="hljs-keyword">string</span> <span class="hljs-string">`gorm:&quot;unique;not null&quot;`</span> <span class="hljs-comment">// è®¾ç½®ä¼šå‘˜å·ï¼ˆmember numberï¼‰å”¯ä¸€å¹¶ä¸”ä¸ä¸ºç©º</span><br>  Num          <span class="hljs-keyword">int</span>     <span class="hljs-string">`gorm:&quot;AUTO_INCREMENT&quot;`</span> <span class="hljs-comment">// è®¾ç½® num ä¸ºè‡ªå¢ç±»å‹</span><br>  Address      <span class="hljs-keyword">string</span>  <span class="hljs-string">`gorm:&quot;index:addr&quot;`</span> <span class="hljs-comment">// ç»™addresså­—æ®µåˆ›å»ºåä¸ºaddrçš„ç´¢å¼•</span><br>  IgnoreMe     <span class="hljs-keyword">int</span>     <span class="hljs-string">`gorm:&quot;-&quot;`</span> <span class="hljs-comment">// å¿½ç•¥æœ¬å­—æ®µ</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ GORM å®˜æ–¹æ–‡æ¡£å½“ä¸­æ¨¡å‹å®šä¹‰çš„ä¸€ä¸ªä¾‹å­ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹å½“ä¸­å¾€å¾€ä¼šé‡åˆ°éœ€è¦å¤æ‚ç±»å‹ä¾‹å¦‚ <code>map</code> æˆ–è€…æ˜¯ä¸€äº›è‡ªå®šä¹‰çš„ç±»å‹è¿›è¡Œç»‘å®šã€‚</p><p>æˆ‘ä»¬åœ¨æ–‡æ¡£çš„æè¿°å½“ä¸­å¯ä»¥çœ‹åˆ°è¿™ä¹ˆä¸€æ®µè¯ï¼š</p><blockquote><p>æ¨¡å‹ï¼ˆModelsï¼‰é€šå¸¸åªæ˜¯æ­£å¸¸çš„ golang structsã€åŸºæœ¬çš„ go ç±»å‹æˆ–å®ƒä»¬çš„æŒ‡é’ˆã€‚ åŒæ—¶ä¹Ÿæ”¯æŒ<a href="https://golang.org/pkg/database/sql/#Scanner"><code>sql.Scanner</code></a>åŠ<a href="https://golang.org/pkg/database/sql/driver/#Valuer"><code>driver.Valuer</code></a> æ¥å£ï¼ˆinterfacesï¼‰ã€‚</p></blockquote><p>è‡ªå·²çš„æ•°æ®ç±»å‹åªéœ€è¦å®ç°è¿™ä¸¤ä¸ªæ¥å£å°±å¯ä»¥å®ç°æ•°æ®ç»‘å®šäº†ï¼Œæ–‡æ¡£åªæœ‰ä¸€å¥è¯æˆ‘ä»¬çœ‹çœ‹å…·ä½“æ€ä¹ˆåšã€‚</p><h2 id="äºŒã€é€šè¿‡å®ç°-sql-Scanner-driver-Valuer-æ¥å£å®ç°æ•°æ®ç»‘å®š"><a href="#äºŒã€é€šè¿‡å®ç°-sql-Scanner-driver-Valuer-æ¥å£å®ç°æ•°æ®ç»‘å®š" class="headerlink" title="äºŒã€é€šè¿‡å®ç° sql.Scanner,driver.Valuer æ¥å£å®ç°æ•°æ®ç»‘å®š"></a>äºŒã€é€šè¿‡å®ç° <code>sql.Scanner,driver.Valuer</code> æ¥å£å®ç°æ•°æ®ç»‘å®š</h2><h3 id="2-1-æ¥å£æ–‡æ¡£"><a href="#2-1-æ¥å£æ–‡æ¡£" class="headerlink" title="2.1 æ¥å£æ–‡æ¡£"></a>2.1 æ¥å£æ–‡æ¡£</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// sql.Scanner</span><br><span class="hljs-keyword">type</span> Scanner <span class="hljs-keyword">interface</span> &#123;<br>    <span class="hljs-comment">// Scan assigns a value from a database driver.</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// The src value will be of one of the following types:</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">//    int64</span><br>    <span class="hljs-comment">//    float64</span><br>    <span class="hljs-comment">//    bool</span><br>    <span class="hljs-comment">//    []byte</span><br>    <span class="hljs-comment">//    string</span><br>    <span class="hljs-comment">//    time.Time</span><br>    <span class="hljs-comment">//    nil - for NULL values</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// An error should be returned if the value cannot be stored</span><br>    <span class="hljs-comment">// without loss of information.</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// Reference types such as []byte are only valid until the next call to Scan</span><br>    <span class="hljs-comment">// and should not be retained. Their underlying memory is owned by the driver.</span><br>    <span class="hljs-comment">// If retention is necessary, copy their values before the next call to Scan.</span><br>    Scan(src <span class="hljs-keyword">interface</span>&#123;&#125;) error<br>&#125;<br><br><span class="hljs-comment">// driver.Valuer</span><br><span class="hljs-keyword">type</span> Valuer <span class="hljs-keyword">interface</span> &#123;<br>    <span class="hljs-comment">// Value returns a driver Value.</span><br>    <span class="hljs-comment">// Value must not panic.</span><br>    Value() (Value, error)<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å‘ç° <code>Valuer</code> ç”¨äºä¿å­˜æ•°æ®çš„æ—¶å€™ï¼Œ<code>Scaner</code> ç”¨äºæ•°æ®ä»æ•°æ®åº“æ˜ å°„åˆ° model çš„æ—¶å€™</p><h3 id="2-2-å®ç°æ¥å£"><a href="#2-2-å®ç°æ¥å£" class="headerlink" title="2.2 å®ç°æ¥å£"></a>2.2 å®ç°æ¥å£</h3><p>ä¸‹é¢æˆ‘ä»¬æ¥ä¸€ä¸ªå®é™…çš„ä¾‹å­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Args å‚æ•°</span><br><span class="hljs-keyword">type</span> Args <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span><br><br><span class="hljs-comment">// Scan Scanner</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(args Args)</span> <span class="hljs-title">Scan</span><span class="hljs-params">(value <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">if</span> value == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br>b, ok := value.([]<span class="hljs-keyword">byte</span>)<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;value is not []byte, value: %v&quot;</span>, value)<br>&#125;<br><br><span class="hljs-keyword">return</span> json.Unmarshal(b, &amp;args)<br>&#125;<br><br><span class="hljs-comment">// Value Valuer</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(args Args)</span> <span class="hljs-title">Value</span><span class="hljs-params">()</span> <span class="hljs-params">(driver.Value, error)</span></span> &#123;<br><span class="hljs-keyword">if</span> args == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-keyword">return</span> json.Marshal(args)<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨çš„æ—¶å€™æˆ‘ä»¬åªè¦å†åŠ ä¸Šä¸€ä¸ªæ•°æ®ç±»å‹å°± OK äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Data <span class="hljs-keyword">struct</span> &#123;<br>  Args Args <span class="hljs-string">`json:&quot;args&quot; gorm:&quot;type:text&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-æŠ½è±¡é€šç”¨å·¥å…·å‡½æ•°"><a href="#2-3-æŠ½è±¡é€šç”¨å·¥å…·å‡½æ•°" class="headerlink" title="2.3 æŠ½è±¡é€šç”¨å·¥å…·å‡½æ•°"></a>2.3 æŠ½è±¡é€šç”¨å·¥å…·å‡½æ•°</h3><p>åœ¨å®é™…çš„ä½¿ç”¨ä¸­æˆ‘ä»¬å¯èƒ½ä¼šæœ‰è®¸å¤šçš„ç±»å‹çš„éœ€è¦è¿™æ ·å­˜å‚¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥æŠ½è±¡ä¸€ä¸ªå…¬ç”¨çš„å·¥å…·å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// scan for scanner helper</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scan</span><span class="hljs-params">(data <span class="hljs-keyword">interface</span>&#123;&#125;, value <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">if</span> value == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-keyword">switch</span> value.(<span class="hljs-keyword">type</span>) &#123;<br><span class="hljs-keyword">case</span> []<span class="hljs-keyword">byte</span>:<br><span class="hljs-keyword">return</span> json.Unmarshal(value.([]<span class="hljs-keyword">byte</span>), data)<br><span class="hljs-keyword">case</span> <span class="hljs-keyword">string</span>:<br><span class="hljs-keyword">return</span> json.Unmarshal([]<span class="hljs-keyword">byte</span>(value.(<span class="hljs-keyword">string</span>)), data)<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;val type is valid, is %+v&quot;</span>, value)<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// for valuer helper</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">value</span><span class="hljs-params">(data <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;, error)</span></span> &#123;<br>vi := reflect.ValueOf(data)<br><span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦ä¸º 0 å€¼</span><br><span class="hljs-keyword">if</span> vi.IsZero() &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-keyword">return</span> json.Marshal(data)<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨çš„æ—¶å€™åªéœ€è¦è°ƒç”¨ä¸€ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Args å‚æ•°</span><br><span class="hljs-keyword">type</span> Args <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span><br><br><span class="hljs-comment">// Scan Scanner</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(args Args)</span> <span class="hljs-title">Scan</span><span class="hljs-params">(value <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">return</span> scan(&amp;args, value)<br>&#125;<br><br><span class="hljs-comment">// Value Valuer</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(args Args)</span> <span class="hljs-title">Value</span><span class="hljs-params">()</span> <span class="hljs-params">(driver.Value, error)</span></span> &#123;<br><span class="hljs-keyword">return</span> value(args)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä¸‰ã€é€šè¿‡-hook-å®ç°æ•°æ®ç»‘å®š"><a href="#ä¸‰ã€é€šè¿‡-hook-å®ç°æ•°æ®ç»‘å®š" class="headerlink" title="ä¸‰ã€é€šè¿‡ hook å®ç°æ•°æ®ç»‘å®š"></a>ä¸‰ã€é€šè¿‡ hook å®ç°æ•°æ®ç»‘å®š</h2><p>é™¤äº†ä¸Šé¢çš„è¿™ç§æ–¹æ³•æœ‰æ²¡æœ‰å…¶ä»–çš„å®ç°æ–¹å¼å‘¢ï¼Ÿ</p><p>å½“ç„¶æ˜¯æœ‰çš„ï¼Œä»ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå®ç°æ–¹å¼å°±æ˜¯ä¿å­˜æ•°æ®çš„æ—¶å€™å°†æ•°æ®è½¬æ¢ä¸ºåŸºæœ¬ç±»å‹ï¼Œç„¶ååœ¨å–å‡ºæ¥ç»‘å®šæ•°æ®çš„æ—¶å€™å†è½¬æ¢ä¸€ä¸‹ï¼Œè¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ <a href="http://gorm.io/docs/hooks.html">GORM çš„ Hook</a> å®ç°ã€‚åˆ©ç”¨ <code>BeforeSave</code> åœ¨æ•°æ®ä¿å­˜å‰è½¬æ¢ï¼Œå†åˆ©ç”¨ <code>AfterFind</code> åœ¨æ•°æ®å–å‡ºæ¥ä¹‹åè½¬æ¢å³å¯ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼æˆ‘ä»¬éœ€è¦åœ¨ struct ä¸­å®šä¹‰ä¸€ä¸ªç”¨äºå®é™…æ˜ å°„æ•°æ®åº“æ•°æ®çš„å­—æ®µã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Data Data</span><br><span class="hljs-keyword">type</span> Data <span class="hljs-keyword">struct</span> &#123;<br>Args    <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125; <span class="hljs-string">`json:&quot;args&quot; gorm:&quot;-&quot;`</span><br>ArgsStr <span class="hljs-keyword">string</span>                 <span class="hljs-string">`json:&quot;-&quot; gorm:&quot;column:args&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// BeforeSave æ•°æ®ä¿å­˜å‰</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(data *Data)</span> <span class="hljs-title">BeforeSave</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">if</span> data.Args == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br>b, err := json.Marshal(&amp;data.Args)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br>data.ArgsStr = <span class="hljs-keyword">string</span>(b)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// AfterFind æŸ¥è¯¢ä¹‹å</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(data *Data)</span> <span class="hljs-title">AfterFind</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">if</span> data.ArgsStr == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-keyword">return</span> json.Unmarshal([]<span class="hljs-keyword">byte</span>(data.ArgsStr), &amp;data.Args)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·åŒæ ·å¯ä»¥è¾¾åˆ°ç›¸ä¼¼çš„æ•ˆæœ</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ç¯‡æ–‡ç« ä»‹ç»äº†ä¸¤ç§é€šç”¨æ•°æ®ç±»å‹åœ¨ GORM ä¸­çš„ç»‘å®šæ–¹å¼ï¼š</p><ul><li>é€šè¿‡å®ç°ç›¸å…³çš„æ¥å£å®ç°ï¼Œå¹¶ä¸”æŠ½è±¡äº†ä¸€ä¸ªé€šç”¨çš„è¾…åŠ©å‡½æ•°</li><li>é€šè¿‡ hook å®ç°</li></ul><p>ä¸€èˆ¬æ¨èä½¿ç”¨ç¬¬ä¸€ç§æ–¹æ³•ï¼Œåªæ˜¯éœ€è¦å•ç‹¬å®šä¹‰æ•°æ®ç±»å‹ï¼Œç¬¬äºŒç§æ–¹æ³•éœ€è¦å¤šä¸€ä¸ªè¾…åŠ©å­—æ®µï¼Œè¿™ç§æ–¹å¼å¦‚æœç›¸å…³çš„å­—æ®µè¿‡å¤šä¼šå¾ˆä¸ä¼˜é›…ã€‚</p><p>æ„Ÿè°¢é˜…è¯»ï¼Œè¿™æ˜¯ Go Web å°æŠ€å·§ç³»åˆ—çš„ç¬¬äºŒç¯‡æ–‡ç« ï¼Œä¸‹ä¸€ç¯‡ä¸ºå¤§å®¶ä»‹ç»å‚æ•°ç»‘å®šå½“ä¸­çš„ä¸€äº›å°æŠ€å·§</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>gorm</tag>
      
      <tag>å°æŠ€å·§</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go Web å°æŠ€å·§ï¼ˆä¸€ï¼‰ç®€åŒ–Ginæ¥å£ä»£ç </title>
    <link href="/post/38237.html"/>
    <url>/post/38237.html</url>
    
    <content type="html"><![CDATA[<p>ä¸çŸ¥é“å¤§å®¶åœ¨ä½¿ç”¨ Gin æ„å»º API æœåŠ¡æ—¶æœ‰æ²¡æœ‰è¿™æ ·çš„é—®é¢˜:</p><ol><li>å‚æ•°ç»‘å®šçš„ç¯èŠ‚å¯ä¸å¯ä»¥è‡ªåŠ¨å¤„ç†ï¼Ÿ</li><li>é”™è¯¯å¯ä¸å¯ä»¥ç›´æ¥è¿”å›ï¼Œä¸æƒ³å†™ç©º <code>return</code>, æ¼å†™å°±æ˜¯ <code>bug</code></li></ol><p>æœ¬æ–‡é€šè¿‡ç®€å•åœ°å°è£…ï¼Œåˆ©ç”¨ go çš„æ¥å£ç‰¹æ€§ï¼Œæä¾›ä¸€ä¸ªè§£å†³ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜çš„æ€è·¯</p><a id="more"></a><h2 id="è§£å†³è¿‡ç¨‹"><a href="#è§£å†³è¿‡ç¨‹" class="headerlink" title="è§£å†³è¿‡ç¨‹"></a>è§£å†³è¿‡ç¨‹</h2><h3 id="åˆšå¼€å§‹æ—¶å†™-API-æœåŠ¡æ—¶"><a href="#åˆšå¼€å§‹æ—¶å†™-API-æœåŠ¡æ—¶" class="headerlink" title="åˆšå¼€å§‹æ—¶å†™ API æœåŠ¡æ—¶"></a>åˆšå¼€å§‹æ—¶å†™ API æœåŠ¡æ—¶</h3><p>æˆ‘ä»¬åˆšå¼€å§‹ä½¿ç”¨ Gin å†™ API æœåŠ¡æ—¶ï¼Œä¸€èˆ¬ä¼šæŒ‰ç…§å®˜æ–¹æ–‡æ¡£ä¸Šçš„ ğŸŒ° è¿™ä¹ˆå†™</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// User ç”¨æˆ·ç»“æ„</span><br><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>UserName <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-comment">// CreateUser åˆ›å»ºç”¨æˆ·</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateUser</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br><span class="hljs-keyword">var</span> params User<br><span class="hljs-keyword">if</span> err := ctx.ShouldBind(&amp;params); err != <span class="hljs-literal">nil</span> &#123;<br>ctx.JSON(http.StatusBadRequest, gin.H&#123;<br><span class="hljs-string">&quot;code&quot;</span>: <span class="hljs-number">400</span>,<br><span class="hljs-string">&quot;msg&quot;</span>:  <span class="hljs-string">&quot;å‚æ•°é”™è¯¯&quot;</span>,<br>&#125;)<br><br>logrus.Errorf(<span class="hljs-string">&quot;params err, %v&quot;</span>, params)<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// ä¸€äº›å…¶ä»–çš„ä¸šåŠ¡é€»è¾‘ ...</span><br><br>ctx.JSON(http.StatusOK, gin.H&#123;<br><span class="hljs-string">&quot;code&quot;</span>: <span class="hljs-number">0</span>,<br><span class="hljs-string">&quot;msg&quot;</span>:  <span class="hljs-string">&quot;åˆ›å»ºæˆåŠŸ&quot;</span>,<br>&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>r := gin.Default()<br>r.POST(<span class="hljs-string">&quot;user&quot;</span>, CreateUser)<br><span class="hljs-keyword">if</span> err := r.Run(<span class="hljs-string">&quot;:8080&quot;</span>); err != <span class="hljs-literal">nil</span> &#123;<br>logrus.Fatalf(<span class="hljs-string">&quot;can not start serve: %v&quot;</span>, err)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å°è£…è¿”å›å€¼"><a href="#å°è£…è¿”å›å€¼" class="headerlink" title="å°è£…è¿”å›å€¼"></a>å°è£…è¿”å›å€¼</h3><p>æˆ‘ä»¬å†™äº†ä¸€æ®µæ—¶é—´ä¹‹åï¼Œä¼šå‘ç°ï¼Œæˆ‘ä»¬çš„è¿”å›å€¼çš„ç»“æ„æ˜¯å›ºå®šçš„ï¼Œä¸ºä»€ä¹ˆä¸æŠ½è±¡ä¸€ä¸‹å‘¢ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç»“æ„ä½“ <code>Resp</code> ï¼Œå¹¶ä¸”å°è£…äº†ä¸¤ä¸ªæ–¹æ³•ç”¨äºæˆåŠŸå’Œå¤±è´¥è¿™ä¸¤ç§çŠ¶æ€çš„è¿”å›</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// resp.go</span><br><br><span class="hljs-comment">// Resp è¿”å›</span><br><span class="hljs-keyword">type</span> Resp <span class="hljs-keyword">struct</span> &#123;<br>Code <span class="hljs-keyword">int</span><br>Msg  <span class="hljs-keyword">string</span><br>Data <span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br><br><span class="hljs-comment">// ErrorResp é”™è¯¯è¿”å›å€¼</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ErrorResp</span><span class="hljs-params">(ctx *gin.Context, code <span class="hljs-keyword">int</span>, msg <span class="hljs-keyword">string</span>, data ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>resp(ctx, code, msg, data...)<br>&#125;<br><br><span class="hljs-comment">// SuccessResp æ­£ç¡®è¿”å›å€¼</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SuccessResp</span><span class="hljs-params">(ctx *gin.Context, msg <span class="hljs-keyword">string</span>, data ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>resp(ctx, <span class="hljs-number">0</span>, msg, data...)<br>&#125;<br><br><span class="hljs-comment">// resp è¿”å›</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">resp</span><span class="hljs-params">(ctx *gin.Context, code <span class="hljs-keyword">int</span>, msg <span class="hljs-keyword">string</span>, data ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>resp := Resp&#123;<br>Code: code,<br>Msg:  msg,<br>Data: data,<br>&#125;<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) == <span class="hljs-number">1</span> &#123;<br>resp.Data = data[<span class="hljs-number">0</span>]<br>&#125;<br>ctx.JSON(http.StatusOK, resp)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ·»åŠ è¿™ä¸ªæ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹ <code>CreateUser</code> è¿™ä¸ªæ–¹æ³•ï¼ŒæˆåŠŸçš„ä» 16 è¡Œå˜åˆ°äº† 12 è¡Œ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// main.go</span><br><span class="hljs-comment">// CreateUser åˆ›å»ºç”¨æˆ·</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateUser</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br><span class="hljs-keyword">var</span> params User<br><span class="hljs-keyword">if</span> err := ctx.ShouldBind(&amp;params); err != <span class="hljs-literal">nil</span> &#123;<br>ErrorResp(ctx, <span class="hljs-number">400</span>, <span class="hljs-string">&quot;å‚æ•°é”™è¯¯&quot;</span>)<br>logrus.Errorf(<span class="hljs-string">&quot;params err, %v&quot;</span>, params)<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// ä¸€äº›å…¶ä»–çš„ä¸šåŠ¡é€»è¾‘ ...</span><br><br>SuccessResp(ctx, <span class="hljs-string">&quot;åˆ›å»ºæˆåŠŸ&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¸¤ä¸ªç—›ç‚¹"><a href="#ä¸¤ä¸ªç—›ç‚¹" class="headerlink" title="ä¸¤ä¸ªç—›ç‚¹"></a>ä¸¤ä¸ªç—›ç‚¹</h3><p>ä¸Šé¢çš„æ–¹æ³•è¿˜ä¸å¤Ÿå®Œæ•´ï¼Œæˆ‘ä»¬è¿˜æ˜¯æœ‰è®¸å¤šé‡å¤çš„é€»è¾‘ï¼Œå¯ä»¥å‘ç°æˆ‘ä»¬åœ¨å†™çš„ç»å¤§å¤šæ•° API å¤§æ¦‚éƒ½æ˜¯è¿™æ ·ï¼š</p><ol><li>å‚æ•°ç»‘å®š &amp; æ ¡éªŒ</li><li>ä¸šåŠ¡é€»è¾‘</li><li>è¿”å›</li></ol><p>è¿™é‡Œé¢æœ‰ä¸¤ä¸ªç—›ç‚¹ï¼š</p><ol><li>å‚æ•°ç»‘å®šçš„ç¯èŠ‚å¯ä¸å¯ä»¥è‡ªåŠ¨å¤„ç†ï¼Ÿ</li><li><p>é”™è¯¯å¯ä¸å¯ä»¥ç›´æ¥è¿”å›ï¼Œä¸æƒ³å†™ç©º <code>return</code>, æ¼å†™å°±æ˜¯ <code>bug</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ä¸æƒ³å†™å¤§é‡è¿™ç§é‡å¤çš„ä»£ç </span><br><span class="hljs-keyword">var</span> params User<br><span class="hljs-keyword">if</span> err := ctx.ShouldBind(&amp;params); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// ä¸‹é¢è¿™ä¸‰è¡Œæ˜¯ä¸æ˜¯å¯ä»¥åˆå¹¶æˆä¸€è¡Œ</span><br>ErrorResp(ctx, <span class="hljs-number">400</span>, <span class="hljs-string">&quot;å‚æ•°é”™è¯¯&quot;</span>)<br>logrus.Errorf(<span class="hljs-string">&quot;params err, %v&quot;</span>, params)<br><span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="ä½¿ç”¨æ¥å£å°è£…è¯·æ±‚"><a href="#ä½¿ç”¨æ¥å£å°è£…è¯·æ±‚" class="headerlink" title="ä½¿ç”¨æ¥å£å°è£…è¯·æ±‚"></a>ä½¿ç”¨æ¥å£å°è£…è¯·æ±‚</h3><p>ä¸Šé¢çš„è¿™ä¸¤ä¸ªç—›ç‚¹æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªè¾…åŠ©å‡½æ•°è§£å†³</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Requester è¯·æ±‚</span><br><span class="hljs-keyword">type</span> Requester <span class="hljs-keyword">interface</span> &#123;<br>Request(ctx *gin.Context) (*Resp, error)<br>&#125;<br><br><span class="hljs-comment">// Handle è¯·æ±‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Handle</span><span class="hljs-params">(r Requester)</span> <span class="hljs-title">gin</span>.<span class="hljs-title">HandlerFunc</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br>resp, err := request(r, ctx)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">var</span> code *errcode.Error<br><span class="hljs-keyword">if</span> !errors.As(err, &amp;code) &#123;<br>code = errcode.Unknown.Wrap(err)<br>&#125;<br><br>resp = &amp;Resp&#123;<br>Code: code.Code,<br>Msg:  code.String(),<br>&#125;<br>_ = ctx.Error(err)<br>&#125;<br>ctx.JSON(http.StatusOK, resp)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">request</span><span class="hljs-params">(r Requester, ctx *gin.Context)</span> <span class="hljs-params">(*controller.Resp, error)</span></span> &#123;<br><span class="hljs-comment">// å‚æ•°ç»‘å®š</span><br><span class="hljs-keyword">if</span> err := ctx.ShouldBind(r); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errcode.ErrParams.Wrap(err)<br>&#125;<br><br><span class="hljs-keyword">return</span> r.Request(ctx)<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬åªéœ€è¦å®ç°è¿™ä¸ª <code>Requester</code>, å†™ API æ—¶åªéœ€è¦å…³æ³¨ä¸šåŠ¡é€»è¾‘å°±å¯ä»¥äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// CreateUser åˆ›å»ºç”¨æˆ·</span><br><span class="hljs-keyword">type</span> CreateUser <span class="hljs-keyword">struct</span> &#123;<br>UserName <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *User)</span> <span class="hljs-title">Request</span><span class="hljs-params">(ctx *gin.Context)</span> <span class="hljs-params">(*Resp, error)</span></span> &#123;<br><span class="hljs-comment">// ä¸šåŠ¡é€»è¾‘</span><br><br><span class="hljs-comment">// è¿”å›æˆåŠŸå€¼</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>r := gin.Default()<br>r.POST(<span class="hljs-string">&quot;user&quot;</span>, Handle(&amp;CreateUser))<br><span class="hljs-keyword">if</span> err := r.Run(<span class="hljs-string">&quot;:8080&quot;</span>); err != <span class="hljs-literal">nil</span> &#123;<br>logrus.Fatalf(<span class="hljs-string">&quot;can not start serve: %v&quot;</span>, err)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç æœ‰ä¸€ä¸ª bug ä¸çŸ¥é“å¤§å®¶å‘ç°æ²¡æœ‰ï¼Œæˆ‘ä»¬ä¸Šä¸€æ¬¡è¯·æ±‚çš„å‚æ•°ä¼šè¢«å¸¦åˆ°ä¸‹ä¸€æ¬¡è¯·æ±‚å½“ä¸­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Handle è¯·æ±‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Handle</span><span class="hljs-params">(r Requester)</span> <span class="hljs-title">gin</span>.<span class="hljs-title">HandlerFunc</span></span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx *gin.Context)</span></span> &#123;<br><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ Requester, é¿å…å°†ä¸Šä¸€æ¬¡çš„å‚æ•°å¸¦åˆ°ä¸‹ä¸€æ¬¡å½“ä¸­</span><br><span class="hljs-keyword">if</span> reflect.TypeOf(r).Kind() != reflect.Ptr &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;must be a pointer&quot;</span>)<br>&#125;<br><br>req := reflect.New(reflect.ValueOf(r).Elem().Type()).Interface().(Requester)<br>resp, err := request(req, ctx)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">var</span> code *errcode.Error<br><span class="hljs-keyword">if</span> !errors.As(err, &amp;code) &#123;<br>code = errcode.Unknown.Wrap(err)<br>&#125;<br><br>resp = &amp;Resp&#123;<br>Code: code.Code,<br>Msg:  code.String(),<br>&#125;<br>_ = ctx.Error(err)<br>&#125;<br>ctx.JSON(http.StatusOK, resp)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¤§æ¦‚è¿™æ ·å·®ä¸å¤šå°± ok äº†ï¼Œè¿˜æœ‰å¾ˆå¤šå¯ä»¥å®Œå–„çš„ç‚¹ï¼Œè¿™é‡Œæœ‰ä¸€äº›æ€è·¯ï¼Œæœ‰çš„å·²ç»åšäº†ï¼Œæœ‰çš„è¿˜åœ¨è·¯ä¸Š</p><ol><li><p>æ¯æ¬¡æ³¨å†Œéƒ½å†™ <code>Handle(&amp;CreateUser)</code> è¿˜æ˜¯æœ‰ç‚¹éº»çƒ¦?</p><p>å¯ä»¥å°è£…ä¸€ä¸‹ <code>gin.IRouter</code> è¿™ä¸ªæ¥å£ï¼Œè¿™æ ·æ³¨å†Œæ¥å£å°±å¯ä»¥å’ŒåŸæ¥ä¸€æ ·äº†</p></li><li><p>å‚æ•°ç»‘å®šå¦‚æœæˆ‘éœ€è¦å¤šæ¬¡ç»‘å®šæ€ä¹ˆåŠ?</p><p>å¯ä»¥æ·»åŠ ä¸€ä¸ªæ¥å£ï¼Œå¦‚æœå®ç°äº†è¿™ä¸ªæ¥å£å°±æ‰§è¡Œä»¥ä¸‹ï¼Œå¯¹äºæœ‰ç‰¹æ®Šçš„å‚æ•°æ ¡éªŒä¹‹ç±»çš„ä¹Ÿå¯ä»¥é‡‡ç”¨ç±»ä¼¼çš„æ–¹å¼å¤„ç†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-keyword">type</span> Binder <span class="hljs-keyword">interface</span> &#123;<br>Bind(ctx *gin.Context) error<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">request</span><span class="hljs-params">(r Requester, ctx *gin.Context)</span> <span class="hljs-params">(*controller.Resp, error)</span></span> &#123;<br><span class="hljs-comment">// å‚æ•°ç»‘å®š</span><br><span class="hljs-keyword">if</span> err := ctx.ShouldBind(r); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errcode.ErrParams.Wrap(err)<br>&#125;<br><br><span class="hljs-comment">// å…¶ä½™å‚æ•°ç»‘å®š</span><br><span class="hljs-keyword">if</span> b, ok := r.(Binder); ok &#123;<br><span class="hljs-keyword">if</span> err := b.Bind(api); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errcode.ErrParams.Wrap(err)<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> r.Request(ctx)<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>æ€ä¹ˆè¾“å‡º API æ–‡æ¡£ï¼Ÿ</p><p>å¯ä»¥å’Œ <code>swagger</code> ä¹‹ç±»çš„ API æ–‡æ¡£ç»“åˆ, åˆ©ç”¨ <code>go generate</code> è‡ªåŠ¨ç”Ÿæˆï¼Œé¡ºä¾¿å¯ä»¥è¿æ¥å£æ³¨å†Œéƒ½ä¸ç”¨äº†ï¼Œæ·»åŠ ä¸€è¡Œæ³¨é‡Šï¼Œè‡ªåŠ¨æ³¨å†Œæ¥å£ï¼Œå¹¶ä¸”è¾“å‡ºæ¥å£æ–‡æ¡£</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// @Router put /api/v1/user</span><br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(u *User)</span> <span class="hljs-title">Request</span><span class="hljs-params">(ctx *gin.Context)</span> <span class="hljs-params">(*Resp, error)</span></span><br></code></pre></td></tr></table></figure></li><li><p>èƒ½ä¸èƒ½å‡å°‘ CURD ä»£ç ?</p><p>å¯ä»¥å®ç°ï¼Œåªéœ€è¦é‡‡ç”¨çº¦å®šçš„é¡¹ç›®æ¥å£ï¼Œå¯ä»¥ åˆ©ç”¨ <code>go generate</code> ç›´æ¥è‡ªåŠ¨ç”Ÿæˆç®€å•çš„ CURD ä»£ç </p></li></ol><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>å°æŠ€å·§</tag>
      
      <tag>api</tag>
      
      <tag>gin</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å–„ç”¨å·¥å…·ä¹‹postmané«˜çº§ç”¨æ³•æ¦‚è¿°</title>
    <link href="/post/45050.html"/>
    <url>/post/45050.html</url>
    
    <content type="html"><![CDATA[<p>POSTMAN æ˜¯æˆ‘åœ¨å¼€å‘è¿‡ç¨‹å½“ä¸­æœ€å¸¸ç”¨åˆ°çš„ API æµ‹è¯•å·¥å…·ä¹‹ä¸€ï¼Œè™½ç„¶å¹¶ä¸å®Œç¾ï¼Œä½†ä¹Ÿæ˜¯ç›®å‰ä¸ªäººè®¤ä¸ºåœ¨ API æµ‹è¯•æ—¶æœ€å¥½ç”¨çš„å®¢æˆ·ç«¯å·¥å…·ä¹‹ä¸€ã€‚</p><p>æœ¬æ–‡é€‚ç”¨äºåç«¯ï¼Œå‰ç«¯ï¼Œç§»åŠ¨ç«¯ä»¥åŠæµ‹è¯•çš„åŒå­¦ï¼Œåˆ†ä¸‰å¤§éƒ¨åˆ†ä»æœ€ç®€å•çš„ç•Œé¢æ“ä½œå¼€è®²ï¼Œç„¶åæ¶‰åŠåˆ°å˜é‡ã€è„šæœ¬ä»¥åŠä¸€äº›äº‘æœåŠ¡ç›¸å…³çš„åŠŸèƒ½ï¼Œæœ€åå°†é€‚é…å‡ ä¸ªæ¡ˆä¾‹è®²è§£æ€ä¹ˆä½¿ç”¨ POSTMAN æé«˜æˆ‘ä»¬çš„å·¥ä½œæ•ˆç‡ã€‚æœ¬æ–‡å‰åŠéƒ¨åˆ†åŒ…å«è¾ƒå¤šåŸºç¡€åŠŸèƒ½è®²è§£ï¼Œå¯¹å·²ç»æ¯”è¾ƒç†Ÿæ‚‰ä½¿ç”¨çš„åŒå­¦ï¼Œå¯ä»¥é€‰æ‹©æ€§çš„è·³è¿‡éƒ¨åˆ†å†…å®¹ã€‚</p><a id="more"></a><blockquote><p>PS: æœ¬æ–‡åŒ…å«å¤§é‡ç¤ºä¾‹å›¾ç‰‡ï¼Œå¤§å±é£Ÿç”¨æ•ˆæœæœ€ä½³ï¼Œpostman çœ‹è¿™ä¸€ç¯‡æ–‡ç« å°±å¤Ÿç”¨äº†</p></blockquote><h2 id="é›¶ã€åº"><a href="#é›¶ã€åº" class="headerlink" title="é›¶ã€åº"></a>é›¶ã€åº</h2><p>æˆ‘æ‰€æœ‰çš„æ–‡ç« åŸºæœ¬éƒ½æ¥è‡ªå¹³æ—¶å¼€å‘ä¸­çš„éœ€æ±‚ï¼Œå‰æ®µæ—¶é—´åœ¨å…¬å¸é€šè¿‡ç½‘å…³è°ƒç”¨æ¥å£ï¼Œæµ‹è¯•å¾ˆéº»çƒ¦ï¼Œç„¶åå°±æƒ³ä½¿ç”¨åœ¨æœ¬åœ°ç›´æ¥è°ƒç”¨ï¼Œç”±äºæœ‰ç­¾åæœºåˆ¶ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ SDK è¿›è¡Œè°ƒç”¨ï¼Œåé¢æ¯”è¾ƒå®Œæ•´çš„çœ‹äº†ä¸€ä¸‹<code>postman</code>çš„æ–‡æ¡£ï¼Œæ„Ÿè§‰å‘ç°äº†æ–°å¤§é™†ã€‚</p><blockquote><p>æ³¨: æœ¬æ–‡ä¼šä»‹ç» postman çš„å¸¸ç”¨ä»¥åŠä¸å¤ªå¸¸ç”¨çš„é«˜çº§ç”¨æ³•ï¼Œä½†æ˜¯ä¸ä¼šæ‰€æœ‰æ–¹é¢éƒ½å»åšç»†èŠ‚ä»‹ç»ï¼Œå¸Œæœ›å¯ä»¥èµ·åˆ°çš„æŠ›ç –å¼•ç‰çš„ä½œç”¨</p></blockquote><h2 id="ä¸€ã€ç®€è¦ä»‹ç»"><a href="#ä¸€ã€ç®€è¦ä»‹ç»" class="headerlink" title="ä¸€ã€ç®€è¦ä»‹ç»"></a>ä¸€ã€ç®€è¦ä»‹ç»</h2><p><code>postman</code>æ˜¯ä¸€æ¬¾å¼ºå¤§çš„ API æ¥å£æµ‹è¯•å·¥å…·ï¼Œæœ‰ chrome appã€chrome æ‰©å±•ã€æ¡Œé¢ç‰ˆï¼Œæ¨èä½¿ç”¨æœ€æ–°æœ€å¼ºå¤§çš„æ¡Œé¢ç‰ˆæœ¬ã€‚ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹åŠŸèƒ½ï¼Œæœ¬æ–‡ä¹Ÿä¼šå›´ç»•ä»¥ä¸‹åŠŸèƒ½ç‚¹å±•å¼€è®²è§£:</p><blockquote><p>æœ‰ â˜ æ ‡è¯†è¡¨ç¤ºä¸ºäº‘æœåŠ¡</p></blockquote><ol><li>API æµ‹è¯•</li><li>å˜é‡</li><li>ä»£ç ç”Ÿæˆ</li><li><strong>Script</strong></li><li>API ä»£ç†</li><li>â˜ï¸ API æ–‡æ¡£</li><li>â˜ï¸ Mock Server</li><li>â˜ï¸ æ¥å£ç›‘æ§</li><li>â˜ï¸ Postman API</li></ol><h2 id="äºŒã€æ­£æ–‡"><a href="#äºŒã€æ­£æ–‡" class="headerlink" title="äºŒã€æ­£æ–‡"></a>äºŒã€æ­£æ–‡</h2><h3 id="2-1ã€ä½¿ç”¨ç®€ä»‹"><a href="#2-1ã€ä½¿ç”¨ç®€ä»‹" class="headerlink" title="2.1ã€ä½¿ç”¨ç®€ä»‹"></a>2.1ã€ä½¿ç”¨ç®€ä»‹</h3><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œpostman ç•Œé¢ååˆ†ä¸°å¯Œï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰å¸¸ç”¨çš„åŠŸèƒ½éƒ½èƒ½ä¸€è§ˆæ— ä½™</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/Snipaste_2019-06-04_01-25-22.png" alt=""></p><h3 id="2-2ã€API-æµ‹è¯•"><a href="#2-2ã€API-æµ‹è¯•" class="headerlink" title="2.2ã€API æµ‹è¯•"></a>2.2ã€API æµ‹è¯•</h3><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒAPI æµ‹è¯•é¡µé¢ååˆ†çš„æ˜“ç”¨ï¼Œæ“ä½œç•Œé¢ä¸€ç›®äº†ç„¶ã€‚</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190605235605.png" alt=""></p><h4 id="2-2-1ã€è®¤è¯"><a href="#2-2-1ã€è®¤è¯" class="headerlink" title="2.2.1ã€è®¤è¯"></a>2.2.1ã€è®¤è¯</h4><p>æ¥å£çš„è°ƒç”¨å¸¸å¸¸éœ€è¦é€šè¿‡ç™»å½•ï¼Œpostman é¢„è®¾ä¸€äº›å¸¸è§çš„è®¤è¯æ–¹å¼ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„ Basic Auth, OAuth2.0 ç­‰ï¼Œè¿™äº›é¢„è®¾çš„åè®®åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šååˆ†çš„æœ‰ç”¨ã€‚</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190605235911.png" alt=""></p><p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œé»˜è®¤é€‰é¡¹æ˜¯ä»çˆ¶ç›®å½•ä¸­ç»§æ‰¿ï¼Œæ‰€ä»¥å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ª Collection æˆ–è€…æ˜¯ä¸‹é¢çš„æ–‡ä»¶å¤¹ä¸­è®¾ç½®è®¤è¯æ–¹å¼ï¼Œè¿™æ—¶å€™æ•´ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰çš„ API é»˜è®¤éƒ½å¯ä»¥é€šè¿‡è®¤è¯</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190606000414.png" alt=""></p><h4 id="2-2-2ã€å‚æ•°"><a href="#2-2-2ã€å‚æ•°" class="headerlink" title="2.2.2ã€å‚æ•°"></a>2.2.2ã€å‚æ•°</h4><p>æ‰€æœ‰ K-V æ¨¡å¼çš„å‚æ•°éƒ½å¯ä»¥æ‰¹é‡ç¼–è¾‘, åŒ…æ‹¬ QueryString, Body, Header, æ‰¹é‡ç¼–è¾‘çš„åŠŸèƒ½å¯ä»¥å¿«é€Ÿå¤åˆ¶æµè§ˆå™¨ä¸­çš„è¯·æ±‚å‚æ•°ä¿¡æ¯åˆ° postman ä¸­</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/1559750920570.png" alt=""></p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190606001204.png" alt=""></p><h3 id="2-3ã€å˜é‡"><a href="#2-3ã€å˜é‡" class="headerlink" title="2.3ã€å˜é‡"></a>2.3ã€å˜é‡</h3><p>postman ä¸­ä¸€å…±å­˜åœ¨äº”ç§å˜é‡ç±»å‹ï¼Œ å…¨å±€å˜é‡ï¼ŒCollection/æ–‡ä»¶å¤¹ä¸­çš„å˜é‡ï¼Œç¯å¢ƒå˜é‡ï¼Œæ•°æ®å˜é‡ï¼Œæœ¬åœ°å˜é‡</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190606001837.png" alt=""></p><p>å¦‚å›¾æ‰€æœ‰å˜é‡å±‚çº§ä»å¤–åˆ°å†…ï¼Œå¦‚æœå‡ºç°é‡å¤çš„å˜é‡åï¼Œé‡Œé¢çš„ä¼šè¦†ç›–å¤–éƒ¨çš„å˜é‡</p><h4 id="2-3-2ã€å˜é‡è®¾ç½®"><a href="#2-3-2ã€å˜é‡è®¾ç½®" class="headerlink" title="2.3.2ã€å˜é‡è®¾ç½®"></a>2.3.2ã€å˜é‡è®¾ç½®</h4><h5 id="2-3-2-1ã€Collection-å˜é‡"><a href="#2-3-2-1ã€Collection-å˜é‡" class="headerlink" title="2.3.2.1ã€Collection å˜é‡"></a>2.3.2.1ã€Collection å˜é‡</h5><p>ç‚¹å‡»ç¼–è¾‘ Collectionï¼Œå¦‚å›¾æ‰€ç¤º</p><p>INITIAL VALUE: è¿™ä¸ªå€¼æ˜¯ç”¨äºåˆ†äº«ç»™å›¢é˜Ÿçš„æˆå‘˜çš„æ—¶å€™å±•ç¤ºçš„å€¼</p><p>CURRENT VALUE: è¡¨ç¤ºå½“å‰å®é™…çš„å€¼</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190606002811.png" alt=""></p><h5 id="2-3-2-2ã€ç¯å¢ƒå˜é‡-amp-å…¨å±€å˜é‡"><a href="#2-3-2-2ã€ç¯å¢ƒå˜é‡-amp-å…¨å±€å˜é‡" class="headerlink" title="2.3.2.2ã€ç¯å¢ƒå˜é‡ &amp; å…¨å±€å˜é‡"></a>2.3.2.2ã€ç¯å¢ƒå˜é‡ &amp; å…¨å±€å˜é‡</h5><p>ç¯å¢ƒå˜é‡å’Œå…¨å±€å˜é‡çš„è®¾ç½®åœ¨ postman çš„å³ä¸Šè§’ï¼Œè®¾ç½®ç•Œé¢å’Œä¸Šå›¾çš„ Collection ç•Œé¢ç±»ä¼¼</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190606003057.png" alt=""></p><h4 id="2-3-2ã€å˜é‡çš„ä½¿ç”¨"><a href="#2-3-2ã€å˜é‡çš„ä½¿ç”¨" class="headerlink" title="2.3.2ã€å˜é‡çš„ä½¿ç”¨"></a>2.3.2ã€å˜é‡çš„ä½¿ç”¨</h4><p>å˜é‡é€šè¿‡ <code>&#123;&#123;VAR_NAME&#125;&#125;</code>, åœ¨å®é™…è¯·æ±‚çš„æ—¶å€™å˜é‡å¯ä»¥è®¾ç½®ä¸ºå®é™…çš„å€¼ï¼Œå˜é‡ä¹Ÿå¯ä»¥è¢«è„šæœ¬è®¾ç½®, ä¿®æ”¹, è¯»å–, è¿™ä¸ªç‰¹æ€§èƒ½å¤Ÿè®©æˆ‘ä»¬æœ‰äº†å¾ˆå¤šå¯èƒ½</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190606002133.png" alt=""></p><h4 id="2-3-3ã€åŠ¨æ€å˜é‡"><a href="#2-3-3ã€åŠ¨æ€å˜é‡" class="headerlink" title="2.3.3ã€åŠ¨æ€å˜é‡"></a>2.3.3ã€åŠ¨æ€å˜é‡</h4><p>postman é¢„è®¾äº†å‡ ä¸ªåŠ¨æ€å˜é‡<code>&#123;&#123;$guid&#125;&#125;</code>, å¯ä»¥è·å–å½“å‰çš„æ—¶é—´æˆ³ç­‰ä¿¡æ¯</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190606002440.png" alt=""></p><h3 id="2-4ã€ä»£ç ç”Ÿæˆ"><a href="#2-4ã€ä»£ç ç”Ÿæˆ" class="headerlink" title="2.4ã€ä»£ç ç”Ÿæˆ"></a>2.4ã€ä»£ç ç”Ÿæˆ</h3><p>å¦‚å›¾æ‰€ç¤ºï¼Œpostman æä¾›äº†å¾ˆå¤šè¯­è¨€ä»¥åŠä¸€äº›å¸¸ç”¨æ¡†æ¶çš„ä»£ç ï¼Œæˆ‘ä»¬åœ¨å®é™…ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ç›´æ¥å¤åˆ¶ä»£ç èŠ‚çº¦è®¸å¤šæ—¶é—´</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190606003416.png" alt=""></p><h3 id="2-5ã€Script-åˆ’é‡ç‚¹"><a href="#2-5ã€Script-åˆ’é‡ç‚¹" class="headerlink" title="2.5ã€Script(åˆ’é‡ç‚¹)"></a>2.5ã€Script(åˆ’é‡ç‚¹)</h3><h4 id="2-5-1ã€ç®€ä»‹"><a href="#2-5-1ã€ç®€ä»‹" class="headerlink" title="2.5.1ã€ç®€ä»‹"></a>2.5.1ã€ç®€ä»‹</h4><p>åœ¨ POSTMAN ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ç¼–å†™ JavaScript è„šæœ¬å¢å¼ºå…¶åŠŸèƒ½ï¼ŒPOSTMAN çš„è„šæœ¬è¿è¡Œåœ¨å…¶æä¾›çš„æ²™ç›’ç¯å¢ƒä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç‚¹å‡»å·¦ä¸‹è§’æŒ‰é’®å¯ä»¥å‡ºç°è°ƒè¯•çª—å£ï¼Œä¼šæ˜¾ç¤ºè„šæœ¬çš„ debug ä¿¡æ¯</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190618000158.png" alt=""></p><p>åœ¨ postman ä¸­ä¸€å…±æ”¯æŒä¸¤ç§è„šæœ¬ï¼Œåˆ†åˆ«æ˜¯ Pre Request Script, Test Scriptï¼Œè¿™ä¸¤ç§è„šæœ¬åˆ†åˆ«åœ¨è¯·æ±‚å‰ä»¥åŠè¯·æ±‚åç”Ÿæ•ˆï¼Œç¬¬ä¸€ç§æˆ‘å¸¸ç”¨äºç”Ÿæˆå„ç§ç­¾åæˆ–è€…æ˜¯éœ€è¦æå‰è¯·æ±‚è·å–ä¸€äº› tokenï¼Œåé¢ä¸€ç§æ›´å¸¸è§äºé›†æˆæµ‹è¯•ä¸­ï¼Œç”¨äºæ§åˆ¶æµ‹è¯•çš„å‰åé¡ºåºï¼Œä¾‹å¦‚åé¢ä¼šè®²åˆ°çš„æ¡ˆä¾‹ï¼Œåœ¨ CD å‰é›†æˆæ¥å£å›å½’æµ‹è¯•ï¼Œç¡®ä¿ä¸»æµç¨‹æ— è¯¯å†ä¸Šçº¿ç­‰ã€‚</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190618000827.png" alt=""></p><h4 id="2-5-2ã€API"><a href="#2-5-2ã€API" class="headerlink" title="2.5.2ã€API"></a>2.5.2ã€API</h4><p>postman æä¾›äº†ä¸€äº› APIï¼Œ<code>pm.*</code>, ä¾‹å¦‚:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">pm.global.* <span class="hljs-comment"># å…¨å±€å˜é‡ç›¸å…³</span><br>pm.environment.* <span class="hljs-comment"># ç¯å¢ƒå˜é‡ç›¸å…³</span><br>pm.request.* <span class="hljs-comment"># è¯·æ±‚ç›¸å…³, æ³¨æ„è¯·æ±‚ç›¸å…³çš„ä¿¡æ¯æ—¶åªè¯»çš„ä¸èƒ½ä¿®æ”¹</span><br>pm.sendRequest() <span class="hljs-comment"># å‘é€è¯·æ±‚</span><br><br><span class="hljs-comment"># ä¸‹é¢è¿™äº›åªèƒ½ç”¨äº test script</span><br>pm.response.* <span class="hljs-comment"># è¿”å›å€¼ç›¸å…³</span><br>pm.cookies.* <span class="hljs-comment"># cookies</span><br>pm.test() <span class="hljs-comment"># æ‰§è¡Œæµ‹è¯•</span><br>...<br></code></pre></td></tr></table></figure><p>é™¤æ­¤ä¹‹å¤–è¿˜å†…ç½®äº†ä¸€äº›å¸¸ç”¨çš„ npm åŒ…å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä¾‹å¦‚:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">ajv â†’ v6.6.2<br>atob â†’ v2.1.2<br>btoa â†’ v1.2.1<br>chai â†’ v4.2.0<br>cheerio â†’ v0.22.0<br>...<br></code></pre></td></tr></table></figure><p>æ›´å¤š API ä¿¡æ¯å¯ä»¥è®¿é—®å®˜æ–¹æ–‡æ¡£æŸ¥çœ‹: <a href="https://learning.getpostman.com/docs/postman/scripts/postman_sandbox_api_reference">Postman Sandbox API reference</a></p><h4 id="2-5-3ã€Pre-Request-Script"><a href="#2-5-3ã€Pre-Request-Script" class="headerlink" title="2.5.3ã€Pre Request Script"></a>2.5.3ã€Pre Request Script</h4><p>è¯·æ±‚å‰æ‰§è¡Œè¯¥è„šæœ¬ï¼Œä¸€èˆ¬ç”¨äºæå‰è®¾ç½®ä¸€äº›ç­¾åä¿¡æ¯ï¼Œä¸Šæ–‡æåˆ°è¿‡è™½ç„¶ postman å°†è¯·æ±‚çš„ä¿¡æ¯æš´éœ²ç»™äº†æˆ‘ä»¬ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶ä¸èƒ½ä¿®æ”¹ï¼Œé‚£æˆ‘ä»¬è¦å¦‚ä½•æ‰èƒ½å¤Ÿå°†æˆ‘ä»¬ç”Ÿæˆçš„å€¼æ”¾åœ¨è¯·æ±‚ä¹‹ä¸­å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ï¼š å˜é‡ï¼Œå¦‚æœç­¾åä¿¡æ¯ä»…åœ¨ header ä¹‹ä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ’å…¥æ–°çš„ header ä¿¡æ¯</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­</p><p>è°ƒç”¨ç¬¬ä¸‰æ–¹æœåŠ¡çš„æ—¶å€™å¾€å¾€éœ€è¦ç”Ÿæˆä¸€ä¸ª Token è¿›è¡Œé‰´æƒï¼Œè¿™ä¸ªç¤ºä¾‹ä¼šåˆ†åˆ«ç”Ÿæˆä¸€ä¸ªæ—¶é—´æˆ³ï¼Œä»¥åŠåˆ©ç”¨è‡ªå¸¦çš„<code>CryptoJS</code>åº“è¿›è¡Œ<code>AES</code>åŠ å¯†ç­¾åï¼Œå¹¶ä¸”åˆ†åˆ«ä½¿ç”¨è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæ–°å¢ header çš„æ–¹å¼æ³¨å…¥åˆ°è¯·æ±‚ä¹‹ä¸­</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190710224627.png" alt=""></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// ä»ç¯å¢ƒå˜é‡ä¸­è·å–å¯†é’¥ä¸appid</span><br><span class="hljs-keyword">let</span> secret = pm.environment.get(<span class="hljs-string">&quot;secret&quot;</span>);<br><span class="hljs-keyword">let</span> appid = pm.environment.get(<span class="hljs-string">&quot;appid&quot;</span>);<br><br><span class="hljs-comment">// è·å–å½“å‰æ—¶é—´æˆ³</span><br><span class="hljs-keyword">let</span> time = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;time:&quot;</span>, time + <span class="hljs-string">&quot;&quot;</span>);<br><br><span class="hljs-comment">// ç›´æ¥å‘ Header ä¸­æ’å…¥ä¸€æ¡æ–°çš„è®°å½•</span><br>pm.request.headers.upsert(&#123; <span class="hljs-attr">key</span>: <span class="hljs-string">&quot;time&quot;</span>, <span class="hljs-attr">value</span>: time &#125;);<br><br><span class="hljs-comment">// ç­¾å</span><br><span class="hljs-keyword">let</span> sign = CryptoJS.AES.encrypt(time + appid, secret);<br><br><span class="hljs-comment">// è®¾ç½®ç¯å¢ƒå˜é‡</span><br>pm.environment.set(<span class="hljs-string">&quot;sign&quot;</span>, sign.ciphertext.toString().toUpperCase());<br></code></pre></td></tr></table></figure><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190710224357.png" alt=""></p><h4 id="2-5-4ã€Test-Script"><a href="#2-5-4ã€Test-Script" class="headerlink" title="2.5.4ã€Test Script"></a>2.5.4ã€Test Script</h4><p>æµ‹è¯•è„šæœ¬å’Œä¸€åŠçš„å•å…ƒæµ‹è¯•å¤§åŒå°å¼‚ï¼Œè¿™é‡Œç®€è¦ä»‹ç»æ¯”è¾ƒå¸¸ç”¨å’Œé‡è¦çš„ä¸¤ä¸ªåŠŸèƒ½ï¼Œè¯¦ç»†äº†è§£å¯ä»¥<a href="https://learning.getpostman.com/docs/postman/scripts/test_examples/">ç‚¹å‡»æŸ¥çœ‹æ–‡æ¡£</a></p><ul><li><p>åŸºæœ¬çš„æµ‹è¯•è¯­å¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript">pm.test(<span class="hljs-string">&quot;æµ‹è¯•åç§°&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-comment">// æ–­è¨€</span><br>  pm.expect(pm.response.responseTime).to.be.below(<span class="hljs-number">200</span>);<br>&#125;);<br></code></pre></td></tr></table></figure></li><li><p>æµç¨‹æ§åˆ¶ï¼Œå¯ä»¥å¯¹ API æµ‹è¯•çš„é¡ºåºè¿›è¡Œæ§åˆ¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// è®¾ç½®ä¸‹ä¸€ä¸ªä¼šè¢«æ‰§è¡Œçš„è¯·æ±‚</span><br>postman.setNextRequest(<span class="hljs-string">&quot;request_name&quot;</span>);<br><span class="hljs-comment">// ç»ˆç«¯æµç¨‹</span><br>postman.setNextRequest(<span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></figure></li></ul><p>è¿è¡Œä¸€å…±æœ‰ä¸¤ç§æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯ Collection Run ä»¥åŠ newman cli æ‰§è¡Œï¼Œ newman ä¼šåœ¨åæ–‡çš„æ¡ˆä¾‹ä¹‹ä¸­æåˆ°</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190712004751.png" alt=""></p><p>å¯ä»¥çœ‹åˆ°æ‰§è¡Œç»“æœè¯¦ç»†çš„ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥å¯¼å‡º</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190712005755.png" alt=""></p><h3 id="2-6ã€API-ä»£ç†"><a href="#2-6ã€API-ä»£ç†" class="headerlink" title="2.6ã€API ä»£ç†"></a>2.6ã€API ä»£ç†</h3><blockquote><p>è¿™ä¸ªåŠŸèƒ½å¯¹äºå®¢æˆ·ç«¯è°ƒè¯•çš„åŒå­¦ååˆ†æœ‰ç”¨ï¼Œå¯ä»¥é€šè¿‡ POSTMAN æä¾›çš„ä»£ç†åŠŸèƒ½ï¼Œå°†å®¢æˆ·ç«¯çš„è¯·æ±‚ä¿å­˜åœ¨å†å²è®°å½•æˆ–è€…æ˜¯ä¸€ä¸ª Collection ä¸­</p></blockquote><p>é¦–å…ˆæˆ‘ä»¬åœ¨ POSTMAN è¿›è¡Œå¦‚ä¸‹è®¾ç½®ï¼Œç‚¹å‡» Filters è¿˜å¯ä»¥å¯¹è¯·æ±‚çš„æ–¹æ³•ï¼ŒURL è¿›è¡Œä¸€äº›è¿‡æ»¤çš„æ“ä½œ</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190710225227.png" alt=""></p><p>æ¥ä¸‹æ¥ï¼Œä»¥å®‰å“æ‰‹æœºä¸ºä¾‹ï¼Œæˆ‘ä»¬éœ€è¦å’Œç”µè„‘å¤„äºåŒä¸€ç½‘æ®µï¼Œå¹¶ä¸”åœ¨ WIFI è®¾ç½®é‡ŒåŠ ä¸Šä»£ç†</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/Screenshot_2019-07-11-23-43-13-112_com.android.se.png?x-oss-process=image/resize,h_600" alt=""></p><p>ç„¶åå†åˆ°æˆ‘ä»¬ä¹‹å‰è®¾ç½®çš„ Collection ä¸­å°±å¯ä»¥çœ‹åˆ°è¯·æ±‚çš„è®°å½•äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºåœ¨æ‰‹æœºä¸Šè®¾ç½®äº†ä»£ç†ä¹‹åè®¿é—®äº†ä¸€ä¸‹ç™¾åº¦ï¼Œæ‰€æœ‰çš„è¯·æ±‚é“¾æ¥ä»¥åŠå‚æ•°éƒ½ä¼šå±•ç¤ºåœ¨ postman ä¸­</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190711234614.png" alt=""></p><h3 id="2-7ã€â˜ï¸-API-æ–‡æ¡£"><a href="#2-7ã€â˜ï¸-API-æ–‡æ¡£" class="headerlink" title="2.7ã€â˜ï¸ API æ–‡æ¡£"></a>2.7ã€â˜ï¸ API æ–‡æ¡£</h3><blockquote><p>æ¥ä¸‹æ¥ï¼Œå°†ä¼šæ˜¯äº‘æœåŠ¡ç›¸å…³çš„åŠŸèƒ½ï¼Œå¦‚æœä¸èƒ½ä½¿ç”¨äº‘æœåŠ¡è¿™ä¸€è¶´å¯ä»¥è·³è¿‡</p></blockquote><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190710231728.png" alt=""></p><p>å¦‚å›¾æ‰€ç¤ºæ–‡æ¡£å‘å¸ƒæˆåŠŸä¹‹åï¼Œå³å¯çœ‹åˆ°æ–‡æ¡£çš„è¯¦æƒ…ï¼Œå·²ç» API è¯¦æƒ…ï¼Œå¹¶ä¸”å³ä¾§æœ‰ä»£ç ç”Ÿæˆå™¨ï¼Œå¯ä»¥ç›´æ¥å¤åˆ¶å¯¹åº”çš„ä»£ç ï¼Œååˆ†æ–¹ä¾¿</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190710231917.png" alt=""></p><p>è¯¦ç»†ç¤ºä¾‹å¯ä»¥ç‚¹å‡»æŸ¥çœ‹ <a href="https://documenter.getpostman.com/view/364695/RWaGUpsy?version=latest">We å·å¤§ API</a> ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æˆªæ­¢åˆ°æ–‡ç« å‘å¸ƒæ—¶ï¼Œpostman å¯¹å…è´¹è´¦æˆ·æ–‡æ¡£æœ‰ä¸€å®šçš„é™åˆ¶æ¯æœˆå…¬å¼€æ–‡æ¡£åªèƒ½æœ‰ 1000 çš„è®¿é—®</p><h3 id="2-8ã€â˜ï¸-Mock-Server"><a href="#2-8ã€â˜ï¸-Mock-Server" class="headerlink" title="2.8ã€â˜ï¸ Mock Server"></a>2.8ã€â˜ï¸ Mock Server</h3><p>åŒæ ·ååˆ†çš„ç®€å•ï¼Œå³é”® Collection ç‚¹å‡» mock å¹¶æŒ‰ç…§å¦‚å›¾æ‰€ç¤ºï¼Œè¿›è¡Œä¸€äº›ç®€å•çš„é…ç½®å³å¯ï¼Œæ³¨æ„ mock server çš„æ•°æ®æ˜¯è¯·æ±‚çš„æ—¶å€™ save example çš„æ•°æ®ï¼Œå¹¶ä¸”åŒæ ·å…è´¹è´¦æˆ·ï¼Œä¸€ä¸ªæœˆåªèƒ½è°ƒç”¨ 1000 æ¬¡ APIï¼Œå¯ä»¥ç‚¹å‡»æŸ¥çœ‹ <a href="https://documenter.getpostman.com/view/364695/RWaGUpsy?version=latest">We å·å¤§ API</a> ï¼Œé‡Œé¢çš„æ–‡æ¡£ç¤ºä¾‹å°±æ˜¯ä½¿ç”¨çš„ Mock Server</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190710232547.png" alt=""></p><h3 id="2-9ã€â˜ï¸-æ¥å£ç›‘æ§"><a href="#2-9ã€â˜ï¸-æ¥å£ç›‘æ§" class="headerlink" title="2.9ã€â˜ï¸ æ¥å£ç›‘æ§"></a>2.9ã€â˜ï¸ æ¥å£ç›‘æ§</h3><p>åŒæ ·ååˆ†çš„ç®€å•ï¼Œå³é”® Collection ç‚¹å‡» monitor collection å¹¶æŒ‰ç…§å¦‚å›¾æ‰€ç¤ºè¿›è¡Œä¸€äº›é…ç½®ï¼Œå¯ä»¥é€‰æ‹© é¢‘ç‡ï¼Œæ¥å£ç›‘æ§çš„ä½ç½®ï¼Œè§¦å‘æ—¶é—´ç­‰å­—æ®µ</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190710232823.png" alt=""></p><h3 id="2-10ã€â˜ï¸-Postman-API"><a href="#2-10ã€â˜ï¸-Postman-API" class="headerlink" title="2.10ã€â˜ï¸ Postman API"></a>2.10ã€â˜ï¸ Postman API</h3><p>é™¤æ­¤ä¹‹å¤– POSTMAN è¿˜æä¾›å¼€æ”¾çš„ API ä½¿å…¶æœ‰æ›´å¤šçš„å¯èƒ½ï¼Œå¦‚å›¾æ‰€ç¤ºè·å– API Keyï¼Œå…·ä½“çš„ä½¿ç”¨è¯·ç‚¹<a href="https://docs.api.getpostman.com/?_ga=2.113542607.916957680.1562768130-1454391695.1559579723&amp;version=latest">å‡»æŸ¥çœ‹ API æ–‡æ¡£</a>ï¼Œ é€šè¿‡ API æˆ‘ä»¬å¯ä»¥å®ç°ä¸€äº›è‡ªåŠ¨åŒ–çš„æ“ä½œï¼Œä¹Ÿå¯ä»¥è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£ï¼Œç„¶åç”¨ github pages è¿›è¡Œéƒ¨ç½²ï¼Œä¸å—è´¦æˆ·é™åˆ¶ç­‰ç­‰ï¼Œç”±äºæ–‡ç« ç¯‡å¹…æœ‰é™ï¼Œè¿™é‡Œå°±ä¸å±•å¼€è®²äº†ã€‚</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190710233355.png" alt=""></p><h2 id="ä¸‰ã€ä½¿ç”¨æ¡ˆä¾‹"><a href="#ä¸‰ã€ä½¿ç”¨æ¡ˆä¾‹" class="headerlink" title="ä¸‰ã€ä½¿ç”¨æ¡ˆä¾‹"></a>ä¸‰ã€ä½¿ç”¨æ¡ˆä¾‹</h2><h3 id="3-1ã€å’Œ-CI-CD-è”åŠ¨ï¼Œè¿›è¡Œæ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•"><a href="#3-1ã€å’Œ-CI-CD-è”åŠ¨ï¼Œè¿›è¡Œæ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•" class="headerlink" title="3.1ã€å’Œ CI/CD è”åŠ¨ï¼Œè¿›è¡Œæ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•"></a>3.1ã€å’Œ CI/CD è”åŠ¨ï¼Œè¿›è¡Œæ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•</h3><blockquote><p>postman æä¾›äº†ä¸€ä¸ªå‘½åè¡Œå·¥å…·ï¼Œnewman, é€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥åœ¨æˆ‘ä»¬çš„ CI /CD çš„æµç¨‹ä¸ŠåŠ å…¥æ¥å£è‡ªåŠ¨åŒ–å›å½’çš„æµç¨‹ï¼Œç¡®ä¿æœåŠ¡çš„ç¨³å®šæ€§</p></blockquote><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä»¥ gitlab ci/cd ä¸ºä¾‹ï¼Œé…ç½®ä¸€ä¸ªç®€å•çš„æ¥å£å›å½’</p><p>newman å…·ä½“çš„ä½¿ç”¨æ–¹æ³•å¯ä»¥æŸ¥çœ‹å®˜æ–¹çš„æ–‡æ¡£æˆ–è€…æ˜¯<a href="https://github.com/postmanlabs/newman">github ä»“åº“</a>çš„ä»‹ç», è¿™é‡Œä¸å†èµ˜è¿°ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä¸€ä¸‹ç®€å•çš„ä½¿ç”¨</p><p>é¦–å…ˆæ˜¯ <code>.gitlab-ci.yml</code> çš„é…ç½®</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">stages:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">test</span><br><br><span class="hljs-attr">api_test:</span><br>  <span class="hljs-attr">stage:</span> <span class="hljs-string">test</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">node:11.15.0</span><br>  <span class="hljs-attr">before_script:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span> <span class="hljs-string">-g</span> <span class="hljs-string">newman</span><br>  <span class="hljs-attr">script:</span><br>    <span class="hljs-comment"># æ­¤å¤„æ‰§è¡Œçš„æ˜¯å®˜æ–¹çš„ä¸€ä¸ªä¾‹å­ï¼Œrun åé¢å¯ä»¥æ˜¯å¯¼å‡ºçš„Collectionçš„æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯åˆ†äº«å‡ºæ¥çš„Collection</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">newman</span> <span class="hljs-string">run</span> <span class="hljs-string">&quot;https://www.getpostman.com/collections/631643-f695cab7-6878-eb55-7943-ad88e1ccfd65-JsLv&quot;</span><br>  <span class="hljs-attr">tags:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">gitlab-org</span><br></code></pre></td></tr></table></figure><p>å¦‚ä¸‹å›¾æ‰€ç¤ºæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…·ä½“çš„æ‰§è¡Œç»“æœï¼Œè¿”å›çš„ä¿¡æ¯ä¹Ÿæ¯”è¾ƒè¯¦ç»†ï¼Œå’Œä¸Šæ–‡çš„ Test Script è„šæœ¬ç»“åˆå°±å¯ä»¥è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ¥å£å›å½’æµ‹è¯•çš„æ•ˆæœ</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190712002216.png" alt=""></p><p><a href="https://gitlab.com/mohuishou/postman-ci/pipelines">ç‚¹å‡»å¯ä»¥æŸ¥çœ‹è¿™ä¸ª demo</a></p><h3 id="3-2ã€æœ¬åœ°æ¥å£æ–‡æ¡£"><a href="#3-2ã€æœ¬åœ°æ¥å£æ–‡æ¡£" class="headerlink" title="3.2ã€æœ¬åœ°æ¥å£æ–‡æ¡£"></a>3.2ã€æœ¬åœ°æ¥å£æ–‡æ¡£</h3><p>åœ¨ä¸Šæ–‡æˆ‘ä»¬æœ‰æåˆ°è¿‡ï¼Œpostman çš„äº‘æ–‡æ¡£æ¯”è¾ƒå¥½ç”¨ï¼Œä½†æ˜¯å…è´¹è´¦æˆ·çš„é™åˆ¶æ¯”è¾ƒå¤§ï¼Œå¹¶ä¸”å¾ˆå¤šæ—¶å€™åœ¨å…¬å¸æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ä¸€äº›äº‘çš„åŠŸèƒ½ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å¯¼å‡º postman collection å¹¶ä¸”ä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹çš„å·¥å…·ï¼Œæˆ–è€…æ˜¯è‡ªå·±å®ç°ä¸€ä¸ªæ¥å£æ–‡æ¡£çš„ç”ŸæˆåŠŸèƒ½ï¼Œæ¥è¾¾åˆ°è¾“å‡ºæœ¬åœ°æ–‡æ¡£çš„ç›®çš„</p><p>è¿™é‡Œæˆ‘ä»¬å€ŸåŠ© <a href="https://github.com/thedevsaddam/docgen">docgen</a> è¿™ä¸ªè½®å­æ¥è¾“å‡ºä¸€ä»½æœ¬åœ°çš„æ–‡æ¡£ï¼Œç±»ä¼¼çš„å·¥å…·è¿˜æœ‰è®¸å¤šï¼Œå®ç°ä¸Šä¹Ÿä¸å¤æ‚ï¼Œå¦‚æœæœ‰æ ¼å¼ä¸Šçš„ä¸€äº›éœ€æ±‚å®Œå…¨å¯ä»¥ä¸€ä¸¤ä¸ªå°æ—¶çš„åŠŸå¤«é€ å‡ºä¸€ä¸ªè¿˜èƒ½ç”¨çš„å°å·¥å…·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åªéœ€è¦å¯¼å‡ºjsonæ–‡ä»¶ï¼Œå°±å¯ä»¥è¾“å‡ºåœ¨çº¿æ–‡æ¡£ï¼Œæˆ–è€…æ˜¯ç”Ÿæˆhtmlï¼Œmarkdown æ–‡ä»¶äº†</span><br>$ ./docgen.exe server -f Weå·å¤§.postman_collection.json<br>2019/07/12 00:30:51 Listening on port:  9000<br>2019/07/12 00:30:51 Web Server is available at http://localhost:9000/<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆçš„æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190712003222.png" alt=""></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ç¯‡æ–‡ç« æ‹–çš„ç¨å¾®æœ‰ç‚¹ç‚¹ä¹…ï¼Œå†…å®¹æœ‰ç‚¹è¶…å‡ºæœ€å¼€å§‹çš„é¢„è®¡ï¼Œå†™çš„ç¨ç¨æœ‰ç‚¹ç‚¹å¤šäº†ï¼ŒPOSTMAN è¿˜æœ‰éœ€è¦æœ‰ç”¨çš„ç©æ³•ï¼Œå¤§å®¶å¯ä»¥æ¢ç´¢ä¸€ä¸‹ï¼Œé™¤äº†ä¸Šæ–‡è®²åˆ°çš„ä¹‹å¤–ï¼Œè¯´ä¸€äº›æˆ‘å¸¸ç”¨åˆ°çš„æ–¹å¼</p><ul><li>åˆ©ç”¨ collection run æ‰¹é‡æäº¤è¯·æ±‚ï¼Œåšä¸€äº›æ‰¹å¤„ç†çš„å·¥ä½œ</li><li>åˆ©ç”¨ pre request script è®¾ç½®åœ¨ Collection ä¸­ï¼Œç„¶åç”¨ä¸åŒçš„ç¯å¢ƒå˜é‡åŒºåˆ†ä¸åŒçš„é¡¹ç›®ï¼Œè¿™ç§ç”¨åœ¨ç½‘å…³ç±»çš„æµ‹è¯•ååˆ†æœ‰</li></ul><p>æ–‡ç« æ¯”è¾ƒé•¿ï¼Œæ„Ÿè°¢ä½ çš„é˜…è¯»</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><a href="https://learning.getpostman.com/docs">Postman å®˜æ–¹æ–‡æ¡£ï¼Œå¾ˆå…¨é¢ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰çš„æ“ä½œéƒ½èƒ½åœ¨ä¸Šé¢æ‰¾åˆ°</a></li><li><a href="https://haofly.net/postman/">Postman é«˜çº§ç”¨æ³•</a></li><li><a href="https://www.twblogs.net/a/5bddb8542b717720b51ab853/zh-cn">Postman é«˜çº§åº”ç”¨ï¼ˆ9ï¼‰ï¼šAPI æ”¶é›†ç¥å™¨â€”â€”è¯·æ±‚æ‹¦æˆª</a></li><li><a href="https://documenter.getpostman.com/view/364695/RWaGUpsy?version=latest">We å·å¤§ API</a></li><li><a href="https://github.com/postmanlabs/newman">newman</a></li><li><a href="https://gitlab.com/mohuishou/postman-ci/pipelines">gitlab ci demo</a></li><li><a href="https://github.com/thedevsaddam/docgen">docgen</a></li></ol><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>tool</tag>
      
      <tag>postman</tag>
      
      <tag>api</tag>
      
      <tag>rest</tag>
      
      <tag>test</tag>
      
      <tag>gatway</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>go generate and ast</title>
    <link href="/post/41140.html"/>
    <url>/post/41140.html</url>
    
    <content type="html"><![CDATA[<h2 id="æ¥”-xie-å­"><a href="#æ¥”-xie-å­" class="headerlink" title="æ¥”(xiÄ“)å­"></a>æ¥”(xiÄ“)å­</h2><p>æœ€è¿‘å†™<code>API CURD</code>æ¯”è¾ƒå¤šï¼Œä¸ºäº†ç»“æ„æ¸…æ™°ï¼Œè¿”å›å€¼éœ€è¦ç»Ÿä¸€é”™è¯¯ç ï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªç»Ÿä¸€çš„<code>errcode</code>åŒ…ä¸­å®šä¹‰é”™è¯¯ç å¸¸é‡ï¼Œä»¥åŠå…¶é”™è¯¯ä¿¡æ¯.</p><a id="more"></a><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç”±äºå¸¸é‡æ˜¯å¯¼å‡ºå­—ç¬¦ -&gt; <code>golint</code> æ£€æµ‹éœ€è¦ç¼–å†™æ³¨é‡Š -&gt; æ³¨é‡Šä¿¡æ¯å…¶å®å°±æ˜¯é”™è¯¯ä¿¡æ¯ï¼Œå·²ç»åœ¨ä¸‹æ–‡çš„<code>msg map[int]string</code>ä¸­å®šä¹‰ï¼Œå¦‚æœåœ¨å†™å°±å¾—å†™ä¸¤é</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/assets/20190507235621.png" alt=""></p><p>ä¸å†™ï¼Œå°±æ»¡å±æ³¢æµªçº¿ï¼Œä¸èƒ½å¿ï¼</p><p>å†™äº†ï¼Œå°±å¾—<code>Copy</code>ä¸€ä»½ï¼Œè¿˜ä¸åˆ©äºç»´æŠ¤ï¼Œä¸èƒ½å¿ï¼</p><p>èƒ½ä¸èƒ½åªå†™ä¸€ä»½æ³¨é‡Šï¼Œå‰©ä¸‹çš„<code>msg</code>é€šè¿‡è¯»å–æ³¨é‡Šä¿¡æ¯è‡ªåŠ¨ç”Ÿæˆï¼Œå°†æˆ‘ä»¬å®(hua)è´µ(diao)çš„ç”Ÿå‘½ï¼Œä»è¿™äº›é‡å¤ç¹æ‚æ— æ„ä¹‰çš„åŠ³åŠ¨ä¸­è§£æ”¾å‡ºæ¥ã€‚</p><p>ä¸ºäº†å®ç°è¿™ä¸ª<del>ä¼Ÿå¤§çš„ç›®æ ‡</del>, éœ€è¦ä»¥ä¸‹ä¸¤ä¸ªå…³é”®çš„æ•°æ®:</p><ol><li>è§£ææºä»£ç è·å–å¸¸é‡ä¸æ³¨é‡Šä¹‹é—´çš„å…³ç³» -&gt; ğŸŒ²Go æŠ½è±¡è¯­æ³•æ ‘: AST<sup><a href="https://golang.org/pkg/go/ast">[3]</a></sup></li><li>ä» Go æºç ç”Ÿæˆ Go ä»£ç  -&gt; ğŸ‘ go generate<sup><a href="https://blog.golang.org/generate">[5]</a></sup></li></ol><h2 id="ğŸ‘-go-generate"><a href="#ğŸ‘-go-generate" class="headerlink" title="ğŸ‘ go generate"></a>ğŸ‘ go generate</h2><p><code>golang</code>åœ¨<code>1.4</code>ç‰ˆæœ¬ä¸­å¼•å…¥äº†<code>go generate</code>å‘½ä»¤ï¼Œå¸¸ç”¨äºæ–‡ä»¶ç”Ÿæˆï¼Œä¾‹å¦‚åœ¨ Golang å®˜æ–¹åšå®¢<sup><a href="https://blog.golang.org/generate">[5]</a></sup>ä¸­ä»‹ç»çš„<a href="https://golang.org/x/tools/cmd/stringer">Stringer</a>å¯ä»¥ä¸ºæšä¸¾è‡ªåŠ¨å®ç°<code>Stringer</code>çš„æ–¹æ³•ï¼Œä»ä¸šåŠ¡ä»£ç ä¸­è§£æ”¾å‡ºæ¥</p><h3 id="ğŸ’»-å‘½ä»¤æ–‡æ¡£"><a href="#ğŸ’»-å‘½ä»¤æ–‡æ¡£" class="headerlink" title="ğŸ’» å‘½ä»¤æ–‡æ¡£"></a>ğŸ’» å‘½ä»¤æ–‡æ¡£</h3><p>ä½¿ç”¨<code>go help generate</code>æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹å‘½ä»¤çš„å¸®åŠ©æ–‡æ¡£</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">â–¶ go <span class="hljs-built_in">help</span> generate<br>usage: go generate [-run regexp] [-n] [-v] [-x] [build flags] [file.go... | packages]<br>...<br></code></pre></td></tr></table></figure><p>è§£é‡Šå¾ˆé•¿ï¼Œå°±ä¸è´´ä¸Šæ¥äº†ï¼Œç®€è¦çš„æ¦‚æ‹¬ä¸€ä¸‹:</p><ol><li><p>å‚æ•°è¯´æ˜</p><ul><li>-run æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å‘½ä»¤è¡Œï¼Œä»…æ‰§è¡ŒåŒ¹é…çš„å‘½ä»¤(å’Œ<code>go test -run</code>ç±»ä¼¼)</li><li>-v æ‰“å°  å·²è¢«æ£€ç´¢å¤„ç†çš„æ–‡ä»¶ã€‚</li><li>-n æ‰“å°å‡ºå°†è¢«æ‰§è¡Œçš„å‘½ä»¤ï¼Œæ­¤æ—¶å°†ä¸çœŸå®æ‰§è¡Œå‘½ä»¤</li><li>-x æ‰“å°å·²æ‰§è¡Œçš„å‘½ä»¤</li></ul></li><li><p>ä¸¾ä¸ªæ —å­</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å¯¹å½“å‰åŒ…ä¸‹çš„Goæ–‡ä»¶è¿›è¡Œå¤„ç†, å¹¶æ‰“å°å·²è¢«æ£€ç´¢å¤„ç†çš„æ–‡ä»¶ã€‚</span><br>go generate -v<br><span class="hljs-comment"># æ‰“å°å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ä¸­å°†è¦è¢«æ‰§è¡Œçš„å‘½ä»¤(å®é™…ä¸ä¼šæ‰§è¡Œ)</span><br>go generate -n ./...<br></code></pre></td></tr></table></figure></li><li><p><code>go generate</code>ä¼šæ‰«æ<code>.go</code>æºç æ–‡ä»¶ä¸­çš„æ³¨é‡Š<code>//go:generate command args...</code>ï¼Œ å¹¶ä¸”æ‰§è¡Œå…¶å‘½ä»¤ï¼Œæ³¨æ„:</p><ul><li>è¿™äº›å‘½ä»¤æ˜¯ä¸ºäº†æ›´æ–°æˆ–è€…åˆ›å»º Go æºæ–‡ä»¶</li><li><code>command</code>å¿…é¡»æ˜¯å¯æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œä¾‹å¦‚åœ¨ PATH ä¸­æˆ–è€…ä½¿ç”¨ç»å¯¹è·¯å¾„</li><li><code>arg</code>å¦‚æœå¸¦å¼•å·ä¼šè¢«è¯†åˆ«æˆä¸€ä¸ªå‚æ•°, ä¾‹å¦‚: <code>//go:generate command &quot;x1 x2&quot;</code>, è¿™æ¡è¯­å¥æ‰§è¡Œçš„å‘½ä»¤åªæœ‰ä¸€ä¸ªå‚æ•°</li><li><strong>æ³¨é‡Šä¸­<code>//</code>å’Œ<code>go</code>ä¹‹é—´æ²¡æœ‰ç©ºæ ¼</strong></li></ul></li><li><p><code>go generate</code>å¿…é¡»æ‰‹åŠ¨æ‰§è¡Œï¼Œå¦‚æœæƒ³ç­‰ç€<code>go build</code>, <code>go test</code>, <code>go run</code> å‘½ä»¤æ‰§è¡Œçš„æ—¶å€™è‡ªåŠ¨æ‰§è¡Œï¼Œå¯ä»¥æ´—æ´—ç¡äº†</p></li><li><p>ä¸ºäº†è®©åˆ«äººæˆ–è€…æ˜¯ IDE è¯†åˆ«ä»£ç æ˜¯é€šè¿‡<code>go generate</code>ç”Ÿæˆçš„ï¼Œè¯·åœ¨ç”Ÿæˆçš„ä»£ç ä¸­æ·»åŠ æ³¨é‡Š(ä¸€èˆ¬æ”¾åœ¨æ–‡ä»¶å¼€å¤´)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># PS: è¿™æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼</span><br>^// Code generated .* DO NOT EDIT\.$<br></code></pre></td></tr></table></figure><p>ä¸¾ä¸ªæ —å­:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Code generated by mohuishou DO NOT EDIT</span><br><br><span class="hljs-keyword">package</span> painkiller<br></code></pre></td></tr></table></figure></li><li><p><code>go generate</code>åœ¨æ‰§è¡Œçš„æ—¶å€™ä¼šè‡ªåŠ¨æ³¨å…¥ä»¥ä¸‹ç¯å¢ƒå˜é‡:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$GOARCH</span><br>ç³»ç»Ÿæ¶æ„: arm, amd64 ç­‰<br><span class="hljs-variable">$GOOS</span><br>æ“ä½œç³»ç»Ÿ: linux, windows ç­‰<br><span class="hljs-variable">$GOFILE</span><br>å½“å‰æ‰§è¡Œçš„å‘½ä»¤æ‰€å¤„çš„æ–‡ä»¶å<br><span class="hljs-variable">$GOLINE</span><br>å½“å‰æ‰§è¡Œçš„å‘½ä»¤åœ¨æ–‡ä»¶ä¸­çš„è¡Œå·<br><span class="hljs-variable">$GOPACKAGE</span><br>æ‰§è¡Œçš„å‘½ä»¤æ‰€å¤„çš„æ–‡ä»¶çš„åŒ…å<br><span class="hljs-variable">$DOLLAR</span><br>$ ç¬¦å·<br></code></pre></td></tr></table></figure></li></ol><h3 id="ğŸŒ°-Go-å®˜æ–¹åšå®¢ä¸­ç»™å‡ºçš„æ —å­"><a href="#ğŸŒ°-Go-å®˜æ–¹åšå®¢ä¸­ç»™å‡ºçš„æ —å­" class="headerlink" title="ğŸŒ° Go å®˜æ–¹åšå®¢ä¸­ç»™å‡ºçš„æ —å­"></a>ğŸŒ° Go å®˜æ–¹åšå®¢ä¸­ç»™å‡ºçš„æ —å­</h3><p>æºæ–‡ä»¶: <code>painkiller.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//go:generate stringer -type=Pill</span><br><br><span class="hljs-keyword">package</span> painkiller<br><br><span class="hljs-keyword">type</span> Pill <span class="hljs-keyword">int</span><br><br><span class="hljs-keyword">const</span> (<br>    Placebo Pill = <span class="hljs-literal">iota</span><br>    Aspirin<br>    Ibuprofen<br>    Paracetamol<br>    Acetaminophen = Paracetamol<br>)<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go generate<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆæ–‡ä»¶: <code>painkiller_stringer.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// generated by stringer -type Pill pill.go; DO NOT EDIT</span><br><br><span class="hljs-keyword">package</span> painkiller<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">const</span> _Pill_name = <span class="hljs-string">&quot;PlaceboAspirinIbuprofenParacetamol&quot;</span><br><br><span class="hljs-keyword">var</span> _Pill_index = [...]<span class="hljs-keyword">uint8</span>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">7</span>, <span class="hljs-number">14</span>, <span class="hljs-number">23</span>, <span class="hljs-number">34</span>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(i Pill)</span> <span class="hljs-title">String</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br>    <span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">0</span> || i+<span class="hljs-number">1</span> &gt;= Pill(<span class="hljs-built_in">len</span>(_Pill_index)) &#123;<br>        <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;Pill(%d)&quot;</span>, i)<br>    &#125;<br>    <span class="hljs-keyword">return</span> _Pill_name[_Pill_index[i]:_Pill_index[i+<span class="hljs-number">1</span>]]<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ ğŸŒ°ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨<code>.go</code>æºæ–‡ä»¶ä¸­ï¼Œæ·»åŠ äº†ä¸€è¡Œæ³¨é‡Š<code>go:generate stringer -type=Pill</code>, æ‰§è¡Œå‘½ä»¤<code>go generate</code>å°±è°ƒç”¨<code>stringer</code>å‘½ä»¤åœ¨åŒç›®å½•ä¸‹ç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„<code>_stringer.go</code>çš„æ–‡ä»¶</p><p>å›æƒ³ä¸€ä¸‹ä¸Šæ–‡æåˆ°çš„éœ€æ±‚ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰å¾ˆç±»ä¼¼ï¼Œä» Go æºæ–‡ä»¶ä¸­ï¼Œç”Ÿæˆäº†ä¸€äº›ä¸æƒ³é‡å¤å†™çš„ä¸šåŠ¡é€»è¾‘</p><h2 id="ğŸŒ²-AST"><a href="#ğŸŒ²-AST" class="headerlink" title="ğŸŒ² AST"></a>ğŸŒ² AST</h2><p>å›åˆ°å‰é¢çš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦ä»æºä»£ç ä¸­è·å–å¸¸é‡å’Œæ³¨é‡Šä¹‹å‰çš„å…³ç³»ï¼Œè¿™æ—¶å°±éœ€è¦æˆ‘ä»¬çš„ ğŸŒ²AST éš†é‡ç™»åœºäº†ã€‚</p><p>æœ¬æ–‡ä¸å¯¹ AST è¿‡å¤šä»‹ç»ï¼Œå¯ä»¥é˜…è¯»å‚è€ƒèµ„æ–™ä¸­çš„ AST æ ‡å‡†åº“æ–‡æ¡£<sup><a href="https://golang.org/pkg/go/ast">[3]</a></sup>ï¼ŒGo çš„ AST(æŠ½è±¡è¯­æ³•æ ‘)<sup><a href="https://zhuanlan.zhihu.com/p/28516587">[4]</a></sup></p><h3 id="ç®€è¦ä»‹ç»ä¸€ä¸‹-AST-åŒ…"><a href="#ç®€è¦ä»‹ç»ä¸€ä¸‹-AST-åŒ…" class="headerlink" title="ç®€è¦ä»‹ç»ä¸€ä¸‹ AST åŒ…"></a>ç®€è¦ä»‹ç»ä¸€ä¸‹ AST åŒ…</h3><p>åŸºç¡€çš„æ¥å£ç±»å‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Node ASTæ ‘èŠ‚ç‚¹</span><br><span class="hljs-keyword">type</span> Node <span class="hljs-keyword">interface</span> &#123;<br>  Pos() token.Pos<br>  End() token.Pos<br>&#125;<br><br><span class="hljs-comment">// Expr æ‰€æœ‰çš„è¡¨è¾¾å¼éƒ½éœ€è¦å®ç°Expræ¥å£</span><br><span class="hljs-keyword">type</span> Expr <span class="hljs-keyword">interface</span> &#123;<br>  Node<br>  exprNode()<br>&#125;<br><br><span class="hljs-comment">// Stmt æ‰€æœ‰çš„è¯­å¥éƒ½éœ€è¦å®ç°Stmtæ¥å£</span><br><span class="hljs-keyword">type</span> Stmt <span class="hljs-keyword">interface</span> &#123;<br>  Node<br>  stmtNode()<br>&#125;<br><br><span class="hljs-comment">// Decl æ‰€æœ‰çš„å£°æ˜éƒ½éœ€è¦å®ç°Declæ¥å£</span><br><span class="hljs-keyword">type</span> Decl <span class="hljs-keyword">interface</span> &#123;<br>  Node<br>  declNode()<br>&#125;<br></code></pre></td></tr></table></figure><p>ç­‰ä¼šå„¿å¯èƒ½ä¼šç”¨åˆ°çš„<code>ValueSpec</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ValueSpec è¡¨ç¤ºå¸¸é‡å£°æ˜æˆ–è€…å˜é‡å£°æ˜</span><br><span class="hljs-keyword">type</span> ValueSpec <span class="hljs-keyword">struct</span> &#123;<br>        Doc     *CommentGroup <span class="hljs-comment">// associated documentation; or nil</span><br>        Names   []*Ident      <span class="hljs-comment">// value names (len(Names) &gt; 0)</span><br>        Type    Expr          <span class="hljs-comment">// value type; or nil</span><br>        Values  []Expr        <span class="hljs-comment">// initial values; or nil</span><br>        Comment *CommentGroup <span class="hljs-comment">// line comments; or nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="CommentMap"><a href="#CommentMap" class="headerlink" title="CommentMap"></a>CommentMap</h3><p>åœ¨ godoc<sup><a href="https://golang.org/pkg/go/ast">[3]</a></sup>çš„ Example ä¸­å¯ä»¥å‘ç°æœ‰ä¸€ä¸ª<a href="https://golang.org/pkg/go/ast/#example_CommentMap">CommentMap</a>ä¾‹å­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// CommentMapæŠŠASTèŠ‚ç‚¹å’Œå…¶å…³è”çš„æ³¨é‡Šåˆ—è¡¨è¿›è¡Œæ˜ å°„</span><br><span class="hljs-keyword">type</span> CommentMap <span class="hljs-keyword">map</span>[Node][]*CommentGroup<br></code></pre></td></tr></table></figure><ol><li><p>é€šè¿‡<code>parse</code>è¯»å–æºç åˆ›å»ºä¸€ä¸ª AST</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">fset := token.NewFileSet() <span class="hljs-comment">// positions are relative to fset</span><br>f, err := parser.ParseFile(fset, <span class="hljs-string">&quot;src.go&quot;</span>, src, parser.ParseComments)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>ä» AST ä¸­æ–°å»ºä¸€ä¸ª<code>CommentMap</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">cmap := ast.NewCommentMap(fset, f, f.Comments)<br></code></pre></td></tr></table></figure></li></ol><h2 id="éœ€æ±‚å®ç°"><a href="#éœ€æ±‚å®ç°" class="headerlink" title="éœ€æ±‚å®ç°"></a>éœ€æ±‚å®ç°</h2><h3 id="1-è·å–å¸¸é‡å’Œæ³¨é‡Šçš„å…³è”å…³ç³»"><a href="#1-è·å–å¸¸é‡å’Œæ³¨é‡Šçš„å…³è”å…³ç³»" class="headerlink" title="1. è·å–å¸¸é‡å’Œæ³¨é‡Šçš„å…³è”å…³ç³»"></a>1. è·å–å¸¸é‡å’Œæ³¨é‡Šçš„å…³è”å…³ç³»</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go">file := os.Getenv(<span class="hljs-string">&quot;GOFILE&quot;</span>)<br><span class="hljs-comment">// ä¿å­˜æ³¨é‡Šä¿¡æ¯</span><br><span class="hljs-keyword">var</span> comments = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>)<br><br><span class="hljs-comment">// è§£æä»£ç æºæ–‡ä»¶ï¼Œè·å–å¸¸é‡å’Œæ³¨é‡Šä¹‹é—´çš„å…³ç³»</span><br>fset := token.NewFileSet()<br>f, err := parser.ParseFile(fset, file, <span class="hljs-literal">nil</span>, parser.ParseComments)<br>checkErr(err)<br><br><span class="hljs-comment">// Create an ast.CommentMap from the ast.File&#x27;s comments.</span><br><span class="hljs-comment">// This helps keeping the association between comments</span><br><span class="hljs-comment">// and AST nodes.</span><br>cmap := ast.NewCommentMap(fset, f, f.Comments)<br><span class="hljs-keyword">for</span> node := <span class="hljs-keyword">range</span> cmap &#123;<br>  <span class="hljs-comment">// ä»…æ”¯æŒä¸€æ¡å£°æ˜è¯­å¥ï¼Œä¸€ä¸ªå¸¸é‡çš„æƒ…å†µ</span><br>  <span class="hljs-keyword">if</span> spec, ok := node.(*ast.ValueSpec); ok &amp;&amp; <span class="hljs-built_in">len</span>(spec.Names) == <span class="hljs-number">1</span> &#123;<br>    <span class="hljs-comment">// ä»…æå–å¸¸é‡çš„æ³¨é‡Š</span><br>    ident := spec.Names[<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">if</span> ident.Obj.Kind == ast.Con &#123;<br>      <span class="hljs-comment">// è·å–æ³¨é‡Šä¿¡æ¯</span><br>      comments[ident.Name] = getComment(ident.Name, spec.Doc)<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-è·å–æ³¨é‡Šä¿¡æ¯"><a href="#2-è·å–æ³¨é‡Šä¿¡æ¯" class="headerlink" title="2. è·å–æ³¨é‡Šä¿¡æ¯"></a>2. è·å–æ³¨é‡Šä¿¡æ¯</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// getComment è·å–æ³¨é‡Šä¿¡æ¯ï¼Œæ¥è‡ªASTæ ‡å‡†åº“çš„summaryæ–¹æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getComment</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>, group *ast.CommentGroup)</span> <span class="hljs-title">string</span></span> &#123;<br><span class="hljs-keyword">var</span> buf bytes.Buffer<br><br><br><span class="hljs-keyword">for</span> _, comment := <span class="hljs-keyword">range</span> group.List &#123;<br>    <span class="hljs-comment">// æ³¨é‡Šä¿¡æ¯ä¼šä»¥ // å‚æ•°åï¼Œå¼€å§‹ï¼Œæˆ‘ä»¬å®é™…ä½¿ç”¨æ—¶ä¸éœ€è¦ï¼Œå»æ‰</span><br>text := strings.TrimSpace(strings.TrimPrefix(comment.Text, fmt.Sprintf(<span class="hljs-string">&quot;// %s&quot;</span>, name)))<br>buf.WriteString(text)<br>&#125;<br><br><span class="hljs-comment">// replace any invisibles with blanks</span><br>bytes := buf.Bytes()<br><span class="hljs-keyword">for</span> i, b := <span class="hljs-keyword">range</span> bytes &#123;<br><span class="hljs-keyword">switch</span> b &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\t&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>, <span class="hljs-string">&#x27;\r&#x27;</span>:<br>bytes[i] = <span class="hljs-string">&#x27; &#x27;</span><br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-keyword">string</span>(bytes)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-ç”Ÿæˆä»£ç "><a href="#3-ç”Ÿæˆä»£ç " class="headerlink" title="3. ç”Ÿæˆä»£ç "></a>3. ç”Ÿæˆä»£ç </h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> suffix = <span class="hljs-string">&quot;_msg_gen.go&quot;</span><br><br><span class="hljs-comment">// tpl ç”Ÿæˆä»£ç éœ€è¦ç”¨åˆ°æ¨¡æ¿</span><br><span class="hljs-keyword">const</span> tpl = <span class="hljs-string">`</span><br><span class="hljs-string">// Code generated by github.com/mohuishou/gen-const-msg DO NOT EDIT</span><br><span class="hljs-string"></span><br><span class="hljs-string">// &#123;&#123;.pkg&#125;&#125; const code comment msg</span><br><span class="hljs-string">package &#123;&#123;.pkg&#125;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">// noErrorMsg if code is not found, GetMsg will return this</span><br><span class="hljs-string">const noErrorMsg = &quot;unknown error&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">// messages get msg from const comment</span><br><span class="hljs-string">var messages = map[int]string&#123;</span><br><span class="hljs-string">&#123;&#123;range $key, $value := .comments&#125;&#125;</span><br><span class="hljs-string">&#123;&#123;$key&#125;&#125;: &quot;&#123;&#123;$value&#125;&#125;&quot;,&#123;&#123;end&#125;&#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">// GetMsg get error msg</span><br><span class="hljs-string">func GetMsg(code int) string &#123;</span><br><span class="hljs-string">var (</span><br><span class="hljs-string">msg string</span><br><span class="hljs-string">ok  bool</span><br><span class="hljs-string">)</span><br><span class="hljs-string">if msg, ok = messages[code]; !ok &#123;</span><br><span class="hljs-string">msg = noErrorMsg</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">return msg</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">`</span><br><br><span class="hljs-comment">// gen ç”Ÿæˆä»£ç </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">gen</span><span class="hljs-params">(comments <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>)</span> <span class="hljs-params">([]<span class="hljs-keyword">byte</span>, error)</span></span> &#123;<br>  <span class="hljs-keyword">var</span> buf = bytes.NewBufferString(<span class="hljs-string">&quot;&quot;</span>)<br><br>  data := <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>    <span class="hljs-string">&quot;pkg&quot;</span>:      os.Getenv(<span class="hljs-string">&quot;GOPACKAGE&quot;</span>),<br>    <span class="hljs-string">&quot;comments&quot;</span>: comments,<br>  &#125;<br><br>  t, err := template.New(<span class="hljs-string">&quot;&quot;</span>).Parse(tpl)<br>  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.Wrapf(err, <span class="hljs-string">&quot;template init err&quot;</span>)<br>  &#125;<br><br>  err = t.Execute(buf, data)<br>  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.Wrapf(err, <span class="hljs-string">&quot;template data err&quot;</span>)<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> format.Source(buf.Bytes())<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»ä¸€ä¸ªç®€å•çš„æ•ˆç‡éœ€æ±‚å¼•ç”³åˆ°<code>go generate</code>å’Œ<code>ast</code>çš„ä½¿ç”¨ï¼Œé¡ºä¾¿é˜…è¯»äº†ä¸€ä¸‹<code>ast</code>çš„æºç ï¼ŒèŠ±è´¹çš„æ—¶é—´å…¶å®å¯èƒ½æ˜¯è¿™ä¸ªå·¥å…·èŠ‚çº¦çš„æ—¶é—´çš„å‡ å€äº†ï¼Œä½†æ˜¯æ”¶è·ä¹Ÿæ˜¯ä¹‹å‰æ²¡æœ‰æƒ³åˆ°çš„ã€‚</p><ol><li>ä½¿ç”¨äº†è¿™ä¹ˆä¹…çš„<code>go</code>å‘½ä»¤ï¼Œè¯¦ç»†çš„é˜…è¯»äº†<code>go help command</code>çš„è¯´æ˜ä¹‹åï¼Œå‘ç°ä¹‹å‰å¯èƒ½è¿äº†è§£éƒ½ç®—ä¸ä¸Š</li><li>æ ‡å‡†åº“çš„<code>godoc</code>æ˜¯æœ€å¥½çš„ä½¿ç”¨è¯´æ˜ï¼Œç¬¬äºŒå¥½çš„æ˜¯å®ƒçš„æºä»£ç </li></ol><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><p><a href="https://github.com/mohuishou/go-const-msg">go-const-msg æœ¬æ–‡å®ç°çš„æºä»£ç </a></p></li><li><p><a href="https://yushuangqi.com/blog/2017/go-command-generate.html">Golang Generate å‘½ä»¤è¯´æ˜ä¸ä½¿ç”¨</a></p></li><li><p><a href="https://golang.org/pkg/go/ast/">AST æ ‡å‡†åº“æ–‡æ¡£</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/28516587">Go çš„ AST(æŠ½è±¡è¯­æ³•æ ‘)</a></p></li><li><p><a href="https://blog.golang.org/generate">GO å®˜æ–¹åšå®¢: Generating code</a></p></li></ol><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>generate</tag>
      
      <tag>ast</tag>
      
      <tag>tool</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>hexo-next-algolia-searchå…¨æ–‡æœç´¢</title>
    <link href="/post/27142.html"/>
    <url>/post/27142.html</url>
    
    <content type="html"><![CDATA[<p>åœ¨ hexo ä¸­é€šè¿‡ algolia å®ç°å…¨æ–‡æœç´¢</p><a id="more"></a><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><blockquote><p>The latest version of the Hexo-Algolia plugin removes the content indexing feature, given Algoliaâ€™s free account limitation.</p></blockquote><p>é€šè¿‡ä¸»é¢˜å®˜æ–¹çš„<a href="https://theme-next.org/docs/third-party-services/search-services">æ–‡æ¡£</a>æˆ‘ä»¬å‘ç°ï¼Œå…¨æ–‡ç´¢å¼•çš„åŠŸèƒ½å·²ç»è¢«ç§»é™¤äº†ï¼ŒåŸå› æ˜¯å› ä¸ºä¼šå‡ºç°<code>Record Too Big</code>çš„æŠ¥é”™ï¼ŒæŸ¥é˜… algolia çš„<a href="https://www.algolia.com/doc/faq/basics/is-there-a-size-limit-for-my-index-records">æ–‡æ¡£</a>æˆ‘ä»¬å¯ä»¥å‘ç°å…è´¹è´¦å·ï¼Œå•æ¡ç´¢å¼•çš„ä¸Šé™ä¸º<code>10kB</code>, å•†ä¸šç‰ˆç”¨æˆ·çš„ç´¢å¼•ä¸Šé™ä¸º<code>20KB</code></p><h2 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h2><blockquote><p>è¯·å…ˆæŒ‰ç…§ä¸Šæ–‡æåˆ°çš„ä¸»é¢˜é…ç½®è¯´æ˜é…ç½®ä¹‹åè¿›è¡Œå¦‚ä¸‹æ“ä½œ</p></blockquote><ol><li><p>æ›¿æ¢æ’ä»¶</p><p>åœ¨<code>package.json</code>ä¸­æ›¿æ¢ä¸‹é¢è¿™ä¸€è¡Œ</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&quot;hexo-algolia&quot;: &quot;https://github.com/mohuishou/hexo-algolia&quot;<br></code></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ä¸»é¢˜æ–‡ä»¶<code>themes\next\source\js\algolia-search.js</code></p><p>å°†<code>instantsearch.widgets.hits</code>æ–¹æ³•ä¸­, item å¯¹åº”çš„è¿”å›å€¼æ›¿æ¢ä¸ºä»¥ä¸‹å†…å®¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">return</span> (<br>  <span class="hljs-string">&#x27;&lt;a href=&quot;&#x27;</span> +<br>  link +<br>  <span class="hljs-string">&#x27;&quot; class=&quot;algolia-hit-item-link&quot;&gt;&#x27;</span> +<br>  <span class="hljs-string">&#x27;&lt;div class=&quot;algolia-hit-item-title&quot;&gt;&#x27;</span> +<br>  data._highlightResult.title.value +<br>  <span class="hljs-string">&quot;&lt;/div&gt;&quot;</span> +<br>  <span class="hljs-string">&#x27;&lt;div class=&quot;algolia-hit-item-content&quot;&gt;&#x27;</span> +<br>  data._snippetResult.raw.value +<br>  <span class="hljs-string">&quot;&lt;/div&gt;&quot;</span> +<br>  <span class="hljs-string">&quot;&lt;/a&gt;&quot;</span><br>);<br></code></pre></td></tr></table></figure><p>è¿™ä¸¤æ­¥åšå®Œå…¶å®å°±å·²ç»å®Œæˆçš„äº†å…¨æ–‡ç´¢å¼•ï¼Œä½†æ˜¯æœç´¢ç»“æœä¼šæŠŠæ‰€æœ‰å†…å®¹è¿”å›ï¼Œæˆ‘ä»¬å…¶å®åªéœ€è¦åŒ¹é…å…³é”®è¯é™„è¿‘çš„ç»“æœ</p></li><li><p>å¼€å¯ Attributes to snippet ç‰¹æ€§</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºç‚¹å‡»ç´¢å¼•-&gt;é…ç½®ï¼Œ ç„¶åå†åˆ°å·¦ä¾§åˆ—è¡¨ä¸­é€‰ä¸­<code>Snippeting</code></p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190410234147.png" alt=""></p><p>ç„¶åå¦‚å›¾æ‰€ç¤ºæ·»åŠ å­—æ®µ<code>raw</code>, å³ä¾§ä¸ºæ˜¾ç¤ºçš„å­—ç¬¦æ•°ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚ä¿®æ”¹</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190410234453.png" alt=""></p><p>åˆ°è¿™é‡Œå°±å¤§åŠŸå‘Šæˆäº†ï¼Œä½†æ˜¯å…³é”®è¯è¿˜ä¸å¤Ÿçªå‡ºï¼Œå¯ä»¥å†åšä¸€äº›ç¾åŒ–</p></li><li><p>ç¾åŒ–æœç´¢ç»“æœ</p><p>åœ¨<code>source/_data</code>ä¸­æ–°å¢<code>styles.styl</code>æ–‡ä»¶</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">em</span> &#123;<br>  <span class="hljs-attribute">color</span>: red;<br>  <span class="hljs-attribute">font-style</span>: normal;<br>&#125;<br><br><span class="hljs-selector-class">.algolia-hit-item-title</span> &#123;<br>  <span class="hljs-attribute">font-weight</span>: bold;<br>&#125;<br><br><span class="hljs-selector-class">.algolia-hit-item-content</span> &#123;<br>  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.8em</span>;<br>  <span class="hljs-attribute">color</span>: <span class="hljs-number">#555</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¿®æ”¹<code>_config.yml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">theme_config:</span><br>  <span class="hljs-attr">custom_file_path:</span><br>    <span class="hljs-attr">styles:</span> <span class="hljs-string">source/_data/styles.styl</span><br></code></pre></td></tr></table></figure><p>ok! å¤§åŠŸå‘Šæˆ</p></li></ol><h2 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h2><ol><li><p>ä¼˜åŒ–å‰:</p><blockquote><p>éšæ„æ‰¾äº†ä¸€ä¸ªåšå®¢çš„æˆªå›¾ï¼Œæ˜¾ç¤ºåªæœ‰æ ‡é¢˜ï¼Œæ²¡æœ‰çš„é«˜äº®ä»¥åŠè¯¦æƒ…<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190411000323.png" alt=""></p></blockquote></li><li><p>ä¼˜åŒ–å:<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190410235215.png" alt=""></p></li></ol><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>åŸç†å…¶å®å¾ˆç®€å•ï¼Œè·å–æ–‡ç« åŸå§‹<code>markdown</code>å†…å®¹ï¼Œåˆ¤æ–­å¤§å°å¦‚æœè¶…è¿‡æŒ‡å®šå¤§å°(é»˜è®¤ 8K)å°±è¿›è¡Œæˆªæ–­</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// è·å–åŸå§‹å†…å®¹</span><br><span class="hljs-keyword">var</span> rawBuf = <span class="hljs-keyword">new</span> Buffer(data.raw);<br><span class="hljs-comment">// è·å–å¤§å°é™åˆ¶</span><br><span class="hljs-keyword">var</span> rowSize = options.maxRawSize * <span class="hljs-number">1024</span>;<br><span class="hljs-keyword">if</span> (rawBuf.length &gt; rowSize) &#123;<br>  <span class="hljs-comment">// è¶…å‡ºé™åˆ¶ï¼Œè¿›è¡Œæˆªæ–­</span><br>  storedPost.raw = rawBuf.toString(<span class="hljs-string">&quot;utf8&quot;</span>, <span class="hljs-number">0</span>, rowSize);<br>  <span class="hljs-comment">// å»é™¤æœ€åä¸€ä¸ªå­—ç¬¦</span><br>  <span class="hljs-comment">// ç”±äºæˆªæ–­æ˜¯æŒ‰ç…§å­—èŠ‚æˆªæ–­çš„ï¼Œä½†æ˜¯ä¸€ä¸ªä¸­æ–‡å­—ç¬¦ä¸æ­¢ä¸€ä¸ªå­—èŠ‚ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœ€åä¸€ä¸ªå­—ç¬¦ä¹±ç </span><br>  storedPost.raw = storedPost.raw.substring(<span class="hljs-number">0</span>, storedPost.raw.length - <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¦æƒ…å¯ä»¥æŸ¥çœ‹ PR: <a href="https://github.com/oncletom/hexo-algolia/pull/39/files">Feature/add raw max len</a></p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>blog</tag>
      
      <tag>hexo</tag>
      
      <tag>next</tag>
      
      <tag>algolia</tag>
      
      <tag>search</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>dockeré•œåƒç˜¦èº«&amp;ä¼˜åŒ–</title>
    <link href="/post/51252.html"/>
    <url>/post/51252.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>ä¸ºä»€ä¹ˆåœ¨å­˜å‚¨å¦‚æ­¤ä¾¿å®œçš„ä»Šå¤©æˆ‘ä»¬ä»ç„¶éœ€è¦å¯¹ Docker é•œåƒè¿›è¡Œç˜¦èº«?</p></blockquote><a id="more"></a><blockquote><p>PS: æœ¬æ–‡ç¯‡å¹…è¾ƒé•¿ï¼Œè¯·é…Œæƒ…è§‚çœ‹</p></blockquote><h2 id="å°é•œåƒçš„ä¼˜ç‚¹"><a href="#å°é•œåƒçš„ä¼˜ç‚¹" class="headerlink" title="å°é•œåƒçš„ä¼˜ç‚¹"></a>å°é•œåƒçš„ä¼˜ç‚¹</h2><ol><li><p>åŠ é€Ÿæ„å»º/éƒ¨ç½²</p><p>è™½ç„¶å­˜å‚¨èµ„æºè¾ƒä¸ºå»‰ä»·ï¼Œä½†æ˜¯ç½‘ç»œ IO æ˜¯æœ‰é™çš„ï¼Œåœ¨å¸¦å®½æœ‰é™çš„æƒ…å†µä¸‹ï¼Œéƒ¨ç½²ä¸€ä¸ª 1G çš„é•œåƒå’Œ 10M çš„é•œåƒå¸¦æ¥çš„æ—¶é—´å·®è·å¯èƒ½å°±æ˜¯åˆ†é’Ÿçº§å’Œç§’çº§çš„å·®è·ã€‚ç‰¹åˆ«æ˜¯åœ¨<strong>å‡ºç°æ•…éšœ</strong>ï¼ŒæœåŠ¡è¢«è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹æ—¶ï¼Œè¿™ä¸ªæ—¶é—´å°¤ä¸ºå®è´µã€‚</p></li><li><p>æé«˜å®‰å…¨æ€§ï¼Œå‡å°‘æ”»å‡»é¢ç§¯</p><p>è¶Šå°çš„é•œåƒè¡¨ç¤ºæ— ç”¨çš„ç¨‹åºè¶Šå°‘ï¼Œå¯ä»¥å¤§å¤§çš„å‡å°‘è¢«æ”»å‡»çš„ç›®æ ‡</p></li><li><p>å‡å°‘å­˜å‚¨å¼€é”€</p></li></ol><h2 id="å°é•œåƒçš„åˆ¶ä½œåŸåˆ™"><a href="#å°é•œåƒçš„åˆ¶ä½œåŸåˆ™" class="headerlink" title="å°é•œåƒçš„åˆ¶ä½œåŸåˆ™"></a>å°é•œåƒçš„åˆ¶ä½œåŸåˆ™</h2><ol><li><p>é€‰ç”¨æœ€å°çš„åŸºç¡€é•œåƒ</p></li><li><p>å‡å°‘å±‚ï¼Œå»é™¤éå¿…è¦çš„æ–‡ä»¶</p><p>åœ¨å®é™…åˆ¶ä½œé•œåƒçš„è¿‡ç¨‹ä¸­ï¼Œä¸€å‘³çš„åˆå¹¶å±‚ä¸å¯å–ï¼Œéœ€è¦å­¦ä¼šå……åˆ†çš„åˆ©ç”¨ Docker çš„ç¼“å­˜æœºåˆ¶ï¼Œæå–å…¬å…±å±‚ï¼ŒåŠ é€Ÿæ„å»ºã€‚</p><ul><li><strong>ä¾èµ–æ–‡ä»¶å’Œå®é™…çš„ä»£ç æ–‡ä»¶å•ç‹¬åˆ†å±‚</strong></li><li><strong>å›¢é˜Ÿ/å…¬å¸é‡‡ç”¨å…¬å…±çš„åŸºç¡€é•œåƒç­‰</strong></li></ul></li><li><p>ä½¿ç”¨å¤šé˜¶æ®µæ„å»º</p><p>å¾€å¾€æˆ‘ä»¬åœ¨æ„å»ºé˜¶æ®µå’Œå®é™…è¿è¡Œé˜¶æ®µéœ€è¦çš„ä¾èµ–ç¯å¢ƒæ˜¯ä¸åŒçš„ï¼Œä¾‹å¦‚<code>golang</code>ç¼–å†™çš„ç¨‹åºå®é™…è¿è¡Œçš„æ—¶å€™ä»…ä»…éœ€è¦ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶å³å¯ï¼Œå¯¹äº<code>Node</code>æ¥è¯´ï¼Œå¯èƒ½æœ€åè¿è¡Œçš„åªæ˜¯ä¸€äº›æ‰“åŒ…ä¹‹åçš„<code>js</code>æ–‡ä»¶è€Œä¸éœ€è¦åŒ…å«<code>node_modules</code>é‡Œæˆåƒä¸Šä¸‡çš„ä¾èµ–</p></li></ol><h2 id="åŸºç¡€é•œåƒ"><a href="#åŸºç¡€é•œåƒ" class="headerlink" title="åŸºç¡€é•œåƒ"></a>åŸºç¡€é•œåƒ</h2><ul><li><p><a href="https://github.com/GoogleCloudPlatform/distroless">distroless</a></p><blockquote><p>â€œDistrolessâ€ images contain only your application and its runtime dependencies. They do not contain package managers, shells or any other programs you would expect to find in a standard Linux distribution.</p></blockquote><p><code>distroless</code>æ˜¯ Google æ¨å‡ºçš„ä¸€ä¸ªä»…ä»…åŒ…å«è¿è¡Œæ—¶ç¯å¢ƒï¼Œä¸åŒ…å«åŒ…ç®¡ç†å™¨ï¼Œ<code>shell</code>ç­‰å…¶ä»–ç¨‹åºã€‚å¦‚æœä½ çš„ç¨‹åºæ²¡æœ‰å…¶ä»–ä¾èµ–çš„è¯ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©</p></li><li><p><a href="https://hub.docker.com/_/alpine">alpine</a></p><blockquote><p>Alpine Linux is a security-oriented, lightweight Linux distribution based on musl libc and busybox.</p></blockquote><p>alpine æ˜¯ä¸€ä¸ªåŸºäº<code>musl</code>, <code>busybox</code>çš„å®‰å…¨çš„<code>linux</code>å‘è¡Œç‰ˆã€‚éº»é›€è™½å°äº”è„ä¿±å…¨ï¼Œè™½ç„¶ä¸åˆ° 10M, ä½†æ˜¯åŒ…å«äº†ä¸€ä¸ªåŒ…ç®¡ç†å™¨å’Œ<code>shell</code>ç¯å¢ƒï¼Œè¿™åœ¨æˆ‘ä»¬å®é™…çš„ä½¿ç”¨è°ƒè¯•å½“ä¸­å°†éå¸¸æœ‰ç”¨ã€‚</p><p>ä½†æ˜¯è¯·æ³¨æ„ï¼Œç”±äº<code>alpine</code>ä½¿ç”¨äº†æ›´å°çš„<code>muslc</code>æ›¿ä»£<code>glibc</code>ï¼Œä¼šå¯¼è‡´æŸäº›åº”ç”¨æ— æ³•ä½¿ç”¨ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘</p></li><li><p><a href="https://hub.docker.com/_/scratch">scratch</a></p><p>scratch æ˜¯ç©ºç™½é•œåƒï¼Œä¸€èˆ¬ç”¨äºåŸºç¡€é•œåƒæ„å»ºï¼Œä¾‹å¦‚<code>alpine</code>é•œåƒçš„<code>dockerfile</code>ä¾¿æ˜¯ä»<code>scratch</code>å¼€å§‹çš„</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> scratch<br><span class="hljs-keyword">ADD</span><span class="bash"> alpine-minirootfs-20190228-x86_64.tar.gz /</span><br><span class="hljs-keyword">CMD</span><span class="bash"> [<span class="hljs-string">&quot;/bin/sh&quot;</span>]</span><br></code></pre></td></tr></table></figure></li><li><p><a href="https://hub.docker.com/_/busybox">busybox</a></p></li></ul><p>ä¸€èˆ¬è€Œè¨€ï¼Œ<code>distroless</code>ç›¸å¯¹ä¼šæ›´åŠ çš„å®‰å…¨ï¼Œä½†æ˜¯åœ¨å®é™…ä½¿ç”¨çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šé‡åˆ°æ·»åŠ ä¾èµ–ä»¥åŠè°ƒè¯•æ–¹é¢çš„é—®é¢˜ï¼Œ<code>alpine</code>æ›´å°ï¼Œè‡ªå¸¦åŒ…ç®¡ç†å™¨ï¼Œæ›´åŠ è´´åˆä½¿ç”¨ä¹ æƒ¯ï¼Œä½†æ˜¯<code>muslc</code>å¯èƒ½ä¼šå¸¦æ¥å…¼å®¹æ€§çš„é—®é¢˜ï¼Œä¸€èˆ¬è€Œè¨€æˆ‘ä¼šé€‰æ‹©<code>alpine</code>ä½œä¸ºåŸºç¡€é•œåƒä½¿ç”¨ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨<a href="https://hub.docker.com">Docker Hub</a>å½“ä¸­æˆ‘ä»¬å¯ä»¥å‘ç°å¸¸ç”¨çš„<code>Debian</code>çš„é•œåƒä¹Ÿä¼šæä¾›çš„åªåŒ…å«åŸºç¡€åŠŸèƒ½çš„å°é•œåƒ</p><h3 id="åŸºç¡€é•œåƒå¯¹æ¯”"><a href="#åŸºç¡€é•œåƒå¯¹æ¯”" class="headerlink" title="åŸºç¡€é•œåƒå¯¹æ¯”"></a>åŸºç¡€é•œåƒå¯¹æ¯”</h3><p>æ­¤å¤„ç›´æ¥æ‹‰å–åŸºç¡€é•œåƒï¼ŒæŸ¥çœ‹é•œåƒå¤§å°ï¼Œ é€šè¿‡è§‚å¯Ÿæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ<code>alpine</code>åªæœ‰ 5M å·¦å³ä¸º<code>debian</code>çš„ 20 åˆ†ä¹‹ä¸€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">alpine      latest    5cb3aa00f899        3 weeks ago         5.53MB<br>debian      latest    0af60a5c6dd0        3 weeks ago         101MB<br>ubuntu      18.04     47b19964fb50        7 weeks ago         88.1MB<br>ubuntu      latest    47b19964fb50        7 weeks ago         88.1MB<br>alpine      3.8       3f53bb00af94        3 months ago        4.41MB<br></code></pre></td></tr></table></figure><p>ä¼¼ä¹ä»ä¸Šé¢çœ‹ï¼Œæ„Ÿè§‰å·®è·ä¸å¤§ï¼Œå®è·µä¸­ï¼Œä¸åŒè¯­è¨€çš„åŸºç¡€é•œåƒéƒ½ä¼šæä¾›ä¸€äº›é‡‡ç”¨ä¸åŒåŸºç¡€é•œåƒåˆ¶ä½œçš„ tagï¼Œä¸‹é¢æˆ‘ä»¬ä»¥<code>ruby</code>çš„é•œåƒä¸ºä¾‹ï¼ŒæŸ¥çœ‹ä¸åŒåŸºç¡€é•œåƒçš„å·®å¼‚ã€‚å¯ä»¥çœ‹åˆ°é»˜è®¤çš„ latest é•œåƒ<code>881MB</code>è€Œ<code>alpine</code>ä»…ä»…åªæœ‰ä¸åˆ°<code>50MB</code>è¿™ä¸ªå·®è·å°±ååˆ†çš„å¯è§‚äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">ruby   latest   a5d26127d8d0        4 weeks ago         881MB<br>ruby   alpine   8d8f7d19d1fa        4 weeks ago         47.8MB<br>ruby   slim     58dd4d3c99da        4 weeks ago         125MB<br></code></pre></td></tr></table></figure><h2 id="å‡å°‘å±‚ï¼Œå»é™¤éå¿…è¦çš„æ–‡ä»¶"><a href="#å‡å°‘å±‚ï¼Œå»é™¤éå¿…è¦çš„æ–‡ä»¶" class="headerlink" title="å‡å°‘å±‚ï¼Œå»é™¤éå¿…è¦çš„æ–‡ä»¶"></a>å‡å°‘å±‚ï¼Œå»é™¤éå¿…è¦çš„æ–‡ä»¶</h2><ol><li>åˆ é™¤æ–‡ä»¶ä¸è¦è·¨è¡Œ</li></ol><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># dockerfile 1</span><br><span class="hljs-keyword">FROM</span> alpine<br><br><span class="hljs-keyword">RUN</span><span class="bash"> wget https://github.com/mohuishou/scuplus-wechat/archive/1.0.0.zip</span><br><br><span class="hljs-comment"># dockerfile 2</span><br><span class="hljs-keyword">FROM</span> alpine<br><br><span class="hljs-keyword">RUN</span><span class="bash"> wget https://github.com/mohuishou/scuplus-wechat/archive/1.0.0.zip</span><br><span class="hljs-keyword">RUN</span><span class="bash"> rm 1.0.0.zip</span><br><br><span class="hljs-comment"># dockerfile 3</span><br><span class="hljs-keyword">FROM</span> alpine<br><br><span class="hljs-keyword">RUN</span><span class="bash"> wget https://github.com/mohuishou/scuplus-wechat/archive/1.0.0.zip &amp;&amp;  rm 1.0.0.zip</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">test</span>   3  351a80e99c22        5 seconds ago        5.53MB<br><span class="hljs-built_in">test</span>   2  ad27e625b8e5        49 seconds ago       6.1MB<br><span class="hljs-built_in">test</span>   1  165e2e0df1d3        About a minute ago   6.1MB<br></code></pre></td></tr></table></figure><p>å¯ä»¥å‘ç° 1ï¼Œ2 ä¸¤ä¸ªå¤§å°ä¸€æ ·ï¼Œä½†æ˜¯ 3 å°äº† 0.5MBï¼Œè¿™æ˜¯å› ä¸º docker å‡ ä¹æ¯ä¸€è¡Œå‘½ä»¤éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå±‚ï¼Œåˆ é™¤æ–‡ä»¶çš„æ—¶å€™ï¼šå› ä¸ºåº•ä¸‹å„å±‚éƒ½æ˜¯åªè¯»çš„ï¼Œå½“éœ€è¦åˆ é™¤è¿™äº›å±‚ä¸­çš„æ–‡ä»¶æ—¶ï¼ŒAUFS ä½¿ç”¨ whiteout æœºåˆ¶ï¼Œå®ƒçš„å®ç°æ˜¯é€šè¿‡åœ¨ä¸Šå±‚çš„å¯å†™çš„ç›®å½•ä¸‹å»ºç«‹å¯¹åº”çš„ whiteout éšè—æ–‡ä»¶æ¥å®ç°çš„ï¼Œæ‰€ä»¥åœ¨å½“å‰å±‚å»åˆ é™¤ä¸Šä¸€å±‚çš„æ–‡ä»¶ï¼Œåªæ˜¯ä¼šæŠŠè¿™ä¸ªæ–‡ä»¶éšè—æ‰ç½¢äº†</p><ol start="2"><li>ä½¿ç”¨å•è¡Œå‘½ä»¤</li></ol><p>é™¤äº†åˆ é™¤è¯­å¥éœ€è¦æ”¾åœ¨ä¸€è¡Œä»¥å¤–ï¼Œç”±äºå±‚çš„æœºåˆ¶ï¼Œæˆ‘ä»¬å®‰è£…ä¾èµ–çš„ä¸€äº›å…¬å…±çš„è¯­å¥æœ€å¥½ä¹Ÿä½¿ç”¨æ¡<code>RUN</code>å‘½ä»¤ç”Ÿæˆï¼Œå‡å°‘æœ€ç»ˆçš„å±‚æ•°</p><ol start="3"><li><p>åˆ†ç¦»ä¾èµ–åŒ…ï¼Œä»¥åŠæºä»£ç ç¨‹åºï¼Œå……åˆ†åˆ©ç”¨å±‚çš„ç¼“å­˜</p><p>è¿™æ˜¯ä¸€ä¸ª<strong>æœ€ä½³å®è·µ</strong>ï¼Œåœ¨å®é™…çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çš„ä¾èµ–åŒ…å¾€å¾€æ˜¯å˜åŠ¨ä¸å¤§çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æ­£åœ¨å¼€å‘çš„æºç çš„å˜åŠ¨æ˜¯è¾ƒä¸ºé¢‘ç¹ï¼Œå¦‚æœæˆ‘ä»¬å®é™…çš„ä»£ç åªæœ‰<code>10M</code>ï¼Œä½†æ˜¯ä¾èµ–é¡¹æœ‰<code>1G</code>, å¦‚æœåœ¨<code>COPY</code>çš„æ—¶å€™ç›´æ¥<code>COPY . .</code>ä¼šå¯¼è‡´æ¯æ¬¡ä¿®æ”¹ä»£ç éƒ½ä¼šæ—¶è¿™ä¸€å±‚çš„ç¼“å­˜å¤±æ•ˆï¼Œå¯¼è‡´æµªè´¹å¤åˆ¶ä»¥åŠæ¨é€åˆ°é•œåƒä»“åº“çš„æ—¶é—´ï¼Œå°† COPY è¯­å¥åˆ†å¼€ï¼Œæ¯æ¬¡ push å°±å¯ä»¥åªå˜æ›´æˆ‘ä»¬é¢‘ç¹ä¿®æ”¹çš„ä»£ç å±‚ï¼Œè€Œä¸æ˜¯è¿ç€ä¾èµ–ä¸€èµ·</p></li><li><p>ä½¿ç”¨<code>.dockerignore</code></p><p>åœ¨ä½¿ç”¨<code>Git</code>æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>.gitignore</code>å¿½ç•¥æ–‡ä»¶ï¼Œåœ¨ docker build çš„æ—¶å€™ä¹Ÿå¯ä»¥ä½¿ç”¨<code>.dockerignore</code>åœ¨ Docker ä¸Šä¸‹æ–‡ä¸­å¿½ç•¥æ–‡ä»¶ï¼Œè¿™æ ·ä¸ä»…å¯ä»¥å‡å°‘ä¸€äº›éå¿…è¦æ–‡ä»¶çš„å¯¼å…¥ï¼Œä¹Ÿå¯ä»¥æé«˜å®‰å…¨æ€§ï¼Œé¿å…å°†ä¸€äº›é…ç½®æ–‡ä»¶æ‰“åŒ…åˆ°é•œåƒä¸­</p></li></ol><h2 id="å¤šé˜¶æ®µæ„å»º"><a href="#å¤šé˜¶æ®µæ„å»º" class="headerlink" title="å¤šé˜¶æ®µæ„å»º"></a>å¤šé˜¶æ®µæ„å»º</h2><p>å¤šé˜¶æ®µæ„å»ºå…¶å®ä¹Ÿæ˜¯å‡å°‘å±‚çš„ä¸€ç§ï¼Œé€šè¿‡å¤šé˜¶æ®µæ„å»ºï¼Œæœ€ç»ˆé•œåƒå¯ä»¥ä»…åŒ…å«æœ€åç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå’Œå¿…é¡»çš„è¿è¡Œæ—¶ä¾èµ–ï¼Œå¤§å¤§å‡å°‘é•œåƒä½“ç§¯ã€‚</p><p>ä»¥<code>GO</code>è¯­è¨€ä¸ºä¾‹ï¼Œå®é™…è¿è¡Œçš„è¿‡ç¨‹ä¸­åªéœ€è¦æœ€åç¼–è¯‘ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶å³å¯ï¼Œè€Œ<code>GO</code>è¯­è¨€æœ¬çœä»¥åŠæ‰©å±•åŒ…ï¼Œä»£ç æ–‡ä»¶éƒ½æ˜¯ä¸å¿…è¦çš„ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨ç¼–è¯‘çš„æ—¶å€™è¿™äº›ä¾èµ–åˆæ˜¯å¿…é¡»çš„ï¼Œè¿™æ—¶å€™å°±å¯ä»¥ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºçš„æ–¹å¼ï¼Œå‡å°‘æœ€ç»ˆç”Ÿæˆçš„é•œåƒä½“ç§¯</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># ä½¿ç”¨golangé•œåƒä½œä¸ºbuilderé•œåƒ</span><br><span class="hljs-keyword">FROM</span> golang:<span class="hljs-number">1.12</span> as builder<br><br><span class="hljs-keyword">WORKDIR</span><span class="bash"> /go/src/github.com/go/helloworld/</span><br><br><span class="hljs-keyword">COPY</span><span class="bash"> app.go .</span><br><br><span class="hljs-keyword">RUN</span><span class="bash"> go build -o app .</span><br><br><span class="hljs-comment"># ç¼–è¯‘å®Œæˆä¹‹åä½¿ç”¨alpineé•œåƒä½œä¸ºæœ€ç»ˆçš„åŸºç¡€é•œåƒ</span><br><span class="hljs-keyword">FROM</span> alpine:latest as prod<br><br><span class="hljs-keyword">RUN</span><span class="bash"> apk --no-cache add ca-certificates</span><br><br><span class="hljs-keyword">WORKDIR</span><span class="bash"> /root/</span><br><br><span class="hljs-comment"># ä»builderä¸­å¤åˆ¶ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶</span><br><span class="hljs-keyword">COPY</span><span class="bash"> --from=builder /go/src/github.com/go/helloworld/app .</span><br><br><span class="hljs-keyword">CMD</span><span class="bash"> [<span class="hljs-string">&quot;./app&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>ç”±äºæœ¬æ–‡ç¯‡å¹…è¾ƒé•¿ï¼Œè¿™é‡Œä¸å¯¹å¤šé˜¶æ®µæ„å»ºå±•å¼€è®²è§£ï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒ<a href="https://yeasy.gitbooks.io/docker_practice/image/multistage-builds/#%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA">å¤šé˜¶æ®µæ„å»º</a></p><h2 id="å¥‡æ·«æŠ€å·§"><a href="#å¥‡æ·«æŠ€å·§" class="headerlink" title="å¥‡æ·«æŠ€å·§"></a>å¥‡æ·«æŠ€å·§</h2><ol><li><p>ä½¿ç”¨<a href="https://github.com/wagoodman/dive">dive</a>æŸ¥çœ‹ docker é•œåƒçš„å±‚ï¼Œå¯ä»¥å¸®åŠ©ä½ åˆ†æå‡å°‘é•œåƒä½“ç§¯</p></li><li><p>ä½¿ç”¨<a href="https://github.com/docker-slim/docker-slim">docker-slim</a> å¯ä»¥è‡ªåŠ¨å¸®åŠ©ä½ å‡å°‘é•œåƒä½“ç§¯ï¼Œå¯¹äº Web åº”ç”¨è¾ƒä¸ºæœ‰ç”¨</p></li><li><p>å®‰è£…è½¯ä»¶æ—¶å»é™¤ä¾èµ–</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ubuntu</span><br>apt-get install -y â€”â€Šno-install-recommends<br><br><span class="hljs-comment">#alpine</span><br>apk add --no-cache &amp;&amp;  apk del build-dependencies<br><br><span class="hljs-comment"># centos</span><br>yum install -y ... &amp;&amp; yum clean all<br></code></pre></td></tr></table></figure><ol start="4"><li><p>ä½¿ç”¨<code>--flatten</code>å‚æ•°ï¼Œå‡å°‘å±‚(ä¸æ¨è)</p></li><li><p>ä½¿ç”¨<a href="https://github.com/jwilder/docker-squash">docker-squash</a>å‹ç¼©å±‚</p></li></ol><h2 id="ä¸åŒè¯­è¨€çš„ç¤ºä¾‹"><a href="#ä¸åŒè¯­è¨€çš„ç¤ºä¾‹" class="headerlink" title="ä¸åŒè¯­è¨€çš„ç¤ºä¾‹"></a>ä¸åŒè¯­è¨€çš„ç¤ºä¾‹</h2><blockquote><p>æ·»åŠ ä¸­â€¦â€¦</p></blockquote><h3 id="Ruby-Rails"><a href="#Ruby-Rails" class="headerlink" title="Ruby(Rails)"></a>Ruby(Rails)</h3><ol><li><p>åªå®‰è£…ç”Ÿäº§æ‰€éœ€çš„ä¾èµ–</p></li><li><p>åˆ é™¤ä¸éœ€è¦çš„ä¾èµ–æ–‡ä»¶</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">bundle install --without development:<span class="hljs-built_in">test</span>:assets -j4 --retry 3 --path=vendor/bundle \<br>    <span class="hljs-comment"># Remove unneeded files (cached *.gem, *.o, *.c)</span><br>    &amp;&amp; rm -rf vendor/bundle/ruby/2.5.0/cache/*.gem \<br>    &amp;&amp; find vendor/bundle/ruby/2.5.0/gems/ -name <span class="hljs-string">&quot;*.c&quot;</span> -delete \<br>    &amp;&amp; find vendor/bundle/ruby/2.5.0/gems/ -name <span class="hljs-string">&quot;*.o&quot;</span> -delete<br></code></pre></td></tr></table></figure><ol start="3"><li>åˆ é™¤å‰ç«¯çš„<code>node_modules</code>ä»¥åŠç¼“å­˜æ–‡ä»¶</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">rm -rf node_modules tmp/cache app/assets vendor/assets spec<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°å†…å®¹å¯ä»¥ç»“åˆ<strong>å¤šé˜¶æ®µæ„å»º</strong>å®ç°</p><h3 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h3><p>Golang åœ¨ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºä¹‹åï¼Œåªå‰©ä¸‹äº†ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™æ—¶å€™å†è¦ä¼˜åŒ–ï¼Œå°±åªæœ‰ä½¿ç”¨<code>upx</code>ä¹‹ç±»çš„å·¥å…·å‹ç¼©äºŒè¿›åˆ¶æ–‡ä»¶çš„ä½“ç§¯äº†</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><a href="http://dockone.io/article/8174">Docker å®¹å™¨é•œåƒç˜¦èº«çš„ä¸‰ä¸ªå°çªé—¨</a></li><li><a href="https://liulantao.com/docker-base-images.html">åŸºç¡€é•œåƒ | å†è°ˆ Docker ç˜¦èº«</a></li><li><a href="https://legacy.gitbook.com/book/yeasy/docker_practice/details">Docker â€”â€” ä»å…¥é—¨åˆ°å®è·µ</a>è¿™æ˜¯ä¸€æœ¬å¾ˆä¸é”™çš„ Docker å¼€æºä¹¦</li><li><a href="https://jingwei.link/2018/07/18/docker-namespace-cgroups-aufs.html#aufs">Docker åŸºæœ¬åŸç†ç®€æ</a></li><li><a href="https://medium.com/@lemuelbarango/ruby-on-rails-smaller-docker-images-bff240931332">Ruby on Railsâ€Šâ€”â€ŠSmaller docker images</a></li></ol><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>notes</category>
      
    </categories>
    
    
    <tags>
      
      <tag>blog</tag>
      
      <tag>docker</tag>
      
      <tag>cloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GORMé¿å‘æŒ‡å—ä¹‹å«å…³è”å…³ç³»çš„æ›´æ–°</title>
    <link href="/post/60163.html"/>
    <url>/post/60163.html</url>
    
    <content type="html"><![CDATA[<p>åœ¨ GORM çš„<a href="http://gorm.io/docs/update.html">æ–‡æ¡£</a>å½“ä¸­æœ‰è¯´æ˜ï¼Œä½¿ç”¨<code>Update</code>, <code>Updates</code>æ—¶åªä¼šæ›´æ–°æ”¹å˜çš„å­—æ®µï¼Œä½†æ˜¯å‡ºç°å…³è”å…³ç³»çš„æ—¶å€™æƒ…å†µä¼¼ä¹æœ‰äº†ä¸€äº›å¾®å¦™çš„å˜åŒ–</p><blockquote><p>If you only want to update changed Fields, you could use <code>Update</code>, <code>Updates</code></p></blockquote><a id="more"></a><h2 id="å…ˆè¯´ç»“è®º"><a href="#å…ˆè¯´ç»“è®º" class="headerlink" title="å…ˆè¯´ç»“è®º"></a>å…ˆè¯´ç»“è®º</h2><p><code>db.Model(&amp;user).Update(&quot;name&quot;, &quot;hello&quot;)</code>å¦‚æœ<code>user</code>åŒ…å«å…³è”å…³ç³»ï¼Œ<code>user</code>çš„å…³è”å…³ç³»å°†è¢«è‡ªåŠ¨æ›´æ–°</p><h2 id="é¿å‘"><a href="#é¿å‘" class="headerlink" title="é¿å‘"></a>é¿å‘</h2><p><strong>1.å¦‚æœç¡®è®¤ä¸ä¼šä½¿ç”¨åˆ°å…³è”ç›¸å…³çš„å›è°ƒï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨<code>UpdateColumn</code>,<code>UpdateColumns</code>æ–¹æ³•</strong></p><p>ä¸‹é¢æ˜¯æ¥è‡ª<a href="http://gorm.io/docs/update.html#Update-Columns-w-o-Hooks">å®˜æ–¹æ–‡æ¡£</a>çš„ä¾‹å­:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Update single attribute, similar with `Update`</span><br>db.Model(&amp;user).UpdateColumn(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;hello&quot;</span>)<br><span class="hljs-comment">//// UPDATE users SET name=&#x27;hello&#x27; WHERE id = 111;</span><br><br><span class="hljs-comment">// Update multiple attributes, similar with `Updates`</span><br>db.Model(&amp;user).UpdateColumns(User&#123;Name: <span class="hljs-string">&quot;hello&quot;</span>, Age: <span class="hljs-number">18</span>&#125;)<br><span class="hljs-comment">//// UPDATE users SET name=&#x27;hello&#x27;, age=18 WHERE id = 111;</span><br></code></pre></td></tr></table></figure><p><strong>2.å¦‚æœéœ€è¦ç”¨åˆ°ç›¸å…³çš„å›è°ƒï¼Œå¯ä»¥æ‰‹åŠ¨æŒ‡å®š<code>Model</code>é‡Œé¢çš„ç»“æ„ä½“</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">db.Model(&amp;User&#123;Model: Model&#123;ID: <span class="hljs-number">1</span>&#125;&#125;).UpdateColumn(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;hello&quot;</span>)<br></code></pre></td></tr></table></figure><h2 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h2><p>ä¸‹é¢è¿™ä¸€æ®µæ˜¯å®˜æ–¹æ–‡æ¡£ä¸­çš„ä¾‹å­ï¼Œåªä¼šæ›´æ–°æ›´æ–°<code>users</code>è¡¨çš„<code>name</code>å­—æ®µ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Update single attribute if it is changed</span><br>db.Model(&amp;user).Update(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;hello&quot;</span>)<br><span class="hljs-comment">//// UPDATE users SET name=&#x27;hello&#x27;, updated_at=&#x27;2013-11-17 21:34:10&#x27; WHERE id=111;</span><br></code></pre></td></tr></table></figure><p>ä½†æ˜¯å¦‚æœ<code>Model(&amp;struct)</code>,<code>struct</code>åŒ…å«å…³è”å…³ç³»æ—¶ï¼Œ<code>struct</code>å…³è”å…³ç³»å°†è¢«æ›´æ–°ï¼Œå¦‚ä»¥ä¸‹æ‰€ç¤º:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Product <span class="hljs-keyword">struct</span> &#123;<br>gorm.Model<br>Code         <span class="hljs-keyword">string</span><br>Price        <span class="hljs-keyword">uint</span><br>Applications []Application<br>&#125;<br><br><span class="hljs-keyword">type</span> Application <span class="hljs-keyword">struct</span> &#123;<br>gorm.Model<br>Name      <span class="hljs-keyword">string</span><br>ProductID <span class="hljs-keyword">uint</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// Migrate the schema</span><br>db.AutoMigrate(&amp;Product&#123;&#125;, &amp;Application&#123;&#125;)<br><br><span class="hljs-comment">// Create</span><br>db.Create(&amp;Product&#123;Code: <span class="hljs-string">&quot;L1212&quot;</span>, Price: <span class="hljs-number">1000</span>&#125;)<br><br><span class="hljs-comment">// Read</span><br><span class="hljs-keyword">var</span> product Product<br>db.First(&amp;product, <span class="hljs-number">1</span>) <span class="hljs-comment">// find product with id 1</span><br>product.Applications = []Application&#123;<br>&#123;<br>Name: <span class="hljs-string">&quot;test&quot;</span>,<br>&#125;,<br>&#125;<br><span class="hljs-comment">// Update - update product&#x27;s price to 2000</span><br>db.Model(&amp;product).Update(<span class="hljs-string">&quot;Price&quot;</span>, <span class="hljs-number">1000</span>)<br>    <span class="hljs-comment">// UPDATE products SET price = &#x27;1000&#x27;, updated_at = &#x27;2019-01-29 21:58:52&#x27;  WHERE products.deleted_at IS NULL</span><br><span class="hljs-comment">// INSERT INTO applications (created_at,updated_at,deleted_at,name,product_id) VALUES (&#x27;2019-01-29 21:58:52&#x27;,&#x27;2019-01-29 21:58:52&#x27;,NULL,&#x27;test&#x27;,&#x27;0&#x27;)</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="æº¯æº"><a href="#æº¯æº" class="headerlink" title="æº¯æº"></a>æº¯æº</h2><blockquote><p>è¯¥éƒ¨åˆ†é»˜è®¤å¯¹ GORM çš„æºç æœ‰ä¸€å®šçš„äº†è§£</p></blockquote><p>æŸ¥çœ‹<code>Model</code>ç›¸å…³çš„æºç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°<code>Model</code>å…¶å®å°±æ˜¯<code>clone</code>äº†ä¸€ä¸ª<code>DB</code>å¯¹è±¡ç„¶åå°†ä¼ å…¥çš„æŒ‡é’ˆèµ‹å€¼ç»™<code>Value</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Model specify the model you would like to run db operations</span><br><span class="hljs-comment">//    // update all users&#x27;s name to `hello`</span><br><span class="hljs-comment">//    db.Model(&amp;User&#123;&#125;).Update(&quot;name&quot;, &quot;hello&quot;)</span><br><span class="hljs-comment">//    // if user&#x27;s primary key is non-blank, will use it as condition, then will only update the user&#x27;s name to `hello`</span><br><span class="hljs-comment">//    db.Model(&amp;user).Update(&quot;name&quot;, &quot;hello&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *DB)</span> <span class="hljs-title">Model</span><span class="hljs-params">(value <span class="hljs-keyword">interface</span>&#123;&#125;)</span> *<span class="hljs-title">DB</span></span> &#123;<br>c := s.clone()<br>c.Value = value<br><span class="hljs-keyword">return</span> c<br>&#125;<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹<code>Update/Updates</code>ç›¸å…³çš„æºç æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œè¿™é‡Œè®²éœ€è¦æ›´æ–°çš„å­—æ®µé€šè¿‡<code>InstanceSet(&quot;gorm:update_interface&quot;, values)</code>ä¿å­˜äº†ä¸‹æ¥</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Update update attributes with callbacks, refer: https://jinzhu.github.io/gorm/crud.html#update</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *DB)</span> <span class="hljs-title">Update</span><span class="hljs-params">(attrs ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span> *<span class="hljs-title">DB</span></span> &#123;<br><span class="hljs-keyword">return</span> s.Updates(toSearchableMap(attrs...), <span class="hljs-literal">true</span>)<br>&#125;<br><br><span class="hljs-comment">// Updates update attributes with callbacks, refer: https://jinzhu.github.io/gorm/crud.html#update</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *DB)</span> <span class="hljs-title">Updates</span><span class="hljs-params">(values <span class="hljs-keyword">interface</span>&#123;&#125;, ignoreProtectedAttrs ...<span class="hljs-keyword">bool</span>)</span> *<span class="hljs-title">DB</span></span> &#123;<br><span class="hljs-keyword">return</span> s.NewScope(s.Value).<br>Set(<span class="hljs-string">&quot;gorm:ignore_protected_attrs&quot;</span>, <span class="hljs-built_in">len</span>(ignoreProtectedAttrs) &gt; <span class="hljs-number">0</span>).<br>InstanceSet(<span class="hljs-string">&quot;gorm:update_interface&quot;</span>, values).<br>callCallbacks(s.parent.callbacks.updates).db<br>&#125;<br></code></pre></td></tr></table></figure><p>å†çœ‹çœ‹å…³è”å…³ç³»æ›´æ–°çš„ä»£ç ï¼Œ åªæœ‰ä¸€ä¸ªå‚æ•°<code>scope</code>,<code>scope</code>å“ªå„¿æ¥çš„å‘¢ï¼Œä¸Šé¢çš„<code>s.NewScope(s.Value)</code>,è¿™ä¸ªåœ°æ–¹å…¶å®ä¹Ÿæ˜¯å°†æœ€å¼€å§‹<code>Model</code>ä¸­çš„ <code>value</code>æ‹·è´äº†ä¸€ä»½</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">saveAfterAssociationsCallback</span><span class="hljs-params">(scope *Scope)</span></span> &#123;<br>    <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨å…³ç³»å…³ç³»ç„¶åæ›´æ–°bala bala...</span><br>    <span class="hljs-keyword">for</span> _, field := <span class="hljs-keyword">range</span> scope.Fields() &#123;<br>autoUpdate, autoCreate, saveReference, relationship := saveAssociationCheck(scope, field)<br>        <span class="hljs-comment">//...</span><br>    &#125;<br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™ä¸ªäº†å·®ä¸å¤šå°±å¯æ˜ç™½äº†ï¼Œä¸»è¦åŸå› æ˜¯å› ä¸º<code>Model</code>çš„<code>value</code>ä¸€ç›´è·Ÿéšåˆ°äº†æœ€åï¼Œå¯¼è‡´æœ€åæ‰§è¡Œå…³è”å…³ç³»æ›´æ–°å›è°ƒçš„æ—¶å€™ï¼Œæ£€æµ‹åˆ°æœ‰å…³è”æ•°æ®æ•°æ®è¡¨ä¸­ä¸å­˜åœ¨ï¼Œå°±ä¼šè‡ªç„¶çš„æ ¹æ®å…³è”å…³ç³»æ’å…¥è¿›å»</p><h2 id="ç›¸å…³èµ„æº"><a href="#ç›¸å…³èµ„æº" class="headerlink" title="ç›¸å…³èµ„æº"></a>ç›¸å…³èµ„æº</h2><ol><li>ç›®å‰è¿˜ä¸æ¸…æ¥šè¿™æ˜¯ä¸€ä¸ª bug è¿˜æ˜¯ä¸€ä¸ª featureï¼Œå…ˆæäº¤äº†ä¸€ä¸ª issue: <a href="https://github.com/jinzhu/gorm/issues/2278">https://github.com/jinzhu/gorm/issues/2278</a></li><li><a href="https://lailin.xyz/post/notes/%E4%B8%80%E4%B8%AA%E5%8D%81%E5%88%86%E8%BE%B9%E7%BC%98%E7%9A%84gorm%E7%9A%84bug/">ä¸€ä¸ªååˆ†è¾¹ç¼˜çš„ gorm çš„ bug</a></li></ol><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>blog</tag>
      
      <tag>note</tag>
      
      <tag>gorm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Github Actionsä»‹ç»&amp;è‡ªåŠ¨æ„å»ºGithub Pagesåšå®¢</title>
    <link href="/post/28054.html"/>
    <url>/post/28054.html</url>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡å°†ä¸»è¦è®²è¿°å¦‚ä½•åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ Github Actionsï¼Œ å¹¶ä¸”ä½¿ç”¨ Github Actions å®Œæˆ CI/CD çš„æ“ä½œ</p><a id="more"></a><blockquote><p>æ•…äº‹çš„èµ·å› å°±æ˜¯ï¼Œgithub çš„ç§æœ‰ä»“åº“å…è´¹äº†, æ‰“ç®—å°† blog ä»“åº“åˆ‡æ¢ä¸ºç§æœ‰ä»“åº“ï¼Œè¿™æ ·å¯ä»¥åŒæ—¶å°†ç¬”è®°å’Œåšå®¢æ”¾åœ¨ä¸€å—ï¼Œåˆ©ç”¨ hugo çš„ draft åŠŸèƒ½ï¼Œå°†ä¸æƒ³å‘å¸ƒçš„æ–‡ç« è®¾ç½® true å³å¯ã€‚</p><p>ä¿®æ”¹ä¹‹åç”±äºä¹‹å‰ä½¿ç”¨ Travis CI è‡ªåŠ¨æ„å»ºåšå®¢çš„é™æ€é¡µé¢ï¼Œè€Œ Travis CI å¯¹äºç§æœ‰ä»“åº“åªèƒ½è¯•ç”¨ 100 æ¬¡ï¼Œæ­£å¥½ä¹‹å‰è·å¾—äº† Github Actions çš„æµ‹è¯•èµ„æ ¼ï¼Œä½†æ˜¯ä¸€ç›´éƒ½è¿˜æ²¡æœ‰ä½¿ç”¨è¿‡ï¼Œæœ¬æ¬¡è®°å½•ä¸€ä¸‹ Github Actions çš„ä½¿ç”¨è¿‡ç¨‹</p></blockquote><h2 id="Actions"><a href="#Actions" class="headerlink" title="Actions"></a>Actions</h2><p>actions å¯ä»¥ç”¨æ¥ä½œä¸º CI/CD ä½¿ç”¨ï¼Œä½†æ˜¯å®ƒä¸åªæ˜¯ CI/CDï¼Œå› ä¸ºå®ƒå…¶å®æ˜¯ä¸€ç»„ docker å®¹å™¨æ‰€ç»„æˆçš„ Workflowï¼ŒWorkflow çš„è§¦å‘æ¡ä»¶ï¼Œå…¬å…±ä»“åº“ç›®å‰ä»…æ”¯æŒ pushï¼Œç§æœ‰ä»“åº“åˆ™æ”¯æŒ check_runã€createã€deleteã€issue commentï¼Œ commit comment, pull request ç­‰è®¸å¤šäº‹ä»¶, é€šè¿‡è¿™äº›äº‹ä»¶ï¼Œå¯ä»¥å®Œæˆé™¤äº† CI/CD ä¹‹å¤–çš„è®¸å¤šè‡ªåŠ¨åŒ–æ“ä½œï¼Œä¾‹å¦‚æ¥æ”¶åˆ° issue comment ä¹‹åä½¿ç”¨ telegram bot å‘é€é€šçŸ¥ç­‰ç­‰</p><h3 id="åˆ›å»ºä¸€ä¸ª-Workflow"><a href="#åˆ›å»ºä¸€ä¸ª-Workflow" class="headerlink" title="åˆ›å»ºä¸€ä¸ª Workflow"></a>åˆ›å»ºä¸€ä¸ª Workflow</h3><p>å¦‚æœä½ æœ‰æƒé™çš„è¯ï¼Œåœ¨ä½ çš„ä»“åº“ä¸‹åº”è¯¥å¯ä»¥çœ‹åˆ°ä¸€ä¸ª Actions çš„èœå•</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190115223805.png" alt=""></p><h3 id="Workflow-GUI"><a href="#Workflow-GUI" class="headerlink" title="Workflow GUI"></a>Workflow GUI</h3><p>å¦‚ä¸‹å›¾æ‰€ç¤º</p><ol><li>åˆ‡æ¢è§†å›¾ï¼Œä»å·¦åˆ°å³åˆ†åˆ«æ˜¯ï¼ŒGUI çš„æ–¹å¼ç¼–è¾‘ï¼Œç›´æ¥ç¼–è¾‘æ–‡ä»¶ï¼ŒæŸ¥çœ‹å˜åŠ¨</li><li>workflow åŒºåŸŸï¼Œä¸€ä¸ª main.workflow æ–‡ä»¶ä¸‹å¯ä»¥åŒ…å«å¤šä¸ª workflowï¼Œæ¯ä¸€ä¸ª workflow</li><li>æ¯ä¸ª workflow å…·ä½“çš„ç¼–è¾‘åŒºåŸŸï¼Œæ¯ä¸ª workflow å¯ä»¥å…³è”å¤šä¸ª actionï¼Œæ¯ä¸ª action éƒ½æœ‰å¤´å°¾ä¸¤ä¸ªç‚¹ï¼Œç‚¹å‡»ä¸‹æ‹‰å³å¯è¿æ¥èµ·æ¥</li><li>ä¿å­˜æäº¤æŒ‰é’®</li></ol><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190115224518.png" alt=""></p><h4 id="Workflow-edit"><a href="#Workflow-edit" class="headerlink" title="Workflow edit"></a>Workflow edit</h4><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œworkflow åªæœ‰ä¸¤ä¸ªå¯é€‰çš„ä¿®æ”¹é¡¹ï¼Œåˆ†åˆ«æ˜¯ Name ä»¥åŠè§¦å‘æ¡ä»¶ï¼Œè§¦å‘æ¡ä»¶å…¬å…±ä»“åº“ç›®å‰ä»…æ”¯æŒ pushï¼Œç§æœ‰ä»“åº“åˆ™æ”¯æŒ check_runã€createã€deleteã€issue commentï¼Œ commit comment, pull request ç­‰è®¸å¤šäº‹ä»¶ã€‚å®Œæ•´çš„è§¦å‘æ¡ä»¶å¯ä»¥æŸ¥çœ‹ <a href="https://developer.github.com/actions/creating-workflows/workflow-configuration-options/#events-supported-in-workflow-files">Events supported in workflow files</a></p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190115230105.png" alt=""></p><h4 id="action-edit"><a href="#action-edit" class="headerlink" title="action edit"></a>action edit</h4><p>å¦‚ä¸‹å›¾æ‰€ç¤º</p><ol><li>uses ä½¿ç”¨çš„ docker é•œåƒ, åœ¨ <a href="https://github.com/actions">https://github.com/actions</a> æä¾›äº†ä¸€äº›å¸¸ç”¨çš„ actions å¯ä»¥ç›´æ¥ä½¿ç”¨<ol><li><code>&#123;user&#125;/&#123;repo&#125;/&#123;path&#125;@&#123;ref&#125;</code> ç›´æ¥ä½¿ç”¨å…¬å¼€çš„ä»“åº“ï¼Œä»“åº“é‡Œå¿…é¡»åŒ…å« dockerfile, path ä¸ºå¯é€‰é¡¹ï¼Œæ²¡æœ‰ path é»˜è®¤ä¸ºæ ¹è·¯å¾„ï¼Œe.g <code>actions/heroku@master</code>, <a href="mailto:`actions/aws/ec2@v2.0.1">`actions/aws/ec2@v2.0.1</a>`</li><li><code>./path/to/dir</code>å½“å‰ä»“åº“çš„ç›¸å¯¹è·¯å¾„</li><li><code>docker://&#123;host&#125;/&#123;image&#125;:&#123;tag&#125;</code> docker é•œåƒåœ°å€ï¼Œhost ä¸ºå¯é€‰é¡¹ï¼Œä¸å¡« host é»˜è®¤ä» dockerhub æ‹‰å–ï¼Œe.g <code>docker://mohuishou/hugo:0.53</code>, <code>docker://gcr.io/cloud-builders/gradle</code></li></ol></li><li>label å°±æ˜¯æ ‡ç­¾</li><li>runs è¦†ç›– dockerfile ä¸­çš„ entrypoint</li><li>args è¦†ç›– dockerfile ä¸­çš„ cmd</li><li>secret è¯»å–è¯¥ä»“åº“ä¿å­˜çš„ç§˜å¯†å˜é‡ï¼Œå°†ä»¥ç¯å¢ƒå˜é‡çš„å½¢å¼æ³¨å…¥åˆ°è¿è¡Œçš„å®¹å™¨ä¸­</li><li>env æ³¨å…¥åˆ°è¿è¡Œçš„å®¹å™¨ä¸­çš„ç¯å¢ƒå˜é‡ï¼Œæ˜¯å¯è§çš„</li></ol><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/20190116000345.png" alt=""></p><h3 id="åˆ›å»º-Action"><a href="#åˆ›å»º-Action" class="headerlink" title="åˆ›å»º Action"></a>åˆ›å»º Action</h3><p>Action å…¶å®å°±æ˜¯ Docker é•œåƒï¼ŒæŒ‰ç…§ Docker é•œåƒçš„å†™æ³•å³å¯ï¼Œéœ€è¦å…³æ³¨ä»¥ä¸‹å‡ ç‚¹</p><h4 id="1-Dockerfile-Lables"><a href="#1-Dockerfile-Lables" class="headerlink" title="1. Dockerfile Lables"></a>1. Dockerfile Lables</h4><p>github actions ä¼šè¯»å– dockerfile çš„ label åœ¨ Workflow GUI ä¸Šåšä¸€äº›å±•ç¤º</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">LABEL</span><span class="bash"> <span class="hljs-string">&quot;com.github.actions.name&quot;</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment">#Github action çš„åå­—</span></span><br><span class="hljs-keyword">LABEL</span><span class="bash"> <span class="hljs-string">&quot;com.github.actions.description&quot;</span>=<span class="hljs-string">&quot;desc&quot;</span> <span class="hljs-comment">#è¯´æ˜</span></span><br><span class="hljs-keyword">LABEL</span><span class="bash"> <span class="hljs-string">&quot;com.github.actions.icon&quot;</span>=<span class="hljs-string">&quot;mic&quot;</span> <span class="hljs-comment">#GUIä¸Šå±•ç¤ºçš„å›¾æ ‡</span></span><br><span class="hljs-keyword">LABEL</span><span class="bash"> <span class="hljs-string">&quot;com.github.actions.color&quot;</span>=<span class="hljs-string">&quot;purple&quot;</span> <span class="hljs-comment"># GUIä¸Šå±•ç¤ºçš„é¢œè‰²</span></span><br><br><span class="hljs-keyword">LABEL</span><span class="bash"> <span class="hljs-string">&quot;repository&quot;</span>=<span class="hljs-string">&quot;http://github.com/mohuishou/hugo-action&quot;</span> <span class="hljs-comment"># ä»“åº“åœ°å€</span></span><br><span class="hljs-keyword">LABEL</span><span class="bash"> <span class="hljs-string">&quot;homepage&quot;</span>=<span class="hljs-string">&quot;http://github.com/mohuishou&quot;</span> <span class="hljs-comment"># ä¸»é¡µ</span></span><br><span class="hljs-keyword">LABEL</span><span class="bash"> <span class="hljs-string">&quot;maintainer&quot;</span>=<span class="hljs-string">&quot;mohuishou &lt;1@lailin.xyz&gt;&quot;</span> <span class="hljs-comment"># ä½œè€…</span></span><br></code></pre></td></tr></table></figure><h4 id="2-Env"><a href="#2-Env" class="headerlink" title="2. Env"></a>2. Env</h4><p>é»˜è®¤çš„ç¯å¢ƒå˜é‡ï¼Œä»¥åŠå¦‚ä½•è¯»å–</p><h5 id="é»˜è®¤ç¯å¢ƒå˜é‡"><a href="#é»˜è®¤ç¯å¢ƒå˜é‡" class="headerlink" title="é»˜è®¤ç¯å¢ƒå˜é‡"></a>é»˜è®¤ç¯å¢ƒå˜é‡</h5><p>æ‰€æœ‰çš„é»˜è®¤å€¼å¯ä»¥å‚è€ƒè¿™é‡Œ <a href="https://developer.github.com/actions/creating-github-actions/accessing-the-runtime-environment/#environment-variables">Environment variables</a></p><p>å¸¸ç”¨çš„ä¸»è¦æœ‰</p><table><thead><tr><th>Environment variable</th><th>Description</th></tr></thead><tbody><tr><td><code>GITHUB_ACTOR</code></td><td>ç”¨æˆ·çš„åå­—</td></tr><tr><td><code>GITHUB_REPOSITORY</code></td><td>ç”¨æˆ·å’Œä»“åº“çš„åœ°å€ ä¾‹å¦‚ <code>mohuishou/hugo-action</code></td></tr><tr><td><code>GITHUB_WORKSPACE</code></td><td>github çš„å·¥ä½œåŒºï¼Œ é»˜è®¤å€¼ä¸º <code>/github/workspace</code></td></tr><tr><td><code>GITHUB_TOKEN</code></td><td>workflow çš„ github token å¯ä»¥ç”¨æ¥ clone æ‹‰å–æ•°æ®ï¼Œä½†æ˜¯æ²¡æœ‰ push çš„æƒé™</td></tr></tbody></table><h5 id="è¯»å–ç¯å¢ƒå˜é‡"><a href="#è¯»å–ç¯å¢ƒå˜é‡" class="headerlink" title="è¯»å–ç¯å¢ƒå˜é‡"></a>è¯»å–ç¯å¢ƒå˜é‡</h5><p>è¯»å–ç¯å¢ƒå˜é‡æ—¶éœ€è¦æ³¨æ„ï¼Œç¯å¢ƒå˜é‡æ˜¯åœ¨å®¹å™¨è¿è¡Œæ—¶æ³¨å…¥çš„ï¼Œæ‰€ä»¥åœ¨ dockerfile é‡Œé¢æ²¡æœ‰åŠæ³•ç›´æ¥ä½¿ç”¨</p><h2 id="ä½¿ç”¨-hugo-action-è‡ªåŠ¨-build-amp-push-åšå®¢"><a href="#ä½¿ç”¨-hugo-action-è‡ªåŠ¨-build-amp-push-åšå®¢" class="headerlink" title="ä½¿ç”¨ hugo-action è‡ªåŠ¨ build&amp;push åšå®¢"></a>ä½¿ç”¨ hugo-action è‡ªåŠ¨ build&amp;push åšå®¢</h2><p><a href="https://github.com/mohuishou/hugo-action">https://github.com/mohuishou/hugo-action</a></p><h3 id="éµå¾ªä»¥ä¸‹çº¦å®š"><a href="#éµå¾ªä»¥ä¸‹çº¦å®š" class="headerlink" title="éµå¾ªä»¥ä¸‹çº¦å®š"></a>éµå¾ªä»¥ä¸‹çº¦å®š</h3><ol><li>ä½ çš„åšå®¢æºä»£ç åœ°å€å’Œ github pages åœ°å€ä¸åŒ</li><li>github pages ä»“åº“åœ°å€ä¸º <code>youname.github.io</code></li></ol><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>åˆ›å»ºæ–‡ä»¶ <code>.github/main.workflow</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">workflow <span class="hljs-string">&quot;blog ci/cd&quot;</span> &#123;<br>  on = <span class="hljs-string">&quot;push&quot;</span><br>  resolves = [<span class="hljs-string">&quot;hugo&quot;</span>]<br>&#125;<br><br>action <span class="hljs-string">&quot;hugo&quot;</span> &#123;<br>  uses = <span class="hljs-string">&quot;docker://mohuishou/hugo-action:0.53&quot;</span><br>  secrets = [<br>    <span class="hljs-string">&quot;TOKEN&quot;</span>,<br>  ]<br>  env = &#123;<br>    EMAIL = <span class="hljs-string">&quot;1@lailin.xyz&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h3><table><thead><tr><th>Key</th><th>Value</th><th>Must</th></tr></thead><tbody><tr><td>TOKEN</td><td>ä½ çš„ github tokenï¼Œéœ€è¦æœ‰ push æƒé™ï¼Œä¿å­˜åœ¨å¯†ç å˜é‡ä¸­</td><td>yes</td></tr><tr><td>EMAIL</td><td>ä½ çš„é‚®ç®±</td></tr></tbody></table><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ol><li><a href="https://developer.github.com/actions/">å®˜æ–¹æ–‡æ¡£</a></li><li><a href="https://github.com/xitu/gold-miner/blob/master/TODO1/introducing-github-actions.md">GitHub Actions ä»‹ç»ï¼Œäº†è§£ä¸€ä¸‹ï¼Ÿ</a></li><li><a href="https://github.com/actions">Github Actions Repo</a></li></ol><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>blog</tag>
      
      <tag>notes</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åœ¨blogä¸­å†…åµŒåœ¨çº¿PPT</title>
    <link href="/post/7944.html"/>
    <url>/post/7944.html</url>
    
    <content type="html"><![CDATA[<p>æœ‰æ—¶æˆ‘ä»¬ä¼šåšä¸€äº›åˆ†äº«ï¼Œåˆ†äº«ä¹‹åå¯ä»¥æŠŠ PPT è„±æ•ä¹‹åæ”¾åœ¨åšå®¢ä¸Šé¢ï¼Œå¯ä»¥ä½¿ç”¨ office online ç›´æ¥å†…åµŒ PPT, å·¨ç¡¬å¤§æ³•å¥½</p><a id="more"></a><h2 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h2><ol><li>åœ¨çº¿æ’­æ”¾</li><li>æ”¯æŒåŠ¨ç”»</li><li>æ”¯æŒæ’­æ”¾å†…åµŒè§†é¢‘</li><li>è‡ªé€‚åº”</li></ol><p>ä¸Šé¢çš„éœ€æ±‚, WPS äº‘æ–‡æ¡£æ”¯æŒ 1, ä»¥åŠä¸€äº›ç®€å•çš„åŠ¨ç”»ï¼ŒOffice online æ”¯æŒ 1,2,3 ç¬¬å››ç‚¹æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å• js è„šæœ¬è§£å†³</p><h2 id="è·å–åˆ†äº«é“¾æ¥"><a href="#è·å–åˆ†äº«é“¾æ¥" class="headerlink" title="è·å–åˆ†äº«é“¾æ¥"></a>è·å–åˆ†äº«é“¾æ¥</h2><p>1.ç™»å½• <a href="https://onedrive.live.com">https://onedrive.live.com</a> ä¸Šä¼ éœ€è¦åˆ†äº«çš„ PPT 2.å¦‚ä¸‹å›¾æ‰€ç¤º æ‰“å¼€åˆšåˆšä¸Šä¼ çš„ PPT æ–‡ä»¶<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/assets/20181208165037.png?x-oss-process=image/resize,w_800" alt=""></p><p>3.ç‚¹å‡»å³ä¸Šè§’çš„æ–‡ä»¶ -&gt; å…±äº« -&gt; åµŒå…¥<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/assets/20181208170149.png?x-oss-process=image/resize,w_800" alt=""></p><p>4.è·å–åˆ†äº«é“¾æ¥ï¼Œå°†ä»£ç ä¸­çš„åˆ†äº«é“¾æ¥å¤åˆ¶<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/assets/20181208170334.png?x-oss-process=image/resize,w_800" alt=""></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;è¿™é‡Œæ˜¯ä½ çš„åˆ†äº«é“¾æ¥&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;350px&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;221px&quot;</span> <span class="hljs-attr">frameborder</span>=<span class="hljs-string">&quot;0&quot;</span></span><br><span class="hljs-tag">  &gt;</span>è¿™æ˜¯åµŒå…¥<br>  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;https://office.com&quot;</span>&gt;</span>Microsoft Office<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> æ¼”ç¤ºæ–‡ç¨¿ï¼Œç”±<br>  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;https://office.com/webapps&quot;</span>&gt;</span>Office Online<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>  æ”¯æŒã€‚<br><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span><br></code></pre></td></tr></table></figure><p>5.ä¿®æ”¹ä»£ç è‡ªé€‚åº”ï¼Œå°†ä¸Šä¸€æ­¥è·å–åˆ°çš„é“¾æ¥æ›¿æ¢åˆ°ä¸‹æ–¹ä»£ç ä¸­ï¼Œå¤åˆ¶ç²˜è´´åˆ°åšå®¢ä¸­å³å¯</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs html">&lt;iframe<br>  id=&quot;ppt&quot;<br>  width=&quot;100%&quot;<br>  onload=&quot;autoChange()&quot;<br>  src=&quot;åœ¨æ­¤å¤„æ›¿æ¢ä¸ºä½ çš„PPTé“¾æ¥&quot;<br>  frameborder=&quot;0&quot;<br>&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><br><span class="javascript">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">autoChange</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="javascript">    <span class="hljs-keyword">let</span> ifm = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;ppt&quot;</span>);</span><br>    ifm.height = (ifm.clientWidth / 16) * 9 + 24;<br>  &#125;<br><span class="javascript">  <span class="hljs-built_in">window</span>.onresize = autoChange;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><p><a href="https://lailin.xyz/post/notes/pprof-go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/">https://lailin.xyz/post/notes/pprof-go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/</a></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Office Online å¯¹äº PPT æ”¯æŒç›¸å½“çš„å¥½ï¼Œå”¯ä¸€çš„ç¼ºç‚¹å¯èƒ½å°±æ˜¯åœ¨å›½å†…æœ‰äº›çš„ç¡®è¢«å¢™ï¼Œå¯èƒ½éœ€è¦ FQ æ‰èƒ½è®¿é—®</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>blog</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è®°ä¸€æ¬¡net httpå†…å­˜æ³„æ¼</title>
    <link href="/post/44107.html"/>
    <url>/post/44107.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>ä½¿ç”¨ gin ä½œä¸ºæ–‡ä»¶ä¸‹è½½æœåŠ¡å™¨ï¼Œå†…å­˜å ç”¨çªç„¶ä»å‡ å M åˆ°äº† 10G ä»¥ä¸Šï¼Œå¯¼è‡´æœåŠ¡è¢« kill é‡å¯</p></blockquote><h2 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h2><p><code>server.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>r := gin.Default()<br>r.GET(<span class="hljs-string">&quot;/download&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(context *gin.Context)</span></span> &#123;<br>f, err := os.Open(<span class="hljs-string">&quot;./win7.iso&quot;</span>)<br>log.Println(err)<br><span class="hljs-keyword">defer</span> f.Close()<br>info, _ := f.Stat()<br>b := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">byte</span>, info.Size())<br>f.Read(b)<br>context.Data(<span class="hljs-number">200</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>, b)<br>&#125;)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>log.Println(http.ListenAndServe(<span class="hljs-string">&quot;localhost:6060&quot;</span>, <span class="hljs-literal">nil</span>))<br>&#125;()<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br>time.Sleep(time.Second * <span class="hljs-number">30</span>)<br>runtime.GC()<br>log.Println(<span class="hljs-string">&quot;gc&quot;</span>)<br>&#125;<br>&#125;()<br>runtime.MemProfileRate = <span class="hljs-number">16</span> * <span class="hljs-number">1024</span><br>r.Run(<span class="hljs-string">&quot;:8080&quot;</span>)<br>&#125;<br><br></code></pre></td></tr></table></figure><p><code>client.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>resp, _ := http.Get(<span class="hljs-string">&quot;http://localhost:8080/download&quot;</span>)<br>resp.Body.Close()<br>log.Println(<span class="hljs-string">&quot;ok&quot;</span>)<br><span class="hljs-keyword">select</span> &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨<code>pprof</code>æˆ‘ä»¬å¯ä»¥å‘ç°å†…å­˜å ç”¨é«˜è¾¾<code>3GB</code>, å³ä½¿æˆ‘ä¸»åŠ¨è°ƒç”¨äº† GC è¿™ä¸ªå†…å­˜ä»æœªé‡Šæ”¾</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/assets/profile001.gif" alt=""></p><h2 id="è¿½æº¯"><a href="#è¿½æº¯" class="headerlink" title="è¿½æº¯"></a>è¿½æº¯</h2><p>é€šè¿‡æŸ¥çœ‹ä»£ç æˆ‘ä»¬å¯ä»¥å‘ç°è¯·æ±‚å·²ç»ç»“æŸï¼Œä»£ç å¹¶æ²¡æœ‰å…¶ä»–åœ°æ–¹å¯¹<code>[]byte</code>å¼•ç”¨ï¼Œä¸€ç›´è¿½æº¯åˆ°æœ€ä½å±‚ä¹Ÿä¸è§å…¶ä»–å¼•ç”¨ã€‚</p><p>ä½†æ˜¯ç»“æŸ<code>client</code>è¿›ç¨‹ä¹‹åä¼šæœ‰ä¸€ä¸ªç¥å¥‡çš„å‘ç°ï¼Œç»“æŸ client ä¹‹åè¿™ä¸€å—å†…å­˜å°±å¯ä»¥è¢« GC æ‰</p><p>é€šè¿‡è¿™ä¸ªç°è±¡è‡ªç„¶è€Œç„¶çš„å°±æƒ³åˆ°å¯èƒ½æ˜¯ TCP é“¾æ¥æ²¡æœ‰æ–­å¼€ï¼Œå¯¼è‡´è¿™ä¸€å—å†…å­˜çš„å¼•ç”¨å¹¶æ²¡æœ‰è¢«é‡Šæ”¾æ‰</p><p>http æ˜¯ä¸€ä¸ªæœ¬èº«æ˜¯çŸ­è¿æ¥ï¼Œä½†æ˜¯ä¸ºäº†å¤ç”¨ TCP è¿æ¥æ‰€ä»¥æœ‰äº†<code>keep-alive</code>ï¼Œä½†æ˜¯å¯¹äºä¸‹è½½æœåŠ¡æ¥è¯´æˆ‘ä»¬å…¶å®ä¸ç”¨å¤ç”¨ TCP è¿æ¥ï¼Œåªéœ€è¦åœ¨æ–‡ä»¶ä¸‹è½½å®Œæ¯•ä¹‹åä¸»åŠ¨å…³é—­è¿™ä¸ªè¿æ¥å³å¯ï¼Œæ‰€ä»¥æˆ‘åˆ†åˆ«åœ¨ client åŠ ä¸Šäº†ä¸€ä¸ª header</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">Connection</span>: <span class="hljs-keyword">close</span><br></code></pre></td></tr></table></figure><p>å†æ¬¡é€šè¿‡<code>pprof</code>æŸ¥çœ‹å†…å­˜å ç”¨å‘ç°å†…å­˜ä»æœªå¾—åˆ°é‡Šæ”¾</p><h2 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h2><p>é€šè¿‡ rfc æ–‡æ¡£ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°è§„èŒƒå¹¶æ²¡æœ‰è§„å®šç”±è°æ¥å…³é—­é“¾æ¥ï¼ŒGo net/http å¸Œæœ›å®¢æˆ·ç«¯å…³é—­é“¾æ¥</p><p><a href="https://tools.ietf.org/html/rfc2616#page-117">https://tools.ietf.org/html/rfc2616#page-117</a></p><blockquote><p>HTTP/1.1 defines the â€œcloseâ€ connection option for the sender to signal that the connection will be closed after completion of the response.</p></blockquote><h2 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h2><ol><li>ä½¿ç”¨æµè€Œä¸æ˜¯ç›´æ¥è¯»å†…å­˜ï¼Œåœ¨<code>gin</code>ä¸­ä¸è¦ç›´æ¥ä½¿ç”¨<code>c.Data</code>è€Œæ˜¯ä½¿ç”¨<code>c.DataFromReader</code></li><li>ä½¿ç”¨ AWS S3 ç­‰å­˜å‚¨æœåŠ¡ä¸‹å‘æ–‡ä»¶ï¼Œå‡è½»æœåŠ¡å‹åŠ›</li><li>å°½é‡ä¸ä½¿ç”¨å®˜æ–¹çš„<code>net/http</code>å¤„ç†æ–‡ä»¶</li><li><a href="https://jiajunhuang.com">@jiajun è€å¸ˆ</a> å·²ç»ç»™ Go å®˜æ–¹æäº†ä¸€ä¸ª <a href="https://github.com/golang/go/pull/28936">PR</a>ï¼Œç­‰å¾… PR Merge</li></ol><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><a href="https://jiajunhuang.com/articles/2018_11_24-memory_leak_in_net_http.md.html">https://jiajunhuang.com/articles/2018_11_24-memory_leak_in_net_http.md.html</a></li><li><a href="https://tools.ietf.org/html/rfc2616">https://tools.ietf.org/html/rfc2616</a></li><li><a href="https://lailin.xyz/post/notes/pprof-go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/">https://lailin.xyz/post/notes/pprof-go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/</a></li></ol><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>notes</tag>
      
      <tag>å†…å­˜æ³„æ¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pprof goæ€§èƒ½åˆ†æå·¥å…·</title>
    <link href="/post/40393.html"/>
    <url>/post/40393.html</url>
    
    <content type="html"><![CDATA[<p>PPT åˆ†äº«(å¯èƒ½éœ€è¦ FQ æ–¹èƒ½è®¿é—®ï¼Œéœ€è¦å¯ä»¥è®¿é—®, onedrive.live.com)</p><a id="more"></a><iframe id="ppt" width="100%" onload="changeFrameHeight()"  src="https://onedrive.live.com/embed?cid=9B44A0E26836C4FF&amp;resid=9B44A0E26836C4FF%211837&amp;authkey=AAoxyFlzZ39JQvM&amp;em=2&amp;wdAr=1.7777777777777777" frameborder="0">è¿™æ˜¯åµŒå…¥ <a target="_blank" href="https://office.com">Microsoft Office</a> æ¼”ç¤ºæ–‡ç¨¿ï¼Œç”± <a target="_blank" href="https://office.com/webapps">Office Online</a> æ”¯æŒã€‚</iframe><script>function changeFrameHeight(){    var ifm= document.getElementById("ppt");    console.log(ifm.width)    ifm.height=ifm.clientWidth / 16 * 9 + 24;}window.onresize = changeFrameHeight</script><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>blog</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä½¿ç”¨TravisCIè‡ªåŠ¨éƒ¨ç½²Blog</title>
    <link href="/post/52061.html"/>
    <url>/post/52061.html</url>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰åšå®¢çš„æ›´æ–°ä¸€ç›´éƒ½æ˜¯åœ¨æœ¬åœ°è¿è¡Œ<code>hugo</code>ç„¶åæ‰‹åŠ¨ push åˆ° github ä»“åº“ï¼Œè™½ç„¶å†™äº†ä¸€ä¸ªå°è„šæœ¬ï¼Œä½†æ˜¯æœ¬åœ°è¿˜æ˜¯å¤šäº†ä¸€ä¸ª public æ–‡ä»¶å¤¹ï¼Œæœ€è¿‘çœ‹äº† travis ci å¯ä»¥å’Œ github å®Œç¾çš„ç»“åˆã€‚å…³äº travis ci ä¸è¿‡å¤šä»‹ç»ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥ç›´æ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œå†™çš„éå¸¸è¯¦ç»†</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># æŒ‡å®šè¿è¡Œè¯­è¨€ä¸ºgo</span><br><span class="hljs-attr">language:</span> <span class="hljs-string">go</span><br><br><span class="hljs-comment"># æŒ‡å®šgoè¯­è¨€ç‰ˆæœ¬</span><br><span class="hljs-attr">go:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;1.10.x&quot;</span><br><br><span class="hljs-comment"># å®‰è£…ä¾èµ–ï¼Œå®‰è£…hugo</span><br><span class="hljs-attr">install:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">wget</span> <span class="hljs-string">https://github.com/gohugoio/hugo/releases/download/v0.49/hugo_0.49_Linux-64bit.tar.gz</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">tar</span> <span class="hljs-string">-xzvf</span> <span class="hljs-string">hugo_0.49_Linux-64bit.tar.gz</span><br><br><span class="hljs-comment"># åœ¨scriptæ‰§è¡Œå‰æ‰§è¡Œï¼Œè®¾ç½®gitç”¨æˆ·åï¼Œé‚®ç®±ï¼Œä»githubæŠŠblogæ–‡ä»¶æ‹‰ä¸‹æ¥</span><br><span class="hljs-attr">before_script:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">config</span> <span class="hljs-string">--global</span> <span class="hljs-string">user.email</span> <span class="hljs-string">&quot;1@lailin.xyz&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">config</span> <span class="hljs-string">--global</span> <span class="hljs-string">user.name</span> <span class="hljs-string">&quot;mohuishou&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">clone</span> <span class="hljs-string">https://$GITHUB_TOKEN@github.com/mohuishou/mohuishou.github.io.git</span> <span class="hljs-string">public</span><br>  <span class="hljs-comment"># clone ä¸»é¢˜</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">clone</span> <span class="hljs-string">https://github.com/laozhu/hugo-nuo</span> <span class="hljs-string">themes/hugo-nuo</span><br><br><span class="hljs-comment"># ç”Ÿæˆé™æ€ç½‘é¡µ</span><br><span class="hljs-attr">script:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">./hugo</span><br><br><span class="hljs-comment"># è¿è¡ŒæˆåŠŸä¹‹åå°†é¡µé¢æ¨é€åˆ°githubä¸Š</span><br><span class="hljs-attr">after_success:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">cd</span> <span class="hljs-string">public</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">add</span> <span class="hljs-string">.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">commit</span> <span class="hljs-string">-m</span> <span class="hljs-string">&#x27;travis auto update&#x27;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">push</span> <span class="hljs-string">-u</span> <span class="hljs-string">origin</span> <span class="hljs-string">master</span><br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>notes</tag>
      
      <tag>ci</tag>
      
      <tag>hugo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä½¿ç”¨Golandè°ƒè¯•Goç¨‹åº</title>
    <link href="/post/37623.html"/>
    <url>/post/37623.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>åœ¨ä¸Šä¸€ç¯‡ Blog å½“ä¸­å‘ç°äº†ä¸€ä¸ªååˆ†è¾¹ç¼˜çš„ GORM çš„ bugï¼Œç”±äºä¸ç†Ÿæ‚‰å·¥å…·ï¼Œbug çš„è°ƒè¯•è¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦ï¼Œè¿™ä¸€ç¯‡è®²ä¸€è®²å¦‚ä½•ä½¿ç”¨ Goland å¼ºå¤§çš„ debug åŠŸèƒ½è°ƒè¯• Go ç¨‹åº</p></blockquote><a id="more"></a><h2 id="Goland"><a href="#Goland" class="headerlink" title="Goland"></a>Goland</h2><p>Goland æ˜¯ jb å…¬å¸çš„ Go è¯­è¨€ IDEï¼Œå’Œ jb å®¶æ—çš„å…¶ä»– IDE ä¸€æ ·çš„å¼ºå¤§å¹¶ä¸”åƒå†…å­˜</p><p>ä¸‹è½½åœ°å€: <a href="https://www.jetbrains.com/go">https://www.jetbrains.com/go</a></p><h2 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h2><h3 id="where"><a href="#where" class="headerlink" title="where"></a>where</h3><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨<code>main</code>å‡½æ•°æˆ–è€…æ˜¯å•å…ƒæµ‹è¯•å‡½æ•°çš„æ—è¾¹ä¼šå‡ºç°ä¸€ä¸ªæ‰§è¡Œçš„æŒ‰é’®<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141140.jpg" alt=""><br>åœ¨å±å¹•çš„å³ä¸Šè§’ä¹Ÿå¯ä»¥çœ‹è§ä¸€ä¸ªå°è™«å­çš„æŒ‰é’®ï¼Œç‚¹å‡»å°±å¯ä»¥å¼€å§‹ debug<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141151.jpg" alt=""></p><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç‚¹å‡» Edit æ‰“å¼€é…ç½®çª—å£<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141152.jpg" alt=""><br>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥å¯¹å½“å‰çš„è¿è¡Œå‘½ä»¤è¿›è¡Œé…ç½®ï¼Œæˆ–è€…ç‚¹å‡»ä¸‹æ–¹ templatesï¼Œå¯¹æ¨¡æ¿é…ç½®ï¼Œä¿®æ”¹æ¨¡æ¿é…ç½®ï¼Œåœ¨å½“å‰é¡¹ç›®ä¹‹åå†ç‚¹å‡» go run æ—¶ï¼Œä¼šè‡ªåŠ¨é‡‡ç”¨æ¨¡æ¿çš„é…ç½®<br>é…ç½®å¯ä»¥å¯¹æ–‡ä»¶ï¼Œç¯å¢ƒå˜é‡ï¼Œè¿è¡Œå‘½ä»¤ç­‰è¿›è¡Œé…ç½®ï¼Œä¸€èˆ¬ç”¨çš„æ¯”è¾ƒå¤šçš„å°±æ˜¯ç¯å¢ƒå˜é‡<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141153.jpg" alt=""></p><h3 id="æ–­ç‚¹"><a href="#æ–­ç‚¹" class="headerlink" title="æ–­ç‚¹"></a>æ–­ç‚¹</h3><p>å¦‚å›¾æ‰€ç¤ºç‚¹å‡»è¡Œå·å’Œä»£ç ä¹‹é—´çš„ç©ºç™½å³å¯æ·»åŠ æ–­ç‚¹<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141154.jpg" alt=""><br>å¦‚å›¾æ‰€ç¤ºï¼Œå³é”®ç‚¹å‡»çº¢ç‚¹ï¼Œå¯ä»¥å¯¹æ–­ç‚¹è¿›è¡Œä¸€äº›é«˜çº§çš„è®¾å®š<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141155.jpg" alt=""><br>ç‚¹å‡» more ä¼šå‡ºç°å¦‚ä¸‹å¼¹çª—<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141156.jpg" alt=""></p><h3 id="çª—å£"><a href="#çª—å£" class="headerlink" title="çª—å£"></a>çª—å£</h3><p>ç‚¹å‡» Debug å¼€å§‹è¿è¡Œä¹‹åï¼Œä¼šå‡ºç°ä¸€ä¸ª debug çª—å£ï¼Œå½“å‰çš„çª—å£æ˜¯ console çª—å£<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141157.jpg" alt=""><br>ç‚¹å‡» debugger å¯ä»¥çœ‹åˆ°æ•´ä¸ªç¨‹åºçš„è°ƒç”¨æ ˆï¼Œç‚¹å‡»ç›¸åº”çš„è°ƒç”¨æ ˆå¯ä»¥è°ƒè½¬çš„ç›¸åº”çš„ä»£ç ï¼Œå¹¶ä¸”æ˜¾ç¤ºå½“å‰çš„å˜é‡ä¿¡æ¯<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141158.jpg" alt=""><br>å¦‚å›¾æ‰€ç¤ºå¯ä»¥åœ¨å½“å‰æ ˆï¼Œæ‰§è¡Œç›¸åº”çš„å‘½ä»¤ï¼Œä½†æ˜¯æš‚æ—¶è¿˜ä¸æ”¯æŒæ‰§è¡Œæ–¹æ³•ï¼Œåªèƒ½æŸ¥çœ‹å˜é‡æˆ–è€…æ˜¯è°ƒç”¨å˜é‡çš„å±æ€§<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141159.jpg" alt=""></p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>tool</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸€ä¸ªååˆ†è¾¹ç¼˜çš„gormçš„bug</title>
    <link href="/post/37449.html"/>
    <url>/post/37449.html</url>
    
    <content type="html"><![CDATA[<p>[toc]</p><h2 id="å¤ç°ä»£ç "><a href="#å¤ç°ä»£ç " class="headerlink" title="å¤ç°ä»£ç "></a>å¤ç°ä»£ç </h2><p>è¿™ä¸ªä»£ç çš„è§¦å‘æ¡ä»¶æ¯”è¾ƒä¸¥è‹›ï¼Œé¦–å…ˆå¿…é¡»è¦ä¿è¯ gorm æ‰§è¡Œçš„ä¸€è¡Œå¿…é¡»ä¸º<code>updates</code>è¯­å¥ï¼Œå¹¶ä¸”åœ¨<code>updates(struct)</code>,å¹¶ä¸”ä¼ å…¥çš„è¿™ä¸ª<code>struct</code>å¿…é¡»è¦åŒ…å«ä¸€ä¸ªç›´æ¥æˆ–è€…é—´æ¥å…³è”çš„ä¸€ä¸ªå¤šæ€è¡¨ï¼Œè¿™äº›æ¡ä»¶ç¼ºä¸€ä¸å¯</p><a id="more"></a><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> A <span class="hljs-keyword">struct</span> &#123;<br>gorm.Model<br>Name <span class="hljs-keyword">string</span><br>B    B <span class="hljs-string">`gorm:&quot;polymorphic:Owner&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">type</span> B <span class="hljs-keyword">struct</span> &#123;<br>gorm.Model<br>OwnerID   <span class="hljs-keyword">uint</span><br>OwnerType <span class="hljs-keyword">string</span><br>&#125;<br><br>a := A&#123;Name: <span class="hljs-string">&quot;test&quot;</span>&#125;<br>db = db.Model(&amp;a)<br>db.Where(a)<br>db.Updates(A&#123;Name: <span class="hljs-string">&quot;test2&quot;</span>&#125;) <span class="hljs-comment">// panic</span><br></code></pre></td></tr></table></figure><h2 id="ç°è±¡"><a href="#ç°è±¡" class="headerlink" title="ç°è±¡"></a>ç°è±¡</h2><p>å…ˆè¯´ç°è±¡ï¼Œåœ¨ä¸€æ¬¡ä»£ç è”è°ƒçš„è¿‡ç¨‹å½“ä¸­ï¼Œå‘ç°è°ƒç”¨ä¸€ä¸ªæ›´æ–°æ¥å£çš„æ—¶å€™ä¼šæŠ¥ 500 é”™è¯¯ï¼ˆpanicï¼‰ï¼Œä½†æ˜¯åœ¨ä»€ä¹ˆéƒ½ä¸ä¿®æ”¹çš„æƒ…å†µä¸‹ï¼Œå†æ¬¡è°ƒç”¨æ¥å£ï¼Œæ›´æ–°æˆåŠŸ</p><p>é”™è¯¯æ—¥å¿—å¦‚ä¸‹ï¼Œæ˜¯ç”±äºä¸€ä¸ªç©ºæŒ‡é’ˆçš„è°ƒç”¨:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-built_in">panic</span>: runtime error: invalid memory address or <span class="hljs-literal">nil</span> pointer dereference<br><br>github.com/jinzhu/gorm.(*DB).clone(<span class="hljs-number">0x0</span>, <span class="hljs-number">0x0</span>)<br>E:/SoftFile/GOPATH/src/github.com/jinzhu/gorm/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">715</span> +<span class="hljs-number">0x4e</span><br>github.com/jinzhu/gorm.(*DB).Model(<span class="hljs-number">0x0</span>, <span class="hljs-number">0x6cb460</span>, <span class="hljs-number">0xc00017c160</span>, <span class="hljs-number">0x0</span>)<br>E:/SoftFile/GOPATH/src/github.com/jinzhu/gorm/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">445</span> +<span class="hljs-number">0x32</span><br>github.com/jinzhu/gorm.(*Scope).TableName(<span class="hljs-number">0xc000172100</span>, <span class="hljs-number">0xc00016c3c0</span>, <span class="hljs-number">0x6f894a</span>)<br>E:/SoftFile/GOPATH/src/github.com/jinzhu/gorm/scope.<span class="hljs-keyword">go</span>:<span class="hljs-number">325</span> +<span class="hljs-number">0x133</span><br>github.com/jinzhu/gorm.(*Scope).GetModelStruct.func2(<span class="hljs-number">0xc000170010</span>, <span class="hljs-number">0xc000172100</span>, <span class="hljs-number">0xc00017a050</span>, <span class="hljs-number">0xc0001749c0</span>)<br>E:/SoftFile/GOPATH/src/github.com/jinzhu/gorm/model_struct.<span class="hljs-keyword">go</span>:<span class="hljs-number">420</span> +<span class="hljs-number">0x24c7</span><br>github.com/jinzhu/gorm.(*Scope).GetModelStruct(<span class="hljs-number">0xc000172100</span>, <span class="hljs-number">0xc00017a050</span>)<br>E:/SoftFile/GOPATH/src/github.com/jinzhu/gorm/model_struct.<span class="hljs-keyword">go</span>:<span class="hljs-number">574</span> +<span class="hljs-number">0x140c</span><br>github.com/jinzhu/gorm.(*Scope).Fields(<span class="hljs-number">0xc000172100</span>, <span class="hljs-number">0xc000172100</span>, <span class="hljs-number">0x2030000</span>, <span class="hljs-number">0x2030000</span>)<br>E:/SoftFile/GOPATH/src/github.com/jinzhu/gorm/scope.<span class="hljs-keyword">go</span>:<span class="hljs-number">115</span> +<span class="hljs-number">0xaf</span><br>github.com/jinzhu/gorm.convertInterfaceToMap(<span class="hljs-number">0x6cb460</span>, <span class="hljs-number">0xc00017c160</span>, <span class="hljs-number">0xc00017c001</span>, <span class="hljs-number">0x199</span>)<br>E:/SoftFile/GOPATH/src/github.com/jinzhu/gorm/scope.<span class="hljs-keyword">go</span>:<span class="hljs-number">860</span> +<span class="hljs-number">0x4f8</span><br>github.com/jinzhu/gorm.(*Scope).updatedAttrsWithValues(<span class="hljs-number">0xc000172080</span>, <span class="hljs-number">0x6cb460</span>, <span class="hljs-number">0xc00017c160</span>, <span class="hljs-number">0x6cb460</span>, <span class="hljs-number">0xc00017c160</span>)<br>E:/SoftFile/GOPATH/src/github.com/jinzhu/gorm/scope.<span class="hljs-keyword">go</span>:<span class="hljs-number">877</span> +<span class="hljs-number">0x8b</span><br>github.com/jinzhu/gorm.assignUpdatingAttributesCallback(<span class="hljs-number">0xc000172080</span>)<br>E:/SoftFile/GOPATH/src/github.com/jinzhu/gorm/callback_update.<span class="hljs-keyword">go</span>:<span class="hljs-number">25</span> +<span class="hljs-number">0x81</span><br>github.com/jinzhu/gorm.(*Scope).callCallbacks(<span class="hljs-number">0xc000172080</span>, <span class="hljs-number">0xc00012ff00</span>, <span class="hljs-number">0x9</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0xc00017c160</span>)<br>E:/SoftFile/GOPATH/src/github.com/jinzhu/gorm/scope.<span class="hljs-keyword">go</span>:<span class="hljs-number">831</span> +<span class="hljs-number">0x5c</span><br>github.com/jinzhu/gorm.(*DB).Updates(<span class="hljs-number">0xc00017e090</span>, <span class="hljs-number">0x6cb460</span>, <span class="hljs-number">0xc00017c160</span>, <span class="hljs-number">0x0</span>, <span class="hljs-number">0x0</span>, <span class="hljs-number">0x0</span>, <span class="hljs-number">0xc00017e090</span>)<br>E:/SoftFile/GOPATH/src/github.com/jinzhu/gorm/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">383</span> +<span class="hljs-number">0x13b</span><br>main.main()<br>E:/SoftFile/GOPATH/src/github.com/mohuishou/test/main.<span class="hljs-keyword">go</span>:<span class="hljs-number">34</span> +<span class="hljs-number">0x269</span><br></code></pre></td></tr></table></figure><h2 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2><p>é¦–å…ˆä» panic çš„å †æ ˆé¡¶ç«¯å¾€ä¸‹çœ‹, æ˜¯è°ƒç”¨<code>s.db</code>çš„æ—¶å€™æŠ¥çš„é”™ï¼Œæ¨æ–­åº”è¯¥æ˜¯<code>s</code>çš„å€¼ä¸º<code>nil</code>å¯¼è‡´çš„é”™è¯¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *DB)</span> <span class="hljs-title">clone</span><span class="hljs-params">()</span> *<span class="hljs-title">DB</span></span> &#123;<br>db := &amp;DB&#123;<br>db:                s.db, <span class="hljs-comment">// ä»è¿™ä¸€è¡Œå¼€å§‹panic</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ç€å¾€ä¸‹çœ‹ï¼Œè¿™é‡Œçš„<code>s</code>åº”è¯¥ä¹Ÿæ˜¯ä¸€ä¸ª<code>nil</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Model specify the model you would like to run db operations</span><br><span class="hljs-comment">//    // update all users&#x27;s name to `hello`</span><br><span class="hljs-comment">//    db.Model(&amp;User&#123;&#125;).Update(&quot;name&quot;, &quot;hello&quot;)</span><br><span class="hljs-comment">//    // if user&#x27;s primary key is non-blank, will use it as condition, then will only update the user&#x27;s name to `hello`</span><br><span class="hljs-comment">//    db.Model(&amp;user).Update(&quot;name&quot;, &quot;hello&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *DB)</span> <span class="hljs-title">Model</span><span class="hljs-params">(value <span class="hljs-keyword">interface</span>&#123;&#125;)</span> *<span class="hljs-title">DB</span></span> &#123;<br>c := s.clone() <span class="hljs-comment">// ä»è¿™é‡Œè°ƒç”¨</span><br>c.Value = value<br><span class="hljs-keyword">return</span> c<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ç€èµ°, åœ¨è·å–è¡¨åçš„æ—¶å€™ï¼Œéœ€è¦è°ƒç”¨<code>scope.db.Model</code>ï¼Œ è¿™é‡Œçš„ db åº”è¯¥æ˜¯ä¸€ä¸ª<code>nil</code>å¯¼è‡´è°ƒç”¨å¤±è´¥</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// TableName return table name</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(scope *Scope)</span> <span class="hljs-title">TableName</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br>    <span class="hljs-comment">// ...</span><br><span class="hljs-keyword">return</span> scope.GetModelStruct().TableName(scope.db.Model(scope.Value))<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»ä¸‹é¢çš„è°ƒç”¨ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå®åœ¨è·å–<code>Struct</code>çš„ç»“æ„çš„æ—¶å€™ï¼Œç”±äºæœ‰å¤šæ€å…³è”(<code>polymorphic</code>)çš„ tagï¼Œæ‰€ä»¥éœ€è¦è·å–å¤šæ€è¡¨çš„<code>TableName</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(scope *Scope)</span> <span class="hljs-title">GetModelStruct</span><span class="hljs-params">()</span> *<span class="hljs-title">ModelStruct</span></span> &#123;<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">if</span> polymorphic := field.TagSettings[<span class="hljs-string">&quot;POLYMORPHIC&quot;</span>]; polymorphic != <span class="hljs-string">&quot;&quot;</span> &#123;<br>        <span class="hljs-keyword">if</span> value, ok := field.TagSettings[<span class="hljs-string">&quot;POLYMORPHIC_VALUE&quot;</span>]; ok &#123;<br>            relationship.PolymorphicValue = value<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// è¿™é‡Œè°ƒç”¨</span><br>            relationship.PolymorphicValue = scope.TableName()<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨<code>GetModelStruct</code>çš„åŸå› æ˜¯å› ä¸ºéœ€è¦è·å–<code>value</code>çš„æ‰€æœ‰å­—æ®µï¼Œå­—æ®µç­‰äº nil çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨<code>GetModelStruct</code>å»è·å–</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Fields get value&#x27;s fields</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(scope *Scope)</span> <span class="hljs-title">Fields</span><span class="hljs-params">()</span> []*<span class="hljs-title">Field</span></span> &#123;<br><span class="hljs-keyword">if</span> scope.fields == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">for</span> _, structField := <span class="hljs-keyword">range</span> scope.GetModelStruct().StructFields &#123;<br>            <span class="hljs-comment">// ...</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹è¿™ä¸ªå‡½æ•°å¯ä»¥å‘ç°ï¼Œä¼šæŠŠ<code>interface</code>è½¬ä¸º<code>map</code>, ç”±äºæˆ‘ä»¬æœ€å¼€å§‹ä¼ å…¥çš„æ˜¯<code>db.Updates(A&#123;Name: &quot;test2&quot;&#125;)</code>æ¡ä»¶æ˜¯ä¸€ä¸ª struct æ‰€ä»¥ä¼šæ‰§è¡Œä¸‹é¢<code>case interface&#123;&#125; -&gt; default</code>åˆ†æ”¯ã€‚æ­¤æ—¶ä¼šè°ƒç”¨<code>(&amp;Scope&#123;Value: values&#125;).Fields()</code>ï¼Œè¿™æ—¶å€™å¯ä»¥å‘ç°<code>Scope</code>è¿™ä¸ªå¯¹è±¡åœ¨åˆå§‹è¯çš„æ—¶å€™æ˜¯æ²¡æœ‰<code>db</code>è¿™ä¸ªå­—æ®µçš„ï¼Œæ‰€ä»¥åœ¨è·å– table name çš„æ—¶å€™éœ€è¦è°ƒç”¨åˆ°<code>scope.db</code>è¿™æ—¶å€™å°±ä¼š panic</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">convertInterfaceToMap</span><span class="hljs-params">(values <span class="hljs-keyword">interface</span>&#123;&#125;, withIgnoredField <span class="hljs-keyword">bool</span>)</span> <span class="hljs-title">map</span>[<span class="hljs-title">string</span>]<span class="hljs-title">interface</span></span>&#123;&#125; &#123;<br><span class="hljs-keyword">var</span> attrs = <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&#125;<br><br><span class="hljs-keyword">switch</span> value := values.(<span class="hljs-keyword">type</span>) &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;:<br><span class="hljs-keyword">return</span> value<br><span class="hljs-keyword">case</span> []<span class="hljs-keyword">interface</span>&#123;&#125;:<br><span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> value &#123;<br><span class="hljs-keyword">for</span> key, value := <span class="hljs-keyword">range</span> convertInterfaceToMap(v, withIgnoredField) &#123;<br>attrs[key] = value<br>&#125;<br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-keyword">interface</span>&#123;&#125;:<br>reflectValue := reflect.ValueOf(values)<br><br><span class="hljs-keyword">switch</span> reflectValue.Kind() &#123;<br><span class="hljs-keyword">case</span> reflect.Map:<br><span class="hljs-keyword">for</span> _, key := <span class="hljs-keyword">range</span> reflectValue.MapKeys() &#123;<br>attrs[ToDBName(key.Interface().(<span class="hljs-keyword">string</span>))] = reflectValue.MapIndex(key).Interface()<br>&#125;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-comment">// åœ¨è¿™é‡Œè°ƒç”¨</span><br><span class="hljs-keyword">for</span> _, field := <span class="hljs-keyword">range</span> (&amp;Scope&#123;Value: values&#125;).Fields() &#123;<br><span class="hljs-keyword">if</span> !field.IsBlank &amp;&amp; (withIgnoredField || !field.IsIgnored) &#123;<br>attrs[field.DBName] = field.Field.Interface()<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> attrs<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œè¿™ä¸ª bug å°±ç®—ç»“æ¡ˆäº†ï¼Œä½†æ˜¯æ¥ç€çœ‹çœ‹ï¼Œä¸ºä»€ä¹ˆä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°.</p><p>è¿™ä¸ªå‡½æ•°ä¼šè·å–éœ€è¦æ›´æ–°çš„å­—æ®µ<code>map</code>,å¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ª<code>struct</code>ï¼Œä¼šè½¬æ¢ä¸º<code>map</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(scope *Scope)</span> <span class="hljs-title">updatedAttrsWithValues</span><span class="hljs-params">(value <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-params">(results <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;, hasUpdate <span class="hljs-keyword">bool</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> scope.IndirectValue().Kind() != reflect.Struct &#123;<br><span class="hljs-keyword">return</span> convertInterfaceToMap(value, <span class="hljs-literal">false</span>), <span class="hljs-literal">true</span><br>&#125;<br><br>results = <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&#125;<br><br><span class="hljs-keyword">for</span> key, value := <span class="hljs-keyword">range</span> convertInterfaceToMap(value, <span class="hljs-literal">true</span>) &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¼šæŠŠè·å–åˆ°éœ€è¦æ›´æ–°çš„ map ä¿å­˜ä¸‹æ¥</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// assignUpdatingAttributesCallback assign updating attributes to model</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">assignUpdatingAttributesCallback</span><span class="hljs-params">(scope *Scope)</span></span> &#123;<br><span class="hljs-keyword">if</span> attrs, ok := scope.InstanceGet(<span class="hljs-string">&quot;gorm:update_interface&quot;</span>); ok &#123;<br><span class="hljs-keyword">if</span> updateMaps, hasUpdate := scope.updatedAttrsWithValues(attrs); hasUpdate &#123;<br>scope.InstanceSet(<span class="hljs-string">&quot;gorm:update_attrs&quot;</span>, updateMaps)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>scope.SkipLeft()<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p><a href="https://github.com/jinzhu/gorm/pull/2105">https://github.com/jinzhu/gorm/pull/2105</a></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><h3 id="GORMï¼Œä½¿ç”¨-map-è€Œä¸æ˜¯-struct"><a href="#GORMï¼Œä½¿ç”¨-map-è€Œä¸æ˜¯-struct" class="headerlink" title="GORMï¼Œä½¿ç”¨ map è€Œä¸æ˜¯ struct"></a>GORMï¼Œä½¿ç”¨ map è€Œä¸æ˜¯ struct</h3><p>åœ¨ä½¿ç”¨çš„ GORM çš„æ—¶å€™ï¼Œéœ€è¦æ›´æ–°ä¸€äº›å­—æ®µçš„æ—¶å€™<strong>æœ€å¥½ä½¿ç”¨ map è€Œä¸æ˜¯ struct</strong>ï¼Œå› ä¸ºå¦‚æœä½¿ç”¨ structï¼Œgorm æœ€ç»ˆä¼šæŠŠè¿™ä¸ª struct è½¬æ¢ä¸º mapï¼Œå¹¶ä¸”å¦‚æœè¿™ä¸ª struct åŒ…å«ä¸€äº›å…³è”å…³ç³»ï¼Œgorm ä¼šä¸€ç›´é€’å½’çš„æŸ¥æ‰¾è½¬æ¢ä¸‹å»ï¼Œå¦‚æœæ•´ä¸ªè¡¨çš„å…³è”å…³ç³»æ¯”è¾ƒå¤æ‚ï¼Œä¼šå¯¼è‡´æ•ˆç‡æ¯”è¾ƒä½ä¸‹</p><h3 id="ä¸ºä»€ä¹ˆä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼Œç¬¬äºŒæ¬¡è¿è¡Œå°±ä¸ä¼š-panic"><a href="#ä¸ºä»€ä¹ˆä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼Œç¬¬äºŒæ¬¡è¿è¡Œå°±ä¸ä¼š-panic" class="headerlink" title="ä¸ºä»€ä¹ˆä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼Œç¬¬äºŒæ¬¡è¿è¡Œå°±ä¸ä¼š panic"></a>ä¸ºä»€ä¹ˆä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼Œç¬¬äºŒæ¬¡è¿è¡Œå°±ä¸ä¼š panic</h3><p>è¿™æ˜¯ç”±äº GORM ä¼šå¯¹ struct çš„ç»“æ„æœ‰ä¸€ä¸ªå…¨å±€çš„ç¼“å­˜<code>modelStructsMap</code>ï¼Œç”±äºè¿™ä¸ªæ˜¯å› ä¸ºæŸ¥æ‰¾å…³è”å…³ç³»çš„æ—¶å€™æŠ¥é”™ï¼Œå…¶æœ¬èº«å·²ç»æ–°å»ºäº†ä¸€ä¸ª<code>modelstruct</code>å¹¶ä¸”ç¼“å­˜äº†ä¸‹æ¥ï¼Œæ‰€ä»¥å†æ¬¡è°ƒç”¨çš„æ—¶å€™å°±ä¸ä¼šæ‰§è¡Œåé¢çš„ä»£ç äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// GetModelStruct get value&#x27;s model struct, relationships based on struct and tag definition</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(scope *Scope)</span> <span class="hljs-title">GetModelStruct</span><span class="hljs-params">()</span> *<span class="hljs-title">ModelStruct</span></span> &#123;<br><span class="hljs-comment">//...</span><br><span class="hljs-comment">// Get Cached model struct</span><br><span class="hljs-keyword">if</span> value := modelStructsMap.Get(reflectType); value != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> value<br>&#125;<br><span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è°ƒè¯•æ€»ç»“"><a href="#è°ƒè¯•æ€»ç»“" class="headerlink" title="è°ƒè¯•æ€»ç»“"></a>è°ƒè¯•æ€»ç»“</h3><p>è°ƒè¯•çš„è¿‡ç¨‹æ¯”å†™æ¥çš„è¦è‰°è¾›å¾ˆå¤šï¼Œç”±äºè°ƒè¯•çš„æ—¶å€™æ˜¯ä»è‡ªèº«çš„ä»£ç å¼€å§‹ï¼Œé€šè¿‡<code>Goland</code>çš„ debug ä¸æ–­çš„æ‰“æ–­ç‚¹ï¼Œä¸€éä¸€éçš„æ‰§è¡Œï¼ŒæŸ¥æ‰¾æ•´ä¸ªæ‰§è¡Œçš„è¿‡ç¨‹ï¼Œå¯¼è‡´å¿½ç•¥äº†æœ€ç›´æ¥æ‰¾åˆ°é”™è¯¯ä»£ç çš„æ–¹å¼ã€‚</p><p>ä¸è¿‡è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå®è´µçš„ç»å†ï¼Œè¿™ä¸ª Bug è°ƒè¯•ç»“æŸä¹‹åï¼Œ<code>Goland</code>å¼ºå¤§çš„è°ƒè¯•åŠŸèƒ½å·²ç»å¯ä»¥ç©çš„æ¯”è¾ƒ 6 äº†</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>notes</category>
      
    </categories>
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>gorm</tag>
      
      <tag>notes</tag>
      
      <tag>bug</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Httprouterä»‹ç»åŠæºç é˜…è¯»</title>
    <link href="/post/44029.html"/>
    <url>/post/44029.html</url>
    
    <content type="html"><![CDATA[<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« å½“ä¸­é˜…è¯»äº† Go è¯­è¨€çš„ä¸€ä¸ªé«˜æ€§èƒ½çš„ Web æ¡†æ¶ Ginï¼ŒWeb æ¡†æ¶å½“ä¸­æœ€é‡è¦çš„åŠŸèƒ½ä¹‹ä¸€æ˜¯è·¯ç”±ï¼ŒGin çš„è·¯ç”±å°±æ˜¯ç”± httprouter è¿™ä¸ªåŒ…å®ç°çš„</p><h2 id="åœ°å€"><a href="#åœ°å€" class="headerlink" title="åœ°å€"></a>åœ°å€</h2><ul><li><a href="https://github.com/julienschmidt/httprouter">https://github.com/julienschmidt/httprouter</a></li><li><a href="https://godoc.org/github.com/julienschmidt/httprouter">https://godoc.org/github.com/julienschmidt/httprouter</a></li></ul><h2 id="ç‰¹æ€§"><a href="#ç‰¹æ€§" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h2><ul><li>åŸºäºåŸºæ•°æ ‘å®ç°çš„é«˜æ€§èƒ½è·¯ç”±æ¡†æ¶</li><li>ä»…æ”¯æŒç²¾ç¡®åŒ¹é…</li><li>ä¸å¿…å…³å¿ƒ URL ç»“å°¾çš„æ–œçº¿</li><li>è·¯å¾„è‡ªåŠ¨æ ¡æ­£ï¼Œä¾‹å¦‚åœ¨ url è·¯å¾„å½“ä¸­æœ‰<code>../</code>,<code>//</code>çš„æ—¶å€™</li><li>å¯ä»¥åœ¨ URL å½“ä¸­è®¾ç½®å‚æ•°ï¼Œä¾‹å¦‚<code>/user/:id</code></li><li>é›¶å†…å­˜åˆ†é…</li><li>ä¸å­˜åœ¨æœåŠ¡å™¨å´©æºƒï¼Œå¯ä»¥é€šè¿‡è®¾ç½®<code>panic handler</code>ä½¿æœåŠ¡å™¨ä» panic å½“ä¸­æ¢å¤</li><li>é€‚åˆ API æ„å»º</li></ul><h2 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h2><h3 id="ä¸¤ä¸ªé—®é¢˜"><a href="#ä¸¤ä¸ªé—®é¢˜" class="headerlink" title="ä¸¤ä¸ªé—®é¢˜"></a>ä¸¤ä¸ªé—®é¢˜</h3><p>è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼Œå°±åŸºæœ¬æ˜ç™½äº†è¿™ä¸ªè·¯ç”±æ¡†æ¶</p><ul><li>è·¯ç”±æ˜¯æ˜¯å¦‚ä½•æ³¨å†Œï¼Ÿå¦‚ä½•ä¿å­˜çš„ï¼Ÿ</li><li>å½“è¯·æ±‚åˆ°æ¥ä¹‹åï¼Œè·¯ç”±æ˜¯å¦‚ä½•åŒ¹é…ï¼Œå¦‚ä½•æŸ¥æ‰¾çš„ï¼Ÿ</li></ul><h3 id="ä¸€ä¸ª-Demo"><a href="#ä¸€ä¸ª-Demo" class="headerlink" title="ä¸€ä¸ª Demo"></a>ä¸€ä¸ª Demo</h3><p>è¿˜æ˜¯ä»ä¸€ä¸ª<code>Hello World</code>è®²èµ·</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>  &#123;<br>r := httprouter.New()<br>r.GET(<span class="hljs-string">&quot;/:name&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(writer http.ResponseWriter, request *http.Request, params httprouter.Params)</span></span> &#123;<br>        fmt.Fprintf(writer, <span class="hljs-string">&quot;hello, %s!\n&quot;</span>, params.ByName(<span class="hljs-string">&quot;name&quot;</span>))<br>&#125;)<br>http.ListenAndServe(<span class="hljs-string">&quot;:8080&quot;</span>,r)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>httprouter.New()</code>åˆå§‹åŒ–äº†ä¸€ä¸ª Routerï¼Œä¸‹é¢ç›´æ¥çœ‹ä¸€ä¸‹ Router çš„ç»“æ„</p><h3 id="Router"><a href="#Router" class="headerlink" title="Router"></a>Router</h3><p>åœ¨ Router çš„æºç å½“ä¸­æœ‰ååˆ†è¯¦å°½çš„æ³¨é‡Šï¼Œè¿™é‡ŒæŒ‰ç…§æˆ‘ä¸ªäººçš„ç†è§£æ³¨é‡Šä¸€ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-comment">// Routerå®ç°äº†Http.Handleræ¥å£ï¼Œç”¨äºæ³¨å†Œåˆ†å‘è·¯ç”±</span><br><span class="hljs-keyword">type</span> Router <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">// trees æ˜¯ä¸€ä¸ªåŸºæ•°æ ‘é›†åˆï¼Œæ¯ä¸€ä¸ªHTTPæ–¹æ³•å¯¹åº”ä¸€æ£µå•ç‹¬çš„è·¯ç”±æ ‘</span><br>    <span class="hljs-comment">// nodeæ˜¯åŸºæ•°æ ‘çš„æ ¹èŠ‚ç‚¹</span><br>trees <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*node<br><br>    <span class="hljs-comment">// ç”¨äºå¼€å¯ä¸Šæ–‡æåˆ°çš„è‡ªåŠ¨å¤„ç†URLå°¾éƒ¨æ–œæ†çš„ç‰¹æ€§</span><br>    <span class="hljs-comment">// è¿™ä¸ªå€¼ä¸ºtrueæ—¶ï¼Œå¦‚æœ/foo/æ²¡æœ‰è¢«åŒ¹é…åˆ°ï¼Œä¼šå°è¯•åŒ¹é…/foo</span><br>RedirectTrailingSlash <span class="hljs-keyword">bool</span><br><br><span class="hljs-comment">// ç”¨äºå¼€å¯ä¸Šæ–‡æåˆ°çš„è·¯ç”±æ ¡æ­£çš„ç‰¹æ€§</span><br>    <span class="hljs-comment">// è¿™ä¸ªå€¼ä¸ºtrueæ—¶ï¼Œä¼šå¯¹../å’Œ//è¿™ç§è·¯å¾„è¿›è¡Œæ ¡æ­£</span><br>RedirectFixedPath <span class="hljs-keyword">bool</span><br><br>    <span class="hljs-comment">// è¿™ä¸ªå€¼ä¸ºtrueæ—¶ï¼Œå¦‚æœå½“å‰æ–¹æ³•çš„è·¯ç”±æ²¡æœ‰è¢«åŒ¹é…åˆ°ï¼Œä¼šå°è¯•åŒ¹é…å…¶ä»–æ–¹æ³•çš„è·¯ç”±ï¼Œ</span><br>    <span class="hljs-comment">// å¦‚æœåŒ¹é…åˆ°äº†åˆ™è¿”å›405ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±äº¤ç»™NotFound Handlerå¤„ç†</span><br>HandleMethodNotAllowed <span class="hljs-keyword">bool</span><br><br><span class="hljs-comment">// è¿™ä¸ªå€¼ä¸ºtrueæ—¶ï¼Œå°†å¼€å¯OPTIONSè‡ªåŠ¨åŒ¹é…ï¼Œæ³¨æ„: æ‰‹åŠ¨åŒ¹é…ä¼˜å…ˆçº§æ›´é«˜</span><br>HandleOPTIONS <span class="hljs-keyword">bool</span><br><br>    <span class="hljs-comment">// æ²¡æœ‰åŒ¹é…åˆ°ç›¸åº”è·¯ç”±çš„æ—¶å€™ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•</span><br>    <span class="hljs-comment">// å¦‚æœæ²¡æœ‰æ³¨å†Œè¿™ä¸ªæ–¹æ³•ä¼šè¿”å› NotFound</span><br>NotFound http.Handler<br><br><span class="hljs-comment">// æ²¡æœ‰åŒ¹é…åˆ°ç›¸åº”è·¯ç”±å¹¶ä¸”HandleMethodNotAllowedä¸ºtrueæ—¶ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•</span><br>MethodNotAllowed http.Handler<br><br>    <span class="hljs-comment">// ç”¨äºä»panicå½“ä¸­æ¢å¤</span><br>    <span class="hljs-comment">// éœ€è¦è¿”å›500é”™è¯¯ï¼Œå¹¶ä¸”æ¸²æŸ“ç›¸åº”çš„é”™è¯¯é¡µé¢</span><br>PanicHandler <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(http.ResponseWriter, *http.Request, <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span><br>&#125;<br></code></pre></td></tr></table></figure><p>åˆå§‹åŒ– Router ä¹‹åçœ‹çœ‹è·¯ç”±æ˜¯å¦‚ä½•ä¿å­˜å¹¶ä¸”æ³¨å†Œçš„</p><h3 id="è·¯ç”±æ˜¯å¦‚ä½•ä¿å­˜çš„"><a href="#è·¯ç”±æ˜¯å¦‚ä½•ä¿å­˜çš„" class="headerlink" title="è·¯ç”±æ˜¯å¦‚ä½•ä¿å­˜çš„?"></a>è·¯ç”±æ˜¯å¦‚ä½•ä¿å­˜çš„?</h3><p>è¿™é‡Œä»¥å®˜æ–¹ Readme å½“ä¸­çš„ä¾‹å­è¯´æ˜ï¼š<br>å¦‚æœæ³¨å†Œäº†ä»¥ä¸‹è·¯ç”±</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">r.GET(<span class="hljs-string">&quot;/&quot;</span>, f1)<br>r.GET(<span class="hljs-string">&quot;/search/&quot;</span>, f2)<br>r.GET(<span class="hljs-string">&quot;/support/&quot;</span>, f3)<br>r.GET(<span class="hljs-string">&quot;/blog/&quot;</span>, f4)<br>r.GET(<span class="hljs-string">&quot;/blog/:post/&quot;</span>, f5)<br>r.GET(<span class="hljs-string">&quot;/about_us/&quot;</span>, f6)<br>r.GET(<span class="hljs-string">&quot;/about_us/team/&quot;</span>, f7)<br>r.GET(<span class="hljs-string">&quot;/contact/&quot;</span>, f8)<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™äº›è·¯ç”±ä¼šå¦‚ä¸‹æ–¹æ‰€ç¤ºï¼Œä»¥ä¸€é¢—æ ‘çš„å½¢å¼ä¿å­˜ï¼Œå¹¶ä¸”è¿™äº›è·¯ç”±çš„å…¬å…±å‰ç¼€ä¼šè¢«æŠ½ç¦»å¹¶ä¸”å˜ä¸ºä¸Šä¸€å±‚èŠ‚ç‚¹<br>Priority è¡¨ç¤ºåŠ ä¸Šè‡ªèº«ä¸€å…±æœ‰å¤šå°‘ä¸ªèŠ‚ç‚¹<br>Path è¡¨ç¤ºè·¯å¾„<br>Handle è¡¨ç¤ºè·¯ç”±æ³¨å†Œçš„æ–¹æ³•</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Priority</span>   Path             Handle<br><span class="hljs-attribute">9</span>          \                *&lt;<span class="hljs-number">1</span>&gt;<br><span class="hljs-attribute">3</span>          â”œs               nil<br><span class="hljs-attribute">2</span>          |â”œearch\         *&lt;<span class="hljs-number">2</span>&gt;<br><span class="hljs-attribute">1</span>          |â””upport\        *&lt;<span class="hljs-number">3</span>&gt;<br><span class="hljs-attribute">2</span>          â”œblog\           *&lt;<span class="hljs-number">4</span>&gt;<br><span class="hljs-attribute">1</span>          |    â””:post      nil<br><span class="hljs-attribute">1</span>          |         â””\     *&lt;<span class="hljs-number">5</span>&gt;<br><span class="hljs-attribute">2</span>          â”œabout-us\       *&lt;<span class="hljs-number">6</span>&gt;<br><span class="hljs-attribute">1</span>          |        â””team\  *&lt;<span class="hljs-number">7</span>&gt;<br><span class="hljs-attribute">1</span>          â””contact\        *&lt;<span class="hljs-number">8</span>&gt;<br></code></pre></td></tr></table></figure><h3 id="r-Handle"><a href="#r-Handle" class="headerlink" title="r.Handle"></a>r.Handle</h3><p><code>r.Get</code>, <code>r.Post</code>ç­‰æ–¹æ³•å®è´¨éƒ½æ˜¯é€šè¿‡è°ƒç”¨ r.Handle å®ç°çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Router)</span> <span class="hljs-title">Handle</span><span class="hljs-params">(method, path <span class="hljs-keyword">string</span>, handle Handle)</span></span> &#123;<br>    <span class="hljs-comment">// è·¯å¾„æ³¨å†Œå¿…é¡»ä»/å¼€å§‹ï¼Œå¦åˆ™ç›´æ¥æŠ¥é”™</span><br><span class="hljs-keyword">if</span> path[<span class="hljs-number">0</span>] != <span class="hljs-string">&#x27;/&#x27;</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;path must begin with &#x27;/&#x27; in path &#x27;&quot;</span> + path + <span class="hljs-string">&quot;&#x27;&quot;</span>)<br>&#125;<br><br>    <span class="hljs-comment">// è·¯ç”±æ ‘mapä¸å­˜åœ¨éœ€è¦æ–°å»º</span><br><span class="hljs-keyword">if</span> r.trees == <span class="hljs-literal">nil</span> &#123;<br>r.trees = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*node)<br>&#125;<br><br>    <span class="hljs-comment">// è·å–å½“å‰æ–¹æ³•æ‰€å¯¹åº”æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œä¸å­˜åœ¨åˆ™æ–°å»ºä¸€ä¸ª</span><br>root := r.trees[method]<br><span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>root = <span class="hljs-built_in">new</span>(node)<br>r.trees[method] = root<br>&#125;<br><br>    <span class="hljs-comment">// å‘è·¯ç”±æ ‘å½“ä¸­æ·»åŠ ä¸€æ¡ä¸€æ¡è·¯ç”±</span><br>root.addRoute(path, handle)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="node"><a href="#node" class="headerlink" title="node"></a>node</h3><p>è·¯ç”±æ˜¯æ³¨å†Œåˆ°ä¸€é¢—è·¯ç”±æ ‘å½“ä¸­çš„ï¼Œå…ˆçœ‹çœ‹èŠ‚ç‚¹çš„æºç ï¼Œå†æ¥åˆ†æï¼Œæ˜¯å¦‚ä½•æ·»åŠ è·¯ç”±çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> node <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">// å½“å‰èŠ‚ç‚¹çš„è·¯å¾„</span><br>    path      <span class="hljs-keyword">string</span><br><br>    <span class="hljs-comment">// æ˜¯å¦ä¸ºå‚æ•°èŠ‚ç‚¹ï¼Œå‚æ•°èŠ‚ç‚¹ç”¨:nameè¡¨ç¤º</span><br>    wildChild <span class="hljs-keyword">bool</span><br><br>    <span class="hljs-comment">// å½“å‰èŠ‚ç‚¹ç±»å‹ï¼Œ ä¸€å…±æœ‰4ç§</span><br>    <span class="hljs-comment">// static: é™æ€èŠ‚ç‚¹ï¼Œé»˜è®¤ç±»å‹</span><br><span class="hljs-comment">// root: æ ¹èŠ‚ç‚¹</span><br><span class="hljs-comment">// param: å…¶ä»–èŠ‚ç‚¹</span><br><span class="hljs-comment">// catchAll: å¸¦æœ‰*çš„èŠ‚ç‚¹ï¼Œè¿™é‡Œ*çš„ä½œç”¨å’Œæ­£åˆ™å½“ä¸­çš„*ä¸€æ ·</span><br>    nType     nodeType<br><br>    <span class="hljs-comment">// å½“å‰è·¯å¾„ä¸Šæœ€å¤§å‚æ•°çš„ä¸ªæ•°ï¼Œä¸èƒ½è¶…è¿‡255</span><br>    maxParams <span class="hljs-keyword">uint8</span><br><br>    <span class="hljs-comment">// ä»£è¡¨åˆ†æ”¯çš„é¦–å­—æ¯</span><br>    <span class="hljs-comment">// ä¸Šé¢çš„ä¾‹å­ï¼Œå½“å‰èŠ‚ç‚¹ä¸ºs</span><br>    <span class="hljs-comment">// é‚£ä¹ˆindices = eu</span><br>    <span class="hljs-comment">// â”œs               nil</span><br>    <span class="hljs-comment">// |â”œearch\         *&lt;2&gt;</span><br>    <span class="hljs-comment">// |â””upport\        *&lt;3&gt;</span><br>    indices   <span class="hljs-keyword">string</span><br><br>    <span class="hljs-comment">// å­©å­èŠ‚ç‚¹</span><br>    children  []*node<br><br>    <span class="hljs-comment">// æ³¨å†Œçš„è·¯ç”±</span><br>    handle    Handle<br><br>    <span class="hljs-comment">// æƒé‡ï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹åŠ ä¸Šæ‰€æœ‰å­èŠ‚ç‚¹çš„æ•°ç›®</span><br>priority  <span class="hljs-keyword">uint32</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è·¯ç”±æ ‘æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Ÿ"><a href="#è·¯ç”±æ ‘æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Ÿ" class="headerlink" title="è·¯ç”±æ ‘æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Ÿ"></a>è·¯ç”±æ ‘æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Ÿ</h3><p>æœªå®Œå¾…ç»­</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>è·¯ç”±</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Ginæºç é˜…è¯» ä»0.1å¼€å§‹</title>
    <link href="/post/12338.html"/>
    <url>/post/12338.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘æ‰“ç®—å¼€å§‹å­¦ä¹ ä¸€ä¸‹ Gin çš„æºä»£ç ï¼Œç°åœ¨ Gin å·²ç»æ˜¯ä¸€ä¸ªååˆ†æˆç†Ÿçš„æ¡†æ¶äº†ï¼Œä»£ç é‡ä¹Ÿä¸å°‘ï¼Œé˜…è¯»èµ·æ¥è¿˜æ˜¯æœ‰ä¸€å®šçš„éš¾åº¦ï¼Œæ‰€ä»¥æˆ‘æ‰“ç®—ä» 0.1 ç‰ˆæœ¬å¼€å§‹é˜…è¯»å­¦ä¹ ï¼Œä¸€ç›´åˆ°æœ€æ–°çš„ä¸€ä¸ªç‰ˆæœ¬ã€‚è·Ÿéšç€ Gin çš„æºç ä¸€æ­¥ä¸€æ­¥çš„å­¦ä¹ æˆé•¿ã€‚</p></blockquote><h2 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h2><p>Gin 0.1 çš„ä»£ç é‡ååˆ†çš„å°‘, ä¸»è¦ä»£ç ä¸€å…±ä¹Ÿåªæœ‰äº”ä¸ªæ–‡ä»¶ï¼Œä»£ç ä¸­çš„æ³¨é‡Šä¹Ÿæ¯”è¾ƒè¯¦ç»†</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs css">â”‚  <span class="hljs-selector-tag">auth</span><span class="hljs-selector-class">.go</span><br>â”‚  <span class="hljs-selector-tag">gin</span><span class="hljs-selector-class">.go</span><br>â”‚  <span class="hljs-selector-tag">logger</span><span class="hljs-selector-class">.go</span><br>â”‚  <span class="hljs-selector-tag">README</span><span class="hljs-selector-class">.md</span><br>â”‚  <span class="hljs-selector-tag">recovery</span><span class="hljs-selector-class">.go</span><br>â”‚  <span class="hljs-selector-tag">validation</span><span class="hljs-selector-class">.go</span><br></code></pre></td></tr></table></figure><h2 id="è·‘èµ·æ¥"><a href="#è·‘èµ·æ¥" class="headerlink" title="è·‘èµ·æ¥"></a>è·‘èµ·æ¥</h2><p>Gin 0.1 çš„ä»£ç é‡ååˆ†çš„å°‘ï¼Œä½†æ˜¯è¿˜æ˜¯å…ˆä»<code>readme</code>çš„ç¤ºä¾‹å¼€å§‹è¯´èµ·</p><p>é¦–å…ˆä¸‹é¢è¿™ä¸€æ®µä»£ç æ˜¯ç›´æ¥è·‘ä¸èµ·æ¥çš„ï¼Œä¸çŸ¥é“æ˜¯ä»£ç æœ¬èº«çš„ bug è¿˜æ˜¯å› ä¸º Go è¯­è¨€çš„ç‰ˆæœ¬å˜åŒ–å¯¼è‡´çš„ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ä¿®æ”¹å‡ ä¸ªåœ°æ–¹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    r := gin.Default()<br>    r.GET(<span class="hljs-string">&quot;ping&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span>&#123;<br>        c.String(<span class="hljs-string">&quot;pong&quot;</span>)<br>    &#125;)<br><br>    <span class="hljs-comment">// Listen and server on 0.0.0.0:8080</span><br>    r.Run(<span class="hljs-string">&quot;:80&quot;</span>)<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ç¬¬ä¸€æ¬¡ä¿®æ”¹"><a href="#ç¬¬ä¸€æ¬¡ä¿®æ”¹" class="headerlink" title="ç¬¬ä¸€æ¬¡ä¿®æ”¹"></a>ç¬¬ä¸€æ¬¡ä¿®æ”¹</h3><p><code>main.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br><span class="hljs-string">&quot;net/http&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>  &#123;<br>    r := gin.Default()<br>    <span class="hljs-comment">// åœ¨è¿™å„¿å¿…é¡»åœ¨pingï¼Œå‰åŠ ä¸Š/ï¼Œä¸ç„¶ä¼šå¯¼è‡´panic</span><br>r.GET(<span class="hljs-string">&quot;/ping&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span>&#123;<br>        <span class="hljs-comment">// String æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä½†æ˜¯å®ä¾‹åªå†™äº†ä¸€ä¸ª</span><br>c.String(http.StatusOK,<span class="hljs-string">&quot;pong&quot;</span>)<br>&#125;)<br><br><span class="hljs-comment">// Listen and server on 0.0.0.0:8080</span><br>r.Run(<span class="hljs-string">&quot;:80&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>gin.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Returns a new blank Engine instance without any middleware attached.</span><br><span class="hljs-comment">// The most basic configuration</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">()</span> *<span class="hljs-title">Engine</span></span> &#123;<br>engine := &amp;Engine&#123;&#125;<br>engine.RouterGroup = &amp;RouterGroup&#123;<span class="hljs-literal">nil</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">nil</span>, engine&#125;<br>    engine.router = httprouter.New()<br>    <span class="hljs-comment">// NotFound æ˜¯ä¸€ä¸ªhttp.Handlerçš„æ¥å£ï¼Œä½†æ˜¯æºç å½“ä¸­èµ‹å€¼äº†ä¸€ä¸ªæ–¹æ³•ç»™ä»–</span><br>    engine.router.NotFound = engine<br>    <span class="hljs-comment">// engine.router.NotFound = engine.handle404</span><br><span class="hljs-keyword">return</span> engine<br>&#125;<br></code></pre></td></tr></table></figure><p>å¥½äº†ä¿®æ”¹å®Œæˆä¹‹åå°±å¯ä»¥è¿è¡Œ, <code>go run main.go</code>æˆåŠŸè¿è¡Œäº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ª bugï¼Œåªèƒ½è®¿é—®ä¸€æ¬¡ï¼Œå°±ä¼šå› ä¸º<code>stack overflow</code>é€€å‡º</p><p>æŸ¥çœ‹ä¸€ä¸‹<code>gin.go</code>, <code>ServeHTTP</code>å¯ä»¥å‘ç°ï¼Œgin æ˜¯ç›´æ¥è°ƒç”¨äº†<code>httprouter</code>çš„<code>ServeHTTP</code>æ–¹æ³•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ServeHTTP makes the router implement the http.Handler interface.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(engine *Engine)</span> <span class="hljs-title">ServeHTTP</span><span class="hljs-params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;<br>engine.router.ServeHTTP(w, req)<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»§ç»­è¿½è¸ªï¼Œå¯ä»¥å‘ç°åœ¨<code>httprouter</code>çš„<code>ServeHTTP</code>æ–¹æ³•æœ€åæœ‰ä¸€æ®µåˆ¤å®š 404 çš„ä»£ç ï¼Œè¿™æ—¶å€™å°±å¯ä»¥å‘ç°è¿™æ˜¯ä¹‹å‰ä¿®æ”¹<code>gin.go`</code> engine.router.NotFound = engine <code>è¿™æ®µä»£ç é€ æˆçš„ï¼Œç”±äº Chrome æµè§ˆå™¨è®¿é—®çš„æ—¶å€™ä¼šå°è¯•è®¿é—®</code>/favicon.ico<code>è¿™ä¸ªæ–‡ä»¶ï¼Œç„¶è€Œæˆ‘ä»¬åœ¨è·¯ç”±å½“ä¸­å¹¶æ²¡æœ‰å®šä¹‰ï¼Œæ­¤æ—¶å°±æ˜¯ 404ï¼Œè¿™æ—¶å€™ç”±äºä¹‹å‰æˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç»™</code>router<code>ä¼ é€’çš„</code>NotFound<code>ä¸º</code>engine<code>ï¼Œè€Œ</code>engine.ServeHTTP<code>è°ƒç”¨äº†</code>router.ServeHTTP`è¿™æ—¶å€™å°±é€ æˆäº†æ— é™é€’å½’ï¼Œå¯¼è‡´æœ€åé€€å‡º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Handle 404</span><br><span class="hljs-keyword">if</span> r.NotFound != <span class="hljs-literal">nil</span> &#123;<br>r.NotFound.ServeHTTP(w, req)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>http.NotFound(w, req)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ç¬¬äºŒæ¬¡ä¿®æ”¹"><a href="#ç¬¬äºŒæ¬¡ä¿®æ”¹" class="headerlink" title="ç¬¬äºŒæ¬¡ä¿®æ”¹"></a>ç¬¬äºŒæ¬¡ä¿®æ”¹</h3><p><code>gin.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Returns a new blank Engine instance without any middleware attached.</span><br><span class="hljs-comment">// The most basic configuration</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">()</span> *<span class="hljs-title">Engine</span></span> &#123;<br>engine := &amp;Engine&#123;&#125;<br>engine.RouterGroup = &amp;RouterGroup&#123;<span class="hljs-literal">nil</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">nil</span>, engine&#125;<br>    engine.router = httprouter.New()<br>    <span class="hljs-comment">// NotFound æ˜¯ä¸€ä¸ªhttp.Handlerçš„æ¥å£ï¼Œä½†æ˜¯æºç å½“ä¸­èµ‹å€¼äº†ä¸€ä¸ªæ–¹æ³•ç»™ä»–</span><br>    <span class="hljs-comment">// æ³¨é‡Šæ‰å³å¯</span><br>    <span class="hljs-comment">// engine.router.NotFound = engine.handle404</span><br><span class="hljs-keyword">return</span> engine<br>&#125;<br></code></pre></td></tr></table></figure><p><code>go run main.go</code>æˆåŠŸè¿è¡Œï¼Œå°±æ²¡æœ‰é—®é¢˜äº†</p><h2 id="Gin-æºç åˆ†æ"><a href="#Gin-æºç åˆ†æ" class="headerlink" title="Gin æºç åˆ†æ"></a>Gin æºç åˆ†æ</h2><p>è·‘èµ·æ¥ä¹‹åå°±å…·ä½“çœ‹çœ‹æºç ,åˆå§‹ç‰ˆæœ¬çš„ Gin å½“ä¸­æ‹¥æœ‰ä¸‰ä¸ªæ¯”è¾ƒé‡è¦çš„<code>struct</code>ï¼Œä¹Ÿæ˜¯æ ¸å¿ƒçš„ç»„æˆéƒ¨åˆ†</p><p><code>Context</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Contextæ˜¯ginå½“ä¸­æœ€ä¸ºé‡è¦çš„ä¸€éƒ¨åˆ†</span><br><span class="hljs-comment">// å®ƒç”¨äºåœ¨ä¸­é—´ä»¶å½“ä¸­ä¼ é€’å˜é‡ï¼Œç®¡ç†æµç¨‹ã€‚ä¾‹å¦‚æ¥å—jsonè¯·æ±‚ï¼Œå¹¶è¿”å›json</span><br><span class="hljs-comment">// Context is the most important part of gin. It allows us to pass variables between middleware,</span><br><span class="hljs-comment">// manage the flow, validate the JSON of a request and render a JSON response for example.</span><br>Context <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">// ServeHTTP ç¬¬äºŒä¸ªå‚æ•°ï¼Œè¯·æ±‚ä½“</span><br>    Req      *http.Request<br>    <span class="hljs-comment">// ServeHTTP ç¬¬ä¸€æ¬¡å‚æ•°ï¼Œå“åº”</span><br>    Writer   http.ResponseWriter<br>    <span class="hljs-comment">// å¯ä»¥è®¾ç½®çš„å€¼</span><br>    Keys     <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;<br>    <span class="hljs-comment">// é”™è¯¯ä¿¡æ¯</span><br>    Errors   []ErrorMsg<br>    <span class="hljs-comment">// è¯·æ±‚å‚æ•°</span><br>    Params   httprouter.Params<br>    <span class="hljs-comment">// = ä¸­é—´ä»¶ + è¯·æ±‚å¤„ç†å‡½æ•°(æœ€åä¸€ä¸ª)</span><br>    handlers []HandlerFunc<br>    <span class="hljs-comment">// Engine å®ä¾‹</span><br>    engine   *Engine<br>    <span class="hljs-comment">// å½“å‰å¤„ç†åˆ°çš„Handlerä¸‹æ ‡</span><br>    index    <span class="hljs-keyword">int8</span><br>&#125;<br><br><span class="hljs-comment">// ä¸‹ä¸€ä¸ªä¸­é—´ä»¶</span><br>Next()<br><span class="hljs-comment">// ç»ˆæ­¢å¤„ç†ï¼Œç›´æ¥è¿”å›</span><br>Abort(code <span class="hljs-keyword">int</span>)<br><span class="hljs-comment">// æ·»åŠ é”™è¯¯ä¿¡æ¯ï¼Œå¹¶ä¸”ç»ˆæ­¢å¤„ç†</span><br>Fail(code <span class="hljs-keyword">int</span>, err error)<br><span class="hljs-comment">// æ·»åŠ é”™è¯¯ä¿¡æ¯</span><br>Error(err error, meta <span class="hljs-keyword">interface</span>&#123;&#125;)<br><br><span class="hljs-comment">// ç»™Context.Keysæ·»åŠ å€¼</span><br>Set(key <span class="hljs-keyword">string</span>, item <span class="hljs-keyword">interface</span>&#123;&#125;)<br><span class="hljs-comment">// è·å–Context.Keysçš„å€¼ï¼Œå¦‚æœä¸å­˜åœ¨ä¼šå¯¼è‡´panic</span><br>Get(key <span class="hljs-keyword">string</span>) <span class="hljs-keyword">interface</span>&#123;&#125;<br><br><span class="hljs-comment">// å°†è¯·æ±‚ä½“çš„å‚æ•°ä½œä¸ºjsonè§£æ</span><br>ParseBody(item <span class="hljs-keyword">interface</span>&#123;&#125;) error<br><span class="hljs-comment">// åŒParseBodyï¼Œä½†æ˜¯å¦‚æœä¸æ˜¯ä¸€ä¸ªå¯è§£æçš„jsonä¼šè°ƒç”¨Fail(400)ç»ˆæ­¢è¯·æ±‚</span><br>EnsureBody(item <span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-keyword">bool</span><br><br><span class="hljs-comment">// ä¸‹é¢æ˜¯å’Œè¿”å›ç›¸å…³çš„å‡½æ•°ï¼Œcode å‚æ•°å‡è¡¨ç¤ºhttp status</span><br><br><span class="hljs-comment">// è¿”å›json</span><br>JSON(code <span class="hljs-keyword">int</span>, obj <span class="hljs-keyword">interface</span>&#123;&#125;)<br><span class="hljs-comment">// è¿”å›xml</span><br>XML(code <span class="hljs-keyword">int</span>, obj <span class="hljs-keyword">interface</span>&#123;&#125;)<br><span class="hljs-comment">// HTMLæ¨¡æ¿æ¸²æŸ“ï¼Œä½¿ç”¨golangæ ‡å‡†åº“çš„æ¨¡æ¿åº“</span><br>HTML(code <span class="hljs-keyword">int</span>, name <span class="hljs-keyword">string</span>, data <span class="hljs-keyword">interface</span>&#123;&#125;)<br><span class="hljs-comment">// è¿”å›å­—ç¬¦ä¸²</span><br>String(code <span class="hljs-keyword">int</span>, msg <span class="hljs-keyword">string</span>)<br><span class="hljs-comment">// è¿”å›æµæ•°æ®</span><br>Data(code <span class="hljs-keyword">int</span>, data []<span class="hljs-keyword">byte</span>)<br></code></pre></td></tr></table></figure><p><code>RouterGroup</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// RouterGroupç”¨äºç®¡ç†è·¯ç”±ï¼Œä¸€ä¸ªRouterGroupå’Œä¸€ä¸ªå‰ç¼€ä»¥åŠä¸€ç»„ä¸­é—´ä»¶å…³è”</span><br><span class="hljs-comment">// Used internally to configure router, a RouterGroup is associated with a prefix</span><br><span class="hljs-comment">// and an array of handlers (middlewares)</span><br>RouterGroup <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">// ä¸­é—´ä»¶</span><br>    Handlers []HandlerFunc<br>    <span class="hljs-comment">// è·¯å¾„å‰ç¼€</span><br>    prefix   <span class="hljs-keyword">string</span><br>    parent   *RouterGroup<br>    <span class="hljs-comment">// Engine å®ä¾‹</span><br>    engine   *Engine<br>&#125;<br><br><span class="hljs-comment">// æ–°å»ºä¸€ä¸ªContextï¼Œç”¨äºä¼ é€’è¿™ä¸ªè·¯ç”±ç»„çš„æ•°æ®</span><br>createContext(w http.ResponseWriter, req *http.Request, params httprouter.Params, handlers []HandlerFunc) *Context<br><span class="hljs-comment">// æ·»åŠ ä¸€ä¸ªä¸­é—´ä»¶åˆ°è¿™ä¸ªè·¯ç”±ç»„</span><br>Use(middlewares ...HandlerFunc)<br><span class="hljs-comment">// æ–°å»ºä¸€ä¸ªè·¯ç”±ç»„</span><br>Group(component <span class="hljs-keyword">string</span>, handlers ...HandlerFunc) *RouterGroup<br><span class="hljs-comment">// æ³¨å†Œä¸€ä¸ªè·¯ç”±</span><br>Handle(method, p <span class="hljs-keyword">string</span>, handlers []HandlerFunc)<br><span class="hljs-comment">// è°ƒç”¨Handleæ–¹æ³•æ³¨å†Œä¸€ä¸ªPOSTè·¯ç”±</span><br>POST(path <span class="hljs-keyword">string</span>, handlers ...HandlerFunc)<br><span class="hljs-comment">// è°ƒç”¨Handleæ–¹æ³•æ³¨å†Œä¸€ä¸ªGETè·¯ç”±</span><br>GET(path <span class="hljs-keyword">string</span>, handlers ...HandlerFunc)<br><span class="hljs-comment">// è°ƒç”¨Handleæ–¹æ³•æ³¨å†Œä¸€ä¸ªDELETEè·¯ç”±</span><br>DELETE(path <span class="hljs-keyword">string</span>, handlers ...HandlerFunc)<br><span class="hljs-comment">// è°ƒç”¨Handleæ–¹æ³•æ³¨å†Œä¸€ä¸ªPATCHè·¯ç”±</span><br>PATCH(path <span class="hljs-keyword">string</span>, handlers ...HandlerFunc)<br><span class="hljs-comment">// è°ƒç”¨Handleæ–¹æ³•æ³¨å†Œä¸€ä¸ªPUTè·¯ç”±</span><br>PUT(path <span class="hljs-keyword">string</span>, handlers ...HandlerFunc)<br><span class="hljs-comment">// ç»„åˆä¸­é—´ä»¶ï¼Œå°†ä¼ å…¥çš„Handlersæ”¾åœ¨å·²æœ‰çš„Handlersåé¢</span><br>combineHandlers(handlers []HandlerFunc) []HandlerFunc<br></code></pre></td></tr></table></figure><p><code>Engine</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ç”¨äºè¡¨ç¤ºWebæ¡†æ¶ï¼ŒåŒ…å«äº†fast HTTProuterå’Œä¸€ä¸ªå…¨å±€çš„ä¸­é—´ä»¶åˆ—è¡¨</span><br><span class="hljs-comment">// Represents the web framework, it wrappers the blazing fast httprouter multiplexer and a list of global middlewares.</span><br>Engine <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">// è·¯ç”±ç»„</span><br>    *RouterGroup<br>    <span class="hljs-comment">// 404 å¤„ç†</span><br>    handlers404   []HandlerFunc<br>    <span class="hljs-comment">// http router å®ä¾‹</span><br>    router        *httprouter.Router<br>    <span class="hljs-comment">// æ¨¡æ¿</span><br>    HTMLTemplates *template.Template<br>&#125;<br><span class="hljs-comment">// åŠ è½½HTMLæ¨¡æ¿</span><br>LoadHTMLTemplates(pattern <span class="hljs-keyword">string</span>)<br><span class="hljs-comment">// è®¾ç½®404æ–¹æ³•</span><br>NotFound404(handlers ...HandlerFunc)<br><span class="hljs-comment">// é»˜è®¤çš„404æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªç‰ˆæœ¬å¹¶æ²¡æœ‰ä½¿ç”¨ä¸Š</span><br>handle404(w http.ResponseWriter, req *http.Request)<br><span class="hljs-comment">// ä¿å­˜æ–‡ä»¶</span><br>ServeFiles(path <span class="hljs-keyword">string</span>, root http.FileSystem)<br><span class="hljs-comment">// å®ç°http.Handleræ¥å£</span><br>ServeHTTP(w http.ResponseWriter, req *http.Request)<br><span class="hljs-comment">// è°ƒç”¨http.ListenAndServeå¯åŠ¨æœåŠ¡å™¨</span><br>Run(addr <span class="hljs-keyword">string</span>)<br></code></pre></td></tr></table></figure><p>0.1 ç‰ˆæœ¬çš„ gin åªæ˜¯ä¸€ä¸ªæå°ï¼Œæä¸ºç®€å•çš„å·¥å…·ç®±ï¼Œä¸»è¦æä¾›äº†ä¸€ä¸ªç®€å•çš„è·¯ç”±å’Œç®€å•çš„ä¸­é—´ä»¶å®ç°ï¼Œææ¸…æ¥šä¸‹é¢è¿™ä¸¤ä¸ªé—®é¢˜è¿™ä¸ªæ¡†æ¶çš„ä¹Ÿå°±æ˜ç™½äº†ã€‚</p><ol><li><p>ä¸€ä¸ªä½¿ç”¨äº†<code>Gin</code>çš„ Web åº”ç”¨ï¼Œä»åˆå§‹åŒ–åˆ°å¯åŠ¨çš„æµç¨‹ï¼Ÿ</p></li><li><p>ä¸€ä¸ªè¯·æ±‚ä»æ¥æ”¶åˆ°è¿”å›ç»å†äº†ä»€ä¹ˆï¼Ÿ</p></li></ol><h3 id="åº”ç”¨æµç¨‹"><a href="#åº”ç”¨æµç¨‹" class="headerlink" title="åº”ç”¨æµç¨‹"></a>åº”ç”¨æµç¨‹</h3><p>1.é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª<code>engine</code>å®ä¾‹ï¼Œæ³¨å†Œäº†ä¸¤ä¸ªä¸¤ä¸ªåŸºæœ¬çš„ä¸­é—´ä»¶</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">gin.Default() -&gt; gin.New() -&gt; engine.Use(Recovery(), Logger())<br></code></pre></td></tr></table></figure><p>2.ç„¶åä½¿ç”¨<code>group.Handle</code>æ–¹æ³•æ³¨å†Œè·¯ç”±, å…³é”®ä»£ç å¦‚ä¸‹ï¼Œå°†è·¯ç”±æ·»åŠ åˆ° http router çš„æ ‘ä¸­ï¼Œå½“æ‰§è¡Œ handler æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ª<code>Context</code>å¹¶ä¸”ä»å¤´å¼€å§‹æ‰§è¡Œ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">group.engine.router.Handle(method, p,<br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, req *http.Request, params httprouter.Params)</span></span> &#123;<br>    group.createContext(w, req, params, handlers).Next()<br>&#125;)<br></code></pre></td></tr></table></figure><p>3.è°ƒç”¨<code>http.ListenAndServe</code>ç›‘å¬æŒ‡å®šç«¯å£ï¼Œå¯åŠ¨æœåŠ¡å™¨</p><h3 id="è¯·æ±‚æµç¨‹"><a href="#è¯·æ±‚æµç¨‹" class="headerlink" title="è¯·æ±‚æµç¨‹"></a>è¯·æ±‚æµç¨‹</h3><ol><li>å½“æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œä¼šè°ƒç”¨ä¹‹å‰æ³¨å†Œçš„<code>engine.ServeHTTP</code>æ–¹æ³•ï¼ŒæŸ¥æ‰¾è·¯ç”±</li><li><code>engine.ServeHTTP</code>æ–¹æ³•ä½¿ç”¨äº†<code>httprouter</code>çš„<code>ServeHTTP</code>æ–¹æ³•ï¼Œè¿™æ˜¯ä¼šé€šè¿‡è¯·æ±‚çš„ path ä»å·²æ³¨å†Œçš„è·¯ç”±æ ‘ä¸Šè·å–å¯¹åº”çš„è·¯ç”±ï¼Œå¹¶ä¸”æ‰§è¡Œå…¶ handler æ–¹æ³•ï¼Œå¦‚ä¸Šæ‰€ç¤ºï¼Œhandler æ–¹æ³•å†…éƒ¨é€šè¿‡åˆ›å»ºä¸€ä¸ª router group å¯¹åº”çš„ Context ä»å¤´å¼€å§‹æ‰§è¡Œæ‰€æœ‰çš„ä¸­é—´ä»¶ä»¥åŠæ³¨å†Œè·¯ç”±æ—¶æ³¨å†Œçš„è¯·æ±‚å¤„ç†å‡½æ•°</li><li>ä»è¯·æ±‚å¤„ç†å‡½æ•°ä¸­è¿”å›ä¿¡æ¯</li></ol><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>gin</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>çº¯æŠ€æœ¯äººå‘˜å’ŒæŠ•èµ„è€…çš„ä¸€äº›åŒºåˆ«</title>
    <link href="/post/61686.html"/>
    <url>/post/61686.html</url>
    
    <content type="html"><![CDATA[<p>ä»¥ä¸‹éƒ½æ˜¯æµæ°´è´¦ï¼Œæ„Ÿæ…¨ä¸€ä¸‹â€¦</p><p>ä»Šå¤©æœ‰å¹¸å‚åŠ äº†ä¸€ä½å¸ˆå…„çš„æ ¡å‹èšä¼šï¼Œä¹Ÿå¾ˆå·§åˆï¼Œå’Œå¾ˆå¤šå¤§ä½¬ä¸€èµ·åƒäº†ä¸€ä¸ªé¥­ï¼Œå¬å¤§ä½¬ä»¬èŠå¤©å—ç›Šé¢‡å¤šã€‚</p><p>ä»Šå¤©æœ‰ä¸€ä½åšæŠ€æœ¯å¾ˆå‰å®³çš„ï¼Œä¸“å®¶çº§çš„å¸ˆå…„æƒ³åˆ›ä¸šï¼ŒèŠèµ·äº†ä»–çš„é¡¹ç›®ï¼Œå¦å¤–å‡ ä¸ªåšä¼ä¸šçš„å¸ˆå…„åœ¨æ—è¾¹å¬å¹¶ä¸”ç»™å‡ºå»ºè®®ã€‚è®©æˆ‘äº§ç”Ÿä¸€ç§å¾ˆå¼ºçƒˆçš„å¯¹æ¯”ï¼ŒåšæŠ€æœ¯çš„å¸ˆå…„è€ƒè™‘çš„æœ€å¤šçš„æ˜¯æŠ€æœ¯ååˆ†çš„ç‰›ï¼ŒæŠ€æœ¯æ‹¥æœ‰ä¸å¯å¤åˆ¶ï¼Œæˆ–è€…è¯´å¾ˆé«˜çš„å¤åˆ¶æˆæœ¬ã€‚ä½†æ˜¯æ²¡æœ‰è¯´åˆ°å…·ä½“çš„ç‰›åœ¨ä»€ä¹ˆåœ°æ–¹ï¼Œè€Œå…¶ä»–å‡ ä¸ªå¸ˆå…„åœ¨å¸®å¿™ç†æ¸…é¡¹ç›®çš„æ€è·¯ï¼Œæœ‰æ²¡æœ‰åšè¿‡å¸‚åœºè°ƒæŸ¥ï¼Œæœ‰æ²¡æœ‰æˆå‹çš„äº§å“ï¼Œäº§å“å…·ä½“çš„æŠ€æœ¯æŒ‡æ ‡ç­‰ç­‰ã€‚</p><p>ä¸åŒä½ç½®çš„äººçœ‹é—®é¢˜çš„è§’åº¦ä¸ä¸€æ ·ï¼Œæˆ–è®¸åªæœ‰é‚£ä¸ªæŠ€æœ¯å¾ˆç‰›çš„å¸ˆå…„ä¸€æ ·æ‰èƒ½æŠŠä¸€é—¨æŠ€æœ¯åšåˆ°æè‡´ã€‚</p><p>ä½†æ˜¯åè¿‡æ¥æ€è€ƒä¸€ä¸‹åšæŠ€æœ¯éœ€ä¸éœ€è¦æœ‰ä¸€å®šçš„äº§å“æ€ç»´ï¼Œéœ€ä¸éœ€è¦äº†è§£å¸‚åœºåŠ¨æ€ï¼Œéœ€ä¸éœ€è¦è‰¯å¥½çš„ä¸€ä¸ªè¯­è¨€è¡¨è¿°å’Œç»„ç»‡èƒ½åŠ›ï¼Œè™½ç„¶è¿™äº›è‚¯å®šä¸æ˜¯æœ€é‡è¦çš„ï¼Œä½†æ˜¯åº”è¯¥ä¹Ÿæ˜¯ä¸å¯æˆ–ç¼ºçš„å§ã€‚</p><p>è‡ªå‹‰</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>notes</category>
      
    </categories>
    
    
    <tags>
      
      <tag>notes</tag>
      
      <tag>æ‚è®°</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2018å¹´çš„ä¸€äº›å°ç›®æ ‡</title>
    <link href="/post/22757.html"/>
    <url>/post/22757.html</url>
    
    <content type="html"><![CDATA[<p>æ—¶é—´è¿‡å¾—å¾ˆå¿«ï¼Œä»ä¸€ä¸ªå­¦ç”Ÿåˆ°ä¸€ä¸ªç¤¾ä¼šäººåªéœ€è¦é‚£ä¹ˆä¸€ç¬é—´ï¼Œä¸€ä¸ªæ¥ä¸åŠååº”çš„ç¬é—´ã€‚è™½ç„¶ä¹‹å‰ç»å†è¿‡å¤§é‡çš„å®ä¹ å·¥ä½œï¼Œä¹Ÿä¸æ˜¯ç¬¬ä¸€æ¬¡åªèº«ä¸€äººåƒé‡Œè¿¢è¿¢æ¥åˆ°è¿™ä¸ªé™Œç”Ÿçš„åŸå¸‚ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰é‚£ä¹ˆä¸€äº›çš„ä¸é€‚åº”ã€‚</p><p>å¼€å§‹å·¥ä½œäº†ï¼Œæ—¶é—´å˜å¾—å°‘äº†ï¼Œä½†æ˜¯å­¦ä¹ çš„ç´§è¿«æ€§å´æ˜¯å˜å¾—æ›´é«˜äº†</p><p>åˆ—ä¸€åˆ—å‰©ä¸‹ä¸åˆ°åŠå¹´æ—¶é—´æƒ³è¦å­¦ä¹ çš„ä¸œè¥¿å§ï¼Œæƒå½“æ˜¯ä¸€ä¸ªå¤‡å¿˜å½•</p><ul><li>é˜…è¯»å­¦ä¹ è‡³å°‘ä¸¤ä¸ª Go Web æ¡†æ¶ <code>ä¸ƒå…«æœˆ</code><ul><li>Echo</li><li>Gin</li><li>Iris</li><li>Beego</li><li>â€¦</li></ul></li><li>å­¦ä¹  Golang è°ƒåº¦æºç  <code>ä¸ƒå…«æœˆ or ä¹æœˆ</code></li><li>ä»é›¶å¼€å§‹ç¼–å†™è‡ªå·±çš„ç¬¬ä¸€ä¸ª Go Web æ¡†æ¶ <code>å…«ä¹æœˆ</code></li><li>æœªå®Œå¾…ç»­â€¦</li></ul><p>å¸Œæœ›èƒ½å¤Ÿå…»æˆè®°å½•å­¦ä¹ è¿‡ç¨‹çš„ä¹ æƒ¯ï¼Œ<code>å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´</code></p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>è§„åˆ’æ€»ç»“</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ€»ç»“</tag>
      
      <tag>è§„åˆ’</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>goæ ‡å‡†åº“â€”â€”ioutil.ReadAllçš„å®ç°</title>
    <link href="/post/47700.html"/>
    <url>/post/47700.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><blockquote><p>æœ€è¿‘å‡†å¤‡å­¦ä¹ ä¸€ä¸‹ golang çš„æ ‡å‡†åº“ï¼Œè¯¦ç»†çš„é˜…è¯»éƒ¨åˆ†æºç ï¼Œè¿™ä¸ªç›®å½•è®°å½•ä¸€ä¸‹å­¦ä¹ çš„è¿‡ç¨‹å’Œå¿ƒå¾—</p></blockquote><p>go è¯­è¨€çš„<code>ioutil</code>åŒ…æä¾›äº†å¾ˆå¤šæ–¹ä¾¿çš„ io æ“ä½œçš„å·¥å…·é›†ï¼Œæœ¬æ–‡ä¸»è¦è¯¦ç»†åˆ†æ<code>ReadAll</code>æ–¹æ³•çš„æºç å®ç°ã€‚</p><p><code>ReadAll</code>æ˜¯å¾ˆå¸¸ç”¨çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨æ¥ä¸€æ¬¡æ€§çš„è¯»å–<code>io.Reader</code>å½“ä¸­çš„æ•°æ®ã€‚</p><h2 id="æºç å®ç°"><a href="#æºç å®ç°" class="headerlink" title="æºç å®ç°"></a>æºç å®ç°</h2><h5 id="1-ReadAll"><a href="#1-ReadAll" class="headerlink" title="1. ReadAll"></a>1. ReadAll</h5><p>é˜…è¯»ä¸‹æ–¹çš„æºç æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ<code>ReadAll</code>å…¶å®è°ƒç”¨äº†ä¸€ä¸ªéå¯¼å‡ºçš„æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥çš„è¿½è¸ª</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ReadAll reads from r until an error or EOF and returns the data it read.</span><br><span class="hljs-comment">// A successful call returns err == nil, not err == EOF. Because ReadAll is</span><br><span class="hljs-comment">// defined to read from src until EOF, it does not treat an EOF from Read</span><br><span class="hljs-comment">// as an error to be reported.</span><br><span class="hljs-comment">// ReadAllä»rè¯»å–æ•°æ®ç›´åˆ°EOFæˆ–é‡åˆ°errorï¼Œè¿”å›è¯»å–çš„æ•°æ®å’Œé‡åˆ°çš„é”™è¯¯ã€‚</span><br><span class="hljs-comment">// æˆåŠŸçš„è°ƒç”¨è¿”å›çš„errä¸ºnilè€ŒéEOFã€‚</span><br><span class="hljs-comment">// å› ä¸ºæœ¬å‡½æ•°å®šä¹‰ä¸ºè¯»å–rç›´åˆ°EOFï¼Œå®ƒä¸ä¼šå°†è¯»å–è¿”å›çš„EOFè§†ä¸ºåº”æŠ¥å‘Šçš„é”™è¯¯ã€‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ReadAll</span><span class="hljs-params">(r io.Reader)</span> <span class="hljs-params">([]<span class="hljs-keyword">byte</span>, error)</span></span> &#123;<br><span class="hljs-keyword">return</span> readAll(r, bytes.MinRead)<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="2-readAll"><a href="#2-readAll" class="headerlink" title="2. readAll"></a>2. readAll</h5><p>é˜…è¯»è¿™ä¸ªå‡½æ•°ä»£ç ï¼Œå¯ä»¥å‘ç°ï¼Œ<code>ioutil.ReadAll</code>å®è´¨ä¸Šæ˜¯ä½¿ç”¨<code>bytes.buffer</code>å®ç°çš„ï¼Œåœ¨è¿™é‡Œé¢è°ƒç”¨äº†ä¸¤ä¸ª<code>bytes.buffer</code>çš„æ–¹æ³•ï¼Œä¸€ä¸ªç”¨æ¥åˆå§‹åŒ–<code>buffer</code>çš„å®¹é‡ï¼Œä¸€ä¸ªç”¨äºè¯»å–æ‰€æœ‰çš„<code>io.Reader</code>æ•°æ®</p><p>é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜å¯ä»¥å­¦ä¹ åˆ° go å½“ä¸­ panic recover çš„ä½¿ç”¨æ–¹æ³•ï¼Œåœ¨<code>buffer</code>å½“ä¸­ï¼Œå¦‚æœæ— æ³•åˆ†é…è¶³å¤Ÿçš„å†…å­˜çš„æ—¶å€™ï¼Œä¼šç›´æ¥<code>panic bytes.ErrTooLarge</code>çš„é”™è¯¯ï¼Œä½†æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬æœŸæœ›æŠŠè¿™ä¸ªé”™è¯¯ç»™è¿”å›å›æ¥ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨<code>defer recover</code>ä»<code>panic</code>å½“ä¸­æ¢å¤å›æ¥</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// readAll reads from r until an error or EOF and returns the data it read</span><br><span class="hljs-comment">// from the internal buffer allocated with a specified capacity.</span><br><span class="hljs-comment">// readAllä»rè¯»å–åˆ°ä¸€ä¸ªé”™è¯¯æˆ–EOFï¼Œå¹¶è¿”å›ä»æŒ‡å®šå®¹é‡åˆ†é…çš„å†…éƒ¨ç¼“å†²åŒºä¸­è¯»å–çš„æ•°æ®ã€‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readAll</span><span class="hljs-params">(r io.Reader, capacity <span class="hljs-keyword">int64</span>)</span> <span class="hljs-params">(b []<span class="hljs-keyword">byte</span>, err error)</span></span> &#123;<br>    <span class="hljs-comment">// æ–°å»ºäº†ä¸€ä¸ªbuffer</span><br><span class="hljs-keyword">var</span> buf bytes.Buffer<br><span class="hljs-comment">// If the buffer overflows, we will get bytes.ErrTooLarge.</span><br>    <span class="hljs-comment">// Return that as an error. Any other panic remains.</span><br>    <span class="hljs-comment">// å¦‚æœbufferæº¢å‡ºäº†ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªbytes.ErrTooLargeçš„é”™è¯¯</span><br>    <span class="hljs-comment">// å¦‚æœå¾—åˆ°çš„æ˜¯bytes.ErrTooLargeé”™è¯¯ï¼Œå°†å…¶è¿”å›ï¼Œå…¶ä»–panicé”™è¯¯ï¼Œä»ç„¶panic</span><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>e := <span class="hljs-built_in">recover</span>()<br><span class="hljs-keyword">if</span> e == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">if</span> panicErr, ok := e.(error); ok &amp;&amp; panicErr == bytes.ErrTooLarge &#123;<br>err = panicErr<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-built_in">panic</span>(e)<br>&#125;<br>    &#125;()<br>    <span class="hljs-comment">// åˆ¤æ–­capacityçš„å€¼æ˜¯å¦è¶…è¿‡äº†intç±»å‹çš„ä¸Šé™</span><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">int64</span>(<span class="hljs-keyword">int</span>(capacity)) == capacity &#123;<br><span class="hljs-comment">// å‘bufferå½“ä¸­å¢åŠ capacityçš„å®¹é‡</span><br>buf.Grow(<span class="hljs-keyword">int</span>(capacity))<br>    &#125;<br>    <span class="hljs-comment">// ä½¿ç”¨buffer ReadFrom æ–¹æ³•è¯»å–æ‰€æœ‰çš„io.Readeræ•°æ®</span><br>_, err = buf.ReadFrom(r)<br><span class="hljs-keyword">return</span> buf.Bytes(), err<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="3-buffer"><a href="#3-buffer" class="headerlink" title="3. buffer"></a>3. buffer</h5><p>è¦çœ‹<code>buffer</code>ç›¸å…³å‡½æ•°çš„å®ç°ï¼Œå…ˆçœ‹çœ‹<code>buffer</code>çš„å®šä¹‰ï¼Œä¸ç„¶åˆ°æ—¶å€™å¯èƒ½ä¼šæ‡µ B</p><p>ä¸»è¦ä¼šç”¨åˆ°ä¸¤ä¸ªå­—æ®µï¼Œä¸€ä¸ªæ˜¯<code>buf</code>,<code>buf</code>çš„å†…å®¹æ˜¯ç”¨<code>off</code>åˆ°<code>len(buf)</code>çš„ï¼Œ<code>off</code>ä¹‹å‰çš„è¡¨ç¤ºå·²ç»è¯»å–äº†æ•°æ®ï¼Œ<code>off</code>è¡¨ç¤ºå½“å‰ä½ç½®ï¼Œ<code>buffer</code>çš„<code>writeå’Œread</code>æ–¹æ³•éƒ½ä¼šä»è¿™ä¸ªä½ç½®å¼€å§‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// A Buffer is a variable-sized buffer of bytes with Read and Write methods.</span><br><span class="hljs-comment">// The zero value for Buffer is an empty buffer ready to use.</span><br><span class="hljs-comment">// Bufferæ˜¯ä¸€ä¸ªå®ç°äº†è¯»å†™æ–¹æ³•çš„å¯å˜å¤§å°çš„å­—èŠ‚ç¼“å†²ã€‚</span><br><span class="hljs-comment">// æœ¬ç±»å‹çš„é›¶å€¼æ˜¯ä¸€ä¸ªç©ºçš„å¯ç”¨äºè¯»å†™çš„ç¼“å†²ã€‚</span><br><span class="hljs-keyword">type</span> Buffer <span class="hljs-keyword">struct</span> &#123;<br>buf      []<span class="hljs-keyword">byte</span> <span class="hljs-comment">// contents are the bytes buf[off : len(buf)]</span><br>off      <span class="hljs-keyword">int</span>    <span class="hljs-comment">// read at &amp;buf[off], write at &amp;buf[len(buf)]</span><br>lastRead readOp <span class="hljs-comment">// last read operation, so that Unread* can work correctly.</span><br><span class="hljs-comment">// <span class="hljs-doctag">FIXME:</span> lastRead can fit in a single byte</span><br><br><span class="hljs-comment">// memory to hold first slice; helps small buffers avoid allocation.</span><br><span class="hljs-comment">// <span class="hljs-doctag">FIXME:</span> it would be advisable to align Buffer to cachelines to avoid false</span><br><span class="hljs-comment">// sharing.</span><br>bootstrap [<span class="hljs-number">64</span>]<span class="hljs-keyword">byte</span><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="4-buffer-Grow"><a href="#4-buffer-Grow" class="headerlink" title="4. buffer.Grow"></a>4. buffer.Grow</h5><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨æ¥å¢åŠ ç¼“å†²åŒºçš„å†…å­˜ï¼Œå®é™…è¿˜æ˜¯è°ƒç”¨äº†éå¯¼å‡ºçš„<code>grow</code>æ–¹æ³•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Grow grows the buffer&#x27;s capacity, if necessary, to guarantee space for</span><br><span class="hljs-comment">// another n bytes. After Grow(n), at least n bytes can be written to the</span><br><span class="hljs-comment">// buffer without another allocation.</span><br><span class="hljs-comment">// If n is negative, Grow will panic.</span><br><span class="hljs-comment">// If the buffer can&#x27;t grow it will panic with ErrTooLarge.</span><br><span class="hljs-comment">// å¿…è¦æ—¶ä¼šå¢åŠ ç¼“å†²çš„å®¹é‡ï¼Œä»¥ä¿è¯nå­—èŠ‚çš„å‰©ä½™ç©ºé—´ã€‚</span><br><span class="hljs-comment">// è°ƒç”¨Grow(n)åè‡³å°‘å¯ä»¥å‘ç¼“å†²ä¸­å†™å…¥nå­—èŠ‚æ•°æ®è€Œæ— éœ€ç”³è¯·å†…å­˜ã€‚</span><br><span class="hljs-comment">// å¦‚æœnå°äºé›¶æˆ–è€…ä¸èƒ½å¢åŠ å®¹é‡éƒ½ä¼španic ErrTooLarge é”™è¯¯ã€‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Buffer)</span> <span class="hljs-title">Grow</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;bytes.Buffer.Grow: negative count&quot;</span>)<br>&#125;<br>m := b.grow(n)<br>b.buf = b.buf[<span class="hljs-number">0</span>:m]<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="5-buffer-ReadFrom"><a href="#5-buffer-ReadFrom" class="headerlink" title="5. buffer.ReadFrom"></a>5. buffer.ReadFrom</h5><p>ä¸»è¦çœ‹çœ‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼Œå®ç°äº†ä»<code>io.Reader</code>è¯»å–æ‰€æœ‰æ•°æ®ã€‚</p><p>ç¤ºæ„å›¾:<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-142743.png" alt="ç¤ºæ„å›¾"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ReadFrom reads data from r until EOF and appends it to the buffer, growing</span><br><span class="hljs-comment">// the buffer as needed. The return value n is the number of bytes read. Any</span><br><span class="hljs-comment">// error except io.EOF encountered during the read is also returned. If the</span><br><span class="hljs-comment">// buffer becomes too large, ReadFrom will panic with ErrTooLarge.</span><br><span class="hljs-comment">// ReadFromä»rä¸­è¯»å–æ•°æ®ç›´åˆ°ç»“æŸå¹¶å°†è¯»å–çš„æ•°æ®å†™å…¥ç¼“å†²ä¸­ï¼Œå¦‚å¿…è¦ä¼šå¢åŠ ç¼“å†²å®¹é‡ã€‚</span><br><span class="hljs-comment">// è¿”å›å€¼nä¸ºä»rè¯»å–å¹¶å†™å…¥bçš„å­—èŠ‚æ•°ï¼›ä¼šè¿”å›è¯»å–æ—¶é‡åˆ°çš„é™¤äº†io.EOFä¹‹å¤–çš„é”™è¯¯ã€‚</span><br><span class="hljs-comment">// å¦‚æœç¼“å†²å¤ªå¤§ï¼ŒReadFromä¼šé‡‡ç”¨é”™è¯¯å€¼ErrTooLargeå¼•å‘panicã€‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Buffer)</span> <span class="hljs-title">ReadFrom</span><span class="hljs-params">(r io.Reader)</span> <span class="hljs-params">(n <span class="hljs-keyword">int64</span>, err error)</span></span> &#123;<br>    <span class="hljs-comment">// const opInvalid = 0  // Non-read operation. è¡¨ç¤ºä¹‹å‰æ²¡æœ‰è¯»æ“ä½œ</span><br>b.lastRead = opInvalid<br>    <span class="hljs-comment">// If buffer is empty, reset to recover space.</span><br>    <span class="hljs-comment">// å¦‚æœç¼“å†²åŒºä¸ºç©ºï¼Œé‡ç½®ä¸ºæ¢å¤ç©ºé—´ã€‚</span><br><span class="hljs-keyword">if</span> b.off &gt;= <span class="hljs-built_in">len</span>(b.buf) &#123;<br>b.Reset()<br>    &#125;<br>    <span class="hljs-comment">// å¾ªç¯è¯»å–io.Reader çš„æ•°æ®</span><br><span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-comment">// åˆ¤æ–­å½“å‰å‰©ä½™ç©ºé—´æ˜¯å¦å°äºMinReadï¼ŒMinRead = 512</span><br><span class="hljs-keyword">if</span> free := <span class="hljs-built_in">cap</span>(b.buf) - <span class="hljs-built_in">len</span>(b.buf); free &lt; MinRead &#123;<br>            <span class="hljs-comment">// not enough space at end</span><br>            <span class="hljs-comment">// ç©ºé—´ä¸è¶³</span><br>            <span class="hljs-comment">// æ–°å»ºä¸€ä¸ªbuf</span><br>            newBuf := b.buf<br>            <span class="hljs-comment">// åˆ¤æ–­å®é™…å‰©ä½™å®¹é‡æ˜¯å¦å°äºMinRead = 512</span><br><span class="hljs-keyword">if</span> b.off+free &lt; MinRead &#123;<br><span class="hljs-comment">// not enough space using beginning of buffer;</span><br>                <span class="hljs-comment">// double buffer capacity</span><br>                <span class="hljs-comment">// å®é™…å‰©ä½™ç©ºé—´ä¸è¶³ï¼Œåˆ†é…åŒå€çš„ç¼“å†²ç©ºé—´ï¼Œç¼“å†²çš„æœ€å°å€¼ä¸ºMinReadæ‰€ä»¥åŠ ä¸Šä¸€ä¸ªMinReadï¼Œé¿å…åŒå€ä¹‹åä»ç„¶æ¯”MinReadå°</span><br>                <span class="hljs-comment">// makeSliceå‡½æ•°ç”¨äºåˆ†é…ç¼“å†²ç©ºé—´ï¼Œå¦‚æœåˆ†é…å¤±è´¥ä¼španic ErrTooLarge é”™è¯¯</span><br>newBuf = makeSlice(<span class="hljs-number">2</span>*<span class="hljs-built_in">cap</span>(b.buf) + MinRead)<br>            &#125;<br>            <span class="hljs-comment">// å°†åŸæœ‰bufæ•°æ®å¤åˆ¶åˆ°æ–°çš„buf</span><br>            <span class="hljs-built_in">copy</span>(newBuf, b.buf[b.off:])<br>            <span class="hljs-comment">// len(b.buf)-b.off å°±ç­‰äºbufå½“å‰å†…å®¹çš„é•¿åº¦</span><br>            <span class="hljs-comment">// ä¾‹å­: a:=make([]byte,20)</span><br>            <span class="hljs-comment">//      b:=a[:10]</span><br>            <span class="hljs-comment">//      len(b) // 10</span><br>            <span class="hljs-comment">//      cap(b) //20</span><br>            b.buf = newBuf[:<span class="hljs-built_in">len</span>(b.buf)-b.off]<br>            <span class="hljs-comment">// å°†offç½®0</span><br>b.off = <span class="hljs-number">0</span><br>        &#125;<br>        <span class="hljs-comment">// ä»io.Readerå½“ä¸­è¯»å–æ•°æ®ï¼Œä¼ å…¥bufçš„å‰©ä½™ç©ºé—´</span><br>        <span class="hljs-comment">// ç¬¬ä¸€ç§æƒ…å†µï¼Œæ•°æ®è¯»å–å®Œæ¯•ï¼Œè¿”å›è¯»å–é•¿åº¦mä»¥åŠ,io.EOFé”™è¯¯</span><br>        <span class="hljs-comment">// ç¬¬äºŒç§æƒ…å†µ, æ•°æ®æœªè¯»å®Œï¼Œé‡åˆ°é”™è¯¯</span><br>        <span class="hljs-comment">// ç¬¬ä¸‰ç§æƒ…å†µï¼Œæ•°æ®æœªè¯»å®Œï¼Œç¼“å†²åŒºå®¹é‡ä¸å¤Ÿï¼Œè¿”å›è¯»å–æ•°æ®é•¿åº¦mä»¥åŠnil</span><br>        m, e := r.Read(b.buf[<span class="hljs-built_in">len</span>(b.buf):<span class="hljs-built_in">cap</span>(b.buf)])<br>        <span class="hljs-comment">// åªè·å–æœ‰æ•°æ®çš„bufï¼Œæ— æ•°æ®çš„ç©ºé—´è½¬åŒ–ä¸ºcap</span><br>b.buf = b.buf[<span class="hljs-number">0</span> : <span class="hljs-built_in">len</span>(b.buf)+m]<br>        n += <span class="hljs-keyword">int64</span>(m)<br>        <span class="hljs-comment">// æ•°æ®è¯»å–å®Œæ¯•è·³å‡ºå¾ªç¯</span><br><span class="hljs-keyword">if</span> e == io.EOF &#123;<br><span class="hljs-keyword">break</span><br>        &#125;<br>        <span class="hljs-comment">// é‡åˆ°é”™è¯¯è¿”å›</span><br><span class="hljs-keyword">if</span> e != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> n, e<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> n, <span class="hljs-literal">nil</span> <span class="hljs-comment">// err is EOF, so return nil explicitly</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>goæ ‡å‡†åº“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä½¿ç”¨chromedpè§£å†³åçˆ¬è™«é—®é¢˜</title>
    <link href="/post/5431.html"/>
    <url>/post/5431.html</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘ We å·å¤§ä¸Šçš„æ•™åŠ¡å¤„å…¬å‘Šæ–°é—»å·²ç»å¾ˆä¹…æ²¡æœ‰æ›´æ–°äº†ï¼Œæƒ³åˆ°å¯èƒ½æ˜¯ ip è¢«å°äº†ï¼ŒæŸ¥äº†ä¸€ä¸‹ logï¼Œå‘ç°å¹¶ä¸æ˜¯ï¼Œè€Œæ˜¯è·å–åˆ°çš„é¡µé¢å…¨å˜æˆäº†æ··æ·†è¿‡çš„ jsï¼Œä¸‹é¢æ”¾ä¸¤ä¸ªæ ¼å¼åŒ–çš„å‡½æ•°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_$Es</span>(<span class="hljs-params">_$Cu</span>) </span>&#123;<br>  _$Cu[<span class="hljs-number">14</span>] = _$v9();<br>  _$Cu[_$yf(_$ox(), <span class="hljs-number">16</span>)] = _$Dn();<br>  <span class="hljs-keyword">var</span> _$cR = _$CR();<br>  _$cR = _$iT();<br>  <span class="hljs-keyword">return</span> _$DA();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_$Dk</span>(<span class="hljs-params">_$Cu</span>) </span>&#123;<br>  <span class="hljs-keyword">var</span> _$x5 = _$Dv();<br>  <span class="hljs-keyword">var</span> _$x5 = _$EB();<br>  <span class="hljs-keyword">if</span> (_$Ex()) &#123;<br>    _$w9 = _$Dw();<br>  &#125;<br>  _$Cu[_$yf(_$EJ(), <span class="hljs-number">16</span>)] = _$ED();<br>  _$Cu[_$yf(_$Ep(), <span class="hljs-number">16</span>)] = _$EP();<br>  _$w9 = _$EB();<br>  <span class="hljs-keyword">return</span> _$Cu[_$yf(_$v9(), <span class="hljs-number">16</span>)];<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_$rK</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">var</span> _$aJ = _$c0(_$DN());<br>  _$aJ = _$BC(_$aJ, <span class="hljs-number">2</span>);<br>  <span class="hljs-keyword">var</span> _$Ce = _$yr(_$qt());<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> _$Cu = <span class="hljs-number">0</span>; _$Cu &lt; _$aJ[_$gX()]; _$Cu++) &#123;<br>    _$aJ[_$Cu] = _$Ce + _$aJ[_$Cu];<br>  &#125;<br>  <span class="hljs-keyword">return</span> _$aJ;<br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹ç€è¿™ä¸€å †å°±å¤´å¤§ï¼Œä½†æ˜¯æœ¬ç€åªè¦æ˜¯æµè§ˆå™¨èƒ½å¤Ÿæ¸²æŸ“å‡ºæ¥çš„é¡µé¢çˆ¬è™«å°±å¯ä»¥çˆ¬åˆ°çš„åŸåˆ™ï¼Œä¸€æ­¥ä¸€æ­¥çš„è§£å†³</p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><ol><li>å…ˆä½¿ç”¨ postman å‘é€äº†ä¸€ä¸‹è¯·æ±‚ï¼Œå‘ç°è¿”å›äº†ä¸Šé¢ä¸€å †ä¹±ç </li><li>å¤åˆ¶äº†æ­£å¸¸æ¸²æŸ“é¡µé¢ request header é‡æ–°å‘é€è¯·æ±‚ï¼Œå¯ä»¥å¾—åˆ°æ­£å¸¸çš„é¡µé¢ã€‚è€ƒè™‘ä¸¤ä¸ªå¯èƒ½ä¸€ä¸ªæ˜¯ header æœ‰ä»€ä¹ˆç‰¹æ®Šçš„å¤„ç†ï¼Œä¸€ä¸ªæ˜¯ cookie ä¸Šçš„é—®é¢˜ã€‚</li><li>header å…¶ä»–å†…å®¹ä¸å˜ï¼Œå»æ‰ cookie é‡æ–°å‘é€è¯·æ±‚ï¼Œå†ä¸€æ¬¡å¾—åˆ°ä¸€å †ä¹±ç ã€‚é—®é¢˜å®šä½æˆåŠŸï¼Œåº”è¯¥å°±æ˜¯ cookie çš„é—®é¢˜äº†</li><li>æ¸…ç©º chrome çš„ç¼“å­˜ï¼Œé‡æ–°åŠ è½½é¡µé¢ï¼ŒæŸ¥çœ‹è¯·æ±‚è®°å½•ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªé¡µé¢ä¸€å…±åŠ è½½äº†ä¸¤æ¬¡<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141634.png" alt="ç¬¬ä¸€æ¬¡åŠ è½½"><br>ç¬¬ä¸€æ¬¡åŠ è½½æ²¡æœ‰è¿”å› cookie<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141635.png" alt="ç¬¬äºŒæ¬¡åŠ è½½"><br>ç¬¬äºŒæ¬¡åŠ è½½è¿”å›äº†ä¸€ä¸ª<code>JSESSIONID</code>ï¼Œè¿™ä¸ªåº”è¯¥å°±æ˜¯æœ€ç»ˆéœ€è¦çš„ cookie äº†</li><li>è§‚å¯Ÿä¸¤æ¬¡è¯·æ±‚çš„ä¸­é—´ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°è¿˜æœ‰ä¸¤ä¸ªè¯·æ±‚ï¼Œè¿™ä¸¤ä¸ªè¯·æ±‚åº”è¯¥å°±æ˜¯ç¬¬äºŒæ¬¡è¿”å› cookie çš„åŸå› äº†ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚æ˜¯é¡µé¢å†…çš„å¤–é“¾ js æ–‡ä»¶ï¼Œç¬¬äºŒä¸ªè¯·æ±‚åº”è¯¥å°±æ˜¯æ··æ·†è¿‡çš„ js å‘å‡ºçš„è¯·æ±‚äº†ã€‚</li><li>å› ä¸ºå®åŠ›æœ‰é™ï¼Œåˆ†æäº†å‡ ä¸ªå°æ—¶éƒ½æ²¡æœ‰åˆ†æå‡ºæ¥è¿™ä¸ªé€»è¾‘æ˜¯æ€ä¹ˆåŠ è½½çš„ã€‚ä½†æ˜¯æƒ³åˆ°äº†ç›´æ¥ä»æµè§ˆå™¨æŠŠ cookie å¤åˆ¶ä¸‹æ¥ç»™çˆ¬è™«ä½¿ç”¨ä¸å°±å¯ä»¥äº†ï¼Ÿä½†æ˜¯è¿™æ ·ä¹Ÿè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä¸å¯èƒ½æ¯ä¸€æ¬¡éƒ½æ‰‹åŠ¨çš„å»è·å– cookie è¿™æ ·è¾¾ä¸åˆ°æƒ³è¦çš„æ•ˆæœã€‚ç„¶åçœ‹åˆ° Python æœ‰ä½¿ç”¨<code>Selenium</code>æ¥å®Œå…¨æ¨¡æ‹Ÿæµè§ˆå™¨æ¸²æŸ“ç„¶åè§£æé¡µé¢çš„çˆ¬è™«æ¡ˆä¾‹ï¼Œæ‰¾äº†ä¸€ä¸‹ golang æœ‰æ²¡æœ‰ç±»ä¼¼çš„æµè§ˆå™¨æ¸²æŸ“æ–¹æ¡ˆï¼Œåœ¨ä¸‡èƒ½çš„ gayhub ä¸Šæ‰¾åˆ°äº†<code>chromedp</code>ã€‚ä¸‹é¢ä½¿ç”¨ chromedp æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</li></ol><h2 id="chromedp"><a href="#chromedp" class="headerlink" title="chromedp"></a>chromedp</h2><blockquote><p>Package chromedp is a faster, simpler way to drive browsers (Chrome, Edge, Safari, Android, etc) without external dependencies (ie, Selenium, PhantomJS, etc) using the Chrome Debugging Protocol.</p></blockquote><h5 id="1-installï¼ˆå»ºè®®ä½¿ç”¨æ¢¯å­ï¼‰"><a href="#1-installï¼ˆå»ºè®®ä½¿ç”¨æ¢¯å­ï¼‰" class="headerlink" title="1.installï¼ˆå»ºè®®ä½¿ç”¨æ¢¯å­ï¼‰"></a>1.installï¼ˆå»ºè®®ä½¿ç”¨æ¢¯å­ï¼‰</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go get -u github.com/chromedp/chromedp<br></code></pre></td></tr></table></figure><h5 id="2-code"><a href="#2-code" class="headerlink" title="2.code"></a>2.code</h5><p>è¿è¡Œä¸‹é¢è¿™ä¸€æ®µä»£ç å¯ä»¥çœ‹åˆ° chrome ä¼šå¼¹å‡ºä¸€ä¸ªçª—å£å¹¶ä¸”è¿è¡Œç½‘é¡µï¼Œæœ€ååœ¨ console è¾“å‡ºæœŸæœ›çš„ htmlï¼Œä½†æ˜¯æˆ‘ä»¬å…¶å®åªéœ€è¦å¾—åˆ°æ­£ç¡®çš„ cookieï¼Œç”¨æ¥ä¹‹åçˆ¬å–ç½‘é¡µä½¿ç”¨ã€‚å¦‚æœæ‰€æœ‰çš„é¡µé¢éƒ½éœ€è¦ç­‰å¾… chrome æ¸²æŸ“ç»“æŸä¹‹åçˆ¬å–ï¼Œé‚£ä¹ˆæ•ˆç‡å®åœ¨æ˜¯å¤ªä½äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;context&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;io/ioutil&quot;</span><br><span class="hljs-string">&quot;log&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br><br><span class="hljs-string">&quot;github.com/chromedp/cdproto/cdp&quot;</span><br><span class="hljs-string">&quot;github.com/chromedp/chromedp&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> err error<br><br><span class="hljs-comment">// create context</span><br>ctxt, cancel := context.WithCancel(context.Background())<br><span class="hljs-keyword">defer</span> cancel()<br><br><span class="hljs-comment">// create chrome instance</span><br>c, err := chromedp.New(ctxt, chromedp.WithLog(log.Printf))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatal(err)<br>&#125;<br><br><span class="hljs-comment">// run task list</span><br><span class="hljs-keyword">var</span> res <span class="hljs-keyword">string</span><br>err = c.Run(ctxt, chromedp.Tasks&#123;<br>        <span class="hljs-comment">// è®¿é—®æ•™åŠ¡å¤„é¡µé¢</span><br>chromedp.Navigate(<span class="hljs-string">`http://jwc.scu.edu.cn/jwc/moreNotice.action`</span>),<br>        <span class="hljs-comment">// ç­‰å¾…tableæ¸²æŸ“æˆåŠŸï¼ŒæˆåŠŸåˆ™è¯´æ˜å·²ç»è·å–åˆ°äº†æ­£ç¡®çš„é¡µé¢</span><br>        chromedp.WaitVisible(<span class="hljs-string">`table`</span>, chromedp.ByQuery),<br>        <span class="hljs-comment">// è·å–bodyæ ‡ç­¾çš„htmlå­—ç¬¦</span><br>chromedp.OuterHTML(<span class="hljs-string">&quot;body&quot;</span>, &amp;res),<br>&#125;)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatal(err)<br>&#125;<br><br><span class="hljs-comment">// å…³é—­chromeå®ä¾‹</span><br>err = c.Shutdown(ctxt)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatal(err)<br>&#125;<br><br><span class="hljs-comment">// ç­‰å¾…chromeå®ä¾‹å…³é—­</span><br>err = c.Wait()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatal(err)<br>&#125;<br><br>    <span class="hljs-comment">// è¾“å‡ºhtmlå­—ç¬¦ä¸²</span><br>log.Printf(res)<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="3-è·å–-cookie"><a href="#3-è·å–-cookie" class="headerlink" title="3.è·å– cookie"></a>3.è·å– cookie</h5><p>ä¿®æ”¹ç¬¬ 2 æ­¥å½“ä¸­ task list çš„ä»£ç è·å– cookieï¼Œä¿®æ”¹ä¹‹åå¯ä»¥çœ‹åˆ° console å½“ä¸­è¾“å‡ºäº†ä¸€æ®µ cookie å­—ç¬¦ä¸²ï¼Œä½¿ç”¨è¿™ä¸ª cookie åœ¨ postman å½“ä¸­æµ‹è¯•å¯ä»¥å‘ç°ï¼Œå¯ä»¥è·å–åˆ°æ­£ç¡®çš„é¡µé¢ã€‚åˆ°äº†è¿™ä¸€æ­¥å…¶å®å°±åº”è¯¥ç®—åŸºæœ¬å®Œæˆäº†ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼šæ¯æ¬¡è¿è¡Œçš„æ—¶å€™éƒ½ä¼šå¼¹å‡ºä¸€ä¸ª chrome çª—å£ï¼Œçˆ¬è™«åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œæ˜¯æ²¡æœ‰ gui é¡µé¢çš„ï¼Œå¹¶ä¸”æ¯æ¬¡æ‰“å¼€ä¸€ä¸ª chrome å®ä¾‹çš„æ—¶é—´å¼€é”€ä¹Ÿæ¯”è¾ƒå¤§ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å°†chromedp.OuterHTML(&quot;body&quot;, &amp;res) æ›¿æ¢ä¸ºä¸‹é¢çš„ä»£ç </span><br>chromedp.ActionFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, h cdp.Executor)</span> <span class="hljs-title">error</span></span> &#123;<br>    <span class="hljs-comment">// è·å–cookie</span><br>    cookies, err := network.GetAllCookies().Do(ctx, h)<br><br>    <span class="hljs-comment">// å°†cookieæ‹¼æ¥æˆheaderè¯·æ±‚ä¸­cookieå­—æ®µçš„æ¨¡å¼</span><br>    <span class="hljs-keyword">var</span> c <span class="hljs-keyword">string</span><br>    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> cookies &#123;<br>        c = c + v.Name + <span class="hljs-string">&quot;=&quot;</span> + v.Value + <span class="hljs-string">&quot;;&quot;</span><br>    &#125;<br>    log.Println(c)<br><br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> err<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;),<br></code></pre></td></tr></table></figure><h5 id="5-ä½¿ç”¨-chrome-çš„-headless-æ¨¡å¼"><a href="#5-ä½¿ç”¨-chrome-çš„-headless-æ¨¡å¼" class="headerlink" title="5.ä½¿ç”¨ chrome çš„ headless æ¨¡å¼"></a>5.ä½¿ç”¨ chrome çš„ headless æ¨¡å¼</h5><p>a.ä½¿ç”¨ docker è¿è¡Œä¸€ä¸ª headless æ¨¡å¼çš„ chrome</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d -p 9222:9222 --rm --name chrome-headless knqz/chrome-headless<br></code></pre></td></tr></table></figure><p>b.ä¿®æ”¹ä»£ç </p><p>å¯ä»¥çœ‹åˆ°ä¸»è¦çš„åŒºåˆ«å°±åœ¨åˆ›å»º chrome å®ä¾‹çš„æ—¶å€™æ²¡æœ‰å»å¯åŠ¨ä¸€ä¸ª chromeï¼Œå½“ç„¶æœ€åä¹Ÿä¸éœ€è¦å»å…³é—­å®ƒ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;context&quot;</span><br><span class="hljs-string">&quot;log&quot;</span><br><br><span class="hljs-string">&quot;github.com/chromedp/chromedp/client&quot;</span><br><br><span class="hljs-string">&quot;github.com/chromedp/cdproto/network&quot;</span><br><br><span class="hljs-string">&quot;github.com/chromedp/cdproto/cdp&quot;</span><br><br><span class="hljs-string">&quot;github.com/chromedp/chromedp&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> err error<br><br><span class="hljs-comment">// create context</span><br>ctxt, cancel := context.WithCancel(context.Background())<br><span class="hljs-keyword">defer</span> cancel()<br><br><span class="hljs-comment">// create chrome instance</span><br>c, err := chromedp.New(ctxt, chromedp.WithTargets(client.New().WatchPageTargets(ctxt)), chromedp.WithLog(log.Printf))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatal(err)<br>&#125;<br><br><span class="hljs-comment">// run task list</span><br>err = c.Run(ctxt, chromedp.Tasks&#123;<br>        <span class="hljs-comment">// è®¿é—®æ•™åŠ¡å¤„é¡µé¢</span><br>chromedp.Navigate(<span class="hljs-string">`http://jwc.scu.edu.cn/jwc/moreNotice.action`</span>),<br>        <span class="hljs-comment">// ç­‰å¾…tableæ¸²æŸ“æˆåŠŸï¼ŒæˆåŠŸåˆ™è¯´æ˜å·²ç»è·å–åˆ°äº†æ­£ç¡®çš„é¡µé¢</span><br>        chromedp.WaitVisible(<span class="hljs-string">`table`</span>, chromedp.ByQuery),<br>        <span class="hljs-comment">// è·å–bodyæ ‡ç­¾çš„htmlå­—ç¬¦</span><br>chromedp.ActionFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, h cdp.Executor)</span> <span class="hljs-title">error</span></span> &#123;<br>            <span class="hljs-comment">// è·å–cookie</span><br>            cookies, err := network.GetAllCookies().Do(ctx, h)<br><br>            <span class="hljs-comment">// å°†cookieæ‹¼æ¥æˆheaderè¯·æ±‚ä¸­cookieå­—æ®µçš„æ¨¡å¼</span><br>            <span class="hljs-keyword">var</span> c <span class="hljs-keyword">string</span><br>            <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> cookies &#123;<br>                c = c + v.Name + <span class="hljs-string">&quot;=&quot;</span> + v.Value + <span class="hljs-string">&quot;;&quot;</span><br>            &#125;<br>            log.Println(c)<br><br>            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                <span class="hljs-keyword">return</span> err<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>        &#125;),<br>&#125;)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatal(err)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ°è¿™é‡ŒåŸºæœ¬å°±å¯ä»¥ä½¿ç”¨äº†ï¼Œè·å–åˆ° cookie ä¹‹åå¯ä»¥ä½¿ç”¨å–œæ¬¢çš„æ–¹å¼å»è·å–é¡µé¢</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>çˆ¬è™«</tag>
      
      <tag>chromedp</tag>
      
      <tag>å››å·å¤§å­¦</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Weå·å¤§å¼€å‘ç¬”è®°@0.2.0</title>
    <link href="/post/62925.html"/>
    <url>/post/62925.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p>å¯ä»¥æœç´¢å°ç¨‹åº<code>weå·å¤§</code>ç›´æ¥ä½“éªŒ</p><p>è¿™ä¸æ˜¯åˆšåˆšå‘å®Œ 0.1.0 çš„ç¬”è®°ä¹ˆï¼Ÿæ€ä¹ˆ 0.2.0 éƒ½å‡ºæ¥äº†ï¼Ÿ</p><p>æ²¡æœ‰çœ‹é”™ï¼Œæ•ˆç‡å°±æ˜¯é‚£ä¹ˆé«˜ï¼Œä¸Šä¸€ç¯‡ä¹Ÿæåˆ°äº† 0.1.0 å®¡æ ¸é€šè¿‡çš„æ—¶å€™ 0.2.0 å°±åŸºæœ¬å·²ç»å®Œæˆäº†ï¼Œè€Œä¸”ç°åœ¨å·²ç»ä¸Šçº¿äº†(å‡†ç¡®çš„è¯´æ˜¯ 0.2.1 ç‰ˆæœ¬)ï¼Œè¿™ä¸€æ¬¡çš„å®¡æ ¸å¿«äº†è®¸å¤šï¼Œåªç”¨äº†ä¸åˆ°ä¸¤å¤©å°±å·²ç»å®¡æ ¸é€šè¿‡äº†</p><h2 id="åŠŸèƒ½é¢„è§ˆ"><a href="#åŠŸèƒ½é¢„è§ˆ" class="headerlink" title="åŠŸèƒ½é¢„è§ˆ"></a>åŠŸèƒ½é¢„è§ˆ</h2><p>è¿™ä¸€ç‰ˆä¸»è¦æ–°å¢ä¸‰ä¸ªåŠŸèƒ½ï¼Œç„¶åå°±æ˜¯ä¸€äº›ä¼˜åŒ–ï¼š</p><p><strong>1.åé¦ˆ</strong></p><p>å‚è€ƒ we é‡é‚®ï¼Œç›´æ¥å’Œ github çš„ issue å…³è”ï¼Œæ‰€æœ‰æäº¤çš„åé¦ˆä¿¡æ¯ï¼Œéƒ½ä¼šæ–°å»ºä¸€æ¡ issueï¼Œä¸ºäº†é˜²æ­¢æ»¥ç”¨ï¼Œæ¯å¤©çš„åé¦ˆæ¬¡æ•°åšäº†ä¸€å®šçš„é™åˆ¶</p><p>è¿™ä¸ªåç«¯ä¸Šç›´æ¥é‡‡ç”¨äº† Google çš„ go-github åŒ…ï¼Œå¼€å‘èµ·æ¥ååˆ†çš„æ–¹ä¾¿ï¼Œåªæ˜¯æ–‡æ¡£èµ„æ–™ä¸æ˜¯ç‰¹åˆ«çš„ä¸°å¯Œï¼Œä¹‹åä¼šä¸“é—¨æ€»ç»“ä¸€ä¸‹</p><p><strong>2.ç©ºé—²æ•™å®¤æŸ¥è¯¢</strong></p><p>å­¦æ ¡çš„ç©ºé—²æ•™å®¤æŸ¥è¯¢é¡µé¢ï¼š<a href="http://cir.scu.edu.cn/cir/index.html">http://cir.scu.edu.cn/cir/index.html</a></p><p>è¿™æ˜¯å­¦æ ¡éš¾å¾—åšçš„æ¯”è¾ƒå‹å¥½çš„ç«™ç‚¹ï¼Œå¯¹äºè¿™ä¸ªéœ€è¦åç«¯åšä¸€æ¬¡æ¥å£ä¸­è½¬å³å¯</p><p><strong>3.æ–°é—» Tag åˆ—è¡¨</strong></p><p>è¿™ä¸€ç‰ˆå¯ä»¥ç›´æ¥é€šè¿‡ç‚¹å‡»åˆ—è¡¨çš„ tagï¼ŒæŸ¥çœ‹å‰ 20 æ¡åŒ…å«è¯¥ tag çš„æ–°é—»ï¼Œ è‡³äºä¸ºä»€ä¹ˆæ˜¯ 20 æ¡ï¼Œå› ä¸ºä¸€ä¸ªå¾ˆå¥‡æ€ªçš„ bug ç°åœ¨è¿˜æ²¡æœ‰è§£å†³ã€‚</p><p>ä¸¤ä¸ªé¡µé¢ï¼ŒAï¼ŒB åŒ…å«äº†åŒä¸€ä¸ªæ¨¡å— Cï¼Œåœ¨æ¨¡å— C å½“ä¸­å¯ä»¥ç‚¹å‡»è·³è½¬åˆ° Bï¼Œç°åœ¨çš„é—®é¢˜å°±æ˜¯åœ¨ A é¡µé¢çš„ C æ¨¡å—å½“ä¸­ç‚¹å‡»è·³è½¬åˆ° B é¡µé¢ä¹‹åï¼ŒB é¡µé¢çš„ C æ¨¡å—çš„ scroll-view ç»‘å®šçš„æ‰€æœ‰äº‹ä»¶éƒ½ä¼šæ¶ˆå¤±</p><h2 id="å›¾ç‰‡é¢„è§ˆ"><a href="#å›¾ç‰‡é¢„è§ˆ" class="headerlink" title="å›¾ç‰‡é¢„è§ˆ"></a>å›¾ç‰‡é¢„è§ˆ</h2><p><img src="https://user-images.githubusercontent.com/15172509/35327035-66a31fb8-0133-11e8-9694-862bb9580b95.png" alt="screenshot_2018-01-24-18-19-17-192_com tencent mm"><br><img src="https://user-images.githubusercontent.com/15172509/35327038-672fd782-0133-11e8-821d-5e280bade960.png" alt="screenshot_2018-01-24-18-18-56-360_com tencent mm"><br><img src="https://user-images.githubusercontent.com/15172509/35327040-67727a4c-0133-11e8-9173-7fcd92ff5c0a.png" alt="screenshot_2018-01-24-18-19-02-187_com tencent mm"></p><h2 id="åšå®¢åŸæ–‡-amp-amp-å¼€æºåœ°å€"><a href="#åšå®¢åŸæ–‡-amp-amp-å¼€æºåœ°å€" class="headerlink" title="åšå®¢åŸæ–‡&amp;&amp;å¼€æºåœ°å€"></a>åšå®¢åŸæ–‡&amp;&amp;å¼€æºåœ°å€</h2><p><a href="https://github.com/mohuishou/scuplus-wechat">https://github.com/mohuishou/scuplus-wechat</a><br><a href="http://lailin.xyz/post/Weå·å¤§å¼€å‘ç¬”è®°@0.2.0/">http://lailin.xyz/post/We å·å¤§å¼€å‘ç¬”è®°@0.2.0/</a></p><p>å¯ä»¥å…³æ³¨å¼€å‘è¿›åº¦æˆ–è€…æäº¤åé¦ˆæˆ–è€…æ˜¯ PRï¼Œstar å¤šå¤šç›Šå–„</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>weå·å¤§</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Weå·å¤§å¼€å‘ç¬”è®°@0.1.0</title>
    <link href="/post/62781.html"/>
    <url>/post/62781.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p>å¾®ä¿¡å°ç¨‹åºå·²ç»å‡ºæ¥ä¸€å¹´å·¦å³äº†ï¼Œç„¶åä¹‹å‰ä¹Ÿå†™è¿‡ä¸€ä¸ª scuplus çš„ web é¡¹ç›®ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ­£å¼ä¸Šçº¿å°±æ— ç–¾è€Œç»ˆäº†ï¼Œå½“ç„¶ä¹Ÿä¸æ˜¯ä¸€ç‚¹ç”¨å¤„éƒ½æ²¡æœ‰ï¼Œæ‹†åˆ†å‡ºæ¥äº†ä¸¤ä¸ªå°çš„åŠŸèƒ½æ¨¡å—ï¼Œä¸€ä¸ªæ˜¯ç»©ç‚¹è®¡ç®—å™¨ï¼Œä¸€ä¸ªå¿«æ·è¯„æ•™ï¼Œç»©ç‚¹è®¡ç®—å™¨çš„æ—¥ PV å¿«è¦ç ´ 3W äº†ï¼ŒUV å·²ç»ç ´ 1W äº†ï¼Œå¤§å®¶æœŸæœ«çœ‹æˆç»©çš„å¿ƒæƒ…ä¾æ—§æ˜¯é‚£ä¹ˆçš„æ€¥è¿«ã€‚</p><p>æŒ‰ç†æ¥è¯´ï¼Œæˆ‘å³å°†æ¯•ä¸šåšè¿™äº›å…¶å®ä¸å¤ªå¥½ï¼Œæ¯•ä¸šä¹‹åä»£ç çš„ç»´æŠ¤ä»¥åŠè¿è¥éƒ½æ˜¯ä¸€ä¸ªå¤§é—®é¢˜ï¼Œä½†æ˜¯å·å¤§ä¸€ç›´ç¼ºå°‘ä¸€ä¸ªç»¼åˆå‹çš„ APP æˆ–è€…ç½‘ç«™ï¼Œå­¦æ ¡å®˜æ–¹çš„ç½‘ç«™åšçš„éƒ½åŠå…¶çš„ä¸å‹å¥½ï¼Œè€Œä¸”ååˆ†çš„åˆ†æ•£ï¼Œæ‰€ä»¥ä¸€ç›´æœ‰è¿™ä¸ªæƒ³æ³•ï¼Œæƒ³åšä¸€ä¸ªé›†æ–°é—»èµ„è®¯ã€æ¯”èµ›èµ„è®¯/æ‰¾é˜Ÿå‹/æ‹‰ç¥¨ï¼Œæ•™åŠ¡æŸ¥è¯¢ï¼Œè¯¾ç¨‹æ¨è/æ’å/è¯„ä»·/é€‰è¯¾ï¼Œä¹¦ç±æŸ¥è¯¢/å€Ÿé˜…äºä¸€ä½“çš„ä¸€ä¸ªç»¼åˆå‹ç½‘ç«™ã€‚å½“ç„¶è¿™ä¸ªæƒ³æ³•æ¶‰åŠåˆ°çš„ä¸œè¥¿æœ‰ç‚¹å¤šï¼Œå¸å–ä¹‹å‰çš„æ•™è®­ï¼Œè¿™æ¬¡æ‰“ç®—ä¸€æ­¥ä¸€æ­¥çš„æ¥ï¼Œå‰æœŸåšåŠŸèƒ½ï¼ŒåæœŸåšä¼˜åŒ–ï¼Œåˆ†æ¨¡å—ä¸Šçº¿</p><p>ä½¿ç”¨å¾®ä¿¡å°ç¨‹åºå¼€å‘å¥½å¤„æ˜¯ä¸ç”¨è€ƒè™‘æµè§ˆå™¨çš„å…¼å®¹æ€§ä¹Ÿä¸ç”¨è€ƒè™‘å»åšä¸¤ä¸ª APPï¼Œä»¥åŠå„ç§å‹å·çš„æ‰‹æœºï¼Œä½†æ˜¯ä¸å¥½çš„åœ°æ–¹å°±æ˜¯æ‰€æœ‰çš„ç•Œé¢éƒ½åªèƒ½é è‡ªå·±å»å®ç°ï¼ŒåŸºæœ¬æ²¡æœ‰ç°æˆçš„ ui æ¡†æ¶ï¼Œæœ‰æ—¶å€™å†™çš„æœ‰ç‚¹è›‹ç–¼(PS æˆ‘æ˜¯ä¸€ä¸ªåç«¯)ã€‚ç„¶åå°±æ˜¯å®¡æ ¸ï¼Œå¾®ä¿¡çš„å®¡æ ¸ 0.1.0 ç‰ˆæœ¬ç”¨äº† 5 å¤©æ‰å®Œæˆï¼Œè¿™ä¸ªæ—¶é—´æˆ‘çš„ 0.2.0 ç‰ˆæœ¬å·²ç»åŸºæœ¬å¼€å‘å®Œæˆäº†</p><p>é¡¹ç›®å·²ç»å¼€æºï¼Œå¯ä»¥å…³æ³¨å¼€å‘è¿›åº¦æˆ–è€…æäº¤åé¦ˆæˆ–è€…æ˜¯ PRï¼Œstar å¤šå¤šç›Šå–„<br><a href="https://github.com/mohuishou/scuplus-wechat">https://github.com/mohuishou/scuplus-wechat</a></p><h2 id="æ‰«ç ä½“éªŒ"><a href="#æ‰«ç ä½“éªŒ" class="headerlink" title="æ‰«ç ä½“éªŒ"></a>æ‰«ç ä½“éªŒ</h2><p><img src="https://scuplus.oss-cn-shenzhen.aliyuncs.com/qcode.jpg" alt=""></p><h2 id="åŠŸèƒ½é¢„è§ˆ"><a href="#åŠŸèƒ½é¢„è§ˆ" class="headerlink" title="åŠŸèƒ½é¢„è§ˆ"></a>åŠŸèƒ½é¢„è§ˆ</h2><p>0.1.0 ç‰ˆæœ¬åªæ˜¯å®Œæˆäº†åŸºæœ¬çš„æ¡†æ¶ï¼Œä»¥åŠç›¸å¯¹æ¥è¯´æ¯”è¾ƒå¸¸ç”¨çš„åŠŸèƒ½ï¼š</p><ul><li>æœ€æ–°èµ„è®¯ï¼ˆé’æ˜¥å·å¤§/scuinfo/æ•™åŠ¡å¤„/å­¦å·¥éƒ¨ç­‰ï¼‰</li><li>æˆç»©/GPA æŸ¥è¯¢</li><li>è¯¾è¡¨æŸ¥è¯¢</li></ul><h2 id="å›¾ç‰‡é¢„è§ˆ"><a href="#å›¾ç‰‡é¢„è§ˆ" class="headerlink" title="å›¾ç‰‡é¢„è§ˆ"></a>å›¾ç‰‡é¢„è§ˆ</h2><p><img src="https://user-images.githubusercontent.com/15172509/34929988-07a91c84-fa02-11e7-9a67-c2399232f820.png" alt="index"><br><img src="https://user-images.githubusercontent.com/15172509/34929987-07640356-fa02-11e7-8197-6dbeb5ac1dc1.jpg" alt="grade"><br><img src="https://user-images.githubusercontent.com/15172509/34929989-07e6f7fc-fa02-11e7-9143-b7d9737b432d.png" alt="news"><br><img src="https://user-images.githubusercontent.com/15172509/34929990-08246a24-fa02-11e7-832c-fa3be2681ba9.png" alt="newslist"><br><img src="https://user-images.githubusercontent.com/15172509/34929991-085ae856-fa02-11e7-9fba-3355071ea3b5.png" alt="schedule"></p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>weå·å¤§</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ‹›é“¶ç½‘ç»œé¢è¯•æ€»ç»“</title>
    <link href="/post/1358.html"/>
    <url>/post/1358.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>ä¸‰é¢åŒæ—¶è¿›è¡Œï¼Œæ¯ä¸€é¢é—´éš”ä¸è¶…è¿‡äº”åˆ†é’Ÿï¼Œå‰é¢ä¸¤é¢æŠ€æœ¯é¢æœ€åä¸€é¢ HRï¼Œå®Œå…¨ä¸ä¼š JAVAï¼Œç»“æœä¸€ç›´é—® JAVA å¿ƒæ€çˆ†ç‚¸</p></blockquote><h2 id="ä¸€é¢-20min"><a href="#ä¸€é¢-20min" class="headerlink" title="ä¸€é¢(20min)"></a>ä¸€é¢(20min)</h2><h3 id="1-è‡ªæˆ‘ä»‹ç»"><a href="#1-è‡ªæˆ‘ä»‹ç»" class="headerlink" title="1. è‡ªæˆ‘ä»‹ç»"></a>1. è‡ªæˆ‘ä»‹ç»</h3><h3 id="2-JAVA-ç”¨è¿‡ä¹ˆï¼Ÿå‡†å¤‡å»ä»€ä¹ˆåœ°æ–¹ï¼Ÿ"><a href="#2-JAVA-ç”¨è¿‡ä¹ˆï¼Ÿå‡†å¤‡å»ä»€ä¹ˆåœ°æ–¹ï¼Ÿ" class="headerlink" title="2. JAVA ç”¨è¿‡ä¹ˆï¼Ÿå‡†å¤‡å»ä»€ä¹ˆåœ°æ–¹ï¼Ÿ"></a>2. JAVA ç”¨è¿‡ä¹ˆï¼Ÿå‡†å¤‡å»ä»€ä¹ˆåœ°æ–¹ï¼Ÿ</h3><p>ç”¨è¿‡ä¸€å¤©å†™äº†ä¸€ä¸ªå° APP</p><h3 id="3-JAVA-çš„-HashMap-æ€ä¹ˆå®ç°ï¼ŸPUT-ä¸€æ¬¡åšäº†ä»€ä¹ˆæ“ä½œ"><a href="#3-JAVA-çš„-HashMap-æ€ä¹ˆå®ç°ï¼ŸPUT-ä¸€æ¬¡åšäº†ä»€ä¹ˆæ“ä½œ" class="headerlink" title="3. JAVA çš„ HashMap æ€ä¹ˆå®ç°ï¼ŸPUT ä¸€æ¬¡åšäº†ä»€ä¹ˆæ“ä½œ"></a>3. JAVA çš„ HashMap æ€ä¹ˆå®ç°ï¼ŸPUT ä¸€æ¬¡åšäº†ä»€ä¹ˆæ“ä½œ</h3><p>ä¸ä¼š</p><h3 id="4-JAVA-çš„-GC-æ€ä¹ˆå®ç°"><a href="#4-JAVA-çš„-GC-æ€ä¹ˆå®ç°" class="headerlink" title="4. JAVA çš„ GC æ€ä¹ˆå®ç°"></a>4. JAVA çš„ GC æ€ä¹ˆå®ç°</h3><p>ä¸ä¼šï¼Œå¼ºè¡Œè¯´äº†ä¸€æ³¢ PHP çš„ GC</p><h3 id="5-Mysql-çš„é”"><a href="#5-Mysql-çš„é”" class="headerlink" title="5. Mysql çš„é”"></a>5. Mysql çš„é”</h3><p>Innodb æ”¯æŒåˆ°è¡Œçº§é”ï¼ŒMyISAM åªæ”¯æŒåˆ°è¡¨</p><h3 id="6-æ±‚ä¸€ä¸ªäºŒå‰æ ‘ä»»æ„ä¸¤èŠ‚ç‚¹çš„è·ç¦»ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ï¼Ÿ"><a href="#6-æ±‚ä¸€ä¸ªäºŒå‰æ ‘ä»»æ„ä¸¤èŠ‚ç‚¹çš„è·ç¦»ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ï¼Ÿ" class="headerlink" title="6. æ±‚ä¸€ä¸ªäºŒå‰æ ‘ä»»æ„ä¸¤èŠ‚ç‚¹çš„è·ç¦»ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ï¼Ÿ"></a>6. æ±‚ä¸€ä¸ªäºŒå‰æ ‘ä»»æ„ä¸¤èŠ‚ç‚¹çš„è·ç¦»ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ï¼Ÿ</h3><h3 id="7-è®¾è®¡æ¨¡å¼äº†è§£ä¸ï¼Ÿè£…é¥°å™¨æ¨¡å¼è§£é‡Šä¸€ä¸‹ï¼Œå†™ä¸€ä¸ª"><a href="#7-è®¾è®¡æ¨¡å¼äº†è§£ä¸ï¼Ÿè£…é¥°å™¨æ¨¡å¼è§£é‡Šä¸€ä¸‹ï¼Œå†™ä¸€ä¸ª" class="headerlink" title="7. è®¾è®¡æ¨¡å¼äº†è§£ä¸ï¼Ÿè£…é¥°å™¨æ¨¡å¼è§£é‡Šä¸€ä¸‹ï¼Œå†™ä¸€ä¸ª"></a>7. è®¾è®¡æ¨¡å¼äº†è§£ä¸ï¼Ÿè£…é¥°å™¨æ¨¡å¼è§£é‡Šä¸€ä¸‹ï¼Œå†™ä¸€ä¸ª</h3><p>è§£é‡Šäº†ä¸€ä¸‹ï¼Œæ²¡æœ‰å†™ï¼Œåé¢è®©å†™äº†ä¸€ä¸ªå·¥å‚</p><blockquote><p>è¿˜æœ‰ä¸€äº›å¿˜äº†</p></blockquote><h2 id="äºŒé¢-15min"><a href="#äºŒé¢-15min" class="headerlink" title="äºŒé¢(15min)"></a>äºŒé¢(15min)</h2><h3 id="1-è‡ªæˆ‘ä»‹ç»-1"><a href="#1-è‡ªæˆ‘ä»‹ç»-1" class="headerlink" title="1. è‡ªæˆ‘ä»‹ç»"></a>1. è‡ªæˆ‘ä»‹ç»</h3><h3 id="2-JAVA-çš„-GC-æ€ä¹ˆå®ç°ã€‚ã€‚ã€‚åˆæ¥äº†"><a href="#2-JAVA-çš„-GC-æ€ä¹ˆå®ç°ã€‚ã€‚ã€‚åˆæ¥äº†" class="headerlink" title="2. JAVA çš„ GC æ€ä¹ˆå®ç°ã€‚ã€‚ã€‚åˆæ¥äº†"></a>2. JAVA çš„ GC æ€ä¹ˆå®ç°ã€‚ã€‚ã€‚åˆæ¥äº†</h3><h3 id="3-Mysql-å»é™¤é‡å¤é¡¹"><a href="#3-Mysql-å»é™¤é‡å¤é¡¹" class="headerlink" title="3. Mysql å»é™¤é‡å¤é¡¹"></a>3. Mysql å»é™¤é‡å¤é¡¹</h3><h3 id="4-Mysql-è§¦å‘å™¨æœºåˆ¶"><a href="#4-Mysql-è§¦å‘å™¨æœºåˆ¶" class="headerlink" title="4. Mysql è§¦å‘å™¨æœºåˆ¶"></a>4. Mysql è§¦å‘å™¨æœºåˆ¶</h3><h3 id="5-è®¾è®¡ä¸€ä¸ªæ— é™æåˆ†ç±»çš„æ•°æ®åº“è¡¨"><a href="#5-è®¾è®¡ä¸€ä¸ªæ— é™æåˆ†ç±»çš„æ•°æ®åº“è¡¨" class="headerlink" title="5. è®¾è®¡ä¸€ä¸ªæ— é™æåˆ†ç±»çš„æ•°æ®åº“è¡¨"></a>5. è®¾è®¡ä¸€ä¸ªæ— é™æåˆ†ç±»çš„æ•°æ®åº“è¡¨</h3><h3 id="6-æ€ä¹ˆæŠŠå»å¤„æ¥çš„æ•°æ®æ ‘å‹ç»“æ„åŒ–"><a href="#6-æ€ä¹ˆæŠŠå»å¤„æ¥çš„æ•°æ®æ ‘å‹ç»“æ„åŒ–" class="headerlink" title="6. æ€ä¹ˆæŠŠå»å¤„æ¥çš„æ•°æ®æ ‘å‹ç»“æ„åŒ–"></a>6. æ€ä¹ˆæŠŠå»å¤„æ¥çš„æ•°æ®æ ‘å‹ç»“æ„åŒ–</h3><h2 id="ä¸‰é¢-35min"><a href="#ä¸‰é¢-35min" class="headerlink" title="ä¸‰é¢(35min)"></a>ä¸‰é¢(35min)</h2><h3 id="1-æ‹¿äº†ä¸€æ³¢ç®€å†ï¼Œæˆç»©å•ï¼Œè‡ªæˆ‘ä»‹ç»"><a href="#1-æ‹¿äº†ä¸€æ³¢ç®€å†ï¼Œæˆç»©å•ï¼Œè‡ªæˆ‘ä»‹ç»" class="headerlink" title="1. æ‹¿äº†ä¸€æ³¢ç®€å†ï¼Œæˆç»©å•ï¼Œè‡ªæˆ‘ä»‹ç»"></a>1. æ‹¿äº†ä¸€æ³¢ç®€å†ï¼Œæˆç»©å•ï¼Œè‡ªæˆ‘ä»‹ç»</h3><h3 id="2-ä¸ºä»€ä¹ˆä¸æƒ³ç•™åœ¨æˆéƒ½"><a href="#2-ä¸ºä»€ä¹ˆä¸æƒ³ç•™åœ¨æˆéƒ½" class="headerlink" title="2. ä¸ºä»€ä¹ˆä¸æƒ³ç•™åœ¨æˆéƒ½"></a>2. ä¸ºä»€ä¹ˆä¸æƒ³ç•™åœ¨æˆéƒ½</h3><h3 id="3-æˆç»©å•ä¸Šå¾ˆå¤š-60-åˆ†ï¼Œé£˜è¿‡è¿˜æ˜¯é‡ä¿®"><a href="#3-æˆç»©å•ä¸Šå¾ˆå¤š-60-åˆ†ï¼Œé£˜è¿‡è¿˜æ˜¯é‡ä¿®" class="headerlink" title="3. æˆç»©å•ä¸Šå¾ˆå¤š 60 åˆ†ï¼Œé£˜è¿‡è¿˜æ˜¯é‡ä¿®"></a>3. æˆç»©å•ä¸Šå¾ˆå¤š 60 åˆ†ï¼Œé£˜è¿‡è¿˜æ˜¯é‡ä¿®</h3><p>é£˜è¿‡</p><h3 id="4-ç°åœ¨é¢è¯•äº†å“ªäº›å…¬å¸ï¼Œæœ‰æ²¡æœ‰æ”¶åˆ°-offer-æ„å‘"><a href="#4-ç°åœ¨é¢è¯•äº†å“ªäº›å…¬å¸ï¼Œæœ‰æ²¡æœ‰æ”¶åˆ°-offer-æ„å‘" class="headerlink" title="4. ç°åœ¨é¢è¯•äº†å“ªäº›å…¬å¸ï¼Œæœ‰æ²¡æœ‰æ”¶åˆ° offer æ„å‘"></a>4. ç°åœ¨é¢è¯•äº†å“ªäº›å…¬å¸ï¼Œæœ‰æ²¡æœ‰æ”¶åˆ° offer æ„å‘</h3><h3 id="5-ç®€å•çš„ä»‹ç»äº†ä¸€ä¸ªé¡¹ç›®"><a href="#5-ç®€å•çš„ä»‹ç»äº†ä¸€ä¸ªé¡¹ç›®" class="headerlink" title="5. ç®€å•çš„ä»‹ç»äº†ä¸€ä¸ªé¡¹ç›®"></a>5. ç®€å•çš„ä»‹ç»äº†ä¸€ä¸ªé¡¹ç›®</h3><h3 id="6-ä»‹ç»äº†ç¤¾å›¢ç ”å‘éƒ¨éƒ¨é•¿å’Œå­¦é™¢å›¢å‰¯ç»å†"><a href="#6-ä»‹ç»äº†ç¤¾å›¢ç ”å‘éƒ¨éƒ¨é•¿å’Œå­¦é™¢å›¢å‰¯ç»å†" class="headerlink" title="6. ä»‹ç»äº†ç¤¾å›¢ç ”å‘éƒ¨éƒ¨é•¿å’Œå­¦é™¢å›¢å‰¯ç»å†"></a>6. ä»‹ç»äº†ç¤¾å›¢ç ”å‘éƒ¨éƒ¨é•¿å’Œå­¦é™¢å›¢å‰¯ç»å†</h3><blockquote><p>è¿˜æœ‰ä¸€äº›è®°ä¸ä½äº†</p></blockquote><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>é¢è¯•</tag>
      
      <tag>ç§‹æ‹›</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>shellæ’åº</title>
    <link href="/post/27243.html"/>
    <url>/post/27243.html</url>
    
    <content type="html"><![CDATA[<h1 id="Shell-æ’åº"><a href="#Shell-æ’åº" class="headerlink" title="Shell æ’åº"></a>Shell æ’åº</h1><h2 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h2><p>å¸Œå°”æ’åºé€šè¿‡å°†æ¯”è¾ƒçš„å…¨éƒ¨å…ƒç´ åˆ†ä¸ºå‡ ä¸ªåŒºåŸŸæ¥æå‡æ’å…¥æ’åºçš„æ€§èƒ½ã€‚è¿™æ ·å¯ä»¥è®©ä¸€ä¸ªå…ƒç´ å¯ä»¥ä¸€æ¬¡æ€§åœ°æœæœ€ç»ˆä½ç½®å‰è¿›ä¸€å¤§æ­¥ã€‚ç„¶åç®—æ³•å†å–è¶Šæ¥è¶Šå°çš„æ­¥é•¿è¿›è¡Œæ’åºï¼Œç®—æ³•çš„æœ€åä¸€æ­¥å°±æ˜¯æ™®é€šçš„æ’å…¥æ’åºï¼Œä½†æ˜¯åˆ°äº†è¿™æ­¥ï¼Œéœ€æ’åºçš„æ•°æ®å‡ ä¹æ˜¯å·²æ’å¥½çš„äº†ï¼ˆæ­¤æ—¶æ’å…¥æ’åºè¾ƒå¿«ï¼‰ã€‚</p><h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><ol><li>è®¾ç½®é—´éš”ï¼ˆä¼ ç»Ÿé—´éš”ä¸º N/2ï¼‰</li><li>æ’å…¥æ’åº</li></ol><h2 id="å›¾ç‰‡ç¤ºä¾‹"><a href="#å›¾ç‰‡ç¤ºä¾‹" class="headerlink" title="å›¾ç‰‡ç¤ºä¾‹"></a>å›¾ç‰‡ç¤ºä¾‹</h2><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-142753.gif" alt=""></p><h2 id="ç¨‹åºç¤ºä¾‹"><a href="#ç¨‹åºç¤ºä¾‹" class="headerlink" title="ç¨‹åºç¤ºä¾‹"></a>ç¨‹åºç¤ºä¾‹</h2><h3 id="ä¼ ç»Ÿå®ç°"><a href="#ä¼ ç»Ÿå®ç°" class="headerlink" title="ä¼ ç»Ÿå®ç°"></a>ä¼ ç»Ÿå®ç°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//SortInt ä¼ ç»Ÿshellæ’åº,é—´éš”ä¸ºN/2</span><br><span class="hljs-comment">//ç›¸é‚»é—´éš”å¯èƒ½ä¸äº’è´¨ï¼Œå¯èƒ½ä¼šå‡ºç°å‰ç½®æ’åºæ— ç”¨çš„æƒ…å†µ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SortInt</span><span class="hljs-params">(a []<span class="hljs-keyword">int</span>)</span> <span class="hljs-params">([]<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>)</span></span> &#123;<br>n := <span class="hljs-number">0</span><br>aLen := <span class="hljs-built_in">len</span>(a)<br><br><span class="hljs-comment">//å®šä¹‰é—´éš”</span><br><span class="hljs-keyword">for</span> i := aLen / <span class="hljs-number">2</span>; i &gt; <span class="hljs-number">0</span>; i = i / <span class="hljs-number">2</span> &#123;<br><br><span class="hljs-comment">//æ’å…¥æ’åº</span><br><span class="hljs-keyword">for</span> j := i; j &lt; aLen; j++ &#123;<br>tmp := a[j]<br>k := j<br><span class="hljs-keyword">for</span> ; k &gt;= i &amp;&amp; tmp &lt; a[k-i]; k = k - i &#123;<br>a[k] = a[k-i]<br>n++<br>&#125;<br>a[k] = tmp<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> a, n<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="Hibbard-ç®—æ³•"><a href="#Hibbard-ç®—æ³•" class="headerlink" title="Hibbard ç®—æ³•"></a>Hibbard ç®—æ³•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-comment">//SortHibbardInt Hibbardç®—æ³•ï¼Œé—´éš”ä¸º2^k-1</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SortHibbardInt</span><span class="hljs-params">(a []<span class="hljs-keyword">int</span>)</span> <span class="hljs-params">([]<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>)</span></span> &#123;<br>n, i := <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br>aLen := <span class="hljs-built_in">len</span>(a)<br><span class="hljs-keyword">for</span> i = <span class="hljs-number">1</span>; i &lt;= aLen<span class="hljs-number">-1</span>; i = i*<span class="hljs-number">2</span> + <span class="hljs-number">1</span> &#123;<br>&#125;<br><span class="hljs-comment">//å®šä¹‰é—´éš”</span><br><span class="hljs-keyword">for</span> ; i &gt; <span class="hljs-number">0</span>; i = (i - <span class="hljs-number">1</span>) / <span class="hljs-number">2</span> &#123;<br><span class="hljs-comment">// println(i)</span><br><span class="hljs-comment">//æ’å…¥æ’åº</span><br><span class="hljs-keyword">for</span> j := i; j &lt; aLen; j++ &#123;<br>tmp := a[j]<br>k := j<br><span class="hljs-keyword">for</span> ; k &gt;= i &amp;&amp; tmp &lt; a[k-i]; k = k - i &#123;<br>a[k] = a[k-i]<br>n++<br>&#125;<br>a[k] = tmp<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> a, n<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>æ’åº</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å†’æ³¡æ’åº</title>
    <link href="/post/21238.html"/>
    <url>/post/21238.html</url>
    
    <content type="html"><![CDATA[<h1 id="å†’æ³¡æ’åº"><a href="#å†’æ³¡æ’åº" class="headerlink" title="å†’æ³¡æ’åº"></a>å†’æ³¡æ’åº</h1><h2 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h2><p>å†’æ³¡æ’åºï¼ˆBubble Sortï¼‰æ˜¯ä¸€ç§ç®€å•çš„æ’åºç®—æ³•ã€‚å®ƒé‡å¤åœ°èµ°è®¿è¿‡è¦æ’åºçš„æ•°åˆ—ï¼Œä¸€æ¬¡æ¯”è¾ƒä¸¤ä¸ªå…ƒç´ ï¼Œå¦‚æœä»–ä»¬çš„é¡ºåºé”™è¯¯å°±æŠŠä»–ä»¬äº¤æ¢è¿‡æ¥ã€‚èµ°è®¿æ•°åˆ—çš„å·¥ä½œæ˜¯é‡å¤åœ°è¿›è¡Œç›´åˆ°æ²¡æœ‰å†éœ€è¦äº¤æ¢ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥æ•°åˆ—å·²ç»æ’åºå®Œæˆã€‚</p><h2 id="æ­¥éª¤ï¼š"><a href="#æ­¥éª¤ï¼š" class="headerlink" title="æ­¥éª¤ï¼š"></a>æ­¥éª¤ï¼š</h2><ol><li>æ¯”è¾ƒç›¸é‚»çš„å…ƒç´ ï¼ˆä»åå¾€å‰ï¼‰ã€‚å¦‚æœç¬¬ä¸€ä¸ªæ¯”ç¬¬äºŒä¸ªå¤§ï¼Œå°±äº¤æ¢ä»–ä»¬ä¸¤ä¸ªã€‚</li><li>å¯¹æ¯ä¸€å¯¹ç›¸é‚»å…ƒç´ ä½œåŒæ ·çš„å·¥ä½œï¼Œä»å¼€å§‹ç¬¬ä¸€å¯¹åˆ°ç»“å°¾çš„æœ€åä¸€å¯¹ã€‚åœ¨è¿™ä¸€ç‚¹ï¼Œæœ€åçš„å…ƒç´ åº”è¯¥ä¼šæ˜¯æœ€å¤§çš„æ•°ã€‚<br>(<strong>å¦‚æœè¿™ä¸€æ­¥æ²¡æœ‰å‡ºç°ä»»ä½•ä¸€æ¬¡äº¤æ¢ï¼Œé‚£ä¹ˆè¯´æ˜æ‰€æœ‰çš„å…ƒç´ å·²ç»æœ‰åºï¼Œä¸éœ€è¦å†è¿›è¡Œä¸‹é¢çš„æ­¥éª¤äº†</strong>)</li><li>é’ˆå¯¹æ‰€æœ‰çš„å…ƒç´ é‡å¤ä»¥ä¸Šçš„æ­¥éª¤ï¼Œé™¤äº†æœ€åä¸€ä¸ªã€‚</li><li>æŒç»­æ¯æ¬¡å¯¹è¶Šæ¥è¶Šå°‘çš„å…ƒç´ é‡å¤ä¸Šé¢çš„æ­¥éª¤ï¼Œç›´åˆ°æ²¡æœ‰ä»»ä½•ä¸€å¯¹æ•°å­—éœ€è¦æ¯”è¾ƒã€‚</li></ol><h2 id="å›¾ç‰‡ç¤ºä¾‹"><a href="#å›¾ç‰‡ç¤ºä¾‹" class="headerlink" title="å›¾ç‰‡ç¤ºä¾‹"></a>å›¾ç‰‡ç¤ºä¾‹</h2><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-142754.gif" alt=""></p><h2 id="ç¨‹åºç¤ºä¾‹ï¼ˆgoï¼‰"><a href="#ç¨‹åºç¤ºä¾‹ï¼ˆgoï¼‰" class="headerlink" title="ç¨‹åºç¤ºä¾‹ï¼ˆgoï¼‰"></a>ç¨‹åºç¤ºä¾‹ï¼ˆgoï¼‰</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SortInt</span><span class="hljs-params">(a []<span class="hljs-keyword">int</span>)</span> <span class="hljs-params">([]<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>)</span></span> &#123;<br><span class="hljs-comment">//äº¤æ¢æ¬¡æ•°ï¼Œè®¡æ•°</span><br>n := <span class="hljs-number">0</span><br><br>aLen := <span class="hljs-built_in">len</span>(a)<br><br><span class="hljs-keyword">for</span> i := aLen - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i-- &#123;<br><span class="hljs-comment">//æ ‡è®°ï¼Œå¦‚æœflagä¸€æ¬¡å†’æ³¡ä¹‹åæ²¡æœ‰æ”¹å˜ï¼Œé‚£ä¹ˆè¯æ˜æ’åºå·²å®Œæˆï¼Œä¸éœ€è¦å†æ¬¡æ’åºï¼Œç›´æ¥é€€å‡º</span><br>flag := <span class="hljs-number">0</span><br><br><span class="hljs-comment">//ä¸€æ¬¡å†’æ³¡</span><br><span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; i; j++ &#123;<br><span class="hljs-keyword">if</span> a[j] &gt; a[j+<span class="hljs-number">1</span>] &#123;<br><span class="hljs-comment">//äº¤æ¢ä¸¤ä¸ªå˜é‡çš„å€¼ï¼Œæ— éœ€å¼•å…¥ä¸´æ—¶å˜é‡</span><br>a[j], a[j+<span class="hljs-number">1</span>] = a[j+<span class="hljs-number">1</span>], a[j]<br><br>n++<br><br><span class="hljs-comment">//æœ‰äº¤æ¢ï¼Œflag=1</span><br>flag = <span class="hljs-number">1</span><br>&#125;<br>&#125;<br><br><span class="hljs-comment">//åˆ¤æ–­ä¸€æ¬¡å†’æ³¡ï¼Œæ˜¯å¦å­˜åœ¨äº¤æ¢</span><br><span class="hljs-keyword">if</span> flag == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br><br>&#125;<br><br><span class="hljs-keyword">return</span> a, n<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>æ’åº</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å †æ’åº</title>
    <link href="/post/46698.html"/>
    <url>/post/46698.html</url>
    
    <content type="html"><![CDATA[<h2 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h2><p>å †ç§¯æ’åºï¼š æ˜¯æŒ‡åˆ©ç”¨å †è¿™ç§æ•°æ®ç»“æ„æ‰€è®¾è®¡çš„ä¸€ç§æ’åºç®—æ³•ã€‚å †æ˜¯ä¸€ä¸ªè¿‘ä¼¼å®Œå…¨äºŒå‰æ ‘çš„ç»“æ„ï¼Œå¹¶åŒæ—¶æ»¡è¶³å †æ€§è´¨ï¼šå³å­ç»“ç‚¹çš„é”®å€¼æˆ–ç´¢å¼•æ€»æ˜¯å°äºï¼ˆæˆ–è€…å¤§äºï¼‰å®ƒçš„çˆ¶èŠ‚ç‚¹ã€‚</p><h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><ul><li>å»ºå †ï¼Œå»ºå †æ˜¯ä¸æ–­è°ƒæ•´å †çš„è¿‡ç¨‹ï¼Œä» len/2 å¤„å¼€å§‹è°ƒæ•´ï¼Œä¸€ç›´åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ­¤å¤„ len æ˜¯å †ä¸­å…ƒç´ çš„ä¸ªæ•°ã€‚å»ºå †çš„è¿‡ç¨‹æ˜¯çº¿æ€§çš„è¿‡ç¨‹ï¼Œä» len/2 åˆ° 0 å¤„ä¸€ç›´è°ƒç”¨è°ƒæ•´å †çš„è¿‡ç¨‹ï¼Œç›¸å½“äº o(h1)+o(h2)â€¦+o(hlen/2) å…¶ä¸­ h è¡¨ç¤ºèŠ‚ç‚¹çš„æ·±åº¦ï¼Œlen/2 è¡¨ç¤ºèŠ‚ç‚¹çš„ä¸ªæ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ±‚å’Œçš„è¿‡ç¨‹ï¼Œç»“æœæ˜¯çº¿æ€§çš„ O(n)ã€‚</li><li>è°ƒæ•´å †ï¼šè°ƒæ•´å †åœ¨æ„å»ºå †çš„è¿‡ç¨‹ä¸­ä¼šç”¨åˆ°ï¼Œè€Œä¸”åœ¨å †æ’åºè¿‡ç¨‹ä¸­ä¹Ÿä¼šç”¨åˆ°ã€‚åˆ©ç”¨çš„æ€æƒ³æ˜¯æ¯”è¾ƒèŠ‚ç‚¹ i å’Œå®ƒçš„å­©å­èŠ‚ç‚¹ left(i),right(i)ï¼Œé€‰å‡ºä¸‰è€…æœ€å¤§(æˆ–è€…æœ€å°)è€…ï¼Œå¦‚æœæœ€å¤§ï¼ˆå°ï¼‰å€¼ä¸æ˜¯èŠ‚ç‚¹ i è€Œæ˜¯å®ƒçš„ä¸€ä¸ªå­©å­èŠ‚ç‚¹ï¼Œé‚£è¾¹äº¤äº’èŠ‚ç‚¹ i å’Œè¯¥èŠ‚ç‚¹ï¼Œç„¶åå†è°ƒç”¨è°ƒæ•´å †è¿‡ç¨‹ï¼Œè¿™æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ã€‚è°ƒæ•´å †çš„è¿‡ç¨‹æ—¶é—´å¤æ‚åº¦ä¸å †çš„æ·±åº¦æœ‰å…³ç³»ï¼Œæ˜¯ lgn çš„æ“ä½œï¼Œå› ä¸ºæ˜¯æ²¿ç€æ·±åº¦æ–¹å‘è¿›è¡Œè°ƒæ•´çš„ã€‚</li><li>å †æ’åºï¼šå †æ’åºæ˜¯åˆ©ç”¨ä¸Šé¢çš„ä¸¤ä¸ªè¿‡ç¨‹æ¥è¿›è¡Œçš„ã€‚é¦–å…ˆæ˜¯æ ¹æ®å…ƒç´ æ„å»ºå †ã€‚ç„¶åå°†å †çš„æ ¹èŠ‚ç‚¹å–å‡º(ä¸€èˆ¬æ˜¯ä¸æœ€åä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œäº¤æ¢)ï¼Œå°†å‰é¢ len-1 ä¸ªèŠ‚ç‚¹ç»§ç»­è¿›è¡Œå †è°ƒæ•´çš„è¿‡ç¨‹ï¼Œç„¶åå†å°†æ ¹èŠ‚ç‚¹å–å‡ºï¼Œè¿™æ ·ä¸€ç›´åˆ°æ‰€æœ‰èŠ‚ç‚¹éƒ½å–å‡ºã€‚å †æ’åºè¿‡ç¨‹çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(nlgn)ã€‚å› ä¸ºå»ºå †çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ï¼ˆè°ƒç”¨ä¸€æ¬¡ï¼‰ï¼›è°ƒæ•´å †çš„æ—¶é—´å¤æ‚åº¦æ˜¯ lgnï¼Œè°ƒç”¨äº† n-1 æ¬¡ï¼Œæ‰€ä»¥å †æ’åºçš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(nlgn)[2]</li></ul><p><em>æ³¨æ„: æ ¹èŠ‚ç‚¹åœ¨æ•°ç»„å½“ä¸­å­˜æ”¾çš„ä½ç½®æ˜¯ 0ï¼Œæ‰€ä»¥ç¬¬ i ä¸ªèŠ‚ç‚¹çš„å·¦å­©å­æ˜¯ 2i+1,å³å­©å­æ˜¯ 2i+2</em></p><h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141622.gif" alt="ç¤ºä¾‹å›¾ç‰‡"></p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> HeapSort<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-comment">//HeapSort å †æ’åº</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HeapSort</span><span class="hljs-params">(arr []<span class="hljs-keyword">int</span>)</span></span> &#123;<br>LEN := <span class="hljs-built_in">len</span>(arr)<br><span class="hljs-keyword">for</span> i := LEN/<span class="hljs-number">2</span> - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i-- &#123;<br>HeapAjust(arr, i, LEN)<br>&#125;<br><br><span class="hljs-keyword">for</span> i := LEN - <span class="hljs-number">1</span>; i &gt; <span class="hljs-number">0</span>; i-- &#123;<br>arr[i], arr[<span class="hljs-number">0</span>] = arr[<span class="hljs-number">0</span>], arr[i]<br>HeapAjust(arr, <span class="hljs-number">0</span>, i)<br>&#125;<br>&#125;<br><br><span class="hljs-comment">//HeapAjust å †è°ƒæ•´</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HeapAjust</span><span class="hljs-params">(arr []<span class="hljs-keyword">int</span>, start <span class="hljs-keyword">int</span>, length <span class="hljs-keyword">int</span>)</span></span> &#123;<br>tmp := arr[start]<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">2</span>*start + <span class="hljs-number">1</span>; i &lt; length; i = i * <span class="hljs-number">2</span> &#123;<br><span class="hljs-keyword">if</span> i+<span class="hljs-number">1</span> &lt; length &amp;&amp; arr[i] &lt; arr[i+<span class="hljs-number">1</span>] &#123;<br>i++<br>&#125;<br><span class="hljs-keyword">if</span> tmp &gt; arr[i] &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>arr[start] = arr[i]<br>start = i<br>&#125;<br>arr[start] = tmp<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>æ’åº</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å½’å¹¶æ’åº</title>
    <link href="/post/63711.html"/>
    <url>/post/63711.html</url>
    
    <content type="html"><![CDATA[<h2 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h2><p>å½’å¹¶æ’åº:æ˜¯å»ºç«‹åœ¨å½’å¹¶æ“ä½œä¸Šçš„ä¸€ç§æœ‰æ•ˆçš„æ’åºç®—æ³•ã€‚è¯¥ç®—æ³•æ˜¯é‡‡ç”¨åˆ†æ²»æ³•ï¼ˆDivide and Conquerï¼‰çš„ä¸€ä¸ªéå¸¸å…¸å‹çš„åº”ç”¨</p><h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><ul><li>ç”³è¯·ç©ºé—´ï¼Œä½¿å…¶å¤§å°ä¸ºä¸¤ä¸ªå·²ç»æ’åºåºåˆ—ä¹‹å’Œï¼Œè¯¥ç©ºé—´ç”¨æ¥å­˜æ”¾åˆå¹¶åçš„åºåˆ—</li><li>è®¾å®šä¸¤ä¸ªæŒ‡é’ˆï¼Œæœ€åˆä½ç½®åˆ†åˆ«ä¸ºä¸¤ä¸ªå·²ç»æ’åºåºåˆ—çš„èµ·å§‹ä½ç½®</li><li>æ¯”è¾ƒä¸¤ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„å…ƒç´ ï¼Œé€‰æ‹©ç›¸å¯¹å°çš„å…ƒç´ æ”¾å…¥åˆ°åˆå¹¶ç©ºé—´ï¼Œå¹¶ç§»åŠ¨æŒ‡é’ˆåˆ°ä¸‹ä¸€ä½ç½®</li><li>é‡å¤æ­¥éª¤ 3 ç›´åˆ°æŸä¸€æŒ‡é’ˆè¾¾åˆ°åºåˆ—å°¾</li><li>å°†å¦ä¸€åºåˆ—å‰©ä¸‹çš„æ‰€æœ‰å…ƒç´ ç›´æ¥å¤åˆ¶åˆ°åˆå¹¶åºåˆ—å°¾</li></ul><h2 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h2><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141633.gif" alt="ç¤ºä¾‹å›¾ç‰‡"></p><h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> merge<br><br><span class="hljs-comment">//INFINITY ä¸€ä¸ªæ¯”è¾ƒå¤§çš„å€¼ç”¨ä½œå“¨å…µ</span><br><span class="hljs-keyword">const</span> INFINITY = <span class="hljs-number">0xffff</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">merge</span><span class="hljs-params">(arr []<span class="hljs-keyword">int</span>, start, end <span class="hljs-keyword">int</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> start &lt; end &#123;<br><span class="hljs-comment">//ä»ä¸­é—´åˆ’åˆ†ï¼Œåˆ†åˆ«å·¦å³ä¸¤è¾¹æ’åº</span><br>mid := (end + start) / <span class="hljs-number">2</span><br>merge(arr, start, mid)<br>merge(arr, mid+<span class="hljs-number">1</span>, end)<br><br><span class="hljs-comment">//ä¸‹é¢è¿›è¡Œå½’å¹¶æ“ä½œï¼Œå°†ä¸¤ä¸ªé•¿åº¦è¾ƒå°ä½†æ˜¯å·²ç»æ’åºå®Œæˆçš„æ•°ç»„åˆå¹¶æˆä¸€ä¸ªè¾ƒé•¿é•¿åº¦çš„æ’åºæ•°ç»„</span><br><br><span class="hljs-comment">//æ–°å»ºä¸€ä¸ªæ•°ç»„ç”¨äºå­˜æ”¾å·¦è¾¹çš„å€¼</span><br>arr1 := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, mid-start+<span class="hljs-number">2</span>)<br><span class="hljs-built_in">copy</span>(arr1, arr[start:mid+<span class="hljs-number">1</span>])<br>arr1[mid-start+<span class="hljs-number">1</span>] = INFINITY<br><br><span class="hljs-comment">//æ–°å»ºä¸€ä¸ªæ•°ç»„ç”¨äºå­˜æ”¾å³è¾¹çš„å€¼</span><br>arr2 := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, end-mid+<span class="hljs-number">1</span>)<br><span class="hljs-built_in">copy</span>(arr2, arr[mid+<span class="hljs-number">1</span>:end+<span class="hljs-number">1</span>])<br>arr2[end-mid] = INFINITY<br><br><span class="hljs-comment">//æ¯”è¾ƒå¤§å°</span><br>j, k := <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i := start; i &lt;= end; i++ &#123;<br><span class="hljs-keyword">if</span> arr1[j] &lt;= arr2[k] &#123;<br>arr[i] = arr1[j]<br>j++<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>arr[i] = arr2[k]<br>k++<br>&#125;<br>&#125;<br><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>æ’åº</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¿«é€Ÿæ’åº</title>
    <link href="/post/11306.html"/>
    <url>/post/11306.html</url>
    
    <content type="html"><![CDATA[<blockquote><p><a href="https://github.com/mohuishou/go-sort">https://github.com/mohuishou/go-sort</a></p></blockquote><h2 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h2><p>å¿«é€Ÿæ’åºæ˜¯ç”±ä¸œå°¼Â·éœå°”æ‰€å‘å±•çš„ä¸€ç§æ’åºç®—æ³•ã€‚åœ¨å¹³å‡çŠ¶å†µä¸‹ï¼Œæ’åº n ä¸ªé¡¹ç›®è¦ ÎŸ(n log n)æ¬¡æ¯”è¾ƒã€‚åœ¨æœ€åçŠ¶å†µä¸‹åˆ™éœ€è¦ ÎŸ(n2)æ¬¡æ¯”è¾ƒï¼Œä½†è¿™ç§çŠ¶å†µå¹¶ä¸å¸¸è§ã€‚äº‹å®ä¸Šï¼Œå¿«é€Ÿæ’åºé€šå¸¸æ˜æ˜¾æ¯”å…¶ä»– ÎŸ(n log n) ç®—æ³•æ›´å¿«ï¼Œå› ä¸ºå®ƒçš„å†…éƒ¨å¾ªç¯ï¼ˆinner loopï¼‰å¯ä»¥åœ¨å¤§éƒ¨åˆ†çš„æ¶æ„ä¸Šå¾ˆæœ‰æ•ˆç‡åœ°è¢«å®ç°å‡ºæ¥ï¼Œä¸”åœ¨å¤§éƒ¨åˆ†çœŸå®ä¸–ç•Œçš„æ•°æ®ï¼Œå¯ä»¥å†³å®šè®¾è®¡çš„é€‰æ‹©ï¼Œå‡å°‘æ‰€éœ€æ—¶é—´çš„äºŒæ¬¡æ–¹é¡¹ä¹‹å¯èƒ½æ€§ã€‚</p><h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><ul><li>ä»æ•°åˆ—ä¸­æŒ‘å‡ºä¸€ä¸ªå…ƒç´ ï¼Œç§°ä¸º â€œåŸºå‡†â€ï¼ˆpivotï¼‰ï¼Œ</li><li>é‡æ–°æ’åºæ•°åˆ—ï¼Œæ‰€æœ‰å…ƒç´ æ¯”åŸºå‡†å€¼å°çš„æ‘†æ”¾åœ¨åŸºå‡†å‰é¢ï¼Œæ‰€æœ‰å…ƒç´ æ¯”åŸºå‡†å€¼å¤§çš„æ‘†åœ¨åŸºå‡†çš„åé¢ï¼ˆç›¸åŒçš„æ•°å¯ä»¥åˆ°ä»»ä¸€è¾¹ï¼‰ã€‚åœ¨è¿™ä¸ªåˆ†åŒºé€€å‡ºä¹‹åï¼Œè¯¥åŸºå‡†å°±å¤„äºæ•°åˆ—çš„ä¸­é—´ä½ç½®ã€‚è¿™ä¸ªç§°ä¸ºåˆ†åŒºï¼ˆpartitionï¼‰æ“ä½œã€‚</li><li>é€’å½’åœ°ï¼ˆrecursiveï¼‰æŠŠå°äºåŸºå‡†å€¼å…ƒç´ çš„å­æ•°åˆ—å’Œå¤§äºåŸºå‡†å€¼å…ƒç´ çš„å­æ•°åˆ—æ’åºã€‚</li></ul><p><em>æ³¨æ„: åŸºå‡†ç‚¹é‡‡ç”¨ä¸‰å…ƒç´ åŸåˆ™æ³•ï¼Œä¸‰å…ƒç´ é€‰æ‹©ä¹‹åä¸€å¤´ä¸€å°¾å°±å·²ç»æœ‰åºäº†</em></p><h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141632.gif" alt="ç¤ºä¾‹å›¾ç‰‡"></p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> quik<br><br><span class="hljs-comment">//Sort å¿«é€Ÿæ’åº</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Sort</span><span class="hljs-params">(arr []<span class="hljs-keyword">int</span>)</span></span> &#123;<br>Quik(arr, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(arr)<span class="hljs-number">-1</span>)<br>&#125;<br><br><span class="hljs-comment">//Quik å¿«é€Ÿæ’åºé€’å½’å®ç°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Quik</span><span class="hljs-params">(arr []<span class="hljs-keyword">int</span>, left <span class="hljs-keyword">int</span>, right <span class="hljs-keyword">int</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> right-left &lt; <span class="hljs-number">2</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>p := middle3(arr, left, right)<br><br>i := left + <span class="hljs-number">1</span><br>j := right - <span class="hljs-number">2</span><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">for</span> arr[i] &lt; p &#123;<br>i++<br>&#125;<br><span class="hljs-keyword">for</span> arr[j] &gt; p &#123;<br>j--<br>&#125;<br><span class="hljs-keyword">if</span> i &lt; j &#123;<br>arr[i], arr[j] = arr[j], arr[i]<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br>arr[i], arr[right<span class="hljs-number">-1</span>] = arr[right<span class="hljs-number">-1</span>], arr[i]<br>Quik(arr, left, i<span class="hljs-number">-1</span>)<br>Quik(arr, i+<span class="hljs-number">1</span>, right)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">middle3</span><span class="hljs-params">(arr []<span class="hljs-keyword">int</span>, left <span class="hljs-keyword">int</span>, right <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;<br>center := (right + left) / <span class="hljs-number">2</span><br><span class="hljs-keyword">if</span> arr[left] &gt; arr[center] &#123;<br>arr[left], arr[center] = arr[center], arr[left]<br>&#125;<br><span class="hljs-keyword">if</span> arr[left] &gt; arr[right] &#123;<br>arr[left], arr[right] = arr[right], arr[left]<br>&#125;<br><span class="hljs-keyword">if</span> arr[center] &gt; arr[right] &#123;<br>arr[center], arr[right] = arr[right], arr[center]<br>&#125;<br>arr[center], arr[right<span class="hljs-number">-1</span>] = arr[right<span class="hljs-number">-1</span>], arr[center]<br><span class="hljs-keyword">return</span> arr[right<span class="hljs-number">-1</span>]<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>æ’åº</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ’å…¥æ’åº</title>
    <link href="/post/50190.html"/>
    <url>/post/50190.html</url>
    
    <content type="html"><![CDATA[<h1 id="æ’å…¥æ’åº"><a href="#æ’å…¥æ’åº" class="headerlink" title="æ’å…¥æ’åº"></a>æ’å…¥æ’åº</h1><h2 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h2><p>æ’å…¥æ’åºçš„å·¥ä½œåŸç†æ˜¯é€šè¿‡æ„å»ºæœ‰åºåºåˆ—ï¼Œå¯¹äºæœªæ’åºæ•°æ®ï¼Œåœ¨å·²æ’åºåºåˆ—ä¸­ä»åå‘å‰æ‰«æï¼Œæ‰¾åˆ°ç›¸åº”ä½ç½®å¹¶æ’å…¥ã€‚</p><h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><ol><li>ä»ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹ï¼Œè¯¥å…ƒç´ å¯ä»¥è®¤ä¸ºå·²ç»è¢«æ’åº</li><li>å–å‡ºä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œåœ¨å·²ç»æ’åºçš„å…ƒç´ åºåˆ—ä¸­ä»åå‘å‰æ‰«æ</li><li>å¦‚æœè¯¥å…ƒç´ ï¼ˆå·²æ’åºï¼‰å¤§äºæ–°å…ƒç´ ï¼Œå°†è¯¥å…ƒç´ ç§»åˆ°ä¸‹ä¸€ä½ç½®</li><li>é‡å¤æ­¥éª¤ 3ï¼Œç›´åˆ°æ‰¾åˆ°å·²æ’åºçš„å…ƒç´ å°äºæˆ–è€…ç­‰äºæ–°å…ƒç´ çš„ä½ç½®</li><li>å°†æ–°å…ƒç´ æ’å…¥åˆ°è¯¥ä½ç½®å</li><li>é‡å¤æ­¥éª¤ 2~5</li></ol><h2 id="å›¾ç‰‡ç¤ºä¾‹"><a href="#å›¾ç‰‡ç¤ºä¾‹" class="headerlink" title="å›¾ç‰‡ç¤ºä¾‹"></a>å›¾ç‰‡ç¤ºä¾‹</h2><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141645.gif" alt=""></p><h2 id="ç¨‹åºç¤ºä¾‹ï¼ˆgoï¼‰"><a href="#ç¨‹åºç¤ºä¾‹ï¼ˆgoï¼‰" class="headerlink" title="ç¨‹åºç¤ºä¾‹ï¼ˆgoï¼‰"></a>ç¨‹åºç¤ºä¾‹ï¼ˆgoï¼‰</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//SortInt æ’å…¥æ’åº</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SortInt</span><span class="hljs-params">(a []<span class="hljs-keyword">int</span>)</span> <span class="hljs-params">([]<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>)</span></span> &#123;<br>n := <span class="hljs-number">0</span><br>aLen := <span class="hljs-built_in">len</span>(a)<br><br><span class="hljs-comment">//ä»i=1å¼€å§‹ï¼Œç¬¬ä¸€ä¸ªæ•°ä¸ç”¨æ’åºï¼Œä¸€ä¸ªæ•°ç›¸å½“äºå·²ç»æœ‰åºäº†</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; aLen; i++ &#123;<br><span class="hljs-comment">//å–å‡ºæ–°æ•°ï¼ˆç±»ä¼¼æ‘¸ç‰Œï¼‰</span><br>tmp := a[i]<br><br><span class="hljs-comment">//å°†æ–°æ•°å’Œä¹‹å‰çš„æ•°ä»åå¾€å‰ï¼ˆä»å¤§åˆ°å°ï¼‰ä¸€æ¬¡æ¯”è¾ƒï¼Œå¦‚æœæ–°æ•°æ›´å°,å°±å°†ä»¥å‰çš„æ•°å¾€åç§»ä¸€ä½</span><br>j := i<br><span class="hljs-keyword">for</span> ; (j &gt; <span class="hljs-number">0</span>) &amp;&amp; (tmp &lt; a[j<span class="hljs-number">-1</span>]); j-- &#123;<br>n++<br>a[j] = a[j<span class="hljs-number">-1</span>] <span class="hljs-comment">//åç§»ä¸€ä½</span><br>&#125;<br><span class="hljs-comment">//æ–°æ•°æ’å…¥</span><br>a[j] = tmp<br><br>&#125;<br><span class="hljs-keyword">return</span> a, n<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>æ’åº</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é€‰æ‹©æ’åº</title>
    <link href="/post/51203.html"/>
    <url>/post/51203.html</url>
    
    <content type="html"><![CDATA[<blockquote><p><a href="https://github.com/mohuishou/go-sort">https://github.com/mohuishou/go-sort</a></p></blockquote><h2 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h2><p>é€‰æ‹©æ’åº(Selection sort)æ˜¯ä¸€ç§ç®€å•ç›´è§‚çš„æ’åºç®—æ³•ã€‚å®ƒçš„å·¥ä½œåŸç†å¦‚ä¸‹ã€‚é¦–å…ˆåœ¨æœªæ’åºåºåˆ—ä¸­æ‰¾åˆ°æœ€å°å…ƒç´ ï¼Œå­˜æ”¾åˆ°æ’åºåºåˆ—çš„èµ·å§‹ä½ç½®ï¼Œç„¶åï¼Œå†ä»å‰©ä½™æœªæ’åºå…ƒç´ ä¸­ç»§ç»­å¯»æ‰¾æœ€å°å…ƒç´ ï¼Œç„¶åæ”¾åˆ°æ’åºåºåˆ—æœ«å°¾ã€‚ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°æ‰€æœ‰å…ƒç´ å‡æ’åºå®Œæ¯•ã€‚</p><h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141643.gif" alt="ç¤ºä¾‹å›¾ç‰‡"></p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> selection<br><br><span class="hljs-comment">//Sort é€‰æ‹©æ’åº</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Sort</span><span class="hljs-params">(arr []<span class="hljs-keyword">int</span>)</span></span> &#123;<br><span class="hljs-keyword">var</span> LEN = <span class="hljs-built_in">len</span>(arr)<br>minIndex := <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; LEN; i++ &#123;<br>minIndex = i<br><span class="hljs-keyword">for</span> j := i; j &lt; LEN; j++ &#123;<br><span class="hljs-keyword">if</span> arr[minIndex] &gt; arr[j] &#123;<br>minIndex = j<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> minIndex != i &#123;<br>arr[minIndex], arr[i] = arr[i], arr[minIndex]<br>&#125;<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>æ’åº</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç™¾åº¦é¢è¯•æ€»ç»“</title>
    <link href="/post/56757.html"/>
    <url>/post/56757.html</url>
    
    <content type="html"><![CDATA[<h2 id="ä¸€é¢-40min"><a href="#ä¸€é¢-40min" class="headerlink" title="ä¸€é¢(40min)"></a>ä¸€é¢(40min)</h2><h3 id="0-è‡ªæˆ‘ä»‹ç»"><a href="#0-è‡ªæˆ‘ä»‹ç»" class="headerlink" title="0. è‡ªæˆ‘ä»‹ç»"></a>0. è‡ªæˆ‘ä»‹ç»</h3><h3 id="1-ä»‹ç»-ImageOCR-çš„é¡¹ç›®"><a href="#1-ä»‹ç»-ImageOCR-çš„é¡¹ç›®" class="headerlink" title="1. ä»‹ç» ImageOCR çš„é¡¹ç›®"></a>1. ä»‹ç» ImageOCR çš„é¡¹ç›®</h3><h3 id="2-çŸ¥é“æœ‰å“ªäº›æ’åºç®—æ³•ï¼Ÿ"><a href="#2-çŸ¥é“æœ‰å“ªäº›æ’åºç®—æ³•ï¼Ÿ" class="headerlink" title="2. çŸ¥é“æœ‰å“ªäº›æ’åºç®—æ³•ï¼Ÿ"></a>2. çŸ¥é“æœ‰å“ªäº›æ’åºç®—æ³•ï¼Ÿ</h3><p>å†’æ³¡ã€æ’å…¥ã€shellã€å½’å¹¶ã€å¿«æ’ã€å †æ’åºã€é€‰æ‹©æ’åºç­‰ç­‰</p><blockquote><p>æœ‰æ²¡æœ‰ä¸ä¼šå†™çš„ï¼Œæ’é›·æ’æ‰äº†å †æ’åº</p></blockquote><h3 id="3-æ‰‹å†™æ’å…¥æ’åºå¹¶è§£é‡Š"><a href="#3-æ‰‹å†™æ’å…¥æ’åºå¹¶è§£é‡Š" class="headerlink" title="3. æ‰‹å†™æ’å…¥æ’åºå¹¶è§£é‡Š"></a>3. æ‰‹å†™æ’å…¥æ’åºå¹¶è§£é‡Š</h3><h3 id="4-ä¸Šé¢çš„æ’åºç®—æ³•å“ªäº›æ˜¯ç¨³å®šçš„ï¼Œå“ªäº›æ˜¯ä¸ç¨³å®šçš„"><a href="#4-ä¸Šé¢çš„æ’åºç®—æ³•å“ªäº›æ˜¯ç¨³å®šçš„ï¼Œå“ªäº›æ˜¯ä¸ç¨³å®šçš„" class="headerlink" title="4. ä¸Šé¢çš„æ’åºç®—æ³•å“ªäº›æ˜¯ç¨³å®šçš„ï¼Œå“ªäº›æ˜¯ä¸ç¨³å®šçš„"></a>4. ä¸Šé¢çš„æ’åºç®—æ³•å“ªäº›æ˜¯ç¨³å®šçš„ï¼Œå“ªäº›æ˜¯ä¸ç¨³å®šçš„</h3><h3 id="è¿˜æœ‰ä¸€äº›å¿˜äº†"><a href="#è¿˜æœ‰ä¸€äº›å¿˜äº†" class="headerlink" title="è¿˜æœ‰ä¸€äº›å¿˜äº†"></a>è¿˜æœ‰ä¸€äº›å¿˜äº†</h3><h2 id="äºŒé¢-1-2h"><a href="#äºŒé¢-1-2h" class="headerlink" title="äºŒé¢(1.2h)"></a>äºŒé¢(1.2h)</h2><h3 id="0-ä»‹ç»ç®€å†ä¸Šçš„å¦å¤–ä¸€ä¸ªé¡¹ç›®"><a href="#0-ä»‹ç»ç®€å†ä¸Šçš„å¦å¤–ä¸€ä¸ªé¡¹ç›®" class="headerlink" title="0. ä»‹ç»ç®€å†ä¸Šçš„å¦å¤–ä¸€ä¸ªé¡¹ç›®"></a>0. ä»‹ç»ç®€å†ä¸Šçš„å¦å¤–ä¸€ä¸ªé¡¹ç›®</h3><h3 id="1-PHP-çš„åŸºæœ¬æ•°æ®ç±»å‹ä»¥åŠåŸºæœ¬æ•°æ®ç±»å‹å†…æ ¸å¦‚ä½•å®ç°"><a href="#1-PHP-çš„åŸºæœ¬æ•°æ®ç±»å‹ä»¥åŠåŸºæœ¬æ•°æ®ç±»å‹å†…æ ¸å¦‚ä½•å®ç°" class="headerlink" title="1. PHP çš„åŸºæœ¬æ•°æ®ç±»å‹ä»¥åŠåŸºæœ¬æ•°æ®ç±»å‹å†…æ ¸å¦‚ä½•å®ç°?"></a>1. PHP çš„åŸºæœ¬æ•°æ®ç±»å‹ä»¥åŠåŸºæœ¬æ•°æ®ç±»å‹å†…æ ¸å¦‚ä½•å®ç°?</h3><p><strong>åŸºæœ¬æ•°æ®ç±»å‹</strong></p><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs zephir"><span class="hljs-keyword">boolean</span>(å¸ƒå°”å‹)å¸ƒå°”å‹æ˜¯æœ€ç®€å•çš„æ•°æ®ç±»å‹ï¼Œåªæœ‰ä¸¤ä¸ªå€¼ <span class="hljs-keyword">false</span>(å‡) å’Œ<span class="hljs-keyword">true</span>(çœŸ)<br><span class="hljs-keyword">string</span>(å­—ç¬¦ä¸²å‹)å­—ç¬¦ä¸²å°±æ˜¯è¿ç»­çš„å­—ç¬¦åºåˆ—ï¼Œå¦‚ ehco <span class="hljs-string">&quot;string&quot;</span>;<br><span class="hljs-keyword">integer</span>(æ•´å‹)    æ•´å‹æ•°æ®ç±»å‹åªèƒ½åŒ…å«æ•´æ•°ï¼Œè¿™äº›æ•°æ®ç±»å‹å¯ä»¥æ˜¯è´Ÿæ•°æˆ–è€…æ­£æ•°<br>folat(æµ®ç‚¹å‹)æµ®ç‚¹å‹ç±»å‹ç”¨äºå­˜å‚¨æ•°å­—ï¼Œå’Œæ•´å‹ä¸åŒçš„æ˜¯æµ®ç‚¹å‹å¯ä»¥æœ‰å°æ•°ç‚¹<br><span class="hljs-keyword">array</span>ï¼ˆæ•°ç»„ï¼‰ä¸€ç»„ç›¸åŒç±»å‹çš„é›†åˆ<br><span class="hljs-keyword">object</span>ï¼ˆå¯¹è±¡ï¼‰å¯¹è±¡æ˜¯ä¸€ä¸ªå®åŠ›ï¼Œä½¿ç”¨<span class="hljs-keyword">new</span>å‘½ä»¤åˆ›å»ºä¸€ä¸ªå¯¹è±¡<br><span class="hljs-keyword">resource</span>ï¼ˆèµ„æºï¼‰èµ„æºæ˜¯ä¸€ç§ç‰¹æ®Šçš„å˜é‡ï¼Œä¿å­˜åœ¨å¤–éƒ¨èµ„æºçš„ä¸€ä¸ªåº”ç”¨ï¼Œèµ„æºæ˜¯é€šè¿‡å‡½æ•°æ¥è¿›è¡Œå»ºç«‹çš„<br><span class="hljs-keyword">null</span>ï¼ˆ ç©ºç™½ï¼‰ç‰¹æ®Šçš„å€¼ï¼Œè¡¨ç¤ºå˜é‡æ²¡æœ‰å€¼ï¼Œä»»ä½•å˜é‡çš„åˆå§‹å€¼éƒ½æ˜¯<span class="hljs-keyword">null</span><br></code></pre></td></tr></table></figure><p><strong>å˜é‡çš„åœ¨å†…æ ¸å½“ä¸­çš„ä¿å­˜æ–¹å¼ï¼š</strong></p><ul><li>php5.3: <a href="http://blog.csdn.net/qq_28602957/article/details/52959132">http://blog.csdn.net/qq_28602957/article/details/52959132</a></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">union</span> _<span class="hljs-title">zvalue_value</span> &#123;</span><br>    <span class="hljs-keyword">long</span> lval;                  <span class="hljs-comment">/* long value */</span><br>    <span class="hljs-keyword">double</span> dval;                <span class="hljs-comment">/* double value */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>        <span class="hljs-keyword">char</span> *val;<br>        <span class="hljs-keyword">int</span> len;<br>    &#125; str;<br>    HashTable *ht;              <span class="hljs-comment">/* hash table value */</span><br>    zend_object_value obj;<br>    zend_ast *ast;<br>&#125; zvalue_value;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">zval_struct</span> &#123;</span><br>    <span class="hljs-comment">/* Variable information */</span><br>    zvalue_value value;     <span class="hljs-comment">/* value */</span><br>    zend_uint refcount__gc;<br>    zend_uchar type;    <span class="hljs-comment">/* active type */</span><br>    zend_uchar is_ref__gc;<br>&#125;;<br></code></pre></td></tr></table></figure><table><thead><tr><th style="text-align:center">PHP è¯­è¨€å±‚ç±»å‹</th><th style="text-align:center">å­˜åœ¨ zvalue_value çš„æˆå‘˜å˜é‡</th></tr></thead><tbody><tr><td style="text-align:center">long,bool,resoure</td><td style="text-align:center">lval</td></tr><tr><td style="text-align:center">double</td><td style="text-align:center">dval</td></tr><tr><td style="text-align:center">string</td><td style="text-align:center">str(len ä¿å­˜å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œval ä¿å­˜å­—ç¬¦ä¸²çš„å€¼)</td></tr><tr><td style="text-align:center">array</td><td style="text-align:center">htï¼ˆå“ˆå¸Œè¡¨ï¼‰</td></tr><tr><td style="text-align:center">object</td><td style="text-align:center">obj</td></tr></tbody></table><ul><li>php7: <a href="https://yq.aliyun.com/articles/27359">https://yq.aliyun.com/articles/27359</a></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//å­˜å‚¨å˜é‡çš„ç»“æ„</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">zval_struct</span> &#123;</span><br>    zend_value        value;            <span class="hljs-comment">/* value */</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>            ZEND_ENDIAN_LOHI_4(<br>                zend_uchar    type,         <span class="hljs-comment">/* active type */</span><br>                zend_uchar    type_flags,<br>                zend_uchar    const_flags,<br>                zend_uchar    reserved)     <span class="hljs-comment">/* call info for EX(This) */</span><br>        &#125; v;<br>        <span class="hljs-keyword">uint32_t</span> type_info;<br>    &#125; u1;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        <span class="hljs-keyword">uint32_t</span>     var_flags;<br>        <span class="hljs-keyword">uint32_t</span>     next;                 <span class="hljs-comment">/* hash collision chain */</span><br>        <span class="hljs-keyword">uint32_t</span>     cache_slot;           <span class="hljs-comment">/* literal cache slot */</span><br>        <span class="hljs-keyword">uint32_t</span>     lineno;               <span class="hljs-comment">/* line number (for ast nodes) */</span><br>        <span class="hljs-keyword">uint32_t</span>     num_args;             <span class="hljs-comment">/* arguments number for EX(This) */</span><br>        <span class="hljs-keyword">uint32_t</span>     fe_pos;               <span class="hljs-comment">/* foreach position */</span><br>        <span class="hljs-keyword">uint32_t</span>     fe_iter_idx;          <span class="hljs-comment">/* foreach iterator index */</span><br>    &#125; u2;<br>&#125;;<br><br><span class="hljs-comment">//å˜é‡çš„å€¼</span><br><span class="hljs-comment">//é€šè¿‡ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ã€‚å˜é‡æ˜¯é€šè¿‡ä¸€ä¸ª_zval_structç»“æ„ä½“æ–¹å¼å­˜å‚¨çš„ã€‚å…¶ä¸­ç»“æ„ä½“ä¸­çš„valueå­˜å‚¨çš„æ˜¯å˜é‡çš„å€¼ã€‚è¿™ä¸ªæˆå‘˜æ˜¯zend_valueç±»å‹çš„ã€‚zend_valueç±»å‹çš„å®šä¹‰å¦‚ä¸‹ï¼š</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">union</span> _<span class="hljs-title">zend_value</span> &#123;</span><br>    zend_long         lval;             <span class="hljs-comment">/* long value */</span><br>    <span class="hljs-keyword">double</span>            dval;             <span class="hljs-comment">/* double value */</span><br>    zend_refcounted  *counted;<br>    zend_string      *str;<br>    zend_array       *arr;<br>    zend_object      *obj;<br>    zend_resource    *res;<br>    zend_reference   *ref;<br>    zend_ast_ref     *ast;<br>    zval             *zv;<br>    <span class="hljs-keyword">void</span>             *ptr;<br>    zend_class_entry *ce;<br>    zend_function    *func;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>        <span class="hljs-keyword">uint32_t</span> w1;<br>        <span class="hljs-keyword">uint32_t</span> w2;<br>    &#125; ww;<br>&#125; zend_value;<br></code></pre></td></tr></table></figure><h3 id="2-PHP-å¦‚ä½•ä¸-nginx-é€šä¿¡ï¼Œé€šä¿¡æ–¹å¼æœ‰ä»€ä¹ˆå¼‚åŒ"><a href="#2-PHP-å¦‚ä½•ä¸-nginx-é€šä¿¡ï¼Œé€šä¿¡æ–¹å¼æœ‰ä»€ä¹ˆå¼‚åŒ" class="headerlink" title="2. PHP å¦‚ä½•ä¸ nginx é€šä¿¡ï¼Œé€šä¿¡æ–¹å¼æœ‰ä»€ä¹ˆå¼‚åŒ"></a>2. PHP å¦‚ä½•ä¸ nginx é€šä¿¡ï¼Œé€šä¿¡æ–¹å¼æœ‰ä»€ä¹ˆå¼‚åŒ</h3><ul><li><a href="https://vsxen.github.io/2017/05/30/phpcgi-socks-vs-tcp/">https://vsxen.github.io/2017/05/30/phpcgi-socks-vs-tcp/</a></li></ul><h4 id="CGI-æ¨¡å¼"><a href="#CGI-æ¨¡å¼" class="headerlink" title="CGI æ¨¡å¼"></a>CGI æ¨¡å¼</h4><p>CGI CGIï¼ˆcommon gateway interfaceï¼‰é€šå¸¸ç¿»è¯‘ä¸ºå…±åŒç½‘å…³æ¥å£ï¼Œæ˜¯ HTTP æœåŠ¡å™¨ä¸æœºå™¨ä¸Šçš„å…¶ä»–ç¨‹åºè¿›è¡Œé€šä¿¡çš„ä¸€ä¸ªæ¥å£ï¼Œè®© Web æœåŠ¡å™¨å¿…è¦æ—¶å¯åŠ¨é¢å¤–çš„ç¨‹åºå¤„ç†åŠ¨æ€å†…å®¹ã€‚CGI æ˜¯ä¸€ç§åè®®ï¼Œå®ƒå®šä¹‰äº† Webserver ä¸ CGI ç¨‹åºçš„é€šä¿¡æ–¹å¼ã€‚Webserver æ¥å—å®¢æˆ·ç«¯çš„ HTTP è¯·æ±‚ï¼Œç„¶åå»ºç«‹è¿›ç¨‹æ‰§è¡Œ CGI ç¨‹åºï¼Œå®¢æˆ·ç«¯çš„è¯·æ±‚è¢«ä¼ é€’ç»™ CGI ç¨‹åºï¼ŒCGI æ‰§è¡Œåç»“æœå†è¿”å› Webserverã€‚ CGI çš„å‡ºç°è®© WEB ä»é™æ€å˜ä¸ºä¸ºåŠ¨æ€ï¼Œéšç€ Web çš„è¶Šæ¥è¶Šæ™®åŠï¼Œå¾ˆå¤šçš„ç½‘ç«™çš„éƒ½éœ€è¦æœ‰åŠ¨æ€çš„é¡µé¢ï¼Œä»¥ä¾¿ä¸æµè§ˆè€…äº’äº¤ã€‚éšç€ç½‘ç»œæŠ€æœ¯çš„å‘å±•ï¼ŒCGI æ–¹å¼çš„ç¼ºç‚¹ä¹Ÿè¶Šæ¥è¶Šçªå‡ºã€‚æ¯æ¬¡å®¢æˆ·ç«¯è¯·æ±‚éƒ½éœ€è¦å»ºç«‹å’Œé”€æ¯è¿›ç¨‹ã€‚å› ä¸º HTTP è¦ç”Ÿæˆä¸€ä¸ªåŠ¨æ€é¡µé¢ï¼Œç³»ç»Ÿå°±å¿…é¡»å¯åŠ¨ä¸€ä¸ªæ–°çš„è¿›ç¨‹ä»¥è¿è¡Œ CGI ç¨‹åºï¼Œä¸æ–­åœ° fork æ˜¯ä¸€é¡¹å¾ˆæ¶ˆè€—æ—¶é—´å’Œèµ„æºçš„å·¥ä½œã€‚</p><h4 id="FastCGI"><a href="#FastCGI" class="headerlink" title="FastCGI"></a>FastCGI</h4><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒCGI è§£é‡Šå™¨çš„åå¤åŠ è½½æ˜¯ CGI æ€§èƒ½ä½ä¸‹çš„ä¸»è¦åŸå› ï¼Œå¦‚æœ CGI è§£é‡Šå™¨ä¿æŒåœ¨å†…å­˜ä¸­ å¹¶æ¥å— FastCGI è¿›ç¨‹ç®¡ç†å™¨è°ƒåº¦ï¼Œåˆ™å¯ä»¥æä¾›è‰¯å¥½çš„æ€§èƒ½ã€ä¼¸ç¼©æ€§ã€Fail-Over ç‰¹æ€§ç­‰ç­‰ã€‚</p><p>FastCGI æ˜¯ä¸€ä¸ªå¸¸é©»å‹çš„ CGIï¼Œå¯ä»¥ä¸€ç›´æ‰§è¡Œï¼Œåªè¦æ¿€æ´»åï¼Œä¸ä¼šæ¯æ¬¡éƒ½èŠ±æ—¶é—´å» fork ä¸€æ¬¡ï¼Œè€Œä¸”è¿˜æ”¯æŒåˆ†å¸ƒå¼è¿ç®—ï¼ˆä½¿å¾— php ç¨‹åºè§£é‡Šæ‰§è¡Œå¯ä»¥å•ç‹¬äº¤ç»™ php æœåŠ¡å™¨ï¼‰ï¼Œå³å¯ä»¥åœ¨ç½‘ç«™æœåŠ¡å™¨ä»¥å¤–çš„ä¸»æœºä¸Šæ‰§è¡Œå¹¶ä¸”æ¥å—æ¥è‡ªå…¶å®ƒç½‘ç«™æœåŠ¡å™¨æ¥çš„è¯·æ±‚ã€‚</p><p>1ã€Web Server å¯åŠ¨æ—¶è½½å…¥ FastCGI è¿›ç¨‹ç®¡ç†å™¨ï¼ˆIIS ISAPI æˆ– Apache Moduleï¼‰;<br>2ã€FastCGI è¿›ç¨‹ç®¡ç†å™¨è‡ªèº«åˆå§‹åŒ–ï¼Œå¯åŠ¨å¤šä¸ª CGI è§£é‡Šå™¨è¿›ç¨‹ (åœ¨ä»»åŠ¡ç®¡ç†å™¨ä¸­å¯è§å¤šä¸ª php-cgi.exe)å¹¶ç­‰å¾…æ¥è‡ª Web Server çš„è¿æ¥ã€‚<br>3ã€å½“å®¢æˆ·ç«¯è¯·æ±‚åˆ°è¾¾ Web Server æ—¶ï¼ŒFastCGI è¿›ç¨‹ç®¡ç†å™¨é€‰æ‹©å¹¶è¿æ¥åˆ°ä¸€ä¸ª CGI è§£é‡Šå™¨ã€‚Web server å°† CGI ç¯å¢ƒå˜é‡å’Œæ ‡å‡†è¾“å…¥å‘é€åˆ° FastCGI å­è¿›ç¨‹ php-cgi.exeã€‚<br>4ã€FastCGI å­è¿›ç¨‹å®Œæˆå¤„ç†åå°†æ ‡å‡†è¾“å‡ºå’Œé”™è¯¯ä¿¡æ¯ä»åŒä¸€è¿æ¥è¿”å› Web Serverã€‚å½“ FastCGI å­è¿›ç¨‹å…³é—­è¿æ¥æ—¶ï¼Œè¯·æ±‚ä¾¿å‘Šå¤„ç†å®Œæˆã€‚FastCGI å­è¿›ç¨‹æ¥ç€ç­‰å¾…å¹¶å¤„ç†æ¥è‡ª FastCGI è¿›ç¨‹ç®¡ç†å™¨ï¼ˆè¿è¡Œåœ¨ WebServer ä¸­ï¼‰çš„ä¸‹ä¸€ä¸ªè¿æ¥ã€‚ åœ¨æ­£å¸¸çš„ CGI æ¨¡å¼ä¸­ï¼Œphp-cgi.exe åœ¨æ­¤ä¾¿é€€å‡ºäº†</p><h4 id="Apache-æ¨¡å—"><a href="#Apache-æ¨¡å—" class="headerlink" title="Apache æ¨¡å—"></a>Apache æ¨¡å—</h4><p>MPM Multi Path Modules ï¼ˆå¤šé“å¤„ç†æ¨¡å—ï¼‰ç”¨äºå®šä¹‰ apache åœ¨å“åº”å¤šä¸ªç”¨æˆ·è¯·æ±‚æ—¶æ‰€å·¥ä½œçš„æ¨¡å‹ã€‚æœ‰ä¸‰ç§ MPM æ¨¡å¼ï¼š</p><p>preforkï¼ˆä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªè¿›ç¨‹å“åº”ï¼‰</p><p>workerï¼ˆä¸€ä¸ªè¯·æ±‚ç”¨ä¸€ä¸ªçº¿ç¨‹å“åº”ï¼Œå¯åŠ¨å¤šä¸ªè¿›ç¨‹æ¯ä¸ªè¿›ç¨‹ç”Ÿæˆå¤šä¸ªçº¿ç¨‹ï¼‰</p><p>eventï¼ˆä¸€ä¸ªè¿›ç¨‹å¤„ç†å¤šä¸ªè¯·æ±‚ï¼‰</p><p>ä»¥æ¨¡å—å®‰è£…çš„ php æ²¡æœ‰ç‹¬ç«‹çš„è¿›ç¨‹ï¼Œæ˜¯ä½œä¸º apache çš„æ¨¡å—å’Œ apache ä¸€èµ·å¯åŠ¨çš„ã€‚</p><p>ä»¥ä¸Šä¸‰ç§ MPM æ¨¡å¼ï¼Œworker æ¨¡å¼ä¼šæ¯” prefork æ¨¡å¼å æ®æ›´å°‘çš„å†…å­˜ï¼Œé«˜å¹¶å‘ä¸‹çš„è¡¨ç°æ›´å¥½ã€‚è€Œä¸”ä½¿ç”¨å¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹æ··åˆæ¨¡å¼ï¼Œå³ä½¿æœ‰ä¸€ä¸ªçº¿ç¨‹æŒ‚äº†ï¼Œä¹Ÿåªå½±å“å’Œè¯¥çº¿ç¨‹åŒè¿›ç¨‹çš„å…¶ä»–çº¿ç¨‹ï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–çš„è¿›ç¨‹ã€‚ä½†æ˜¯å¦‚æœæœ‰ç‰¹åˆ«å¤šçš„çº¿ç¨‹éƒ½ä½¿ç”¨ keep-alive çš„é•¿è¿æ¥æ–¹å¼ï¼Œåˆ™çº¿ç¨‹ä¼šä¸€ç›´è¢«å æ®ç›´åˆ°è¶…æ—¶æ‰é‡Šæ”¾ï¼Œå¯¼è‡´åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ— å¯ç”¨çº¿ç¨‹ã€‚è€Œ event æ¨¡å¼ä½¿ç”¨äº†ä¸€ä¸ªä¸“é—¨çš„çº¿ç¨‹æ¥å¤„ç†è¿™äº› keep-alive ç±»çº¿ç¨‹ï¼Œè¾ƒå¥½çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚</p><h4 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h4><p>Nginx å¤„ç† PHP æ–‡ä»¶ åªæœ‰ FastCGI ä¸€ç§<br>ä¸è¿‡ Nginx è¿æ¥ fastcgi çš„æ–¹å¼æœ‰ 2 ç§ï¼šTCP å’Œ unix domain socket<br>Unix domain socket æˆ–è€… IPC socket æ˜¯ä¸€ç§ç»ˆç«¯ï¼Œå¯ä»¥ä½¿åŒä¸€å°æ“ä½œç³»ç»Ÿä¸Šçš„ä¸¤ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹è¿›è¡Œæ•°æ®é€šä¿¡ã€‚ä¸ç®¡é“ç›¸æ¯”ï¼ŒUnix domain sockets æ—¢å¯ä»¥ä½¿ç”¨å­—èŠ‚æµå’Œæ•°æ®é˜Ÿåˆ—ï¼Œè€Œç®¡é“é€šä¿¡åˆ™åªèƒ½é€šè¿‡å­—èŠ‚æµã€‚Unix domain sockets çš„æ¥å£å’Œ Internet socket å¾ˆåƒï¼Œä½†å®ƒä¸ä½¿ç”¨ç½‘ç»œåº•å±‚åè®®æ¥é€šä¿¡ã€‚Unix domain socket çš„åŠŸèƒ½æ˜¯ POSIX æ“ä½œç³»ç»Ÿé‡Œçš„ä¸€ç§ç»„ä»¶ã€‚<br>Unix domain sockets ä½¿ç”¨ç³»ç»Ÿæ–‡ä»¶çš„åœ°å€æ¥ä½œä¸ºè‡ªå·±çš„èº«ä»½ã€‚å®ƒå¯ä»¥è¢«ç³»ç»Ÿè¿›ç¨‹å¼•ç”¨ã€‚æ‰€ä»¥ä¸¤ä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶æ‰“å¼€ä¸€ä¸ª Unix domain sockets æ¥è¿›è¡Œé€šä¿¡ã€‚ä¸è¿‡è¿™ç§é€šä¿¡æ–¹å¼æ˜¯å‘ç”Ÿåœ¨ç³»ç»Ÿå†…æ ¸é‡Œè€Œä¸ä¼šåœ¨ç½‘ç»œé‡Œä¼ æ’­ã€‚<br>TCP å’Œ unix domain socket æ–¹å¼å¯¹æ¯”<br>TCP æ˜¯ä½¿ç”¨ TCP ç«¯å£è¿æ¥ 127.0.0.1:9000<br>Socket æ˜¯ä½¿ç”¨ unix domain socket è¿æ¥å¥—æ¥å­—/dev/shm/php-cgi.sockï¼ˆå¾ˆå¤šæ•™ç¨‹ä½¿ç”¨è·¯å¾„/tmpï¼Œè€Œè·¯å¾„/dev/shm æ˜¯ä¸ª tmpfsï¼Œé€Ÿåº¦æ¯”ç£ç›˜å¿«å¾—å¤šï¼‰<br>æµ‹è¯•æœºæ˜¯ä¸ª 1 æ ¸çš„ centos5.4ï¼Œ2 ç”¨æˆ·å¹¶å‘æ—¶ç³»ç»Ÿèµ„æºæ¶ˆè€— 50%å·¦å³ï¼Œ10 ç”¨æˆ·èµ„æºå°±è·‘å¾—å¾ˆæ»¡äº†</p><p>ç»“è®ºæ˜¯åœ¨æœåŠ¡å™¨å‹åŠ›ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œtcp å’Œ socket å·®åˆ«ä¸å¤§ï¼Œä½†åœ¨å‹åŠ›æ¯”è¾ƒæ»¡çš„æ—¶å€™ï¼Œç”¨å¥—æ¥å­—æ–¹å¼ï¼Œæ•ˆæœç¡®å®æ¯”è¾ƒå¥½ã€‚<br>ä¸‹é¢æ˜¯ php 5.3 ä»¥ä¸Šç‰ˆæœ¬å°† TCP æ”¹æˆ socket æ–¹å¼çš„é…ç½®æ–¹æ³•ï¼š<br>ä¿®æ”¹ php-fpm.confï¼ˆ/usr/local/php/etc/php-fpm.confï¼‰<br>;listen = 127.0.0.1:9000<br>listen = /dev/shm/php-cgi.sock<br>ä¿®æ”¹ nginx é…ç½®æ–‡ä»¶ server æ®µçš„é…ç½®ï¼Œå°† http çš„æ–¹å¼æ”¹ä¸º socket æ–¹å¼</p><p>ä»åŸç†ä¸Šæ¥è¯´ï¼Œunix socket æ–¹å¼è‚¯å®šè¦æ¯” tcp çš„æ–¹å¼å¿«è€Œä¸”æ¶ˆè€—èµ„æºå°‘ï¼Œå› ä¸º socket ä¹‹é—´åœ¨ nginx å’Œ php-fpm çš„è¿›ç¨‹ä¹‹é—´é€šä¿¡ï¼Œè€Œ tcp éœ€è¦ç»è¿‡æœ¬åœ°å›ç¯é©±åŠ¨ï¼Œè¿˜è¦ç”³è¯·ä¸´æ—¶ç«¯å£å’Œ tcp ç›¸å…³èµ„æºã€‚<br>å½“ç„¶è¿˜æ˜¯ä»åŸç†ä¸Šæ¥è¯´ï¼Œunix socket ä¼šæ˜¾å¾—ä¸æ˜¯é‚£ä¹ˆç¨³å®šï¼Œå½“å¹¶å‘è¿æ¥æ•°çˆ†å‘æ—¶ï¼Œä¼šäº§ç”Ÿå¤§é‡çš„é•¿æ—¶ç¼“å­˜ï¼Œåœ¨æ²¡æœ‰é¢å‘è¿æ¥åè®®æ”¯æ’‘çš„æƒ…å†µä¸‹ï¼Œå¤§æ•°æ®åŒ…å¾ˆæœ‰å¯èƒ½å°±ç›´æ¥å‡ºé”™å¹¶ä¸ä¼šè¿”å›å¼‚å¸¸ã€‚è€Œ TCP è¿™æ ·çš„é¢å‘è¿æ¥çš„åè®®ï¼Œå¤šå°‘å¯ä»¥ä¿è¯é€šä¿¡çš„æ­£ç¡®æ€§å’Œå®Œæ•´æ€§ã€‚</p><h3 id="3-PHP-çš„æ‰§è¡Œæ¨¡å¼æœ‰å“ªäº›"><a href="#3-PHP-çš„æ‰§è¡Œæ¨¡å¼æœ‰å“ªäº›" class="headerlink" title="3. PHP çš„æ‰§è¡Œæ¨¡å¼æœ‰å“ªäº›"></a>3. PHP çš„æ‰§è¡Œæ¨¡å¼æœ‰å“ªäº›</h3><ul><li><a href="http://blog.csdn.net/xujingzhong0077/article/details/53316767">http://blog.csdn.net/xujingzhong0077/article/details/53316767</a></li></ul><h4 id="è¿è¡Œæ¨¡å¼"><a href="#è¿è¡Œæ¨¡å¼" class="headerlink" title="è¿è¡Œæ¨¡å¼"></a>è¿è¡Œæ¨¡å¼</h4><p>å…³äº PHP ç›®å‰æ¯”è¾ƒå¸¸è§çš„äº”å¤§è¿è¡Œæ¨¡å¼ï¼š<br>1ï¼‰CGIï¼ˆé€šç”¨ç½‘å…³æ¥å£/ Common Gateway Interfaceï¼‰<br>2ï¼‰FastCGIï¼ˆå¸¸é©»å‹ CGI / Long-Live CGIï¼‰<br>3ï¼‰CLIï¼ˆå‘½ä»¤è¡Œè¿è¡Œ / Command Line Interfaceï¼‰<br>4ï¼‰Web æ¨¡å—æ¨¡å¼ï¼ˆApache ç­‰ Web æœåŠ¡å™¨è¿è¡Œçš„æ¨¡å¼ï¼‰<br>5ï¼‰ISAPIï¼ˆInternet Server Application Program Interfaceï¼‰</p><p>å¤‡æ³¨ï¼šåœ¨ PHP5.3 ä»¥åï¼ŒPHP ä¸å†æœ‰ ISAPI æ¨¡å¼ï¼Œå®‰è£…åä¹Ÿä¸å†æœ‰ php5isapi.dll è¿™ä¸ªæ–‡ä»¶ã€‚è¦åœ¨ IIS6 ä¸Šä½¿ç”¨é«˜ç‰ˆæœ¬ PHPï¼Œå¿…é¡»å®‰è£… FastCGI æ‰©å±•ï¼Œç„¶åä½¿ IIS6 æ”¯æŒ FastCGIã€‚</p><h4 id="1-1ã€CGI-æ¨¡å¼"><a href="#1-1ã€CGI-æ¨¡å¼" class="headerlink" title="1.1ã€CGI æ¨¡å¼"></a>1.1ã€CGI æ¨¡å¼</h4><p>CGI å³é€šç”¨ç½‘å…³æ¥å£ï¼ˆCommon Gateway Interfaceï¼‰ï¼Œå®ƒæ˜¯ä¸€æ®µç¨‹åºï¼Œé€šä¿—çš„è®² CGI å°±è±¡æ˜¯ä¸€åº§æ¡¥ï¼ŒæŠŠç½‘é¡µå’Œ Web æœåŠ¡å™¨ä¸­çš„æ‰§è¡Œç¨‹åºè¿æ¥èµ·æ¥ï¼Œå®ƒæŠŠ HTML æ¥æ”¶çš„æŒ‡ä»¤ä¼ é€’ç»™æœåŠ¡å™¨çš„æ‰§è¡Œç¨‹åºï¼Œå†æŠŠæœåŠ¡å™¨æ‰§è¡Œç¨‹åºçš„ç»“æœè¿”è¿˜ç»™ HTML é¡µã€‚CGI çš„è·¨å¹³å°æ€§èƒ½æä½³ï¼Œå‡ ä¹å¯ä»¥åœ¨ä»»ä½•æ“ä½œç³»ç»Ÿä¸Šå®ç°ã€‚CGI å·²ç»æ˜¯æ¯”è¾ƒè€çš„æ¨¡å¼äº†ï¼Œè¿™å‡ å¹´éƒ½å¾ˆå°‘ç”¨äº†ã€‚</p><p>æ¯æœ‰ä¸€ä¸ªç”¨æˆ·è¯·æ±‚ï¼Œéƒ½ä¼šå…ˆè¦åˆ›å»º CGI çš„å­è¿›ç¨‹ï¼Œç„¶åå¤„ç†è¯·æ±‚ï¼Œå¤„ç†å®Œåç»“æŸè¿™ä¸ªå­è¿›ç¨‹ï¼Œè¿™å°±æ˜¯ Fork-And-Execute æ¨¡å¼ã€‚ å½“ç”¨æˆ·è¯·æ±‚æ•°é‡éå¸¸å¤šæ—¶ï¼Œä¼šå¤§é‡æŒ¤å ç³»ç»Ÿçš„èµ„æºå¦‚å†…å­˜ï¼ŒCPU æ—¶é—´ç­‰ï¼Œé€ æˆæ•ˆèƒ½ä½ä¸‹ã€‚æ‰€ä»¥ç”¨ CGI æ–¹å¼çš„æœåŠ¡å™¨æœ‰å¤šå°‘è¿æ¥è¯·æ±‚å°±ä¼šæœ‰å¤šå°‘ CGI å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹åå¤åŠ è½½æ˜¯ CGI æ€§èƒ½ä½ä¸‹çš„ä¸»è¦åŸå› ã€‚</p><p>å¦‚æœä¸æƒ³æŠŠ PHP åµŒå…¥åˆ°æœåŠ¡å™¨ç«¯è½¯ä»¶ï¼ˆå¦‚ Apacheï¼‰ä½œä¸ºä¸€ä¸ªæ¨¡å—å®‰è£…çš„è¯ï¼Œå¯ä»¥é€‰æ‹©ä»¥ CGI çš„æ¨¡å¼å®‰è£…ã€‚æˆ–è€…æŠŠ PHP ç”¨äºä¸åŒçš„ CGI å°è£…ä»¥ä¾¿ä¸ºä»£ç åˆ›å»ºå®‰å…¨çš„ chroot å’Œ setuid ç¯å¢ƒã€‚è¿™æ ·æ¯ä¸ªå®¢æˆ·æœºè¯·æ±‚ä¸€ä¸ª PHP æ–‡ä»¶ï¼ŒWeb æœåŠ¡å™¨å°±è°ƒç”¨ php.exeï¼ˆwin ä¸‹æ˜¯ php.exe,linux æ˜¯ phpï¼‰å»è§£é‡Šè¿™ä¸ªæ–‡ä»¶ï¼Œç„¶åå†æŠŠè§£é‡Šçš„ç»“æœä»¥ç½‘é¡µçš„å½¢å¼è¿”å›ç»™å®¢æˆ·æœºã€‚ è¿™ç§å®‰è£…æ–¹å¼é€šå¸¸ä¼šæŠŠ PHP çš„å¯æ‰§è¡Œæ–‡ä»¶å®‰è£…åˆ° web æœåŠ¡å™¨çš„ cgi-bin ç›®å½•ã€‚CERT å»ºè®®ä¹¦ CA-96.11 å»ºè®®ä¸è¦æŠŠä»»ä½•çš„è§£é‡Šå™¨æ”¾åˆ° cgi-bin ç›®å½•ã€‚ è¿™ç§æ–¹å¼çš„å¥½å¤„æ˜¯æŠŠ Web Server å’Œå…·ä½“çš„ç¨‹åºå¤„ç†ç‹¬ç«‹å¼€æ¥ï¼Œç»“æ„æ¸…æ™°ï¼Œå¯æ§æ€§å¼ºï¼ŒåŒæ—¶ç¼ºç‚¹å°±æ˜¯å¦‚æœåœ¨é«˜è®¿é—®éœ€æ±‚çš„æƒ…å†µä¸‹ï¼ŒCGI çš„è¿›ç¨‹ Fork å°±ä¼šæˆä¸ºå¾ˆå¤§çš„æœåŠ¡å™¨è´Ÿæ‹…ï¼Œæƒ³ è±¡ä¸€ä¸‹æ•°ç™¾ä¸ªå¹¶å‘è¯·æ±‚å¯¼è‡´æœåŠ¡å™¨ Fork å‡ºæ•°ç™¾ä¸ªè¿›ç¨‹å°±æ˜ç™½äº†ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ CGI ä¸€ç›´èƒŒè´Ÿæ€§èƒ½ä½ä¸‹ï¼Œé«˜èµ„æºæ¶ˆè€—çš„æ¶åçš„åŸå› ã€‚</p><h4 id="1-2ã€FastCGI-æ¨¡å¼"><a href="#1-2ã€FastCGI-æ¨¡å¼" class="headerlink" title="1.2ã€FastCGI æ¨¡å¼"></a>1.2ã€FastCGI æ¨¡å¼</h4><p>FastCGI æ˜¯ CGI çš„å‡çº§ç‰ˆæœ¬ï¼ŒFastCGI åƒæ˜¯ä¸€ä¸ªå¸¸é©» (long-live)å‹çš„ CGIï¼Œå®ƒå¯ä»¥ä¸€ç›´æ‰§è¡Œç€ï¼Œåªè¦æ¿€æ´»åï¼Œä¸ä¼šæ¯æ¬¡éƒ½è¦èŠ±è´¹æ—¶é—´å» Fork ä¸€æ¬¡ ï¼ˆè¿™æ˜¯ CGI æœ€ä¸ºäººè¯Ÿç—…çš„ fork-and-execute æ¨¡å¼ï¼‰ã€‚<br>FastCGI æ˜¯ä¸€ä¸ªå¯ä¼¸ç¼©åœ°ã€é«˜é€Ÿåœ°åœ¨ HTTP server å’ŒåŠ¨æ€è„šæœ¬è¯­è¨€é—´é€šä¿¡çš„æ¥å£ã€‚å¤šæ•°æµè¡Œçš„ HTTP server éƒ½æ”¯æŒ FastCGIï¼ŒåŒ…æ‹¬ Apacheã€Nginx å’Œ lighttpd ç­‰ï¼ŒåŒæ—¶ï¼ŒFastCGI ä¹Ÿè¢«è®¸å¤šè„šæœ¬è¯­è¨€æ‰€æ”¯æŒï¼Œå…¶ä¸­å°±æœ‰ PHPã€‚<br>FastCGI æ¥å£æ–¹å¼é‡‡ç”¨ C/S ç»“æ„ï¼Œå¯ä»¥å°† HTTP æœåŠ¡å™¨å’Œè„šæœ¬è§£ææœåŠ¡å™¨åˆ†å¼€ï¼ŒåŒæ—¶åœ¨è„šæœ¬è§£ææœåŠ¡å™¨ä¸Šå¯åŠ¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªè„šæœ¬è§£æå®ˆæŠ¤è¿›ç¨‹ã€‚å½“ HTTP æœåŠ¡å™¨æ¯æ¬¡é‡åˆ°åŠ¨æ€ç¨‹åºæ—¶ï¼Œå¯ä»¥å°†å…¶ç›´æ¥äº¤ä»˜ç»™ FastCGI è¿›ç¨‹æ¥æ‰§è¡Œï¼Œç„¶åå°†å¾—åˆ°çš„ç»“æœè¿”å›ç»™æµè§ˆå™¨ã€‚è¿™ç§æ–¹å¼å¯ä»¥è®© HTTP æœåŠ¡å™¨ä¸“ä¸€åœ°å¤„ç†é™æ€è¯·æ±‚æˆ–è€…å°†åŠ¨æ€è„šæœ¬æœåŠ¡å™¨çš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè¿™åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜äº†æ•´ä¸ªåº”ç”¨ç³»ç»Ÿçš„æ€§èƒ½ã€‚</p><p>ã€åŸç†ã€‘<br>1ï¼‰Web Server å¯åŠ¨æ—¶è½½å…¥ FastCGI è¿›ç¨‹ç®¡ç†å™¨ï¼ˆIIS ISAPI æˆ– Apache Module)ï¼›<br>2ï¼‰FastCGI è¿›ç¨‹ç®¡ç†å™¨è‡ªèº«åˆå§‹åŒ–ï¼Œå¯åŠ¨å¤šä¸ª CGI è§£é‡Šå™¨è¿›ç¨‹ (å¯è§å¤šä¸ª php-cgi.exe æˆ– php-cig)å¹¶ç­‰å¾…æ¥è‡ª Web Server çš„è¿æ¥ï¼›<br>3ï¼‰å½“å®¢æˆ·ç«¯è¯·æ±‚åˆ°è¾¾ Web Server æ—¶ï¼ŒFastCGI è¿›ç¨‹ç®¡ç†å™¨é€‰æ‹©å¹¶è¿æ¥åˆ°ä¸€ä¸ª CGI è§£é‡Šå™¨ã€‚Web server å°† CGI ç¯å¢ƒå˜é‡å’Œæ ‡å‡†è¾“å…¥å‘é€åˆ° FastCGI å­è¿›ç¨‹ php-cgiï¼›<br>4ï¼‰FastCGI å­è¿›ç¨‹å®Œæˆå¤„ç†åå°†æ ‡å‡†è¾“å‡ºå’Œé”™è¯¯ä¿¡æ¯ä»åŒä¸€è¿æ¥è¿”å› Web Serverã€‚å½“ FastCGI å­è¿›ç¨‹å…³é—­è¿æ¥æ—¶ï¼Œè¯·æ±‚ä¾¿å‘Šå¤„ç†å®Œæˆã€‚FastCGI å­è¿›ç¨‹æ¥ç€ç­‰å¾…å¹¶å¤„ç†æ¥è‡ª FastCGI è¿›ç¨‹ç®¡ç†å™¨ï¼ˆè¿è¡Œåœ¨ WebServer ä¸­ï¼‰çš„ä¸‹ä¸€ä¸ªè¿æ¥ã€‚åœ¨æ­£å¸¸çš„ CGI æ¨¡å¼ä¸­ï¼Œphp-cgi.exe åœ¨æ­¤ä¾¿é€€å‡ºäº†ã€‚<br>åœ¨ CGI æ¨¡å¼ä¸­ï¼Œä½ å¯ä»¥æƒ³è±¡ CGI é€šå¸¸æœ‰å¤šæ…¢ã€‚æ¯ä¸€ä¸ª Web è¯·æ±‚ PHP éƒ½å¿…é¡»é‡æ–°è§£æ php.iniã€é‡æ–°è½½å…¥å…¨éƒ¨ dll æ‰©å±•å¹¶é‡åˆå§‹åŒ–å…¨éƒ¨æ•°æ®ç»“æ„ã€‚ä½¿ç”¨ FastCGIï¼Œæ‰€æœ‰è¿™äº›éƒ½åªåœ¨è¿›ç¨‹å¯åŠ¨æ—¶å‘ç”Ÿä¸€æ¬¡ã€‚ä¸€ä¸ªé¢å¤–çš„å¥½å¤„æ˜¯ï¼ŒæŒç»­æ•°æ®åº“è¿æ¥ï¼ˆPersistent database connectionï¼‰å¯ä»¥å·¥ä½œã€‚</p><p>å¤‡æ³¨ï¼šPHP çš„ FastCGI è¿›ç¨‹ç®¡ç†å™¨æ˜¯ PHP-FPMï¼ˆPHP-FastCGI Process Managerï¼‰<br>ã€ä¼˜ç‚¹ã€‘<br>1ï¼‰ä»ç¨³å®šæ€§ä¸Šçœ‹ï¼ŒFastCGI æ˜¯ä»¥ç‹¬ç«‹çš„è¿›ç¨‹æ± æ¥è¿è¡Œ CGIï¼Œå•ç‹¬ä¸€ä¸ªè¿›ç¨‹æ­»æ‰ï¼Œç³»ç»Ÿå¯ä»¥å¾ˆè½»æ˜“çš„ä¸¢å¼ƒï¼Œç„¶åé‡æ–°åˆ†é…æ–°çš„è¿›ç¨‹æ¥è¿è¡Œé€»è¾‘ï¼›<br>2ï¼‰ä»å®‰å…¨æ€§ä¸Šçœ‹ï¼ŒFastCGI æ”¯æŒåˆ†å¸ƒå¼è¿ç®—ã€‚FastCGI å’Œå®¿ä¸»çš„ Server å®Œå…¨ç‹¬ç«‹ï¼ŒFastCGI æ€ä¹ˆ down ä¹Ÿä¸ä¼šæŠŠ Server æå®ï¼›<br>3ï¼‰ä»æ€§èƒ½ä¸Šçœ‹ï¼ŒFastCGI æŠŠåŠ¨æ€é€»è¾‘çš„å¤„ç†ä» Server ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œå¤§è´Ÿè·çš„ IO å¤„ç†è¿˜æ˜¯ç•™ç»™å®¿ä¸» Serverï¼Œè¿™æ ·å®¿ä¸» Server å¯ä»¥ä¸€å¿ƒä¸€æ„ä½œ IOï¼Œå¯¹äºä¸€ä¸ªæ™®é€šçš„åŠ¨æ€ç½‘é¡µæ¥è¯´, é€»è¾‘å¤„ç†å¯èƒ½åªæœ‰ä¸€å°éƒ¨åˆ†ï¼Œå¤§é‡çš„æ˜¯å›¾ç‰‡ç­‰é™æ€ã€‚</p><p>ã€ç¼ºç‚¹ã€‘<br>è¯´å®Œäº†å¥½å¤„ï¼Œä¹Ÿæ¥è¯´è¯´ç¼ºç‚¹ã€‚ä»æˆ‘çš„å®é™…ä½¿ç”¨æ¥çœ‹ï¼Œç”¨ FastCGI æ¨¡å¼æ›´é€‚åˆç”Ÿäº§ç¯å¢ƒçš„æœåŠ¡å™¨ã€‚ä½†å¯¹äºå¼€å‘ç”¨æœºå™¨æ¥è¯´å°±ä¸å¤ªåˆé€‚ã€‚å› ä¸ºå½“ä½¿ç”¨ Zend Studio è°ƒè¯•ç¨‹åºæ—¶ï¼Œç”±äº FastCGI ä¼šè®¤ä¸º PHP è¿›ç¨‹è¶…æ—¶ï¼Œä»è€Œåœ¨é¡µé¢è¿”å› 500 é”™è¯¯ã€‚è¿™ä¸€ç‚¹è®©äººéå¸¸æ¼ç«ï¼Œæ‰€ä»¥æˆ‘åœ¨å¼€å‘æœºå™¨ä¸Šè¿˜æ˜¯æ¢å›äº† ISAPI æ¨¡å¼ã€‚å¯¹æŸäº›æœåŠ¡å™¨çš„æ–°ç‰ˆæœ¬æ”¯æŒä¸å¥½ï¼Œå¯¹åˆ†å¸ƒå¼è´Ÿè½½å‡è¡¡æ²¡è¦æ±‚çš„æ¨¡å—åŒ–å®‰è£…æ˜¯å¦æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚ç›®å‰çš„ FastCGI å’Œ Server æ²Ÿé€šè¿˜ä¸å¤Ÿæ™ºèƒ½ï¼Œä¸€ä¸ª FastCGI è¿›ç¨‹å¦‚æœæ‰§è¡Œæ—¶é—´è¿‡é•¿ä¼šè¢«å½“æˆæ˜¯æ­»è¿›ç¨‹æ€æ‰é‡èµ·ï¼Œè¿™æ ·åœ¨å¤„ç†é•¿æ—¶é—´ä»»åŠ¡çš„æ—¶å€™å¾ˆéº»çƒ¦ï¼Œè¿™æ ·åšä¹Ÿä½¿å¾— FastCGI æ— æ³•å…è®¸è”æœºè°ƒè¯•ã€‚å› ä¸ºæ˜¯å¤šè¿›ç¨‹ï¼Œæ‰€ä»¥æ¯” CGI å¤šçº¿ç¨‹æ¶ˆè€—æ›´å¤šçš„æœåŠ¡å™¨å†…å­˜ï¼ŒPHP-CGI è§£é‡Šå™¨æ¯è¿›ç¨‹æ¶ˆè€— 7 è‡³ 25 å…†å†…å­˜ï¼Œå°†è¿™ä¸ªæ•°å­—ä¹˜ä»¥ 50 æˆ– 100 å°±æ˜¯å¾ˆå¤§çš„å†…å­˜æ•°ã€‚</p><h4 id="1-3-CLI-æ¨¡å¼"><a href="#1-3-CLI-æ¨¡å¼" class="headerlink" title="1.3 CLI æ¨¡å¼"></a>1.3 CLI æ¨¡å¼</h4><p>PHP-CLI æ˜¯ PHP Command Line Interface çš„ç®€ç§°ï¼Œå¦‚åŒå®ƒåå­—çš„æ„æ€ï¼Œå°±æ˜¯ PHP åœ¨å‘½ä»¤è¡Œè¿è¡Œçš„æ¥å£ï¼ŒåŒºåˆ«äºåœ¨ Web æœåŠ¡å™¨ä¸Šè¿è¡Œçš„ PHP ç¯å¢ƒï¼ˆPHP-CGIï¼ŒISAPI ç­‰ï¼‰ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼ŒPHP ä¸å•å¯ä»¥å†™å‰å°ç½‘é¡µï¼Œå®ƒè¿˜å¯ä»¥ç”¨æ¥å†™åå°çš„ç¨‹åºã€‚ PHP çš„ CLI Shell è„šæœ¬é€‚ç”¨äºæ‰€æœ‰çš„ PHP ä¼˜åŠ¿ï¼Œä½¿åˆ›å»ºè¦ä¹ˆæ”¯æŒè„šæœ¬æˆ–ç³»ç»Ÿç”šè‡³ä¸ GUI åº”ç”¨ç¨‹åºçš„æœåŠ¡ç«¯ï¼Œåœ¨ Windows å’Œ Linux ä¸‹éƒ½æ˜¯æ”¯æŒ PHP-CLI æ¨¡å¼çš„ã€‚<br>ã€ä¼˜ç‚¹ã€‘<br>1ï¼‰ä½¿ç”¨å¤šè¿›ç¨‹ï¼Œå­è¿›ç¨‹ç»“æŸä»¥åï¼Œå†…æ ¸ä¼šè´Ÿè´£å›æ”¶èµ„æºï¼›<br>2ï¼‰ä½¿ç”¨å¤šè¿›ç¨‹ï¼Œå­è¿›ç¨‹å¼‚å¸¸é€€å‡ºä¸ä¼šå¯¼è‡´æ•´ä¸ªè¿›ç¨‹ Thread é€€å‡ºï¼Œçˆ¶è¿›ç¨‹è¿˜æœ‰æœºä¼šé‡å»ºæµç¨‹ï¼›<br>3ï¼‰ä¸€ä¸ªå¸¸é©»ä¸»è¿›ç¨‹ï¼Œåªè´Ÿè´£ä»»åŠ¡åˆ†å‘ï¼Œé€»è¾‘æ›´æ¸…æ¥šã€‚<br>æˆ‘ä»¬åœ¨ Linux ä¸‹ç»å¸¸ä½¿ç”¨â€php â€“mâ€æŸ¥æ‰¾ PHP å®‰è£…äº†é‚£äº›æ‰©å±•å°±æ˜¯ PHP å‘½ä»¤è¡Œè¿è¡Œæ¨¡å¼ï¼›æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è¾“å…¥â€php â€“hâ€å»æ·±å…¥ç ”ç©¶è¯¥è¿è¡Œæ¨¡å¼ã€‚</p><h4 id="1-4-æ¨¡å—æ¨¡å¼"><a href="#1-4-æ¨¡å—æ¨¡å¼" class="headerlink" title="1.4 æ¨¡å—æ¨¡å¼"></a>1.4 æ¨¡å—æ¨¡å¼</h4><p>æ¨¡å—æ¨¡å¼æ˜¯ä»¥ mod_php5 æ¨¡å—çš„å½¢å¼é›†æˆï¼Œæ­¤æ—¶ mod_php5 æ¨¡å—çš„ä½œç”¨æ˜¯æ¥æ”¶ Apache ä¼ é€’è¿‡æ¥çš„ PHP æ–‡ä»¶è¯·æ±‚ï¼Œå¹¶å¤„ç†è¿™äº›è¯·æ±‚ï¼Œç„¶åå°†å¤„ç†åçš„ç»“æœè¿”å›ç»™ Apacheã€‚å¦‚æœæˆ‘ä»¬åœ¨ Apache å¯åŠ¨å‰åœ¨å…¶é…ç½®æ–‡ä»¶ä¸­é…ç½®å¥½äº† PHP æ¨¡å—<br>ï¼ˆmod_php5ï¼‰ï¼Œ PHP æ¨¡å—é€šè¿‡æ³¨å†Œ apache2 çš„ ap_hook_post_config æŒ‚é’©ï¼Œåœ¨ Apache å¯åŠ¨çš„æ—¶å€™å¯åŠ¨æ­¤æ¨¡å—ä»¥æ¥å— PHP æ–‡ä»¶çš„è¯·æ±‚ã€‚<br>é™¤äº†è¿™ç§å¯åŠ¨æ—¶çš„åŠ è½½æ–¹å¼ï¼ŒApache çš„æ¨¡å—å¯ä»¥åœ¨è¿è¡Œçš„æ—¶å€™åŠ¨æ€è£…è½½ï¼Œè¿™æ„å‘³ç€å¯¹æœåŠ¡å™¨å¯ä»¥è¿›è¡ŒåŠŸèƒ½æ‰©å±•è€Œä¸éœ€è¦é‡æ–°å¯¹æºä»£ç è¿›è¡Œç¼–è¯‘ï¼Œç”šè‡³æ ¹æœ¬ä¸éœ€è¦åœæ­¢æœåŠ¡å™¨ã€‚æˆ‘ä»¬æ‰€éœ€è¦åšçš„ä»…ä»…æ˜¯ç»™æœåŠ¡å™¨å‘é€ä¿¡å· HUP æˆ–è€… AP_SIG_GRACEFUL é€šçŸ¥æœåŠ¡å™¨é‡æ–°è½½å…¥æ¨¡å—ã€‚ä½†æ˜¯åœ¨åŠ¨æ€åŠ è½½ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å°†æ¨¡å—ç¼–è¯‘æˆä¸ºåŠ¨æ€é“¾æ¥åº“ã€‚æ­¤æ—¶çš„åŠ¨æ€åŠ è½½å°±æ˜¯åŠ è½½åŠ¨æ€é“¾æ¥åº“ã€‚ Apache ä¸­å¯¹åŠ¨æ€é“¾æ¥åº“çš„å¤„ç†æ˜¯é€šè¿‡æ¨¡å— mod_so æ¥å®Œæˆçš„ï¼Œå› æ­¤ mod_so æ¨¡å—ä¸èƒ½è¢«åŠ¨æ€åŠ è½½ï¼Œå®ƒåªèƒ½è¢«é™æ€ç¼–è¯‘è¿› Apache çš„æ ¸å¿ƒã€‚è¿™æ„å‘³ç€å®ƒæ˜¯éšç€ Apache ä¸€èµ·å¯åŠ¨çš„ã€‚<br>Apache æ˜¯å¦‚ä½•åŠ è½½æ¨¡å—çš„å‘¢ï¼Ÿæˆ‘ä»¬ä»¥å‰é¢æåˆ°çš„ mod_php5 æ¨¡å—ä¸ºä¾‹ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨ Apache çš„é…ç½®æ–‡ä»¶ httpd.conf ä¸­æ·»åŠ ä¸€è¡Œï¼š<br>LoadModule php5_module modules/mod_php5.so</p><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº† LoadModule å‘½ä»¤ï¼Œè¯¥å‘½ä»¤çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ¨¡å—çš„åç§°ï¼Œåç§°å¯ä»¥åœ¨æ¨¡å—å®ç°çš„æºç ä¸­æ‰¾åˆ°ã€‚ç¬¬äºŒä¸ªé€‰é¡¹æ˜¯è¯¥æ¨¡å—æ‰€å¤„çš„è·¯å¾„ã€‚å¦‚æœéœ€è¦åœ¨æœåŠ¡å™¨è¿è¡Œæ—¶åŠ è½½æ¨¡å—ï¼Œå¯ä»¥é€šè¿‡å‘é€ä¿¡å· HUP æˆ–è€… AP_SIG_GRACEFUL ç»™æœåŠ¡å™¨ï¼Œä¸€æ—¦æ¥å—åˆ°è¯¥ä¿¡å·ï¼ŒApache å°†é‡æ–°è£…è½½æ¨¡å—ï¼Œè€Œä¸éœ€è¦é‡æ–°å¯åŠ¨æœåŠ¡å™¨ã€‚<br>è¯¥è¿è¡Œæ¨¡å¼æ˜¯æˆ‘ä»¬ä»¥å‰åœ¨ windows ç¯å¢ƒä¸‹ä½¿ç”¨ apache æœåŠ¡å™¨ç»å¸¸ä½¿ç”¨çš„ï¼Œè€Œåœ¨æ¨¡å—åŒ–ï¼ˆDLLï¼‰ä¸­ï¼ŒPHP æ˜¯ä¸ Web æœåŠ¡å™¨ä¸€èµ·å¯åŠ¨å¹¶è¿è¡Œçš„ã€‚ï¼ˆå®ƒæ˜¯ apache åœ¨ CGI çš„åŸºç¡€ä¸Šè¿›è¡Œçš„ä¸€ç§æ‰©å±•ï¼ŒåŠ å¿« PHP çš„è¿è¡Œæ•ˆç‡ï¼‰ã€‚</p><h4 id="1-5-ISAPI-æ¨¡å¼"><a href="#1-5-ISAPI-æ¨¡å¼" class="headerlink" title="1.5 ISAPI æ¨¡å¼"></a>1.5 ISAPI æ¨¡å¼</h4><p>ISAPIï¼ˆInternet Server Application Program Interfaceï¼‰æ˜¯å¾®è½¯æä¾›çš„ä¸€å¥—é¢å‘ Internet æœåŠ¡çš„ API æ¥å£ï¼Œä¸€ä¸ª ISAPI çš„ DLLï¼Œå¯ä»¥åœ¨è¢«ç”¨æˆ·è¯·æ±‚æ¿€æ´»åé•¿é©»å†…å­˜ï¼Œç­‰å¾…ç”¨æˆ·çš„å¦ä¸€ä¸ªè¯·æ±‚ï¼Œè¿˜å¯ä»¥åœ¨ä¸€ä¸ª DLL é‡Œè®¾ç½®å¤šä¸ªç”¨æˆ·è¯·æ±‚å¤„ç†å‡½æ•°ï¼Œæ­¤å¤–ï¼ŒISAPI çš„ DLL åº”ç”¨ç¨‹åºå’Œ WWW æœåŠ¡å™¨å¤„äºåŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œæ•ˆç‡è¦æ˜¾è‘—é«˜äº CGIã€‚ï¼ˆç”±äºå¾®è½¯çš„æ’ä»–æ€§ï¼Œåªèƒ½è¿è¡Œäº windows ç¯å¢ƒï¼‰<br>PHP ä½œä¸º Apache æ¨¡å—ï¼ŒApache æœåŠ¡å™¨åœ¨ç³»ç»Ÿå¯åŠ¨åï¼Œé¢„å…ˆç”Ÿæˆå¤šä¸ªè¿›ç¨‹å‰¯æœ¬é©»ç•™åœ¨å†…å­˜ä¸­ï¼Œä¸€æ—¦æœ‰è¯·æ±‚å‡ºç°ï¼Œå°±ç«‹å³ä½¿ç”¨è¿™äº›ç©ºä½™çš„å­è¿›ç¨‹è¿›è¡Œå¤„ç†ï¼Œè¿™æ ·å°±ä¸å­˜åœ¨ç”Ÿæˆå­è¿›ç¨‹é€ æˆçš„å»¶è¿Ÿäº†ã€‚è¿™äº›æœåŠ¡å™¨å‰¯æœ¬åœ¨å¤„ç†å®Œä¸€æ¬¡ HTTP è¯·æ±‚ä¹‹åå¹¶ä¸ç«‹å³é€€å‡ºï¼Œè€Œæ˜¯åœç•™åœ¨è®¡ç®—æœºä¸­ç­‰å¾…ä¸‹æ¬¡è¯·æ±‚ã€‚å¯¹äºå®¢æˆ·æµè§ˆå™¨çš„è¯·æ±‚ååº”æ›´å¿«ï¼Œæ€§èƒ½è¾ƒé«˜ã€‚</p><h3 id="4-PHP-ä»£ç çš„æ‰§è¡Œæµç¨‹"><a href="#4-PHP-ä»£ç çš„æ‰§è¡Œæµç¨‹" class="headerlink" title="4. PHP ä»£ç çš„æ‰§è¡Œæµç¨‹"></a>4. PHP ä»£ç çš„æ‰§è¡Œæµç¨‹</h3><ul><li><a href="http://blog.csdn.net/a2534725767/article/details/55194582">http://blog.csdn.net/a2534725767/article/details/55194582</a></li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css">1<span class="hljs-selector-class">.Scanning</span>(<span class="hljs-selector-tag">Lexing</span>) ,å°†<span class="hljs-selector-tag">PHP</span>ä»£ç è½¬æ¢ä¸ºè¯­è¨€ç‰‡æ®µ(<span class="hljs-selector-tag">Tokens</span>)<br>2<span class="hljs-selector-class">.Parsing</span>, å°†<span class="hljs-selector-tag">Tokens</span>è½¬æ¢æˆç®€å•è€Œæœ‰æ„ä¹‰çš„è¡¨è¾¾å¼<br>3<span class="hljs-selector-class">.Compilation</span>, å°†è¡¨è¾¾å¼ç¼–è¯‘æˆ<span class="hljs-selector-tag">Opocdes</span><br>4<span class="hljs-selector-class">.Execution</span>, é¡ºæ¬¡æ‰§è¡Œ<span class="hljs-selector-tag">Opcodes</span>ï¼Œæ¯æ¬¡ä¸€æ¡ï¼Œä»è€Œå®ç°<span class="hljs-selector-tag">PHP</span>è„šæœ¬çš„åŠŸèƒ½ã€‚<br></code></pre></td></tr></table></figure><h3 id="5-PHP-ä¸-Golang-çš„åŒºåˆ«"><a href="#5-PHP-ä¸-Golang-çš„åŒºåˆ«" class="headerlink" title="5. PHP ä¸ Golang çš„åŒºåˆ«"></a>5. PHP ä¸ Golang çš„åŒºåˆ«</h3><h4 id="å‚è€ƒåšæ–‡"><a href="#å‚è€ƒåšæ–‡" class="headerlink" title="å‚è€ƒåšæ–‡"></a>å‚è€ƒåšæ–‡</h4><ul><li><a href="http://www.yinwang.org/blog-cn/2014/04/18/golang">å¯¹ Go è¯­è¨€çš„ç»¼åˆè¯„ä»·</a></li><li><a href="https://www.zhihu.com/question/21409296">Go è¯­è¨€çš„ä¼˜åŠ¿åœ¨å“ªé‡Œï¼Ÿ</a></li><li><a href="http://blog.csdn.net/liigo/article/details/23699459">æˆ‘ä¸ºä»€ä¹ˆæ”¾å¼ƒ Go è¯­è¨€</a></li><li><a href="http://blog.csdn.net/a82168506/article/details/6664714">php çš„ä¼˜ç¼ºç‚¹</a></li><li><a href="http://www.cnblogs.com/xiaotaoing/p/6687418.html">php ä¼˜ç¼ºç‚¹</a></li></ul><blockquote><p>é¢è¯•çš„æ—¶å€™åŸºæœ¬ä¸Šä¸Šé¢è¯´åˆ°çš„éƒ½è¯´åˆ°äº†ä¸€äº›ä½†æ˜¯é¢è¯•çš„æ—¶å€™é€»è¾‘è¿˜æ˜¯ä¸å¤Ÿæ¸…æ™°</p></blockquote><h3 id="6-æ·±åº¦ä¼˜å…ˆéå†ä¸å¹¿åº¦ä¼˜å…ˆéå†"><a href="#6-æ·±åº¦ä¼˜å…ˆéå†ä¸å¹¿åº¦ä¼˜å…ˆéå†" class="headerlink" title="6. æ·±åº¦ä¼˜å…ˆéå†ä¸å¹¿åº¦ä¼˜å…ˆéå†"></a>6. æ·±åº¦ä¼˜å…ˆéå†ä¸å¹¿åº¦ä¼˜å…ˆéå†</h3><ul><li><a href="http://www.cnblogs.com/biyeymyhjob/archive/2012/07/18/2596983.html">http://www.cnblogs.com/biyeymyhjob/archive/2012/07/18/2596983.html</a></li></ul><h4 id="a-DFS"><a href="#a-DFS" class="headerlink" title="a. DFS"></a>a. DFS</h4><p>ï¼ˆ1ï¼‰è®¿é—®é¡¶ç‚¹ vï¼›<br>ï¼ˆ2ï¼‰ä» v çš„æœªè¢«è®¿é—®çš„é‚»æ¥ç‚¹ä¸­é€‰å–ä¸€ä¸ªé¡¶ç‚¹ wï¼Œä» w å‡ºå‘è¿›è¡Œæ·±åº¦ä¼˜å…ˆéå†ï¼›<br>ï¼ˆ3ï¼‰é‡å¤ä¸Šè¿°ä¸¤æ­¥ï¼Œç›´è‡³å›¾ä¸­æ‰€æœ‰å’Œ v æœ‰è·¯å¾„ç›¸é€šçš„é¡¶ç‚¹éƒ½è¢«è®¿é—®åˆ°ã€‚</p><h4 id="b-BFS"><a href="#b-BFS" class="headerlink" title="b. BFS"></a>b. BFS</h4><p>ï¼ˆ1ï¼‰é¡¶ç‚¹ v å…¥é˜Ÿåˆ—ã€‚<br>ï¼ˆ2ï¼‰å½“é˜Ÿåˆ—éç©ºæ—¶åˆ™ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™ç®—æ³•ç»“æŸã€‚<br>ï¼ˆ3ï¼‰å‡ºé˜Ÿåˆ—å–å¾—é˜Ÿå¤´é¡¶ç‚¹ vï¼›è®¿é—®é¡¶ç‚¹ v å¹¶æ ‡è®°é¡¶ç‚¹ v å·²è¢«è®¿é—®ã€‚<br>ï¼ˆ4ï¼‰æŸ¥æ‰¾é¡¶ç‚¹ v çš„ç¬¬ä¸€ä¸ªé‚»æ¥é¡¶ç‚¹ colã€‚<br>ï¼ˆ5ï¼‰è‹¥ v çš„é‚»æ¥é¡¶ç‚¹ col æœªè¢«è®¿é—®è¿‡çš„ï¼Œåˆ™ col å…¥é˜Ÿåˆ—ã€‚<br>ï¼ˆ6ï¼‰ç»§ç»­æŸ¥æ‰¾é¡¶ç‚¹ v çš„å¦ä¸€ä¸ªæ–°çš„é‚»æ¥é¡¶ç‚¹ colï¼Œè½¬åˆ°æ­¥éª¤ï¼ˆ5ï¼‰ã€‚<br>ç›´åˆ°é¡¶ç‚¹ v çš„æ‰€æœ‰æœªè¢«è®¿é—®è¿‡çš„é‚»æ¥ç‚¹å¤„ç†å®Œã€‚è½¬åˆ°æ­¥éª¤ï¼ˆ2ï¼‰ã€‚<br>å¹¿åº¦ä¼˜å…ˆéå†å›¾æ˜¯ä»¥é¡¶ç‚¹ v ä¸ºèµ·å§‹ç‚¹ï¼Œç”±è¿‘è‡³è¿œï¼Œä¾æ¬¡è®¿é—®å’Œ v æœ‰è·¯å¾„ç›¸é€šè€Œä¸”è·¯å¾„é•¿åº¦ä¸º 1ï¼Œ2ï¼Œâ€¦â€¦çš„é¡¶ç‚¹ã€‚ä¸ºäº†ä½¿â€œå…ˆè¢«è®¿é—®é¡¶ç‚¹çš„é‚»æ¥ç‚¹â€å…ˆäºâ€œåè¢«è®¿é—®é¡¶ç‚¹çš„é‚»æ¥ç‚¹â€è¢«è®¿é—®ï¼Œéœ€è®¾ç½®é˜Ÿåˆ—å­˜å‚¨è®¿é—®çš„é¡¶ç‚¹ã€‚</p><h3 id="7-æµè§ˆå™¨è¾“å…¥ä¸€ä¸ª-URL-ä¹‹åå‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…"><a href="#7-æµè§ˆå™¨è¾“å…¥ä¸€ä¸ª-URL-ä¹‹åå‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…" class="headerlink" title="7. æµè§ˆå™¨è¾“å…¥ä¸€ä¸ª URL ä¹‹åå‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…"></a>7. æµè§ˆå™¨è¾“å…¥ä¸€ä¸ª URL ä¹‹åå‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…</h3><ul><li><a href="http://www.cnblogs.com/wenanry/archive/2010/02/25/1673368.html">http://www.cnblogs.com/wenanry/archive/2010/02/25/1673368.html</a></li></ul><h3 id="8-éå†ä¸€ä¸ªç›®å½•ä¸‹é¢æ‰€æœ‰çš„æ–‡ä»¶ä»¥åŠæ–‡ä»¶å¤¹"><a href="#8-éå†ä¸€ä¸ªç›®å½•ä¸‹é¢æ‰€æœ‰çš„æ–‡ä»¶ä»¥åŠæ–‡ä»¶å¤¹" class="headerlink" title="8. éå†ä¸€ä¸ªç›®å½•ä¸‹é¢æ‰€æœ‰çš„æ–‡ä»¶ä»¥åŠæ–‡ä»¶å¤¹"></a>8. éå†ä¸€ä¸ªç›®å½•ä¸‹é¢æ‰€æœ‰çš„æ–‡ä»¶ä»¥åŠæ–‡ä»¶å¤¹</h3><blockquote><p>é¢è¯•çš„æ—¶å€™å†™äº†ä¸€ä¸ª DFSï¼Œä¸€ä¸‹è¢«é—®åˆ° BFS æ€ä¹ˆå†™çš„æ—¶å€™çŸ­è·¯äº†ï¼Œæ²¡æœ‰æƒ³èµ·äº†ï¼Œå…¶å®å®ç°çš„æ–¹æ³•ä¸éš¾ï¼Œå‚è€ƒé—®é¢˜ 6</p></blockquote><h3 id="å…¶å®è¿˜æœ‰å…¶ä»–çš„é—®é¢˜ï¼Œä¸è¿‡å¿˜äº†"><a href="#å…¶å®è¿˜æœ‰å…¶ä»–çš„é—®é¢˜ï¼Œä¸è¿‡å¿˜äº†" class="headerlink" title="å…¶å®è¿˜æœ‰å…¶ä»–çš„é—®é¢˜ï¼Œä¸è¿‡å¿˜äº†"></a>å…¶å®è¿˜æœ‰å…¶ä»–çš„é—®é¢˜ï¼Œä¸è¿‡å¿˜äº†</h3><h2 id="ä¸‰é¢-20min"><a href="#ä¸‰é¢-20min" class="headerlink" title="ä¸‰é¢[20min]"></a>ä¸‰é¢[20min]</h2><blockquote><p>ä¸‰é¢æ²¡æœ‰è¢«é—®åˆ°æŠ€æœ¯ç»†èŠ‚</p></blockquote><h3 id="0-è‡ªæˆ‘ä»‹ç»-1"><a href="#0-è‡ªæˆ‘ä»‹ç»-1" class="headerlink" title="0. è‡ªæˆ‘ä»‹ç»"></a>0. è‡ªæˆ‘ä»‹ç»</h3><h3 id="1-ç®€å•çš„ä»‹ç»äº†ä¸€ä¸ªé¡¹ç›®"><a href="#1-ç®€å•çš„ä»‹ç»äº†ä¸€ä¸ªé¡¹ç›®" class="headerlink" title="1. ç®€å•çš„ä»‹ç»äº†ä¸€ä¸ªé¡¹ç›®"></a>1. ç®€å•çš„ä»‹ç»äº†ä¸€ä¸ªé¡¹ç›®</h3><h3 id="2-åœ¨å¹³æ—¶åšé¡¹ç›®çš„æ—¶å€™é‡åˆ°çš„éš¾ç‚¹"><a href="#2-åœ¨å¹³æ—¶åšé¡¹ç›®çš„æ—¶å€™é‡åˆ°çš„éš¾ç‚¹" class="headerlink" title="2. åœ¨å¹³æ—¶åšé¡¹ç›®çš„æ—¶å€™é‡åˆ°çš„éš¾ç‚¹"></a>2. åœ¨å¹³æ—¶åšé¡¹ç›®çš„æ—¶å€™é‡åˆ°çš„éš¾ç‚¹</h3><p>å‡ ä¸ªæ–¹é¢ç®€å•è®²äº†ä¸€ä¸‹ï¼Œå›¢é˜Ÿåä½œçš„éš¾ç‚¹ï¼ŒæŠ€æœ¯éš¾ç‚¹ï¼Œå¿ƒç†éš¾ç‚¹</p><h3 id="3-å›¢é˜Ÿåˆä½œå½“ä¸­å¦‚æœç¢°åˆ°ä¸€ä¸ª-BUGï¼Œä½†æ˜¯å¼€å‘äººå‘˜è§‰å¾—ä¸é‡è¦ï¼Œä½ è§‰å¾—é‡è¦æ€ä¹ˆç­ï¼Ÿ"><a href="#3-å›¢é˜Ÿåˆä½œå½“ä¸­å¦‚æœç¢°åˆ°ä¸€ä¸ª-BUGï¼Œä½†æ˜¯å¼€å‘äººå‘˜è§‰å¾—ä¸é‡è¦ï¼Œä½ è§‰å¾—é‡è¦æ€ä¹ˆç­ï¼Ÿ" class="headerlink" title="3. å›¢é˜Ÿåˆä½œå½“ä¸­å¦‚æœç¢°åˆ°ä¸€ä¸ª BUGï¼Œä½†æ˜¯å¼€å‘äººå‘˜è§‰å¾—ä¸é‡è¦ï¼Œä½ è§‰å¾—é‡è¦æ€ä¹ˆç­ï¼Ÿ"></a>3. å›¢é˜Ÿåˆä½œå½“ä¸­å¦‚æœç¢°åˆ°ä¸€ä¸ª BUGï¼Œä½†æ˜¯å¼€å‘äººå‘˜è§‰å¾—ä¸é‡è¦ï¼Œä½ è§‰å¾—é‡è¦æ€ä¹ˆç­ï¼Ÿ</h3><p>åšæŒä¸æ”¾è¿‡ä¸ºåº•çº¿ï¼Œæ¢ä½æ€è€ƒï¼Œä»¥äº§å“å’Œç”¨æˆ·çš„è§’åº¦åŠè¯´å¼€å‘</p><h3 id="4-å¯¹åŠ ç­æœ‰ä»€ä¹ˆçœ‹æ³•ï¼Ÿ"><a href="#4-å¯¹åŠ ç­æœ‰ä»€ä¹ˆçœ‹æ³•ï¼Ÿ" class="headerlink" title="4. å¯¹åŠ ç­æœ‰ä»€ä¹ˆçœ‹æ³•ï¼Ÿ"></a>4. å¯¹åŠ ç­æœ‰ä»€ä¹ˆçœ‹æ³•ï¼Ÿ</h3><p>æ­£å¸¸ç°è±¡ï¼Œå®Œå…¨å¯ä»¥æ¥å—</p><h3 id="5-ä¸ºä»€ä¹ˆæƒ³å»æ·±åœ³ï¼Ÿ"><a href="#5-ä¸ºä»€ä¹ˆæƒ³å»æ·±åœ³ï¼Ÿ" class="headerlink" title="5. ä¸ºä»€ä¹ˆæƒ³å»æ·±åœ³ï¼Ÿ"></a>5. ä¸ºä»€ä¹ˆæƒ³å»æ·±åœ³ï¼Ÿ</h3><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>é¢è¯•</tag>
      
      <tag>ç§‹æ‹›</tag>
      
      <tag>ç™¾åº¦</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é—ä¼ ç®—æ³•</title>
    <link href="/post/34642.html"/>
    <url>/post/34642.html</url>
    
    <content type="html"><![CDATA[<h2 id="å®ç°ç¤ºä¾‹-Golang"><a href="#å®ç°ç¤ºä¾‹-Golang" class="headerlink" title="å®ç°ç¤ºä¾‹-Golang"></a>å®ç°ç¤ºä¾‹-Golang</h2><p><a href="https://github.com/mohuishou/algorithm/tree/master/GA">github</a></p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> GA<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;math&quot;</span><br><span class="hljs-string">&quot;math/rand&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> (<br>groupSize      <span class="hljs-keyword">int</span>      <span class="hljs-comment">//ç§ç¾¤å¤§å°</span><br>chromosomeSize <span class="hljs-keyword">int</span>      <span class="hljs-comment">//æŸ“è‰²ä½“é•¿åº¦</span><br>selectRand     <span class="hljs-keyword">float64</span>  <span class="hljs-comment">//è½®ç›˜é€‰æ‹©æ¦‚ç‡</span><br>crossRand      <span class="hljs-keyword">float64</span>  <span class="hljs-comment">//äº¤å‰æ¦‚ç‡</span><br>mutationRand   <span class="hljs-keyword">float64</span>  <span class="hljs-comment">//å˜å¼‚æ¦‚ç‡</span><br>group          []Person <span class="hljs-comment">//ç§ç¾¤</span><br>bestPerson     Person   <span class="hljs-comment">//å½“å‰æœ€å¥½çš„ä¸ªä½“</span><br>r              *rand.Rand<br>)<br><br><span class="hljs-comment">//Person ä¸ªä½“</span><br><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>chromosome []<span class="hljs-keyword">int</span>   <span class="hljs-comment">//æŸ“è‰²ä½“</span><br>value      <span class="hljs-keyword">float64</span> <span class="hljs-comment">//é€‚åº”å€¼</span><br>&#125;<br><br><span class="hljs-comment">//Init åˆå§‹åŒ–å‡½æ•°</span><br><span class="hljs-comment">//åˆå§‹åŒ–è®¾ç½®ç§ç¾¤å¤§å°ã€è½®ç›˜é€‰æ‹©æ¦‚ç‡ã€äº¤å‰æ¦‚ç‡å·²ç»å˜å¼‚çš„æ¦‚ç‡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Init</span><span class="hljs-params">(GroupSize, ChromosomeSize <span class="hljs-keyword">int</span>, SelectRand, CrossRand, MutationRand <span class="hljs-keyword">float64</span>)</span></span> &#123;<br>groupSize = GroupSize<br>crossRand = CrossRand<br>selectRand = SelectRand<br>mutationRand = MutationRand<br>chromosomeSize = ChromosomeSize<br>r = rand.New(rand.NewSource(time.Now().UnixNano()))<br>bestPerson.chromosome = <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, chromosomeSize)<br>&#125;<br><br><span class="hljs-comment">//InitGroup åˆå§‹åŒ–ç§ç¾¤</span><br><span class="hljs-comment">//æ ¹æ®ç§ç¾¤å¤§å°éšæœºäº§ç”Ÿä¸€äº›ä¸ªä½“å¡«å……</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitGroup</span><span class="hljs-params">()</span></span> &#123;<br>group = <span class="hljs-built_in">make</span>([]Person, groupSize)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; groupSize; i++ &#123;<br>group[i].chromosome = <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, chromosomeSize)<br><span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; chromosomeSize; j++ &#123;<br><span class="hljs-keyword">if</span> r.Float64() &gt; selectRand &#123;<br>group[i].chromosome[j] = <span class="hljs-number">1</span><br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">//Fitness è®¡ç®—é€‚åº”å€¼</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Fitness</span><span class="hljs-params">(person Person)</span> <span class="hljs-title">float64</span></span> &#123;<br>x := decode(person)<br><span class="hljs-keyword">return</span> x + <span class="hljs-number">10</span>*math.Sin(<span class="hljs-number">5</span>*x) + <span class="hljs-number">7</span>*math.Cos(<span class="hljs-number">4</span>*x)<br>&#125;<br><br><span class="hljs-comment">//è§£ç </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">decode</span><span class="hljs-params">(person Person)</span> <span class="hljs-title">float64</span></span> &#123;<br><span class="hljs-keyword">var</span> sum <span class="hljs-keyword">float64</span><br><span class="hljs-comment">//è§£ç </span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; chromosomeSize; i++ &#123;<br><span class="hljs-comment">//äºŒè¿›åˆ¶æŸ“è‰²ä½“è½¬åè¿›åˆ¶å€¼</span><br><span class="hljs-keyword">if</span> person.chromosome[i] == <span class="hljs-number">1</span> &#123;<br>sum = sum + math.Pow(<span class="hljs-number">2.0</span>, <span class="hljs-keyword">float64</span>(i))<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> sum * <span class="hljs-number">9</span> / (math.Pow(<span class="hljs-number">2.0</span>, <span class="hljs-number">14.0</span>) - <span class="hljs-number">1</span>)<br>&#125;<br><br><span class="hljs-comment">//Select é€‰æ‹©</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Select</span><span class="hljs-params">()</span></span> &#123;<br>newGroup := <span class="hljs-built_in">make</span>([]Person, groupSize)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; groupSize; i++ &#123;<br>newGroup[i].chromosome = <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, chromosomeSize)<br>rnd := r.Float64()<br><br>A:<br><span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; groupSize; j++ &#123;<br><span class="hljs-keyword">if</span> group[j].value &gt; rnd*bestPerson.value &#123;<br><span class="hljs-built_in">copy</span>(newGroup[i].chromosome, group[j].chromosome)<br><span class="hljs-keyword">break</span> A<br>&#125;<br><span class="hljs-keyword">if</span> j == groupSize<span class="hljs-number">-1</span> &#123;<br><span class="hljs-built_in">copy</span>(newGroup[i].chromosome, bestPerson.chromosome)<br>&#125;<br>&#125;<br>&#125;<br>group = newGroup<br>newGroup = <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">//Cross äº¤å‰</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Cross</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; groupSize; i = i + <span class="hljs-number">2</span> &#123;<br><span class="hljs-keyword">if</span> r.Float64() &lt; crossRand &#123;<br>crossPosition := r.Intn(chromosomeSize - <span class="hljs-number">1</span>)<br><span class="hljs-keyword">if</span> crossPosition == <span class="hljs-number">0</span> || crossPosition == <span class="hljs-number">1</span> &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-comment">//äº¤å‰</span><br><span class="hljs-keyword">for</span> j := crossPosition; j &lt; chromosomeSize; j++ &#123;<br>tmp := group[i].chromosome[j]<br>group[i].chromosome[j] = group[i+<span class="hljs-number">1</span>].chromosome[j]<br>group[i+<span class="hljs-number">1</span>].chromosome[j] = tmp<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">//Mutation å˜å¼‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Mutation</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; groupSize; i++ &#123;<br><span class="hljs-keyword">if</span> r.Float64() &lt; mutationRand &#123;<br>mutationPosition := r.Intn(chromosomeSize - <span class="hljs-number">1</span>)<br><br><span class="hljs-comment">//å•ç‚¹å˜å¼‚</span><br><span class="hljs-keyword">if</span> group[i].chromosome[mutationPosition] == <span class="hljs-number">0</span> &#123;<br>group[i].chromosome[mutationPosition] = <span class="hljs-number">1</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>group[i].chromosome[mutationPosition] = <span class="hljs-number">0</span><br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">//GA é—ä¼ ç®—æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GA</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">//åˆå§‹åŒ–</span><br>Init(<span class="hljs-number">100</span>, <span class="hljs-number">14</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.05</span>)<br><span class="hljs-comment">//åˆå§‹åŒ–ç§ç¾¤</span><br>InitGroup()<br><br><span class="hljs-comment">//é—ä¼ å¾ªç¯</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">200</span>; i++ &#123;<br><br><span class="hljs-comment">//è®¡ç®—é€‚åº”å€¼</span><br><span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; groupSize; j++ &#123;<br>group[j].value = Fitness(group[j])<br><br><span class="hljs-comment">//ä¿å­˜å½“å‰æœ€å¥½çš„ä¸ªä½“</span><br><span class="hljs-keyword">if</span> group[j].value &gt; bestPerson.value &#123;<br><span class="hljs-built_in">copy</span>(bestPerson.chromosome, group[j].chromosome)<br>bestPerson.value = group[j].value<br>fmt.Println(<span class="hljs-string">&quot;ç¬¬&quot;</span>, i, <span class="hljs-string">&quot;ä»£æœ€å¥½ä¸ªä½“ï¼š&quot;</span>, bestPerson.value, <span class="hljs-string">&quot; &quot;</span>, decode(bestPerson))<br>&#125;<br>&#125;<br><br><span class="hljs-comment">//é€‰æ‹©</span><br>Select()<br><br><span class="hljs-comment">//äº¤å‰</span><br>Cross()<br><br><span class="hljs-comment">//å˜å¼‚</span><br>Mutation()<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>ç®—æ³•</tag>
      
      <tag>é—ä¼ ç®—æ³•</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æœ€çŸ­è·¯å¾„ç®—æ³•SPFA</title>
    <link href="/post/21230.html"/>
    <url>/post/21230.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>å‰é¢è¯´äº†å•æºæœ€çŸ­è·¯å¾„ç®—æ³• Dijkstraï¼Œä»¥åŠå¤šæºæœ€çŸ­è·¯å¾„ç®—æ³• Floydï¼Œä½†æ˜¯éƒ½ä¸èƒ½é€‚ç”¨äºæœ‰è´Ÿæƒè¾¹å­˜åœ¨çš„æƒ…å†µï¼Œè¿™é‡Œå®ç°ä¸€ä¸‹æ˜¯è¥¿å—äº¤é€šå¤§å­¦æ®µå‡¡ä¸äº 1994 å¹´å‘è¡¨çš„ SPFAï¼ˆShortest Path Faster Algorithmï¼‰ç®—æ³•ã€‚è¯¥ç®—æ³•åœ¨ Bellman-ford ç®—æ³•çš„åŸºç¡€ä¸ŠåŠ ä¸Šä¸€ä¸ªé˜Ÿåˆ—ä¼˜åŒ–ï¼Œå‡å°‘äº†å†—ä½™çš„æ¾å¼›æ“ä½œã€‚</p></blockquote><blockquote><p>spfa å¯ä»¥é€‚ç”¨äºæœ‰è´Ÿæƒè¾¹å­˜åœ¨çš„æƒ…å†µï¼Œä½†æ˜¯æ— æ³•æ±‚è§£å­˜åœ¨è´Ÿæƒå›è·¯çš„æƒ…å†µï¼Œä½†æ˜¯å¯ä»¥åˆ¤æ–­</p></blockquote><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>åªè¦æœ€çŸ­è·¯å¾„å­˜åœ¨ï¼ŒSPFA ç®—æ³•å¿…å®šèƒ½æ±‚å‡ºæœ€å°å€¼ã€‚è¯æ˜ï¼šæ¯æ¬¡å°†ç‚¹æ”¾å…¥é˜Ÿå°¾ï¼Œéƒ½æ˜¯ç»è¿‡æ¾å¼›æ“ä½œè¾¾åˆ°çš„ã€‚æ¢è¨€ä¹‹ï¼Œæ¯æ¬¡çš„ä¼˜åŒ–å°†ä¼šæœ‰æŸä¸ªç‚¹ v çš„æœ€çŸ­è·¯å¾„ä¼°è®¡å€¼ d[v]å˜å°ã€‚æ‰€ä»¥ç®—æ³•çš„æ‰§è¡Œä¼šä½¿ d è¶Šæ¥è¶Šå°ã€‚ç”±äºæˆ‘ä»¬å‡å®šå›¾ä¸­ä¸å­˜åœ¨è´Ÿæƒå›è·¯ï¼Œæ‰€ä»¥æ¯ä¸ªç»“ç‚¹éƒ½æœ‰æœ€çŸ­è·¯å¾„å€¼ã€‚å› æ­¤ï¼Œç®—æ³•ä¸ä¼šæ— é™æ‰§è¡Œä¸‹å»ï¼Œéšç€ d å€¼çš„é€æ¸å˜å°ï¼Œç›´åˆ°åˆ°è¾¾æœ€çŸ­è·¯å¾„å€¼æ—¶ï¼Œç®—æ³•ç»“æŸï¼Œè¿™æ—¶çš„æœ€çŸ­è·¯å¾„ä¼°è®¡å€¼å°±æ˜¯å¯¹åº”ç»“ç‚¹çš„æœ€çŸ­è·¯å¾„å€¼ã€‚</p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="github"><a href="#github" class="headerlink" title="github"></a><a href="https://github.com/mohuishou/algorithm/tree/master/ShortestPath/Floyd">github</a></h3><h3 id="BFS"><a href="#BFS" class="headerlink" title="BFS"></a>BFS</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs go">q := list.New()<br>q.PushBack(s)<br><br><span class="hljs-comment">//å¾ªç¯è·³å‡ºæ¡ä»¶ï¼šé˜Ÿåˆ—ä¸ºç©º</span><br><span class="hljs-keyword">for</span> q.Len() != <span class="hljs-number">0</span> &#123;<br>u := q.Front().Value.(Graph.VextexType)<br>q.Remove(q.Front())<br><br><span class="hljs-comment">//é‡Šæ”¾å¯¹ç‚¹uçš„æ ‡è®°</span><br>visited[u] = <span class="hljs-literal">false</span><br><br>e := graph.G[u].FisrtEdge<br><br><span class="hljs-keyword">for</span> e != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">//è¿™æ¡è¾¹ä¸‹çš„é¡¶ç‚¹</span><br>v := e.V<br><br><span class="hljs-comment">//å¦‚æœå½“å‰ç‚¹çš„è·ç¦»åŠ ä¸Šè¾¹çš„è·ç¦»å°äºä¹‹å‰è¯¥ç‚¹çš„è·ç¦»ï¼Œé‚£ä¹ˆå°±æ›´æ–°è¯¥ç‚¹çš„è·ç¦»</span><br><span class="hljs-keyword">if</span> dist[v] &gt; dist[u]+e.Weight &#123;<br>dist[v] = dist[u] + e.Weight <span class="hljs-comment">//æ›´æ–°è¯¥ç‚¹è·ç¦»</span><br>path[v] = u                  <span class="hljs-comment">//æ›´æ–°çˆ¶èŠ‚ç‚¹</span><br><br><span class="hljs-comment">//å¦‚æœé¡¶ç‚¹ä¸åœ¨é˜Ÿå†…ï¼Œåˆ™å°†é¡¶ç‚¹å…¥é˜Ÿ</span><br><span class="hljs-keyword">if</span> visited[v] == <span class="hljs-literal">false</span> &#123;<br>q.PushBack(v) <span class="hljs-comment">//å°†è¯¥ç‚¹å…¥é˜Ÿ</span><br>visited[v] = <span class="hljs-literal">true</span><br>count[v]++<br><br><span class="hljs-comment">//å‡ºç°è´Ÿç¯ï¼ŒæŠ¥é”™</span><br><span class="hljs-keyword">if</span> count[v] &gt; graph.VNum &#123;<br><span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;å­˜åœ¨è´Ÿç¯ï¼&quot;</span>)<br>&#125;<br>&#125;<br>&#125;<br>e = e.Next<br>&#125;<br><br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br></code></pre></td></tr></table></figure><h3 id="DFS"><a href="#DFS" class="headerlink" title="DFS"></a>DFS</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go">visited[u] = <span class="hljs-literal">true</span><br>e := graph.G[u].FisrtEdge<br><span class="hljs-keyword">for</span> e != <span class="hljs-literal">nil</span> &#123;<br>v := e.V<br><span class="hljs-keyword">if</span> dist[v] &gt; dist[u]+e.Weight &#123;<br>dist[v] = dist[u] + e.Weight <span class="hljs-comment">//æ›´æ–°è¯¥ç‚¹è·ç¦»</span><br>path[v] = u                  <span class="hljs-comment">//æ›´æ–°çˆ¶èŠ‚ç‚¹</span><br><span class="hljs-keyword">if</span> visited[v] == <span class="hljs-literal">false</span> &#123;<br>count[v]++<br><span class="hljs-keyword">if</span> count[v] &gt; graph.VNum &#123;<br><span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;å­˜åœ¨è´Ÿç¯ï¼&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">//æ³¨æ„DFSçš„ç»“æœä¸èƒ½ç›´æ¥returnï¼Œç›´æ¥returnçš„æ—¶å€™å›æº¯çš„æ—¶å€™å°±æ²¡æœ‰åŠæ³•åœ¨ä¸Šä¸€çº§é‡æ–°æ‰¾å€¼äº†</span><br>err := DFS(v)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br>&#125;<br>e = e.Next<br>&#125;<br>visited[u] = <span class="hljs-literal">false</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>ç®—æ³•</tag>
      
      <tag>å›¾</tag>
      
      <tag>æœ€çŸ­è·¯å¾„</tag>
      
      <tag>spfa</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æœ€çŸ­è·¯å¾„ç®—æ³•-Floyd</title>
    <link href="/post/60101.html"/>
    <url>/post/60101.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>åœ¨ä¸Šä¸€ç¯‡å½“ä¸­è®²äº† Dijkstra ç®—æ³•ï¼ŒDijkstra é€‚ç”¨äºå¯¹äºå•æºè·¯å¾„çš„æ±‚å–ï¼Œä½†æ˜¯å¯¹äºä»»æ„ä¸¤ä¸ªç‚¹ä¹‹é—´çš„æœ€å°è·¯å¾„å‘¢ï¼Ÿé¦–å…ˆæƒ³åˆ°çš„å½“ç„¶æ˜¯ç›´æ¥ä½¿ç”¨å¤šæ¬¡çš„ Dijkstra ç®—æ³•æ¥æ±‚å–ä»»æ„ä¸¤ç‚¹ä¹‹é—´çš„æœ€çŸ­è·¯å¾„ï¼Œä½†æ˜¯è¿™æ ·ä¸‹æ¥æ—¶é—´å¤æ‚åº¦ä¼šæ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥ä½¿ç”¨ä¸€ç§æ–°çš„ç®—æ³•ï¼ŒFloyd ç®—æ³•æ¥æ±‚å–æœ€çŸ­è·¯å¾„</p></blockquote><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>Floyd ç®—æ³•æ˜¯ä¸€ä¸ªç»å…¸çš„åŠ¨æ€è§„åˆ’ç®—æ³•ã€‚ç”¨é€šä¿—çš„è¯­è¨€æ¥æè¿°çš„è¯ï¼Œé¦–å…ˆæˆ‘ä»¬çš„ç›®æ ‡æ˜¯å¯»æ‰¾ä»ç‚¹ i åˆ°ç‚¹ j çš„æœ€çŸ­è·¯å¾„ã€‚ä»åŠ¨æ€è§„åˆ’çš„è§’åº¦çœ‹é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºè¿™ä¸ªç›®æ ‡é‡æ–°åšä¸€ä¸ªè¯ é‡Š<br>ä»ä»»æ„èŠ‚ç‚¹ i åˆ°ä»»æ„èŠ‚ç‚¹ j çš„æœ€çŸ­è·¯å¾„ä¸å¤–ä¹ 2 ç§å¯èƒ½:</p><ul><li>1.ç›´æ¥ä» i åˆ° jï¼Œ</li><li>2.ä» i ç»è¿‡è‹¥å¹²ä¸ªèŠ‚ç‚¹ k åˆ° jã€‚<br>æ‰€ä»¥ï¼Œæˆ‘ä»¬å‡è®¾ Dis(i,j)ä¸ºèŠ‚ç‚¹ u åˆ°èŠ‚ç‚¹ v çš„æœ€çŸ­è·¯å¾„çš„è·ç¦»ï¼Œå¯¹äºæ¯ä¸€ä¸ªèŠ‚ç‚¹ kï¼Œæˆ‘ä»¬æ£€æŸ¥ Dis(i,k) + Dis(k,j) &lt; Dis(i,j)æ˜¯å¦æˆç«‹ï¼Œå¦‚æœæˆç«‹ï¼Œè¯æ˜ä» i åˆ° k å†åˆ° j çš„è·¯å¾„æ¯” i ç›´æ¥åˆ° j çš„è·¯å¾„çŸ­ï¼Œæˆ‘ä»¬ä¾¿è®¾ç½® Dis(i,j) = Dis(i,k) + Dis(k,j)ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå½“æˆ‘ä»¬éå†å®Œæ‰€æœ‰èŠ‚ç‚¹ kï¼ŒDis(i,j)ä¸­è®°å½•çš„ä¾¿æ˜¯ i åˆ° j çš„æœ€çŸ­è·¯å¾„çš„è·ç¦»ã€‚</li></ul><h2 id="ç®—æ³•æè¿°ï¼š"><a href="#ç®—æ³•æè¿°ï¼š" class="headerlink" title="ç®—æ³•æè¿°ï¼š"></a>ç®—æ³•æè¿°ï¼š</h2><p>a.ä»ä»»æ„ä¸€æ¡å•è¾¹è·¯å¾„å¼€å§‹ã€‚æ‰€æœ‰ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»æ˜¯è¾¹çš„æƒï¼Œå¦‚æœä¸¤ç‚¹ä¹‹é—´æ²¡æœ‰è¾¹ç›¸è¿ï¼Œåˆ™æƒä¸ºæ— ç©·å¤§ã€‚ ã€€ã€€<br>b.å¯¹äºæ¯ä¸€å¯¹é¡¶ç‚¹ u å’Œ vï¼Œçœ‹çœ‹æ˜¯å¦å­˜åœ¨ä¸€ä¸ªé¡¶ç‚¹ w ä½¿å¾—ä» u åˆ° w å†åˆ° v æ¯”å·±çŸ¥çš„è·¯å¾„æ›´çŸ­ã€‚å¦‚æœæ˜¯æ›´æ–°å®ƒã€‚</p><h2 id="Golang-å®ç°"><a href="#Golang-å®ç°" class="headerlink" title="Golang å®ç°"></a>Golang å®ç°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ShortestPath<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;errors&quot;</span><br><br><span class="hljs-string">&quot;github.com/mohuishou/algorithm/GraphMatrix&quot;</span><br>)<br><br><span class="hljs-comment">//Floyd æ±‚å–å¤šæºæœ€çŸ­è·¯å¾„</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Floyd</span><span class="hljs-params">(graph GraphMatrix.Graph, dist [][]GraphMatrix.EdgeType, path [][]<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">error</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; graph.VNum; i++ &#123;<br><span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; graph.VNum; j++ &#123;<br>path[i][j] = <span class="hljs-number">-1</span><br>dist[i][j] = graph.G[i][j]<br>&#125;<br>&#125;<br><br>    <span class="hljs-comment">//æ³¨æ„ï¼Œkå¿…é¡»æ”¾åœ¨æœ€å¤–å±‚ï¼Œå¦‚æœæ”¾åœ¨æœ€é‡Œå±‚ä¼šè¿‡æ—©çš„ç¡®è®¤ä¸¤ç‚¹çš„æœ€çŸ­è·¯å¾„</span><br><span class="hljs-keyword">for</span> k := <span class="hljs-number">0</span>; k &lt; graph.VNum; k++ &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; graph.VNum; i++ &#123;<br><span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; graph.VNum; j++ &#123;<br><br><span class="hljs-comment">//æ‰¾åˆ°æ›´çŸ­çš„è·¯å¾„</span><br><span class="hljs-keyword">if</span> dist[i][k]+dist[k][j] &lt; dist[i][j] &#123;<br>dist[i][j] = dist[i][k] + dist[k][j]<br><br><span class="hljs-comment">//å‘ç°è´Ÿå€¼åœˆ</span><br><span class="hljs-keyword">if</span> i == j &amp;&amp; dist[i][j] &lt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;å­˜åœ¨è´Ÿå€¼åœˆ&quot;</span>)<br>&#125;<br>path[i][j] = k<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">//GetPathForFloyd è·å–è·¯å¾„</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPathForFloyd</span><span class="hljs-params">(path [][]<span class="hljs-keyword">int</span>, s, t <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(tPath []<span class="hljs-keyword">int</span>)</span></span> &#123;<br>tPath = <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-number">1</span>)<br>tPath[<span class="hljs-number">0</span>] = s<br><span class="hljs-keyword">for</span> &#123;<br>s = path[s][t]<br><span class="hljs-keyword">if</span> s == <span class="hljs-number">-1</span> || s == t &#123;<br>tPath = <span class="hljs-built_in">append</span>(tPath, t)<br><span class="hljs-keyword">return</span> tPath<br>&#125;<br>tPath = <span class="hljs-built_in">append</span>(tPath, s)<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>ç®—æ³•</tag>
      
      <tag>å›¾</tag>
      
      <tag>æœ€çŸ­è·¯å¾„</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é‚»æ¥è¡¨-Golang</title>
    <link href="/post/18885.html"/>
    <url>/post/18885.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€ç®€å•ç›´æ¥çš„åŠæ³•ä¸€èˆ¬å°±æ˜¯ä½¿ç”¨é‚»æ¥çŸ©é˜µçš„åŠæ³•æ¥è¡¨ç¤ºå›¾ï¼Œä½†æ˜¯å¯¹äºç¨€ç–å›¾æ¥è¯´è¾¹çš„æ•°ç›®æƒ³å¯¹æ¥è¯´æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨é‚»æ¥çŸ©é˜µçš„åŠæ³•ä¼šæ¯”è¾ƒæµªè´¹èµ„æºï¼Œæ‰€ä»¥è¿™é‡Œé‡‡ç”¨é‚»æ¥è¡¨</p></blockquote><h2 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h2><p><a href="https://github.com/mohuishou/algorithm/tree/master/Graph">https://github.com/mohuishou/algorithm/tree/master/Graph</a></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> Graph<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;bufio&quot;</span><br><span class="hljs-string">&quot;io&quot;</span><br><span class="hljs-string">&quot;os&quot;</span><br><span class="hljs-string">&quot;strconv&quot;</span><br><span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-comment">// EdgeType è¾¹çš„æƒå€¼ç±»å‹</span><br><span class="hljs-keyword">type</span> EdgeType <span class="hljs-keyword">int</span><br><br><span class="hljs-comment">// VextexType é¡¶ç‚¹ç±»å‹å®šä¹‰</span><br><span class="hljs-keyword">type</span> VextexType <span class="hljs-keyword">int</span><br><br><span class="hljs-comment">// VextexDataType é¡¶ç‚¹å€¼ç±»å‹å®šä¹‰</span><br><span class="hljs-keyword">type</span> VextexDataType <span class="hljs-keyword">int</span><br><br><span class="hljs-comment">//EdgeNode è¾¹çš„èŠ‚ç‚¹</span><br><span class="hljs-keyword">type</span> EdgeNode <span class="hljs-keyword">struct</span> &#123;<br>Weight EdgeType   <span class="hljs-comment">//æƒå€¼</span><br>V      VextexType <span class="hljs-comment">//æŒ‡å‘å‚¨å­˜è¯¥é¡¶ç‚¹çš„ä¸‹æ ‡</span><br>Next   *EdgeNode  <span class="hljs-comment">//æŒ‡å‘ä¸‹ä¸€æ¡è¾¹</span><br>&#125;<br><br><span class="hljs-comment">//VextexNode é¡¶ç‚¹èŠ‚ç‚¹å®šä¹‰</span><br><span class="hljs-keyword">type</span> VextexNode <span class="hljs-keyword">struct</span> &#123;<br>data      VextexDataType <span class="hljs-comment">//é¡¶ç‚¹çš„å€¼</span><br>FisrtEdge *EdgeNode      <span class="hljs-comment">//è¯¥é¡¶ç‚¹æŒ‡å‘çš„ç¬¬ä¸€æ¡è¾¹</span><br>&#125;<br><br><span class="hljs-comment">//Graph å›¾</span><br><span class="hljs-keyword">type</span> Graph <span class="hljs-keyword">struct</span> &#123;<br>VNum, ENum <span class="hljs-keyword">int</span>          <span class="hljs-comment">//é¡¶ç‚¹æ•°ç›®ï¼Œè¾¹æ•°ç›®</span><br>G          []VextexNode <span class="hljs-comment">//é‚»æ¥è¡¨</span><br>&#125;<br><br><span class="hljs-comment">//CreateGraph åˆ›å»ºé‚»æ¥è¡¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateGraph</span><span class="hljs-params">(VNum <span class="hljs-keyword">int</span>)</span> <span class="hljs-params">(graph Graph)</span></span> &#123;<br>graph.VNum = VNum<br>graph.G = <span class="hljs-built_in">make</span>([]VextexNode, VNum)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; VNum; i++ &#123;<br>graph.G[i] = VextexNode&#123;&#125;<br>&#125;<br><span class="hljs-keyword">return</span> graph<br>&#125;<br><br><span class="hljs-comment">//AddEdge æ·»åŠ è¾¹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(graph Graph)</span> <span class="hljs-title">AddEdge</span><span class="hljs-params">(s, t VextexType, weight EdgeType)</span></span> &#123;<br>edge := &amp;EdgeNode&#123;V: t, Weight: weight&#125;<br><br><span class="hljs-comment">//æ·»åŠ è¾¹åˆ°å¤´éƒ¨</span><br>edge.Next = graph.G[s].FisrtEdge<br>graph.G[s].FisrtEdge = edge<br>&#125;<br><br><span class="hljs-comment">//BuildGraph é€šè¿‡è¯»å–æ–‡ä»¶å»ºå›¾</span><br><span class="hljs-comment">//æ–‡ä»¶æ ¼å¼è¦æ±‚:</span><br><span class="hljs-comment">//é¡¶ç‚¹ä¸ªæ•° è¾¹æ•°</span><br><span class="hljs-comment">//é¡¶ç‚¹v1 é¡¶ç‚¹V2 è¾¹çš„æƒé‡</span><br><span class="hljs-comment">//...</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BuildGraph</span><span class="hljs-params">(path <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(graph Graph)</span></span> &#123;<br>f, err := os.Open(path)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>buf := bufio.NewReader(f)<br><br>i := <span class="hljs-number">0</span><br><span class="hljs-comment">//è¾¹çš„æ•°ç›®</span><br><span class="hljs-keyword">for</span> &#123;<br>line, err := buf.ReadString(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> err == io.EOF &#123;<br><span class="hljs-keyword">return</span> graph<br>&#125;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>line = strings.TrimSpace(line)<br>data := strings.Split(line, <span class="hljs-string">&quot; &quot;</span>)<br><span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span> &#123;<br>n, err := strconv.Atoi(data[<span class="hljs-number">0</span>])<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>graph = CreateGraph(n)<br><br>graph.ENum, err = strconv.Atoi(data[<span class="hljs-number">1</span>])<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> i &lt;= graph.ENum &#123;<br>s, err := strconv.Atoi(data[<span class="hljs-number">0</span>])<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>t, err := strconv.Atoi(data[<span class="hljs-number">1</span>])<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>weight, err := strconv.Atoi(data[<span class="hljs-number">2</span>])<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>graph.AddEdge(VextexType(s), VextexType(t), EdgeType(weight))<br>&#125;<br>i++<br>&#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>ç®—æ³•</tag>
      
      <tag>å›¾</tag>
      
      <tag>é‚»æ¥è¡¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æœ€çŸ­è·¯å¾„ç®—æ³•-Dijkstra</title>
    <link href="/post/13459.html"/>
    <url>/post/13459.html</url>
    
    <content type="html"><![CDATA[<h2 id="ç®—æ³•æè¿°"><a href="#ç®—æ³•æè¿°" class="headerlink" title="ç®—æ³•æè¿°"></a>ç®—æ³•æè¿°</h2><blockquote><p>è¿™ä¸ªç®—æ³•æ˜¯é€šè¿‡ä¸ºæ¯ä¸ªé¡¶ç‚¹ v ä¿ç•™ç›®å‰ä¸ºæ­¢æ‰€æ‰¾åˆ°çš„ä» s åˆ° v çš„æœ€çŸ­è·¯å¾„æ¥å·¥ä½œçš„ã€‚åˆå§‹æ—¶ï¼ŒåŸç‚¹ s çš„è·¯å¾„æƒé‡è¢«èµ‹ä¸º 0 ï¼ˆd[s] = 0ï¼‰ã€‚è‹¥å¯¹äºé¡¶ç‚¹ s å­˜åœ¨èƒ½ç›´æ¥åˆ°è¾¾çš„è¾¹ï¼ˆs,mï¼‰ï¼Œåˆ™æŠŠ d[m]è®¾ä¸º wï¼ˆs, mï¼‰,åŒæ—¶æŠŠæ‰€æœ‰å…¶ä»–ï¼ˆs ä¸èƒ½ç›´æ¥åˆ°è¾¾çš„ï¼‰é¡¶ç‚¹çš„è·¯å¾„é•¿åº¦è®¾ä¸ºæ— ç©·å¤§ï¼Œå³è¡¨ç¤ºæˆ‘ä»¬ä¸çŸ¥é“ä»»ä½•é€šå‘è¿™äº›é¡¶ç‚¹çš„è·¯å¾„ï¼ˆå¯¹äºæ‰€æœ‰é¡¶ç‚¹çš„é›†åˆ V ä¸­çš„ä»»æ„é¡¶ç‚¹ vï¼Œ è‹¥ v ä¸ä¸º s å’Œä¸Šè¿° m ä¹‹ä¸€ï¼Œ d[v] = âˆï¼‰ã€‚å½“ç®—æ³•ç»“æŸæ—¶ï¼Œd[v] ä¸­å­˜å‚¨çš„ä¾¿æ˜¯ä» s åˆ° v çš„æœ€çŸ­è·¯å¾„ï¼Œæˆ–è€…å¦‚æœè·¯å¾„ä¸å­˜åœ¨çš„è¯æ˜¯æ— ç©·å¤§ã€‚<br>è¾¹çš„æ‹“å±•æ˜¯ Dijkstra ç®—æ³•çš„åŸºç¡€æ“ä½œï¼šå¦‚æœå­˜åœ¨ä¸€æ¡ä» u åˆ° v çš„è¾¹ï¼Œé‚£ä¹ˆä» s åˆ° v çš„æœ€çŸ­è·¯å¾„å¯ä»¥é€šè¿‡å°†è¾¹ï¼ˆu, vï¼‰æ·»åŠ åˆ°å°¾éƒ¨æ¥æ‹“å±•ä¸€æ¡ä» s åˆ° v çš„è·¯å¾„ã€‚è¿™æ¡è·¯å¾„çš„é•¿åº¦æ˜¯ d[u] + w(u, v)ã€‚å¦‚æœè¿™ä¸ªå€¼æ¯”ç›®å‰å·²çŸ¥çš„ d[v] çš„å€¼è¦å°ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ–°å€¼æ¥æ›¿ä»£å½“å‰ d[v] ä¸­çš„å€¼ã€‚æ‹“å±•è¾¹çš„æ“ä½œä¸€ç›´è¿è¡Œåˆ°æ‰€æœ‰çš„ d[v] éƒ½ä»£è¡¨ä» s åˆ° v çš„æœ€çŸ­è·¯å¾„çš„é•¿åº¦å€¼ã€‚æ­¤ç®—æ³•çš„ç»„ç»‡ä»¤ d[u] è¾¾åˆ°å…¶æœ€ç»ˆå€¼æ—¶ï¼Œæ¯æ¡è¾¹ï¼ˆu, vï¼‰éƒ½åªè¢«æ‹“å±•ä¸€æ¬¡ã€‚<br>ç®—æ³•ç»´æŠ¤ä¸¤ä¸ªé¡¶ç‚¹é›†åˆ S å’Œ Qã€‚é›†åˆ S ä¿ç•™æ‰€æœ‰å·²çŸ¥æœ€å° d[v] å€¼çš„é¡¶ç‚¹ v ï¼Œè€Œé›†åˆ Q åˆ™ä¿ç•™å…¶ä»–æ‰€æœ‰é¡¶ç‚¹ã€‚é›†åˆ S åˆå§‹çŠ¶æ€ä¸ºç©ºï¼Œè€Œåæ¯ä¸€æ­¥éƒ½æœ‰ä¸€ä¸ªé¡¶ç‚¹ä» Q ç§»åŠ¨åˆ° Sã€‚è¿™ä¸ªè¢«é€‰æ‹©çš„é¡¶ç‚¹æ˜¯ Q ä¸­æ‹¥æœ‰æœ€å°çš„ d[u] å€¼çš„é¡¶ç‚¹ã€‚å½“ä¸€ä¸ªé¡¶ç‚¹ u ä» Q ä¸­è½¬ç§»åˆ°äº† S ä¸­ï¼Œç®—æ³•å¯¹ u çš„æ¯æ¡å¤–æ¥è¾¹ (u, v) è¿›è¡Œæ‹“å±•ã€‚</p></blockquote><p>å¦‚ä¸‹å›¾ï¼š<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-142734.gif" alt=""></p><h2 id="ä»£ç å®ç°-Golang"><a href="#ä»£ç å®ç°-Golang" class="headerlink" title="ä»£ç å®ç°-Golang"></a>ä»£ç å®ç°-Golang</h2><p><a href="https://github.com/mohuishou/algorithm/tree/master/ShortestPath">github</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> ShortestPath<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;errors&quot;</span><br><br><span class="hljs-string">&quot;container/list&quot;</span><br><br><span class="hljs-string">&quot;github.com/mohuishou/algorithm/Graph&quot;</span><br>)<br><br><span class="hljs-comment">//INF æ— ç©·å¤§</span><br><span class="hljs-keyword">const</span> INF = <span class="hljs-number">0xffffff</span><br><br><span class="hljs-comment">//Dijkstra ç®—æ³•</span><br><span class="hljs-comment">//ä¸€ç§æ±‚å•æºæœ€çŸ­è·¯å¾„çš„ç®—æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Dijkstra</span><span class="hljs-params">(graph Graph.Graph, s Graph.VextexType, dist []Graph.EdgeType, path []Graph.VextexType)</span></span> &#123;<br>visited := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">bool</span>, graph.VNum)<br><span class="hljs-comment">//åˆå§‹åŒ–</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; graph.VNum; i++ &#123;<br>dist[i] = INF <span class="hljs-comment">//è·ç¦»ä¸ºæ— ç©·å¤§</span><br>path[i] = <span class="hljs-number">-1</span>  <span class="hljs-comment">//æ²¡æœ‰ä¸Šä¸€ä¸ªèŠ‚ç‚¹</span><br>visited[i] = <span class="hljs-literal">false</span><br>&#125;<br>path[s] = s<br>dist[s] = <span class="hljs-number">0</span><br><br><span class="hljs-comment">//ä½¿ç”¨listå®ç°ä¸€ä¸ªé˜Ÿåˆ—æ“ä½œ</span><br>q := list.New()<br><br><span class="hljs-comment">//å°†ç‚¹så…¥é˜Ÿ</span><br>q.PushBack(s)<br><span class="hljs-keyword">for</span> q.Len() != <span class="hljs-number">0</span> &#123;<br>u := q.Front().Value.(Graph.VextexType)<br>q.Remove(q.Front())<br><span class="hljs-comment">//å¦‚æœè¯¥ç‚¹å‘¨å›´çš„ç‚¹å·²ç»èµ°è¿‡ï¼Œåˆ™æ— éœ€å†èµ°</span><br><span class="hljs-keyword">if</span> visited[u] &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br><span class="hljs-comment">//å°†è¯¥ç‚¹åŠ å…¥å·²è§‚å¯Ÿ</span><br>visited[u] = <span class="hljs-literal">true</span><br><br>e := graph.G[u].FisrtEdge<br><br><span class="hljs-keyword">for</span> e != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">//è¿™æ¡è¾¹ä¸‹çš„é¡¶ç‚¹</span><br>v := e.V<br><br><span class="hljs-comment">//å¦‚æœè¯¥ç‚¹å°šæœªèµ°è¿‡ï¼Œå¹¶ä¸”å½“å‰ç‚¹çš„è·ç¦»åŠ ä¸Šè¾¹çš„è·ç¦»å°äºä¹‹å‰è¯¥ç‚¹çš„è·ç¦»ï¼Œé‚£ä¹ˆå°±æ›´æ–°è¯¥ç‚¹çš„è·ç¦»</span><br><span class="hljs-keyword">if</span> visited[v] == <span class="hljs-literal">false</span> &amp;&amp; dist[v] &gt; dist[u]+e.Weight &#123;<br>dist[v] = dist[u] + e.Weight <span class="hljs-comment">//æ›´æ–°è¯¥ç‚¹è·ç¦»</span><br>path[v] = u                  <span class="hljs-comment">//æ›´æ–°çˆ¶èŠ‚ç‚¹</span><br>q.PushBack(v)                <span class="hljs-comment">//å°†è¯¥ç‚¹å…¥é˜Ÿ</span><br>&#125;<br>e = e.Next<br>&#125;<br><br>&#125;<br><br>&#125;<br><br><span class="hljs-comment">//GetPath é€šè¿‡è·¯å¾„è·å¾—åˆ°æŒ‡å®šç›®çš„èŠ‚ç‚¹çš„è·¯å¾„</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPath</span><span class="hljs-params">(path []Graph.VextexType, t Graph.VextexType)</span> <span class="hljs-params">([]Graph.VextexType, error)</span></span> &#123;<br>tPath := <span class="hljs-built_in">make</span>([]Graph.VextexType, <span class="hljs-number">0</span>)<br><span class="hljs-keyword">for</span> &#123;<br>tPath = <span class="hljs-built_in">append</span>(tPath, t)<br><span class="hljs-keyword">if</span> path[t] == <span class="hljs-number">-1</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;ä¸å­˜åœ¨åˆ°è¯¥èŠ‚ç‚¹çš„è·¯å¾„&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> t == path[t] &#123;<br><span class="hljs-keyword">return</span> tPath, <span class="hljs-literal">nil</span><br>&#125;<br>t = path[t]<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>go</tag>
      
      <tag>ç®—æ³•</tag>
      
      <tag>åä¸ºè½¯æŒ‘</tag>
      
      <tag>å›¾</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åä¸ºè½¯æŒ‘2017</title>
    <link href="/post/4976.html"/>
    <url>/post/4976.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>ç¨ç¨æ€»ç»“ä¸€ä¸‹æœ€è¿‘å·®ä¸å¤šå‡ å¤©çš„å¿ƒè·¯å†ç¨‹ï¼Œè™½ç„¶æœ€åæ²¡æœ‰æ‹¿åˆ°åæ¬¡ï¼Œä½†æ˜¯ä»æœ€å¼€å§‹çš„è¿æœ€çŸ­è·¯å¾„æ˜¯ä»€ä¹ˆéƒ½ä¸çŸ¥é“ï¼Œåˆ°ç°åœ¨çš„å·²ç»å¯ä»¥åˆ©ç”¨é—ä¼ ç®—æ³•+æœ€å°è´¹ç”¨æœ€å¤§æµç®—æ³•æ±‚å‡ºä¸€äº›å¯è¡Œçš„è§£ï¼Œå°±çŸ­çŸ­çš„ä¸åˆ°ä¸€å‘¨çš„æ—¶é—´ï¼Œå­¦ä¹ åˆ°äº†å¯ä»¥è¯´ä¹‹å‰ä¸€ä¸ªå­¦æœŸä¹Ÿæœªå¿…èƒ½å¤Ÿå­¦ä¹ åˆ°çš„çŸ¥è¯†ã€‚</p></blockquote><p>è¿™ä¸¤å¤©ä¼šæŠŠæœ€è¿‘å­¦åˆ°çš„ç›¸å…³çŸ¥è¯†è®°å½•åˆ°åšå®¢å½“ä¸­ï¼Œåœ¨è¿™å„¿æš‚ä¸”å…ˆåˆ—ä¸€ä¸ªå¤§çº²ï¼š</p><ul><li><p>æœ€çŸ­è·¯å¾„é—®é¢˜</p><ul><li>Dijkstra</li><li>Floyd</li><li>SPFA</li></ul></li><li><p>ç›¸å…³é—®é¢˜</p><ul><li>æœ€å¤§æµé—®é¢˜</li><li>æœ€å°è´¹ç”¨æœ€å¤§æµé—®é¢˜</li></ul></li><li><p>å¯å‘å¼ç®—æ³•</p><ul><li>é—ä¼ ç®—æ³•</li><li>æ¨¡æ‹Ÿé€€ç«ç®—æ³•</li><li>ç²’å­ç¾¤ç®—æ³•</li></ul><p>ä¸Šé¢éƒ½æ˜¯åœ¨è¿™ä¸ªè¿‡ç¨‹å½“ä¸­ç”¨åˆ°äº†çš„ä¸€äº›ç®—æ³•æˆ–è€…æ˜¯ä¸€äº›é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯åœ¨å¯¹äºè¿™ä¸ªå…·ä½“çš„é—®é¢˜è§£å†³çš„æ—¶å€™è¿˜è¦åšå‡ºä¸€äº›å…·ä½“çš„è°ƒæ•´ï¼Œç›´æ¥å¥—ç”¨æ˜¯ä¸ä¼šå‡ºç»“æœçš„ã€‚</p><p>ä½†æ˜¯å¤§ä½“çš„æ€è·¯å°±æ˜¯å¯å‘å¼ç®—æ³•ç¡®å®šæœåŠ¡å™¨èŠ‚ç‚¹çš„æ•°ç›®ä»¥åŠä½ç½®ï¼Œç„¶åç”¨æœ€å°è´¹ç”¨æœ€å¤§æµå¾—åˆ°èŠ±è´¹ä»¥åŠç»“æœè·¯å¾„ã€‚</p></li></ul><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>ç®—æ³•</tag>
      
      <tag>åä¸ºè½¯æŒ‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åˆ©ç”¨vboxåœ¨winä¸‹æ­å»ºlinuxå¼€å‘ç¯å¢ƒ</title>
    <link href="/post/50696.html"/>
    <url>/post/50696.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>ä¹‹å‰ä¸€ç›´åœ¨ç”¨ deepinï¼Œä½†æ˜¯æœ€è¿‘å› ä¸ºè¦ä½¿ç”¨ win ä¸‹çš„ä¸€äº›è½¯ä»¶å°±ç›´æ¥åˆ‡åˆ° win äº†ï¼Œæƒ³äº†æƒ³å¯ä¸å¯ä»¥ç›´æ¥æ­å»ºä¸€ä¸ª linux ç¯å¢ƒï¼Œåœ¨ windows ä¸‹ç¼–ç å‘¢<br>ç¬¬ä¸€æ¬¡å°è¯•çš„æ˜¯ docker çš„æ–¹æ¡ˆï¼Œä½†æ˜¯æœ€åæ”¾å¼ƒäº†ï¼Œå› ä¸º docker åˆ©ç”¨ vbox å»ºç«‹çš„è™šæ‹Ÿæœºå¯åŠ¨çš„æ—¶å€™æ˜¯ä¸æ˜¯çš„ä¼šå‡ºç°é—®é¢˜ç„¶åå°±é‡å»ºï¼Œååˆ†çš„ä¸ç¨³å®šã€‚<br>æ‰€ä»¥è¿™æ¬¡ç›´æ¥ä½¿ç”¨è™šæ‹Ÿæœºæ­å»º</p></blockquote><h2 id="å‡†å¤‡å·¥å…·"><a href="#å‡†å¤‡å·¥å…·" class="headerlink" title="å‡†å¤‡å·¥å…·"></a>å‡†å¤‡å·¥å…·</h2><ul><li>ubuntu-16.04-server-amd64.iso (åªéœ€è¦å¼€å‘ç¯å¢ƒï¼Œæ‰€ä»¥ä½¿ç”¨ server å°±è¡Œä¸éœ€è¦æ¡Œé¢ç‰ˆ)</li><li>vbox 5.1.10ï¼ˆæˆ‘ä½¿ç”¨çš„æœ€æ–°ç‰ˆï¼‰</li></ul><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>1.å®‰è£… VBox</p><p><em>ä¸å†èµ˜è¿°ï¼Œç›´æ¥é»˜è®¤å°±è¡Œï¼Œæœ€å¥½ä¸è¦å®‰è£…åœ¨ C ç›˜ã€‚å¦‚æœæœ‰é—®é¢˜å¯ä»¥å‚è§ç½‘ä¸Šçš„å…¶ä»–æ•™ç¨‹</em></p><p>2.å®‰è£… UbuntuServer16.04</p><p><em>åšäº†å‡ ä¸ªåŠ¨å›¾</em></p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-142743.gif" alt=""></p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-142745.gif" alt=""></p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-142746.gif" alt=""></p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-142747.gif" alt=""></p><p>3.è®¾ç½®ç½‘å¡</p><p>VBox é»˜è®¤ä½¿ç”¨ NAT æ¨¡å¼ï¼Œä½†æ˜¯è¿™ä¸ªæ¨¡å¼ä¸‹ä¸»æœºæ˜¯ ping ä¸é€šè™šæ‹Ÿæœºçš„ï¼Œæ‰€ä»¥æ–°å»ºä¸€ä¸ª host-only ç½‘å¡ï¼Œä½¿ç”¨åŒç½‘å¡ï¼Œä¸€ä¸ª NAT ç”¨äºä¸Šç½‘ï¼Œä¸€ä¸ª host-only ç”¨äºå’Œä¸»æœºç›¸è¿ï¼Œä¹‹åç›´æ¥ç”¨ xshell è¿æ¥ï¼Œè™šæ‹Ÿæœºåå°æ‰“å¼€å°±è¡Œäº†ã€‚</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-142747.png" alt=""></p><p>è¿›å…¥è™šæ‹Ÿæœºï¼Œä½¿ç”¨<code>ifconfig</code>å‘½ä»¤å‘ç°åªæœ‰ä¸€å¼ ç½‘å¡<code>ifconfig -a</code>å‘ç°è¿˜æœ‰ä¸€å¼ ç½‘å¡<code>enp0s8</code>æœªè¿æ¥ä¸Š</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-142748.png" alt=""></p><p>è¾“å…¥<code>sudo vi /etc/network/interfaces</code></p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-142750.png" alt=""></p><p>æ–°å¢ä¸‹é¢å‡ è¡Œ</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-142751.png" alt=""></p><p>ä¿å­˜é‡å¯</p><p><code>ifconfig</code> æŸ¥çœ‹ä¸€å…±å‡ºç°ä¸‰ä¸ªç½‘å¡<br>ä½¿ç”¨ä¸»æœº ping è™šæ‹Ÿæœºå¯ä»¥ ping é€š</p><p>4.å®‰è£… ssh æœåŠ¡ç«¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt-get update<br>sudo apt-get install openssh-server<br></code></pre></td></tr></table></figure><p>å®‰è£…ä¹‹åå°±å¯ä»¥ä½¿ç”¨ xshell ç­‰å·¥å…·ç›´æ¥è¿æ¥è™šæ‹Ÿæœºäº†</p><p>5.å…±äº«æ–‡ä»¶å¤¹</p><p>(1).éœ€è¦å…ˆå®‰è£… vbox å¢å¼ºç»„ä»¶</p><p>a.å®‰è£…å¢å¼ºç»„ä»¶å‰éœ€è¦å…ˆè£…ä¸€äº›ä¾èµ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt-get install aptitude<br>sudo  aptitude install build-essential linux-headers-$(uname -r) -y<br></code></pre></td></tr></table></figure><p>b.ç‚¹å‡» vbox çš„èœå•ï¼Œæ·»åŠ å¢å¼ºåŠŸèƒ½</p><p>c.æŒ‚è½½å…‰ç›˜</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo mount /dev/cdrom /mnt<br></code></pre></td></tr></table></figure><p>d.å®‰è£…å¢å¼ºåŠŸèƒ½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /mnt<br>sudo ./VBoxLinuxAdditions.run<br></code></pre></td></tr></table></figure><p>å®‰è£…æˆåŠŸï¼Œé‡å¯</p><p>(2).æŒ‚è½½ç£ç›˜</p><p>a.åœ¨ VBox ä¸»ç•Œé¢-&gt;é€‰ä¸­è™šæ‹Ÿæœº-&gt;è®¾ç½®-&gt;å…±äº«æ–‡ä»¶å¤¹-&gt;æ·»åŠ å…±äº«æ–‡ä»¶å¤¹</p><p>b.<br>å‡è®¾å‘½åå…±äº«æ–‡ä»¶å¤¹ä¸º www</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo mkdir /www<br>sudo mount -t vboxsf www /www<br></code></pre></td></tr></table></figure><p>æŒ‚è½½æˆåŠŸ</p><h2 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h2><p>ä¹‹å‰çš„å¯åŠ¨éƒ½æ˜¯æœ‰ç•Œé¢çš„ï¼Œä¹‹åä½¿ç”¨çš„æ—¶å€™å¸Œæœ›ä¸å‡ºç°ç•Œé¢ç›´æ¥åå°è¿è¡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ xshell è¿æ¥å°±å¥½<br>å¤åˆ¶ä¸‹é¢çš„ä»£ç ï¼Œæ–°å»ºä¸€ä¸ª UbuntuServer.bat ç²˜è´´è¿›å»ï¼Œä»¥åç›´æ¥ç‚¹å‡»è¿™ä¸ªè„šæœ¬å°±è¡Œäº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">%VBOX_MSI_INSTALL_PATH%VBoxManage startvm ubuntu --<span class="hljs-built_in">type</span> headless<br></code></pre></td></tr></table></figure><h2 id="END"><a href="#END" class="headerlink" title="END"></a>END</h2><p>åˆ°è¿™å„¿æ•´ä¸ªæµç¨‹å°±ç»“æŸäº†ï¼Œä¹‹åå¯ä»¥æ ¹æ®éœ€æ±‚æ·»åŠ è½¯ä»¶æˆ–è€…æ˜¯ç¯å¢ƒï¼Œä¾‹å¦‚ lnmpã€nodeã€golangã€javaã€gcc ç­‰ç­‰</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>è™šæ‹Ÿæœº</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åœ¨windowså®‰è£…dockertoolï¼Œå¹¶ä¸”é…ç½®æ–‡ä»¶å¤¹å…±äº«</title>
    <link href="/post/7964.html"/>
    <url>/post/7964.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>ä»Šå¤©æŠ˜è…¾äº†å¥½ä¹…ï¼Œç»ˆäºå¥½äº†ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ç‚¹å°é—æ†¾ã€‚</p></blockquote><p>å®ç°ä¸‹é¢å‡ ä¸ªç‚¹</p><ul><li>å®‰è£… dockertool(é€šè¿‡ boot2docker ä»¥åŠ vbox é©±åŠ¨)</li><li>ä½¿ç”¨ kitematic å¯è§†åŒ–ç®¡ç†</li><li>å’Œ windows æœ¬åœ°å…±äº«æ–‡ä»¶å¤¹</li></ul><h2 id="å®‰è£…-dockertool"><a href="#å®‰è£…-dockertool" class="headerlink" title="å®‰è£… dockertool"></a>å®‰è£… dockertool</h2><h3 id="ä¸‹è½½-dockertool"><a href="#ä¸‹è½½-dockertool" class="headerlink" title="ä¸‹è½½ dockertool"></a>ä¸‹è½½ dockertool</h3><p>åœ°å€ä¸€ï¼š<a href="http://get.daocloud.io/#install-docker-for-mac-windows">daocloud åŠ é€Ÿ</a><br>åœ°å€äºŒï¼š<a href="https://github.com/docker/toolbox/releases/tag/v1.12.3">github</a></p><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>åŒå‡»æ–‡ä»¶å®‰è£…å³å¯ï¼Œå¯ä»¥æ›´æ”¹å®‰è£…ä½ç½®çš„é€‰é¡¹ï¼Œå…¶ä½™é»˜è®¤å³å¯<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-142752.png" alt=""><br>å¦‚æœç”µè„‘ä¸Šå·²ç»å®‰è£…äº† vbox å°†ä¸ä¼šå†å®‰è£…ï¼Œå¦‚æœæ²¡æœ‰ vbox å°†åœ¨ C ç›˜å®‰è£… VBoxï¼Œå¦‚æœä¸æƒ³å®‰è£…åˆ° C ç›˜å¯ä»¥æå‰å®‰è£…</p><h3 id="ä½¿ç”¨-kitematic-å¯è§†åŒ–ç®¡ç†"><a href="#ä½¿ç”¨-kitematic-å¯è§†åŒ–ç®¡ç†" class="headerlink" title="ä½¿ç”¨ kitematic å¯è§†åŒ–ç®¡ç†"></a>ä½¿ç”¨ kitematic å¯è§†åŒ–ç®¡ç†</h3><p>docker ToolBox è‡ªå¸¦ kitematic å¯ä»¥ç›´æ¥æ‰“å¼€<br><strong>æ³¨æ„ï¼š</strong> å¦‚æœè®¾ç½®äº†ç¯å¢ƒå˜é‡ MACHINE_STORAGE_PATHï¼Œæ›´æ”¹äº†è™šæ‹Ÿæœºçš„é»˜è®¤ä¿å­˜ä½ç½®ï¼Œkitematic å¯èƒ½ä¼šæ‰“ä¸å¼€ï¼Œå¹¶ä¸”å¯åŠ¨æŠ¥é”™ï¼š<code>Error: write EPROTO</code><br>æš‚æ—¶æ²¡æœ‰æ‰¾åˆ°å¯è¡Œçš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯è¿™æ ·åªæœ‰ kitematic ä¸èƒ½ä½¿ç”¨ï¼Œdocker æ²¡æœ‰å½±å“</p><h3 id="ä½¿ç”¨åŠ é€Ÿå™¨"><a href="#ä½¿ç”¨åŠ é€Ÿå™¨" class="headerlink" title="ä½¿ç”¨åŠ é€Ÿå™¨"></a>ä½¿ç”¨åŠ é€Ÿå™¨</h3><p>åœ¨ä¸ä½¿ç”¨åŠ é€Ÿå™¨çš„æƒ…å†µä¸‹ï¼Œä¼šè‡ªåŠ¨çš„å‘ docker hub æ‹‰å–é•œåƒï¼Œä½†æ˜¯å›½å†…çš„è®¿é—® docker hub çš„é€Ÿåº¦å®åœ¨æ˜¯æœ‰äº›æ…¢ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨<a href="https://www.daocloud.io/mirror#accelerator-doc">daoclou</a>çš„åŠ é€Ÿå™¨<br>æ‰“å¼€ powershell</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker-machine ssh default<br>sudo sed -i <span class="hljs-string">&quot;s|EXTRA_ARGS=&#x27;|EXTRA_ARGS=&#x27;--registry-mirror=åŠ é€Ÿåœ°å€ |g&quot;</span> <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/boot2docker/</span>profile<br><span class="hljs-keyword">exit</span><br>docker-machine restart default<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œï¼šè¿æ¥ sshï¼Œè¿›å…¥è™šæ‹Ÿæœº<br>ç¬¬äºŒè¡Œï¼šæ·»åŠ åŠ é€Ÿå™¨åœ°å€<br>ç¬¬ä¸‰è¡Œï¼šé€€å‡ºè™šæ‹Ÿæœº<br>ç¬¬å››è¡Œï¼šé‡å¯è™šæ‹Ÿæœº</p><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ xshell ç­‰è½¯ä»¶è¿æ¥ä¹‹åç›´æ¥è¾“å…¥</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">sudo sed -i <span class="hljs-string">&quot;s|EXTRA_ARGS=&#x27;|EXTRA_ARGS=&#x27;--registry-mirror=åŠ é€Ÿåœ°å€ |g&quot;</span> <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/boot2docker/</span>profile<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨é€€å‡ºè¿æ¥ï¼Œåœ¨æœ¬æœºç¯å¢ƒä¸‹é‡å¯ docker-machine</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">docker-machine restart <span class="hljs-function"><span class="hljs-keyword">def</span><span class="hljs-title">ault</span></span><br></code></pre></td></tr></table></figure><h2 id="å…±äº«æ–‡ä»¶å¤¹"><a href="#å…±äº«æ–‡ä»¶å¤¹" class="headerlink" title="å…±äº«æ–‡ä»¶å¤¹"></a>å…±äº«æ–‡ä»¶å¤¹</h2><p>å…±äº«æ–‡ä»¶å¤¹æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ä½¿ç”¨ vbox ä¸ä¸»æœºå…±äº«æ–‡ä»¶å¤¹ç„¶ååœ¨è®© docker ä¸ boot2docker è™šæ‹Ÿæœºå…±äº«ï¼Œç¬¬äºŒç§æ˜¯åˆ›å»ºä¸€ä¸ª samba æœåŠ¡ã€‚<br>æˆ‘è¿™é‡Œä½¿ç”¨ç¬¬ä¸€ç§ã€‚</p><p>1.é¦–å…ˆåœ¨ vbox å½“ä¸­æ·»åŠ å…±äº«æ–‡ä»¶å¤¹<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-142753.png" alt=""></p><p>2.ç„¶åè¿›å…¥ powershell æˆ–è€…å…¶ä»–çš„ shell è½¯ä»¶</p><p>è¿›å…¥è™šæ‹Ÿæœº(ä¸è¦ç›´æ¥åœ¨ vbox å½“ä¸­è¿›å…¥ï¼Œç›´æ¥è¿›å…¥å¯èƒ½ä¼šåˆ›å»ºå¤±è´¥)</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">docker-machine ssh <span class="hljs-function"><span class="hljs-keyword">def</span><span class="hljs-title">ault</span></span><br></code></pre></td></tr></table></figure><p>æŒ‚è½½æ–‡ä»¶å¤¹</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">sudo mkdir <span class="hljs-string">/www</span><br>sudo mount -t vboxsf www <span class="hljs-string">/www</span><br></code></pre></td></tr></table></figure><p>www æ˜¯åœ¨ vbo å…±äº«æ–‡ä»¶å¤¹è®¾ç½®çš„ï¼Œ/www æ˜¯åœ¨è™šæ‹Ÿæœºä¸­æ–°å»ºçš„</p><p>æ–‡ä»¶å¤¹æŒ‚è½½æˆåŠŸä¹‹åå°±å¯ä»¥åˆ›å»º docker äº†ï¼Œä½†æ˜¯æ³¨æ„ä¸èƒ½ç›´æ¥åœ¨ kitematic å½“ä¸­åˆ›å»ºï¼Œkitematic å½“ä¸­åªèƒ½æŒ‚è½½<code>C\user</code>ä¸‹çš„ç›®å½•ï¼Œæ‰€ä»¥åªèƒ½æ‰‹åŠ¨åˆ›å»º docker å®¹å™¨<br>ä¾‹å¦‚ï¼š</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">docker run -d -P <span class="hljs-params">--name</span> web -v <span class="hljs-string">/www</span>:<span class="hljs-string">/www</span> webdevops/php-apache-dev<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åœ¨laravel/lumenä¹‹å¤–ä½¿ç”¨Eloquent</title>
    <link href="/post/29454.html"/>
    <url>/post/29454.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>è¿™å‘¨åˆšåšå®Œå­¦æ ¡çš„ä¸€ä¸ªæ™ºèƒ½ç¡¬ä»¶æ¯”èµ›çš„ä½œå“ï¼Œæˆ‘è´Ÿè´£åç«¯æœåŠ¡å™¨ï¼Œä»¥åŠé…å¥— App çš„åˆ¶ä½œã€‚æ•´ä¸ªä¸€å—éƒ½ç”¨ socket è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œä½†æ˜¯å…¶ä¸­æ¶‰åŠåˆ°çš„æ•°æ®åº“çš„æ“ä½œï¼Œæœ€è¿‘ lumen ç”¨çš„æ¯”è¾ƒå¤šï¼Œè§‰å¾—å®ƒçš„æ•°æ®åº“çš„ç»„ä»¶ç‰¹åˆ«æ–¹ä¾¿ï¼Œæ‰€ä»¥å°±æƒ³çœ‹çœ‹èƒ½ä¸èƒ½å•ç‹¬æ‹¿å‡ºæ¥ä½¿ç”¨ã€‚</p></blockquote><p>ç»è¿‡ä¸€ç•ªæŸ¥æ‰¾èµ„æ–™ï¼Œä¸»è¦åˆ†ä¸ºä¸¤æ­¥è¿›è¡Œ</p><h2 id="å®‰è£…ç›¸åº”çš„æ•°æ®åº“åŒ…"><a href="#å®‰è£…ç›¸åº”çš„æ•°æ®åº“åŒ…" class="headerlink" title="å®‰è£…ç›¸åº”çš„æ•°æ®åº“åŒ…"></a>å®‰è£…ç›¸åº”çš„æ•°æ®åº“åŒ…</h2><p><em>è¿™é‡Œä½¿ç”¨ 5.2 çš„åŒ…ï¼Œå¯ä»¥æ›´å…·è‡ªå·±çš„éœ€æ±‚è¿›è¡Œæ›´æ¢</em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">composer require illuminate/database ~5.2<br></code></pre></td></tr></table></figure><h2 id="è®¾ç½®å¯åŠ¨æ–‡ä»¶-start-php"><a href="#è®¾ç½®å¯åŠ¨æ–‡ä»¶-start-php" class="headerlink" title="è®¾ç½®å¯åŠ¨æ–‡ä»¶(start.php)"></a>è®¾ç½®å¯åŠ¨æ–‡ä»¶(start.php)</h2><p>è¿™é‡Œå°†é…ç½®æ–‡ä»¶ä¸å¯åŠ¨æ–‡ä»¶åˆ†å¼€ï¼Œä¹Ÿå¯ä»¥åˆå¹¶åœ¨ä¸€èµ·ã€‚æˆ‘ç›´æ¥ä½¿ç”¨äº†ä¸€ä¸ª php æ–‡ä»¶è¿”å›æ•°ç»„ï¼Œä¹Ÿå¯ä»¥å¼•å…¥<code>vlucas/phpdotenv</code>ä½¿ç”¨.env æ–‡ä»¶æ¥é…ç½®å˜é‡</p><h3 id="start-php"><a href="#start-php" class="headerlink" title="start.php"></a>start.php</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by mohuishou&lt;1<span class="hljs-doctag">@lailin</span>.xyz&gt;.</span><br><span class="hljs-comment"> * User: mohuishou&lt;1<span class="hljs-doctag">@lailin</span>.xyz&gt;</span><br><span class="hljs-comment"> * Date: 2016/11/14 0014</span><br><span class="hljs-comment"> * Time: 18:50</span><br><span class="hljs-comment"> */</span><br><span class="hljs-variable">$database</span> = <span class="hljs-keyword">require_once</span> <span class="hljs-string">&quot;config.php&quot;</span>;<br><br><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Container</span>\<span class="hljs-title">Container</span>;<br><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Capsule</span>\<span class="hljs-title">Manager</span> <span class="hljs-title">as</span> <span class="hljs-title">Capsule</span>;<br><br><span class="hljs-variable">$capsule</span> = <span class="hljs-keyword">new</span> Capsule;<br><br><span class="hljs-comment">// åˆ›å»ºé“¾æ¥</span><br><span class="hljs-variable">$capsule</span>-&gt;addConnection(<span class="hljs-variable">$database</span>);<br><br><span class="hljs-comment">// è®¾ç½®å…¨å±€é™æ€å¯è®¿é—®DB</span><br><span class="hljs-variable">$capsule</span>-&gt;setAsGlobal();<br><br><span class="hljs-comment">// å¯åŠ¨Eloquent</span><br><span class="hljs-variable">$capsule</span>-&gt;bootEloquent();<br></code></pre></td></tr></table></figure><h3 id="config-php"><a href="#config-php" class="headerlink" title="config.php"></a>config.php</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by PhpStorm.</span><br><span class="hljs-comment"> * User: lxl</span><br><span class="hljs-comment"> * Date: 16-11-17</span><br><span class="hljs-comment"> * Time: ä¸‹åˆ8:38</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">return</span> [<br>    <span class="hljs-string">&#x27;driver&#x27;</span> =&gt; <span class="hljs-string">&#x27;mysql&#x27;</span>,<br>    <span class="hljs-string">&#x27;host&#x27;</span> =&gt; <span class="hljs-string">&quot;localhost&quot;</span>,<br>    <span class="hljs-string">&#x27;database&#x27;</span> =&gt; <span class="hljs-string">&quot;smart_lock&quot;</span>,<br>    <span class="hljs-string">&#x27;username&#x27;</span> =&gt; <span class="hljs-string">&quot;root&quot;</span>,<br>    <span class="hljs-string">&#x27;password&#x27;</span> =&gt; <span class="hljs-string">&quot;mima&quot;</span>,<br>    <span class="hljs-string">&#x27;charset&#x27;</span> =&gt; <span class="hljs-string">&#x27;utf8&#x27;</span>,<br>    <span class="hljs-string">&#x27;collation&#x27;</span> =&gt; <span class="hljs-string">&#x27;utf8_unicode_ci&#x27;</span>,<br>    <span class="hljs-string">&#x27;prefix&#x27;</span> =&gt; <span class="hljs-string">&quot;&quot;</span>,<br>];<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>laravel</tag>
      
      <tag>lumen</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>javaç¬”è®°1</title>
    <link href="/post/52826.html"/>
    <url>/post/52826.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>java åˆå­¦ç¬”è®°ï¼Œéšæ‰‹è®°å½•</p></blockquote><ul><li><p>å•å¼•å·è¡¨ç¤ºå­—ç¬¦<code>char</code>ç±»å‹(<em>ä¸å¸¸ç”¨</em>)ï¼ŒåŒå¼•å·æ‰æ˜¯å­—ç¬¦ä¸²</p></li><li><p>float ç±»å‹åé¢è¦æ·»åŠ  f<code>3.14f</code>(<em>ä¸å¸¸ç”¨</em>)ï¼Œä¸æ·»åŠ åç¼€é»˜è®¤ä¸º double</p></li><li><p><code>final</code>è¡¨ç¤ºå¸¸é‡ï¼Œ<code>static final</code>è¡¨ç¤ºç±»å¸¸é‡</p></li><li><p>ä½è¿ç®— - ä¸ï¼š<code>&amp;</code> - æˆ–ï¼š<code>|</code> - éï¼š<code>~</code> - å¼‚æˆ–ï¼š<code>^</code> - å·¦ç§»ï¼š<code>&lt;&lt;</code> - å³ç§»ï¼š<code>&gt;&gt;</code></p></li><li><p>ä¸è¦æŠŠå¸ƒå°”å€¼å¼ºåˆ¶è½¬æ¢ä¸ºä»»ä½•çš„å…¶ä»–æ•°å€¼ï¼Œå¦‚æœè¦è½¬æ¢ä¸º intï¼Œå¯ä»¥ä½¿ç”¨ä¸‰å…ƒè¿ç®—ç¬¦<code>b ? 1:0</code></p></li><li><p>æ•°ç»„çš„å‘½å - <code>int[] a</code>(<em>æ›´å¸¸ç”¨</em>) - <code>int a[]</code></p></li><li><p>æ•°ç»„å¿…é¡»å…ˆåˆå§‹åŒ–æ‰èƒ½ä½¿ç”¨ï¼Œæ²¡æœ‰åˆå§‹åŒ–çš„æ•°ç»„ä¸èƒ½ä½¿ç”¨ - <code>int[] a=new int[100]</code></p></li><li><p>å‘½ä»¤è¡Œå‚æ•°</p></li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>)</span> &#123;&#125;<br></code></pre></td></tr></table></figure><p><em>main å‡½æ•°çš„å‚æ•°ï¼Œargs æ¥å—æ¥è‡ªå‘½ä»¤è¡Œçš„å‚æ•°ï¼Œæ¯ä¸€ä¸ªç©ºæ ¼æ˜¯ä¸€ä¸ªå‚æ•°ï¼Œä½†æ˜¯ç¨‹åºæ–‡ä»¶åä¸åŒ…å«åœ¨å†…</em></p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>ç¬”è®°</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸€é”®è¿ç§»typechoåˆ°hexo</title>
    <link href="/post/59080.html"/>
    <url>/post/59080.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>ä¸ºäº†æ›´å¥½çš„å†™åšå®¢ï¼Œæœ€è¿‘æ‰“ç®—æŠŠåšå®¢é™æ€åŒ–ï¼Œå‘ç°äº† node å†™çš„ hexoã€‚é¡ºä¾¿ä¹Ÿå¯ä»¥ç›´æ¥åˆ©ç”¨ github å’Œ coding çš„ pages æ¥æ­å»ºåšå®¢åŒæ—¶æŠŠä¹‹å‰é—²ç½®çš„æœªå¤‡æ¡ˆåŸŸå<a href="http://lailin.xyz">lailin.xyz</a>åˆ©ç”¨èµ·æ¥.</p></blockquote><p>å†™äº†ä¸€ä¸ª php çš„ typecho ä¸€é”®è½¬æ¢çš„å°ç¨‹åº:<a href="https://github.com/mohuishou/typecho2hexo">github</a></p><h3 id="æ”¯æŒï¼š"><a href="#æ”¯æŒï¼š" class="headerlink" title="æ”¯æŒï¼š"></a>æ”¯æŒï¼š</h3><ul><li>æ–‡æ¡£ä¸€é”®è½¬å­˜ä¸º md æ–‡ä»¶</li><li>å­—ç¬¦ç¼–ç è½¬æ¢ï¼ˆgbk=&gt;utf8ï¼‰</li><li>å›¾ç‰‡/é™„ä»¶ä¸€é”®è½¬å­˜åˆ°æœ¬åœ°</li><li>å›¾ç‰‡/é™„ä»¶ä¸€é”®è½¬å­˜åˆ°ä¸ƒç‰›äº‘</li></ul><h3 id="ä½¿ç”¨è¯´æ˜ï¼š"><a href="#ä½¿ç”¨è¯´æ˜ï¼š" class="headerlink" title="ä½¿ç”¨è¯´æ˜ï¼š"></a>ä½¿ç”¨è¯´æ˜ï¼š</h3><h4 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">git clone https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/mohuishou/</span>typecho2hexo.git<br>composer install<br></code></pre></td></tr></table></figure><h4 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h4><p>å¤åˆ¶ config.example.php å¹¶é‡å‘½åä¸º config.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">return</span> [<br>    <span class="hljs-string">&quot;db&quot;</span>=&gt;[<br>        <span class="hljs-string">&quot;host&quot;</span>=&gt;<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-comment">//æ•°æ®åº“åœ°å€</span><br>        <span class="hljs-string">&quot;port&quot;</span>=&gt;<span class="hljs-number">3306</span>, <span class="hljs-comment">//ç«¯å£å·</span><br>        <span class="hljs-string">&quot;name&quot;</span>=&gt;<span class="hljs-string">&quot;typecho&quot;</span>, <span class="hljs-comment">//æ•°æ®åº“</span><br>        <span class="hljs-string">&quot;user&quot;</span>=&gt;<span class="hljs-string">&quot;root&quot;</span>, <span class="hljs-comment">//æ•°æ®åº“ç”¨æˆ·å</span><br>        <span class="hljs-string">&quot;password&quot;</span>=&gt;<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-comment">//æ•°æ®åº“å¯†ç </span><br>        <span class="hljs-string">&quot;prefix&quot;</span>=&gt;<span class="hljs-string">&quot;typecho&quot;</span>  <span class="hljs-comment">//è¡¨å‰ç¼€</span><br>    ],<br>    <span class="hljs-string">&quot;is_gbk&quot;</span>=&gt;<span class="hljs-literal">false</span>, <span class="hljs-comment">//æ˜¯å¦å¼€å¯gbkè½¬utf8ï¼ˆæœ‰äº›æ•°æ®åº“é‡Œé¢å‚¨å­˜çš„ä¸æ˜¯utf8æ ¼å¼éœ€è¦å¼€å¯è¿™ä¸ªé€‰é¡¹ï¼‰</span><br>    <span class="hljs-comment">//é™„ä»¶ç›¸å…³</span><br>    <span class="hljs-string">&quot;attachment&quot;</span>=&gt;[<br>        <span class="hljs-string">&quot;is_download&quot;</span>=&gt;<span class="hljs-literal">true</span>, <span class="hljs-comment">//æ˜¯å¦ä¸‹è½½é™„ä»¶</span><br>        <span class="hljs-string">&quot;type&quot;</span>=&gt;<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-comment">//é™„ä»¶ä¿å­˜ç±»å‹ï¼šfile æˆ–è€… qiniu</span><br>    ],<br>    <span class="hljs-comment">//ä¸ƒç‰›äº‘å‚¨å­˜ç›¸å…³</span><br>    <span class="hljs-string">&quot;qiniu&quot;</span>=&gt;[<br>        <span class="hljs-string">&quot;access_key&quot;</span>=&gt;<span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;secret_key&quot;</span>=&gt;<span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-string">&quot;bucket_name&quot;</span>=&gt;<span class="hljs-string">&quot;blog&quot;</span>, <span class="hljs-comment">//ä¸ƒç‰›ç©ºé—´å</span><br>        <span class="hljs-string">&quot;domain&quot;</span>=&gt;<span class="hljs-string">&quot;http://&quot;</span> <span class="hljs-comment">//ä¸ƒç‰›å¤–é“¾åŸŸåï¼Œå¿…é¡»è®¾ç½®,å¸¦http://</span><br>    ]<br>];<br></code></pre></td></tr></table></figure><h4 id="è¿è¡Œ"><a href="#è¿è¡Œ" class="headerlink" title="è¿è¡Œ"></a>è¿è¡Œ</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">php index.php <span class="hljs-regexp">//</span>å‘½ä»¤è¡Œ<br></code></pre></td></tr></table></figure><h4 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h4><p>1.å¦‚æœå‡ºç°ä¸Šä¼ é”™è¯¯ï¼Œé™„ä»¶ä¸‹è½½ä½¿ç”¨ curlï¼Œä¸‹è½½æ—¶é—´æœ€é•¿ä¸º 60sï¼Œå¦‚æœæœ‰æ¯”è¾ƒå¤§çš„æ–‡ä»¶æˆ–è€…æ˜¯ç½‘è·¯ç¯å¢ƒä¸å¥½ï¼Œè¯·æ‰‹åŠ¨æ›´æ”¹ä¸€ä¸‹ Lib/Attachment.phpï¼Œå½“ä¸­çš„æ–‡ä»¶æœ€é•¿ä¸‹è½½æ—¶é—´</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">download</span>(<span class="hljs-params"><span class="hljs-variable">$url</span>,<span class="hljs-variable">$filename</span>,<span class="hljs-variable">$dir</span></span>)</span>&#123;<br>    <span class="hljs-variable">$path</span>=<span class="hljs-variable">$dir</span>.<span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-variable">$filename</span>;<br>    <span class="hljs-variable">$ch</span>=curl_init();<br>    <span class="hljs-variable">$timeout</span>=<span class="hljs-number">60</span>; <span class="hljs-comment">//æ–‡ä»¶æœ€é•¿ä¸‹è½½æ—¶é—´</span><br>    curl_setopt(<span class="hljs-variable">$ch</span>,CURLOPT_URL,<span class="hljs-variable">$url</span>);<br>    curl_setopt(<span class="hljs-variable">$ch</span>,CURLOPT_FOLLOWLOCATION,<span class="hljs-number">1</span>);<br>    curl_setopt(<span class="hljs-variable">$ch</span>,CURLOPT_RETURNTRANSFER,<span class="hljs-number">1</span>);<br>    curl_setopt(<span class="hljs-variable">$ch</span>,CURLOPT_CONNECTTIMEOUT,<span class="hljs-variable">$timeout</span>);<br>    <span class="hljs-variable">$res</span>=curl_exec(<span class="hljs-variable">$ch</span>);<br>    curl_close(<span class="hljs-variable">$ch</span>);<br>    <span class="hljs-comment">//æ£€æŸ¥æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨</span><br>    <span class="hljs-keyword">if</span>(!file_exists(<span class="hljs-variable">$dir</span>)) mkdir(<span class="hljs-variable">$dir</span>);<br>    file_put_contents(<span class="hljs-variable">$path</span>,<span class="hljs-variable">$res</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$path</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    
    <tags>
      
      <tag>hexo</tag>
      
      <tag>php</tag>
      
      <tag>typecho</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åœ¨deepinä¸‹å®‰è£…shadowsocks-qt5</title>
    <link href="/post/46155.html"/>
    <url>/post/46155.html</url>
    
    <content type="html"><![CDATA[<h1 id="åœ¨-deepin-ä¸‹å®‰è£…-ss-qt5"><a href="#åœ¨-deepin-ä¸‹å®‰è£…-ss-qt5" class="headerlink" title="åœ¨ deepin ä¸‹å®‰è£… ss-qt5"></a>åœ¨ deepin ä¸‹å®‰è£… ss-qt5</h1><blockquote><p>å®˜ç½‘çš„æ–‡æ¡£ä¸Š Ubuntu å¯ä»¥é€šè¿‡æ·»åŠ ç§æœ‰æºçš„æ–¹å¼å®‰è£…ï¼Œdeepin ä¸è¡Œï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦ç›´æ¥ä»æºç ç¼–è¯‘å®‰è£…ã€‚</p></blockquote><h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><p>æ£€æŸ¥ä¸‹é¢ä¸¤ä¸ªè½¯ä»¶æ˜¯å¦å·²ç»å®‰è£…ï¼Œdeepin è‡ªå¸¦çš„æ²¡æœ‰å®‰è£…ä¸Š</p><ul><li>git</li><li>g++</li></ul><h2 id="ä¸‹è½½æºä»£ç "><a href="#ä¸‹è½½æºä»£ç " class="headerlink" title="ä¸‹è½½æºä»£ç "></a>ä¸‹è½½æºä»£ç </h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">git clone https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/shadowsocks/</span>shadowsocks-qt5.git<br></code></pre></td></tr></table></figure><p><strong>wiki åœ°å€</strong>ï¼š<a href="https://github.com/shadowsocks/shadowsocks-qt5/wiki">https://github.com/shadowsocks/shadowsocks-qt5/wiki</a></p><h2 id="ç¼–è¯‘å®‰è£…"><a href="#ç¼–è¯‘å®‰è£…" class="headerlink" title="ç¼–è¯‘å®‰è£…"></a>ç¼–è¯‘å®‰è£…</h2><p>1.æŒ‰ç…§ wiki è¿›è¡Œå®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt-get install qt5-qmake qtbase5-dev libqrencode-dev libqtshadowsocks-dev libappindicator-dev libzbar-dev libbotan1.10-dev<br></code></pre></td></tr></table></figure><p>ä¼šå‡ºç°é”™è¯¯ï¼Œæ²¡æœ‰<code>libqtshadowsocks-dev</code>è¿™ä¸ªè½¯ä»¶åŒ…ï¼Œæ‰€ä»¥è¿™ä¸ªåŒ…æˆ‘ä»¬ä¹Ÿéœ€è¦è‡ªè¡Œç¼–è¯‘</p><p>2.ä¸‹è½½<code>libqtshadowsocks-dev</code>æºä»£ç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/shadowsocks/libQtShadowsocks.git<br></code></pre></td></tr></table></figure><p>3.å®‰è£…ç¼–è¯‘æ‰€éœ€çš„å…¶ä»–ç»„ä»¶</p><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs q">sudo apt-<span class="hljs-built_in">get</span> install qt5-qmake qtbase5-<span class="hljs-built_in">dev</span> libqrencode-<span class="hljs-built_in">dev</span>  libappindicator-<span class="hljs-built_in">dev</span> libzbar-<span class="hljs-built_in">dev</span> libbotan1<span class="hljs-number">.10</span>-<span class="hljs-built_in">dev</span><br></code></pre></td></tr></table></figure><p>4.ç¼–è¯‘<code>libqtshadowsocks-dev</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> libQtShadowsocks<br>dpkg-buildpackage -uc -us -b<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘æˆåŠŸä¹‹åä¼šåœ¨ä¸Šä¸€çº§ç›®å½•å‘ç°ä¸‰ä¸ª deb åŒ…ï¼ˆå®‰è£…åä¸¤ä¸ªï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">shadowsocks-libqtshadowsocks_1.9.0-1_amd64.deb<br>libqtshadowsocks-dev_1.9.0-1_amd64.deb<br>libqtshadowsocks_1.9.0-1_amd64.deb<br></code></pre></td></tr></table></figure><p>5.å®‰è£…æ‰€éœ€çš„ deb åŒ…(æ³¨æ„é¡ºåº)</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> dpkg -i libqtshadowsocks_<span class="hljs-number">1</span>.<span class="hljs-number">9</span>.<span class="hljs-number">0</span>-<span class="hljs-number">1</span>_amd<span class="hljs-number">64</span>.deb<br><span class="hljs-attribute">sudo</span> dpkg -i libqtshadowsocks-dev_<span class="hljs-number">1</span>.<span class="hljs-number">9</span>.<span class="hljs-number">0</span>-<span class="hljs-number">1</span>_amd<span class="hljs-number">64</span>.deb<br></code></pre></td></tr></table></figure><p>6.ç¼–è¯‘<code>shadowsocks-qt5</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> shadowsocks-qt5<br>dpkg-buildpackage -uc -us -b<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å®Œæˆä¹‹åä¼šåœ¨ä¸Šä¸€çº§ç›®å½•å‡ºç°ä¸€ä¸ª deb åŒ…<code>shadowsocks-qt5_2.7.0-1_amd64.deb</code>ï¼Œç‰ˆæœ¬ä¸åŒåŒ…åå¯èƒ½ä¼šæœ‰ä¸€äº›å°çš„åŒºåˆ«</p><p>7.å®‰è£…è¯•è¯• shadowsocks-qt5</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> dpkg -i shadowsocks-qt<span class="hljs-number">5</span>_<span class="hljs-number">2</span>.<span class="hljs-number">7</span>.<span class="hljs-number">0</span>-<span class="hljs-number">1</span>_amd<span class="hljs-number">64</span>.deb<br></code></pre></td></tr></table></figure><p><strong>å¤§åŠŸå‘Šæˆï¼Œæœ€ååœ¨å¯åŠ¨å™¨é‡Œé¢å°±å¯ä»¥çœ‹åˆ° ss-qt5 çš„å›¾æ ‡äº†ï¼Œæœ€åç»™å‡ºä¸Šé¢æåˆ°çš„æˆ‘ç¼–è¯‘æˆåŠŸçš„ç›¸å…³è½¯ä»¶åŒ…ï¼Œä¸ä¿è¯æœ‰ç”¨^^</strong></p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ss</tag>
      
      <tag>deepin</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å››å·å¤§å­¦é”æ·windowsè§£é™¤å¤šç½‘å¡é™åˆ¶</title>
    <link href="/post/18280.html"/>
    <url>/post/18280.html</url>
    
    <content type="html"><![CDATA[<h3 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h3><blockquote><p>æ¬åˆ°æœ›æ±Ÿæ ¡åŒºä¹‹åæ ¡å›­ç½‘å¿«äº†å¥½å¤šï¼Œä½†æ˜¯éœ€è¦é”æ·è®¤è¯ï¼Œé”æ·è¿™ä¸ªå‘è´§éœ€è¦é™åˆ¶å¤šç½‘å¡ï¼Œè€Œä¸”ç¨‹åºçš„å ç”¨å®åœ¨å¤ªå¤§ï¼Œååˆ†çš„ä¸æ–¹ä¾¿ã€‚ä½¿ç”¨ wifi å…±äº«è½¯ä»¶å¯ä»¥å¼€å¯ wifi çƒ­ç‚¹ï¼Œä½†æ˜¯ä¼šå‡ºç°è¿æ¥æ²¡å¤šä¹…æ²¡ç½‘çš„æƒ…å†µ</p></blockquote><p>æˆ‘ä½¿ç”¨çš„é”æ·ç‰ˆæœ¬æ˜¯ v4.96</p><h3 id="è§£å†³çš„é—®é¢˜"><a href="#è§£å†³çš„é—®é¢˜" class="headerlink" title="è§£å†³çš„é—®é¢˜"></a>è§£å†³çš„é—®é¢˜</h3><p>ç†è®ºä¸Šè¯´å¤šç½‘å¡é™åˆ¶çš„é—®é¢˜éƒ½å¯ä»¥è§£å†³æ‰ï¼š</p><ul><li>wifi çƒ­ç‚¹å…±äº«</li><li>VPNï¼ˆFQï¼‰</li><li>è™šæ‹Ÿæœº host-only</li></ul><h3 id="ä½¿ç”¨æ–¹æ³•"><a href="#ä½¿ç”¨æ–¹æ³•" class="headerlink" title="ä½¿ç”¨æ–¹æ³•"></a>ä½¿ç”¨æ–¹æ³•</h3><p>1.é¦–å…ˆä½ å·²ç»å®‰è£…äº†é”æ·çš„å®¢æˆ·ç«¯å¹¶ä¸”ä½¿ç”¨å…¶å¯ä»¥è®¤è¯ä¸Šç½‘</p><p><em>æ›´æ–°ï¼šå¯ä»¥å°è¯•ç›´æ¥ä»ç¬¬äº”æ­¥å¼€å§‹ï¼Œå› ä¸ºæˆ‘å‘ç°å¥½åƒç›´æ¥ç»“æŸæ‰ç½‘å…¶å®ä¹Ÿä¸ä¼šæ‰</em></p><p>2.ç„¶åä¸‹è½½ mentohust win ç‰ˆæœ¬ï¼ˆ<a href="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/MentoHUST%EF%BC%88WINDOWS%E7%89%88%EF%BC%89.rar">ç‚¹å‡»ä¸‹è½½</a>ï¼‰<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/4058054721.png" alt="1ecdddfa-ec9a-473b-9a13-3b2e5c3b4fdb.png"></p><p>3.mentohust çš„ä½¿ç”¨æ–¹æ³•ç½‘ä¸Šæœ‰å¾ˆå¤šäº†è¿™é‡Œä¸åœ¨èµ˜è¿°ï¼Œ<a href="http://jingyan.baidu.com/article/47a29f2416ba37c015239957.html">ç™¾åº¦ç»éªŒ</a></p><p>4.éœ€è¦æ³¨æ„è¿™é‡Œæœ‰ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œç›´æ¥æŒ‰ç…§ä¸Šé¢é“¾æ¥çš„æ–¹æ³•æ˜¯æ²¡æœ‰åŠæ³•è®¤è¯æˆåŠŸçš„ï¼Œåœ¨è®¾ç½®å¥½ä¹‹åç‚¹å‡»è®¤è¯å‰ï¼Œéœ€è¦å…ˆä½¿ç”¨é”æ·æˆåŠŸè®¤è¯ä¸Šç½‘ï¼Œç„¶åå†ä½¿ç”¨è¿™ä¸ªè½¯ä»¶è®¤è¯ 5.è®¤è¯æˆåŠŸä¹‹åæ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨ï¼Œæ‰¾åˆ° 8021.exe è¿™ä¸ªè¿›ç¨‹å¹²æ‰å°±å¯ä»¥äº† 6.ç„¶åä½¿ç”¨ win10 è‡ªå¸¦çš„ç§»åŠ¨çƒ­ç‚¹ä¹Ÿå¯ä»¥å¼€å¯çƒ­ç‚¹ä¸éœ€è¦å•ç‹¬ä¸‹è½½ wifi å…±äº«è½¯ä»¶<br>(å¦‚æœæ²¡æœ‰ï¼Œ<del>ä½¿ç”¨ wifi è½¯ä»¶,æµ‹è¯•çŒè±¹ wifi è¿˜æ˜¯ä¼šå‡ºç°æ²¡æœ‰ç½‘çš„æƒ…å†µ</del> æˆ–è€…ç›´æ¥ç”¨å‘½ä»¤è¡Œå¼€å¯ä¹Ÿæ˜¯å¯ä»¥çš„)<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/3439227638.png" alt="1610c2cb-221c-42b6-8824-c47176e27cde.png"></p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>å¤§å­¦</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç ´è§£</tag>
      
      <tag>å››å·å¤§å­¦</tag>
      
      <tag>é”æ·</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>phpè®¾è®¡æ¨¡å¼ï¼ˆä¸€ï¼‰å·¥å‚æ¨¡å¼</title>
    <link href="/post/43893.html"/>
    <url>/post/43893.html</url>
    
    <content type="html"><![CDATA[<h1 id="PHP-è®¾è®¡æ¨¡å¼ï¼ˆä¸€ï¼‰å·¥å‚æ¨¡å¼"><a href="#PHP-è®¾è®¡æ¨¡å¼ï¼ˆä¸€ï¼‰å·¥å‚æ¨¡å¼" class="headerlink" title="PHP è®¾è®¡æ¨¡å¼ï¼ˆä¸€ï¼‰å·¥å‚æ¨¡å¼"></a>PHP è®¾è®¡æ¨¡å¼ï¼ˆä¸€ï¼‰å·¥å‚æ¨¡å¼</h1><blockquote><p>æœ€è¿‘ä¼šç®€å•çš„è‡ªæˆ‘æ€»ç»“ä¸€äº› php å½“ä¸­çš„ä¸€äº›è®¾è®¡æ¨¡å¼ï¼Œå½“ç„¶ä¸ªäººæ‰ç–å­¦æµ…ï¼Œå¯èƒ½äº›ä¸å¯¹çš„åœ°æ–¹æœ›å„ä½çœ‹å®˜è§è°…æŒ‡æ­£</p></blockquote><h2 id="æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æ˜¯ä»€ä¹ˆï¼Ÿ"></a>æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>å·¥å‚æ¨¡å¼æ˜¯ä¸€ç§åˆ›å»ºå‹çš„æ¨¡å¼ï¼Œç®€å•çš„è¯´å°±æ˜¯ç”¨æ¥åˆ›å»ºå¯¹è±¡çš„</p><h2 id="ä¸ºä»€ä¹ˆï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆï¼Ÿ"></a>ä¸ºä»€ä¹ˆï¼Ÿ</h2><p>æˆ‘ä»¬ä¸€èˆ¬æœ€æ™®é€šçš„åˆ›å»ºå¯¹è±¡çš„æ–¹å¼æ˜¯è¿™æ ·<code>new classname()</code>,ä½†æ˜¯æ¢ä½æƒ³ä¸€ä¸‹ï¼Œè¿™æ ·åˆ›å»ºå¯¹è±¡çš„æ—¶å€™æˆ‘ä»¬å¿…é¡»è¦çŸ¥é“ç±»åï¼Œä½†æ˜¯æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹ä¸‹é¢å‡ ä¸ªæƒ…å†µï¼š</p><ol><li>å¦‚æœæˆ‘ä»¬ä¸çŸ¥é“ç±»åå‘¢ï¼Ÿ</li><li>å¦‚æœæˆ‘åœ¨å¾ˆå¤šä¸ªæ–‡ä»¶å½“ä¸­éƒ½ç”¨åˆ°äº†è¿™ä¸ªç±»åˆ›å»ºå¯¹è±¡ï¼Œnew äº†å¾ˆå¤šæ¬¡ï¼Œä½†æ˜¯åœ¨é‡æ„æˆ–è€…å…¶ä»–ä»€ä¹ˆæƒ…å†µçš„æ—¶å€™æˆ‘è¦ä¿®æ”¹ç±»åæ€ä¹ˆåŠï¼Ÿå½“ç„¶æœ‰äººä¼šè¯´æ€ä¹ˆä¼šä¿®æ”¹ç±»åï¼Œè¿™æ˜¯æœ‰å¯èƒ½ä¼šé‡åˆ°çš„ï¼Œé‚£è¯´ä¸€ä¸€ä¸‹å¸¸è§ä¸€ç‚¹çš„ï¼Œå¦‚æœæˆ‘ç»™è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•åŠ äº†ï¼Œæˆ–è€…æ˜¯å°‘äº†ä¸€ä¸ªå‚æ•°ï¼Ÿé‚£å²‚ä¸æ˜¯å¾—ä¸€ä¸ªä¸ªçš„å»æ”¹</li><li>æˆ‘ç°åœ¨æœ‰ä¸€ä¸ªæŠ½è±¡çš„åŸºç±»ï¼Œç”±å®ƒæ´¾ç”Ÿäº†å¾ˆå¤šå­ç±»ï¼Œæˆ‘ä¸çŸ¥é“åé¢è¿˜ä¼šä¸ä¼šæ·»åŠ å…¶ä»–çš„å­ç±»</li></ol><p>ä¸Šé¢å‡ ä¸ªéƒ½æ˜¯å¯èƒ½ä¼šé‡åˆ°çš„ä¸€äº›æƒ…å†µä¹‹ä¸€ï¼Œä½¿ç”¨å·¥å‚æ¨¡å¼å¯ä»¥æ¯”è¾ƒå¥½çš„è§£å†³ä¸Šé¢çš„é—®é¢˜</p><h2 id="æ€ä¹ˆåŠï¼Ÿ"><a href="#æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="æ€ä¹ˆåŠï¼Ÿ"></a>æ€ä¹ˆåŠï¼Ÿ</h2><h3 id="ç®€å•å·¥å‚æ¨¡å¼"><a href="#ç®€å•å·¥å‚æ¨¡å¼" class="headerlink" title="ç®€å•å·¥å‚æ¨¡å¼"></a>ç®€å•å·¥å‚æ¨¡å¼</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Food</span></span>&#123;<br>    <span class="hljs-comment">//todo</span><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FoodFactory</span></span>&#123;<br><br>    <span class="hljs-built_in">static</span> <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> food();<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$food</span>= FoodFactory::create();<br></code></pre></td></tr></table></figure><p>ä¸Šé¢å®ç°ç®€å•å·¥å‚æ¨¡å¼,<code>FoodFactory</code>è¿™ä¸ªç±»å¾ˆç®€å•åªæœ‰ä¸€ä¸ªåˆ›å»ºæ–¹æ³•ï¼Œè¿”å› food ç±»çš„å®ä¾‹ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å‘ç°è¿™ä¸ªæ–¹æ³•å¾ˆç¬¨æ‹™ï¼Œåªèƒ½å®ç°ä¸€ä¸ªå¯¹è±¡çš„åˆ›å»ºï¼Œæ„Ÿè§‰æ¯”ç›´æ¥ new ä¸€ä¸ªå¯¹è±¡<br>å¥½ä¸äº†å¤šå°‘ï¼Œåªæ˜¯æ–¹ä¾¿æ”¹åŠ¨è€Œå·²</p><h3 id="å·¥å‚æ–¹æ³•æ¨¡å¼"><a href="#å·¥å‚æ–¹æ³•æ¨¡å¼" class="headerlink" title="å·¥å‚æ–¹æ³•æ¨¡å¼"></a>å·¥å‚æ–¹æ³•æ¨¡å¼</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FoodFactory</span></span>&#123;<br><br>    <span class="hljs-built_in">static</span> <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span>(<span class="hljs-params"><span class="hljs-variable">$classname</span></span>)</span>&#123;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">include_once</span> <span class="hljs-string">&#x27;class/&#x27;</span> . <span class="hljs-variable">$classname</span> . <span class="hljs-string">&#x27;.php&#x27;</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-variable">$classname</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">&#x27;Driver not found&#x27;</span>);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„æ–¹æ³•æˆ‘ä»¬å‘ç°æˆ‘ä»¬å·²ç»å¯ä»¥ä¸å±€é™äºï¼Œåˆ›å»ºä¸€ä¸ªå›ºå®šçš„ç±»çš„å¯¹è±¡äº†<br><strong>ä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼š</strong><br><em>å¦‚æœæˆ‘ä»¬ä½¿ç”¨äº†å‘½åç©ºé—´çš„è¯ï¼Œåœ¨åŠ¨æ€å®ä¾‹åŒ–ç±»çš„æ—¶å€™å¿…é¡»åŒ…å«å®Œæ•´çš„å‘½åç©ºé—´ï¼Œæå‰ use æˆ–è€…å¤„äºç»Ÿä¸€å‘½åç©ºé—´éƒ½æ˜¯æ²¡æœ‰ç”¨çš„</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">Mohuishou</span>\<span class="hljs-title">Lib</span>;<br>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FoodFactory</span></span>&#123;<br>    <span class="hljs-built_in">static</span> <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span>(<span class="hljs-params"><span class="hljs-variable">$classname</span></span>)</span>&#123;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">include_once</span> <span class="hljs-string">&#x27;class/&#x27;</span> . <span class="hljs-variable">$classname</span> . <span class="hljs-string">&#x27;.php&#x27;</span>)&#123;<br>        <span class="hljs-variable">$classname</span>=<span class="hljs-string">&quot;Mohuishou\Lib\\&quot;</span>.<span class="hljs-variable">$classname</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-variable">$classname</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">&#x27;Driver not found&#x27;</span>);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬è¿˜æƒ³ä¼ å…¥å‚æ•°å‘¢ï¼Ÿ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">Mohuishou</span>\<span class="hljs-title">Lib</span>;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FoodFactory</span></span>&#123;<br>    <span class="hljs-built_in">static</span> <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span>(<span class="hljs-params"><span class="hljs-variable">$classname</span>,<span class="hljs-variable">$params</span></span>)</span>&#123;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">include_once</span> <span class="hljs-string">&#x27;class/&#x27;</span> . <span class="hljs-variable">$classname</span> . <span class="hljs-string">&#x27;.php&#x27;</span>)&#123;<br>    <span class="hljs-variable">$classname</span>=<span class="hljs-string">&quot;Mohuishou\Lib\\&quot;</span>.<span class="hljs-variable">$classname</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-variable">$classname</span>(<span class="hljs-variable">$params</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">&#x27;Driver not found&#x27;</span>);<br>&#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬ä¸çŸ¥é“ç±»åï¼Œä¸çŸ¥é“æ–¹æ³•ï¼Œæ€ä¹ˆåŠ?æ€ä¹ˆå®ç°ä¸€ä¸ªä¸€èˆ¬çš„å·¥å‚æ¨¡å¼ï¼Ÿ<br>è¿™é‡Œå¯èƒ½éœ€è¦ç”¨åˆ°åå°„çš„æ¦‚å¿µäº†ï¼Œè¿™ç¯‡å°±ä¸è¿‡å¤šèµ˜è¿°</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>php</tag>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å››å·å¤§å­¦æœ›æ±Ÿæ ¡åŒºä½¿ç”¨mentohustè®¤è¯ä¸Šç½‘</title>
    <link href="/post/51466.html"/>
    <url>/post/51466.html</url>
    
    <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><blockquote><p>åˆšåˆšè§£å†³å®Œå¤©ç¿¼é£æ‰¬çš„ä¸Šç½‘é—®é¢˜ï¼Œç»“æœå°±æ¬æ ¡åŒºäº†ï¼ŒæŒ‰ç…§ä¸Šä¸€ç¯‡æ–‡ç« çš„æ–¹æ³•åœ¨è¿™è¾¹ä¹Ÿæ˜¯å¯ä»¥ç”¨çš„ï¼Œä½†æ˜¯æ ¡å›­ç½‘ä½¿ç”¨çš„é”æ·è®¤è¯å·²ç»æä¾›äº† linux çš„å®¢æˆ·ç«¯äº†ï¼Œæ‰€ä»¥å°±æ²¡æœ‰å¿…è¦é‚£ä¹ˆéº»çƒ¦äº†ã€‚ä½†æ˜¯åœ¨ä¿¡æ¯ç®¡ç†ä¸­å¿ƒä¸‹è½½çš„å®¢æˆ·ç«¯ç®€ç›´æ— è¯­ï¼Œå®¢æˆ·ç«¯å¿…é¡»è¦ç¦ç”¨åŒç½‘å¡ï¼Œè€Œä¸”è¿æ¥çš„çš„æ—¶å€™ä¼šå…ˆæŠŠä½ çš„ç½‘ç»œæœåŠ¡ç»™å…³é—­æ‰ã€‚ã€‚ã€‚ä½†æ˜¯æœ‰æ—¶å€™æœ‰å¼€ä¸äº†ã€‚å¦‚æœä¸æ‰‹åŠ¨ç¦ç”¨æ‰æ— çº¿ç½‘å¡ï¼Œè®¤è¯æˆåŠŸä¹‹å 3 åˆ†é’Ÿä¹‹å†…å¿…æ‰</p></blockquote><h2 id="mentohust"><a href="#mentohust" class="headerlink" title="mentohust"></a>mentohust</h2><blockquote><p>è¿˜å¥½æœ‰ mentohust è¿™ä¸ªç¥å™¨ï¼Œä½†æ˜¯ä½¿ç”¨å½“ä¸­è¿˜æ˜¯æœ‰ä¸€ç‚¹å°å‘</p></blockquote><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/4178932952.png" alt="æ·±åº¦æˆªå›¾20160719182529.png"></p><p>1.é¦–å…ˆä¸‹è½½å®‰è£… mentohust</p><ul><li>å®˜æ–¹åœ°å€:<a href="https://code.google.com/archive/p/mentohust/downloads">https://code.google.com/archive/p/mentohust/downloads</a></li><li><p>å®˜æ–¹çš„è¦ç¿»å¢™ï¼Œè¿™å„¿æä¾›ä¸€ä¸ª ubuntu/debian çš„<a href="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/994570489.deb">mentohust_0.3.4-1-2_i386.deb</a></p><p>2.ç„¶ååœ¨å››å·å¤§å­¦ä¿¡æ¯ç®¡ç†ä¸­å¿ƒä¸‹è½½é”æ· 4.96 ç‰ˆæœ¬ï¼Œè§£å‹æå–<code>8021x.exe</code>,<code>W32N55.dll</code>,<code>SuConfig.dat</code>ç§»åŠ¨åˆ°<code>/etc/mentohust</code></p><p>3.åœ¨ç»å†ä¸€ä¸ªä¸€ä¸ªå°è¯•ä¹‹åçš„å¯ç”¨æ¨¡å¼</p></li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> mentohust -uç”¨æˆ·å -på¯†ç  -a<span class="hljs-number">0</span> -d<span class="hljs-number">2</span> -b<span class="hljs-number">2</span> -v<span class="hljs-number">4</span>.<span class="hljs-number">96</span> -w //ä¸‹æ¬¡ä½¿ç”¨çš„æ—¶å€™ç›´æ¥ä½¿ç”¨sudo mentohustå°±å¯ä»¥äº†<br></code></pre></td></tr></table></figure><p><strong>æ³¨æ„ï¼šå¦‚æœæ˜¾ç¤ºè®¤è¯æˆåŠŸä½†æ˜¯æ— æ³•ä¸Šç½‘ï¼Œè¯•ä¸€è¯•å…ˆå…³é—­æœ‰çº¿ç½‘ç»œçš„è¿æ¥ç„¶åå†æ‰“å¼€ï¼Œç„¶åé©¬ä¸Šè¾“å…¥ä¸Šé¢çš„å‘½ä»¤ï¼Œå³å¯ã€‚æ‹”æ’ç½‘çº¿ä¹Ÿå¯ä»¥</strong></p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>å¤§å­¦</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å››å·å¤§å­¦</tag>
      
      <tag>mentohust</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linuxä¸‹å¤©ç¿¼é£æ‰¬è®¤è¯ä¸Šç½‘çš„ä¸€ä¸ªè§£å†³æ–¹æ³•</title>
    <link href="/post/50628.html"/>
    <url>/post/50628.html</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><blockquote><p>åšä¸»å°è¯•è¿‡è®¸å¤šçš„æ–¹æ³•ä¸€ç›´æ²¡æœ‰è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¾‹å¦‚ï¼šè™šæ‹Ÿæœºæ¡¥æ¥ ï¼Œcrossoverã€wine æ¨¡æ‹Ÿï¼Œå¾ˆæ—©ä»¥å‰çš„ linux ç‰ˆæœ¬ç­‰ç­‰ï¼Œæœ€åéƒ½æ²¡æœ‰æˆåŠŸï¼Œä½†æ˜¯å½“è¦æ¬æ ¡åŒºï¼Œä¸å†ä½¿ç”¨è¿™ä¸ªå®¢æˆ·ç«¯çš„å‰ä¸€å¤©æ™šä¸Šï¼Œçªå‘å¥‡æƒ³ç»“æœè§£å†³äº†â€¦.</p></blockquote><p>ç†è®ºä¸Šè¯¥æ–¹æ³•å¯¹äºæ‰€æœ‰éœ€è¦è®¤è¯çš„ä¸Šç½‘å®¢æˆ·ç«¯æœ‰æ•ˆ</p><h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><p>1.å®‰è£… virtualbox 2.ä¸‹è½½ windows é•œåƒï¼Œåšä¸»ä½¿ç”¨ xp</p><h2 id="å¼€å§‹è®¾ç½®"><a href="#å¼€å§‹è®¾ç½®" class="headerlink" title="å¼€å§‹è®¾ç½®"></a>å¼€å§‹è®¾ç½®</h2><p>1.é¦–å…ˆå®‰è£… windows è™šæ‹Ÿæœº,è™šæ‹Ÿæœºè®¾ç½®:</p><ul><li>å†…å­˜éšæ„ï¼Œå¯ä»¥åœ¨æµ‹è¯•å¥½ä¹‹åï¼Œè®¾ç½®ä¸ºèƒ½å¤Ÿæ­£å¸¸è¿è¡Œçš„æœ€å°å†…å­˜ï¼Œæˆ‘å…ˆä½¿ç”¨çš„æ˜¯ 512M</li><li>ç½‘å¡ï¼Œè®¾ç½®ä¸¤å¼ ç½‘å¡ï¼Œä¸€ä¸ªä½¿ç”¨æ¡¥æ¥ï¼Œæ¡¥æ¥åˆ°è¿æ¥å®½å¸¦çš„æœ‰é™ç½‘ç»œä¸Šï¼Œå¦ä¸€ä¸ªä½¿ç”¨ host-only ç”¨äºç»„å»ºå±€åŸŸç½‘</li></ul><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/3069020784.png" alt="æ·±åº¦æˆªå›¾20160718200311.png"><br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/878380818.png" alt="æ·±åº¦æˆªå›¾20160718200300.png"></p><p>2.åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨å®½å¸¦çš„å®¢æˆ·ç«¯æ‹¨å·ä¸Šç½‘</p><p>3.æŸ¥çœ‹å±€åŸŸç½‘åœ°å€</p><ul><li>è™šæ‹Ÿæœºå½“ä¸­ä½¿ç”¨<code>ipconfig</code>å‘½ä»¤</li><li>ä¸»æœºå½“ä¸­ä½¿ç”¨<code>ifconfig</code>å‘½ä»¤</li><li>å¦‚å›¾æ‰€ç¤º</li></ul><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/3302058632.png" alt="æ·±åº¦æˆªå›¾20160718202926.png"></p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/3537084827.png" alt="æ·±åº¦æˆªå›¾20160718202945.png"></p><p>4.åœ¨è™šæ‹Ÿæœºå½“ä¸­ä½¿ç”¨æœåŠ¡å™¨ä»£ç†è½¯ä»¶ï¼Œç„¶åä¸»æœºå®ç°ä»£ç†ä¸Šç½‘ï¼Œæ¥¼ä¸»ä½¿ç”¨çš„ TGate</p><ul><li>TGate è®¾ç½®å¦‚å›¾æ‰€ç¤º</li></ul><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/1779186853.png" alt="æ·±åº¦æˆªå›¾20160718203937.png"></p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/1448439344.png" alt="æ·±åº¦æˆªå›¾20160718204111.png"></p><p>5.åœ¨ä¸»æœºè®¾ç½®ä»£ç†ä¸Šç½‘</p><ul><li>å¯ä»¥è®¾ç½®å…¨å±€ä»£ç†ï¼Œä½†æ˜¯åšä¸»çš„ deepin å…¨å±€ä»£ç†å¥½åƒæœ‰ç‚¹é—®é¢˜ï¼Œæ‰€ä»¥å°±å…ˆè®¾ç½® chrome çš„ä»£ç†äº†</li><li>å¦‚å›¾æ‰€ç¤º<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/3447026534.png" alt="æ·±åº¦æˆªå›¾20160718204345.png"></li></ul><blockquote><p>æ¥¼ä¸»åˆ°æ­¤å·²ç»å¯ä»¥ä½¿ç”¨äº†</p></blockquote><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>å¤§å­¦</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¤©ç¿¼é£æ‰¬</tag>
      
      <tag>linux</tag>
      
      <tag>ç½‘ç»œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è¿ç§»laravelæ¡†æ¶é¡¹ç›®åˆ°è™šæ‹Ÿä¸»æœº</title>
    <link href="/post/13242.html"/>
    <url>/post/13242.html</url>
    
    <content type="html"><![CDATA[<h3 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h3><p>laravel ç‰ˆæœ¬ï¼š<code>5.2</code><br>è™šæ‹Ÿä¸»æœºï¼šä¸‡ç½‘</p><h3 id="è¿ç§»"><a href="#è¿ç§»" class="headerlink" title="è¿ç§»"></a>è¿ç§»</h3><p>1.å…ˆæŠŠæ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°ç½‘ç«™æ ¹ç›®å½• 2.ç”±äºè®¿é—®çš„æ—¶å€™å…¥å£æ–‡ä»¶åœ¨ public ç›®å½•ä¸‹é¢ï¼Œè¿™æ—¶å€™è®¿é—® url ä¼šå˜æˆ url/public/ï¼Œé‡å†™è§„åˆ™è·³è½¬å°±è¡Œäº†,åœ¨æ ¹ç›®å½•æ–°å»º.hatcess æ–‡ä»¶</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-section">&lt;IfModule mod_rewrite.c&gt;</span><br>    <span class="hljs-attribute"><span class="hljs-nomarkup">RewriteEngine</span></span> <span class="hljs-literal">on</span><br>    <span class="hljs-attribute"><span class="hljs-nomarkup">RewriteCond</span></span> <span class="hljs-variable">%&#123;REQUEST_URI&#125;</span> !^public<br>    <span class="hljs-attribute"><span class="hljs-nomarkup">RewriteRule</span></span> ^(.*)$ public/$<span class="hljs-number">1</span><span class="hljs-meta"> [L]</span><br><span class="hljs-section">&lt;/IfModule&gt;</span><br></code></pre></td></tr></table></figure><p>3.æ‰“å¼€<code>config/app.php</code><br>å°†</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-string">&#x27;key&#x27;</span> =&gt; env(<span class="hljs-string">&#x27;APP_KEY&#x27;</span>, <span class="hljs-string">&#x27;...&#x27;</span>), <span class="hljs-comment">//32ä½å­—ç¬¦ä¸²</span><br><span class="hljs-string">&#x27;cipher&#x27;</span> =&gt; <span class="hljs-string">&#x27;AES-256-CBC&#x27;</span>,<br></code></pre></td></tr></table></figure><p>æ”¹ä¸º</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-string">&#x27;key&#x27;</span> =&gt; env(<span class="hljs-string">&#x27;APP_KEY&#x27;</span>, <span class="hljs-string">&#x27;...&#x27;</span>),<span class="hljs-comment">//16ä½å­—ç¬¦ä¸²</span><br><span class="hljs-string">&#x27;cipher&#x27;</span> =&gt; <span class="hljs-string">&#x27;AES-128-CBC&#x27;</span>,<br></code></pre></td></tr></table></figure><p><em>ç”±äºä¸‡ç½‘ä¸æ”¯æŒâ€™AES-256-CBCâ€™æ‰€ä»¥ç”¨ 128 ä½åŠ å¯†ï¼Œ256 ä½åŠ å¯†ä½¿ç”¨ 32 ä½å­—ç¬¦ä¸²ï¼Œ128 ä½ä½¿ç”¨ 16 ä½å­—ç¬¦ä¸²</em> 4.åˆ°è¿™ä¸€æ­¥åŸºæœ¬å°±æ²¡æœ‰ä»€ä¹ˆé—®é¢˜äº†ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ ajax çš„æ—¶å€™ï¼Œpost æ–¹æ³•æœ‰å¯èƒ½ä¼šè¢« 301 è·³è½¬ç„¶åå˜æˆ get<br>è§£å†³æ–¹æ¡ˆï¼š<br>æ‰“å¼€<code>public</code>ç›®å½•ä¸‹çš„<code>.htaccess</code>æ–‡ä»¶åˆ é™¤ä¸‹é¢è¿™ä¸€æ®µ</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># Redirect Trailing Slashes If Not A Folder...</span><br>  <span class="hljs-attribute"><span class="hljs-nomarkup">RewriteCond</span></span> <span class="hljs-variable">%&#123;REQUEST_FILENAME&#125;</span> !-d<br>  <span class="hljs-attribute"><span class="hljs-nomarkup">RewriteRule</span></span> ^(.*)/$ /$<span class="hljs-number">1</span><span class="hljs-meta"> [L,R=301]</span><br></code></pre></td></tr></table></figure><p>5.å¥½äº†ï¼Œæˆ‘çš„ä½¿ç”¨è¿‡ç¨‹ä¸­å°±æ²¡ä»€ä¹ˆé—®é¢˜äº†ï¼ˆæ³¨ï¼šæŠŠåœ¨æ§åˆ¶å°æŠŠä¸‡ç½‘çš„ php ç‰ˆæœ¬è°ƒåˆ°æœ€é«˜ï¼Œç°åœ¨æ˜¯ 5.5ï¼‰</p><p><strong>è¡¥å……ä¸€ç‚¹å¾ˆå¤šäººå®¹æ˜“å¿½ç•¥çš„ï¼Œé…ç½®æ–‡ä»¶ä¸è¦å¸è½½.env æ–‡ä»¶é‡Œé¢ï¼Œè™šæ‹Ÿæœºä¸€èˆ¬ä¸æ”¯æŒï¼Œæ¢åˆ° config ç›®å½•ä¸‹çš„ç›¸åº”é…ç½®æ–‡ä»¶ä¸‹</strong></p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>php</tag>
      
      <tag>laravel</tag>
      
      <tag>è™šæ‹Ÿä¸»æœº</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä½¿ç”¨lnmp+owncloud+ossfs+ossæ­å»ºå±äºè‡ªå·±çš„ç§æœ‰äº‘ç›˜</title>
    <link href="/post/8013.html"/>
    <url>/post/8013.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>ç»å¸¸å†™ä¸€å†™æ–‡æ¡£ä¹‹ç±»çš„ä¸œè¥¿ï¼Œéœ€è¦ä¸€ä¸ªåŒæ­¥ç½‘ç›˜ï¼Œä½†æ˜¯ç°åœ¨å¸‚é¢ä¸Šçš„è¿˜æ˜¯æ»¡è¶³ä¸äº†æˆ‘çš„è¦æ±‚ï¼Œçªç„¶å‘ç°é˜¿é‡Œäº‘çš„ oss å¯ä»¥æŒ‚è½½æˆè™šæ‹Ÿç£ç›˜ï¼Œè¯•ç€æŠ˜è…¾äº†ä¸€ä¸‹æ•ˆæœè¿˜ä¸é”™ï¼Œä¸è¿‡è¿™ä¸­é—´è¿˜æ˜¯æœ‰è®¸å¤šçš„å‘</p></blockquote><h3 id="ä¹‹å‰ä½¿ç”¨çš„äº‘ç›˜"><a href="#ä¹‹å‰ä½¿ç”¨çš„äº‘ç›˜" class="headerlink" title="ä¹‹å‰ä½¿ç”¨çš„äº‘ç›˜"></a>ä¹‹å‰ä½¿ç”¨çš„äº‘ç›˜</h3><ol><li><p>åšæœäº‘<br>ä¸ªäººè®¤ä¸ºæ˜¯ç°åœ¨å¸‚é¢ä¸Šæœ€å¥½çš„åŒæ­¥ç›˜äº†ï¼Œæ”¯æŒå¢é‡åŒæ­¥ï¼Œå¤šå¹³å°æœ‰ linux ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ webdavã€‚ç¾ä¸­ä¸è¶³çš„å…è´¹ç‰ˆæ¯ä¸ªæœˆé™åˆ¶ä¸Šä¼ ä¸‹è½½æµé‡ï¼Œæ”¶è´¹ç‰ˆä¸é™åˆ¶æµé‡æœ‰ç©ºé—´é™åˆ¶ã€‚æœ‰æ®µæ—¶é—´çªç„¶æœ‰å¤§é‡æ–‡ä»¶éœ€è¦å¤‡ä»½å¯¼è‡´æµé‡ä¸è¶³ï¼Œä½†æ˜¯å¹³æ—¶åˆç”¨ä¸äº†å¤ªå¤šï¼Œå¼€ä¸€ä¸ªæœˆä¸“ä¸šç‰ˆçš„ç©ºé—´åˆä¸å¤Ÿï¼Œç”¨çš„æœ‰ç‚¹æ†‹å±ˆæ‰€ä»¥å°±å¼ƒç”¨äº†ã€‚</p></li><li><p>ç™¾åº¦äº‘ç­‰<br>åœ¨ä½¿ç”¨åšæœäº‘ä¹‹å‰çš„ä¸»åŠ›ç½‘ç›˜ï¼ŒåŒæ­¥ç›˜åŠŸèƒ½ç«Ÿç„¶è¦ä¼šå‘˜æ‰èƒ½ç”¨ï¼Œè€Œä¸”åŒæ­¥ç›˜åšçš„å¾ˆä¸å¥½ç”¨ï¼Œä¸è¿‡ç”¨æ¥åšèµ„æºåˆ†äº«ä¹‹ç±»çš„è¿˜ä¸é”™</p></li></ol><h3 id="ä¸ºä»€ä¹ˆä½¿ç”¨-oss"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨-oss" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨ oss"></a>ä¸ºä»€ä¹ˆä½¿ç”¨ oss</h3><ol><li><p>æ•°æ®çš„ç¨³å®šæ€§ï¼Œæˆ‘æ¯”è¾ƒå–œæ¬¢æŠ˜è…¾æ‰€ä»¥æœåŠ¡å™¨æœ‰æ—¶å€™å°±ä¼šé‡è£…è¿™æ—¶å€™å¯¹äºæ–‡ä»¶å°±éå¸¸çš„ä¸å¥½ç®¡ç†å’Œå¤‡ä»½ï¼Œæ”¾åœ¨ oss ä¸Šé¢èƒ½å¤Ÿæ›´å¥½çš„ç®¡ç†</p></li><li><p>ç¬¬äºŒä¸ªå°±æ˜¯ä¾¿å®œï¼Œä¸å’Œå…¶ä»–å‡ å®¶çš„äº‘æœåŠ¡å¯¹æ¯”ä»…ä»…å’Œé˜¿é‡Œäº‘çš„äº‘ç›˜ï¼Œå°±æ˜¯ä¹°æœåŠ¡å™¨çš„æ—¶å€™çš„ä¸€ä¸ªé€‰é¡¹ï¼Œä¾¿å®œå¾ˆå¤šã€‚40g çš„è¯ä¸€å¹´ä¹Ÿå°±å·®ä¸å¤š 10 å¤šå—çš„æ ·å­ã€‚è€Œä¸”å’Œ ECS æ­é…ä½¿ç”¨æ²¡æœ‰æµé‡è´¹ç”¨</p></li></ol><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>å®‰è£… lnmp æ¶æ„</p><blockquote><p>å…¶å® owncloud å®˜æ–¹æ›´åŠ æ¨è lampï¼Œä½†æ˜¯æˆ‘ä¸ªäººæ›´å–œæ¬¢ nginxï¼Œè¦æ¯” Apache çœèµ„æºä¸€äº›ï¼Œèƒ½å¤Ÿç”¨ Apache çš„ä¹Ÿå¾ˆä¸é”™ï¼Œå¯ä»¥å°‘è¸©å¾ˆå¤šé…ç½®çš„å‘ï¼Œowncloud çš„ nginx å®˜æ–¹ç¤ºä¾‹é…ç½®å¾ˆå¤šå‘ï¼Œä¹‹åä¼šè¯´åˆ°</p></blockquote><h3 id="å®‰è£…-ossfs"><a href="#å®‰è£…-ossfs" class="headerlink" title="å®‰è£… ossfs"></a>å®‰è£… ossfs</h3><blockquote><p>æ³¨æ„ï¼šåœ¨è¿™ä¹‹å‰ä½ éœ€è¦å…ˆå¼€é€š ossï¼Œæœ€å¥½æ˜¯å’Œä½ çš„ ECS æ˜¯ä¸€ä¸ªåœ°åŒºçš„ï¼Œå½“ç„¶ä¸æ˜¯ç”¨çš„ ECS ä¹Ÿå¯ä»¥ç”¨ï¼Œåªæ˜¯é€Ÿåº¦ä¼šæ…¢ä¸€äº›ï¼Œè¿˜æœ‰å°±æ˜¯ä¸‹è½½ä¼šä½¿ç”¨å…¬ç½‘æµé‡ï¼Œä¸Šä¼ æ²¡æœ‰</p></blockquote><p>1.<a href="https://help.aliyun.com/document_detail/32196.html">ç‚¹å‡»æ‰“å¼€ ossfs çš„ä¸‹è½½é¡µé¢ä¸‹è½½å¯¹åº”ç³»ç»Ÿçš„å®‰è£…åŒ…</a> 2.æˆ‘å·² Ubuntu ä¸ºä¾‹ï¼Œå®‰è£… ossfsï¼Œå…¶ä»–ç³»ç»Ÿçœ‹å®˜æ–¹çš„æ–‡æ¡£å°±è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt-get update<br>sudo apt-get install gdebi-core<br>sudo gdebi your_ossfs_package<br></code></pre></td></tr></table></figure><p>3.å°†<code>my-bucket</code>è¿™ä¸ª bucket æŒ‚è½½åˆ°<code>/data/cloud</code>ç›®å½•ä¸‹ï¼ŒAccessKeyId æ˜¯<code>faint</code>ï¼Œ AccessKeySecret æ˜¯<code>123</code>ï¼Œoss endpoint æ˜¯<code>http://oss-cn-hangzhou.aliyuncs.com</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> my-bucket:faint:123 &gt; /etc/passwd-ossfs<br>chmod 640 /etc/passwd-ossfs<br>mkdir /data/cloud<br></code></pre></td></tr></table></figure><p><strong>æœ€åä¸€æ­¥å¾ˆé‡è¦ï¼Œä¸èƒ½ç›´æ¥ç…§å®˜æ–¹æ–‡æ¡£ä¸Šé¢çš„æ¥ï¼Œä¸ç„¶å®‰è£… owncloud çš„æ—¶å€™å¯èƒ½ä¼šå‡ºç°æ²¡æœ‰è®¿é—®æƒé™çš„é—®é¢˜</strong></p><ul><li>é¦–å…ˆå…ˆçœ‹ä¸€ä¸‹ nginx çš„ç”¨æˆ· idï¼Œä»¥æˆ‘çš„æ˜¯<code>www</code>ä¸ºä¾‹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">id www<br></code></pre></td></tr></table></figure><p>ä¼šè¿”å›ç»™ä½ ç”¨æˆ·çš„ uid å’Œ gid ç­‰ç­‰,æˆ‘å‡è®¾è¿”å›çš„ uid å’Œ gid éƒ½ä¸º 1001</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">ossfs my-bucket /data/cloud <span class="hljs-attribute">-ourl</span>=http://oss-cn-hangzhou-internal.aliyuncs.com <span class="hljs-attribute">-ouid</span>=1001 <span class="hljs-attribute">-ogid</span>=1001 -o allow_other -o <span class="hljs-attribute">umask</span>=007<br></code></pre></td></tr></table></figure><p>è¿™é‡Œé¢<code>allow_other</code>æ˜¯å…è®¸å…¶ä»–ç”¨æˆ·è®¿é—®ï¼Œä½†æ˜¯é»˜è®¤è®¾ç½®çš„æ˜¯ 777 æƒé™è¿™æ · owncloud ä¼šæç¤ºä¸å®‰å…¨ï¼Œç”¨<code>umask=007</code>æŒ‚è½½ä¸º 770 æƒé™ï¼Œä¸çŸ¥é“ä¸ºå•¥è¿™é‡Œ 0 ä»£è¡¨ 7,7 è¡¨ç¤º 0</p><blockquote><p>åˆ°è¿™é‡Œ ossfs å°±å®‰è£…å®Œæ¯•äº†ä¸‹é¢å¼€å§‹å®‰è£… owncloud</p></blockquote><h3 id="å®‰è£…-OWNCLOUD"><a href="#å®‰è£…-OWNCLOUD" class="headerlink" title="å®‰è£… OWNCLOUD"></a>å®‰è£… OWNCLOUD</h3><blockquote><p>owncloud çš„å®‰è£…ç½‘ä¸Šå·²ç»æœ‰å¾ˆå¤šçš„æ•™ç¨‹æˆ‘å°±ä¸å¤šè¯´äº†</p></blockquote><p>å…ˆæ‰“å¼€<a href="https://owncloud.org/install/#instructions-server">owncloud çš„å®˜ç½‘çš„æœåŠ¡å™¨ç«¯çš„å®‰è£…åœ°å€</a>ï¼Œæˆ‘å®‰è£…çš„æ—¶å€™æœ€æ–°ç¨³å®šç‰ˆæ˜¯<code>9.0.2</code>å»ºè®®å›½å†…ä¸»æœºç”¨è¿…é›·ä¹‹ç±»çš„ä¸‹è½½è½¯ä»¶å…ˆä¸‹è½½ä¸‹æ¥ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œç›´æ¥ wget æ¯”è¾ƒæ…¢</p><p>1.ä¸‹è½½å¹¶è§£å‹</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">wget</span>  https://download.owncloud.org/community/owncloud-<span class="hljs-number">9</span>.<span class="hljs-number">0</span>.<span class="hljs-number">2</span>.tar.bz<span class="hljs-number">2</span> //æ‰‹åŠ¨ä¸Šä¼ è¿™ä¸€æ­¥å°±ä¸ç”¨äº†<br><span class="hljs-attribute">tar</span> xvf owncloud-<span class="hljs-number">9</span>.<span class="hljs-number">0</span>.<span class="hljs-number">2</span>.tar.bz<span class="hljs-number">2</span> //ä»¥å®é™…çš„æ–‡ä»¶åä¸ºå‡†<br></code></pre></td></tr></table></figure><p>2.ç§»åŠ¨åˆ°ç«™ç‚¹ç›®å½•,å‡è®¾ç«™ç‚¹ç›®å½•ä¸º<code>/data/wwwroot</code></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">mv owncloud<span class="hljs-regexp">/ /</span>data<span class="hljs-regexp">/wwwroot/</span><br></code></pre></td></tr></table></figure><p><strong>3.è®¾ç½®ç›®å½•æƒé™ï¼Œè¿™ä¸€æ­¥å¾ˆé‡è¦</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">chown -R www:www /data/wwwroot/owncloud/<br>chmod 777 /data/wwwroot/owncloud//config/<br></code></pre></td></tr></table></figure><h3 id="è®¾ç½®-nginx-è§„åˆ™ï¼ˆApache-åŸºæœ¬ä¸ç”¨æ”¹ï¼Œåªéœ€è¦è‡ªå·±å»è®¾ç½®ä¸€ä¸‹-sslï¼Œå’Œå¸¸è§„çš„è®¾ç½®å°±è¡Œäº†ï¼‰"><a href="#è®¾ç½®-nginx-è§„åˆ™ï¼ˆApache-åŸºæœ¬ä¸ç”¨æ”¹ï¼Œåªéœ€è¦è‡ªå·±å»è®¾ç½®ä¸€ä¸‹-sslï¼Œå’Œå¸¸è§„çš„è®¾ç½®å°±è¡Œäº†ï¼‰" class="headerlink" title="è®¾ç½® nginx è§„åˆ™ï¼ˆApache åŸºæœ¬ä¸ç”¨æ”¹ï¼Œåªéœ€è¦è‡ªå·±å»è®¾ç½®ä¸€ä¸‹ sslï¼Œå’Œå¸¸è§„çš„è®¾ç½®å°±è¡Œäº†ï¼‰"></a>è®¾ç½® nginx è§„åˆ™ï¼ˆApache åŸºæœ¬ä¸ç”¨æ”¹ï¼Œåªéœ€è¦è‡ªå·±å»è®¾ç½®ä¸€ä¸‹ sslï¼Œå’Œå¸¸è§„çš„è®¾ç½®å°±è¡Œäº†ï¼‰</h3><p><strong>æ³¨æ„è§„åˆ™è®¾ç½®å¥½ä¹‹åï¼Œå®‰è£…çš„æ—¶å€™ç‚¹é«˜çº§è®¾ç½®ï¼Œä½¿ç”¨ mysql æˆ–è€…å…¶ä»–æ•°æ®åº“ï¼Œ<code>sqllite</code>çš„æ€§èƒ½ä¸å¤Ÿï¼Œç„¶åå°±æ˜¯æ•°æ®æ–‡ä»¶ç›®å½•å¡«å†™ä¹‹å‰ä½  ossfs çš„æŒ‚è½½ç›®å½•ï¼Œæˆ‘ä¹‹å‰æŒ‚è½½çš„æ˜¯<code>/data/cloud</code></strong></p><blockquote><p>åé¢æœ‰ 9.x å®˜æ–¹çš„ç¤ºä¾‹ï¼Œæˆ‘è¿™å„¿æç¤ºä¸€ä¸‹æœ‰äº›å‘çš„åœ°æ–¹</p></blockquote><p>1.æœ¬èº«çš„è®¾ç½®é‡Œé¢æ²¡æœ‰ log çš„è®¾ç½®ï¼Œä¸æ–¹ä¾¿ debugï¼Œaccess_log å¯ä»¥ä¸ç”¨ï¼Œerror_log è¿˜æ˜¯éœ€è¦åŠ ä¸Šçš„ 2.é‡Œé¢æ²¡æœ‰ index çš„è®¾ç½®ï¼Œå¦‚æœæ‰“å¼€é¦–é¡µä¸€ç‰‡ç©ºç™½ï¼ŒåŠ ä¸Š index.php ä¹‹åæ²¡æœ‰é—®é¢˜çš„è¯ï¼Œ</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs glsl"><span class="hljs-keyword">location</span> / &#123;<br><span class="hljs-keyword">index</span> <span class="hljs-keyword">index</span>.php <span class="hljs-meta">#åŠ ä¸Šè¿™ä¸€å¥</span><br>      rewrite ^ /<span class="hljs-keyword">index</span>.php$uri;<br>&#125;<br></code></pre></td></tr></table></figure><p>3.å¦‚æœä½ è¿›å…¥å®‰è£…é¡µé¢ï¼ŒæŒ‰ç…§æç¤ºå®‰è£…å¥½äº†ä¹‹åå‡ºç°è¯´<code>æ‰¾ä¸åˆ°æ–‡ä»¶ç›®å½•</code>ä¹‹ç±»çš„è¯ï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½æ˜¯ä½ æ²¡æœ‰å¼€å¯<code>pathinfo</code>ï¼Œowncloud éœ€è¦ pathinfo çš„æ”¯æŒ(ç¤ºä¾‹çš„é…ç½®é‡Œé¢æ˜¯æœ‰ pathinfo çš„è®¾ç½®çš„)</p><h3 id="NEXT"><a href="#NEXT" class="headerlink" title="NEXT"></a>NEXT</h3><blockquote><p>åˆ°è¿™é‡ŒåŸºæœ¬ä¸Š owncloud çš„å®‰è£…åº”è¯¥å°±ç»“æŸäº†ï¼Œä½¿ç”¨ä¹Ÿæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæˆ‘å»ºè®®å¼€å¯ sslï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæˆ‘å¼€äº† ssl ä¹‹åè®¿é—®çš„é€Ÿåº¦æå‡äº†å¥½å‡ å€</p></blockquote><p>é™„é€å®˜æ–¹æ’ä»¶çš„åœ°å€<a href="https://apps.owncloud.com/">ç‚¹æˆ‘ç‚¹æˆ‘</a>,å›½å†…ä¸»æœºåœ¨çº¿å®‰è£…æ’ä»¶å¯èƒ½è£…ä¸ä¸Šï¼Œå¯ä»¥ FQ ä¹‹ååœ¨è¿™é‡Œé¢ä¸‹è½½ç›¸åº”æ’ä»¶åŒ…ï¼Œä¸Šä¼ åˆ° apps ç›®å½•ä¸‹å³å¯ï¼Œä¸‹ä¸€ç¯‡è¯´ä¸€ä¸‹ç”¨ owncloud å®ç°ç¦»çº¿ä¸‹è½½åŠŸèƒ½ï¼Œç°åœ¨ 9.0.2 ç‰ˆæœ¬çš„ä½¿ç”¨ owncloud çš„ç¦»çº¿ä¸‹è½½æ’ä»¶æœ‰é—®é¢˜ï¼Œä½†æ˜¯çœ‹äº†ä¸€ä¸‹è¿™ä¸ª bug å¾ˆæ—©å°±æœ‰ï¼Œåªæ˜¯å¥½åƒä¸€ç›´æ²¡æœ‰ä¿®å¤ã€‚ä¹‹åæˆ‘æ”¹ä¸€ä¸‹èƒ½å¤Ÿç”¨äº†å†å†™ä¸‹ä¸€ç¯‡å§</p><h3 id="9-x-å®˜æ–¹ç¤ºä¾‹"><a href="#9-x-å®˜æ–¹ç¤ºä¾‹" class="headerlink" title="9.x å®˜æ–¹ç¤ºä¾‹"></a>9.x å®˜æ–¹ç¤ºä¾‹</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs nginx"> <span class="hljs-attribute">upstream</span> php-handler &#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:9000</span>; <span class="hljs-comment">#æ³¨æ„ä¸€ä¸‹ä½ è‡ªå·±çš„phpæœåŠ¡è®¾ç½®ï¼Œè¿™ä¸€è¡Œå¯èƒ½éœ€è¦è‡ªå·±è°ƒæ•´</span><br>    <span class="hljs-comment">#server unix:/var/run/php5-fpm.sock;</span><br>&#125;<br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> cloud.example.com;<br>    <span class="hljs-comment"># enforce https</span><br>    <span class="hljs-attribute">return</span> <span class="hljs-number">301</span> https://$server_name$request_uri;<br>&#125;<br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br>    <span class="hljs-attribute">server_name</span> cloud.example.com;<br><br>    <span class="hljs-comment">#sslè¯ä¹¦çš„ä½ç½®</span><br>    <span class="hljs-attribute">ssl_certificate</span> /etc/ssl/nginx/cloud.example.com.crt;<br>    <span class="hljs-attribute">ssl_certificate_key</span> /etc/ssl/nginx/cloud.example.com.key;<br><br>    <span class="hljs-comment"># Add headers to serve security related headers</span><br>    <span class="hljs-comment"># Before enabling Strict-Transport-Security headers please read into this</span><br>    <span class="hljs-comment"># topic first.</span><br><br>    <span class="hljs-comment"># å®‰è£…å¥½ä¹‹åï¼Œåå°å¯èƒ½ä¼šæç¤ºç›¸åº”é”™è¯¯ï¼ŒæŠŠè¿™ä¸€æ®µçš„æ³¨é‡Šå»æ‰å°±è¡Œ</span><br>    <span class="hljs-comment"># add_header Strict-Transport-Security &quot;max-age=15768000;</span><br>    <span class="hljs-comment"># includeSubDomains; preload;&quot;;</span><br><br>    <span class="hljs-comment">#åé¢å®‰è£…å¥½äº†ä¹‹ååå°å¯èƒ½ä¼šæç¤ºheaderçš„é”™è¯¯ï¼ŒæŠŠè¿™ä¸€çŸ­åˆ é™¤æ‰å³å¯</span><br>    <span class="hljs-attribute">add_header</span> X-Content-Type-Options nosniff;<br>    <span class="hljs-attribute">add_header</span> X-Frame-Options <span class="hljs-string">&quot;SAMEORIGIN&quot;</span>;<br>    <span class="hljs-attribute">add_header</span> X-XSS-Protection <span class="hljs-string">&quot;1; mode=block&quot;</span>;<br>    <span class="hljs-attribute">add_header</span> X-Robots-Tag <span class="hljs-literal">none</span>;<br>    <span class="hljs-attribute">add_header</span> X-Download-Options noopen;<br>    <span class="hljs-attribute">add_header</span> X-Permitted-Cross-Domain-Policies <span class="hljs-literal">none</span>;<br><br>    <span class="hljs-comment"># Path to the root of your installation</span><br>    <span class="hljs-attribute">root</span> /var/www/owncloud/;<br><br>    <span class="hljs-attribute">location</span> = /robots.txt &#123;<br>        <span class="hljs-attribute">allow</span> all;<br>        <span class="hljs-attribute">log_not_found</span> <span class="hljs-literal">off</span>;<br>        <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;<br>    &#125;<br><br>    <span class="hljs-comment"># The following 2 rules are only needed for the user_webfinger app.</span><br>    <span class="hljs-comment"># Uncomment it if you&#x27;re planning to use this app.</span><br>    <span class="hljs-comment">#rewrite ^/.well-known/host-meta /public.php?service=host-meta last;</span><br>    <span class="hljs-comment">#rewrite ^/.well-known/host-meta.json /public.php?service=host-meta-json</span><br>    <span class="hljs-comment"># last;</span><br><br>    <span class="hljs-attribute">location</span> = /.well-known/carddav &#123; <span class="hljs-attribute">return</span> <span class="hljs-number">301</span><br>     $scheme://$host/remote.php/dav; &#125;<br>    <span class="hljs-attribute">location</span> = /.well-known/caldav &#123; <span class="hljs-attribute">return</span> <span class="hljs-number">301</span><br>     $scheme://$host/remote.php/dav; &#125;<br><br>    <span class="hljs-attribute">location</span> /.well-known/acme-challenge &#123; &#125;<br><br>    <span class="hljs-comment"># set max upload size</span><br>    <span class="hljs-attribute">client_max_body_size</span> <span class="hljs-number">512M</span>;<br>    <span class="hljs-attribute">fastcgi_buffers</span> <span class="hljs-number">64</span> <span class="hljs-number">4K</span>;<br><br>    <span class="hljs-comment"># Disable gzip to avoid the removal of the ETag header</span><br>    <span class="hljs-attribute">gzip</span> <span class="hljs-literal">off</span>;<br><br>    <span class="hljs-comment"># Uncomment if your server is build with the ngx_pagespeed module</span><br>    <span class="hljs-comment"># This module is currently not supported.</span><br>    <span class="hljs-comment">#pagespeed off;</span><br><br>    <span class="hljs-attribute">error_page</span> <span class="hljs-number">403</span> /core/templates/<span class="hljs-number">403</span>.php;<br>    <span class="hljs-attribute">error_page</span> <span class="hljs-number">404</span> /core/templates/<span class="hljs-number">404</span>.php;<br><br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^</span> /index.php$uri;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/(?:build|tests|config|lib|3rdparty|templates|data)/</span> &#123;<br>        <span class="hljs-attribute">deny</span> all;<br>    &#125;<br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/(?:\.|autotest|occ|issue|indie|db_|console)</span> &#123;<br>        <span class="hljs-attribute">deny</span> all;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> ~<br>   <span class="hljs-regexp"> ^/(?:index|remote|public|cron|core/ajax/update|status|ocs/v[12]|updater</span><br><span class="hljs-regexp"></span>    /.+|ocs-provider/.+|core/templates/<span class="hljs-number">40</span>[<span class="hljs-number">34</span>])\.php(?:$|/) &#123;<br>        <span class="hljs-attribute">include</span> fastcgi_params;<br>        <span class="hljs-attribute">fastcgi_split_path_info</span><span class="hljs-regexp"> ^(.+\.php)(/.+)$</span>;<br>        <span class="hljs-attribute">fastcgi_param</span> SCRIPT_FILENAME $document_root$fastcgi_script_name;<br>        <span class="hljs-attribute">fastcgi_param</span> PATH_INFO $fastcgi_path_info;<br>        <span class="hljs-attribute">fastcgi_param</span> HTTPS <span class="hljs-literal">on</span>;<br>        <span class="hljs-comment">#Avoid sending the security headers twice</span><br>        <span class="hljs-attribute">fastcgi_param</span> modHeadersAvailable <span class="hljs-literal">true</span>;<br>        <span class="hljs-attribute">fastcgi_param</span> front_controller_active <span class="hljs-literal">true</span>;<br>        <span class="hljs-attribute">fastcgi_pass</span> php-handler;<br>        <span class="hljs-attribute">fastcgi_intercept_errors</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-attribute">fastcgi_request_buffering</span> <span class="hljs-literal">off</span>;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/(?:updater|ocs-provider)(?:$|/)</span> &#123;<br>        <span class="hljs-attribute">try_files</span> $uri/ =<span class="hljs-number">404</span>;<br>        <span class="hljs-attribute">index</span> index.php;<br>    &#125;<br><br>    <span class="hljs-comment"># Adding the cache control header for js and css files</span><br>    <span class="hljs-comment"># Make sure it is BELOW the PHP block</span><br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* \.(?:css|js)$</span> &#123;<br>        <span class="hljs-attribute">try_files</span> $uri /index.php$uri$is_args$args;<br>        <span class="hljs-attribute">add_header</span> Cache-Control <span class="hljs-string">&quot;public, max-age=7200&quot;</span>;<br>        <span class="hljs-comment"># Add headers to serve security related headers (It is intended to</span><br>        <span class="hljs-comment"># have those duplicated to the ones above)</span><br>        <span class="hljs-comment"># Before enabling Strict-Transport-Security headers please read into</span><br>        <span class="hljs-comment"># this topic first.</span><br>        <span class="hljs-comment"># add_header Strict-Transport-Security &quot;max-age=15768000;</span><br>        <span class="hljs-comment">#  includeSubDomains; preload;&quot;;</span><br>        <span class="hljs-attribute">add_header</span> X-Content-Type-Options nosniff;<br>        <span class="hljs-attribute">add_header</span> X-Frame-Options <span class="hljs-string">&quot;SAMEORIGIN&quot;</span>;<br>        <span class="hljs-attribute">add_header</span> X-XSS-Protection <span class="hljs-string">&quot;1; mode=block&quot;</span>;<br>        <span class="hljs-attribute">add_header</span> X-Robots-Tag <span class="hljs-literal">none</span>;<br>        <span class="hljs-attribute">add_header</span> X-Download-Options noopen;<br>        <span class="hljs-attribute">add_header</span> X-Permitted-Cross-Domain-Policies <span class="hljs-literal">none</span>;<br>        <span class="hljs-comment"># Optional: Don&#x27;t log access to assets</span><br>        <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;<br>    &#125;<br><br>    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* \.(?:svg|gif|png|html|ttf|woff|ico|jpg|jpeg)$</span> &#123;<br>        <span class="hljs-attribute">try_files</span> $uri /index.php$uri$is_args$args;<br>        <span class="hljs-comment"># Optional: Don&#x27;t log access to other assets</span><br>        <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>php</tag>
      
      <tag>lnmp</tag>
      
      <tag>äº‘ç›˜</tag>
      
      <tag>owncloud</tag>
      
      <tag>oss</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å››å·å¤§å­¦è¯„æ•™å¼€æºä»£ç </title>
    <link href="/post/31503.html"/>
    <url>/post/31503.html</url>
    
    <content type="html"><![CDATA[<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">require</span> <span class="hljs-string">&quot;login.php&quot;</span>;<br><span class="hljs-keyword">require</span> <span class="hljs-string">&quot;QueryList.class.php&quot;</span>;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">evaluate</span></span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$_listUrl</span>=<span class="hljs-string">&quot;http://202.115.47.141/jxpgXsAction.do?oper=listWj&amp;page=&quot;</span>;<span class="hljs-comment">//è¯„æ•™åˆ—è¡¨é¡µé¢</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$_formUrl</span>=<span class="hljs-string">&quot;http://202.115.47.141/jxpgXsAction.do?oper=wjShow&amp;&quot;</span>;<span class="hljs-comment">//è¯„æ•™è¡¨å•é¡µé¢</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$_postUrl</span>=<span class="hljs-string">&quot;http://202.115.47.141/jxpgXsAction.do?oper=wjpg&amp;&quot;</span>;<span class="hljs-comment">//è¯„æ•™æäº¤åœ°å€</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$_yjpj</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$_successNo</span>=<span class="hljs-number">0</span>;<span class="hljs-comment">//æˆåŠŸæ¬¡æ•°</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$_failNo</span>=<span class="hljs-number">0</span>;<span class="hljs-comment">//å¤±è´¥æ¬¡æ•°</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>,<span class="hljs-variable">$pass</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br><br>        <span class="hljs-keyword">$this</span>-&gt;_yjpj=<span class="hljs-keyword">new</span> login(<span class="hljs-variable">$name</span>,<span class="hljs-variable">$pass</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–è¯„æ•™åˆ—è¡¨å¹¶ä¸”è¿”å›åˆ—è¡¨ä¿¡æ¯ä»¥åŠé¡µç </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> mohuishou&lt;1<span class="hljs-doctag">@lailin</span>.xyz&gt;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> mixed</span><br><span class="hljs-comment">     *       $list=[</span><br><span class="hljs-comment">     *           &#x27;info&#x27;=&gt;[</span><br><span class="hljs-comment">     *               [</span><br><span class="hljs-comment">     *                   &#x27;param&#x27;=&gt;[</span><br><span class="hljs-comment">     *                       0 =&gt; &#x27;0000000038&#x27;,</span><br><span class="hljs-comment">     *                       1 =&gt; &#x27;19873162&#x27;,</span><br><span class="hljs-comment">     *                       2 =&gt; &#x27;é«˜è‹¹&#x27;,</span><br><span class="hljs-comment">     *                       3 =&gt; &#x27;å­¦è¯„æ•™&#x27;,</span><br><span class="hljs-comment">     *                       4 =&gt; &#x27;é©¬å…‹æ€ä¸»ä¹‰åŸºæœ¬åŸç†æ¦‚è®º&#x27;,</span><br><span class="hljs-comment">     *                       5 =&gt; &#x27;107021030&#x27;,</span><br><span class="hljs-comment">     *                   ],</span><br><span class="hljs-comment">     *                   &#x27;status&#x27;=&gt;0</span><br><span class="hljs-comment">     *               ],</span><br><span class="hljs-comment">     *              ......</span><br><span class="hljs-comment">     *           ],</span><br><span class="hljs-comment">     *           &#x27;page&#x27;=&gt;[</span><br><span class="hljs-comment">     *               [</span><br><span class="hljs-comment">     *                   &#x27;page&#x27;=&gt;&#x27;2&#x27;</span><br><span class="hljs-comment">     *               ]</span><br><span class="hljs-comment">     *           ]</span><br><span class="hljs-comment">     *       ];</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">getList</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-comment">/*--------------è·å–ç¬¬ä¸€é¡µçš„è¯„æ•™åˆ—è¡¨é¡µé¢---------------*/</span><br>        <span class="hljs-variable">$listContent</span>=<span class="hljs-keyword">$this</span>-&gt;_yjpj-&gt;show(<span class="hljs-keyword">$this</span>-&gt;_listUrl.<span class="hljs-string">&quot;1&quot;</span>);<br><br>        <span class="hljs-comment">/*------------è·å–è¯„æ•™åˆ†é¡µä¿¡æ¯--------------*/</span><br>        <span class="hljs-variable">$pageReg</span>=[<br>            <span class="hljs-string">&#x27;page&#x27;</span>=&gt;[<span class="hljs-string">&#x27;script:eq(3)&#x27;</span>,<span class="hljs-string">&#x27;html&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable">$page</span></span>)</span>&#123;<br>                <span class="hljs-variable">$pattern</span>=<span class="hljs-string">&quot;/document\.all\.pageNo\.value&gt;(.)/&quot;</span>;<br>                preg_match(<span class="hljs-variable">$pattern</span>,<span class="hljs-variable">$page</span>,<span class="hljs-variable">$no</span>);<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$no</span>[<span class="hljs-number">1</span>])&#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-variable">$no</span>[<span class="hljs-number">1</span>];<br>                &#125;<br><br>            &#125;]<br>        ];<br>        <span class="hljs-variable">$page</span>=QueryList::Query(<span class="hljs-variable">$listContent</span>,<span class="hljs-variable">$pageReg</span>);<br>        <span class="hljs-variable">$page</span>=<span class="hljs-variable">$page</span>-&gt;jsonArr[<span class="hljs-number">0</span>][<span class="hljs-string">&#x27;page&#x27;</span>];<br><br>        <span class="hljs-comment">/*---------è·å–è¯„æ•™è€å¸ˆä¿¡æ¯--------------*/</span><br>        <span class="hljs-variable">$listReg</span>=[<br>            <span class="hljs-string">&#x27;param&#x27;</span>=&gt;[<span class="hljs-string">&#x27;img&#x27;</span>,<span class="hljs-string">&#x27;name&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable">$a</span></span>)</span>&#123;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$a</span>)&#123;<br>                    <span class="hljs-keyword">return</span> explode(<span class="hljs-string">&#x27;#@&#x27;</span>,<span class="hljs-variable">$a</span>);<br>                &#125;<br>            &#125;],<br>            <span class="hljs-string">&#x27;status&#x27;</span>=&gt;[<span class="hljs-string">&#x27;img&#x27;</span>,<span class="hljs-string">&#x27;onclick&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable">$a</span></span>)</span>&#123;<br>                <span class="hljs-keyword">if</span>(trim(<span class="hljs-variable">$a</span>)==<span class="hljs-string">&quot;evaluation(this)&quot;</span>)&#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>                &#125;<br>            &#125;],<br>        ];<br><br>        <span class="hljs-comment">/*[ä¼˜åŒ–]ï¼šå‡å°‘é‡å¤æŠ“å–åˆ—è¡¨é¡µï¼Œå¤§å¤§æé«˜æ•ˆç‡*/</span><br>        <span class="hljs-variable">$c</span>=QueryList::Query(<span class="hljs-variable">$listContent</span>,<span class="hljs-variable">$listReg</span>);<br>        <span class="hljs-variable">$list</span>[]=<span class="hljs-variable">$c</span>-&gt;jsonArr;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$page</span>&gt;<span class="hljs-number">1</span>)&#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">2</span>;<span class="hljs-variable">$i</span>&lt;=<span class="hljs-variable">$page</span>;<span class="hljs-variable">$i</span>++)&#123;<br>                <span class="hljs-variable">$listContent</span>=<span class="hljs-keyword">$this</span>-&gt;_yjpj-&gt;show(<span class="hljs-keyword">$this</span>-&gt;_listUrl.<span class="hljs-variable">$i</span>);<br>                <span class="hljs-variable">$c</span>=QueryList::Query(<span class="hljs-variable">$listContent</span>,<span class="hljs-variable">$listReg</span>);<br>                <span class="hljs-variable">$list</span>[]=<span class="hljs-variable">$c</span>-&gt;jsonArr;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$list</span>;<span class="hljs-comment">//è·å–åˆ°çš„è¯„æ•™ä¿¡æ¯</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPostInfo</span>(<span class="hljs-params"><span class="hljs-variable">$list</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br><span class="hljs-comment">//        print_r($list);</span><br>        <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$list</span> <span class="hljs-keyword">as</span>  <span class="hljs-variable">$listVal</span>)&#123;<br><span class="hljs-comment">//            print_r($listVal);</span><br>            <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$listVal</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$listkey</span> =&gt; <span class="hljs-variable">$listValue</span>)&#123;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$listValue</span>[<span class="hljs-string">&#x27;status&#x27;</span>]==<span class="hljs-number">1</span>)&#123;<br><span class="hljs-comment">//                    print_r($listValue);</span><br>                    <span class="hljs-variable">$param</span>=[<br>                        <span class="hljs-string">&#x27;wjbm&#x27;</span>=&gt;<span class="hljs-variable">$listValue</span>[<span class="hljs-string">&#x27;param&#x27;</span>][<span class="hljs-number">0</span>],<br>                        <span class="hljs-string">&#x27;bpr&#x27;</span>=&gt;<span class="hljs-variable">$listValue</span>[<span class="hljs-string">&#x27;param&#x27;</span>][<span class="hljs-number">1</span>],<br>                        <span class="hljs-string">&#x27;pgnr&#x27;</span>=&gt;<span class="hljs-variable">$listValue</span>[<span class="hljs-string">&#x27;param&#x27;</span>][<span class="hljs-number">5</span>],<br>                    ];<br>                    <span class="hljs-variable">$param</span>=http_build_query(<span class="hljs-variable">$param</span>);<br>                    <span class="hljs-variable">$url</span>=<span class="hljs-keyword">$this</span>-&gt;_formUrl.<span class="hljs-variable">$param</span>;<br><span class="hljs-comment">//                    echo $url;</span><br>                    <span class="hljs-variable">$formContent</span>=<span class="hljs-keyword">$this</span>-&gt;_yjpj-&gt;show(<span class="hljs-variable">$url</span>);<br><span class="hljs-comment">//                    print_r($formContent);</span><br>                    <span class="hljs-variable">$res</span>=QueryList::Query(<span class="hljs-variable">$formContent</span>,[<span class="hljs-string">&#x27;name&#x27;</span>=&gt;[<span class="hljs-string">&#x27;[value=10_1]&#x27;</span>,<span class="hljs-string">&#x27;name&#x27;</span>]]);<br><br>                    <span class="hljs-comment">/*--------------å°†è·å–çš„è¡¨å•ä¿¡æ¯æ•´ç†æˆä¸ºå³å°†postçš„å‚æ•°-------------*/</span><br>                    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$res</span>-&gt;jsonArr <span class="hljs-keyword">as</span> <span class="hljs-variable">$postKey</span> =&gt; <span class="hljs-variable">$postValue</span>)&#123;<br>                        <span class="hljs-variable">$postParam</span>[<span class="hljs-variable">$postValue</span>[<span class="hljs-string">&#x27;name&#x27;</span>]]=<span class="hljs-string">&quot;10_1&quot;</span>;<br>                    &#125;<br>                    <span class="hljs-variable">$postParam</span>[<span class="hljs-string">&#x27;wjbm&#x27;</span>]=<span class="hljs-variable">$listValue</span>[<span class="hljs-string">&#x27;param&#x27;</span>][<span class="hljs-number">0</span>];<br>                    <span class="hljs-variable">$postParam</span>[<span class="hljs-string">&#x27;bpr&#x27;</span>]=<span class="hljs-variable">$listValue</span>[<span class="hljs-string">&#x27;param&#x27;</span>][<span class="hljs-number">1</span>];<br>                    <span class="hljs-variable">$postParam</span>[<span class="hljs-string">&#x27;pgnr&#x27;</span>]=<span class="hljs-variable">$listValue</span>[<span class="hljs-string">&#x27;param&#x27;</span>][<span class="hljs-number">5</span>];<br>                    <span class="hljs-variable">$postParam</span>[<span class="hljs-string">&#x27;zgpj&#x27;</span>]=<span class="hljs-string">&quot;very good teacher!!&quot;</span>;<br>                    <span class="hljs-keyword">$this</span>-&gt;post(<span class="hljs-variable">$postParam</span>);<br><span class="hljs-comment">//                    return 0;</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">post</span>(<span class="hljs-params"><span class="hljs-variable">$param</span></span>)</span>&#123;<br>        <span class="hljs-variable">$param</span>=http_build_query(<span class="hljs-variable">$param</span>);<br>        <span class="hljs-variable">$url</span>=<span class="hljs-keyword">$this</span>-&gt;_postUrl.<span class="hljs-variable">$param</span>;<br><span class="hljs-comment">//        echo $url;</span><br>        <span class="hljs-variable">$evalContent</span>=<span class="hljs-keyword">$this</span>-&gt;_yjpj-&gt;show(<span class="hljs-variable">$url</span>);<br><br>        <span class="hljs-comment">/*--------------------æŠ“å–æäº¤ä¹‹åçš„æ•°æ®æŸ¥çœ‹æ˜¯å¦æˆåŠŸæäº¤--------------------*/</span><br>        <span class="hljs-variable">$res</span>=QueryList::Query(<span class="hljs-variable">$evalContent</span>,[<span class="hljs-string">&#x27;info&#x27;</span>=&gt;[<span class="hljs-string">&#x27;script&#x27;</span>,<span class="hljs-string">&#x27;html&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable">$a</span></span>)</span>&#123;<br>            <span class="hljs-variable">$pattern</span>=<span class="hljs-string">&#x27;/alert\(&quot;(.+)&quot;\)/&#x27;</span>;<br>            preg_match_all(<span class="hljs-variable">$pattern</span>,<span class="hljs-variable">$a</span>,<span class="hljs-variable">$res</span>);<br>            <span class="hljs-variable">$success</span>=<span class="hljs-string">&#x27;è¯„ä¼°æˆåŠŸï¼&#x27;</span>;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$res</span>[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]==<span class="hljs-variable">$success</span>)&#123;<br>                <span class="hljs-variable">$a</span>=[<br>                    <span class="hljs-string">&#x27;message&#x27;</span>=&gt;<span class="hljs-variable">$res</span>[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>],<br>                    <span class="hljs-string">&#x27;status&#x27;</span>=&gt;<span class="hljs-number">1</span><br>                ];<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-variable">$a</span>=[<br>                    <span class="hljs-string">&#x27;message&#x27;</span>=&gt;<span class="hljs-variable">$res</span>[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>],<br>                    <span class="hljs-string">&#x27;status&#x27;</span>=&gt;<span class="hljs-number">0</span><br>                ];<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$a</span>;<br>        &#125;]]);<br>        <span class="hljs-variable">$status</span>=<span class="hljs-variable">$res</span>-&gt;jsonArr[<span class="hljs-number">0</span>][<span class="hljs-string">&#x27;info&#x27;</span>][<span class="hljs-string">&#x27;status&#x27;</span>];<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$status</span>==<span class="hljs-number">1</span>)&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;_successNo+=<span class="hljs-number">1</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;_failNo+=<span class="hljs-number">1</span>;<br>        &#125;<br><span class="hljs-comment">//        print_r($res-&gt;jsonArr);</span><br>    &#125;<br><br><br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;getPostInfo(<span class="hljs-keyword">$this</span>-&gt;getList());<br>        <span class="hljs-keyword">$this</span>-&gt;count();<br>      <span class="hljs-keyword">return</span> [<span class="hljs-string">&#x27;success&#x27;</span>=&gt;<span class="hljs-keyword">$this</span>-&gt;_successNo,<span class="hljs-string">&#x27;fail&#x27;</span>=&gt;<span class="hljs-keyword">$this</span>-&gt;_failNo];<br>        <span class="hljs-comment">//return &#x27;è¯„æ•™æˆåŠŸï¼ŒæˆåŠŸï¼š&#x27;.$this-&gt;_successNo.&#x27;ä½ï¼Œ&#x27;.&#x27;å¤±è´¥ï¼š&#x27;.$this-&gt;_failNo.&quot;ä½&quot;;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>å¤§å­¦</category>
      
    </categories>
    
    
    <tags>
      
      <tag>php</tag>
      
      <tag>å››å·å¤§å­¦</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Composerä¸Šçº¿å‰çš„ä¼˜åŒ–</title>
    <link href="/post/36128.html"/>
    <url>/post/36128.html</url>
    
    <content type="html"><![CDATA[<p>æ›´æ–°ä¹‹åæˆ–è€…ä¸Šçº¿å‰åˆ«å¿˜äº†æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤<br>å¦åˆ™å°‘åˆ™æŸå¤± 20%-50%çš„æ€§èƒ½ï¼Œå¤šåˆ™ç¨‹åºç›´æ¥æŠ¥é”™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">composer dump-autoload --optimize<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>php</tag>
      
      <tag>composer</tag>
      
      <tag>ä¼˜åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>phpè¯†åˆ«éªŒè¯ç ï¼ˆäºŒï¼‰</title>
    <link href="/post/10661.html"/>
    <url>/post/10661.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>åœ¨ php è¯†åˆ«éªŒè¯ç ï¼ˆä¸€ï¼‰å½“ä¸­è¯´äº†åŸºæœ¬çš„è¯†åˆ«éªŒè¯ç çš„æ–¹æ³•ï¼ŒåŠå…¶å…³é”®çš„ä»£ç ï¼Œä½†æ˜¯æœ€åæˆ‘ä»¬ç•™ä¸‹äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¯¹äºæœ‰æ—‹è½¬çš„éªŒè¯ç çš„è¯†åˆ«ç‡åŠå…¶ä½ä¸‹çš„é—®é¢˜ï¼Œä¸‹é¢æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p></blockquote><h2 id="æ ‡å‡†åŒ–"><a href="#æ ‡å‡†åŒ–" class="headerlink" title="æ ‡å‡†åŒ–"></a>æ ‡å‡†åŒ–</h2><blockquote><p>è§£å†³ç±»ä¼¼äºä¸‹é¢å›¾ç‰‡è¿™ç§æœ‰æ—‹è½¬å­—ç¬¦çš„éªŒè¯ç ï¼Œæˆ‘ä»¬é¦–å…ˆè¦ç»™å‡ºä¸€ç§æ ‡å‡†ï¼Œè®©æ‰€æœ‰çš„åˆ†å‰²åçš„å›¾ç‰‡éƒ½æŒ‰ç…§ä¸€ä¸ªæ ‡å‡†æ¥æ‘†æ”¾ï¼Œæœ€åå¯¹æ¯”çš„æ—¶å€™æ‰èƒ½å¤Ÿç»Ÿä¸€</p></blockquote><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/1900195239.png" alt="inImgTemp.png"></p><p><strong>å¦‚ä½•æ ‡å‡†åŒ–ï¼Ÿ</strong></p><ul><li><p>æˆ‘ä»¬å¯¹ä¸€ä¸ªå­—ç¬¦è¿›è¡Œæ—‹è½¬ï¼Œç„¶åè®¡ç®—è¿™ä¸ªå­—ç¬¦çš„å®½åº¦ï¼Œå½“å®½åº¦æœ€å°æ—¶ï¼Œæˆ‘ä»¬è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªæ ‡å‡†å­—ç¬¦ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å¤Ÿå¾—åˆ°æ¯”è¾ƒå¥½çš„ç»“æœäº†ï¼ˆé€šè¿‡è§‚å¯Ÿè¿™ç§éªŒè¯ç ï¼Œå‘ç°ä¸€èˆ¬åªè¦å·¦å³æ—‹è½¬ä¸‰ååº¦å³å¯ï¼‰</p></li><li><p>ç„¶åä»…ä»…è¿›è¡Œæ—‹è½¬è¿˜ä¸å¤Ÿï¼Œä¸ºäº†èƒ½å¤Ÿå’Œæ¨¡æ¿ä¹Ÿå°±æ˜¯ç‰¹å¾å€¼åº“è¿›è¡Œå¯¹æ¯”ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ï¼Œç»Ÿä¸€å­—ç¬¦é•¿åº¦ã€‚ä¹Ÿå°±æ˜¯äºŒå€¼åŒ–ä¹‹åçš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œè¿™æ—¶å°±éœ€è¦ç”»ä¸€å¼ é•¿å®½å›ºå®šçš„å›¾ç‰‡ï¼ŒæŠŠæˆ‘ä»¬åŸæ¥çš„å›¾ç‰‡æŒ‰ç…§æ¯”ä¾‹æ‹‰ä¼¸å‹ç¼©å¤åˆ¶è¿‡å»</p></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs php">    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å›¾åƒæ ‡å‡†åŒ–ï¼Œå°†æ—‹è½¬çš„å›¾åƒæ ‡å‡†åŒ–</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> mohuishou&lt;1<span class="hljs-doctag">@lailin</span>.xyz&gt;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> $img</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> resource æ ‡å‡†çš„å›¾åƒèµ„æºå¥æŸ„</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">imageStandard</span>(<span class="hljs-params"><span class="hljs-variable">$img</span></span>)</span>&#123;<br>        <span class="hljs-variable">$min_w</span>=<span class="hljs-number">999</span>;<br>        <span class="hljs-variable">$oimg</span>=<span class="hljs-variable">$img</span>;<br><br>        <span class="hljs-variable">$c</span>=imagecolorallocate(<span class="hljs-variable">$img</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">-30</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-number">30</span>;<span class="hljs-variable">$i</span>++)&#123;<br>            <span class="hljs-variable">$simg</span>=imagerotate(<span class="hljs-variable">$img</span>,<span class="hljs-variable">$i</span>,<span class="hljs-variable">$c</span>);<br><span class="hljs-comment">//            //è®¡ç®—å­—ç¬¦å®½åº¦</span><br>            <span class="hljs-variable">$simg_hash_data</span>=<span class="hljs-keyword">$this</span>-&gt;getWidth(<span class="hljs-variable">$simg</span>);<br>            <span class="hljs-variable">$w</span>=count(<span class="hljs-variable">$simg_hash_data</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$w</span>&lt;<span class="hljs-variable">$min_w</span>)&#123;<br>                <span class="hljs-variable">$oimg_hash_data</span>=<span class="hljs-variable">$simg_hash_data</span>;<br>                <span class="hljs-variable">$min_w</span>=<span class="hljs-variable">$w</span>;<br>            &#125;<br><br>        &#125;<br><br>        <span class="hljs-variable">$out_img_w</span>=count(<span class="hljs-variable">$oimg_hash_data</span>);<br>        <span class="hljs-variable">$out_img_h</span>=count(<span class="hljs-variable">$oimg_hash_data</span>[<span class="hljs-number">0</span>]);<br><br>        <span class="hljs-variable">$out_img</span> = imagecreatetruecolor(<span class="hljs-variable">$out_img_w</span>,<span class="hljs-variable">$out_img_h</span>);<span class="hljs-comment">//åˆ›å»ºä¸€å¹…çœŸå½©è‰²å›¾åƒ</span><br>        <span class="hljs-variable">$bg</span>=imagecolorallocate(<span class="hljs-variable">$out_img</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);<span class="hljs-comment">//èƒŒæ™¯è‰²ç”»ä¸ºç™½è‰²</span><br>        imagefill(<span class="hljs-variable">$out_img</span>, <span class="hljs-number">0</span>,<span class="hljs-number">0</span>, <span class="hljs-variable">$bg</span>);<br><br>        <span class="hljs-comment">//ä¸€åˆ—ä¸€åˆ—çš„è¿›è¡Œç”»å›¾</span><br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$oimg_hash_data</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$k</span>=&gt;<span class="hljs-variable">$v</span>)&#123;<br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$v</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span>=&gt; <span class="hljs-variable">$val</span>)&#123;<br>                <span class="hljs-variable">$color</span>=<span class="hljs-number">255</span>;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$val</span>) <span class="hljs-variable">$color</span>=<span class="hljs-number">0</span>;<br>                <span class="hljs-variable">$c</span> = imagecolorallocate(<span class="hljs-variable">$out_img</span>, <span class="hljs-variable">$color</span>, <span class="hljs-variable">$color</span>, <span class="hljs-variable">$color</span>);<br>                imagesetpixel(<span class="hljs-variable">$out_img</span>, <span class="hljs-variable">$k</span>,<span class="hljs-variable">$key</span>, <span class="hljs-variable">$c</span>);<br>            &#125;<br>        &#125;<br><br><span class="hljs-comment">//        imagepng($out_img,&#x27;./0.png&#x27;);</span><br><br><br>        <span class="hljs-variable">$hash_img</span> = imagecreatetruecolor(<span class="hljs-built_in">self</span>::HASH_W, <span class="hljs-built_in">self</span>::HASH_H);<br>        imagecopyresized(<span class="hljs-variable">$hash_img</span>, <span class="hljs-variable">$out_img</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">self</span>::HASH_W,<span class="hljs-built_in">self</span>::HASH_H,<span class="hljs-variable">$out_img_w</span>,<span class="hljs-variable">$out_img_h</span>);<br><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$hash_img</span>;<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–å›¾åƒçš„å®½åº¦</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> mohuishou&lt;1<span class="hljs-doctag">@lailin</span>.xyz&gt;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> $img å›¾åƒèµ„æºå¥æŸ„</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> int</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidth</span>(<span class="hljs-params"><span class="hljs-variable">$img</span></span>)</span>&#123;<br>        <span class="hljs-comment">//æ ¹æ®èµ„æºå¥æŸ„è·å–æ•´ä¸ªå›¾åƒçš„é«˜ä¸å®½</span><br>        <span class="hljs-variable">$img_w</span>=imagesx(<span class="hljs-variable">$img</span>);<br>        <span class="hljs-variable">$img_h</span>=imagesy(<span class="hljs-variable">$img</span>);<br><br>        <span class="hljs-comment">//å›¾åƒäºŒå€¼åŒ–</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt;<span class="hljs-variable">$img_h</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-variable">$j</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$j</span> &lt;<span class="hljs-variable">$img_w</span>; <span class="hljs-variable">$j</span>++) &#123;<br>                <span class="hljs-variable">$rgb</span> = imagecolorat(<span class="hljs-variable">$img</span>,<span class="hljs-variable">$j</span>,<span class="hljs-variable">$i</span>);<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$rgb</span>==<span class="hljs-number">0</span>)&#123;<br>                    <span class="hljs-variable">$data</span>[<span class="hljs-variable">$i</span>][<span class="hljs-variable">$j</span>]=<span class="hljs-number">1</span>;<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    <span class="hljs-variable">$data</span>[<span class="hljs-variable">$i</span>][<span class="hljs-variable">$j</span>]=<span class="hljs-number">0</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//å»æ‰é›¶è¡Œ</span><br>        <span class="hljs-variable">$data</span>=<span class="hljs-keyword">$this</span>-&gt;removeZero(<span class="hljs-variable">$data</span>);<br><br>        <span class="hljs-comment">//æŒ‰åˆ—å–å›¾åƒè·å–å®½åº¦</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-variable">$img_w</span>;<span class="hljs-variable">$i</span>++)&#123;<br>            <span class="hljs-variable">$column</span>=array_column(<span class="hljs-variable">$data</span>,<span class="hljs-variable">$i</span>);<br>            <span class="hljs-keyword">if</span>(implode(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$column</span>)!=<span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-variable">$data1</span>[]=<span class="hljs-variable">$column</span>;<br>            &#125;<br>        &#125;<br><br><br>        <span class="hljs-comment">//è¿”å›</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$data1</span>;<br><br><br>    &#125;<br></code></pre></td></tr></table></figure><blockquote><p>çœ‹ä¸Šæ–¹çš„ä»£ç å‘ç°ä¼šæœ‰ä¸€ä¸ªå»é™¤é›¶è¡Œçš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯å»é™¤ç©ºç™½è¡Œï¼Œè¿™ä¸€æ­¥æ“ä½œçš„ç›®çš„ä¸»è¦æ˜¯ä¸ºäº†å‡ºæ‰ä¸Šä¸‹å·¦å³æ— ç”¨çš„ç©ºç™½éƒ¨åˆ†ï¼Œåœ¨æˆ‘ä»¬è¿›è¡Œæ¨¡æ¿å¯¹æ¯”çš„æ—¶å€™æ›´åŠ çš„ç²¾ç¡®</p></blockquote><h2 id="å»ºç«‹ç‰¹å¾å€¼åº“"><a href="#å»ºç«‹ç‰¹å¾å€¼åº“" class="headerlink" title="å»ºç«‹ç‰¹å¾å€¼åº“"></a>å»ºç«‹ç‰¹å¾å€¼åº“</h2><blockquote><p>ä¹‹å‰æåˆ°äº†å¾ˆå¤šå’Œæ¨¡æ¿æˆ–è€…æ˜¯ç‰¹å¾å€¼åº“è¿›è¡Œæ¯”è¾ƒï¼Œé‚£æˆ‘ä»¬å¦‚ä½•æ¥å»ºç«‹è¿™ä¸ªåº“å‘¢ï¼Ÿä¸‹é¢è¯´ä¸€ä¸‹æœ€ç®€å•çš„ä¸¤ç§æ–¹æ³•</p></blockquote><ul><li>ç¬¬ä¸€ç§ï¼Œå°±æ˜¯æŠŠä½ éœ€è¦çš„æ•°å­—å¯èƒ½è¿˜æœ‰ 26 ä¸ªå­—æ¯ï¼Œéƒ½å…ˆè¯†åˆ«ä¸€éç„¶åå­˜åˆ°ä¸€ä¸ªæ–‡ä»¶å½“ä¸­ï¼Œä½¿ç”¨çš„æ—¶å€™åŒ…å«è¿™ä¸ªæ–‡ä»¶è¿›è¡Œå¯¹æ¯”å°±è¡Œäº†</li><li>ç¬¬äºŒç§ï¼Œä¹Ÿå·®ä¸å¤šï¼Œå¯ä»¥å†™ä¸€ä¸ª study æ–‡ä»¶ï¼Œè®©ä¸Šé¢çš„æ­¥éª¤ç¨å¾®æ™ºèƒ½ä¸€ç‚¹ï¼Œç›´æ¥è¾“å…¥ä¹‹åï¼Œè‡ªåŠ¨å‚¨å­˜åˆ°æ•°æ®åº“ä¸­</li></ul><p>ä¸‹é¢æ˜¯æˆ‘å†™çš„ä¸€ä¸ªé’ˆå¯¹è”é€šä¼˜é€‰åœ¨æ²ƒçš„ä¸€ä¸ªå°çš„è„šæœ¬ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¯¹äºè¿™ç§é€šè¿‡é“¾æ¥æ¥è¯†åˆ«çš„ï¼Œä¸€å®šè¦å…ˆå°†é“¾æ¥çš„å›¾ç‰‡ä¿å­˜ä¸‹æ¥ï¼Œå› ä¸ºé“¾æ¥æ²¡è·å–ä¸€æ¬¡å›¾ç‰‡å°±ä¼šæ”¹å˜ä¸€æ¬¡</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by mohuishou&lt;1<span class="hljs-doctag">@lailin</span>.xyz&gt;.</span><br><span class="hljs-comment"> * User: mohuishou&lt;1<span class="hljs-doctag">@lailin</span>.xyz&gt;</span><br><span class="hljs-comment"> * Date: 2016/5/1 0001</span><br><span class="hljs-comment"> * Time: 20:44</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">require_once</span> <span class="hljs-string">&#x27;Image.class.php&#x27;</span>;<br><span class="hljs-keyword">require_once</span>  <span class="hljs-string">&#x27;DB.class.php&#x27;</span>;<br><span class="hljs-variable">$db</span>=<span class="hljs-keyword">new</span> \ImageOCR\DB();<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;send&#x27;</span>])&amp;&amp;<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;send&#x27;</span>]==<span class="hljs-string">&quot;send&quot;</span>)&#123;<br>    <span class="hljs-variable">$image</span>=<span class="hljs-keyword">new</span> \ImageOCR\Image(<span class="hljs-string">&quot;./img/inImgTemp.png&quot;</span>);<br>    <span class="hljs-variable">$code</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;code&#x27;</span>];<br>    <span class="hljs-variable">$code_arr</span>=str_split(<span class="hljs-variable">$code</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-variable">$image</span>::CHAR_NUM;<span class="hljs-variable">$i</span>++)&#123;<br>        <span class="hljs-variable">$hash_img_data</span>=implode(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$image</span>-&gt;splitImage(<span class="hljs-variable">$i</span>));<br>        <span class="hljs-variable">$db</span>-&gt;add(<span class="hljs-variable">$code_arr</span>[<span class="hljs-variable">$i</span>],<span class="hljs-variable">$hash_img_data</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;location.href=&#x27;./study.php&#x27;;&lt;/script&gt;&quot;</span>;<br><br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-variable">$image</span>=<span class="hljs-keyword">new</span> \ImageOCR\Image(<span class="hljs-string">&quot;http://www.169ol.com/Mall/Code/getCode&amp;1462104790492&quot;</span>);<br>    imagepng(<span class="hljs-variable">$image</span>-&gt;_in_img,<span class="hljs-string">&quot;./img/inImgTemp.png&quot;</span>);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>    &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>    &lt;title&gt;Study&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>    &lt;form action=<span class="hljs-string">&quot;&quot;</span> method=<span class="hljs-string">&quot;post&quot;</span>&gt;<br>        &lt;img src=<span class="hljs-string">&quot;img/inImgTemp.png&quot;</span>&gt;<br>        &lt;input type=<span class="hljs-string">&quot;text&quot;</span> name=<span class="hljs-string">&quot;code&quot;</span>&gt;<br>        &lt;input name=<span class="hljs-string">&quot;send&quot;</span> type=<span class="hljs-string">&quot;submit&quot;</span> value=<span class="hljs-string">&quot;send&quot;</span> /&gt;<br>    &lt;/form&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><h2 id="å¼€æºä»£ç "><a href="#å¼€æºä»£ç " class="headerlink" title="å¼€æºä»£ç "></a>å¼€æºä»£ç </h2><p><strong>è§‰å¾—ä¸é”™ï¼Œç»™ä¸ª star å‘—</strong></p><script src='http://git.oschina.net/lxl520/ImageOCR/widget_preview'></script><h2 id="æ„Ÿè°¢"><a href="#æ„Ÿè°¢" class="headerlink" title="æ„Ÿè°¢"></a>æ„Ÿè°¢</h2><p><a href="http://drops.wooyun.org/tips/141">å¸¸è§éªŒè¯ç çš„å¼±ç‚¹ä¸éªŒè¯ç è¯†åˆ«</a></p><h2 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h2><p>ç›®å‰çš„è¯†åˆ«æ•ˆç‡å¯ä»¥è¾¾åˆ° 50%ä»¥ä¸Šï¼ŒåŸºæœ¬å¯ä»¥æŠ•å…¥æ­£å¸¸ä½¿ç”¨ï¼Œä½†æ˜¯è¿˜æœ‰å¾ˆå¤§çš„è¿›æ­¥ç©ºé—´ï¼Œæ­£åœ¨åšä¸‹ä¸€æ­¥çš„ä¼˜åŒ–ï¼Œé’ˆå¯¹è¯†åˆ«ç»“æœå¯¹ç‰¹å¾åº“è¿›è¡Œè‡ªåŠ¨ä¼˜åŒ–ï¼Œè‡ªåŠ¨å»é™¤ä½¿ç”¨ç‡è¾ƒä½çš„ç‰¹å¾å€¼ï¼Œè‡ªåŠ¨ä¿å­˜ï¼Œè¯†åˆ«æˆåŠŸçš„ç‰¹å¾å€¼ç­‰ç­‰</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>php</tag>
      
      <tag>å›¾ç‰‡</tag>
      
      <tag>éªŒè¯ç è¯†åˆ«</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>phpåˆ©ç”¨curlä¿å­˜å›¾ç‰‡</title>
    <link href="/post/58471.html"/>
    <url>/post/58471.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>åšéªŒè¯ç è¯†åˆ«çš„æ—¶å€™éœ€è¦å…ˆæŠŠå›¾ç‰‡ä¿å­˜èµ·æ¥ï¼Œå†™äº†ä¸€ä¸ªä¿å­˜å›¾ç‰‡çš„å‡½æ•°</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* <span class="hljs-doctag">@author</span> mohuishou&lt;1<span class="hljs-doctag">@lailin</span>.xyz&gt;</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> string $url è·å–å›¾ç‰‡çš„ç½‘å€</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> string $fileName ä¿å­˜çš„åœ°å€ä»¥åŠæ–‡ä»¶å</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getImg</span>(<span class="hljs-params"><span class="hljs-variable">$url</span>, <span class="hljs-variable">$fileName</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$ch</span> = curl_init();<br>        <span class="hljs-variable">$fp</span> = fopen(<span class="hljs-variable">$fileName</span>, <span class="hljs-string">&#x27;w+&#x27;</span>);<br>        curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>);<br>        curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br>        curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="hljs-number">0</span>);<br>        curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_TIMEOUT, <span class="hljs-number">60</span>);<br>        curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_FILE,<span class="hljs-variable">$fp</span>);<br>        curl_exec(<span class="hljs-variable">$ch</span>);<br>        curl_close(<span class="hljs-variable">$ch</span>);<br>        fclose(<span class="hljs-variable">$fp</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><blockquote><p>ä½¿ç”¨çš„æ—¶å€™å‘ç°ï¼Œéœ€è¦ä¿å­˜éªŒè¯ç çš„ cookiesï¼Œç•™ä½œéªŒè¯ï¼Œå¿…è¦çš„æ—¶å€™è¿˜éœ€è¦åŠ ä¸Š header</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* <span class="hljs-doctag">@author</span> mohuishou&lt;1<span class="hljs-doctag">@lailin</span>.xyz&gt;</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> string $url</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> string $fileName</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCode</span>(<span class="hljs-params"><span class="hljs-variable">$url</span> = <span class="hljs-string">&#x27;http://www.169ol.com/Mall/Code/getCode&#x27;</span>, <span class="hljs-variable">$fileName</span> = <span class="hljs-string">&#x27;./img/code.png&#x27;</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br><br>        <span class="hljs-keyword">$this</span>-&gt;_code_cookie = dirname(<span class="hljs-keyword">__FILE__</span>).<span class="hljs-string">&quot;/pic.cookie&quot;</span>;<br>        <span class="hljs-variable">$ch</span> = curl_init();<br>        <span class="hljs-variable">$fp</span> = fopen(<span class="hljs-variable">$fileName</span>, <span class="hljs-string">&#x27;w+&#x27;</span>);<br>        curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>);<br>        curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br>        curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="hljs-number">0</span>);<br>        curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_TIMEOUT, <span class="hljs-number">60</span>);<br>        curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_FILE,<span class="hljs-variable">$fp</span>);<br>        curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_COOKIEJAR, <span class="hljs-keyword">$this</span>-&gt;_code_cookie);<br><br>        curl_exec(<span class="hljs-variable">$ch</span>);<br>        curl_close(<span class="hljs-variable">$ch</span>);<br>        fclose(<span class="hljs-variable">$fp</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>php</tag>
      
      <tag>å›¾ç‰‡</tag>
      
      <tag>curl</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>phpè¯†åˆ«éªŒè¯ç ï¼ˆä¸€ï¼‰</title>
    <link href="/post/47583.html"/>
    <url>/post/47583.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>æƒ³åšä¸€ä¸ªé’ˆå¯¹è”é€šä¼˜é€‰åœ¨æ²ƒè‡ªåŠ¨ç­¾åˆ°çš„å°ç¨‹åºï¼Œä½†æ˜¯ç™»é™†éœ€è¦éªŒè¯ç ï¼Œæ‰¾äº†ä¸€ä¸‹ç°æœ‰çš„ä¸€äº›åšå®¢æˆ–è€…æ˜¯å¼€æºçš„éªŒè¯ç è¯†åˆ«çš„ä»£ç ï¼Œæ²¡æœ‰ä¸€ä¸ªæ¯”è¾ƒæ»¡æ„çš„ï¼Œsoï¼Œè‡ªå·±å†™äº†ä¸€ä¸ªã€‚</p></blockquote><h2 id="éœ€è¦è¯†åˆ«çš„éªŒè¯ç "><a href="#éœ€è¦è¯†åˆ«çš„éªŒè¯ç " class="headerlink" title="éœ€è¦è¯†åˆ«çš„éªŒè¯ç "></a>éœ€è¦è¯†åˆ«çš„éªŒè¯ç </h2><blockquote><p>ç¬¬ä¸€ç§ï¼š</p></blockquote><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2190097228.png" alt="code.png"></p><blockquote><p>ç¬¬äºŒç§</p></blockquote><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/1819792828.gif" alt="1211862590-56a5bd94d822e.gif"></p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>åƒä¸Šå›¾çš„éªŒè¯ç ä¸€èˆ¬æ¥è¯´çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦è¯†åˆ«çš„æ˜¯ 4 ä¸ªæ•°å­—ï¼Œä½†æ˜¯éªŒè¯ç ä¸ºäº†é˜²æ­¢è‡ªåŠ¨è¯†åˆ«ç¨‹åºæ·»åŠ äº†è®¸å¤šçš„å¹²æ‰°é¡¹ï¼Œä¾‹å¦‚<code>èƒŒæ™¯è‰²</code>ã€<code>é›ªèŠ±</code>ã€<code>å¹²æ‰°çº¿</code>ç­‰ç­‰</p><h2 id="å»é™¤èƒŒæ™¯"><a href="#å»é™¤èƒŒæ™¯" class="headerlink" title="å»é™¤èƒŒæ™¯"></a>å»é™¤èƒŒæ™¯</h2><p>æˆ‘ä»¬é€šè¿‡åˆ†æè¯¥éªŒè¯ç å›¾ç‰‡å¯ä»¥çŸ¥é“ï¼Œæ•°å­—çš„ rgb å€¼ä¸€èˆ¬å¤„åœ¨ 180~190 ä»¥ä¸‹ï¼Œè€ŒèƒŒæ™¯è‰²å’Œé›ªèŠ±çš„ rgb å€¼ä¸€èˆ¬å¤„åœ¨ 200 ä»¥ä¸Šï¼Œsoï¼Œæˆ‘ä»¬åªè¦åœ¨å¤„ç†å›¾ç‰‡çš„æ—¶å€™åªå– 190 ä»¥ä¸‹çš„ rgb å€¼ä¿å­˜å°± ok äº†ï¼Œè¿™æ ·å°±å¯ä»¥å»é™¤æ‰ç»å¤§éƒ¨åˆ†çš„å¹²æ‰°é¡¹</p><h2 id="äºŒå€¼åŒ–"><a href="#äºŒå€¼åŒ–" class="headerlink" title="äºŒå€¼åŒ–"></a>äºŒå€¼åŒ–</h2><p>æŠŠå¹²æ‰°ä¿¡æ¯å»é™¤ä¹‹åï¼Œåªç•™ä¸‹äºŒè¿›åˆ¶ï¼ˆä¹Ÿå°±æ˜¯ 0 å’Œ 1 è¡¨ç¤ºï¼‰çš„ç‚¹é˜µ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * äºŒå€¼åŒ–ï¼Œæ’é™¤èƒŒæ™¯è‰²ï¼Œé›ªèŠ±ç­‰å¹²æ‰°é¡¹</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> mohuishou&lt;1<span class="hljs-doctag">@lailin</span>.xyz&gt;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">imageHash</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-keyword">$this</span>-&gt;_image_h; <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$j</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$j</span> &lt; <span class="hljs-keyword">$this</span>-&gt;_image_w; <span class="hljs-variable">$j</span>++) &#123;<br>            <span class="hljs-variable">$rgb</span> = imagecolorat(<span class="hljs-keyword">$this</span>-&gt;_in_img,<span class="hljs-variable">$j</span>,<span class="hljs-variable">$i</span>);<br>            <span class="hljs-variable">$rgb_array</span> = imagecolorsforindex(<span class="hljs-keyword">$this</span>-&gt;_in_img, <span class="hljs-variable">$rgb</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$rgb_array</span>[<span class="hljs-string">&#x27;red&#x27;</span>]&lt;<span class="hljs-number">190</span>&amp;&amp;<span class="hljs-variable">$rgb_array</span>[<span class="hljs-string">&#x27;green&#x27;</span>]&lt;<span class="hljs-number">190</span>&amp;&amp;<span class="hljs-variable">$rgb_array</span>[<span class="hljs-string">&#x27;blue&#x27;</span>]&lt;<span class="hljs-number">190</span>)&#123;<br><br>                <span class="hljs-variable">$data</span>[<span class="hljs-variable">$i</span>][<span class="hljs-variable">$j</span>]=<span class="hljs-number">1</span>;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br><br>                <span class="hljs-variable">$data</span>[<span class="hljs-variable">$i</span>][<span class="hljs-variable">$j</span>]=<span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>ç‚¹é˜µåŒ–ä¹‹åçš„æˆªå›¾</p></blockquote><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2878339217.png" alt="QQæˆªå›¾20160503213904.png"></p><h2 id="å»å™ªç‚¹"><a href="#å»å™ªç‚¹" class="headerlink" title="å»å™ªç‚¹"></a>å»å™ªç‚¹</h2><p>å›¾åƒäºŒå€¼åŒ–ä¹‹åå¯èƒ½è¿˜å­˜åœ¨å¾ˆå¤šå™ªç‚¹ï¼Œå™ªç‚¹çš„ç‰¹ç‚¹ä¸€èˆ¬æ˜¯å­¤ç«‹æ— æ´çš„ï¼Œè¿™æ—¶å€™æˆ‘ä»¬åªéœ€è¦åˆ¤æ–­ä»¥è¿™ä¸ª 1 ç‚¹ä¸ºä¸­å¿ƒçš„ç‚¹ï¼Œå‘¨å›´çš„ 1 ç‚¹ä¸ªæ•°å°äºä¸€ä¸ªé˜ˆå€¼ï¼ˆæˆ‘æŠŠå®ƒè®¾ä¸º 3ï¼‰ï¼Œå°±ç¡®è®¤å®ƒä¸ºå™ªç‚¹å¹¶å°†ä¹‹å»é™¤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å»é™¤å™ªç‚¹</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> mohuishou&lt;1<span class="hljs-doctag">@lailin</span>.xyz&gt;</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> $hash_data</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> mixed</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">removeHotSpots</span>(<span class="hljs-params"><span class="hljs-variable">$hash_data</span></span>)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-keyword">$this</span>-&gt;_image_h; <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$j</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$j</span> &lt; <span class="hljs-keyword">$this</span>-&gt;_image_w; <span class="hljs-variable">$j</span>++) &#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$hash_data</span>[<span class="hljs-variable">$i</span>][<span class="hljs-variable">$j</span>])&#123;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;isHotSpots(<span class="hljs-variable">$i</span>,<span class="hljs-variable">$j</span>,<span class="hljs-variable">$hash_data</span>)) <span class="hljs-variable">$hash_data</span>[<span class="hljs-variable">$i</span>][<span class="hljs-variable">$j</span>]=<span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$hash_data</span>;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * åˆ¤æ–­æ˜¯å¦æ˜¯å™ªç‚¹</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> mohuishou&lt;1<span class="hljs-doctag">@lailin</span>.xyz&gt;</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> $i</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> $j</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> $hash_data</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> bool ture:æ˜¯å™ªç‚¹,false:ä¸æ˜¯</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isHotSpots</span>(<span class="hljs-params"><span class="hljs-variable">$i</span>,<span class="hljs-variable">$j</span>,<span class="hljs-variable">$hash_data</span></span>)</span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$i</span> == <span class="hljs-number">0</span> || <span class="hljs-variable">$j</span> == <span class="hljs-number">0</span> || <span class="hljs-variable">$i</span> == (<span class="hljs-keyword">$this</span>-&gt;_image_h - <span class="hljs-number">1</span>) || <span class="hljs-variable">$j</span> == (<span class="hljs-keyword">$this</span>-&gt;_image_w - <span class="hljs-number">1</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><br><br>    <span class="hljs-comment">//å¾…æ£€æŸ¥ç‚¹ä¸ºä¸­å¿ƒçš„ä¹ä¸ªç‚¹</span><br>    <span class="hljs-variable">$points</span>[<span class="hljs-number">0</span>]=<span class="hljs-variable">$hash_data</span>[<span class="hljs-variable">$i</span><span class="hljs-number">-1</span>][<span class="hljs-variable">$j</span><span class="hljs-number">-1</span>];<br>    <span class="hljs-variable">$points</span>[<span class="hljs-number">1</span>]=<span class="hljs-variable">$hash_data</span>[<span class="hljs-variable">$i</span><span class="hljs-number">-1</span>][<span class="hljs-variable">$j</span>];<br>    <span class="hljs-variable">$points</span>[<span class="hljs-number">2</span>]=<span class="hljs-variable">$hash_data</span>[<span class="hljs-variable">$i</span><span class="hljs-number">-1</span>][<span class="hljs-variable">$j</span>+<span class="hljs-number">1</span>];<br>    <span class="hljs-variable">$points</span>[<span class="hljs-number">3</span>]=<span class="hljs-variable">$hash_data</span>[<span class="hljs-variable">$i</span>][<span class="hljs-variable">$j</span><span class="hljs-number">-1</span>];<br>    <span class="hljs-variable">$points</span>[<span class="hljs-number">4</span>]=<span class="hljs-variable">$hash_data</span>[<span class="hljs-variable">$i</span>][<span class="hljs-variable">$j</span>];<span class="hljs-comment">//å¾…æ£€æŸ¥ç‚¹</span><br>    <span class="hljs-variable">$points</span>[<span class="hljs-number">5</span>]=<span class="hljs-variable">$hash_data</span>[<span class="hljs-variable">$i</span>][<span class="hljs-variable">$j</span>+<span class="hljs-number">1</span>];<br>    <span class="hljs-variable">$points</span>[<span class="hljs-number">6</span>]=<span class="hljs-variable">$hash_data</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>][<span class="hljs-variable">$j</span><span class="hljs-number">-1</span>];<br>    <span class="hljs-variable">$points</span>[<span class="hljs-number">7</span>]=<span class="hljs-variable">$hash_data</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>][<span class="hljs-variable">$j</span>];<br>    <span class="hljs-variable">$points</span>[<span class="hljs-number">8</span>]=<span class="hljs-variable">$hash_data</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>][<span class="hljs-variable">$j</span>+<span class="hljs-number">1</span>];<br><br>    <span class="hljs-variable">$count</span>=<span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$points</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$v</span>)&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$v</span>)&#123;<br>            <span class="hljs-variable">$count</span>++;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$count</span>&lt;<span class="hljs-number">4</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><blockquote><p>å»é™¤å™ªç‚¹ä¹‹å</p></blockquote><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/1678387744.png" alt="QQæˆªå›¾20160503214315.png"></p><h2 id="å»é™¤å¹²æ‰°çº¿"><a href="#å»é™¤å¹²æ‰°çº¿" class="headerlink" title="å»é™¤å¹²æ‰°çº¿"></a>å»é™¤å¹²æ‰°çº¿</h2><p>é€šè¿‡å»é™¤å™ªç‚¹ä¹‹åçš„å›¾åƒï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå¤§éƒ¨åˆ†çš„å¹²æ‰°çº¿ï¼Œå…¶å®å·²ç»è¢«å»é™¤æ‰äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†ï¼Œå»é™¤å™ªç‚¹çš„æ–¹æ³•å½“åšä¸€ä¸ªæ»¤é•œï¼Œå¤šè¿‡æ»¤å‡ æ¬¡ï¼Œå¹²æ‰°çº¿åŸºæœ¬ä¸Šå¯ä»¥å»é™¤å®Œæ¯•ï¼ˆè¿™é‡Œæµ‹è¯•å»é™¤ä¸‰æ¬¡çš„æ•ˆæœæ˜¯æœ€å¥½çš„ï¼‰</p><h2 id="åˆ†å‰²éªŒè¯ç "><a href="#åˆ†å‰²éªŒè¯ç " class="headerlink" title="åˆ†å‰²éªŒè¯ç "></a>åˆ†å‰²éªŒè¯ç </h2><p>è¿™ä¸ªéªŒè¯ç çš„æ¯ä¸ªæ•°å­—å…¶å®éƒ½æ˜¯ç­‰åˆ†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ç­‰åˆ†çš„æ–¹æ³•å»åˆ†å‰²å®ƒ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> mohuishou&lt;1<span class="hljs-doctag">@lailin</span>.xyz&gt;</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> $n</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> array</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">splitImage</span>(<span class="hljs-params"><span class="hljs-variable">$n</span></span>)</span>&#123;<br>    <span class="hljs-variable">$data</span>=[];<br>    <span class="hljs-variable">$a</span>=<span class="hljs-keyword">$this</span>-&gt;_image_w/<span class="hljs-built_in">self</span>::CHAR_NUM;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-variable">$n</span>*<span class="hljs-variable">$a</span>;<span class="hljs-variable">$i</span>&lt;(<span class="hljs-variable">$n</span>+<span class="hljs-number">1</span>)*<span class="hljs-variable">$a</span>;<span class="hljs-variable">$i</span>++)&#123;<br>        <span class="hljs-variable">$column</span>=array_column(<span class="hljs-keyword">$this</span>-&gt;_hash_data,<span class="hljs-variable">$i</span>);<br>        <span class="hljs-keyword">if</span>(implode(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$column</span>)!=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-variable">$data</span>[]=<span class="hljs-variable">$column</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-variable">$out_img_w</span>=count(<span class="hljs-variable">$data</span>)+<span class="hljs-number">4</span>;<br>    <span class="hljs-variable">$out_img_h</span>=count(<span class="hljs-variable">$data</span>[<span class="hljs-number">0</span>])+<span class="hljs-number">4</span>;<br><br>    <span class="hljs-variable">$out_img</span> = imagecreatetruecolor(<span class="hljs-variable">$out_img_w</span>,<span class="hljs-variable">$out_img_h</span>);<span class="hljs-comment">//åˆ›å»ºä¸€å¹…çœŸå½©è‰²å›¾åƒ</span><br>    <span class="hljs-variable">$bg</span>=imagecolorallocate(<span class="hljs-variable">$out_img</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);<span class="hljs-comment">//èƒŒæ™¯è‰²ç”»ä¸ºç™½è‰²</span><br>    imagefill(<span class="hljs-variable">$out_img</span>, <span class="hljs-number">0</span>,<span class="hljs-number">0</span>, <span class="hljs-variable">$bg</span>);<br><br>    <span class="hljs-comment">//ä¸€åˆ—ä¸€åˆ—çš„è¿›è¡Œç”»å›¾</span><br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$data</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$k</span>=&gt;<span class="hljs-variable">$v</span>)&#123;<br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$v</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span>=&gt; <span class="hljs-variable">$val</span>)&#123;<br>            <span class="hljs-variable">$color</span>=<span class="hljs-number">255</span>;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$val</span>) <span class="hljs-variable">$color</span>=<span class="hljs-number">0</span>;<br>            <span class="hljs-variable">$c</span> = imagecolorallocate(<span class="hljs-variable">$out_img</span>, <span class="hljs-variable">$color</span>, <span class="hljs-variable">$color</span>, <span class="hljs-variable">$color</span>);<br>            imagesetpixel(<span class="hljs-variable">$out_img</span>, <span class="hljs-variable">$k</span>+<span class="hljs-number">2</span>,<span class="hljs-variable">$key</span>+<span class="hljs-number">2</span>, <span class="hljs-variable">$c</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$out_img</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä¿å­˜-amp-å¯¹æ¯”è¯†åˆ«"><a href="#ä¿å­˜-amp-å¯¹æ¯”è¯†åˆ«" class="headerlink" title="ä¿å­˜&amp;å¯¹æ¯”è¯†åˆ«"></a>ä¿å­˜&amp;å¯¹æ¯”è¯†åˆ«</h2><blockquote><p>æœ€åå°†åˆ†å‰²å¥½çš„å›¾ç‰‡äºŒå€¼åŒ–ï¼Œé€šè¿‡ä¸€ä¸ªæ•°ç»„ä¿å­˜ä¸‹æ¥ï¼Œä½œä¸ºä¸€ä¸ªæ ‡å‡†ï¼Œç„¶ååä¹‹åéœ€è¦éªŒè¯çš„éªŒè¯ç ï¼Œé€šè¿‡å’Œä¹‹å‰çš„æ•°ç»„æ±‚äº¤é›†ï¼Œæ¯”è¾ƒæœ€ç›¸è¿‘çš„æ•°å­—å¾—å‡ºç»“æœå³å¯</p></blockquote><h2 id="æ›´å¤š"><a href="#æ›´å¤š" class="headerlink" title="æ›´å¤š"></a>æ›´å¤š</h2><p><strong>å…¶å®åˆ°è¿™ä¸€æ­¥ä¹‹åå·²ç»èƒ½å¤Ÿè¯†åˆ«ä¸€äº›éªŒè¯ç äº†ï¼Œå¯¹äºç¬¬äºŒç§éªŒè¯ç å·²ç»å¯ä»¥è¾¾åˆ°å¾ˆå¥½çš„è¯†åˆ«æ•ˆæœï¼Œä½†æ˜¯å¯¹äºç¬¬ä¸€ç§éªŒè¯ç çš„è¯†åˆ«ç‡å¾ˆä½å¾ˆä½ï¼Œå¤§æ¦‚åªæœ‰<code>5%-15%</code>ï¼ŒåŸºæœ¬ä¸èƒ½æŠ•å…¥ä½¿ç”¨ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« é’ˆå¯¹è¿™ç§éªŒè¯ç ï¼Œæ€ä¹ˆæ›´å¥½çš„è¯†åˆ«ï¼Œä¸»è¦æ˜¯<code>æ ‡å‡†åŒ–</code>å’Œ<code>ç‰¹å¾åº“çš„å»ºç«‹</code></strong></p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>php</tag>
      
      <tag>å›¾ç‰‡</tag>
      
      <tag>è¯†åˆ«</tag>
      
      <tag>éªŒè¯ç è¯†åˆ«</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>php-webhookåˆ©ç”¨phpè„šæœ¬è‡ªåŠ¨åŒ–éƒ¨ç½²gité¡¹ç›®</title>
    <link href="/post/61468.html"/>
    <url>/post/61468.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>é‡åˆ°æƒé™çš„é—®é¢˜å¼„äº†å¥½ä¹…ï¼Œæ•´ç†ä¸€ä¸‹æ­¥éª¤ç®€å•çš„å†™ä¸€ä¸‹<br>åœ¨é˜…è¯»è¿™ç¯‡æ–‡ç« çš„æ—¶å€™é»˜è®¤ä½ çš„æœåŠ¡å™¨ä¸Šå®‰è£…äº† web æœåŠ¡å™¨å’Œ git</p></blockquote><h2 id="step1"><a href="#step1" class="headerlink" title="step1"></a>step1</h2><blockquote><p>å†™ä¸€ä¸ªç®€å•çš„è„šæœ¬æŸ¥çœ‹ä½ çš„æœåŠ¡å™¨è¿è¡Œçš„è´¦æˆ·ï¼Œå’Œæ˜¯å¦èƒ½å¤Ÿè¿è¡Œç›¸å…³å‡½æ•°</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$test</span>=shell_exec(<span class="hljs-string">&quot;whoami&quot;</span>);<br>var_dump(<span class="hljs-variable">$test</span>);<span class="hljs-comment">//æˆ‘çš„è¿”å›çš„æ˜¯ www-data</span><br></code></pre></td></tr></table></figure><p><strong>å¦‚æœè¿™é‡Œè¿”å› null çš„è¯ï¼Œä¸å¦¨æ£€æŸ¥ä¸€ä¸‹ shell_exec å‡½æ•°æ˜¯å¦è¢«ç¦ç”¨äº†</strong></p><h2 id="step2"><a href="#step2" class="headerlink" title="step2"></a>step2</h2><blockquote><p>å»ºç«‹ ssh å…¬é’¥ï¼Œä»¥æˆ‘çš„ www-data è´¦æˆ·ä¸ºä¾‹å­</p></blockquote><p>1.å…ˆå»ºç«‹ä¸€ä¸ª.ssh ç›®å½•å¹¶ç»™äºˆ www-data ç”¨æˆ·æƒé™</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">sudo mkdir <span class="hljs-regexp">/var/</span>www/.ssh<br>sudo chown -R www-data:www-data <span class="hljs-regexp">/var/</span>www<span class="hljs-regexp">/.ssh/</span><br></code></pre></td></tr></table></figure><p>2.ç”Ÿæˆ webhook éƒ¨ç½²å…¬é’¥</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">sudo</span> -Hu www-<span class="hljs-meta">data</span> ssh-keygen -t rsa <span class="hljs-comment">//ä¸€ç›´å›è½¦å³å¯</span><br></code></pre></td></tr></table></figure><p><em>å¦‚æœä½ å’Œæˆ‘ä¸€æ ·ï¼Œé‡åˆ°äº†<code>-su: sudo: command not found</code>ï¼Œå¯ä»¥å…ˆå®‰è£…<code>sudo</code>å‘½ä»¤,<code>apt-get install sudo</code>ï¼Œå¦‚æœä½ å’Œæˆ‘è¿˜ä¸€æ ·é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œä¸å¦¨å…ˆè¯•è¯•<code>apt-get update</code></em></p><p>3.å°† webhook éƒ¨ç½²å…¬é’¥ä¸Šä¼ åˆ°æ‰˜ç®¡ç½‘ç«™</p><blockquote><p>æµ‹è¯•ç”¨çš„ Codingï¼Œå…¶ä»–è¿˜åœ¨æµ‹è¯•å½“ä¸­</p></blockquote><p>å…ˆæŸ¥çœ‹å…¬é’¥</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">sudo cat <span class="hljs-regexp">/var/</span>www<span class="hljs-regexp">/.ssh/i</span>d_rsa.pub<br></code></pre></td></tr></table></figure><p>ç„¶åå¤åˆ¶ä¸Šé¢çš„å†…å®¹åˆ°æ‰˜ç®¡ç½‘ç«™ï¼Œé¡¹ç›®çš„ webhook ä¸Šé¢</p><h2 id="step3"><a href="#step3" class="headerlink" title="step3"></a>step3</h2><blockquote><p>webhook æ–‡ä»¶</p></blockquote><script src='http://git.oschina.net/lxl520/php-webhook/widget_preview'></script><h2 id="step4"><a href="#step4" class="headerlink" title="step4"></a>step4</h2><blockquote><p>å…ˆåœ¨æœåŠ¡å™¨ä¸Š<code>git clone</code></p></blockquote><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">sudo</span> chown -<span class="hljs-type">R</span> www-<span class="hljs-class"><span class="hljs-keyword">data</span>:www-<span class="hljs-keyword">data</span> &#123;ä»£ç åœ°å€&#125;</span><br><span class="hljs-title">sudo</span> -<span class="hljs-type">Hu</span> www-<span class="hljs-class"><span class="hljs-keyword">data</span> git clone &#123;ä½ çš„é¡¹ç›®<span class="hljs-title">ssh</span>åœ°å€&#125; &#123;ä»£ç åœ°å€&#125;  <span class="hljs-comment">--depth=1</span></span><br></code></pre></td></tr></table></figure><p><strong>æ³¨æ„ï¼Œè¿™é‡Œåˆå§‹åŒ– clone å¿…é¡»è¦ç”¨ www-data ç”¨æˆ·</strong></p><h2 id="step5"><a href="#step5" class="headerlink" title="step5"></a>step5</h2><blockquote><p>åœ¨æ‰˜ç®¡ç½‘ç«™ä¸Šæ·»åŠ  webhook åœ°å€ï¼Œç„¶åæäº¤ä¸€æ¬¡æµ‹è¯•</p></blockquote><h2 id="æ„Ÿè°¢"><a href="#æ„Ÿè°¢" class="headerlink" title="æ„Ÿè°¢"></a>æ„Ÿè°¢</h2><blockquote><p>å‚è€ƒäº†ä»¥ä¸‹ä»£ç <br><a href="https://gist.github.com/overtrue/0bf1cd704bf804de2e2c">https://gist.github.com/overtrue/0bf1cd704bf804de2e2c</a></p></blockquote><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>webhook</tag>
      
      <tag>php</tag>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nginxæ— æ³•å¯åŠ¨</title>
    <link href="/post/33991.html"/>
    <url>/post/33991.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>ä»Šå¤©è£…äº†ä¸€ä¸ªæœåŠ¡å™¨ä½†æ˜¯ nginx ä¸€ç›´æ— æ³•å¯åŠ¨ï¼Œgoogle äº†å„ç§ç­”æ¡ˆï¼Œè¿˜æ˜¯æ²¡æœ‰æ•ˆæœ</p></blockquote><h3 id="ä¾‹å¦‚ï¼š"><a href="#ä¾‹å¦‚ï¼š" class="headerlink" title="ä¾‹å¦‚ï¼š"></a>ä¾‹å¦‚ï¼š</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs gradle">nginxå¯åŠ¨ï¼Œé‡å¯ï¼Œå…³é—­å‘½ä»¤<br>åœæ­¢æ“ä½œ<br>åœæ­¢æ“ä½œæ˜¯é€šè¿‡å‘nginxè¿›ç¨‹å‘é€ä¿¡å·ï¼ˆä»€ä¹ˆæ˜¯ä¿¡å·è¯·å‚é˜…linuxæ–‡ ç« ï¼‰æ¥è¿›è¡Œçš„<br>æ­¥éª¤<span class="hljs-number">1</span>ï¼šæŸ¥è¯¢nginxä¸»è¿›ç¨‹å·<br>ps -ef | <span class="hljs-keyword">grep</span> nginx<br>åœ¨è¿›ç¨‹åˆ—è¡¨é‡Œ é¢æ‰¾masterè¿›ç¨‹ï¼Œå®ƒçš„ç¼–å·å°±æ˜¯ä¸»è¿›ç¨‹å·äº†ã€‚<br>æ­¥éª¤<span class="hljs-number">2</span>ï¼šå‘é€ä¿¡å·<br>ä»å®¹åœæ­¢Nginxï¼š<br>kill -QUIT ä¸»è¿›ç¨‹å·<br>å¿«é€Ÿåœæ­¢Nginxï¼š<br>kill -TERM ä¸»è¿›ç¨‹å·<br>å¼ºåˆ¶åœæ­¢Nginxï¼š<br>pkill -<span class="hljs-number">9</span> nginx<br><br>å¦å¤–ï¼Œ è‹¥åœ¨nginx.confé…ç½®äº†pidæ–‡ä»¶å­˜æ”¾è·¯å¾„åˆ™è¯¥æ–‡ä»¶å­˜æ”¾çš„å°±æ˜¯Nginxä¸»è¿›ç¨‹å·ï¼Œå¦‚æœæ²¡æŒ‡å®šåˆ™æ”¾åœ¨nginxçš„logsç›®å½•ä¸‹ã€‚æœ‰äº†pidæ–‡ ä»¶ï¼Œæˆ‘ä»¬å°±ä¸ç”¨å…ˆæŸ¥è¯¢Nginxçš„ä¸»è¿›ç¨‹å·ï¼Œè€Œç›´æ¥å‘Nginxå‘é€ä¿¡å·äº†ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š<br>kill -ä¿¡å·ç±»å‹ <span class="hljs-string">&#x27;/usr/nginx/logs/nginx.pid&#x27;</span><br><br>å¹³æ»‘é‡å¯<br>å¦‚æœæ›´æ”¹äº†é…ç½®å°±è¦é‡å¯Nginxï¼Œè¦å…ˆå…³é—­Nginxå†æ‰“å¼€ï¼Ÿä¸æ˜¯çš„ï¼Œå¯ä»¥å‘Nginx å‘é€ä¿¡å·ï¼Œå¹³æ»‘é‡å¯ã€‚<br>å¹³æ»‘é‡å¯å‘½ä»¤ï¼š<br>kill -HUP ä½è¿›ç§°å·æˆ–è¿›ç¨‹å·æ–‡ä»¶è·¯å¾„<br>æˆ–è€…ä½¿ç”¨<br><br><span class="hljs-regexp">/usr/</span>nginx<span class="hljs-regexp">/sbin/</span>nginx -s reload<br><br>æ³¨æ„ï¼Œä¿®æ”¹äº†é…ç½®æ–‡ä»¶åæœ€å¥½å…ˆæ£€æŸ¥ä¸€ä¸‹ä¿®æ”¹è¿‡çš„é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ ç¡®ï¼Œä»¥å…é‡å¯åNginxå‡ºç°é”™è¯¯å½±å“æœåŠ¡å™¨ç¨³å®šè¿è¡Œã€‚åˆ¤æ–­Nginxé…ç½®æ˜¯å¦æ­£ç¡®å‘½ä»¤å¦‚ä¸‹ï¼š<br>nginx -t -c <span class="hljs-regexp">/usr/</span>nginx<span class="hljs-regexp">/conf/</span>nginx.conf<br>æˆ–è€…<br><br><span class="hljs-regexp">/usr/</span>nginx<span class="hljs-regexp">/sbin/</span>nginx -t<br><br>å¹³æ»‘å‡çº§<br>å¦‚æœæœåŠ¡å™¨æ­£åœ¨è¿è¡Œçš„Nginxè¦è¿›è¡Œå‡çº§ã€æ·»åŠ æˆ–åˆ é™¤æ¨¡å—æ—¶ï¼Œæˆ‘ä»¬éœ€ è¦åœæ‰æœåŠ¡å™¨å¹¶åšç›¸åº”ä¿®æ”¹ï¼Œè¿™æ ·æœåŠ¡å™¨å°±è¦åœ¨ä¸€æ®µæ—¶é—´å†…åœæ­¢æœåŠ¡ï¼ŒNginxå¯ä»¥åœ¨ä¸åœæœºçš„æƒ…å†µä¸‹è¿›è¡Œå„ç§å‡çº§åŠ¨ä½œè€Œä¸å½±å“æœåŠ¡å™¨è¿è¡Œã€‚<br>æ­¥éª¤<span class="hljs-number">1</span>ï¼š<br>å¦‚ æœå‡çº§Nginxç¨‹åºï¼Œå…ˆç”¨æ–°ç¨‹åºæ›¿æ¢æ—§ç¨‹åºæ–‡ä»¶ï¼Œç¼–è¯‘å®‰è£…çš„è¯æ–°ç¨‹åºç›´æ¥ç¼–è¯‘åˆ°Nginxå®‰è£…ç›®å½•ä¸­ã€‚<br>æ­¥ éª¤<span class="hljs-number">2</span>ï¼šæ‰§è¡Œå‘½ä»¤<br>kill -USR2 æ—§ç‰ˆç¨‹åºçš„ä¸»è¿›ç¨‹å·æˆ–è¿›ç¨‹æ–‡ä»¶å<br>æ­¤æ—¶æ—§çš„Nginxä¸»è¿›ç¨‹å°†ä¼šæŠŠè‡ªå·±çš„è¿›ç¨‹æ–‡ä»¶æ”¹åä¸º.oldbinï¼Œç„¶åæ‰§è¡Œæ–°ç‰ˆ Nginxã€‚æ–°æ—§Nginxä¼šåŒå¸‚è¿è¡Œï¼Œå…±åŒå¤„ç†è¯·æ±‚ã€‚<br>è¿™æ—¶è¦é€æ­¥åœæ­¢æ—§ç‰ˆ Nginxï¼Œè¾“å…¥å‘½ä»¤ï¼š<br>kill -WINCH æ—§ç‰ˆä¸»è¿›ç¨‹å·<br>æ…¢æ…¢æ—§çš„å·¥ä½œè¿›ç¨‹å°±éƒ½ä¼šéšç€ä»»åŠ¡æ‰§è¡Œå®Œæ¯•è€Œé€€å‡ºï¼Œæ–°ç‰ˆçš„Nginxçš„å·¥ä½œè¿›ç¨‹ä¼šé€æ¸å–ä»£æ—§ç‰ˆ å·¥ä½œè¿›ç¨‹ã€‚<br><br>æ­¤ æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å†³å®šä½¿ç”¨æ–°ç‰ˆè¿˜æ˜¯æ¢å¤åˆ°æ—§ç‰ˆã€‚<br>ä¸é‡è½½é…ç½®å¯åŠ¨æ–°/æ—§å·¥ä½œè¿›ç¨‹<br>kill -HUP æ—§/æ–°ç‰ˆä¸»è¿›ç¨‹å·<br>ä»å®¹å…³é—­æ—§/æ–°è¿›ç¨‹<br>kill -QUIT æ—§/æ–°ä¸»è¿›ç¨‹å·<br>å¦‚æœæ­¤æ—¶æŠ¥é”™ï¼Œæç¤ºè¿˜æœ‰è¿›ç¨‹æ²¡æœ‰ç»“æŸå°±ç”¨ä¸‹é¢å‘½ä»¤å…ˆå…³é—­æ—§/æ–°å·¥ä½œè¿›ç¨‹ï¼Œå†å…³é—­ä¸»è¿›ç¨‹å·ï¼š<br>kill -TERM æ—§/æ–°å·¥ä½œè¿›ç¨‹å·<br><br>è¿™æ ·ä¸‹æ¥ï¼Œå¦‚æœè¦æ¢å¤åˆ°æ—§ç‰ˆæœ¬ï¼Œåªéœ€è¦ä¸Šé¢çš„å‡ ä¸ªæ­¥ éª¤éƒ½æ˜¯æ“ä½œæ–°ç‰ˆä¸»è¿›ç¨‹å·ï¼Œå¦‚æœè¦ç”¨æ–°ç‰ˆæœ¬å°±ä¸Šé¢çš„å‡ ä¸ªæ­¥éª¤éƒ½æ“ä½œæ—§ç‰ˆä¸»è¿›ç¨‹å·å°±è¡Œäº†ã€‚<br><br>ä¸Šé¢å°±æ˜¯Nginxçš„ä¸€äº›åŸºæœ¬çš„æ“ä½œï¼Œå¸Œæœ›ä»¥åNginxèƒ½æœ‰æ›´å¥½çš„æ–¹æ³•æ¥å¤„ç†è¿™äº›æ“ä½œï¼Œ æœ€å¥½æ˜¯Nginxçš„å‘½ä»¤è€Œä¸æ˜¯å‘Nginxè¿›ç¨‹å‘é€ç³»ç»Ÿä¿¡å·ã€‚<br></code></pre></td></tr></table></figure><h3 id="åé¢å‘ç°"><a href="#åé¢å‘ç°" class="headerlink" title="åé¢å‘ç°"></a>åé¢å‘ç°</h3><p>çªç„¶æƒ³èµ·æ¥ä¼šä¸ä¼šæ˜¯é…ç½®æ–‡ä»¶æœ‰é”™è¯¯å¯¼è‡´çš„æ— æ³•å¯åŠ¨ï¼Œso</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">nginx -t -c <span class="hljs-regexp">/etc/</span>nginx/nginx.conf<br></code></pre></td></tr></table></figure><p><strong>ç»“æœå‘ç°</strong>æ˜¯é…ç½®é¡¹é‡Œé¢çš„æ—¥å¿—æ–‡ä»¶ç›®å½•ä¸å­˜åœ¨</p><h3 id="æ€»ç»“ä¸€ä¸‹"><a href="#æ€»ç»“ä¸€ä¸‹" class="headerlink" title="æ€»ç»“ä¸€ä¸‹"></a>æ€»ç»“ä¸€ä¸‹</h3><p>ä»¥åé‡åˆ°è¿™ç§é—®é¢˜ä¸€å®šè¦å…ˆçœ‹çœ‹æ—¥å¿—æˆ–è€…å…ˆæµ‹è¯•ä¸€ä¸‹è¯­å¥</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>nginx</tag>
      
      <tag>æœåŠ¡å™¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nginx-phpæŠ¥502é”™è¯¯</title>
    <link href="/post/59269.html"/>
    <url>/post/59269.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>æ­£æ˜¯æ‚²å‚¬çŠ¯äº†ä¸€ä¸ªè¶…ä½çº§çš„é”™è¯¯</p></blockquote><p>åœ¨è…¾è®¯äº‘æ–°ä¹°äº†ä¸€ä¸ªæœåŠ¡å™¨ï¼Œç›´æ¥ç”¨äº†ä»¥å‰ nginx çš„é…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯è£…ä¸Šä¹‹åå…ˆæ˜¯ 404 ç„¶å 502ï¼Œä¸€ç›´ä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">404</span>æ˜¯å› ä¸ºæœ¬æ¥è¦æŠ¥<span class="hljs-number">502</span>çš„é”™è¯¯ï¼Œä½†æ˜¯<span class="hljs-number">502</span>çš„é¡µé¢æ²¡æœ‰æ”¾è¿›å»....<br></code></pre></td></tr></table></figure><h4 id="502-çš„é”™è¯¯åœ¨ç½‘ä¸Šæœç´¢äº†å¾ˆå¤šç­”æ¡ˆéƒ½æ²¡æœ‰è§£å†³ï¼Œç„¶ååé¢å‘ç°æˆ‘è‡ªå·±ç«Ÿç„¶æ²¡æœ‰çœ‹é”™è¯¯æ—¥å¿—ï¼Œç¿»æ—¥å¿—çš„æ—¶å€™å‘ç°æ˜¯ï¼š"><a href="#502-çš„é”™è¯¯åœ¨ç½‘ä¸Šæœç´¢äº†å¾ˆå¤šç­”æ¡ˆéƒ½æ²¡æœ‰è§£å†³ï¼Œç„¶ååé¢å‘ç°æˆ‘è‡ªå·±ç«Ÿç„¶æ²¡æœ‰çœ‹é”™è¯¯æ—¥å¿—ï¼Œç¿»æ—¥å¿—çš„æ—¶å€™å‘ç°æ˜¯ï¼š" class="headerlink" title="502 çš„é”™è¯¯åœ¨ç½‘ä¸Šæœç´¢äº†å¾ˆå¤šç­”æ¡ˆéƒ½æ²¡æœ‰è§£å†³ï¼Œç„¶ååé¢å‘ç°æˆ‘è‡ªå·±ç«Ÿç„¶æ²¡æœ‰çœ‹é”™è¯¯æ—¥å¿—ï¼Œç¿»æ—¥å¿—çš„æ—¶å€™å‘ç°æ˜¯ï¼š"></a>502 çš„é”™è¯¯åœ¨ç½‘ä¸Šæœç´¢äº†å¾ˆå¤šç­”æ¡ˆéƒ½æ²¡æœ‰è§£å†³ï¼Œç„¶ååé¢å‘ç°æˆ‘è‡ªå·±ç«Ÿç„¶æ²¡æœ‰çœ‹é”™è¯¯æ—¥å¿—ï¼Œç¿»æ—¥å¿—çš„æ—¶å€™å‘ç°æ˜¯ï¼š</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-number">2016</span><span class="hljs-regexp">/04/</span><span class="hljs-number">25</span> <span class="hljs-number">04</span>:<span class="hljs-number">32</span>:<span class="hljs-number">42</span> [crit] <span class="hljs-number">251</span>#<span class="hljs-number">251</span>: *<span class="hljs-number">166</span> connect() to unix:<span class="hljs-regexp">/var/</span>run<span class="hljs-regexp">/php5-fpm.sock failed (2: No such file or directory) while connecting to upstream, client: 220.167.47.185, server: 127.0.0.1, request: &quot;GET /</span> HTTP<span class="hljs-regexp">/1.1&quot;, upstream: &quot;fastcgi:/</span><span class="hljs-regexp">/unix:/</span>var<span class="hljs-regexp">/run/</span>php5-fpm.sock:<span class="hljs-string">&quot;, host: &quot;</span><span class="hljs-number">115.159</span>.<span class="hljs-number">94.101</span><span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure><h4 id="çªç„¶é—´æç„¶å¤§æ‚Ÿï¼Œæˆ‘æ–°ä¹°çš„æœåŠ¡å™¨è£…çš„æ˜¯-php7ï¼Œä»¥å‰ç”¨çš„-php5ï¼Œsock-æ–‡ä»¶çš„åœ°å€ä¸ä¸€æ ·-æ”¹æˆä¸‹é¢è¿™ä¸ªé‡å¯ï¼Œå°±æ²¡æœ‰é—®é¢˜äº†"><a href="#çªç„¶é—´æç„¶å¤§æ‚Ÿï¼Œæˆ‘æ–°ä¹°çš„æœåŠ¡å™¨è£…çš„æ˜¯-php7ï¼Œä»¥å‰ç”¨çš„-php5ï¼Œsock-æ–‡ä»¶çš„åœ°å€ä¸ä¸€æ ·-æ”¹æˆä¸‹é¢è¿™ä¸ªé‡å¯ï¼Œå°±æ²¡æœ‰é—®é¢˜äº†" class="headerlink" title="çªç„¶é—´æç„¶å¤§æ‚Ÿï¼Œæˆ‘æ–°ä¹°çš„æœåŠ¡å™¨è£…çš„æ˜¯ php7ï¼Œä»¥å‰ç”¨çš„ php5ï¼Œsock æ–‡ä»¶çš„åœ°å€ä¸ä¸€æ ·,æ”¹æˆä¸‹é¢è¿™ä¸ªé‡å¯ï¼Œå°±æ²¡æœ‰é—®é¢˜äº†"></a>çªç„¶é—´æç„¶å¤§æ‚Ÿï¼Œæˆ‘æ–°ä¹°çš„æœåŠ¡å™¨è£…çš„æ˜¯ php7ï¼Œä»¥å‰ç”¨çš„ php5ï¼Œsock æ–‡ä»¶çš„åœ°å€ä¸ä¸€æ ·,æ”¹æˆä¸‹é¢è¿™ä¸ªé‡å¯ï¼Œå°±æ²¡æœ‰é—®é¢˜äº†</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">fastcgi_pass unix:<span class="hljs-regexp">/var/</span>run<span class="hljs-regexp">/php/</span>php7.<span class="hljs-number">0</span>-fpm.sock;<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>nginx</tag>
      
      <tag>æœåŠ¡å™¨</tag>
      
      <tag>php</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Cè¯­è¨€éªŒè¯æµ®ç‚¹æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤º</title>
    <link href="/post/48100.html"/>
    <url>/post/48100.html</url>
    
    <content type="html"><![CDATA[<h3 id="éªŒè¯æµ®ç‚¹æ•°"><a href="#éªŒè¯æµ®ç‚¹æ•°" class="headerlink" title="éªŒè¯æµ®ç‚¹æ•°"></a>éªŒè¯æµ®ç‚¹æ•°</h3><blockquote><p>è™½ç„¶ä»¥å‰ä¹Ÿå­¦è¿‡æµ®ç‚¹æ•°çš„è¡¨ç¤ºåŸç†ï¼Œå¤§è‡´çš„åŸç†è¿˜æ˜¯æ¸…æ¥šçš„ï¼Œä½†æ˜¯ä½¿ç”¨ C è¯­è¨€çš„æ¥è¿›æ€§éªŒè¯è¿˜æ²¡æœ‰å°è¯•è¿‡ï¼Œä¸‹é¢æ˜¯éªŒè¯çš„è¿‡ç¨‹</p></blockquote><h4 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h4><ol><li>çŸ¥é“æµ®ç‚¹æ•°ï¼Œæ˜¯æŒ‰ç…§ 32 ä½åœ¨å†…å­˜ä¸­ä¿å­˜ï¼Œå…¶ä¸­ç¬¬ä¸€ä½è¡¨ç¤ºç¬¦å·ï¼Œå 8 ä½è¡¨ç¤ºæŒ‡æ•°ï¼Œæœ€å 23 ä½è¡¨ç¤ºå°æ•°</li><li>C è¯­è¨€å½“ä¸­å­˜åœ¨æŒ‡é’ˆï¼Œå¯ä»¥ç›´æ¥é€šè¿‡æŒ‡é’ˆæ¥è·å–ï¼Œå˜é‡çš„åœ°å€ã€‚</li><li>æ‰€ä»¥å°±å…ˆå®šä¹‰ä¸€ä¸ªå˜é‡æ¥å‚¨å­˜æµ®ç‚¹æ•°ï¼Œåœ¨å®šä¹‰ä¸€ä¸ªæŒ‡é’ˆæ¥è·å–ï¼Œæµ®ç‚¹æ•°çš„å‚¨å­˜åœ°å€ï¼Œåœ¨æŠŠ 16 è¿›åˆ¶æˆ–è€… 10 è¿›åˆ¶çš„åœ°å€è½¬åŒ–ä¸º 2 è¿›åˆ¶å³å¯<a id="more"></a></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">float</span> a=<span class="hljs-number">209.125</span>;<br><span class="hljs-keyword">int</span> *p=(<span class="hljs-keyword">int</span> *)&amp;a;<br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;è¯·è¾“å…¥ä¸€ä¸²æ•°:&quot;</span>);<br><span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%f&quot;</span>,&amp;a);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, *p);<span class="hljs-comment">//è¾“å‡ºæ•°å€¼åœ¨å†…å­˜ä¸­10è¿›åˆ¶è¡¨ç¤º</span><br>decimal2Binary(*p);<span class="hljs-comment">//å°†åè¿›åˆ¶è½¬åŒ–ä¸ºäºŒè¿›åˆ¶</span><br>decimal2Binary_2(*p);<br>&#125;<br>getchar();<span class="hljs-comment">//é˜²æ­¢ç¨‹åºé€€å‡º</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>åœ¨åè¿›åˆ¶è½¬åŒ–ä¸ºäºŒè¿›åˆ¶çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä½¿ç”¨äº†ä¸¤ç§åŠæ³•ï¼Œé¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯é€šè¿‡å¾ªç¯æ±‚ä½™çš„åŠæ³•æ¥è½¬åŒ–</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * [decimal2Binary åè¿›åˆ¶è½¬æ¢æˆäºŒè¿›åˆ¶ï¼Œä½¿ç”¨å¾ªç¯æ±‚ä½™æ³•]</span><br><span class="hljs-comment"> * @author mohuishou&lt;1@lailin.xyz&gt;</span><br><span class="hljs-comment"> * @param  x [è¦è½¬æ¢çš„åè¿›åˆ¶æ•°]</span><br><span class="hljs-comment"> * @return   [0]</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">decimal2Binary</span><span class="hljs-params">(<span class="hljs-keyword">int</span> x)</span></span>&#123;<br><span class="hljs-keyword">int</span> a[<span class="hljs-number">32</span>];<br><span class="hljs-keyword">int</span> rem;<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">31</span>;j&gt;=<span class="hljs-number">0</span>;j--)&#123;<br> rem=x%<span class="hljs-number">2</span>;<br> x=x/<span class="hljs-number">2</span>;<br> a[j]=rem;<br><br>&#125;<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;=<span class="hljs-number">31</span>;i++) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d&quot;</span>,a[i]);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="5"><li>ç¬¬äºŒç§æ˜¯åé¢æŸ¥èµ„æ–™çš„æ—¶å€™çœ‹åˆ°çš„ä¸€ç§åŠæ³•ï¼Œæˆ‘è½¬æ¢äº†ä¸€ä¸‹ï¼Œç”¨äºè¿™ä¸ªå°ç¨‹åºã€‚ä¸»è¦æ˜¯å……åˆ†åº”ç”¨äº† C è¯­è¨€å½“ä¸­çš„ä½è¿ç®—</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * [decimal2Binary_2 åè¿›åˆ¶è½¬æ¢æˆäºŒè¿›åˆ¶ï¼Œä½¿ç”¨æŒ‰ä½å¯¹æ¯”æ³•]</span><br><span class="hljs-comment"> * @author mohuishou&lt;1@lailin.xyz&gt;</span><br><span class="hljs-comment"> * @param  x [è¦è¿›è¡Œè½¬åŒ–çš„10è¿›åˆ¶æ•°]</span><br><span class="hljs-comment"> * @return   [0]</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">decimal2Binary_2</span><span class="hljs-params">(<span class="hljs-keyword">int</span> x)</span></span>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">31</span>; i &gt;=<span class="hljs-number">0</span>;i--)<br>&#123;<br><span class="hljs-keyword">if</span>(x&amp;(<span class="hljs-number">1</span>&lt;&lt;i))&#123;<span class="hljs-comment">//å°†1å·¦ç§»iä½å¹¶å’Œxè¿›è¡ŒæŒ‰ä½å¯¹æ¯”</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d&quot;</span>,<span class="hljs-number">1</span> );<br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d&quot;</span>,<span class="hljs-number">0</span> );<br>&#125;<br>&#125;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="0-åœ¨æµ®ç‚¹æ•°ä¸­æ€ä¹ˆè¡¨ç¤º"><a href="#0-åœ¨æµ®ç‚¹æ•°ä¸­æ€ä¹ˆè¡¨ç¤º" class="headerlink" title="0 åœ¨æµ®ç‚¹æ•°ä¸­æ€ä¹ˆè¡¨ç¤º"></a>0 åœ¨æµ®ç‚¹æ•°ä¸­æ€ä¹ˆè¡¨ç¤º</h3><blockquote><p>æˆ‘å…ˆé€šè¿‡ä¸Šé¢å†™å¥½çš„ç¨‹åºï¼Œè¾“å…¥ 0 ä¹‹åï¼Œå¾—åˆ°çš„å€¼ä¸º 32 ä¸ª 0ï¼Œç„¶åè¿›è¡Œä¸€ä¸ªç®€å•çš„åˆ†æè®¤ä¸ºï¼š</p></blockquote><h4 id="æµ®ç‚¹æ•°çš„è¡¨ç¤ºæ–¹æ³•"><a href="#æµ®ç‚¹æ•°çš„è¡¨ç¤ºæ–¹æ³•" class="headerlink" title="æµ®ç‚¹æ•°çš„è¡¨ç¤ºæ–¹æ³•"></a>æµ®ç‚¹æ•°çš„è¡¨ç¤ºæ–¹æ³•</h4><ol><li>æµ®ç‚¹æ•°çš„è¡¨ç¤ºæ–¹æ³•æ˜¯ï¼šå…ˆè½¬åŒ–ä¸º 1.xxxï¼ˆå°æ•°éƒ¨åˆ†ï¼‰ * 2^mï¼ˆæŒ‡æ•°éƒ¨åˆ†ï¼‰</li><li>é¦–å…ˆåˆ¤æ–­ç¬¦å·ï¼Œæ­£çš„è¯ç¬¬ä¸€ä½ä¸º 0ï¼Œè´Ÿæ•°çš„è¯ä¸ºç¬¬ä¸€ä½ 1</li><li>æŒ‡æ•°éƒ¨åˆ† m+127=&gt;è½¬åŒ–ä¸º 2 è¿›åˆ¶</li><li>å°æ•°éƒ¨åˆ† xxx=&gt;è½¬åŒ–ä¸º 2 è¿›åˆ¶ï¼Œ</li></ol><h4 id="å¯¹äº-0-çš„æ¨æ–­"><a href="#å¯¹äº-0-çš„æ¨æ–­" class="headerlink" title="å¯¹äº 0 çš„æ¨æ–­"></a>å¯¹äº 0 çš„æ¨æ–­</h4><p>ç”±äº 0 çš„è¯ï¼Œä»–ç¬¬ä¸€æ­¥å°±ä¸èƒ½è½¬åŒ–ä¸º 1.xxxï¼ˆå°æ•°éƒ¨åˆ†ï¼‰ * 2^mï¼ˆæŒ‡æ•°éƒ¨åˆ†)çš„å½¢å¼ï¼Œæ‰€ä»¥æ¯”è¾ƒå¥½çš„ä¸€ä¸ªåŠæ³•å°±æ˜¯ä»¥ 32 ä¸ª 0 è¡¨ç¤º</p><h4 id="æ¨æ–­çš„éªŒè¯"><a href="#æ¨æ–­çš„éªŒè¯" class="headerlink" title="æ¨æ–­çš„éªŒè¯"></a>æ¨æ–­çš„éªŒè¯</h4><blockquote><p>å¯¹äº C è¯­è¨€æ¥è¯´æˆ‘åœ¨ä¹‹å‰å°±å·²ç»éªŒè¯äº†ï¼Œç„¶åæˆ‘æŸ¥è¯¢äº†ç»´åŸºç™¾ç§‘ IEEE äºŒè¿›åˆ¶æµ®ç‚¹æ•°ç®—æœ¯æ ‡å‡†ï¼ˆIEEE 754ï¼‰<a href="https://zh.wikipedia.org/wiki/IEEE_754">ç‚¹å‡»æ‰“å¼€</a>ï¼Œå¯¹æ¯”å¾—å‡ºï¼Œ0 çš„äºŒè¿›åˆ¶æµ®ç‚¹æ•°è¡¨ç¤ºçš„ç¡®æ˜¯ 32 ä¸ª 0</p></blockquote><h3 id="ç¨‹åºè¿è¡Œç»“æœæˆªå›¾"><a href="#ç¨‹åºè¿è¡Œç»“æœæˆªå›¾" class="headerlink" title="ç¨‹åºè¿è¡Œç»“æœæˆªå›¾"></a>ç¨‹åºè¿è¡Œç»“æœæˆªå›¾</h3><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2541890988.png" alt="1.png"></p><h3 id="ç¨‹åºæºä»£ç æˆªå›¾"><a href="#ç¨‹åºæºä»£ç æˆªå›¾" class="headerlink" title="ç¨‹åºæºä»£ç æˆªå›¾"></a>ç¨‹åºæºä»£ç æˆªå›¾</h3><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2014147934.png" alt="2.png"><br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2014147934.png" alt="3.png"></p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>C</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jsç¼–ç è§£ç URL</title>
    <link href="/post/62847.html"/>
    <url>/post/62847.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>åœ¨ js çš„ URL ç¼–ç è§£ç å½“ä¸­æœ‰è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«æ˜¯</p></blockquote><h3 id="ç¼–ç è§£ç å‡½æ•°"><a href="#ç¼–ç è§£ç å‡½æ•°" class="headerlink" title="ç¼–ç è§£ç å‡½æ•°"></a>ç¼–ç è§£ç å‡½æ•°</h3><p>1.</p><p>ç¼–ç <code>encodeURI(str)</code><br>è§£ç <code>decodeURI(str)</code></p><p>2.</p><p>ç¼–ç <code>encodeURIComponent</code><br>è§£ç <code>decodeURIComponent</code></p> <a id="more"></a><h3 id="åŒºåˆ«"><a href="#åŒºåˆ«" class="headerlink" title="åŒºåˆ«"></a>åŒºåˆ«</h3><p>encodeURI å¯¹äºå­—æ¯å’Œå±äº URL çš„å­—ç¬¦ä¸è¿›è¡Œç¼–ç <br>ä½†æ˜¯ encodeURIComponent ä¼šå¯¹å±äº URL çš„å­—ç¬¦ä¹Ÿè¿›è¡Œç¼–ç <br><strong>ä¾‹å¦‚è¿™äº›å­—ç¬¦</strong><code>-_.!~*&#39;()</code></p><h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-built_in">var</span> <span class="hljs-built_in">str</span>=<span class="hljs-string">&quot;http://lxl520.com/ç¨‹åº&quot;</span>;<br>console.log(<span class="hljs-string">&quot;æˆ‘æ˜¯åˆå§‹å­—ç¬¦ä¸²&quot;</span>+<span class="hljs-built_in">str</span>);<br></code></pre></td></tr></table></figure><p><em>æˆ‘æ˜¯åˆå§‹å­—ç¬¦ä¸²<a href="http://lxl520.com/ç¨‹åº">http://lxl520.com/ç¨‹åº</a></em></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> str2=<span class="hljs-built_in">encodeURI</span>(str);<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;æˆ‘æ˜¯ç»è¿‡encodeURIç¼–ç çš„ï¼š&quot;</span>+str2);<br></code></pre></td></tr></table></figure><p><em>æˆ‘æ˜¯ç»è¿‡ encodeURI ç¼–ç çš„ï¼š<a href="http://lxl520.com/%E7%A8%8B%E5%BA%8F">http://lxl520.com/%E7%A8%8B%E5%BA%8F</a></em></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> str3=<span class="hljs-built_in">encodeURIComponent</span>(str);<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;æˆ‘æ˜¯ç»è¿‡encodeURIComponentç¼–ç çš„ï¼š&quot;</span>+str3);<br></code></pre></td></tr></table></figure><p><em>æˆ‘æ˜¯ç»è¿‡ encodeURIComponent ç¼–ç çš„ï¼šhttp%3A%2F%2Flxl520.com%2F%E7%A8%8B%E5%BA%8F</em></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">var</span> str<span class="hljs-number">2</span>Decode=decodeURI(str<span class="hljs-number">2</span>);<br><span class="hljs-attribute">var</span> str<span class="hljs-number">3</span>Decode=decodeURIComponent(str<span class="hljs-number">3</span>);<br><span class="hljs-attribute">console</span>.log(<span class="hljs-string">&quot;æˆ‘ä»¬æ˜¯ç»è¿‡è§£ç çš„å­—ç¬¦ä¸²ï¼š&quot;</span>+str<span class="hljs-number">2</span>Decode+<span class="hljs-string">&quot;\n&quot;</span>+str<span class="hljs-number">3</span>Decode);<br></code></pre></td></tr></table></figure><p><em>æˆ‘ä»¬æ˜¯ç»è¿‡è§£ç çš„å­—ç¬¦ä¸²ï¼š<a href="http://lxl520.com/ç¨‹åº">http://lxl520.com/ç¨‹åº</a><br><a href="http://lxl520.com/ç¨‹åº">http://lxl520.com/ç¨‹åº</a></em></p><h3 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2"></a>ç¤ºä¾‹ 2</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>URLç¼–ç <span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;get&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;è¯·è¾“å…¥æ‚¨è¦ç¼–ç çš„å­—ç¬¦ä¸²&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;urlEncode();&quot;</span>&gt;</span>ç‚¹å‡»è¿›è¡Œç¼–ç <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;urlDecode();&quot;</span>&gt;</span>ç‚¹å‡»è¿›è¡Œè§£ç <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;output&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;è¾“å‡ºæ¡†&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><br>      /**<br>       * @author mohuishou<br>       * [test URLç¼–ç æµ‹è¯•]<br><span class="javascript">       * @<span class="hljs-keyword">return</span> &#123;[type]&#125; [description]</span><br>       */<br><span class="javascript">      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="javascript">        <span class="hljs-keyword">var</span> str = <span class="hljs-string">&quot;http://lxl520.com/ç¨‹åº&quot;</span>;</span><br><span class="javascript">        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;æˆ‘æ˜¯åˆå§‹å­—ç¬¦ä¸²&quot;</span> + str);</span><br><span class="javascript">        <span class="hljs-keyword">var</span> str2 = <span class="hljs-built_in">encodeURI</span>(str);</span><br><span class="javascript">        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;æˆ‘æ˜¯ç»è¿‡encodeURIç¼–ç çš„ï¼š&quot;</span> + str2);</span><br><span class="javascript">        <span class="hljs-keyword">var</span> str3 = <span class="hljs-built_in">encodeURIComponent</span>(str);</span><br><span class="javascript">        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;æˆ‘æ˜¯ç»è¿‡encodeURIComponentç¼–ç çš„ï¼š&quot;</span> + str3);</span><br><span class="javascript">        <span class="hljs-keyword">var</span> str2Decode = <span class="hljs-built_in">decodeURI</span>(str2);</span><br><span class="javascript">        <span class="hljs-keyword">var</span> str3Decode = <span class="hljs-built_in">decodeURIComponent</span>(str3);</span><br><span class="javascript">        <span class="hljs-built_in">console</span>.log(</span><br><span class="javascript">          <span class="hljs-string">&quot;æˆ‘ä»¬æ˜¯ç»è¿‡è§£ç çš„å­—ç¬¦ä¸²ï¼š&quot;</span> + str2Decode + <span class="hljs-string">&quot;\n&quot;</span> + str3Decode</span><br>        );<br>      &#125;<br><br>      /**<br>       * @author mohuishou<br>       * æ›´æ”¹è¾“å…¥çš„å€¼ï¼Œå¹¶å°†å…¶è¾“å‡º<br>       */<br><span class="javascript">      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">urlEncode</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="javascript">        <span class="hljs-keyword">var</span> getVal = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;get&quot;</span>).value; <span class="hljs-comment">//è·å–è¾“å…¥æ¡†çš„å€¼</span></span><br><span class="javascript">        <span class="hljs-keyword">var</span> strEncode = <span class="hljs-built_in">encodeURI</span>(getVal);</span><br><span class="javascript">        <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;output&quot;</span>).value = strEncode; <span class="hljs-comment">//å°†ç¼–ç è¿‡åçš„å€¼è¾“å‡ºåˆ°è¾“å‡ºæ¡†</span></span><br>      &#125;<br><br>      /**<br>       * [urlDecode è§£ç å‡½æ•°ï¼Œå¯¹è¿›è¡Œè§£ç ]<br><span class="javascript">       * @<span class="hljs-keyword">return</span> &#123;[type]&#125; [description]</span><br>       */<br><span class="javascript">      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">urlDecode</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="javascript">        <span class="hljs-keyword">var</span> getVal = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;get&quot;</span>).value; <span class="hljs-comment">//è·å–è¾“å…¥æ¡†çš„å€¼</span></span><br><span class="javascript">        <span class="hljs-keyword">var</span> strDecode = <span class="hljs-built_in">decodeURI</span>(getVal);</span><br><span class="javascript">        <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;output&quot;</span>).value = strDecode;</span><br>      &#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>js</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>cssä¸­æƒé‡ä¸ä¼˜å…ˆçº§</title>
    <link href="/post/39494.html"/>
    <url>/post/39494.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>ä»Šå¤©åœ¨å†™ä¸€ä¸ªå‰ç«¯æ–‡ä»¶çš„æ—¶å€™å‘ç°æœ‰ä¸€ä¸ªæ ·å¼çªç„¶æ²¡æœ‰äº†ä½œç”¨ï¼Œä½†æ˜¯æŒ‰ç…§ä¼˜å…ˆçº§æ¥è¯´åº”è¯¥åé¢çš„å‰é¢çš„æ‰å¯¹ã€‚<br>ç„¶åç ”ç©¶äº†ä¸€ä¸‹ css å½“ä¸­çš„ä¼˜å…ˆçº§åˆ°åº•æ˜¯æ€ä¹ˆå›äº‹ï¼Œæ‰å‘ç°åŸæ¥éƒ½æ˜¯æƒé‡çš„é”…</p></blockquote><a id="more"></a><h3 id="é€‰æ‹©å™¨çš„æƒé‡"><a href="#é€‰æ‹©å™¨çš„æƒé‡" class="headerlink" title="é€‰æ‹©å™¨çš„æƒé‡"></a>é€‰æ‹©å™¨çš„æƒé‡</h3><blockquote><p>åˆ†ä¸ºå››ä¸ªç­‰çº§,æƒé‡å€¼è¶Šå¤§è¡¨ç¤ºä¼˜å…ˆçº§åˆ«è¶Šé«˜</p></blockquote><h4 id="æƒé‡è¡¨"><a href="#æƒé‡è¡¨" class="headerlink" title="æƒé‡è¡¨"></a>æƒé‡è¡¨</h4><table><thead><tr><th>é€‰æ‹©å™¨</th><th>ä¾‹å­</th><th>æƒé‡å€¼</th></tr></thead><tbody><tr><td>å†…è”æ ·å¼</td><td><code>style=&#39;&#39;</code></td><td>1000</td></tr><tr><td>id é€‰æ‹©å™¨</td><td><code>#title</code></td><td>100</td></tr><tr><td>ç±»ï¼Œä¼ªç±»ï¼Œå±æ€§é€‰æ‹©å™¨</td><td><code>.titleï¼Œ:hover ,a[href]</code></td><td>10</td></tr><tr><td>ç±»å‹é€‰æ‹©å™¨ï¼Œä¼ªå…ƒç´ é€‰æ‹©å™¨</td><td><code>p, :before</code></td><td>1</td></tr><tr><td>é€šç”¨é€‰æ‹©å™¨ï¼Œå­é€‰æ‹©å™¨å’Œç›¸é‚»åŒèƒé€‰æ‹©å™¨</td><td><code>*,&gt;,+</code></td><td>0</td></tr></tbody></table><h4 id="ä¸€ä¸ªä¾‹å­"><a href="#ä¸€ä¸ªä¾‹å­" class="headerlink" title="ä¸€ä¸ªä¾‹å­"></a>ä¸€ä¸ªä¾‹å­</h4><p><strong>sytle</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/*æƒé‡=100+1=101*/</span><br><span class="hljs-selector-id">#title</span> <span class="hljs-selector-tag">h2</span> &#123;<br>  <span class="hljs-attribute">color</span>: red;<br>&#125;<br><br><span class="hljs-comment">/*æƒé‡=10+1=11*/</span><br><span class="hljs-selector-class">.content</span> <span class="hljs-selector-tag">h2</span> &#123;<br>  <span class="hljs-attribute">color</span>: blue;<br>&#125;<br><br><span class="hljs-comment">/*æƒé‡=100+1=101*/</span><br><span class="hljs-selector-id">#title</span> <span class="hljs-selector-tag">a</span> &#123;<br>  <span class="hljs-attribute">color</span>: orange;<br>&#125;<br><br><span class="hljs-comment">/*æƒé‡=100+10=110*/</span><br><span class="hljs-selector-id">#title</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[href]</span> &#123;<br>  <span class="hljs-attribute">color</span>: green;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>html</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>æˆ‘æ˜¯æ ‡é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;color:#333;&quot;</span>&gt;</span>æˆ‘æ˜¯å†…å®¹<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--æƒé‡=1000--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://lxl520.com&quot;</span>&gt;</span>lxl520<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>0...0<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141636.png" alt=""></p><h3 id="å±‚å åŸç†ï¼ˆæˆ–è€…è¯´æ˜¯å°±è¿‘åŸåˆ™ï¼‰"><a href="#å±‚å åŸç†ï¼ˆæˆ–è€…è¯´æ˜¯å°±è¿‘åŸåˆ™ï¼‰" class="headerlink" title="å±‚å åŸç†ï¼ˆæˆ–è€…è¯´æ˜¯å°±è¿‘åŸåˆ™ï¼‰"></a>å±‚å åŸç†ï¼ˆ<em>æˆ–è€…è¯´æ˜¯å°±è¿‘åŸåˆ™</em>ï¼‰</h3><p><strong>å½“ä¸¤ä¸ªæ ·å¼çš„ä¼˜å…ˆçº§ä¸€æ ·æ—¶,ä¼šè‡ªåŠ¨é€‰æ‹©æœ€è¿‘çš„ä¸€æ¡æ ·å¼</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><br><span class="css">  <span class="hljs-selector-id">#title</span> &#123;</span><br>    color: red;<br>  &#125;<br><span class="css">  <span class="hljs-selector-id">#title</span> &#123;</span><br>    color: blue;<br>  &#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span>æˆ‘åˆ°åº•å•¥é¢œè‰²<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141637.png" alt=""></p><h3 id="ä¾‹å¤–ï¼ˆ-importantï¼‰"><a href="#ä¾‹å¤–ï¼ˆ-importantï¼‰" class="headerlink" title="ä¾‹å¤–ï¼ˆ!importantï¼‰"></a>ä¾‹å¤–ï¼ˆ!importantï¼‰</h3><p><strong>åœ¨å±æ€§çš„åé¢åŠ ä¸Š!important å¯ä»¥ç”¨æ¥ææƒï¼Œå°±å¥½æ¯”ç›´æ¥è·å¾—ç®¡ç†å‘˜æƒé™ä¸€æ ·ï¼Œè¿™è¿™ä¸ªå±æ€§ä¼šå˜æˆæœ€é«˜ä¼˜å…ˆçº§</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><br>  h2 &#123;<br>    color: red !important;<br>  &#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;color:blue;&quot;</span>&gt;</span>æˆ‘æƒ³å¿…åº”è¯¥æ˜¯è“è‰²<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141638.png" alt=""></p><h3 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h3><ol><li><p><strong>ä¸€äº›ä¸æˆæ–‡è§„åˆ™</strong></p><ul><li><strong>ä¸è¦</strong>åœ¨å…¨ç«™èŒƒå›´çš„ css ä¸­ä½¿ç”¨<code>!important</code>.</li><li><strong>åªåœ¨</strong>éœ€è¦è¦†ç›–å…¨ç«™èŒƒå›´çš„ css æˆ–æ˜¯å¤–éƒ¨ cssï¼ˆä¾‹å¦‚å¼•ç”¨çš„ ExtJs æˆ–æ˜¯ YUIï¼‰çš„æ—¶å€™æ‰åœ¨æŒ‡å®šçš„é¡µé¢ä¸Šä½¿ç”¨<code>!important</code>ã€‚</li><li><strong>ä¸è¦</strong>åœ¨ä½ çš„æ’ä»¶ä¸­ä½¿ç”¨<code>!important</code>ã€‚</li><li><strong>æ°¸è¿œ</strong>éƒ½è¦ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨æ ·å¼è§„åˆ™çš„ä¼˜å…ˆçº§æ¥è§£å†³é—®é¢˜è€Œä¸æ˜¯<code>!important</code>ã€‚</li></ul></li><li><p>å¦‚æœä½ å’Œæˆ‘ä¸€æ ·é‡åˆ°äº†ä¼¼ä¹æ²¡æœ‰èµ·ä½œç”¨çš„ CSS è§„åˆ™ï¼Œè¯·è¯•è¯•åœ¨ä½ çš„é€‰æ‹©å™¨ä¸­æ·»åŠ ä»–çš„ä¸€ä¸ªçˆ¶å…ƒç´ çš„ IDï¼Œä»è€Œæé«˜å®ƒçš„ç‰¹æ®Šæ€§ã€‚çœ‹çœ‹èƒ½ä¸èƒ½è§£å†³é—®é¢˜</p></li></ol><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>css</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>EmotionCamera</title>
    <link href="/post/16707.html"/>
    <url>/post/16707.html</url>
    
    <content type="html"><![CDATA[<h4 id="wiz_toc_0">ç®€å•å®ç°é€»è¾‘</h4><ol><br><li>é¦–å…ˆè¯†åˆ«è„¸éƒ¨</li><br><li>æ ‡è¯†å‡ºå…³é”®ç‚¹</li><br><li>é€šè¿‡ä¸€å®šçš„ç®—æ³•æ•æŠ“è¡¨æƒ…</li><br></ol><h4 id="wiz_toc_1">è¡¨æƒ…ç›¸æœºæ¨¡å—éœ€è¦å®ç°çš„ä»»åŠ¡</h4><ol><br><li>ä»€ä¹ˆæ—¶å€™æ‹ç…§ï¼Ÿ <br><br><em>éœ€è¦ç¡®å®šä¸€ä¸ªé˜ˆå€¼</em></li><br><li>å¯¼å‡ºä¸€ä¸ªé™æ€åº“ <br><br><em>ioså’Œandriod</em><br><br><blockquote><br>  <p>è¡¥å……ï¼Œioséœ€è¦æ¶‰åŠåˆ°macç³»ç»Ÿè¿˜æœ‰OCï¼›andriodéœ€è¦æ¶‰åŠåˆ°Linuxï¼Œå®‰å“æ–¹é¢å¯¼å‡ºçš„é™æ€åº“æ˜¯.aæ ¼å¼ï¼›åŠ¨æ€åº“ä¸º.soæ ¼å¼</p><br></blockquote></li><br></ol><h4 id="wiz_toc_2">æœ€è¿‘ä¸¤å‘¨éœ€è¦å®Œæˆçš„ä»»åŠ¡</h4><blockquote><br>  <p>ç°åœ¨çš„æ—¶é—´ï¼š2015å¹´11æœˆ1æ—¥ 23:34:33 <br><br>  ä¸¤å‘¨åéœ€è¦è¾¾åˆ°çš„æ•ˆæœï¼šä½¿ç”¨å®‰å“è°ƒç”¨C++ç”Ÿæˆçš„.aæ–‡ä»¶</p><br></blockquote><h5 id="wiz_toc_3">éœ€è¦æœç´¢çš„ä¸€äº›ä¸œè¥¿ï¼š</h5><p><ol></p><li>C++é™æ€åº“å¯¼å‡ºï¼ˆios/andriodï¼‰</li><br><li>é™æ€vsåŠ¨æ€åº“</li><br><li>objectâ€•C ï¼ˆiosï¼‰</li><br><li>makefile&amp;modify Macro</li><br><li>èƒ½ä¸èƒ½ç›´æ¥åœ¨ä¸€ä¸ªç¯å¢ƒä¸‹åŒæ—¶å¯¼å‡ºioså’Œå®‰å“éœ€è¦çš„åº“</li><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é¡¹ç›®</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NDKå¼€å‘ä¸­æ— æ³•è®¿é—®android.support.v7.app.AppCompatActivityè§£å†³åŠæ³•</title>
    <link href="/post/64902.html"/>
    <url>/post/64902.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>é”™è¯¯è¯¦æƒ…ï¼š<br>é”™è¯¯: æ— æ³•è®¿é—® android.support.v7.app.AppCompatActivity<br>æ‰¾ä¸åˆ° android.support.v7.app.AppCompatActivity çš„ç±»æ–‡ä»¶</p></blockquote><p>ä¸ºäº†è¿™ä¸ªé—®é¢˜çº ç»“ 2 å¤©äº†ï¼Œåœ¨ç½‘ä¸Šæ‰¾äº†å¾ˆå¤šçš„è§£å†³åŠæ³•éƒ½ä¸è¡Œï¼Œå‡ ä¹æ‰€æœ‰çš„åŠæ³•éƒ½è¯•è¿‡äº†</p><p>æ— æ„ä¸­æŸ¥çœ‹ sdk Manager çš„æ—¶å€™å‘ç°æˆ‘çš„<strong>â€œandroid support libraryâ€</strong>æ²¡æœ‰å®‰è£…ï¼Œç„¶åå½“å³å®‰è£…ä¸Šå»</p><p>éšåæ‰§è¡Œï¼š</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">javah -d jni -classpath   F:<span class="hljs-symbol">\S</span>oftInstall<span class="hljs-symbol">\A</span>ndroid<span class="hljs-symbol">\s</span>dk<span class="hljs-symbol">\p</span>latforms<span class="hljs-symbol">\a</span>ndroid-23<span class="hljs-symbol">\a</span>ndroid.jar;F:<span class="hljs-symbol">\S</span>oftInstall<span class="hljs-symbol">\a</span>ndroid<span class="hljs-symbol">\s</span>dk<span class="hljs-symbol">\e</span>xtras<span class="hljs-symbol">\a</span>ndroid<span class="hljs-symbol">\s</span>upport<span class="hljs-symbol">\v</span>4<span class="hljs-symbol">\a</span>ndroid-support-v4.jar;F:<span class="hljs-symbol">\S</span>oftInstall<span class="hljs-symbol">\a</span>ndroid<span class="hljs-symbol">\s</span>dk<span class="hljs-symbol">\e</span>xtras<span class="hljs-symbol">\a</span>ndroid<span class="hljs-symbol">\s</span>upport<span class="hljs-symbol">\v</span>7<span class="hljs-symbol">\a</span>ppcompat<span class="hljs-symbol">\l</span>ibs<span class="hljs-symbol">\a</span>ndroid-support-v7-appcompat.jar;..<span class="hljs-symbol">\.</span>.<span class="hljs-symbol">\b</span>uild<span class="hljs-symbol">\i</span>ntermediates<span class="hljs-symbol">\c</span>lasses<span class="hljs-symbol">\d</span>ebug com.lxl520.demo3.MainActivity<br></code></pre></td></tr></table></figure><p>å³å¯</p><p><strong>æ³¨æ„ï¼š</strong><br>å¦‚æœå‘ç°ä½ çš„ sdk æ–‡ä»¶å¤¹ä¸‹é¢æ²¡æœ‰<strong>sdk\extras\android\support**<br>è¿™ä¸ªæ–‡ä»¶å¤¹çš„æ—¶å€™ä¸€å®šè¦æ£€æŸ¥ä¸€ä¸‹ä½ çš„</strong>â€œandroid support libraryâ€**æ˜¯å¦å®‰è£…ï¼Œ<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141647.png" alt=""></p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>app</tag>
      
      <tag>ndk</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>phpstrom10æ¿€æ´»æ–¹æ³•ï¼ˆJetBrainsç³»åˆ—è½¯ä»¶æ¿€æ´»ï¼‰</title>
    <link href="/post/28397.html"/>
    <url>/post/28397.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>æ‰¾åˆ°ä¸€ä¸ª JetBrains ç³»åˆ—è½¯ä»¶çš„æ³¨å†ŒæœåŠ¡å™¨</p></blockquote><p><strong>æ³¨å†Œæ—¶é€‰æ‹©â€œLicense serverâ€è¾“å…¥â€œ<a href="http://idea.lanyus.com/â€ç‚¹å‡»â€œOKâ€å¿«é€Ÿæ¿€æ´»JetBrainsç³»åˆ—äº§å“">http://idea.lanyus.com/â€ç‚¹å‡»â€œOKâ€å¿«é€Ÿæ¿€æ´»JetBrainsç³»åˆ—äº§å“</a></strong></p><p>ä¹Ÿå¯ä»¥<br><a href="http://idea.lanyus.com/">ç‚¹å‡»è¿›å…¥è®¡ç®—æ³¨å†Œç </a></p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç ´è§£</tag>
      
      <tag>php</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>phpsocketè¿æ¥ï¼ŒUDP</title>
    <link href="/post/19867.html"/>
    <url>/post/19867.html</url>
    
    <content type="html"><![CDATA[<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php">&lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">//æœåŠ¡å™¨ä¿¡æ¯</span><br><span class="hljs-variable">$server</span> = <span class="hljs-string">&#x27;udp://192.168.253.1:9998&#x27;</span>;<br><span class="hljs-comment">//æ¶ˆæ¯ç»“æŸç¬¦å·</span><br><span class="hljs-variable">$msg_eof</span> = <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-variable">$socket</span> = stream_socket_server(<span class="hljs-variable">$server</span>, <span class="hljs-variable">$errno</span>, <span class="hljs-variable">$errstr</span>, STREAM_SERVER_BIND);<br><span class="hljs-keyword">if</span> (!<span class="hljs-variable">$socket</span>) &#123;<br><span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$errstr</span> (<span class="hljs-subst">$errno</span>)&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">do</span> &#123;<br><span class="hljs-comment">//æ¥æ”¶å®¢æˆ·ç«¯å‘æ¥çš„ä¿¡æ¯</span><br><span class="hljs-variable">$inMsg</span> = stream_socket_recvfrom(<span class="hljs-variable">$socket</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$peer</span>);<br><span class="hljs-comment">//æœåŠ¡ç«¯æ‰“å°å‡ºç›¸å…³ä¿¡æ¯</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Client : <span class="hljs-subst">$peer</span>\n&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Receive : <span class="hljs-subst">&#123;$inMsg&#125;</span>&quot;</span>;<br><span class="hljs-comment">//ç»™å®¢æˆ·ç«¯å‘é€ä¿¡æ¯</span><br><span class="hljs-variable">$outMsg</span> = substr(<span class="hljs-variable">$inMsg</span>, <span class="hljs-number">0</span>, (strrpos(<span class="hljs-variable">$inMsg</span>, <span class="hljs-variable">$msg_eof</span>))).<span class="hljs-string">&#x27; -- &#x27;</span>.date(<span class="hljs-string">&quot;D M j H:i:s Y\r\n&quot;</span>);<br><br>stream_socket_sendto(<span class="hljs-variable">$socket</span>, <span class="hljs-variable">$outMsg</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$peer</span>);<br><br>&#125; <span class="hljs-keyword">while</span> (<span class="hljs-variable">$inMsg</span> !== <span class="hljs-literal">false</span>);<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>php</tag>
      
      <tag>socket</tag>
      
      <tag>udp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>appcanåˆ©ç”¨å¤©ç¿¼rtcå®ç°è§†é¢‘é€šè¯åŠŸèƒ½</title>
    <link href="/post/34934.html"/>
    <url>/post/34934.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬ä»£ç æ˜¯åœ¨ç¤ºä¾‹ä»£ç çš„åŸºç¡€ä¸Šè¿›è¡Œäº†ä¸€äº›ç®€åŒ–ï¼Œå¹¶å°†å…¶å•ç‹¬åšäº†ä¸€ä¸ª vedio.js æ–‡ä»¶ï¼Œåªéœ€è¦ä¸¤ä¸ªæŒ‰é’®ï¼Œå³å¯å®Œæˆæ¥å¬å’Œæ‹¨æ‰“çš„éœ€æ±‚</p></blockquote><p><strong>attentionï¼š</strong></p><ol><li>é»˜è®¤å°†ç”¨æˆ·åè®¾ç½®æˆ 1234ï¼Œæ‹¨æ‰“çš„å¸å·è®¾ç½®æˆ 4321ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ä¸€ä¸ª app å®ç°çš„è¯ï¼Œå…·ä½“é€»è¾‘è‡ªè¡Œä¿®æ”¹</li></ol><h4 id="ä»£ç ï¼š"><a href="#ä»£ç ï¼š" class="headerlink" title="ä»£ç ï¼š"></a>ä»£ç ï¼š</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è§†é¢‘åŠŸèƒ½å®ç°</span><br><span class="hljs-comment"> * ä½¿ç”¨å¤©ç¿¼rtcæ’ä»¶å®ç°</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * åˆå§‹åŒ–ï¼Œåœ¨é¡µé¢åˆå§‹åŒ–æ–¹æ³•ä¸­è°ƒç”¨è¿™ä¸ªå‡½æ•°</span><br><span class="hljs-comment"> * å®šä¹‰å¤©ç¿¼rtcå›è°ƒå‡½æ•°</span><br><span class="hljs-comment"> * åŒä¸€ä¸ªé¡µé¢ä¸­  appcan.readyå¯ä»¥å­˜åœ¨å¤šä¸ªï¼Œä¸ä¼šå†²çª;è€ŒuexOnloadä¸è¡Œ...</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rtcInit</span>(<span class="hljs-params"></span>) </span>&#123;<br>  uexESurfingRtc.onGlobalStatus = upgateGlobalStatus; <span class="hljs-comment">//å…¨å±€ç›‘æ§</span><br>  uexESurfingRtc.cbLogStatus = upgateLogStatus; <span class="hljs-comment">//ç™»é™†å›è°ƒ</span><br>  uexESurfingRtc.cbCallStatus = updateCallStatus; <span class="hljs-comment">//å‘¼å«å›è°ƒ</span><br>  <span class="hljs-comment">//uexESurfingRtc.cbRemotePicPath = showRemotePicPath;//æˆªå±å›è°ƒ</span><br><br>  <span class="hljs-comment">/*----------é…ç½®å¤©ç¿¼rtcæ’ä»¶çš„appkey &amp; appid---------*/</span><br>  appId = <span class="hljs-string">&quot;70392&quot;</span>;<br>  appKey = uexESurfingRtc.setAppKeyAndAppId(appKey, appId); <span class="hljs-comment">//è¾“å…¥ä½ è‡ªå·±çš„appKey;</span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ç™»é™†å›è°ƒï¼Œè¿”å›æ˜¯å¦ç™»é™†æˆåŠŸ</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upgateLogStatus</span>(<span class="hljs-params">opCode, dataType, data</span>) </span>&#123;<br>  <span class="hljs-comment">//alert(data);</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;OK&quot;</span> == data.substring(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>)) &#123;<br>    <span class="hljs-keyword">var</span> status = data.split(<span class="hljs-string">&quot;OK:&quot;</span>)[<span class="hljs-number">1</span>];<br>    <span class="hljs-keyword">var</span> showStr = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;LOGIN&quot;</span> == status) &#123;<br>      showStr = <span class="hljs-string">&quot;ç™»é™†æˆåŠŸï¼Œç‚¹å‡»é€€å‡º&quot;</span>;<br>      $(<span class="hljs-string">&quot;#login&quot;</span>).attr(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;logout&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;LOGOUT&quot;</span> == status) &#123;<br>      showStr = <span class="hljs-string">&quot;ç™»é™†&quot;</span>;<br>      $(<span class="hljs-string">&quot;#login&quot;</span>).attr(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;login&quot;</span>);<br>    &#125;<br>    $(<span class="hljs-string">&quot;#login&quot;</span>).text(showStr);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    alert(data);<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateCallStatus</span>(<span class="hljs-params">opCode, dataType, data</span>) </span>&#123;<br>  alert(data);<br>  <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;OK&quot;</span> == data.substring(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>)) &#123;<br>    <span class="hljs-keyword">var</span> status = data.split(<span class="hljs-string">&quot;OK:&quot;</span>)[<span class="hljs-number">1</span>];<br>    <span class="hljs-keyword">var</span> showStr = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;NORMAL&quot;</span> == status) &#123;<br>      showStr = <span class="hljs-string">&quot;call&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;INCOMING&quot;</span> == status) &#123;<br>      showStr = <span class="hljs-string">&quot;accept&quot;</span>;<br>    &#125;<br>    <span class="hljs-comment">// else if(&quot;CALLING&quot; == status)</span><br>    <span class="hljs-comment">// &#123;</span><br>    <span class="hljs-comment">//     showStr = &quot;Calling&quot;;</span><br>    <span class="hljs-comment">// &#125;</span><br>    $(<span class="hljs-string">&quot;#call&quot;</span>).attr(<span class="hljs-string">&quot;name&quot;</span>, showStr);<br>    $(<span class="hljs-string">&quot;#call&quot;</span>).text(showStr);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    alert(data);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *ç›‘æ§ä¸­å¿ƒå›è°ƒ</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upgateGlobalStatus</span>(<span class="hljs-params">opCode, dataType, data</span>) </span>&#123;<br>  $(<span class="hljs-string">&quot;#content&quot;</span>).append(data);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ç™»é™†æ–¹æ³•çš„å®ç°</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-comment">// alert(123);</span><br>  <span class="hljs-comment">/*--è®¾ç½®ç™»é™†çš„é…ç½®ï¼Œåˆ†åˆ«æ˜¯æœ¬åœ°çª—å£å’Œå¯¹æ–¹è§†é¢‘çª—å£çš„å¤§å°----*/</span><br>  jsonViewConfig = &#123;<br>    localView: &#123;<br>      x: <span class="hljs-string">&quot;10&quot;</span>,<br>      y: <span class="hljs-string">&quot;800&quot;</span>,<br>      w: <span class="hljs-string">&quot;432&quot;</span>,<br>      h: <span class="hljs-string">&quot;528&quot;</span>,<br>    &#125;,<br>    remoteView: &#123;<br>      x: <span class="hljs-string">&quot;440&quot;</span>,<br>      y: <span class="hljs-string">&quot;800&quot;</span>,<br>      w: <span class="hljs-string">&quot;432&quot;</span>,<br>      h: <span class="hljs-string">&quot;528&quot;</span>,<br>    &#125;,<br>  &#125;;<br>  <span class="hljs-comment">/*---è¿™é‡Œé»˜è®¤è®¾ç½®ä¸€ä¸ªç”¨æˆ·åç”¨äºè°ƒè¯•ï¼ŒåæœŸç”¨æˆ·ç™»å½•ä¹‹åç›´æ¥è‡ªåŠ¨ç”Ÿæˆ---*/</span><br>  userName = <span class="hljs-string">&quot;1234&quot;</span>;<br>  <span class="hljs-comment">/*--uexESurfingRtc.loginå‡½æ•°éœ€è¦ä¼ å…¥çš„å‚æ•°æ˜¯ä¸€ä¸ªjsonå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥éœ€è¦è°ƒç”¨JSON.stringifyæ–¹æ³•å°†jsonå¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²--*/</span><br>  jsonDtr = <span class="hljs-built_in">JSON</span>.stringify(jsonViewConfig);<br><br>  uexESurfingRtc.login(jsonDtr, userName);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * é€€å‡ºç™»å½•</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return <span class="hljs-type">&#123;[type]&#125;</span> </span>[description]</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logout</span>(<span class="hljs-params"></span>) </span>&#123;<br>  uexESurfingRtc.logout();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">call</span>(<span class="hljs-params"></span>) </span>&#123;<br>  uexESurfingRtc.call(<span class="hljs-string">&quot;3&quot;</span>, <span class="hljs-string">&quot;4321&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">accept</span>(<span class="hljs-params"></span>) </span>&#123;<br>  uexESurfingRtc.acceptCall(<span class="hljs-string">&quot;3&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *ç™»é™†æŒ‰é’®</span><br><span class="hljs-comment"> *ç‚¹å‡»ä¹‹åç›´æ¥è§†é¢‘ç™»é™†</span><br><span class="hljs-comment"> */</span><br>appcan.button(<span class="hljs-string">&quot;#login&quot;</span>, <span class="hljs-string">&quot;ani-act&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">var</span> btnName = $(<span class="hljs-string">&quot;#login&quot;</span>).attr(<span class="hljs-string">&quot;name&quot;</span>);<br>  <span class="hljs-keyword">if</span> (btnName == <span class="hljs-string">&quot;login&quot;</span>) &#123;<br>    $(<span class="hljs-string">&quot;#login&quot;</span>).text(<span class="hljs-string">&quot;ç™»é™†ä¸­ï¼Œè¯·ç¨å€™...&quot;</span>);<br>    login();<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((btnName = <span class="hljs-string">&quot;logout&quot;</span>)) &#123;<br>    $(<span class="hljs-string">&quot;#login&quot;</span>).text(<span class="hljs-string">&quot;é€€å‡ºä¸­ï¼Œè¯·ç¨å€™...&quot;</span>);<br>    logout();<br>  &#125;<br>&#125;);<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å‘¼å«æŒ‰é’®</span><br><span class="hljs-comment"> */</span><br>appcan.button(<span class="hljs-string">&quot;#call&quot;</span>, <span class="hljs-string">&quot;ani-act&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">var</span> btnName = $(<span class="hljs-string">&quot;#call&quot;</span>).attr(<span class="hljs-string">&quot;name&quot;</span>);<br>  <span class="hljs-keyword">if</span> (btnName == <span class="hljs-string">&quot;call&quot;</span>) &#123;<br>    $(<span class="hljs-string">&quot;#call&quot;</span>).text(<span class="hljs-string">&quot;å‘¼å«ä¸­ï¼Œè¯·ç¨å€™...&quot;</span>);<br>    call();<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((btnName = <span class="hljs-string">&quot;accept&quot;</span>)) &#123;<br>    $(<span class="hljs-string">&quot;#call&quot;</span>).text(<span class="hljs-string">&quot;æ¥å¬ä¸­ï¼Œè¯·ç¨å€™...&quot;</span>);<br>    accept();<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>app</tag>
      
      <tag>appcan</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>javaä¸­å­—ç¬¦ä¸²ç›¸ç­‰çš„åˆ¤æ–­</title>
    <link href="/post/62897.html"/>
    <url>/post/62897.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>ä»Šå¤©éœ€è¦å†™ä¸€ä¸ª Java çš„å°ç¨‹åºéœ€è¦åˆ¤æ–­ä¸€ä¸‹ä»æ§åˆ¶å°è¾“å…¥çš„å­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ï¼Œåœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­å‘ç°ç›´æ¥ä½¿ç”¨â€œ==â€æ¥åˆ¤æ–­æ˜¯æ²¡æœ‰åŠæ³•åˆ¤æ–­å‡ºæ¥çš„ï¼ŒGoogle&amp;ç™¾åº¦äº†ä¸€ä¸‹ï¼Œæ‰¾åˆ°ä¸€ä¸ªè§£å†³åŠæ³•</p></blockquote><h4 id="1-ç”¨â€œ-â€è¿ç®—ç¬¦ï¼Œè¯¥è¿ç®—ç¬¦è¡¨ç¤ºæŒ‡å‘å­—ç¬¦ä¸²çš„å¼•ç”¨æ˜¯å¦ç›¸åŒ"><a href="#1-ç”¨â€œ-â€è¿ç®—ç¬¦ï¼Œè¯¥è¿ç®—ç¬¦è¡¨ç¤ºæŒ‡å‘å­—ç¬¦ä¸²çš„å¼•ç”¨æ˜¯å¦ç›¸åŒ" class="headerlink" title="1. ç”¨â€œ==â€è¿ç®—ç¬¦ï¼Œè¯¥è¿ç®—ç¬¦è¡¨ç¤ºæŒ‡å‘å­—ç¬¦ä¸²çš„å¼•ç”¨æ˜¯å¦ç›¸åŒ"></a>1. ç”¨â€œ==â€è¿ç®—ç¬¦ï¼Œè¯¥è¿ç®—ç¬¦è¡¨ç¤ºæŒ‡å‘å­—ç¬¦ä¸²çš„å¼•ç”¨æ˜¯å¦ç›¸åŒ</h4><p>æ¯”å¦‚è¯´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">String a=<span class="hljs-string">&quot;abc&quot;</span>;String b=<span class="hljs-string">&quot;abc&quot;</span>;<br>a==b;<span class="hljs-comment">//å°†è¿”å›trueã€‚</span><br><span class="hljs-comment">/*è¿™æ˜¯å› ä¸ºåœ¨javaä¸­å­—ç¬¦ä¸²çš„å€¼æ˜¯ä¸å¯æ”¹å˜çš„ï¼Œç›¸åŒçš„å­—ç¬¦ä¸²åœ¨å†…å­˜ä¸­åªä¼šå­˜ä¸€ä»½ï¼Œæ‰€ä»¥aå’ŒbæŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡*/</span><br></code></pre></td></tr></table></figure><p>å†æ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">String a=<span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;abc&quot;</span>);<br>String b=<span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;abc&quot;</span>);<br><span class="hljs-comment">//é‚£ä¹ˆa==bå°†è¿”å›falseï¼Œå› ä¸ºaå’ŒbæŒ‡å‘ä¸åŒçš„å¯¹è±¡ã€‚</span><br></code></pre></td></tr></table></figure><p>ç”¨ scanner ç±»è·å–å­—ç¬¦ä¸²æ¥æ¯”è¾ƒçš„æ—¶å€™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">Scanner input=<span class="hljs-keyword">new</span> Scanner(System.in);<span class="hljs-comment">//æ–°å»ºinputå¯¹è±¡ï¼Œç”¨äºå®ç°è¾“å…¥åŠŸèƒ½</span><br>String a=<span class="hljs-string">&quot;exit&quot;</span>;<span class="hljs-comment">//å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸²</span><br>System.out.println(<span class="hljs-string">&quot;è¯·è¾“å…¥æ‚¨æƒ³è¾“å…¥çš„å­—ç¬¦ä¸²ï¼š&quot;</span>);<br>String get=input.nextLine();<span class="hljs-comment">//è·å–è¾“å…¥å¾—çš„å­—ç¬¦ä¸²çš„å€¼</span><br><span class="hljs-keyword">if</span>(get==a)&#123;<br>    System.out.println(a);<br>&#125;<span class="hljs-comment">//è¿™ä¸ªæ—¶å€™æ²¡æœ‰è¾“å‡ºå€¼</span><br></code></pre></td></tr></table></figure><h4 id="2-ç”¨-equals-æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¯”è¾ƒçš„æ˜¯å­—ç¬¦ä¸²çš„å†…å®¹æ˜¯å¦ç›¸åŒ"><a href="#2-ç”¨-equals-æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¯”è¾ƒçš„æ˜¯å­—ç¬¦ä¸²çš„å†…å®¹æ˜¯å¦ç›¸åŒ" class="headerlink" title="2. ç”¨ equals æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¯”è¾ƒçš„æ˜¯å­—ç¬¦ä¸²çš„å†…å®¹æ˜¯å¦ç›¸åŒ"></a>2. ç”¨ equals æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¯”è¾ƒçš„æ˜¯å­—ç¬¦ä¸²çš„å†…å®¹æ˜¯å¦ç›¸åŒ</h4><p>æ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">String a=<span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;abc&quot;</span>);<br>String b=<span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;abc&quot;</span>);<br>a.equals(b);<span class="hljs-comment">//å°†è¿”å›trueã€‚</span><br></code></pre></td></tr></table></figure><p><strong>æ‰€ä»¥é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸ºäº†é¿å…å‡ºç°ä¸Šè¿°é—®é¢˜ï¼Œåˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ä½¿ç”¨ equals æ–¹æ³•ã€‚</strong></p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>office2016æ¿€æ´»å·¥å…·</title>
    <link href="/post/37989.html"/>
    <url>/post/37989.html</url>
    
    <content type="html"><![CDATA[<h4 id="å¯ä»¥ç”¨äºæ¿€æ´»-windows-office2010-2013-2016-å…¨ç³»åˆ—ç‰ˆæœ¬"><a href="#å¯ä»¥ç”¨äºæ¿€æ´»-windows-office2010-2013-2016-å…¨ç³»åˆ—ç‰ˆæœ¬" class="headerlink" title="å¯ä»¥ç”¨äºæ¿€æ´» windows office2010/2013/2016 å…¨ç³»åˆ—ç‰ˆæœ¬"></a>å¯ä»¥ç”¨äºæ¿€æ´» windows office2010/2013/2016 å…¨ç³»åˆ—ç‰ˆæœ¬</h4><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/QQ%E5%9B%BE%E7%89%8720151022110350.png" alt="è¯·è¾“å…¥å›¾ç‰‡æè¿°"></p><p><strong>ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œè¯¥è½¯ä»¶å³å¯</strong><br>30S ä¸åˆ°ï¼Œä½ ä¼šå‘ç°ä½ çš„ office æˆ–è€… windows å·²ç»æ¿€æ´»äº†ï¼Œæ²¡æœ‰å®‰è£…ç•Œé¢</p><p><a href="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/1198607745.rar">è½¯ä»¶ä¸‹è½½</a></p><h3 id="ps-æœ¬è½¯ä»¶æ”¶é›†äºç½‘ç»œï¼Œè¿™é‡Œä»…ä½œåˆ†äº«ï¼Œè¯·ä¸‹è½½ä¹‹å-24-å°æ—¶ä¹‹å†…åˆ é™¤ï¼Œå¹¶ä¸”ä¸å¾—ç”¨äºå•†ä¸šç”¨é€”"><a href="#ps-æœ¬è½¯ä»¶æ”¶é›†äºç½‘ç»œï¼Œè¿™é‡Œä»…ä½œåˆ†äº«ï¼Œè¯·ä¸‹è½½ä¹‹å-24-å°æ—¶ä¹‹å†…åˆ é™¤ï¼Œå¹¶ä¸”ä¸å¾—ç”¨äºå•†ä¸šç”¨é€”" class="headerlink" title="ps:æœ¬è½¯ä»¶æ”¶é›†äºç½‘ç»œï¼Œè¿™é‡Œä»…ä½œåˆ†äº«ï¼Œè¯·ä¸‹è½½ä¹‹å 24 å°æ—¶ä¹‹å†…åˆ é™¤ï¼Œå¹¶ä¸”ä¸å¾—ç”¨äºå•†ä¸šç”¨é€”"></a><em>ps:æœ¬è½¯ä»¶æ”¶é›†äºç½‘ç»œï¼Œè¿™é‡Œä»…ä½œåˆ†äº«ï¼Œè¯·ä¸‹è½½ä¹‹å 24 å°æ—¶ä¹‹å†…åˆ é™¤ï¼Œå¹¶ä¸”ä¸å¾—ç”¨äºå•†ä¸šç”¨é€”</em></h3><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç ´è§£</tag>
      
      <tag>è½¯ä»¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä½¿ç”¨MITAPPInventor2webå®¢æˆ·ç«¯ç»„ä»¶ä¿å­˜æ•°æ®è‡³äº‘ç«¯</title>
    <link href="/post/35791.html"/>
    <url>/post/35791.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>æ¥ç€å‰é¢çš„è¯´ï¼Œè“ç‰™æ¥æ”¶åˆ°æ•°æ®ä¹‹åéœ€è¦å°†æ•°æ®å¤„ç†åˆ†æç„¶åä¿å­˜ä¸‹æ¥ï¼Œä½†æ˜¯ AI2 å¹¶æ²¡æœ‰ç›´æ¥å†™ä»£ç æ¥çš„æ–¹ä¾¿å¿«æ·ï¼Œå¹¶ä¸”æˆ‘ä»¬çš„ç°åœ¨å¤„äºäº‘è®¡ç®—çš„æ—¶ä»£ï¼Œæ•°æ®æ— ä»·ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æƒ³åŠæ³•å°†æ•°æ®ä¿å­˜åˆ°äº‘ç«¯ã€‚</p></blockquote><h4 id="æ•°æ®ä¿å­˜åˆ°äº‘ç«¯çš„æ–¹æ³•ï¼š"><a href="#æ•°æ®ä¿å­˜åˆ°äº‘ç«¯çš„æ–¹æ³•ï¼š" class="headerlink" title="æ•°æ®ä¿å­˜åˆ°äº‘ç«¯çš„æ–¹æ³•ï¼š"></a>æ•°æ®ä¿å­˜åˆ°äº‘ç«¯çš„æ–¹æ³•ï¼š</h4><ol><li>ä½¿ç”¨è‡ªå¸¦çš„ç½‘ç»œå¾®æ•°æ®åº“</li><li>ä½¿ç”¨ web å®¢æˆ·ç«¯è°ƒç”¨å†™å¥½çš„åç«¯æ¥å£ä¸Šä¼ æ•°æ®</li></ol><blockquote><p>ç”±äºè‡ªå¸¦çš„ç½‘ç»œå¾®æ•°æ®åº“æ˜¯ Python å†™çš„ï¼Œè€Œä¸”å¯¹äºæ•°æ®åº“çš„æ¥å£æœ‰ç€ä¸¥æ ¼é™åˆ¶ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘æ‰ç”¨æˆ‘è‡ªå·±ç”¨ php+mysql å†™çš„ä¸€ä¸ª api æ¥è¿›è¡Œä¸Šä¼ </p></blockquote><h4 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h4><ol><li>å…ˆçœ‹çœ‹ç”¨åˆ°çš„ç»„ä»¶ï¼šä¸»è¦æ˜¯ web å®¢æˆ·ç«¯<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141639.jpg" alt=""></li><li>ç»„ä»¶çš„ä»£ç å—:<ul><li>ç”¨äºè®¾ç½® web å®¢æˆ·ç«¯çš„ç½‘å€<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141640.jpg" alt=""></li><li>æ‰§è¡Œ get è¯·æ±‚<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141641.jpg" alt=""></li><li>è¯·æ±‚æˆåŠŸåè¿”å›æ“ä½œ<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141642.jpg" alt=""><br>æ³¨æ„ï¼šè¿™ä¸€ä¸ªçš„è¯å¦‚æœä½ è®¾ç½®äº†ä¿å­˜å“åº”ä¿¡æ¯ä¸º ture å°±é€‰æ‹©è·å¾—æ–‡ä»¶è¿™ä¸ªæ§åˆ¶å—ï¼Œå¦åˆ™çš„è¯é€‰æ‹©è·å¾—æ–‡å­—çš„æ§åˆ¶å—ï¼Œæˆ‘ä»¬ä½¿ç”¨è·å¾—æ–‡å­—çš„æ§åˆ¶å—</li></ul></li></ol><h4 id="é€»è¾‘æ§åˆ¶å›¾"><a href="#é€»è¾‘æ§åˆ¶å›¾" class="headerlink" title="é€»è¾‘æ§åˆ¶å›¾"></a>é€»è¾‘æ§åˆ¶å›¾</h4><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141643.jpg" alt=""><br><em>æˆ‘åšçš„æ¥å£çš„è¿”å›å€¼ä¸º json æ ¼å¼æ‰€ä»¥é‡‡ç”¨äº† json çš„è§£æï¼Œæˆ‘æš‚æ—¶ä¸éœ€è¦åˆ¤æ–­è¿”å›å€¼å¾—å†…å®¹ã€é‡Œé¢åŒ…å«äº†ä¸Šä¼ æ˜¯å¦æˆåŠŸä¹‹ç±»çš„ã€‘ï¼Œå¦‚æœéœ€è¦çš„è¯è¯·å‚è€ƒæœ‰å…³ json è§£æçš„ç›¸å…³å†…å®¹</em></p><h4 id="æ¨èå‚è€ƒæ‰‹å†Œ"><a href="#æ¨èå‚è€ƒæ‰‹å†Œ" class="headerlink" title="æ¨èå‚è€ƒæ‰‹å†Œ"></a>æ¨èå‚è€ƒæ‰‹å†Œ</h4><ol><li>æ„Ÿè°¢@è€å·«å©†ç¿»è¯‘çš„å‚è€ƒæ‰‹å†Œï¼Œè¿™é‡Œåˆ†äº«ç»™å¤§å®¶ï¼š<a href="http://www.17coding.net/reference/">AI2 ä¸­æ–‡å‚è€ƒæ‰‹å†Œ</a></li><li><a href="http://blog.sina.com.cn/s/blog_62218b990102vhmo.html">@è€å·«å©†çš„ json è§£ææ•™ç¨‹</a></li><li><a href="http://i.youku.com/u/UNTc5MzY3NTYw/playlists">AI2 è§†é¢‘æ•™ç¨‹</a>ä¸å¾—ä¸åæ§½è¿™ä¸ªæ•™ç¨‹çš„æ¸…æ™°åº¦</li></ol><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>app</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>phpstrom9å¯ç”¨æ³¨å†Œç ä¸€æš</title>
    <link href="/post/19314.html"/>
    <url>/post/19314.html</url>
    
    <content type="html"><![CDATA[<h4 id="phpstrom9-å¯ç”¨æ³¨å†Œç ä¸€æš"><a href="#phpstrom9-å¯ç”¨æ³¨å†Œç ä¸€æš" class="headerlink" title="phpstrom9 å¯ç”¨æ³¨å†Œç ä¸€æš"></a>phpstrom9 å¯ç”¨æ³¨å†Œç ä¸€æš</h4><p><strong>username</strong></p><pre><code>EMBRACE</code></pre><p><strong>key</strong></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">===== LICENSE BEGIN =====</span><br>43136-12042010<br>00002UsvSON704l&quot;dILe1PVx3y4&quot;B3<br>49AU6oSDJrsjE8nMOQh&quot;8HTDJHIUUh<br>gd1BebYc5U&quot;6OxDbVsALB4Eb10PW8&quot;<br><span class="hljs-section">===== LICENSE END =====</span><br></code></pre></td></tr></table></figure><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç ´è§£</tag>
      
      <tag>php</tag>
      
      <tag>æ³¨å†Œç </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>phpå¦‚ä½•å®ç°æ•´é™¤</title>
    <link href="/post/28942.html"/>
    <url>/post/28942.html</url>
    
    <content type="html"><![CDATA[<h3 id="php-å¦‚ä½•å®ç°æ•´é™¤"><a href="#php-å¦‚ä½•å®ç°æ•´é™¤" class="headerlink" title="php å¦‚ä½•å®ç°æ•´é™¤"></a>php å¦‚ä½•å®ç°æ•´é™¤</h3><blockquote><p>ä»¥å‰åœ¨ç”¨ C/C++çš„æ—¶å€™ï¼Œæ•´é™¤å°±æ˜¯â€™/â€˜ï¼Œè¿˜è¦ç‰¹åˆ«æ³¨æ„è¿™ä¸ªé—®é¢˜ï¼Œä»Šå¤©ç”¨åˆ° php è°ƒè¯•çš„æ—¶å€™å‡ºé”™äº†ï¼Œæœ€åå‘ç°ï¼šåœ¨ php ä¸­â€™/â€˜é™¤æ³•æ˜¯é»˜è®¤å¸¦æœ‰å°æ•°éƒ¨åˆ†çš„ï¼Œphp è‡ªå¸¦æœ‰å‡ ä¸ªå‡½æ•°å¯ä»¥å¯¹å°æ•°è¿›è¡Œå¤„ç†</p></blockquote><h4 id="1-round-å‡½æ•°ï¼Œå››èˆäº”å…¥"><a href="#1-round-å‡½æ•°ï¼Œå››èˆäº”å…¥" class="headerlink" title="1. round()å‡½æ•°ï¼Œå››èˆäº”å…¥"></a>1. round()å‡½æ•°ï¼Œå››èˆäº”å…¥</h4><pre><code>&lt;?php echo round(7/3); //2 ?&gt;</code></pre><h4 id="2-ceil-å‡½æ•°ï¼Œè¿›ä¸€æ³•"><a href="#2-ceil-å‡½æ•°ï¼Œè¿›ä¸€æ³•" class="headerlink" title="2. ceil()å‡½æ•°ï¼Œè¿›ä¸€æ³•"></a>2. ceil()å‡½æ•°ï¼Œè¿›ä¸€æ³•</h4><p><em>ä¹Ÿå°±æ˜¯å–æ¯”è¯¥æ•°å¤§çš„æœ€å°æ•´æ•°</em></p><pre><code>&lt;?php echo ceil(7/3); //3 ?&gt;</code></pre><h4 id="3-floor-å‡½æ•°ï¼Œèˆä¸€æ³•"><a href="#3-floor-å‡½æ•°ï¼Œèˆä¸€æ³•" class="headerlink" title="3. floor()å‡½æ•°ï¼Œèˆä¸€æ³•"></a>3. floor()å‡½æ•°ï¼Œèˆä¸€æ³•</h4><p><em>ä¹Ÿå°±æ˜¯å–æ¯”è¯¥æ•°å°çš„æœ€å¤§æ•´æ•°</em></p><p> &lt;?php echo floor(7/3); //2?&gt;</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>php</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ç¦åˆ©ã€‘è‡³å–„ç½‘åª’ä½“ç´ æä¸€é”®è¯„ä»·</title>
    <link href="/post/59875.html"/>
    <url>/post/59875.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘åšè‡³å–„ç½‘ä¸Šé¢çš„é¢˜æ—¶å€™ï¼Œå‘ç°åª’ä½“ç´ æéœ€è¦ä¸€ä¸ªä¸€ä¸ªçš„è¯„ä»·å®åœ¨æ˜¯æœ‰ç‚¹çƒ¦ï¼›æ‰€ä»¥å¼€æŒ‚å†™äº†ä¸€ä¸ª JS çš„å°æ’ä»¶ï¼Œç›´æ¥ä¸€æ¬¡æ€§æå®š</p></blockquote><p><strong>æ–¹æ³•ä¸€ï¼šç›´æ¥å°†ä¸‹é¢è¿™ä¸ªé“¾æ¥æ‹–å…¥ä¹¦ç­¾æ ï¼Œç„¶ååœ¨ä½ éœ€è¦ä¸€ä»¶è¯„ä»·åª’ä½“ç´ æçš„åœ°æ–¹ç‚¹å‡»å°±å¥½</strong><br><em>ps:æ¯›æ¦‚æµ‹è¯•æˆåŠŸï¼Œå…¶ä»–çš„è¯·è‡ªæµ‹</em></p><p><a href='javascript:(function(){function sleep(d){for(var t=Date.now();Date.now()-t<=d;){}}function getNum(text){var value=text.replace(/[^0-9]/ig,"");return value}var obj=$("p[href="+"\"javascript:;\""+"]").each(function(){var name=$(this).attr("name");name=getNum(name);parent.showMediaRight(name);wkMediaPj(name,3);var btn1=$(".aui_state_highlight");btn1.click();sleep(1000)})})();'>è‡³å–„ç½‘åª’ä½“ç´ æä¸€é”®è¯„ä»·</a></p><p><em>æœ‰ä»€ä¹ˆé—®é¢˜ç›´æ¥åœ¨è¯„è®ºé—®å°±å¥½</em></p><p><strong>æ›´æ–°ï¼Œé™„èµ ä¸€ä¸ªæ¯›æ¦‚çš„ç­”æ¡ˆ</strong><br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141644.jpg" alt=""></p><p><strong>æ¯›æ¦‚ç­”æ¡ˆè¡¥å……ï¼šä¸­é—´æœ‰ä¸€ä¸ªé—®å·ï¼Œé‚£é“é¢˜çš„ç­”æ¡ˆæ˜¯ï¼šä¸€ä¸ªä¸­å¿ƒï¼Œä¸¤ä¸ªåŸºæœ¬çš„</strong><br><strong>æ³¨ï¼šè¿™æ˜¯æ¯›æ¦‚ä¸Šçš„ç­”æ¡ˆ</strong></p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>js</tag>
      
      <tag>å·¥å…·</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¦‚ä½•ä½¿ç”¨MITAPPInventor2å¿«é€Ÿåˆ›å»ºä¸€ä¸ªè“ç‰™ä¸²å£app</title>
    <link href="/post/23045.html"/>
    <url>/post/23045.html</url>
    
    <content type="html"><![CDATA[<h3 id="å¦‚ä½•ä½¿ç”¨-MIT-APP-Inventor2-å¿«é€Ÿåˆ›å»ºä¸€ä¸ªè“ç‰™ä¸²å£-app"><a href="#å¦‚ä½•ä½¿ç”¨-MIT-APP-Inventor2-å¿«é€Ÿåˆ›å»ºä¸€ä¸ªè“ç‰™ä¸²å£-app" class="headerlink" title="å¦‚ä½•ä½¿ç”¨ MIT APP Inventor2 å¿«é€Ÿåˆ›å»ºä¸€ä¸ªè“ç‰™ä¸²å£ app"></a>å¦‚ä½•ä½¿ç”¨ MIT APP Inventor2 å¿«é€Ÿåˆ›å»ºä¸€ä¸ªè“ç‰™ä¸²å£ app</h3><hr><blockquote><p>æœ€è¿‘åšå­¦æ ¡çš„ä¸€ä¸ªæ¯”èµ›ï¼Œæˆ‘æ˜¯å¹³æ—¶æ˜¯å­¦ä¹ åš web åç«¯çš„ï¼Œæœ‰æ—¶å€™æå¸¦ä¸€äº›å‰ç«¯çš„ä¸œè¥¿ï¼Œä½†æ˜¯æœ€è¿‘è¿™ä¸ªæ¯”èµ›éœ€è¦åšä¸€ä¸ª appï¼Œé—®é¢˜æ¥äº†ï¼Œæ²¡æœ‰å­¦è¿‡ Java æ²¡æœ‰å­¦è¿‡ OC æ‰€ä»¥ ios å’Œå®‰å“éƒ½æ˜¯æ— ä»ä¸‹æ‰‹ï¼Œç„¶åæœ€åæ‰¾äº†å¾ˆå¤šæ··åˆå¼€å‘çš„å·¥å…·ï¼Œæ¯”å¦‚è¯´ APPCANï¼Œapicloudï¼Œhbuilderï¼Œwex5 ç­‰ç­‰ï¼Œæœ€åä¸æ˜¯æ²¡æœ‰è“ç‰™ä¸²å£çš„æ’ä»¶ï¼Œå°±æ˜¯æ²¡æœ‰åŠæ³•ä½¿ç”¨.æœ€ç»ˆåœ¨ä¸€æ¬¡æœç´¢ä¸­æ— æ„çš„å‘ç°äº†è¿™ä¸ª AI2.</p></blockquote><h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><hr><p><strong>1. ä½¿ç”¨ AI2 çš„å‰ææ¡ä»¶ï¼š</strong></p><ul><li>ä¸è¦æ±‚ç•Œé¢çš„ç¾è§‚æ€§ï¼Œéœ€è¦å®ç”¨æ€§</li><li>ä¸ä¼šåŸç”Ÿä»£ç çš„ç¼–ç¨‹</li></ul><p><strong>2. ä½¿ç”¨ AI2 å¥½å¤„ï¼š</strong></p><ul><li>ä¸è¦æ±‚ä½ ä¼šå†™ä»£ç ï¼Œå›¾å½¢åŒ–ç¼–ç¨‹ï¼Œç®€å•æ˜“ç”¨</li><li>æä¾›äº†å¾ˆå¤šæ¨¡å—ä¸€èˆ¬åšä¸€ä¸ªå¸¸ç”¨çš„ app å®Œå…¨æ²¡æœ‰é—®é¢˜</li><li>æœ‰ä¸­æ–‡ç‰ˆï¼Œæ‰€ä»¥è¯´è¯­è¨€éšœç¢ä¹Ÿä¸å­˜åœ¨äº†</li></ul><p><strong>3. ä½¿ç”¨ AI2 çš„å‡ ç§æ–¹å¼ï¼š</strong></p><ul><li>ç¦»çº¿å®‰è£…ï¼Œç¦»çº¿è°ƒè¯•</li><li>åœ¨çº¿ä½¿ç”¨ï¼ŒAI ä¼´ä¾£è°ƒè¯•ï¼ˆæ¨¡æ‹Ÿå™¨è°ƒè¯•ï¼‰<br><em>ä¸ªäººæ¨èç¬¬äºŒç§ï¼Œåœ¨çº¿ä½¿ç”¨ï¼ŒAI ä¼´ä¾£è°ƒè¯•</em></li></ul><p><strong>4. AI2 çš„ä¸­æ–‡ç½‘å€ï¼š</strong></p><ul><li>æœ€æ–°çš„ä¸­æ–‡æœåŠ¡å™¨ï¼š<a href="http://app.gzjkw.net/">http://app.gzjkw.net/</a></li><li>ä¸­æ–‡æ•™ç¨‹ç½‘ç«™ï¼š<a href="http://www.17coding.net/">http://www.17coding.net/</a></li></ul><h4 id="æ•™ç¨‹"><a href="#æ•™ç¨‹" class="headerlink" title="æ•™ç¨‹"></a>æ•™ç¨‹</h4><blockquote><p>PS:ä»…ä»…æ˜¯è‡ªå·±çš„ä¸€äº›ç»éªŒè§‚ç‚¹ï¼Œæœ‰ä»€ä¹ˆé”™è¯¯å¤§å®¶äº¤æµå•Š</p></blockquote><hr><h5 id="1-ç‚¹å‡»è¿›å…¥-http-app-gzjkw-net-ï¼Œ-æ³¨å†Œå¸å·ä¹‹åï¼Œè¿›å…¥ä»¥ä¸‹é¡µé¢"><a href="#1-ç‚¹å‡»è¿›å…¥-http-app-gzjkw-net-ï¼Œ-æ³¨å†Œå¸å·ä¹‹åï¼Œè¿›å…¥ä»¥ä¸‹é¡µé¢" class="headerlink" title="1. ç‚¹å‡»è¿›å…¥ http://app.gzjkw.net/ï¼Œ æ³¨å†Œå¸å·ä¹‹åï¼Œè¿›å…¥ä»¥ä¸‹é¡µé¢"></a>1. ç‚¹å‡»è¿›å…¥ <a href="http://app.gzjkw.net/">http://app.gzjkw.net/</a>ï¼Œ æ³¨å†Œå¸å·ä¹‹åï¼Œè¿›å…¥ä»¥ä¸‹é¡µé¢</h5><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/blogQQå›¾ç‰‡20151015130813.png" alt="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾"></p><h5 id="2-é€‰æ‹©ä¸Šé¢çš„å¸®åŠ©ä¸‹è½½AI-ä¼´ä¾£apkï¼Œä¹‹åç”¨äºåœ¨çº¿è°ƒè¯•"><a href="#2-é€‰æ‹©ä¸Šé¢çš„å¸®åŠ©ä¸‹è½½AI-ä¼´ä¾£apkï¼Œä¹‹åç”¨äºåœ¨çº¿è°ƒè¯•" class="headerlink" title="2. é€‰æ‹©ä¸Šé¢çš„å¸®åŠ©ä¸‹è½½AI ä¼´ä¾£apkï¼Œä¹‹åç”¨äºåœ¨çº¿è°ƒè¯•"></a>2. é€‰æ‹©ä¸Šé¢çš„å¸®åŠ©ä¸‹è½½<strong>AI ä¼´ä¾£</strong>apkï¼Œä¹‹åç”¨äºåœ¨çº¿è°ƒè¯•</h5><ul><li>æˆ–è€…ç›´æ¥ç‚¹å‡» <a href="http://app.gzjkw.net/companions/MITAI2Companion.apk" title="AIä¼´ä¾£">AI ä¼´ä¾£</a> ä¸‹è½½</li></ul><h5 id="3-ç®€å•çš„åŠŸèƒ½ä»‹ç»"><a href="#3-ç®€å•çš„åŠŸèƒ½ä»‹ç»" class="headerlink" title="3. ç®€å•çš„åŠŸèƒ½ä»‹ç»"></a>3. ç®€å•çš„åŠŸèƒ½ä»‹ç»</h5><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/blogQQå›¾ç‰‡20151015131926.png" alt="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾"></p><ul><li><strong>å…¶ä¸­æˆ‘ä»¬éœ€è¦ç”¨åˆ°çš„å‡ ä¸ªç»„ä»¶ï¼š</strong></li></ul><table><thead><tr><th>åç§°</th><th style="text-align:center">ä½œç”¨</th></tr></thead><tbody><tr><td>è“ç‰™å®¢æˆ·ç«¯ 1</td><td style="text-align:center">ç”¨äºæ¥æ”¶è“ç‰™ä¸²å£è®¾å¤‡çš„æ¶ˆæ¯</td></tr><tr><td>æŒ‰é’®</td><td style="text-align:center">ä¸€èˆ¬çš„ button</td></tr><tr><td>æ°´å¹³å¸ƒå±€</td><td style="text-align:center">ç”¨äºå¸ƒå±€æ•´ä¸ªç•Œé¢</td></tr><tr><td>å¯¹è¯æ¡†</td><td style="text-align:center">ç”¨äºå‘å‡ºæç¤ºæ¶ˆæ¯</td></tr><tr><td>activity æ§åˆ¶å™¨</td><td style="text-align:center">ç”¨äºæ‰“å¼€è“ç‰™</td></tr><tr><td>web å®¢æˆ·ç«¯</td><td style="text-align:center">ç”¨äºé“¾æ¥ç½‘ç»œç›¸å…³çš„ä¸œè¥¿ï¼ˆè¿™ä¸ªä¸‹ä¸€æ¬¡ç”¨åˆ°ï¼‰</td></tr><tr><td>è®¡æ—¶å™¨</td><td style="text-align:center">ç”¨äºå®šæ—¶æ¥æ”¶è“ç‰™ä¸²å£å‘é€å‡ºæ¥çš„æ¶ˆæ¯</td></tr></tbody></table><ul><li><strong>å…·ä½“çš„å¸¸ç”¨ç»„ä»¶çš„ä»‹ç»ï¼Œè¯·å¤§å®¶ç‚¹å‡»ç½‘ç«™æŸ¥çœ‹<a href="http://www.17coding.net/">http://www.17coding.net/</a></strong></li></ul><h5 id="4-é€»è¾‘è®¾ç½®"><a href="#4-é€»è¾‘è®¾ç½®" class="headerlink" title="4. é€»è¾‘è®¾ç½®"></a>4. é€»è¾‘è®¾ç½®</h5><ul><li>é¦–å…ˆå®Œæˆç•Œé¢çš„ä¸€ä¸ªç•Œé¢çš„å¸ƒå±€å·¥ä½œ<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/blogQQå›¾ç‰‡20151015170129.png" alt="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾"></li><li><p>ç»„ä»¶çš„é€»è¾‘è®¾ç½®ã€ç‚¹å‡»å³ä¸Šè§’çš„é€»è¾‘è®¾è®¡å³å¯ã€‘<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/blogQQå›¾ç‰‡20151015170447.png" alt="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾"></p></li><li><p>å…¶ä¸­å°† activity å¯åŠ¨å™¨ 1 çš„ action å€¼è®¾ç½®ä¸º<strong>android.bluetooth.adapter.action.REQUEST_ENABLE</strong> ï¼Œè¿™æ ·å¯ä»¥è¾¾åˆ°å¼€å¯è“ç‰™çš„æ•ˆæœ</p></li></ul><h3 id="ä¸‹ä¸€ç¯‡è®²å¦‚ä½•å°†æ•°æ®ä¿å­˜åˆ°æœåŠ¡å™¨ï¼ˆä¸ä½¿ç”¨è‡ªå¸¦çš„ç½‘ç»œæ•°æ®åº“çš„æƒ…å†µä¸‹ï¼‰"><a href="#ä¸‹ä¸€ç¯‡è®²å¦‚ä½•å°†æ•°æ®ä¿å­˜åˆ°æœåŠ¡å™¨ï¼ˆä¸ä½¿ç”¨è‡ªå¸¦çš„ç½‘ç»œæ•°æ®åº“çš„æƒ…å†µä¸‹ï¼‰" class="headerlink" title="ä¸‹ä¸€ç¯‡è®²å¦‚ä½•å°†æ•°æ®ä¿å­˜åˆ°æœåŠ¡å™¨ï¼ˆä¸ä½¿ç”¨è‡ªå¸¦çš„ç½‘ç»œæ•°æ®åº“çš„æƒ…å†µä¸‹ï¼‰"></a><em>ä¸‹ä¸€ç¯‡è®²å¦‚ä½•å°†æ•°æ®ä¿å­˜åˆ°æœåŠ¡å™¨ï¼ˆä¸ä½¿ç”¨è‡ªå¸¦çš„ç½‘ç»œæ•°æ®åº“çš„æƒ…å†µä¸‹ï¼‰</em></h3><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>app</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CoreThinkå›¾ç‰‡è½®æ’­æ’ä»¶ã€ImageSliderã€‘</title>
    <link href="/post/15278.html"/>
    <url>/post/15278.html</url>
    
    <content type="html"><![CDATA[<p>ç§»æ¤äº OT æ’ä»¶ï¼ŒåŸæ–‡åœ°å€<a href="http://www.topthink.com/topic/6244.html">http://www.topthink.com/topic/6244.html</a></p><p>1ã€æ”¯æŒ unslider\flexslider åˆ‡æ¢é€‰æ‹©</p><p>2ã€æ”¯æŒæ¨èä½é€‰æ‹©</p><p>3ã€æ”¯æŒå¤šå›¾</p><p>4ã€åˆ‡æ¢æ—¶é—´&amp;æ–¹å‘é€‰æ‹©</p><p>5ã€è‡ªå®šä¹‰å®¹å™¨å®½åº¦&amp;é«˜åº¦</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141646.png" alt=""></p><p><strong><em>**</em></strong>*<strong><em>**</em></strong>ä½¿ç”¨è¯´æ˜<strong><em>**</em></strong>***<strong><em>**</em></strong><br>1ã€è¯·å…ˆå°†ä¸‹é¢è¿™æ®µä»£ç å¤åˆ¶åˆ° Application\common\controller\addon.class.php</p><pre><code>/* è·å–ä»¶æ‰€éœ€çš„é’©å­æ˜¯å¦å­˜åœ¨ï¼Œæ²¡æœ‰åˆ™æ–°å¢   * @param string $str  é’©å­åç§°   * @param string $addons  æ’ä»¶åç§°   * @param string $addons  ä»¶ç®€ä»‹   */ public function existHook($str, $addons, $msg=&apos;&apos;)&#123;       $hook_mod = M(&apos;addon_hook&apos;); $where[&apos;name&apos;] = $str;       $gethook = $hook_mod-&gt;where($where)-&gt;find();       if(!$gethook || empty($gethook) || !is_array($gethook))&#123;           $data[&apos;name&apos;] = $str; $data[&apos;description&apos;] = $msg; $data[&apos;type&apos;] = 1;           $data[&apos;update_time&apos;] = NOW_TIME; $data[&apos;addons&apos;] = $addons;           if( false !== $hook_mod-&gt;create($data) )&#123;               $hook_mod-&gt;add();           &#125;       &#125;   &#125;   /**    * deleteé’©å­    * @param string $hook  é’©å­åç§°    */   public function deleteHook($hook)&#123;       $model = M(&apos;addon_hook&apos;);       $condition = array( &apos;name&apos; =&gt; $hook, );       $model-&gt;where($condition)-&gt;delete();   &#125;</code></pre><p>2ã€è°ƒç”¨æ–¹æ³•</p><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clojure">&#123;<span class="hljs-symbol">:hook</span>(<span class="hljs-name">&#x27;ImageSlider&#x27;</span>)&#125;<br></code></pre></td></tr></table></figure><p>3ã€å¦‚æœå‡ºç°æ˜¾ç¤ºä¸å‡ºå›¾ç‰‡ï¼Œè·¯å¾„é”™è¯¯çš„æƒ…å†µ</p><p>è¯·æ”¹ä¸€ä¸‹é‚£ä¸ª unslider\flexslider.html çš„å›¾ç‰‡è·¯å¾„ï¼Œå› ä¸ºå®‰è£…çš„è·¯å¾„ä¸åŒå¯èƒ½å‡ºç°æ„å¤–</p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>php</tag>
      
      <tag>corethink</tag>
      
      <tag>æ’ä»¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Corethinkç€‘å¸ƒæµæ’ä»¶</title>
    <link href="/post/54589.html"/>
    <url>/post/54589.html</url>
    
    <content type="html"><![CDATA[<h2 id="ã€åŸåˆ›æ’ä»¶ã€‘ç€‘å¸ƒæµ"><a href="#ã€åŸåˆ›æ’ä»¶ã€‘ç€‘å¸ƒæµ" class="headerlink" title="ã€åŸåˆ›æ’ä»¶ã€‘ç€‘å¸ƒæµ"></a>ã€åŸåˆ›æ’ä»¶ã€‘ç€‘å¸ƒæµ</h2><h3 id="1ã€å‰å°ç•Œé¢"><a href="#1ã€å‰å°ç•Œé¢" class="headerlink" title="1ã€å‰å°ç•Œé¢"></a>1ã€å‰å°ç•Œé¢</h3><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141648.png" alt=""></p><h3 id="2ã€å‰å°å¤§å›¾é¢„è§ˆ"><a href="#2ã€å‰å°å¤§å›¾é¢„è§ˆ" class="headerlink" title="2ã€å‰å°å¤§å›¾é¢„è§ˆ"></a>2ã€å‰å°å¤§å›¾é¢„è§ˆ</h3><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141649.png" alt=""></p><h3 id="3ã€åå°è®¾ç½®"><a href="#3ã€åå°è®¾ç½®" class="headerlink" title="3ã€åå°è®¾ç½®"></a>3ã€åå°è®¾ç½®</h3><p>æ”¯æŒå®¹å™¨å®½åº¦è‡ªå®šä¹‰ï¼Œé«˜åº¦éšå®½åº¦æŒ‰æ¯”ä¾‹æ”¹å˜</p><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141650.png" alt=""></p><h3 id="4ã€åå°ç®¡ç†ç•Œé¢"><a href="#4ã€åå°ç®¡ç†ç•Œé¢" class="headerlink" title="4ã€åå°ç®¡ç†ç•Œé¢"></a>4ã€åå°ç®¡ç†ç•Œé¢</h3><p>ä½œè€…ï¼Œå†…å®¹ä¸ºé€‰å¡«é¡¹ï¼Œå…¶ä½™ä¸ºå¿…å¡«é¡¹<br><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141651.png" alt=""></p><h3 id="5ã€æ–°å¢ç•Œé¢"><a href="#5ã€æ–°å¢ç•Œé¢" class="headerlink" title="5ã€æ–°å¢ç•Œé¢"></a>5ã€æ–°å¢ç•Œé¢</h3><p><img src="https://me-blog.oss-cn-shenzhen.aliyuncs.com/img/2018-12-03-141653.png" alt=""></p><p><strong>**</strong>***<strong>**</strong>ä½¿ç”¨è¯´æ˜<strong><strong><em>**</em></strong></strong>****<strong><strong><em>**</em></strong></strong><br>1ã€å‰å°è°ƒç”¨</p><pre><code>é’©å­&#123;:hook(&apos;WaterFall&apos;)&#125;</code></pre><p>2ã€å®‰è£…è¯´æ˜</p><p>å¦‚æœé»˜è®¤è¡¨å‰ç¼€ä¸æ˜¯ ct<em>ï¼Œè¯·åœ¨æ’ä»¶ç›®å½•ä¸‹ WaterFallAddon.class.php ä¸­çš„ ct</em>æ”¹ä¸ºä½ çš„è¡¨å‰ç¼€</p><pre><code>-&gt;where(&apos;ct_addon_waterfall.status=1&apos;)</code></pre><p>3ã€å®‰è£…è¯´æ˜ 2<br>å¦‚æœä¸èƒ½å®‰è£…æ˜¯ä¸å­˜åœ¨é’©å­åŸå› ï¼Œè§£å†³åŠæ³•è¯·çœ‹æˆ‘ä¸Šä¸€ä¸ª OT ç§»æ¤æ’ä»¶ ImageSlider ä¸­çš„ä½¿ç”¨æ–¹æ³•</p><p><a href="http://lxl520.com/me/blog/index.php/archives/6/">ImageSlider</a></p><p>psï¼š</p><p><a href="http://www.cnblogs.com/sanshi/p/3237429.html">æ„Ÿè°¢ä¸‰ç”ŸçŸ³ä¸Šçš„å‰ç«¯ç€‘å¸ƒæµæ•™ç¨‹</a></p><h2 id="å…³æ³¨æˆ‘è·å–æ›´æ–°">  <a href="#å…³æ³¨æˆ‘è·å–æ›´æ–°" class="headerlink" title="å…³æ³¨æˆ‘è·å–æ›´æ–°"></a>å…³æ³¨æˆ‘è·å–æ›´æ–°<a    class="anchorjs-link"    aria-label="Anchor"    data-anchorjs-icon="î§‹"    href="#å…³æ³¨æˆ‘è·å–æ›´æ–°"    style="font: 1em / 1 anchorjs-icons; padding-left: 0.375em"  ></a></h2><div class="row">  <div class="col-lg-6">    <img      style="width: 100%"      src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      alt="wechat"    />  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="http://s.zhihu.com/B4RT3"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/zhihu.png"        alt="çŸ¥ä¹"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://toutiao.io/subjects/387401?f=new"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/toutiaoio.png"        alt="å¼€å‘è€…å¤´æ¡"    /></a>  </div>  <div class="col-lg-2 col-4">    <a target="_blank" href="https://github.com/mohuishou"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/github.png"        alt="github"    /></a>  </div></div><!-- Add wechat img after categories --><script>document.addEventListener('DOMContentLoaded', (event) => {  let toc = $("#toc");  if (toc.height() >= 1){    toc.append(`    <a      class="fancybox fancybox.image"      href="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"      itemscope=""      itemtype="http://schema.org/ImageObject"      itemprop="url"      data-fancybox="default"      rel="default"      title="wechat"      data-caption="wechat"      ><img        style="width: 100%"        src="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        srcset="https://mohuishou-blog-sz.oss-cn-shenzhen.aliyuncs.com/custom/wechat_white.png"        alt="wechat"      />    `)  }})</script>]]></content>
    
    
    <categories>
      
      <category>ç¨‹åº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>php</tag>
      
      <tag>corethink</tag>
      
      <tag>æ’ä»¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
